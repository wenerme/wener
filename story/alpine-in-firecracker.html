<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.1"><title data-rh=true>Firecracker 运行 AlpineLinux | Wener Live & Life</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:url content=https://wener.me/story/alpine-in-firecracker /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docusaurus_tag content=default /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docsearch:docusaurus_tag content=default /><meta data-rh=true property=og:title content="Firecracker 运行 AlpineLinux | Wener Live & Life"/><meta data-rh=true name=description content="Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。"/><meta data-rh=true property=og:description content="Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。"/><meta data-rh=true property=og:type content=article /><meta data-rh=true property=article:published_time content=2020-10-23T00:00:00.000Z /><meta data-rh=true property=article:tag content=AlpineLinux,Firecracker /><link data-rh=true rel=icon href=/img/favicon.ico /><link data-rh=true rel=canonical href=https://wener.me/story/alpine-in-firecracker /><link data-rh=true rel=alternate href=https://wener.me/story/alpine-in-firecracker hreflang=en /><link data-rh=true rel=alternate href=https://wener.me/story/alpine-in-firecracker hreflang=x-default /><link data-rh=true rel=preconnect href=https://37P8DMWBKF-dsn.algolia.net crossorigin=anonymous /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://wener.me/story/alpine-in-firecracker","@type":"BlogPosting","author":[],"datePublished":"2020-10-23T00:00:00.000Z","description":"Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。","headline":"Firecracker 运行 AlpineLinux","isPartOf":{"@id":"https://wener.me/story","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"https://wener.me/story/alpine-in-firecracker","name":"Firecracker 运行 AlpineLinux","url":"https://wener.me/story/alpine-in-firecracker"}</script><link rel=alternate type=application/rss+xml href=/story/rss.xml title="Wener Live & Life RSS Feed"><link rel=alternate type=application/atom+xml href=/story/atom.xml title="Wener Live & Life Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1",{})</script><link rel=search type=application/opensearchdescription+xml title="Wener Live & Life" href=/opensearch.xml><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css><script src=https://static.cloudflareinsights.com/beacon.min.js async data-cf-beacon='{"token": "e9a1b931103044f3940ee67b78c7df70"}' defer></script><link rel=stylesheet href=/assets/css/styles.fa221ee1.css /><script src=/assets/js/runtime~main.72c320db.js defer></script><script src=/assets/js/main.c07313b6.js defer></script></head><body class=navigation-with-keyboard><svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_jKDA href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/wener-logo-head.svg alt="Wener Logo" class="themedComponent_j2y5 themedComponent--light_v877"/><img src=/img/wener-logo-head.svg alt="Wener Logo" class="themedComponent_j2y5 themedComponent--dark_PUQY"/></div><b class="navbar__title text--truncate">Wener</b></a><a class="navbar__item navbar__link" href=/notes>笔记</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/story>故事</a><a class="navbar__item navbar__link" href=/notes/howto/network/dns-prevent-spoofing>指南</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/wenerme/wener target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_kUGX><use href=#theme-svg-external-link /></svg></a><div class="toggle_N7Mq colorModeToggle_vh_y"><button class="clean-btn toggleButton_PaHe toggleButtonDisabled_RC4w" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_Q188 lightToggleIcon_M1mU"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_Q188 darkToggleIcon_sEdo"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_Q188 systemToggleIcon_cOyE"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_d_Bn><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts=Meta+k><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 24 24" aria-hidden=true><circle cx=11 cy=11 r=8 stroke=currentColor fill=none stroke-width=1.4 /><path d="m21 21-4.3-4.3" stroke=currentColor fill=none stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_c22C"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_Ulkt thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_hSNJ margin-bottom--md">Recent posts</div><div role=group><h3 class=yearGroupHeading_KD0z>2025</h3><ul class="sidebarItemList_dElJ clean-list"><li class=sidebarItem_vrPW><a class=sidebarItemLink_w3wN href=/story/function-and-interface>工具 - 工 与 具</a><li class=sidebarItem_vrPW><a class=sidebarItemLink_w3wN href=/story/here-my-love-ch2>《我把我的矜持都给了她》：第二章 - 故事的重新开始</a></ul></div><div role=group><h3 class=yearGroupHeading_KD0z>2024</h3><ul class="sidebarItemList_dElJ clean-list"><li class=sidebarItem_vrPW><a class=sidebarItemLink_w3wN href=/story/decrypt-classfinal-jar>解密 ClassFinal 加密的 Java Jar 包</a><li class=sidebarItem_vrPW><a class=sidebarItemLink_w3wN href=/story/how-i-note>我记录思考的方式简单总结</a><li class=sidebarItem_vrPW><a class=sidebarItemLink_w3wN href=/story/ml-first-try>第一次尝试机器学习</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_U7V0>Firecracker 运行 AlpineLinux</h1><div class="container_cxbP margin-vert--md"><time datetime=2020-10-23T00:00:00.000Z>October 23, 2020</time> · <!-- -->7 min read</div></header><div id=__blog-post-container class=markdown><p>Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。</p>
<p><strong>优点</strong></p>
<ul>
<li>启动快 &lt; 125ms</li>
<li>内存占用少 &lt; 5mb</li>
<li>Rust 实现</li>
<li>musl 静态链接</li>
<li>firecracker 自身约 <strong>1.6 MB</strong> - <strong>无依赖</strong></li>
</ul>
<p><strong>设计目标/缺陷</strong></p>
<ul>
<li>基于 KVM 实现
<ul>
<li>只有 Linux 平台</li>
<li>只能运行相同架构</li>
</ul>
</li>
<li>专注于虚拟化场景
<ul>
<li>支持的虚拟设备少
<ul>
<li>virtio-net - 虚拟化网络</li>
<li>virtio-block - 虚拟化块设备</li>
<li>virtio-vsock - unix sock</li>
<li>串口 - ttyS0 终端登陆</li>
<li>最简键盘控制器</li>
</ul>
</li>
<li>没有 bios</li>
<li>通过 vmlinux+initramfs+rootfs 启动</li>
</ul>
</li>
<li>要求 Kernel 4.14+</li>
</ul>
<p><strong>为什么选择 Alpine？</strong></p>
<ul>
<li>最容易构建</li>
<li>最容易使用</li>
<li>构建 Firecracker 能使用的 CentOS, Debian, Ubuntu, Fedora 真太难了 - 如果没掌握内部启动机制不建议尝试</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=注意>注意<a href=#注意 class=hash-link aria-label="Direct link to 注意" title="Direct link to 注意" translate=no>​</a></h2>
<p>一些注意事项写在前面：</p>
<div class="theme-admonition theme-admonition-info admonition_phik alert alert--info"><div class=admonitionHeading_zxjO><span class=admonitionIcon_bSNx><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>Firecracker 注意点</div><div class=admonitionContent_R6P7><ul>
<li>没有电源管理，因此不支持重启，会直接退出</li>
<li>系统内 poweroff 或 halt 不会退出 - reboot 会</li>
<li>可以发送 SendCtrlAltDel 退出</li>
<li>不支持 QCOW2 格式，可以考虑配合 NDB 使用</li>
<li>alpine 内核需要 boot-source.initrd_path => initramfs-virt</li>
<li>alpine netboot 的 initramfs-virt 没有 ext4</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=安装>安装<a href=#安装 class=hash-link aria-label="Direct link to 安装" title="Direct link to 安装" translate=no>​</a></h2>
<p>Firecracker 的<a href=https://github.com/firecracker-microvm/firecracker/releases target=_blank rel="noopener noreferrer">发布页</a>可直接下载每个版本。这里使用 curl 下载最新版并安装到 <code>/usr/loca/bin</code>。</p>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain"># 下载安装 firecracker 到 /usr/local/bin/firecracker</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">latest=$(basename $(curl -fsSLI -o /dev/null -w  %{url_effective} https://github.com/firecracker-microvm/firecracker/releases/latest))</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo curl -L -o /usr/local/bin/firecracker https://github.com/firecracker-microvm/firecracker/releases/download/${latest}/firecracker-${latest}-$(uname -m)</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo chmod +x /usr/local/bin/firecracker</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=rootfs>rootfs<a href=#rootfs class=hash-link aria-label="Direct link to rootfs" title="Direct link to rootfs" translate=no>​</a></h2>
<p>启动 firecracker 需要 kernel 和 rootfs，实际使用的时候可能大部分时间都是在准备 rootfs。这里使用 alpinelinux，功能完善构建简单。</p>
<p>因为 alpine 都会提供基础的 rootfs，这里直接下载解压到 ext4 的 loopdev 中。</p>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain"># 创建 root 盘</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">qemu-img create -f raw alpine.rootfs.ext4 1G</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 格式化为 ext4</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">mkfs.ext4 ./alpine.rootfs.ext4</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 挂载到 /tmp/rootfs</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">mkdir /tmp/rootfs</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo mount alpine.rootfs.ext4 /tmp/rootfs</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 下载 rootfs</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">curl -OJ https://mirrors.aliyun.com/alpine/v3.12/releases/x86_64/alpine-minirootfs-3.12.0-x86_64.tar.gz</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 安装到 /tmp/rootfs</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo tar zxvf alpine-minirootfs-3.12.0-x86_64.tar.gz -C /tmp/rootfs/</span><br/></span></code></pre></div></div>
<p>基础 rootfs 还不足以启动系统，因为无法进行系统 init，因此还需要在 rootfs 中安装必要的包启动必要的服务。</p>
<p>进入 rootfs 之前需要 resolv.conf，包含了 DNS 信息。</p>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain"># 拷贝 dns 配置 - 没有会无法进行 dns 解析</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo cp /etc/resolv.conf /tmp/rootfs/etc</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 如果主机是 alpinelinux 可以从主机拷贝配镜像置文件</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 如果不是建议设置镜像</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># sudo cp /etc/apk/repositories /tmp/rootfs/etc/apk/repositories</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># chroot 进入 rootfs 安装环境</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo chroot /tmp/rootfs/ /bin/sh</span><br/></span></code></pre></div></div>
<p>此时进入了 rootfs，因为没有挂载 procfs、sysfs 等目录，并不是一个能完整使用的 rootfs，但对于安装包来说已经足够。</p>
<ul>
<li><a href=https://pkgs.alpinelinux.org/package/v3.12/main/x86_64/alpine-base target=_blank rel="noopener noreferrer">alpine-base</a>
<ul>
<li>基础系统</li>
<li>依赖了 openrc，layout，busybox，apk，conf 等基础包</li>
</ul>
</li>
<li>linux-virt
<ul>
<li>virt 内核 - 不包含固件（200MB 左右），默认 init 包含 virtio 等内核模块</li>
<li>安装后能获取到内核和 initramfs</li>
<li>/boot 下 vmlinuz+initramfs+System.map 约 15MB - 启动是不需要的，拿到后可以删除</li>
</ul>
</li>
<li>haveged
<ul>
<li>随机熵服务</li>
<li>虚拟化环境能更快启动，否则熵初始化可能需要几分钟</li>
</ul>
</li>
</ul>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain">apk add alpine-base linux-virt haveged</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 开机启动</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">rc-update add haveged</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># root 账号密码</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">echo root:root | chpasswd</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 基础服务</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">for svc in devfs procfs sysfs; do ln -fs /etc/init.d/$svc /etc/runlevels/boot; done</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">exit</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># firecracker 使用 ttyS0</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">ln -s agetty /etc/init.d/agetty.ttyS0</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">echo ttyS0 > /etc/securetty</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">rc-update add agetty.ttyS0 default</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 从 rootfs 获取到 vmlinuz 和 initramfs</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo cp /tmp/rootfs/boot/initramfs-virt initramfs-virt</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo cp /tmp/rootfs/boot/vmlinuz-virt vmlinuz-virt</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 取消挂载</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo umount /tmp/rootfs</span><br/></span></code></pre></div></div>
<p>rootfs 准备完成。</p>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=vmlinuxinitrd>vmlinux+initrd<a href=#vmlinuxinitrd class=hash-link aria-label="Direct link to vmlinux+initrd" title="Direct link to vmlinux+initrd" translate=no>​</a></h2>
<p>这里解释一下 rootfs 拿到的 Linux 内核 vmlinuz-virt 和初始内存镜像 initramfs-virt</p>
<ul>
<li>vmlinuz-virt
<ul>
<li>压缩后的 Linux 内核 - 需要解压后 firecracker 才能识别</li>
<li>解压后为 ELF 格式可执行文件 - 与一般 Linux 下可执行文件相同</li>
</ul>
</li>
<li>initramfs-virt
<ul>
<li>压缩后的 cpio 格式</li>
<li>包含了 Linux 内核需要的 virtio 和 ext4 等模块</li>
<li>包含了 Alpine 的 init 系统
<ul>
<li>加载内核模块</li>
<li>找到并挂载 rootfs</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>因为内核是压缩后的，因此还需要进行解压</p>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain"># 下载安装 extract-vmlinux</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo curl -L -o /usr/local/bin/extract-vmlinux https://raw.githubusercontent.com/torvalds/linux/master/scripts/extract-vmlinux</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">sudo chmod +x /usr/local/bin/extract-vmlinux</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 解压 vmlinuz-virt</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">extract-vmlinux vmlinuz-virt > vmlinux-virt</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=启动>启动<a href=#启动 class=hash-link aria-label="Direct link to 启动" title="Direct link to 启动" translate=no>​</a></h2>
<p>所有准备工作已完成，得到</p>
<ul>
<li>alpine.rootfs.ext4 - 系统盘</li>
<li>vmlinux-virt - 内核</li>
<li>initramfs-virt - 初始内存镜像</li>
</ul>
<p>firecracker 有两种启动方式</p>
<ol>
<li>监听端口/socket</li>
</ol>
<ul>
<li>通过调用接口配置 rootfs、内核等</li>
<li>配置完成后请求 InstanceStart 进行启动</li>
</ul>
<ol start=2>
<li>通过配置文件配置</li>
</ol>
<ul>
<li>配置文件等同于接口请求</li>
<li>参数内容和路径与接口一致</li>
</ul>
<p>这里使用方法 #2，因为方便书写编辑简单。</p>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain"># 生成 alpine.json 配置</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">cat &lt;&lt;CONF > alpine.json</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">{</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">  "boot-source": {</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    "initrd_path": "initramfs-virt",</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    "kernel_image_path": "vmlinux-virt",</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    "boot_args": "console=ttyS0 reboot=k panic=1 pci=off modules=virtio_mmio,ext4 rootfstype=ext4"</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">  },</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">  "drives": [</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    {</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">      "drive_id": "rootfs",</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">      "path_on_host": "alpine.rootfs.ext4",</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">      "is_root_device": true,</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">      "is_read_only": false</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    }</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">  "machine-config": {</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    "vcpu_count": 1,</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    "mem_size_mib": 1024,</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    "ht_enabled": false</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">  }</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">}</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">CONF</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 配置完成 - 启动</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain"># 进入后使用 root:root 登陆</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">firecracker --api-sock /tmp/firecracker.socket --config-file alpine.json</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=停止>停止<a href=#停止 class=hash-link aria-label="Direct link to 停止" title="Direct link to 停止" translate=no>​</a></h2>
<div class="theme-admonition theme-admonition-caution admonition_phik alert alert--warning"><div class=admonitionHeading_zxjO><span class=admonitionIcon_bSNx><svg viewBox="0 0 16 16"><path fill-rule=evenodd d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"/></svg></span>Firecracker 不能正常关机</div><div class=admonitionContent_R6P7><p>firecracker 不能使用 poweroff 关机，如果使用了 poweroff 则只能 kill 进程来退出。</div></div>
<p>在系统之外可以请求 <code>Ctrl+Alt+Del</code> 进行关机，实质上是重启的效果，但因为 firecracker 不能重启，因此 init 退出后就关机了。</p>
<div class="language-bash codeBlockContainer_ljD1 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_rhaG><pre tabindex=0 class="prism-code language-bash codeBlock_mx9Q thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_NG8l><span class=token-line style=color:#bfc7d5><span class="token plain">curl --unix-socket /tmp/firecracker.socket -i \</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    -X PUT "http://localhost/actions" \</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    -H  "accept: application/json" \</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    -H  "Content-Type: application/json" \</span><br/></span><span class=token-line style=color:#bfc7d5><span class="token plain">    -d '{"action_type": "SendCtrlAltDel"}'</span><br/></span></code></pre></div></div>
<p>系统内可以直接 <code>reboot</code> 进行关机。</p>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=总结>总结<a href=#总结 class=hash-link aria-label="Direct link to 总结" title="Direct link to 总结" translate=no>​</a></h2>
<p>Firecracker 使用起来蛮惊艳，能成功的快速的启动系统，启动速度会比 QEMU 快不少，因为少了 bios、bootloader、内核解压 等过程。</p>
<p>因为 Firecracker 优缺点非常明显，这里总结一下适用场景：</p>
<ul>
<li>serveless 场景 - 需要快速起停，安全隔离，环境独立</li>
<li>处于安全考虑进行容器执行环境隔离 - 作为容器运行时</li>
<li>将应用打包为系统进行分发，使用 firecracker 屏蔽系统差异</li>
</ul>
<p>不适用场景也很明显：</p>
<ul>
<li>如果需要使用 CentOS、Debian、Ubuntu 之类系统，非常不建议
<ul>
<li>构造一个可使用的 rootfs 和 initramfs 非常麻烦</li>
</ul>
</li>
<li>需要用到的设备 firecracker 可能不支持</li>
<li>需要透传设备到 VM</li>
</ul>
<p>Firecracker 相对较新，集成使用方面还有所欠缺，但在 Firecracker 擅长的领域使用起来是非常舒服的。</p>
<h2 class="anchor anchorWithStickyNavbar_EG6R" id=参考>参考<a href=#参考 class=hash-link aria-label="Direct link to 参考" title="Direct link to 参考" translate=no>​</a></h2>
<ul>
<li><a href=https://gist.github.com/wenerme/97a2f088496bb3e6492ef7e8fe23da8a target=_blank rel="noopener noreferrer">boot-alpine-in-firecracker.sh</a> - 以上所有代码</li>
<li><a href=https://github.com/firecracker-microvm/firecracker target=_blank rel="noopener noreferrer">firecracker-microvm/firecracker</a> - 核心仓库</li>
<li><a href=https://github.com/firecracker-microvm/firectl target=_blank rel="noopener noreferrer">firecracker-microvm/firectl</a> - Golang 实现用于管理 firecracker 虚拟机的辅助工具</li>
<li><a href=https://github.com/firecracker-microvm/firecracker-go-sdk target=_blank rel="noopener noreferrer">firecracker-microvm/firecracker-go-sdk</a> - Golang 直接操作 Firecracker</li>
</ul></div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_noif padding--none margin-left--sm"><li class=tag_mzC7><a rel=tag class="tag_xI_x tagRegular_Q4uH" href=/story/tags/alpine-linux>AlpineLinux</a><li class=tag_mzC7><a rel=tag class="tag_xI_x tagRegular_Q4uH" href=/story/tags/firecracker>Firecracker</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href=https://github.com/wenerme/wener/edit/master/story/../story/2020/2020-10-23-alpine-in-firecracker.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_A7Jz aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_Hg3U"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/story/rancher-vs-kubesphere><div class=pagination-nav__sublabel>Newer post</div><div class=pagination-nav__label>Rancher vs. Kubesphere</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/story/kubernetes-vs-openstack><div class=pagination-nav__sublabel>Older post</div><div class=pagination-nav__label>Kubernetes vs OpenStack</div></a></nav></main><div class="col col--2"><div class="tableOfContents_wpyd thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#注意 class="table-of-contents__link toc-highlight">注意</a><li><a href=#安装 class="table-of-contents__link toc-highlight">安装</a><li><a href=#rootfs class="table-of-contents__link toc-highlight">rootfs</a><li><a href=#vmlinuxinitrd class="table-of-contents__link toc-highlight">vmlinux+initrd</a><li><a href=#启动 class="table-of-contents__link toc-highlight">启动</a><li><a href=#停止 class="table-of-contents__link toc-highlight">停止</a><li><a href=#总结 class="table-of-contents__link toc-highlight">总结</a><li><a href=#参考 class="table-of-contents__link toc-highlight">参考</a></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>笔记</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/notes/java>Java</a><li class=footer__item><a class=footer__link-item href=/notes/os/alpine>AlpineLinux</a><li class=footer__item><a class=footer__link-item href=/notes/devops/kubernetes>Kubernates</a><li class=footer__item><a class=footer__link-item href=/notes/voip>VoIP</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Projects</div><ul class="footer__items clean-list"><li class=footer__item>
              <div>
              <a class=footer__link-item href=https://github.com/wenerme/wener>Wener</a>
              -
              <a class=footer__link-item href=https://github.com/wenerme/wener/actions title="wenerme/wener - ci">
              <img style="vertical-align: middle;opacity: .4;" src=https://github.com/wenerme/wener/workflows/Build/badge.svg />
              </a>
              </div>
              <li class=footer__item><a href=https://apis.wener.me target=_blank rel="noopener noreferrer" class=footer__link-item>Wener's Apis<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_kUGX><use href=#theme-svg-external-link /></svg></a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Social</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/story>Blog</a><li class=footer__item><a href=https://github.com/wenerme target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub</a><li class=footer__item><a href=https://twitter.com/wenerme target=_blank rel="noopener noreferrer" class=footer__link-item>Twitter</a></ul></div></div><div class="footer__bottom text--center"><div class=margin-bottom--sm><img src=/img/wener-logo.svg alt="Wener Site" class="footer__logo themedComponent_j2y5 themedComponent--light_v877"/><img src=/img/wener-logo.svg alt="Wener Site" class="footer__logo themedComponent_j2y5 themedComponent--dark_PUQY"/></div><div class=footer__copyright>Copyright © 1992-2025 Wener - <img alt=cc-by-sa-4.0 src=https://mirrors.creativecommons.org/presskit/buttons/80x15/svg/by-sa.svg /> - Build @2025-10-09 13:46</div></div></div></footer></div></body>