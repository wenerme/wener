---
slug: get-started-with-dsl
title: å¦‚ä½•ä»0åˆ°1å®ç°ä¸€é—¨è¯­è¨€
tags:
  - å¼€å‘
  - è¯­è¨€
  - é˜¿é‡Œ
---

> è¯­è¨€å°±æ˜¯ç¨‹åºå‘˜çš„é…’ç²¾/Languages are alcohol to programmerã€‚ğŸº
> â¤ wener

<!--more-->

## DSL

DSL å…¨åä¸º Domain-specific Lnaguage/é¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œè¯´åˆ° domain-specific ä¼šä¸ä¼šç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ˜¯ DDD å‘¢ï¼ŸDDD ä¸­çš„è¯­è¨€å«åš Ubiquitous Languageï¼Œå³é€šç”¨è¯­è¨€ï¼ŒæŒ‡çš„æ˜¯åœ¨å½“å‰ Domain ä¸‹ä½¿ç”¨ç»Ÿä¸€çš„è‡ªç„¶è¯­è¨€è¿›è¡Œæ²Ÿé€šäº¤æµä¾¿äºä¸Šä¸‹æ–‡çš„ç†è§£å’Œæ²Ÿé€šã€‚DSL çš„ç›®çš„æ˜¯éå¸¸ç±»ä¼¼çš„ï¼Œä¸ºç‰¹å®šé¢†åŸŸå®ç°çš„è¯­è¨€ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›´åŠ é«˜æ•ˆä¾¿æ·çš„è§£å†³ç‰¹å®šé¢†åŸŸçš„é—®é¢˜ã€‚

DSL æ˜¯é¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œä¸ä¹‹ç›¸åçš„è¯­è¨€å«åš General purpose language/é€šç”¨è¯­è¨€ã€‚é€šç”¨è¯­è¨€å‡ä¸ºå›¾çµå®Œå¤‡è¯­è¨€ï¼Œè€Œ DSL åˆ™ä¸å¿…è¦å…·å¤‡è¿™æ ·çš„èƒ½åŠ›ã€‚ä¸€ä¸ªé€šç”¨è¯­è¨€ä¹Ÿæœ‰å…¶ç‰¹å®šçš„åº”ç”¨é¢†åŸŸï¼Œä¾‹å¦‚ ç³»ç»Ÿç¼–ç¨‹ã€Web ç¼–ç¨‹ã€è„šæœ¬ ç­‰ï¼Œæ¥åŒºåˆ«äºå…¶å®ƒè¯­è¨€ï¼Œå› æ­¤æŸç§ç¨‹åº¦ä¸Šæ¥è¯´é€šç”¨è¯­è¨€ä¹Ÿæ˜¯â€œDSLâ€ã€‚

**å¸¸è§çš„ DSL**

| è¯­è¨€ | é¢†åŸŸ       |
| ---- | ---------- |
| JSON | æ•°æ®äº¤æ¢   |
| CSS  | æ ·å¼ç¼–æ’   |
| SQL  | ç»“æ„æŸ¥è¯¢   |
| JSX  | ç»“æ„åŒ–ç»„ä»¶ |

ä½†æ— è®ºé¢†åŸŸä¸ºä½•ï¼ŒDSL æœ¬è´¨æ˜¯è¯­è¨€ï¼Œæœ‰ç‰¹å®šçš„è¯æ³•ã€è¯­æ³•å’Œä¸Šä¸‹æ–‡é€»è¾‘ã€‚å½“éœ€è¦å®ç°ä¸€ç§ DSL è¯­è¨€æ—¶ï¼Œéœ€è¦è€ƒè™‘

- è¯­è¨€çš„ç›®çš„
- æœŸæœ›çš„è¯­æ³•è¯æ³•
- å¤„ç†é€»è¾‘

é©±åŠ¨å®ç°ä¸€é—¨è¯­è¨€ï¼Œå¾€å¾€å› ä¸º

- è®¾è®¡ç†å¿µä¸åŒ
- æ›´å®‰å…¨å¯æ§ - é™åˆ¶è¯­è¨€èƒ½åŠ›
- ä¸ºåº”ç”¨æä¾›æ›´åŠ çµæ´»çš„å¤„ç†èƒ½åŠ› - è„šæœ¬
- æ‰©å±•ç°æœ‰è¯­è¨€å¢å¼ºè¡¨è¾¾èƒ½åŠ› - è½¬è¯‘ - JSXã€TS
- åˆ©ç”¨ç°æœ‰çš„è¿è¡Œç¯å¢ƒå®ç°æ›´ç®€æ´é«˜æ•ˆçš„è¯­è¨€ - Kotlinã€Elixir
- èƒ½å¤Ÿæ›´å¿«æ›´å®¹æ˜“çš„è§£å†³/æè¿°ç‰¹å®šé¢†åŸŸé—®é¢˜ - DSL

ç›®çš„ä¸åŒé©±åŠ¨å®ç°çš„æ–¹å¼ä¹Ÿå„ä¸ç›¸åŒï¼Œæ¯ç§çš„åšæ³•ä¹Ÿä¸å°½ç›¸åŒï¼Œåœ¨è¿™é‡Œä»¥å®ç°ä¸€ä¸ªç®€å•çš„æ•°å­¦è®¡ç®—è¯­è¨€ä½œä¸ºæ¼”ç¤ºã€‚

## å®ç°ä¸€é—¨è¯­è¨€

- ç›®çš„: å®ç°ç®€å•çš„æ•°å€¼è®¡ç®—ï¼Œæ”¯æŒåŸºæœ¬çš„ä¸‰è§’å‡½æ•°
- è¯­è¨€
  _ æ•°å­¦æ“ä½œæ”¯æŒ åŠ å‡ä¹˜é™¤
  _ ä¸‰è§’å‡½æ•°æ”¯æŒ sinã€cos \* è¿è¡Œæ—¶æ•°å€¼ç±»å‹å‡ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°

å½“è¯­è¨€çš„åŸºç¡€ç¡®å®šåï¼Œéœ€è¦å°†è¯­è¨€çš„è¯­æ³•ä»¥æŸç§å½¢å¼è¡¨ç°å‡ºæ¥ï¼Œè¡¨ç°è¯­è¨€è¯­æ³•çš„æ–¹å¼ä¹Ÿæ˜¯ä½¿ç”¨ä¸€é—¨è¯­è¨€(â™»ï¸ğŸ˜„)ã€‚[EBNF](https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form) - æ‰©å±•å·´ç§‘æ–¯èŒƒå¼ï¼Œè¯­æ³•è¡¨è¿°å¦‚ä¸‹

```
è¡¨è¾¾å¼ = æ“ä½œç¬¦è¡¨è¾¾å¼ | å‡½æ•°è¡¨è¾¾å¼ | æ•°å€¼
æ“ä½œç¬¦è¡¨è¾¾å¼ = è¡¨è¾¾å¼ æ“ä½œç¬¦ è¡¨è¾¾å¼
å‡½æ•°è¡¨è¾¾å¼ = å‡½æ•°å ( è¡¨è¾¾å¼ )
æ“ä½œç¬¦ = + | - | * | /
æ•°å€¼ = ä¸€ä¸ªæˆ–å¤šä¸ª æ•°å­—
æ•°å­— = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
```

è¯­æ³•èƒ½ç”¨é€šç”¨çš„ EBNF è¡¨è¿°å‡ºæ¥ï¼Œåœ¨å„ç§è¯­è¨€é‡Œé¢æœ‰å®ç°ç±»ä¼¼ EBNF è¡¨è¾¾è¯­è¨€è¯­æ³•ç»“æ„çš„åº“ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ [pegjs](https://pegjs.org) æ¥è¿›è¡ŒåŸå‹éªŒè¯å’Œå®éªŒã€‚

åœ¨ pegjs çš„[åœ¨çº¿ Demo](https://pegjs.org/online)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸€ä¸ªæ”¯æŒæ•°å­¦è¿ç®—çš„è¯­è¨€ã€‚ç°å°†å·¦ä¾§è¯­æ³•æ›¿æ¢ä¸ºå°†è¦å®ç°çš„è¯­æ³•æè¿°

```
è¡¨è¾¾å¼ = åŠ å‡è¡¨è¾¾å¼
åŠ å‡è¡¨è¾¾å¼  = ä¹˜é™¤è¡¨è¾¾å¼ (('+' / '-') ä¹˜é™¤è¡¨è¾¾å¼)*
ä¹˜é™¤è¡¨è¾¾å¼ = å‡½æ•°è¡¨è¾¾å¼ (('*' / '/') å‡½æ•°è¡¨è¾¾å¼)*
å‡½æ•°è¡¨è¾¾å¼ = å‡½æ•°å '(' è¡¨è¾¾å¼ ')' / æ•°å€¼
æ•°å€¼ = [0-9]+
å‡½æ•°å = [a-z]+
```

> ğŸ’¡ PEG
> ç»†å¿ƒçš„ä½ å¯èƒ½ä¼šå‘ç°æˆ‘ä»¬è¿™é‡Œå®šä¹‰çš„è¯­æ³•ä¸ EBNF æœ‰ä¸€å®šåŒºåˆ«ï¼Œä¾‹å¦‚å•ç‹¬å®šä¹‰äº† `åŠ å‡è¡¨è¾¾å¼`,`ä¹˜é™¤è¡¨è¾¾å¼`ï¼Œå¹¶ä¸”æ˜¯è‡ªé¡¶å‘ä¸‹åµŒå¥—çš„ï¼Œè€Œä¸æ˜¯ EBNF çš„ `è¡¨è¾¾å¼ = æ“ä½œç¬¦è¡¨è¾¾å¼ | å‡½æ•°è¡¨è¾¾å¼ | æ•°å€¼` ä¸€å±‚ç›´æ¥å±•å¼€ã€‚
>
> ä¹‹æ‰€ä»¥ä¹¦å†™æˆè¿™æ ·ï¼Œæ˜¯å› ä¸º pegjs æ˜¯ [PEG](https://en.wikipedia.org/wiki/Parsing_expression_grammar) ç±»çš„è§£æå™¨ï¼Œä¸èƒ½åšå·¦é€’å½’ã€‚è¯¥ç»†èŠ‚æ¶‰åŠåˆ°å¦‚ä½•å®ç°è¯­è¨€è§£æå’Œè¯­æ³•çš„ä¼˜å…ˆçº§å¤„ç†ï¼Œå°†ä¼šåœ¨é¢å¤–çš„æ–‡ç« ä¸­è¿›è¡Œé˜è¿°è§£é‡Šï¼Œå¹¶è®²è§£å¦‚ä½•å®ç°ä¸€ä¸ªè§£æè¯­è¨€çš„è¯­è¨€ã€‚

ç„¶ååœ¨å³ä¸Šè¾“å…¥è¡¨è¾¾å¼ `sin(1)*2+3`, è§£æå®Œæˆåï¼Œå³ä¸‹è§’å‡ºç°å¦‚ä¸‹ JSON å†…å®¹

```json
[[[["s", "i", "n"], "(", [[["1"], []], []], ")"], [["*", ["2"]]]], [["+", [["3"], []]]]]
```

è¯¥ JSON æ˜¯ pegjs çš„è¾“å‡ºï¼Œåœ¨æ²¡åšä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºè¯­æ³•æ ‘ã€‚å…¶ä¸­æ¯ä¸€ä¸ªæ•°ç»„å¯¹åº”äº†è¯­æ³•æè¿°ä¸­çš„ä¸€ä¸ªå®šä¹‰ã€‚ä¾‹å¦‚ `[ "s", "i", "n" ], "(", [ [ [ "1" ], [] ], [] ], ")"` å¯¹åº”è¯­æ³•æ ‘ä¸­çš„ `å‡½æ•°å '(' è¡¨è¾¾å¼ ')'`ï¼Œè¡¨ç¤ºå¯¹`1`æ‰§è¡Œå‡½æ•°`sin`ã€‚

ä¸ºäº†æ›´å¥½çš„å±•ç¤ºè¯­æ³•æ ‘ï¼Œæˆ‘ä»¬åœ¨è¯­æ³•æ ‘ä¸­è°ƒæ•´è¿”å›ç»“æœ

```
è¡¨è¾¾å¼ = åŠ å‡è¡¨è¾¾å¼
åŠ å‡è¡¨è¾¾å¼  = a:ä¹˜é™¤è¡¨è¾¾å¼ b:(op:('+' / '-') right:ä¹˜é™¤è¡¨è¾¾å¼ {return {type:'Op',op,right}})* {return b.reduce((left,right)=>(right.left=left,right),a)}
ä¹˜é™¤è¡¨è¾¾å¼ = a:å‡½æ•°è¡¨è¾¾å¼ b:(op:('*' / '/') right:å‡½æ•°è¡¨è¾¾å¼ {return {type:'Op',op,right}})* {return b.reduce((left,right)=>(right.left=left,right),a)}
å‡½æ•°è¡¨è¾¾å¼ = name:å‡½æ•°å '(' arg:è¡¨è¾¾å¼ ')' {return {type:'Func',name,arg}} / æ•°å€¼
æ•°å€¼ = [0-9]+ {return {type:'Int',value:parseInt(text())}}
å‡½æ•°å = [a-z]+ {return {type:'Name',name:text()}}
```

å¯¹åŒæ ·çš„è¡¨è¾¾å¼ `sin(1)*2+3` æˆ‘ä»¬å¾—åˆ°çš„è¯­æ³•æ ‘ä¸º

```json
{
  "type": "Op",
  "op": "+",
  "left": {
    "type": "Op",
    "op": "*",
    "left": { "type": "Func", "name": { "type": "Name", "name": "sin" }, "arg": { "type": "Int", "value": 1 } },
    "right": { "type": "Int", "value": 2 }
  },
  "right": { "type": "Int", "value": 3 }
}
```

è¿™æ—¶å€™çœ‹ä¸Šå»æ›´åƒæ˜¯æ ‘çš„ç»“æ„ï¼Œtype ä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„ç±»å‹ã€‚

- Func å‡½æ•°è°ƒç”¨èŠ‚ç‚¹ - æœ‰ name å’Œ arg å±æ€§
- Op æ•°å­¦æ“ä½œç¬¦èŠ‚ç‚¹ - æœ‰ opã€leftã€right å±æ€§
- Int æ•°å€¼èŠ‚ç‚¹ - æœ‰ value å±æ€§
- Name åå­—èŠ‚ç‚¹ - æœ‰ name å±æ€§

è¯­æ³•ç»“æ„è¡¨ç°çš„å†…å®¹ä¸è¡¨è¾¾å¼æœ¬èº«æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼Œå¯è®¤ä¸ºæ˜¯ç¨‹åº/è®¡ç®—æœºç†è§£çš„è¡¨è¾¾å¼ï¼Œæ˜¯æ›´åŠ ç»“æ„åŒ–çš„å†…å®¹ã€‚
è¯­æ³•æ ‘ä¼šæœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ï¼Œå› ä¸ºè¯­æ³•æ ‘ä¸è¡¨è¾¾å¼ç­‰ä»·ï¼Œä¹ŸåŒ…å«äº†å®Œæ•´çš„è®¡ç®—é€»è¾‘å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸éœ€è¦è§£æå™¨è¿›è¡Œè§£æã€‚å¯ç”¨äºç”Ÿæˆæ›´åŠ åº•å±‚çš„è¡¨ç°å½¢å¼ï¼Œä¹Ÿå¯ç”¨äºç›´æ¥æ‰§è¡Œã€‚åœºæ™¯çš„åœºæ™¯åŒ…å«

- ç”Ÿæˆ IR - ä¸­é—´å½¢å¼ï¼Œä¾¿äºè¿›è¡Œæ›´å¤šåç»­å¤„ç† - .Netã€GnuRTLã€LLVM
- ç”Ÿæˆæ±‡ç¼– - ç”Ÿæˆèƒ½ç›´æ¥åœ¨ç›®æ ‡å¹³å°æ‰§è¡Œçš„äºŒè¿›åˆ¶ - x86
- ä»£ç è½¬è¯‘ - åˆ©ç”¨ä¸€å®šçš„è§„åˆ™ç”ŸæˆéåŸå§‹ç±»å‹ä»£ç  - Gwt(Java to Js)ã€java2objc
- ä»£ç ä¼˜åŒ– - è¯­æ³•æ ‘ç»“æ„æ¯”è¾ƒé€šç”¨ï¼Œç¨‹åºä¾¿äºå¤„ç†ï¼Œå¯åˆ©ç”¨å…¬å…±çš„è§„åˆ™è¿›è¡ŒåŒ¹é…åˆ¤æ–­
- ä»£ç ç®€åŒ– - åœ¨ä¸å½±å“è¯­ä¹‰çš„æƒ…å†µä¸‹è°ƒæ•´ä»£ç  - UglifyJsã€ä»£ç æ··æ·† - ç”ŸæˆåŸå§‹ç±»å‹ä»£ç 
- ä»£ç åˆ†æ - é™æ€ç±»å‹ã€å®‰å…¨ã€â€œåâ€ä»£ç æ£€æµ‹
- ä»£ç ç´¢å¼• - ä¸€èˆ¬ç”Ÿæˆçš„è¯­æ³•æ ‘èŠ‚ç‚¹éƒ½å¯ä»¥åŒ…å«åŸå§‹ä»£ç ä½ç½®ï¼Œå¯å®ç°åŸºäºæ–¹æ³•æˆ–å¼•ç”¨ç­‰è¿›è¡Œå¿«é€Ÿç´¢å¼• - sourcegraph
- ä»£ç é¢„å¤„ç†
- ...

è¡¨è¾¾å¼è½¬æ¢æˆè¯­æ³•æ ‘ï¼Œå°±å¥½æ¯”ä½¿ç”¨æœºå™¨å­¦ä¹ ä»è‡ªç„¶è¯­è¨€ä¸­æŠ½å–å‡ºæ„å›¾ã€å®ä½“ã€ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯ï¼Œæ˜¯è®¡ç®—æœºå¯¹ç†è§£â€œäººâ€è¦åšä»€ä¹ˆçš„ç¬¬ä¸€æ­¥ã€‚

æ—¢ç„¶åŒæ ·çš„è¯­æ³•èƒ½è°ƒæ•´ä¸ºç”Ÿæˆè¯­æ³•æ ‘ï¼Œé‚£ä¹ˆä¹Ÿå°±èƒ½è°ƒæ•´ä¸ºç›´æ¥è®¡ç®—ç»“æœï¼Œå› æ­¤å¾—åˆ°å¦‚ä¸‹å†…å®¹

```
è¡¨è¾¾å¼ = åŠ å‡è¡¨è¾¾å¼
åŠ å‡è¡¨è¾¾å¼  = a:ä¹˜é™¤è¡¨è¾¾å¼ b:(('+' / '-') ä¹˜é™¤è¡¨è¾¾å¼)* {return b.reduce((r,[o,v])=>o=='+'?r+v:r-v,a)}
ä¹˜é™¤è¡¨è¾¾å¼ = a:å‡½æ•°è¡¨è¾¾å¼ b:(('*' / '/') å‡½æ•°è¡¨è¾¾å¼)* {return b.reduce((r,[o,v])=>o=='*'?r*v:r/v,a)}
å‡½æ•°è¡¨è¾¾å¼ = name:å‡½æ•°å '(' arg:è¡¨è¾¾å¼ ')' {return Math[name](arg)} / æ•°å€¼
æ•°å€¼ = [0-9]+ {return parseInt(text())}
å‡½æ•°å = [a-z]+ {return text()}
```

è¾“å…¥è¡¨è¾¾å¼ `sin(1)*2+3`ï¼Œå¾—åˆ°çš„è¾“å‡ºå€¼ä¸º `4.6829419696157935`ã€‚

è‡³æ­¤ï¼Œä¸€é—¨ç®€å•çš„è¯­è¨€ä¾¿éªŒè¯å®ç°å®Œæˆäº†ã€‚

## æ€»ç»“

pegjs æ˜¯éå¸¸æ–¹ä¾¿çš„å·¥å…·ï¼Œä½†å®é™…åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨æ—¶ï¼Œè¯­æ³•çš„è§£æå¤„ç†éœ€è¦åœ¨ä¸ªä¸ªè¯­è¨€é‡Œæ‰¾ç±»ä¼¼çš„å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è§£æä¸è®¡ç®—æ˜¯å¼‚æ„çš„ï¼Œä¾‹å¦‚é€šè¿‡æœåŠ¡ç«¯è§£æå®Œæˆï¼Œä¸‹å‘è¯­æ³•æ ‘åˆ°å®¢æˆ·ç«¯è¿›è¡Œæ‰§è¡Œã€‚è¿™ä¹Ÿä¸æœ€è¿‘ä¸€ä¸ª js æ ‡å‡†è¯·æ±‚çš„ç›®çš„ç±»ä¼¼,[tc39/proposal-binary-ast](https://github.com/tc39/proposal-binary-ast) å¸Œæœ›æµè§ˆå™¨èƒ½æ‰§è¡ŒäºŒè¿›åˆ¶çš„è¯­æ³•æ ‘ï¼Œè€Œä¸å†æ˜¯æ¯æ¬¡éƒ½è¿›è¡Œè§£æ jsï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚äºŒè¿›åˆ¶çš„è¯­æ³•æ ‘ä¸æ±‡ç¼–/bytecode å‡ ä¹åªæœ‰ä¸€çº¿ä¹‹éš”ï¼Œç„¶åè¿™ä¹Ÿæ­£æ˜¯[webassembly](https://webassembly.org/)çš„ç›®çš„ï¼Œç›´æ¥è®©æµè§ˆå™¨æ‰§è¡Œæ±‡ç¼–ï¼ŒğŸ˜„ã€‚è¯­è¨€ä¸è¿è¡Œç¯å¢ƒæ˜¯å‘¨è€Œå¤å§‹è¿­ä»£çš„ï¼Œå¤šä¹ˆçš„â€œè‡ªç„¶â€ã€‚

## é™„å½•ï¼šå¸¸ç”¨çš„è¯­æ³•è§£æå™¨

| è§£æå™¨    | ç›®æ ‡è¯­è¨€                             |
| --------- | ------------------------------------ |
| flex/yacc | C                                    |
| Antlr4    | Javaã€JSã€Pythonã€Switfã€C#ã€C++ã€Go |
| JavaCC    | Java                                 |
| pegjs     | JavaScript                           |

- [antlr/grammars-v4](https://github.com/antlr/grammars-v4)
  - å…¶ä¸­çš„ [Dart2](https://github.com/antlr/grammars-v4/blob/master/dart2/Dart2.g4) ç”±æˆ‘æäº¤
  - å‡å¦‚èƒ½å®ç°ä¸€ä¸ªé’ˆå¯¹ Dart2 çš„ JSXï¼Œé‚£ä¹ˆ Flutter çš„å¼€å‘å°†ä¼šæ›´åŠ ç¾å¥½ ğŸ¤©
- [Comparison of parser generators](https://en.wikipedia.org/wiki/Comparison_of_parser_generators)
