---
slug: rescue-root-disk
title: ç³»ç»Ÿç›˜æ¢å¤
tags:
  - AlpineLinux
  - è¿ç»´
---

# ç³»ç»Ÿç›˜æ¢å¤

å–œæ¬¢ä½¿ç”¨ é—ªå­˜ç›˜/U ç›˜ ä½œä¸º Linux ç³»ç»Ÿç›˜ï¼Œä½† U ç›˜ ä½¿ç”¨å¯¿å‘½æœ‰é™ï¼Œå½“å¼‚å¸¸åéœ€è¦å¯¹ç³»ç»Ÿç›˜è¿›è¡Œæ›´æ¢ã€‚

<!-- more -->

## ç°çŠ¶

ä½¿ç”¨ SanDisk CZ430 ä½œä¸º ç³»ç»Ÿç›˜/Root åˆ†åŒº

**lsblk**

```
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    1 114.6G  0 disk
â”œâ”€sda1   8:1    1   128M  0 part /boot
â””â”€sda2   8:2    1 114.4G  0 part /
```

**df -h /**

```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2       113G  2.2G  106G   2% /
```

åœ¨ä½¿ç”¨ä¸€æ®µæ—¶é—´åï¼Œ U ç›˜ å¼‚å¸¸ï¼Œç³»ç»Ÿè¢«é‡æ–°æŒ‚è½½ä¸ºåªè¯»ã€‚

```bash
touch ~/test
```

```
touch: cannot touch '/home/admin/test': Read-only file system
```

dmesg å¯çœ‹åˆ°å¼‚å¸¸ä¿¡æ¯ï¼Œå‡ ä¸ªæœˆå‰å·²ç»å‡ºé—®é¢˜äº†ï¼Œå› ä¸ºç³»ç»Ÿè¿˜èƒ½æ­£å¸¸ä½¿ç”¨æš‚ä¸”æ²¡ç®¡ã€‚

```dmesg title="dmesg -T"
[Tue Sep  7 16:48:16 2021] sd 2:0:0:0: [sda] tag#0 UNKNOWN(0x2003) Result: hostbyte=0x00 driverbyte=0x08 cmd_age=0s
[Tue Sep  7 16:48:16 2021] sd 2:0:0:0: [sda] tag#0 Sense Key : 0x7 [current]
[Tue Sep  7 16:48:16 2021] sd 2:0:0:0: [sda] tag#0 ASC=0x27 ASCQ=0x0
[Tue Sep  7 16:48:16 2021] sd 2:0:0:0: [sda] tag#0 CDB: opcode=0x2a 2a 00 00 04 16 90 00 00 08 00
[Tue Sep  7 16:48:16 2021] blk_update_request: critical target error, dev sda, sector 267920 op 0x1:(WRITE) flags 0x103000 phys_seg 1 prio class 0
[Tue Sep  7 16:48:16 2021] Buffer I/O error on dev sda2, logical block 466, lost async page write
```

## å¤‡ä»½æ¢å¤æ–¹æ¡ˆ

å°†ç°åœ¨æ•°æ®å®Œæ•´å¤‡ä»½åˆ°æ–°çš„ U ç›˜ï¼Œé‡å¯å³å¯ï¼Œä½†æ¢å¤å¤‡ä»½æœ‰å¥½å‡ ç§æ–¹å¼ã€‚

1.  å…¨ç›˜ dd

- é€Ÿåº¦æ…¢
- ç®€å•æš´åŠ›
- éœ€è¦æä¾›è‡³å°‘ç°åœ¨ç£ç›˜å¤§å°çš„å­˜å‚¨

2. é‡è£… - ä»…æ‹·è´æ•°æ®

- éº»çƒ¦

3. æ¢å¤åˆ†åŒºã€æ¢å¤æ•°æ®

- é«˜æ•ˆ
- éœ€è¦å¤šä¸€ç‚¹æ“ä½œ
- æ–°ç£ç›˜åªéœ€è¦å·²ç”¨ç©ºé—´å¤§å°å³å¯

## æ¢å¤

å› ä¸ºè¿™æ˜¯å·²ç»ç¬¬ä¸‰å››æ¬¡æ¢å¤äº†ï¼Œä¹‹å‰éƒ½æ˜¯ ddï¼Œä½†è¿™æ¬¡æ‰“ç®—ç”¨æ›´é«˜æ•ˆçš„æ–¹å¼ï¼Œä¸”è¿™æ¬¡çš„ç³»ç»Ÿç›˜ä¸º 128Gï¼Œä½†ç›®å‰åªæœ‰ 64G çš„ç©ºé—² U ç›˜ï¼Œæ•…é€‰æ‹©æ–¹æ¡ˆ 3ã€‚

**æ¢å¤è¿‡ç¨‹**

0. å‡†å¤‡å¤‡ä»½ç›˜
1. åˆ†åŒºè¡¨å¤‡ä»½ & å¯åŠ¨åˆ†åŒºå¤‡ä»½
2. root åˆ†åŒº å¤‡ä»½ & ä¿®å¤
3. éªŒè¯
4. å…³æœº
5. å–æ‰åçš„ U ç›˜
6. å¼€æœº

:::tip æ¢å¤å¤‡ä»½æ³¨æ„äº‹é¡¹

- é€‰æ‹©ä¸€ä¸ªå¯å†™ç›®å½• - tmpfs,shm - ä¾‹å¦‚: /run, /var/run, /tmp, /dev/shm

:::

### å‡†å¤‡å¤‡ä»½ç›˜

- å¤‡ä»½ç›˜ /dev/sdb 64Gï¼ŒåŒ SanDisk CZ430

```pre title="lsblk"
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    1 114.6G  0 disk
â”œâ”€sda1   8:1    1   128M  0 part /boot
â””â”€sda2   8:2    1 114.4G  0 part /
sdb      8:16   1  57.3G  0 disk
```

### åˆ†åŒºè¡¨&å¯åŠ¨åˆ†åŒºå¤‡ä»½

```bash
# ç¡®ä¿ä½¿ç”¨ root ç”¨æˆ·æ“ä½œ
sudo su
# è¿›å…¥å¯å†™ç›®å½•
cd /run

# æ­£å¸¸æƒ…å†µåˆ†åŒºè¡¨çš„å¤‡ä»½æ¢å¤
# sfdisk -d /dev/sda | sfdisk -f /dev/sdb

# é€‰æ‹©ç®€å•æ–¹å¼å¤‡ä»½åå†ä¿®æ”¹æœ€ååˆ†åŒº
# è¿™é‡Œ dd 130MB - åŒæ—¶æŠŠ boot åˆ†åŒºå¤‡ä»½äº†
dd if=/dev/sda of=/dev/sdb bs=1M count=130 status=progress

# è½¬å‚¨åˆ†åŒºè¡¨
sfdisk -d /dev/sda > sda.partition.table.txt
# åˆ é™¤ç¬¬äºŒä¸ªåˆ†åŒºçš„å¤§å°
sed -r '$ s/size=\s*\d+,//' -i sda.partition.table.txt
# é‡å»ºåˆ†åŒº
sfdisk -f /dev/sdb < sda.partition.table.txt
# ç°åœ¨åˆ†åŒºå¤§å°æ­£å¸¸
fdisk -l /dev/sdb

# åˆ†åŒºå˜åŒ–é‡æ–°æ‰«æ
mdev -s
partprobe
# å‡ºç°åˆ†åŒº
ls /dev/sdb*
```

### root åˆ†åŒºå¤‡ä»½

- root åˆ†åŒºä¸€èˆ¬è¾ƒå¤§ï¼Œç›´æ¥ dd æ…¢ä¸”ä¼¤ U ç›˜
- ç›´æ¥ dd éœ€è¦ç›®æ ‡ç›¸åŒå¤§å°ï¼Œå¦åˆ™ä¸¢æ•°æ®
- è¿™é‡Œä½¿ç”¨ clone æ•°æ®æ–¹å¼

:::caution ç”±äºç›®æ ‡åˆ†åŒºæ›´å°ï¼Œä¸èƒ½ç›´æ¥å¤åˆ¶

```bash
# ext4 æ•°æ®æ‹·è´ - åŸºäº ext4 blockï¼Œåªæ‹·è´ä½¿ç”¨éƒ¨åˆ†
# ä¹Ÿå¯ä»¥ç”¨äºç”Ÿæˆ img å¤‡ä»½é•œåƒä¹‹åç”¨
e2image -ra -p /dev/sda2 /dev/sdb2
```

- å¦‚æœåˆ†åŒºå¤§å°è¶³å¤Ÿï¼Œç›´æ¥å¤åˆ¶å³å¯

:::

å› ä¸º root åˆ†åŒºä¸º 120Gï¼Œä½†å®é™…åªç”¨äº† 2.2Gï¼Œ å…ˆé•œåƒåˆ†åŒºï¼Œç¼©å°åˆ†åŒºï¼Œç„¶åæ¢å¤åˆ°æ–°çš„åˆ†åŒºã€‚

ç´¢æ€§å†…å­˜æœ‰ 4Gï¼Œå› æ­¤ç›´æ¥åœ¨ /dev/shm æ“ä½œï¼Œå¦åˆ™éœ€è¦å¤–ç½®å­˜å‚¨ã€‚

```bash
# ä»æ–°æŒ‚è½½ä¸º 3G - é»˜è®¤ 2G
mount -o remount,size=3G /dev/shm
# åˆ¶ä½œé•œåƒ
e2image -rap /dev/sda2 sda2.raw

# ä¿®å¤åˆ†åŒº - ä¸€èˆ¬ Uç›˜ æŸåéƒ½ä¼šå¯¼è‡´ fs å¼‚å¸¸
e2fsck -y sda2.raw
# ç¼©å°åˆ†åŒº
resize2fs sda2.raw 4G
# æ¢å¤
e2image -rap sda2.raw /dev/sdb2
# æ‰©å±•åˆ†åŒº
resize2fs /dev/sdb2
```

### éªŒè¯

```bash
fsck /dev/sdb1
fsck /dev/sdb2

mount /dev/sdb2 /mnt
mount /dev/sdb1 /mnt/boot
# ä¸åº”è¯¥æœ‰å˜åŒ–
rsync -vna /boot/ /mnt/boot/

# ç”±äº fsck ä¿®å¤ï¼Œå¯èƒ½ root åˆ†åŒºå¤§å°ä¸åŒ
df / /mnt /boot /mnt/boot
```

å¦‚æœè£…æœ‰ qemuï¼Œè¿˜å¯ä»¥ç›´æ¥å¯ç”¨ qemu éªŒè¯ï¼Œç›®å‰å°±ç®€å•ç¡®è®¤æ–‡ä»¶æ²¡é—®é¢˜å³å¯ã€‚

```bash
# å‡†å¤‡å…³æœºé‡å¯
umount -R /mnt
eject /dev/sdb

poweroff
```

å–æ‰ åçš„ U ç›˜ï¼Œå¯åŠ¨ã€‚

ä¸€åˆ‡æ¢å¤æ­£å¸¸ã€‚ğŸ‰

## æ€»ç»“

ç³»ç»Ÿç›˜æ¢å¤è¿˜æ˜¯ç›¸å½“å®¹æ˜“ï¼Œä½† CZ430 ç¡®å®æœ‰ç‚¹è€äº†ï¼Œåœ¨ 2017 å¹´å·¦å³ä¸Šå¸‚ï¼Œç›¸åŒè§„æ ¼å·²ç»å– 4ã€5 å¹´äº†ï¼Œæ€§èƒ½å„æ–¹é¢æœ‰æ‰€æ¬ ç¼ºï¼Œä¹‹åä¼šå°½é‡é€‰æ‹© Lexar S47ã€‚

- https://wener.me/notes/ops/admin/fio-out/
  - SanDisk CZ430, Lexar S47 æ€§èƒ½å¯¹æ¯”

æ­¤å¤–ä½¿ç”¨ U ç›˜ åšç³»ç»Ÿç›˜çš„æ—¶å€™ï¼Œä¸€å®šæ³¨æ„ä¿®æ”¹ docker ä¹‹ç±»çš„æ•°æ®ç›®å½•ä¸ºå…¶ä»–å­˜å‚¨ï¼Œå› ä¸ºè·‘å®é™…åº”ç”¨çš„æ—¶å€™ U ç›˜ æ€§èƒ½æ˜¯ä¸è¶³çš„ï¼Œä¸”æ•°æ®åº“ç±»å‹åº”ç”¨çš„å° BlockSize IO ä¸é€‚åˆ U ç›˜ã€‚
