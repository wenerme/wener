"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["39190"],{10565:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>o,toc:()=>c,default:()=>h,metadata:()=>s,assets:()=>l,contentTitle:()=>d});var s=JSON.parse('{"id":"service/forge/drone/README","title":"drone","description":"- harness/drone","source":"@site/../notes/service/forge/drone/README.md","sourceDirName":"service/forge/drone","slug":"/service/forge/drone/","permalink":"/notes/service/forge/drone/","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/forge/drone/README.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1675652392000,"frontMatter":{"title":"drone"},"sidebar":"docs","previous":{"title":"ConcourseCI","permalink":"/notes/service/forge/concourse/"},"next":{"title":"Drone Pipeline","permalink":"/notes/service/forge/drone/pipeline"}}'),i=r(86106),t=r(17776);let o={title:"drone"},d="drone",l={},c=[{value:"server",id:"server",level:2},{value:"drone cli",id:"drone-cli",level:2},{value:"No stage specified, assuming &#39;default&#39;",id:"no-stage-specified-assuming-default",level:2},{value:"trigger: skipping build, no matching pipelines",id:"trigger-skipping-build-no-matching-pipelines",level:2},{value:"cannot accept stage error=&quot;Optimistic Lock Error&quot;",id:"cannot-accept-stage-erroroptimistic-lock-error",level:2},{value:"could not read Username",id:"could-not-read-username",level:2},{value:"http: no content returned: re-connect and re-try",id:"http-no-content-returned-re-connect-and-re-try",level:2}];function a(e){let n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"drone",children:"drone"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/harness/drone",children:"harness/drone"})}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note"})," \u5F00\u53D1\u4E0D\u6D3B\u8DC3"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"drone \u547D\u4EE4\u884C\u5DE5\u5177\u529F\u80FD\u76F8\u5BF9\u5B8C\u5584"}),"\n"]})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5728\u6CA1\u6709 build \u4E4B\u524D\u65E0\u6CD5\u521B\u5EFA build"}),"\n",(0,i.jsx)(n.li,{children:"UI \u4E0A\u5982\u679C\u6CA1\u6743\u9650\u4F1A\u76F4\u63A5\u5F02\u5E38 - \u7A7A\u767D"}),"\n",(0,i.jsxs)(n.li,{children:["\u6CE8\u518C\u7684\u7B2C\u4E00\u4E2A\u8D26\u53F7\u4E0D\u4F1A\u88AB\u8BA4\u4E3A\u662F admin\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u624B\u52A8\u4FEE\u6539 ",(0,i.jsx)(n.code,{children:"update users set user_admin=1 where user_login='drone';"})]}),"\n",(0,i.jsx)(n.li,{children:"\u6216\u8005 \u8BB0\u5F97\u8BBE\u7F6E DRONE_USER_CREATE=username:password,admin:true"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"\u6CA1\u5730\u65B9\u770B\u5F53\u524D\u8D26\u53F7\u7684\u540D\u5B57\u662F\u4EC0\u4E48"}),"\n",(0,i.jsxs)(n.li,{children:["kubernetes runner \u8FD8\u5904\u4E8E ",(0,i.jsx)(n.strong,{children:"\u5B9E\u9A8C\u9636\u6BB5"})," - \u4E0D\u63A8\u8350"]}),"\n",(0,i.jsxs)(n.li,{children:["exec runner \u4E0D\u7EF4\u62A4\u4E86\uFF0C\u65E0\u6CD5\u4F7F\u7528\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u63D2\u4EF6\u673A\u5236\u4F9D\u8D56 image \u8FD0\u884C"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"kubernetes secrets \u9700\u8981\u989D\u5916\u5B9A\u4E49 secret \u8D44\u6E90\uFF0C\u9700\u8981 name+key"}),"\n",(0,i.jsxs)(n.li,{children:["\u6709\u4E9B\u6587\u6863\u5728 ",(0,i.jsx)(n.a,{href:"https://docs.drone.io/",children:"https://docs.drone.io/"})," \u4FA7\u680F\u770B\u4E0D\u5230"]}),"\n"]})}),"\n",(0,i.jsx)(n.h2,{id:"server",children:"server"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ini",children:"# \u5FC5\u987B - \u9884\u751F\u4EA7\nDRONE_RPC_SECRET=\n# \u670D\u52A1\u4FE1\u606F - \u7528\u4E8E\u914D\u7F6E webhook \u4E4B\u7C7B\nDRONE_SERVER_HOST=\nDRONE_SERVER_PROTO=\n\n# \u4EE3\u7801\u4ED3\u5E93\nDRONE_GITEA_CLIENT_ID=\nDRONE_GITEA_CLIENT_SECRET=\nDRONE_GITEA_SERVER=\n\n#\nDRONE_GIT_ALWAYS_AUTH=\nDRONE_GIT_USERNAME=\nDRONE_GIT_PASSWORD=\n\n# \u53EF\u4FEE\u6539\u4F7F\u7528\u7684\u6570\u636E\u5E93 - \u9ED8\u8BA4\u4F7F\u7528 sqlite\nDRONE_DATABASE_DRIVER=postgres\nDRONE_DATABASE_DATASOURCE=postgres://root:password@1.2.3.4:5432/postgres?sslmode=disable\n\n# \u4F7F\u7528 s3 \u5B58\u50A8 build log - \u9ED8\u8BA4\u5B58\u50A8\u5728 sqlite\nAWS_ACCESS_KEY_ID=\nAWS_SECRET_ACCESS_KEY=\nAWS_DEFAULT_REGION=\nAWS_REGION=\n\nDRONE_S3_BUCKET=logs\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://docs.drone.io/server/reference/",children:"https://docs.drone.io/server/reference/"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"drone-cli",children:"drone cli"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# brew install drone\ncurl -L https://github.com/harness/drone-cli/releases/latest/download/drone_darwin_amd64.tar.gz | tar zx\ninstall -t ~/bin drone\n\nexport DRONE_SERVER=https://drone.example.com\nexport DRONE_TOKEN=\ndrone info\n\n# --branch=main --event=pull_request\n# --trusted \u63D0\u9AD8\u6743\u9650\ndrone exec                                     # \u672C\u5730\u6267\u884C .drone.yml\ndrone exec --pipeline=test                     # \u6267\u884C\u5355\u4E2A step - \u652F\u6301 --include,--exclude\ndrone exec --secret-file=.env.local            #\nDRONE_SYSTEM_HOST=drone.company.com drone exec #\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u7528 orgsecret \u80FD\u7B80\u5316\u4E00\u4E9B\u914D\u7F6E\ndrone orgsecret add org DOCKER_REGISTRY http://registry.example.com\ndrone orgsecret add org DOCKER_REGISTRY_USER user\ndrone orgsecret add org DOCKER_REGISTRY_PASSWORD user\n"})}),"\n",(0,i.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(n.h2,{id:"no-stage-specified-assuming-default",children:"No stage specified, assuming 'default'"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"drone exec\n"})}),"\n",(0,i.jsx)(n.h2,{id:"trigger-skipping-build-no-matching-pipelines",children:"trigger: skipping build, no matching pipelines"}),"\n",(0,i.jsx)(n.p,{children:"\u5220\u9664 trigger"}),"\n",(0,i.jsx)(n.h2,{id:"cannot-accept-stage-erroroptimistic-lock-error",children:'cannot accept stage error="Optimistic Lock Error"'}),"\n",(0,i.jsx)(n.p,{children:"\u4E00\u822C\u4E0D\u5F71\u54CD\uFF0C\u5E76\u53D1\u9519\u8BEF\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"could-not-read-username",children:"could not read Username"}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"exec runner \u73B0\u5728\u7528\u4E0D\u4E86"}),"\n"]})}),"\n",(0,i.jsx)(n.p,{children:"DRONE_GIT_ALWAYS_AUTH=true"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://community.harness.io/t/fatal-could-not-read-username-for/10998",children:"https://community.harness.io/t/fatal-could-not-read-username-for/10998"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://community.harness.io/t/solved-fatal-could-not-read-username-for-fqdn-terminal-prompts-disabled-gitea/11663",children:"https://community.harness.io/t/solved-fatal-could-not-read-username-for-fqdn-terminal-prompts-disabled-gitea/11663"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"gitea \u9700\u8981\u628A\u7528\u6237 add \u5230 org"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/appleboy/drone-git-push/issues/49",children:"https://github.com/appleboy/drone-git-push/issues/49"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"~/.netrc"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-.netrc",children:"machine github.com\nlogin technoweenie\npassword SECRET\n\nmachine api.github.com\nlogin technoweenie\npassword SECRET\n"})}),"\n",(0,i.jsx)(n.h2,{id:"http-no-content-returned-re-connect-and-re-try",children:"http: no content returned: re-connect and re-try"})]})}function h(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},17776:function(e,n,r){r.d(n,{R:()=>o,x:()=>d});var s=r(7378);let i={},t=s.createContext(i);function o(e){let n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);