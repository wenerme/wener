"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["58842"],{69721:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>r,toc:()=>h,default:()=>o,metadata:()=>l,assets:()=>c,contentTitle:()=>t});var l=JSON.parse('{"id":"devops/container/cni","title":"CNI","description":"- \u662F\u4EC0\u4E48\uFF1F","source":"@site/../notes/devops/container/cni.md","sourceDirName":"devops/container","slug":"/devops/container/cni","permalink":"/notes/devops/container/cni","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/container/cni.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1652772118000,"frontMatter":{"title":"CNI"},"sidebar":"docs","previous":{"title":"buildkit","permalink":"/notes/devops/container/buildkit"},"next":{"title":"colima","permalink":"/notes/devops/container/colima"}}'),s=i(86106),d=i(17776);let r={title:"CNI"},t="CNI",c={},h=[{value:"spec",id:"spec",level:2},{value:"bridge",id:"bridge",level:2},{value:"Windows",id:"windows",level:2},{value:"error while GETHNSNewtorkByName(mynet): hnsCall failed in Win32: The specified module could not be found. (0x7e)",id:"error-while-gethnsnewtorkbynamemynet-hnscall-failed-in-win32-the-specified-module-could-not-be-found-0x7e",level:2},{value:"failed to find plugin flannel in path /usr/libexec/cni",id:"failed-to-find-plugin-flannel-in-path-usrlibexeccni",level:2}];function a(n){let e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"cni",children:"CNI"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u662F\u4EC0\u4E48\uFF1F\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u62BD\u8C61\u5BB9\u5668\u7F51\u7EDC\u63A5\u53E3\u89C4\u8303"}),"\n",(0,s.jsx)(e.li,{children:"cni-plugins \u63D0\u4F9B\u4E86\u5927\u91CF\u5B9E\u73B0"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/containernetworking/cni",children:"containernetworking/cni"})," - \u89C4\u8303"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/containernetworking/plugins",children:"containernetworking/plugins"})," - \u53C2\u8003\u5B9E\u73B0\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://pkgs.alpinelinux.org/contents?branch=edge&name=cni-plugins&arch=x86_64&repo=community",children:"\u5305\u5185\u5BB9"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["alpine \u9ED8\u8BA4\u5B89\u88C5\u8DEF\u5F84 ",(0,s.jsx)(e.code,{children:"/usr/libexec/cni/"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u9ED8\u8BA4\u7F51\u7EDC\u914D\u7F6E\u76EE\u5F55 ",(0,s.jsx)(e.code,{children:"/etc/cni/net.d"})]}),"\n",(0,s.jsxs)(e.li,{children:["CNI \u5305\u542B\u4E86\u542F\u52A8\u811A\u672C - ",(0,s.jsx)(e.a,{href:"https://github.com/containernetworking/cni/tree/master/scripts",children:"cni/scripts"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u64CD\u4F5C netns - ",(0,s.jsx)(e.code,{children:"ip netns"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"exec-plugins add|del CNI_CONTAINERID CNI_NETNS"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["CNI_CONTAINERID - \u5BB9\u5668 ID\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u552F\u4E00\u6807\u793A\u76EE\u7684\uFF0C\u53EF\u4EE5\u968F\u673A\u751F\u6210"}),"\n",(0,s.jsx)(e.li,{children:"docker \u53EF\u76F4\u63A5\u4F7F\u7528 \u5BB9\u5668 ID"}),"\n",(0,s.jsxs)(e.li,{children:["\u4F8B\u5982 ",(0,s.jsx)(e.code,{children:"printf '%x%x%x%x' $RANDOM $RANDOM $RANDOM $RANDOM"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["CNI_NETNS - \u7F51\u7EDC\u547D\u540D\u7A7A\u95F4\u8DEF\u5F84\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"/proc/<pid>/ns/net"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/flannel-io/flannel",children:"flannel-io/flannel"})}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"warning",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["cni-plugins v1 \u4E4B\u540E\u4E0D\u5305\u542B flannel - AlpineLinux 3.15\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["apk add flannel -X ",(0,s.jsx)(e.a,{href:"https://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing",children:"https://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Type"}),(0,s.jsx)(e.th,{children:"Desc"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Main: \u7F51\u53E3\u521B\u5EFA"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"bridge"}),(0,s.jsx)(e.td,{children:"\u521B\u5EFA\u6865\u63A5\uFF0C\u6DFB\u52A0\u5BBF\u4E3B\u673A\u548C\u5BB9\u5668\u7F51\u7EDC\u5230\u6865\u63A5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"ipvlan"}),(0,s.jsx)(e.td,{children:"\u6DFB\u52A0 ipvlan \u5230\u5BB9\u5668"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"loopback"}),(0,s.jsx)(e.td,{children:"ip li set lo1 up"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"macvlan"}),(0,s.jsx)(e.td,{children:"\u521B\u5EFA macvlan \u7ED9\u5BB9\u5668\uFF0C\u8F6C\u53D1 mac \u6D41\u91CF"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"ptp"}),(0,s.jsx)(e.td,{children:"veth \u5BF9"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"vlan"}),(0,s.jsx)(e.td,{children:"\u521B\u5EFA vlan"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"host-device"}),(0,s.jsx)(e.td,{children:"\u900F\u4F20\u5DF2\u5B58\u5728\u8BBE\u5907"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Windows"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"win-bridge"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"win-overlay"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"IPAM: IP \u5730\u5740\u7533\u8BF7"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"dhcp"}),(0,s.jsx)(e.td,{children:"DHCP \u7533\u8BF7"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"host-local"}),(0,s.jsx)(e.td,{children:"\u7BA1\u7406\u672C\u5730\u7533\u8BF7\u5230\u7684 IP"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"static"}),(0,s.jsx)(e.td,{children:"\u4F7F\u7528\u9759\u6001\u5730\u5740"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Meta: \u5176\u4ED6\u63D2\u4EF6"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"flannel"}),(0,s.jsx)(e.td,{children:"\u57FA\u4E8E flannel \u751F\u6210\u7F51\u53E3"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"tuning"}),(0,s.jsx)(e.td,{children:"\u901A\u8FC7 sysctl \u4FEE\u6539\u7F51\u53E3\u914D\u7F6E"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"portmap"}),(0,s.jsx)(e.td,{children:"\u57FA\u4E8E iptables \u7684\u7AEF\u53E3\u6620\u5C04 - \u4E3B\u673A\u5730\u5740\u7AEF\u53E3\u5230\u5BB9\u5668"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"bandwidth"}),(0,s.jsx)(e.td,{children:"\u8FDB\u51FA\u5E26\u5BBD\u9650\u5236"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"sbr"}),(0,s.jsx)(e.td,{children:"\u57FA\u4E8E\u6765\u6E90\u7684\u8DEF\u7531"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"firewall"}),(0,s.jsx)(e.td,{children:"\u57FA\u4E8E iptables \u6216 firewalld \u7684\u9632\u706B\u5899\u63A7\u5236"})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"spec",children:"spec"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"add,delete,version"}),"\n",(0,s.jsx)(e.li,{children:"stdin, stdout"}),"\n",(0,s.jsx)(e.li,{children:"CNI_ARGS, CAP_ARGS"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'cat <<CONF > bridge.conf\n{\n  "name": "mynet",\n  "type": "bridge",\n  "ipam": {\n    "type":"host-local",\n    "subnet": "10.10.1.0/24"\n  }\n}\nCONF\nip netns add ns1\n\nCNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth2 CNI_PATH="$PWD" \\\nbridge < bridge.conf\n'})}),"\n",(0,s.jsx)(e.h2,{id:"bridge",children:"bridge"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "cniVersion": "0.3.1",\n  // \u7F51\u7EDC\u540D\u5B57\n  "name": "mynet",\n  // \u7F51\u7EDC\u7C7B\u578B - \u5BF9\u5E94 /usr/libexec/cni/\n  "type": "bridge",\n\n  // \u6865\u63A5\u540D\u5B57 - \u9ED8\u8BA4 cni0\n  "bridge": "cni0",\n  // \u8BBE\u7F6E\u7684 IP \u4F5C\u4E3A\u9ED8\u8BA4\u8DEF\u7531\n  "isDefaultGateway": false,\n  // \u8BBE\u5426\u8BBE\u7F6E\u65B0\u7684 IP \u5730\u5740\n  "forceAddress": false,\n  // \u662F\u5426\u914D\u7F6E masquerade\n  "ipMasq": false,\n  // MTU \u9ED8\u8BA4\u53D6\u51B3\u4E8E \u5185\u6838\n  "mtu": 0,\n  // hairpin \u6A21\u5F0F\n  "hairpinMode": false,\n  // IP \u5730\u5740\u7BA1\u7406 - L2 \u7F51\u7EDC\n  "ipam": {\n    "type": "host-local",\n    "subnet": "10.10.0.0/16"\n  },\n  // promiscuous \u6A21\u5F0F\n  "promiscMode": false\n  // \u662F\u5426\u8BBE\u7F6E VLAN tag\n  // "vlan":0\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"windows",children:"Windows"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"win-overlay"}),"\n",(0,s.jsx)(e.li,{children:"win-bridge"}),"\n",(0,s.jsx)(e.li,{children:"host-local"}),"\n",(0,s.jsx)(e.li,{children:"flannel"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'cat <<CONF > overlay.conf\n{\n	"name": "mynet",\n	"type": "win-overlay",\n	"ipMasq": true,\n	"endpointMacPrefix": "0E-2A",\n	"ipam": {\n		"type": "host-local",\n		"subnet": "10.10.0.0/16"\n	},\n  "loopbackDSR": true,\n  "capabilites": {\n      "dns": true\n  }\n}\nCONF\n\nCNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth2 CNI_PATH="$PWD" \\\n./win-overlay < overlay.conf\n'})}),"\n",(0,s.jsx)(e.h2,{id:"error-while-gethnsnewtorkbynamemynet-hnscall-failed-in-win32-the-specified-module-could-not-be-found-0x7e",children:"error while GETHNSNewtorkByName(mynet): hnsCall failed in Win32: The specified module could not be found. (0x7e)"}),"\n",(0,s.jsx)(e.h2,{id:"failed-to-find-plugin-flannel-in-path-usrlibexeccni",children:"failed to find plugin flannel in path /usr/libexec/cni"}),"\n",(0,s.jsx)(e.p,{children:"cni-plugins v1 \u540E\u6CA1\u6709 flannel"})]})}function o(n={}){let{wrapper:e}={...(0,d.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(a,{...n})}):a(n)}},17776:function(n,e,i){i.d(e,{R:()=>r,x:()=>t});var l=i(7378);let s={},d=l.createContext(s);function r(n){let e=l.useContext(d);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),l.createElement(d.Provider,{value:e},n.children)}}}]);