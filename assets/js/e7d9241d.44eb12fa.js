"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["57572"],{99858:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>l,toc:()=>t,default:()=>u,metadata:()=>i,assets:()=>c,contentTitle:()=>s});var i=JSON.parse('{"id":"devops/docker/docker-dind","title":"DID","description":"- 2376 - tls","source":"@site/../notes/devops/docker/docker-dind.md","sourceDirName":"devops/docker","slug":"/devops/docker/dind","permalink":"/notes/devops/docker/dind","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/docker/docker-dind.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1702882608000,"frontMatter":{"title":"DID"},"sidebar":"docs","previous":{"title":"credential helpers","permalink":"/notes/devops/docker/credential-helpers"},"next":{"title":"Dockerfile","permalink":"/notes/devops/docker/dockerfile"}}'),d=r(86106),o=r(17776);let l={title:"DID"},s="Docker In Docker",c={},t=[{value:"rootless",id:"rootless",level:2},{value:"buildx",id:"buildx",level:2},{value:"\u5B58\u5728 mtu \u95EE\u9898",id:"\u5B58\u5728-mtu-\u95EE\u9898",level:2},{value:"invalid TLS configuration: Could not load X509 key pair (cert: &quot;&quot;, key: &quot;&quot;): open : no such file or directory",id:"invalid-tls-configuration-could-not-load-x509-key-pair-cert--key--open--no-such-file-or-directory",level:2},{value:"could not change group /var/run/docker.sock to docker: group docker not found",id:"could-not-change-group-varrundockersock-to-docker-group-docker-not-found",level:2},{value:"libcontainerd: failed to save daemon pid to disk: process with PID 65 is still running",id:"libcontainerd-failed-to-save-daemon-pid-to-disk-process-with-pid-65-is-still-running",level:2},{value:"containerd is still running",id:"containerd-is-still-running",level:2}];function a(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"docker-in-docker",children:"Docker In Docker"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"2376 - tls"}),"\n",(0,d.jsx)(n.li,{children:"2375"}),"\n",(0,d.jsx)(n.li,{children:"cert 825d"}),"\n",(0,d.jsx)(n.li,{children:"\u624B\u52A8\u5173\u95ED tls --tls=fals --tlsverify=false"}),"\n"]}),"\n",(0,d.jsx)(n.admonition,{type:"caution",children:(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"\u6620\u5C04 sock \u5728\u91CD\u542F\u540E\u4F1A\u5931\u6548"}),"\n",(0,d.jsxs)(n.li,{children:["mtu \u6700\u597D\u8BBE\u7F6E <= 1450 - ",(0,d.jsx)(n.code,{children:"--mtu"})]}),"\n",(0,d.jsxs)(n.li,{children:["dind network create \u4E0D\u4F1A\u7EE7\u627F ",(0,d.jsx)(n.code,{children:"--mtu"})," \u53C2\u6570"]}),"\n"]})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# -e DOCKER_TLS_CERTDIR=/certs\n# /certs/ca\n# /certs/client - \u53EF\u6302\u8F7D\u7ED9\u5BA2\u6237\u7AEF\n# \u4E5F\u53EF\u901A\u8FC7 sock \u6302\u8F7D\u7ED9\u5BA2\u6237\u7AEF /var/run/docker.sock\n# \u8BBE\u7F6E DOCKER_TLS_CERTDIR \u4E3A\u7A7A\u5219\u7981\u7528 tls\uFF0C\u7AEF\u53E3\u4E3A 2375\ndocker run --rm -it \\\n  --privileged \\\n  -e DOCKER_TLS_CERTDIR='' \\\n  -v $PWD/data:/var/lib/docker \\\n  --name dind docker:dind --storage-driver overlay2\n\n# \u901A\u8FC7 HOST \u8C03\u7528\nexport DOCKER_HOST=tcp://dind:2375/\nexport DOCKER_DRIVER=overlay2\n# https://github.com/docker-library/docker/pull/166\nexport DOCKER_TLS_CERTDIR=''\n\ncurl --unix-socket /var/run/docker.sock http://localhost/images/json | jq\n"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://github.com/docker-library/docker/blob/master/23.0/dind/dockerd-entrypoint.sh",children:"https://github.com/docker-library/docker/blob/master/23.0/dind/dockerd-entrypoint.sh"})}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"rootless",children:"rootless"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["\u8BD5\u9A8C\u6027\u7684 rootless\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://github.com/docker-library/docker/pull/174",children:"docker-library/docker#174"})}),"\n",(0,d.jsxs)(n.li,{children:["\u8FD8\u662F\u9700\u8981 ",(0,d.jsx)(n.code,{children:"--privileged"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"docker run -d --name docker --privileged docker:dind-rootless\n"})}),"\n",(0,d.jsx)(n.h2,{id:"buildx",children:"buildx"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"BUILDX_VERSION=v0.10.4\n\nmkdir -p ~/.docker/cli-plugins\ncurl -sSLo ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/$BUILDX_VERSION/buildx-$BUILDX_VERSION.linux-amd64\nchmod +x ~/.docker/cli-plugins/docker-buildx\ndocker run --rm --privileged multiarch/qemu-user-static --reset -p yes\ndocker info\n"})}),"\n",(0,d.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,d.jsx)(n.h2,{id:"\u5B58\u5728-mtu-\u95EE\u9898",children:"\u5B58\u5728 mtu \u95EE\u9898"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"curl https \u7684\u65F6\u5019 hang"}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"--mtu=1400"})}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"invalid-tls-configuration-could-not-load-x509-key-pair-cert--key--open--no-such-file-or-directory",children:'invalid TLS configuration: Could not load X509 key pair (cert: "", key: ""): open : no such file or directory'}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["\u4E0D\u8981\u914D\u7F6E ",(0,d.jsx)(n.code,{children:"--tls=false --tlsverify=false"}),",\u53EF\u4EE5\u914D\u7F6E  ",(0,d.jsx)(n.code,{children:"--tls=false"})]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.a,{href:"https://github.com/moby/moby/issues/27105",children:"https://github.com/moby/moby/issues/27105"})}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"could-not-change-group-varrundockersock-to-docker-group-docker-not-found",children:"could not change group /var/run/docker.sock to docker: group docker not found"}),"\n",(0,d.jsxs)(n.p,{children:["\u6DFB\u52A0\u542F\u52A8\u53C2\u6570 ",(0,d.jsx)(n.code,{children:"--group=1000"})," \u6216"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"FROM docker:dind\nRUN addgroup -g 2999 docker\n"})}),"\n",(0,d.jsx)(n.h2,{id:"libcontainerd-failed-to-save-daemon-pid-to-disk-process-with-pid-65-is-still-running",children:"libcontainerd: failed to save daemon pid to disk: process with PID 65 is still running"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"rm /var/run/docker.pid\n"})}),"\n",(0,d.jsx)(n.h2,{id:"containerd-is-still-running",children:"containerd is still running"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:'level=info msg="containerd not running, starting managed containerd"\nlevel=info msg="containerd is still running" module=libcontainerd pid=943\n'})})]})}function u(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}},17776:function(e,n,r){r.d(n,{R:()=>l,x:()=>s});var i=r(7378);let d={},o=i.createContext(d);function l(e){let n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:l(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);