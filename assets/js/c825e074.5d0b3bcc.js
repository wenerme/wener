"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["964180"],{769683:function(n,e,t){t.r(e),t.d(e,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>o});var s=t(608167),l=t(486106),i=t(917776);let r={title:"PostgreSQL ORDER BY+LIMIT \u65F6\u7684\u7D22\u5F15\u9009\u62E9",slug:"postgresql-use-wrong-index-with-order-and-limit",tags:["PostgreSQL","DevOps"]},c="PostgreSQL ORDER BY+LIMIT \u65F6\u7684\u7D22\u5F15\u9009\u62E9",d={authorsImageUrls:[]},o=[{value:"\u7D22\u5F15\u9009\u62E9\u95EE\u9898",id:"\u7D22\u5F15\u9009\u62E9\u95EE\u9898",level:2},{value:"\u7D22\u5F15\u9009\u62E9\u539F\u56E0",id:"\u7D22\u5F15\u9009\u62E9\u539F\u56E0",level:2},{value:"\u89E3\u51B3\u95EE\u9898",id:"\u89E3\u51B3\u95EE\u9898",level:2},{value:"STATISTICS \u573A\u666F",id:"statistics-\u573A\u666F",level:2},{value:"\u53C2\u8003",id:"\u53C2\u8003",level:2}];function a(n){let e={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.p,{children:"\u5F53\u4F7F\u7528 ORDER BY+LIMIT \u65F6 PostgreSQL \u53EF\u80FD\u4F1A\u9009\u62E9\u66F4\u5DEE\u7684\u6267\u884C\u65B9\u5F0F\uFF0C\u6570\u636E\u91CF\u5927\u65F6\uFF0C\u6267\u884C\u6548\u7387\u76F8\u5DEE\u6210\u767E\u4E0A\u5343\u500D\u3002"}),"\n",(0,l.jsx)(e.h2,{id:"\u7D22\u5F15\u9009\u62E9\u95EE\u9898",children:"\u7D22\u5F15\u9009\u62E9\u95EE\u9898"}),"\n",(0,l.jsx)(e.p,{children:"\u5047\u8BBE\u7ED3\u6784\u5982\u4E0B"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"create table organizations(\n  id bigserial primary key,\n  jgmc text,\n  clrq date\n);\n\ncreate index if not exists idx_organizations_clrq on ic.organizations (clrq);\ncreate index if not exists idx_organizations_jgmc_fts on ic.organizations using pgroonga (jgmc);\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u67E5\u8BE2\u901A\u5E38\u57FA\u4E8E clrq \u6392\u5E8F\uFF0C\u4F46\u4F1A \u641C\u7D22 jgmc\u3002"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"explain analyse verbose\nselect jgmc, clrq, id\nfrom ic.organizations\nwhere jgmc &@~ '\u767E\u5EA6'\n  and clrq is not null\norder by clrq desc\nlimit 30 offset 0\n;\n"})}),"\n",(0,l.jsx)(e.admonition,{title:"\u4F7F\u7528\u4E86 clrq is not null \u800C\u975E nulls last",type:"tip",children:(0,l.jsxs)(e.p,{children:["\u56E0\u4E3A\u7D22\u5F15\u9ED8\u8BA4\u9690\u542B nulls last\uFF0C\u4E5F\u5C31\u662F\u8BF4 ",(0,l.jsx)(e.code,{children:"order by clrq asc"})," \u9690\u542B ",(0,l.jsx)(e.code,{children:"order by clrq asc nulls last"}),"\u3002\n\u5F53\u4F7F\u7528 ",(0,l.jsx)(e.code,{children:"order by clrq desc nulls last"})," \u65F6\u4E0D\u4F1A\u9009\u62E9 ",(0,l.jsx)(e.code,{children:"idx_organizations_clrq"})," \u7D22\u5F15\uFF0C\u56E0\u4E3A nulls \u987A\u5E8F\u4E0D\u5339\u914D\u3002\n\u56E0\u6B64\u4F7F\u7528 ",(0,l.jsx)(e.code,{children:"is not null"})," \u6392\u9664\u3002"]})}),"\n",(0,l.jsx)(e.p,{children:"\u7ED9\u51FA\u7684\u6267\u884C\u8BA1\u5212\u548C\u7ED3\u679C\u5982\u4E0B"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:'Limit  (cost=0.43..33132.51 rows=30 width=1284) (actual time=4678.918..13104.109 rows=6 loops=1)\n"  Output: jgmc, clrq, id"\n  ->  Index Scan Backward using idx_organizations_clrq on ic.organizations  (cost=0.43..4069724.46 rows=3685 width=1284) (actual time=4678.916..13104.101 rows=6 loops=1)\n"        Output: jgmc, clrq, id"\n        Index Cond: (organizations.clrq IS NOT NULL)\n        Filter: (organizations.jgmc &@~ \'\u767E\u5EA6\'::text)\n        Rows Removed by Filter: 3685166\nPlanning Time: 0.826 ms\nExecution Time: 13104.226 ms\n'})}),"\n",(0,l.jsx)(e.p,{children:"\u5B9E\u9645\u6267\u884C\u4E86 13s\uFF0C\u9009\u62E9\u4E86 idx_organizations_clrq \u7D22\u5F15\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u4F46\u5982\u679C\u53BB\u6389 LIMIT\uFF1A"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"explain analyse verbose\nselect jgmc, clrq, id\nfrom ic.organizations\nwhere jgmc &@~ '\u767E\u5EA6'\n  and clrq is not null\norder by clrq desc\n-- limit 30 offset 0\n;\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u7ED9\u51FA\u7684\u8BA1\u5212\u5982\u4E0B"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:'Sort  (cost=40479.53..40488.74 rows=3685 width=1284) (actual time=19.771..19.774 rows=6 loops=1)\n"  Output: jgmc, clrq, id"\n  Sort Key: organizations.clrq DESC\n  Sort Method: quicksort  Memory: 36kB\n  ->  Index Scan using idx_organizations_jgmc_fts on ic.organizations  (cost=0.00..40261.24 rows=3685 width=1284) (actual time=19.716..19.737 rows=6 loops=1)\n"        Output: jgmc, clrq, id"\n        Index Cond: (organizations.jgmc &@~ \'\u767E\u5EA6\'::text)\n        Filter: (organizations.clrq IS NOT NULL)\nPlanning Time: 0.706 ms\nExecution Time: 21.824 ms\n'})}),"\n",(0,l.jsx)(e.p,{children:"\u5B9E\u9645\u6267\u884C\u53EA\u9700\u8981 21ms\uFF0C\u9009\u62E9\u4E86 idx_organizations_jgmc_fts \u7D22\u5F15\u3002"}),"\n",(0,l.jsx)(e.p,{children:"PostgreSQL \u5728\u8FD9\u6837\u7684\u573A\u666F\u4E0B\u9009\u62E9\u4E86\u9519\u8BEF\u7684\u7D22\u5F15\uFF0C\u5BFC\u81F4\u67E5\u8BE2\u65F6\u95F4\u76F8\u5DEE 600 \u500D\u3002"}),"\n",(0,l.jsx)(e.h2,{id:"\u7D22\u5F15\u9009\u62E9\u539F\u56E0",children:"\u7D22\u5F15\u9009\u62E9\u539F\u56E0"}),"\n",(0,l.jsxs)(e.p,{children:["ORDER BY+LIMIT \u8BA9\u67E5\u8BE2\u6709 ",(0,l.jsx)(e.strong,{children:"\u63D0\u524D\u7ED3\u675F\u7684\u53EF\u80FD"}),"\u3002"]}),"\n",(0,l.jsx)(e.p,{children:"\u4F8B\u5982 \u5B9E\u9645\u6570\u636E 10k,\u4F46 limit 10, \u53EA\u9700\u4F7F\u7528\u7D22\u5F15\u626B\u63CF 10 \u6761\u6570\u636E\u4FBF\u53EF\u4EE5\u505C\u6B62\u6267\u884C\uFF0C\u800C\u4E0D\u9700\u8981\u5148\u5224\u65AD \u5176\u4ED6 \u6761\u4EF6\u3002"}),"\n",(0,l.jsxs)(e.p,{children:["\u56E0\u6B64 PostgreSQL \u7684 optimizer \u6709\u8BA9\u8FD9\u79CD\u9009\u62E9\u4F18\u5148\u7684\u903B\u8F91 ",(0,l.jsx)(e.a,{href:"https://github.com/postgres/postgres/blob/REL_13_STABLE/src/backend/optimizer/util/pathnode.c#L3633-L3753",children:"pathnode.c#L3633-L3753"}),"\u3002"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["create_limit_path \u9488\u5BF9 LIMIT/OFFSET \u521B\u5EFA\u6267\u884C\u8BA1\u5212\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"adjust_limit_rows_costs \u8C03\u6574\u6B64\u65F6\u7684 rows costs"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-c",metastring:'title="adjust_limit_rows_costs"',children:"*total_cost = *startup_cost +\n  (input_total_cost - input_startup_cost)\n  * count_rows / input_rows;\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{style:{textAlign:"right"},children:"var"}),(0,l.jsx)(e.th,{children:"meaning"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"total_cost"}),(0,l.jsx)(e.td,{children:"\u603B cost"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"startup_cost"}),(0,l.jsx)(e.td,{children:"\u521D\u59CB cost"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"input_total_cost"}),(0,l.jsx)(e.td,{children:"\u8F93\u5165\u603B cost"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"input_startup_cost"}),(0,l.jsx)(e.td,{children:"\u8F93\u5165\u521D\u59CB\u603B cost"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"count_rows"}),(0,l.jsx)(e.td,{children:"limit"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"input_rows"}),(0,l.jsx)(e.td,{children:"\u8F93\u5165 \u884C"})]})]})]}),"\n",(0,l.jsxs)(e.p,{children:["\u5728\u8FD9\u4E2A\u8C03\u6574\u903B\u8F91\u91CC\u4F1A\u5C06\u73B0\u5728\u7684\u8FC7\u7A0B cost ",(0,l.jsx)(e.code,{children:"input_total_cost - input_startup_cost"})," \u4E58\u4EE5 \u7CFB\u6570 ",(0,l.jsx)(e.code,{children:"count_rows / input_rows"}),"\u3002\n\u8FD9\u4E2A\u7CFB\u6570\u4FBF\u4F1A\u4F7F\u5F97 ORDER BY+LIMIT \u65F6\u4F18\u5148\u9009\u62E9\u7D22\u5F15\u3002"]}),"\n",(0,l.jsx)(e.p,{children:"\u56E0\u4E3A\u4E24\u4E2A\u8BA1\u5212\u7684 rows \u76F8\u540C\uFF0C\u4F18\u5148\u4E86 \u6392\u5E8F\u7D22\u5F15\u5219\u4F1A\u9009\u62E9\u6392\u5E8F\u7D22\u5F15\u65B9\u6848\u3002"}),"\n",(0,l.jsx)(e.h2,{id:"\u89E3\u51B3\u95EE\u9898",children:"\u89E3\u51B3\u95EE\u9898"}),"\n",(0,l.jsx)(e.admonition,{title:"\u76EE\u6807",type:"tip",children:(0,l.jsx)(e.p,{children:"\u907F\u514D\u9009\u62E9\u6392\u5E8F\u7D22\u5F15"})}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u4F7F\u7528 noop function \u907F\u514D\u7D22\u5F15"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"explain verbose\nselect clrq, jgmc, id\nfrom ic.organizations\nwhere jgmc &@~ '\u767E\u5EA6'\n  and clrq is not null\norder by coalesce(clrq) desc\nlimit 30 offset 0\n;\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u4F7F\u7528 expression \u907F\u514D\u7D22\u5F15"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"explain verbose\nselect clrq, jgmc, id\nfrom ic.organizations\nwhere jgmc &@~ '\u767E\u5EA6'\n  and clrq is not null\norder by clrq+0 desc\nlimit 30 offset 0\n;\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"3",children:["\n",(0,l.jsx)(e.li,{children:"\u6DFB\u52A0 nulls \u987A\u5E8F\u907F\u514D\u7D22\u5F15"}),"\n"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u56E0\u4E3A index \u9ED8\u8BA4 asc nulls last \u56E0\u6B64 asc \u548C desc \u9009\u62E9\u4E0D\u540C nulls \u987A\u5E8F"}),"\n",(0,l.jsx)(e.li,{children:"where is not null"}),"\n",(0,l.jsx)(e.li,{children:"desc nulls last"}),"\n",(0,l.jsx)(e.li,{children:"asc nulls first"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"explain verbose\nselect clrq, jgmc, id\nfrom ic.organizations\nwhere jgmc &@~ '\u767E\u5EA6'\n  and clrq is not null\norder by clrq desc nulls last\nlimit 30 offset 0\n;\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"4",children:["\n",(0,l.jsx)(e.li,{children:"\u8C03\u6574 STATISTICS"}),"\n"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5728\u4E24\u8005\u7EDF\u8BA1 rows \u4E0D\u540C\u7684\u60C5\u51B5\u4E0B - \u8FD9\u91CC\u4E0D\u9002\u7528"}),"\n",(0,l.jsx)(e.li,{children:"SET STATISTICS"}),"\n",(0,l.jsx)(e.li,{children:"CREATE STATISTICS"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"statistics-\u573A\u666F",children:"STATISTICS \u573A\u666F"}),"\n",(0,l.jsx)(e.p,{children:"STATISTICS \u5F71\u54CD n_distinct\uFF0Cn_distinct \u5F71\u54CD inputs_rows\uFF0C\u591A\u4E2A\u8BA1\u5212\u76F8\u540C\uFF0C\u53EF\u589E\u52A0 STATISTICS \u907F\u514D\u9519\u8BEF\u9009\u62E9\u7D22\u5F15\u3002"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"SELECT attname,\n       n_distinct,\n       null_frac\nFROM pg_stats\nWHERE tablename = 'organizations'\n  and attname in ('clrq', 'jgmc');\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"attname"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"n_distinct"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"null_frac"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"clrq"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"7914"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"0.00030666665"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"jgmc"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"-0.99441195"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"0.0030133333"})]})]})]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"SELECT relname, reltuples, relpages\nFROM pg_class\nWHERE relname LIKE 'organizations';\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"relname"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"reltuples"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"relpages"})]})}),(0,l.jsx)(e.tbody,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"organizations"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"3686376"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"1116103"})]})})]}),"\n",(0,l.jsx)(e.h2,{id:"\u53C2\u8003",children:"\u53C2\u8003"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://gocardless.com/blog/debugging-the-postgres-query-planner/",children:"https://gocardless.com/blog/debugging-the-postgres-query-planner/"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://dba.stackexchange.com/a/258986/234272",children:"https://dba.stackexchange.com/a/258986/234272"})}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(a,{...n})}):a(n)}},917776:function(n,e,t){t.d(e,{R:()=>r,x:()=>c});var s=t(7378);let l={},i=s.createContext(l);function r(n){let e=s.useContext(i);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:r(n.components),s.createElement(i.Provider,{value:e},n.children)}},608167:function(n){n.exports=JSON.parse('{"permalink":"/story/postgresql-use-wrong-index-with-order-and-limit","editUrl":"https://github.com/wenerme/wener/edit/master/story/../story/2021/2021-10-11-postgresql-use-wrong-index-with-order-and-limit.md","source":"@site/../story/2021/2021-10-11-postgresql-use-wrong-index-with-order-and-limit.md","title":"PostgreSQL ORDER BY+LIMIT \u65F6\u7684\u7D22\u5F15\u9009\u62E9","description":"\u5F53\u4F7F\u7528 ORDER BY+LIMIT \u65F6 PostgreSQL \u53EF\u80FD\u4F1A\u9009\u62E9\u66F4\u5DEE\u7684\u6267\u884C\u65B9\u5F0F\uFF0C\u6570\u636E\u91CF\u5927\u65F6\uFF0C\u6267\u884C\u6548\u7387\u76F8\u5DEE\u6210\u767E\u4E0A\u5343\u500D\u3002","date":"2021-10-11T00:00:00.000Z","tags":[{"inline":true,"label":"PostgreSQL","permalink":"/story/tags/postgre-sql"},{"inline":true,"label":"DevOps","permalink":"/story/tags/dev-ops"}],"readingTime":3.71,"hasTruncateMarker":true,"authors":[],"frontMatter":{"title":"PostgreSQL ORDER BY+LIMIT \u65F6\u7684\u7D22\u5F15\u9009\u62E9","slug":"postgresql-use-wrong-index-with-order-and-limit","tags":["PostgreSQL","DevOps"]},"unlisted":false,"prevItem":{"title":"\u7CFB\u7EDF\u76D8\u6062\u590D","permalink":"/story/rescue-root-disk"},"nextItem":{"title":"K3S vs K0S","permalink":"/story/k3s-vs-k0s"}}')}}]);