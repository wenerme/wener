"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["4769"],{74491:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>t,toc:()=>o,default:()=>h,metadata:()=>l,assets:()=>c,contentTitle:()=>a});var l=JSON.parse('{"id":"service/auth/opa/rego","title":"rego","description":"- undefined \u4E0D\u4E3A true \u4E5F\u4E0D\u4E3A false","source":"@site/../notes/service/auth/opa/rego.md","sourceDirName":"service/auth/opa","slug":"/service/auth/opa/rego","permalink":"/notes/service/auth/opa/rego","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/auth/opa/rego.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1736623457000,"frontMatter":{"title":"rego"},"sidebar":"docs","previous":{"title":"opal","permalink":"/notes/service/auth/opa/opal"},"next":{"title":"Ory","permalink":"/notes/service/auth/ory"}}'),s=i(86106),r=i(17776);let t={title:"rego"},a="rego",c={},o=[{value:"External Data",id:"external-data",level:2},{value:"Integration",id:"integration",level:2},{value:"\u5E38\u7528\u7ED3\u6784",id:"\u5E38\u7528\u7ED3\u6784",level:2},{value:"single-value rule data.example.headers conflicts with",id:"single-value-rule-dataexampleheaders-conflicts-with",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"rego",children:"rego"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["undefined \u4E0D\u4E3A true \u4E5F\u4E0D\u4E3A false\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u7C7B\u4F3C SQL \u91CC\u7684 null"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u53D7 ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Datalog",children:"Datalog"})," \u542F\u53D1"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/StyraInc/rego-style-guide",children:"StyraInc/rego-style-guide"})}),"\n",(0,s.jsxs)(n.li,{children:["Examples\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/plexsystems/konstraint/tree/main/examples",children:"https://github.com/plexsystems/konstraint/tree/main/examples"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/open-policy-agent/gatekeeper-library",children:"https://github.com/open-policy-agent/gatekeeper-library"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://rond-authz.io//docs/policy-integration",children:"https://rond-authz.io//docs/policy-integration"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/fugue/regula",children:"https://github.com/fugue/regula"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'# rule-name IS value IF body\n# \u591A\u4E2A\u8868\u8FBE\u5F0F\u4E3A AND\nv if { a:=1; a == 1\uFF1B 2 == 2 }\n# if \u53EF\u4EE5\u7701\u7565\nv { "hello" == "world" }\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u7C7B\u578B\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Scalar"}),"\n",(0,s.jsx)(n.li,{children:"String"}),"\n",(0,s.jsx)(n.li,{children:"Object"}),"\n",(0,s.jsx)(n.li,{children:"Set"}),"\n",(0,s.jsx)(n.li,{children:"Composite"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Comprehension\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Array ",(0,s.jsx)(n.code,{children:"[ <term> | <body> ]"})]}),"\n",(0,s.jsxs)(n.li,{children:["Object ",(0,s.jsx)(n.code,{children:"{ <key>: <term> | <body> }"})]}),"\n",(0,s.jsxs)(n.li,{children:["Set ",(0,s.jsx)(n.code,{children:"{ <term> | <body> }"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["future keyword\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"if, in, every, contains"}),"\n",(0,s.jsx)(n.li,{children:"contains \u548C if \u662F\u53EF\u9009\u7684"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"import future.keywords.if"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Complete Definition\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u503C\u4E0D\u53EF\u53D8"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["implicit\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"data, input"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"unification"})," operator ",(0,s.jsx)(n.code,{children:"="}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"assignment + comparison"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:":="})," + ",(0,s.jsx)(n.code,{children:"=="})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"METADATA"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["YAML\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"title"}),"\n",(0,s.jsx)(n.li,{children:"description"}),"\n",(0,s.jsx)(n.li,{children:"related_resources"}),"\n",(0,s.jsx)(n.li,{children:"authors"}),"\n",(0,s.jsx)(n.li,{children:"organizations"}),"\n",(0,s.jsx)(n.li,{children:"schemas"}),"\n",(0,s.jsx)(n.li,{children:"custom"}),"\n",(0,s.jsx)(n.li,{children:"scope - package, rule, document, subpackages"}),"\n",(0,s.jsxs)(n.li,{children:["entrypoint\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"--prune-unused"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:"# METADATA\n# title: My rule\n# description: A rule that determines if x is allowed.\n# authors:\n# - John Doe <john@example.com>\n# entrypoint: true\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'\n# METADATA\n# schemas:\n#   - input: schema.input\n#   - data.acl: schema["acl-schema"]\nallow {\n    access := data.acl["alice"]\n    access[_] == input.operation\n}\n\n# METADATA\n# schemas:\n#   - input.x: {type: number}\nallow {\n    input.x == 42\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u901A\u8FC7 Metadata \u5B9A\u4E49\u8FD4\u56DE\u7ED3\u679C"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'# METADATA\n# title: Example\n# description: Example package with documentation\npackage example\n\nimport future.keywords.contains\nimport future.keywords.if\n\n# METADATA\n# title: Deny non admin users\n# description: Only admin users are allowed to access these resources\n# related_resources:\n# - https://docs.example.com/policy/rule/E123\n# custom:\n#   code: 401\n#   error_id: E123\ndeny contains {\n	"code": metadata.custom.code,\n	"message": sprintf("Unauthorized due to policy rule (%s, %s)", [\n		metadata.custom.error_id,\n		concat(",", [ref | ref := metadata.related_resources[_].ref]),\n	]),\n} if {\n	input.admin == false\n\n	metadata := rego.metadata.rule()\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"schema \u901A\u8FC7 --schema \u6307\u5B9A"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/policy-language/#metadata",children:"https://www.openpolicyagent.org/docs/latest/policy-language/#metadata"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"with"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'ok:= false\nh := r  if {\n	ok;\n	r := {"OK":1, "X":input.X}\n}\n\nh := r  if {\n	not ok;\n	r := {"OK":0, "X":input.X}\n}\n\nh2 := r if {\n	r:= h with input as {"X":2}\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"external-data",children:"External Data"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"http.send"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/policy-reference/#http",children:"https://www.openpolicyagent.org/docs/latest/policy-reference/#http"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/nicolasff/webdis",children:"https://github.com/nicolasff/webdis"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Redis -> HTTP"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/external-data",children:"https://www.openpolicyagent.org/docs/latest/external-data"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/open-policy-agent/opa/issues/2169",children:"https://github.com/open-policy-agent/opa/issues/2169"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"integration",children:"Integration"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["rego -> sql\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/open-policy-agent/contrib/blob/main/data_filter_example/data_filter_example/opa.py",children:"https://github.com/open-policy-agent/contrib/blob/main/data_filter_example/data_filter_example/opa.py"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"http://localhost:8181/v1/compile"})," -> ast -> sql"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://blog.openpolicyagent.org/write-policy-in-opa-enforce-policy-in-sql-d9d24db93bf4",children:"https://blog.openpolicyagent.org/write-policy-in-opa-enforce-policy-in-sql-d9d24db93bf4"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["minio\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/minio/minio/blob/master/docs/iam/opa.md",children:"https://github.com/minio/minio/blob/master/docs/iam/opa.md"})}),"\n",(0,s.jsx)(n.li,{children:"MINIO_POLICY_PLUGIN_URL"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5E38\u7528\u7ED3\u6784",children:"\u5E38\u7528\u7ED3\u6784"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'# \u591A\u4E2A\u89C4\u5219\ndeny[message] if {\n  condition\n  message := "Why";\n}\n\n# \u6700\u7EC8\nallowed if {\n  true\n}\n'})}),"\n",(0,s.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(n.h2,{id:"single-value-rule-dataexampleheaders-conflicts-with",children:"single-value rule data.example.headers conflicts with"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'headers := {\n    "X-OK": "OK",\n}\n\nheaders["X-OK"] = 1\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u5355\u4E2A\u503C"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rego",children:'headers := {\n    "X-OK": "X"\n} if {}\nelse = {\n    "X-OK": 1\n}\n'})})]})}function h(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},17776:function(e,n,i){i.d(n,{R:()=>t,x:()=>a});var l=i(7378);let s={},r=l.createContext(s);function t(e){let n=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);