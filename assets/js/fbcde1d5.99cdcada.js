"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["53666"],{19243:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>d,toc:()=>a,default:()=>o,metadata:()=>s,assets:()=>c,contentTitle:()=>t});var s=JSON.parse('{"id":"os/virt/qemu/qemu-faq","title":"QEMU FAQ","description":"- 7 ways we harden our KVM hypervisor at Google Cloud: security in plaintext","source":"@site/../notes/os/virt/qemu/qemu-faq.md","sourceDirName":"os/virt/qemu","slug":"/os/virt/qemu/faq","permalink":"/notes/os/virt/qemu/faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/virt/qemu/qemu-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1743657456000,"frontMatter":{"title":"QEMU FAQ","tags":["FAQ"]},"sidebar":"docs","previous":{"title":"QEMU \u6587\u6863","permalink":"/notes/os/virt/qemu/doc"},"next":{"title":"Qemu Image","permalink":"/notes/os/virt/qemu/img"}}'),l=i(86106),r=i(17776);let d={title:"QEMU FAQ",tags:["FAQ"]},t="QEMU FAQ",c={},a=[{value:"\u6301\u5D4C\u5957\u865A\u62DF\u5316",id:"\u6301\u5D4C\u5957\u865A\u62DF\u5316",level:2},{value:"RNG",id:"rng",level:2},{value:"\u73AF\u5883\u68C0\u6D4B",id:"\u73AF\u5883\u68C0\u6D4B",level:2},{value:"\u8BBF\u95EE\u8FDC\u7A0B\u955C\u50CF",id:"\u8BBF\u95EE\u8FDC\u7A0B\u955C\u50CF",level:2},{value:"qemu: uncaught target signal 4 (Illegal instruction) - core dumped",id:"qemu-uncaught-target-signal-4-illegal-instruction---core-dumped",level:2},{value:"qemu-s390x: warning: &#39;msa5-base&#39; requires &#39;klmd-sha-512&#39;",id:"qemu-s390x-warning-msa5-base-requires-klmd-sha-512",level:2},{value:"virtfs",id:"virtfs",level:2},{value:"convert \u540E\u65E0\u6CD5\u542F\u52A8",id:"convert-\u540E\u65E0\u6CD5\u542F\u52A8",level:2},{value:"Overhead",id:"overhead",level:2},{value:"\u786C\u4EF6\u52A0\u901F",id:"\u786C\u4EF6\u52A0\u901F",level:2},{value:"USB",id:"usb",level:2},{value:"-accel kvm: failed to initialize kvm: Permission denied",id:"-accel-kvm-failed-to-initialize-kvm-permission-denied",level:2},{value:"\u9F20\u6807\u504F\u79FB",id:"\u9F20\u6807\u504F\u79FB",level:2},{value:"usb",id:"usb-1",level:2},{value:"Cannot enable HVF when guest CPU has EL3 enabled",id:"cannot-enable-hvf-when-guest-cpu-has-el3-enabled",level:2},{value:"TBD",id:"tbd",level:2}];function h(e){let n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"qemu-faq",children:"QEMU FAQ"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://cloudplatform.googleblog.com/2017/01/7-ways-we-harden-our-KVM-hypervisor-at-Google-Cloud-security-in-plaintext.html",children:"7 ways we harden our KVM hypervisor at Google Cloud: security in plaintext"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u6301\u5D4C\u5957\u865A\u62DF\u5316",children:"\u6301\u5D4C\u5957\u865A\u62DF\u5316"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5927\u591A\u4E91\u5E73\u53F0\u90FD\u4E0D\u652F\u6301\u5D4C\u5957\u865A\u62DF\u5316"}),"\n",(0,l.jsx)(n.li,{children:"\u88F8\u91D1\u5C5E\u670D\u52A1\u5668 \u652F\u6301\u865A\u62DF\u5316"}),"\n",(0,l.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://cloud.google.com/compute/docs/instances/nested-virtualization/overview",children:"GCP \u5D4C\u5957\u865A\u62DF\u5316\u7B80\u4ECB"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Intel Haswell+\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Sandy Bridge, Ivy Bridge \u4E0D\u53EF\u4EE5"}),"\n",(0,l.jsx)(n.li,{children:"AMD \u4E0D\u53EF\u4EE5"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://ignite.readthedocs.io/en/stable/cloudprovider/",children:"Cloud Provider Instances with KVM support"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"GCP - \u6240\u6709\u652F\u6301"}),"\n",(0,l.jsx)(n.li,{children:"DO - \u6240\u6709\u652F\u6301"}),"\n",(0,l.jsx)(n.li,{children:"Azure Dv3, Ev3 - 4C16G+ - $140/mo"}),"\n",(0,l.jsx)(n.li,{children:"Packet - 4C8G+ - ~$50/mo"}),"\n",(0,l.jsxs)(n.li,{children:["AWS ",(0,l.jsx)(n.code,{children:"*.metal"})," - \u88F8\u91D1\u5C5E\u670D\u52A1\u5668 - 48CPU+"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"rng",children:"RNG"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u5EFA\u8BAE\u9ED8\u8BA4\u6DFB\u52A0\uFF0C\u5426\u5219\u53EF\u80FD\u5BFC\u81F4\u975E\u5E38\u6162\u610F\u5916 Hang \u4F4F"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"-device virtio-rng-pci\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u9ED8\u8BA4 ",(0,l.jsx)(n.code,{children:"/dev/random"}),"\u3002 \u53EF\u81EA\u5B9A\u4E49\u53C2\u6570"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"-object rng-random,filename=/dev/hwrng,id=rng0 -device virtio-rng-pci,rng=rng0\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"qemu-system-x86_64 -object rng-random,filename=/dev/urandom,id=rng0 -device virtio-rng-pci,rng=rng0,bus=pci.0,addr=0x7\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.qemu.org/docs/master/system/devices/vhost-user-rng.html",children:"https://www.qemu.org/docs/master/system/devices/vhost-user-rng.html"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u73AF\u5883\u68C0\u6D4B",children:"\u73AF\u5883\u68C0\u6D4B"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# KVM \u8981\u6C42 Intel VT, AMD-V\negrep '(vmx|svm)' /proc/cpuinfo\n\nmodprobe kvm\nmodprobe kvm-intel\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u8BBF\u95EE\u8FDC\u7A0B\u955C\u50CF",children:"\u8BBF\u95EE\u8FDC\u7A0B\u955C\u50CF"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# apk add qemu-block-ssh\nqemu -drive file=ssh://host/path/to/file,if=virtio,cache=none\n"})}),"\n",(0,l.jsx)(n.h2,{id:"qemu-uncaught-target-signal-4-illegal-instruction---core-dumped",children:"qemu: uncaught target signal 4 (Illegal instruction) - core dumped"}),"\n",(0,l.jsx)(n.p,{children:"ppc64le \u5F02\u5E38"}),"\n",(0,l.jsx)(n.h2,{id:"qemu-s390x-warning-msa5-base-requires-klmd-sha-512",children:"qemu-s390x: warning: 'msa5-base' requires 'klmd-sha-512'"}),"\n",(0,l.jsx)(n.p,{children:"s390x \u5F02\u5E38"}),"\n",(0,l.jsx)(n.h2,{id:"virtfs",children:"virtfs"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://wiki.qemu.org/Documentation/9psetup",children:"https://wiki.qemu.org/Documentation/9psetup"})}),"\n",(0,l.jsxs)(n.p,{children:["ProjectZero\nQEMU: virtfs permits guest to access entire host filesystem\n",(0,l.jsx)(n.a,{href:"https://news.ycombinator.com/item?id=13753950",children:"https://news.ycombinator.com/item?id=13753950"})]}),"\n",(0,l.jsx)(n.h2,{id:"convert-\u540E\u65E0\u6CD5\u542F\u52A8",children:"convert \u540E\u65E0\u6CD5\u542F\u52A8"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5728 macOS \u4E0B\u4ECE qcow2 \u8F6C\u6362\u4E3A raw \u540E\u5206\u533A\u4FE1\u606F\u4E22\u5931"}),"\n",(0,l.jsx)(n.li,{children:"Linux \u672A\u9047\u5230\u8FD9\u6837\u7684\u95EE\u9898"}),"\n",(0,l.jsx)(n.li,{children:"\u8F6C\u6362\u540E\u53EF\u4F7F\u7528 fdisk \u68C0\u67E5\u5206\u533A\u4FE1\u606F"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"overhead",children:"Overhead"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"http://www.brightcomputing.com/blog/containerization-vs.-virtualization-more-on-overhead",children:"Containerization vs. Virtualization \u2013 More on Overhead"})}),"\n",(0,l.jsx)(n.h2,{id:"\u786C\u4EF6\u52A0\u901F",children:"\u786C\u4EF6\u52A0\u901F"}),"\n",(0,l.jsx)(n.p,{children:"\u5F00\u542F\u786C\u4EF6\u52A0\u901F\u548C\u4E0D\u5F00\u542F\u6027\u80FD\u53EF\u80FD\u76F8\u5DEE 10 \u500D+\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"qemu-system-x86_64 -accel help\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"tcg - JIT \u6A21\u5F0F"}),"\n",(0,l.jsxs)(n.li,{children:["macOS - hvf, hax\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"hvf \u5B9E\u73B0\u4E0D\u662F\u5F88\u5B8C\u6574\uFF0C\u53EF\u80FD\u4F1A\u51FA\u73B0\u65E0\u6CD5\u8FD0\u884C\u7684\u60C5\u51B5"}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679C\u52A0\u901F\u6709\u95EE\u9898\uFF0C\u5C1D\u8BD5\u4FEE\u6539 smp \u4E3A 1"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Windows - hyper, hax"}),"\n",(0,l.jsx)(n.li,{children:"Linux - kvm"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"usb",children:"USB"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/qemu/qemu/blob/master/docs/usb2.txt",children:"https://github.com/qemu/qemu/blob/master/docs/usb2.txt"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://unix.stackexchange.com/a/251406/47774",children:"https://unix.stackexchange.com/a/251406/47774"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"qemu-system-x86_64 \\\n  -enable-kvm \\\n  -M q35 \\\n  -m 2G \\\n  -usb -usbdevice host:16b2:1001 \\\n  -usb -usbdevice host:0529:0001 \\\n  -usbdevice tablet \\\n  -net nic \\\n  -net bridge,br=br0 \\\n  -vga qxl \\\n  -spice port=5930,disable-ticketing \\\n  -device virtio-serial-pci \\\n  -device virtserialport,chardev=spicechannel0,name=com.redhat.spice.0 \\\n  -chardev spicevmc,id=spicechannel0,name=vdagent \\\n  -drive file=/mnt/data/win-patch.img,if=virtio\n"})}),"\n",(0,l.jsx)(n.h2,{id:"-accel-kvm-failed-to-initialize-kvm-permission-denied",children:"-accel kvm: failed to initialize kvm: Permission denied"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"addgroup $USER kvm\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u9F20\u6807\u504F\u79FB",children:"\u9F20\u6807\u504F\u79FB"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"-device usb-ehci,id=usb,bus=pci.0,addr=0x4 -device usb-mouse -device usb-tablet -device usb-kbd\n"})}),"\n",(0,l.jsx)(n.h2,{id:"usb-1",children:"usb"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"usb2.0"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u517C\u5BB9\u6027\u66F4\u597D"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"-device usb-ehci,id=usb,bus=pci.0,addr=0x4\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"usb3.0"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"-device nec-usb-xhci,id=usb,bus=pci.0,addr=0x4\n"})}),"\n",(0,l.jsx)(n.h2,{id:"cannot-enable-hvf-when-guest-cpu-has-el3-enabled",children:"Cannot enable HVF when guest CPU has EL3 enabled"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Exception Level 3 (EL3)\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6700\u9AD8\u7684\u7279\u6743\u7EA7\u522B"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"tbd",children:"TBD"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"no scancode found for keysym 1185\nno scancode found for keysym 65306\n"})})]})}function o(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}},17776:function(e,n,i){i.d(n,{R:()=>d,x:()=>t});var s=i(7378);let l={},r=s.createContext(l);function d(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);