"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["36692"],{39714:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>d,toc:()=>a,default:()=>h,metadata:()=>r,assets:()=>c,contentTitle:()=>s});var r=JSON.parse('{"id":"service/workflow/bullmq","title":"BullMQ","description":"- \u53EA\u4F9D\u8D56 Redis","source":"@site/../notes/service/workflow/bullmq.md","sourceDirName":"service/workflow","slug":"/service/workflow/bullmq","permalink":"/notes/service/workflow/bullmq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/workflow/bullmq.md","tags":[{"inline":true,"label":"NodeJS","permalink":"/notes/tags/node-js"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1725936322000,"frontMatter":{"tags":["NodeJS"]},"sidebar":"docs","previous":{"title":"Camunda","permalink":"/notes/service/workflow/bpms/camunda"},"next":{"title":"Cadence","permalink":"/notes/service/workflow/cadence"}}'),l=i(86106),t=i(17776);let d={tags:["NodeJS"]},s="BullMQ",c={},a=[{value:"Notes",id:"notes",level:2},{value:"Lifecycle",id:"lifecycle",level:2},{value:"BullMQ vs Bull",id:"bullmq-vs-bull",level:2}];function o(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"bullmq",children:"BullMQ"})}),"\n",(0,l.jsx)(n.admonition,{type:"tip",children:(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u53EA\u4F9D\u8D56 Redis"}),"\n",(0,l.jsx)(n.li,{children:"\u652F\u6301 delay, debounce, flow(parent,children), repeat, rate limit"}),"\n"]})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/taskforcesh/bullmq",children:"taskforcesh/bullmq"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"MIT, TS, Redis"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/OptimalBits/bull",children:"OptimalBits/bull"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"MIT, JS, Redis"}),"\n",(0,l.jsx)(n.li,{children:"maintenance mode, \u63A8\u8350 BullMQ"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["queueName vs jobName\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Worker \u4F7F\u7528 queue \u6765\u533A\u5206"}),"\n",(0,l.jsxs)(n.li,{children:["job \u5305\u542B jobName - \u4E0D\u80FD\u7528\u6765\u5206\u6D41\u7ED9 Worker\uFF0C\u4F46\u53EF\u4EE5\u8BA9 Worker \u5904\u7406\u591A\u79CD job\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5982\u679C\u5E0C\u671B\u7EC6\u7C92\u5EA6\u5206\u6D41\u53EF\u4EE5\u8003\u8651\u521B\u5EFA\u591A\u4E2A Queue\uFF0C\u4F8B\u5982 ",(0,l.jsx)(n.code,{children:"Email:Send"}),", ",(0,l.jsx)(n.code,{children:"Email:Receive"})]}),"\n",(0,l.jsx)(n.li,{children:"pro \u652F\u6301 group \u6982\u5FF5"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://docs.bullmq.io/patterns/named-processor",children:"https://docs.bullmq.io/patterns/named-processor"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u53BB\u91CD\u673A\u5236\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"debounce - \u4F1A\u751F\u6210 debounced \u4E8B\u4EF6"}),"\n",(0,l.jsx)(n.li,{children:"jobId - \u4F1A\u751F\u6210 duplicated \u4E8B\u4EF6"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Client"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-ts",children:"import { Queue } from 'bullmq';\n\nconst queue = new Queue('Paint');\n\nqueue.add('cars', { color: 'blue' });\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Worker"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-ts",children:"import { Worker } from 'bullmq';\n\nconst worker = new Worker('Paint', async (job) => {\n  if (job.name === 'cars') {\n    await paintCar(job.data.color);\n  }\n});\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Listener"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-ts",children:"import { QueueEvents } from 'bullmq';\n\nconst queueEvents = new QueueEvents('Paint');\n\nqueueEvents.on('completed', ({ jobId }) => {\n  console.log('done painting');\n});\n\nqueueEvents.on('failed', ({ jobId, failedReason }: { jobId: string; failedReason: string }) => {\n  console.error('error painting', failedReason);\n});\n"})}),"\n",(0,l.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-ts",children:"export type FinishedStatus = 'completed' | 'failed';\nexport type JobState = FinishedStatus | 'active' | 'delayed' | 'prioritized' | 'waiting' | 'waiting-children';\nexport type JobType = JobState | 'paused' | 'repeat' | 'wait';\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["QueueEvents\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"XREAD BLOCK 10000 STREAMS $key $lastEventId"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5904\u7406\u4E2D\u53EF\u4EE5 job.moveToDelayed \u7136\u540E throw DelayedError\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8BA9 job \u8FDB\u5165\u7B49\u5F85\u72B6\u6001"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5904\u7406\u4E2D\u53EF\u4EE5 job.moveToWaitingChildren \u7136\u540E throw WaitingChildrenError\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8BA9 job \u8FDB\u5165\u7B49\u5F85 children \u7684\u72B6\u6001"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"throw UnrecoverableError \u53EF\u4EE5\u907F\u514D retry"}),"\n",(0,l.jsx)(n.li,{children:"throw throw Worker.RateLimitError \u53EF\u4EE5\u5B9E\u73B0\u624B\u52A8 rate-limit"}),"\n",(0,l.jsxs)(n.li,{children:["repeatable jobs -> delayed jobs\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["jobId \u7528\u4E8E\u751F\u6210 deplayed job\uFF0C\u800C\u4E0D\u7528\u4E8E\u672C\u8EAB job \u53BB\u91CD\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"repeat:KEY:1724148000000"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["key\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u9ED8\u8BA4\u901A\u8FC7 options \u751F\u6210\uFF0C\u81EA\u5B9A\u4E49 key \u521B\u5EFA\u76F8\u540C\u914D\u7F6E\u7684 repeatable job"}),"\n",(0,l.jsx)(n.li,{children:"\u76F8\u540C key \u521B\u5EFA\u53EF\u4EE5\u8986\u76D6\u4E4B\u524D\u7684 options"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"job.toJSON"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "name": "pull",\n  "opts": {\n    "attempts": 0,\n    "delay": 30121,\n    "repeat": {\n      "every": 90000,\n      "key": "WecomArchivePull",\n      "count": 1\n    },\n    "jobId": "repeat:WecomArchivePull:1724148000000",\n    "timestamp": 1724147969879,\n    "prevMillis": 1724148000000\n  },\n  "id": "repeat:WecomArchivePull:1724148000000",\n  "progress": 0,\n  "returnvalue": null,\n  "stacktrace": null,\n  "attemptsStarted": 0,\n  "attemptsMade": 0,\n  "delay": 30121,\n  "repeatJobKey": "WecomArchivePull",\n  "timestamp": 1724147969879,\n  "queueQualifiedName": "bull:WecomArchive"\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["priority 0 - 2^21\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"0 \u6700\u9AD8"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Worker Pickup - prioritized > wait\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"pickup \u540E\u53D8\u4E3A active"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.mermaid,{value:"---\ntitle: Lifecycle of a Job - Queue\n---\n\nstateDiagram-v2\n\nstate fork_state <<fork>>\n    [*] --\x3e fork_state: added\n    fork_state --\x3e wait\n    fork_state --\x3e delayed: delay > 0\n    fork_state --\x3e prioritized: priority > 0\n\n    wait --\x3e wait: rate limit\n    wait --\x3e active\n\n\n    active --\x3e wait: dyanmic rate limit <br/> error retry\n    active --\x3e delayed: error & backoff\n    active --\x3e prioritized: rate limit & priority > 0\n    active --\x3e failed: \u5931\u8D25\n    active --\x3e completed: \u6210\u529F\n\n    prioritized --\x3e active\n    delayed --\x3e prioritized: priority > 0\n    delayed --\x3e wait\n\nstate join_state <<join>>\n    failed --\x3e join_state\n    completed --\x3e join_state\n    join_state --\x3e [*]"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-mermaid---",children:"title: Lifecycle of a Job - Flow Producer\n---\n\nstateDiagram-v2\n\nstate added <<fork>>\n    [*] --\x3e added: added\n\n    state no_children <<fork>>\n        added --\x3e no_children: \u65E0 children\n        no_children --\x3e delayed: delay > 0\n        no_children --\x3e prioritized: priority > 0\n\n    waiting_children: waiting-children\n    added --\x3e waiting_children: \u6709 chdilren\n\n\n    waiting_children --\x3e wait: children completed\n    waiting_children --\x3e delayed: delay > 0\n    waiting_children --\x3e prioritized: priority > 0\n    waiting_children --\x3e failed: child fail & failParentOnFailure\n\n    wait --\x3e wait: rate limit\n    wait --\x3e active\n\n    active --\x3e wait: dyanmic rate limit <br/> error retry\n    active --\x3e delayed: error & backoff\n    active --\x3e prioritized: rate limit & priority > 0\n    active --\x3e failed: \u5931\u8D25\n    active --\x3e completed: \u6210\u529F\n\n    prioritized --\x3e active\n    delayed --\x3e prioritized: priority > 0\n    delayed --\x3e wait\n\nstate finished <<join>>\n    failed --\x3e finished\n    completed --\x3e finished\n    finished --\x3e [*]: finished\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://docs.bullmq.io/guide/architecture",children:"https://docs.bullmq.io/guide/architecture"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(n.h2,{id:"bullmq-vs-bull",children:"BullMQ vs Bull"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"vs"}),(0,l.jsx)(n.th,{children:"bullmq"}),(0,l.jsx)(n.th,{children:"bull"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Year"}),(0,l.jsx)(n.td,{children:"2019"}),(0,l.jsx)(n.td,{children:"2013"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"job event"}),(0,l.jsx)(n.td,{children:"stream"}),(0,l.jsx)(n.td,{children:"pubsub"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Workers and Event listeners"}),(0,l.jsx)(n.td,{children:"separate"}),(0,l.jsx)(n.td,{children:"same"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Scheduler Process"}),(0,l.jsx)(n.td,{children:"\u5355\u72EC Scheduler"}),(0,l.jsx)(n.td,{children:"same"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Job Dependencies"}),(0,l.jsx)(n.td,{children:"\u6709"}),(0,l.jsx)(n.td,{children:"\u65E0"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Priority Queueing"}),(0,l.jsx)(n.td,{children:"\u6709,\u652F\u6301 rate-limited, scheduling"}),(0,l.jsx)(n.td,{children:"\u6709"})]})]})]})]})}function h(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},17776:function(e,n,i){i.d(n,{R:()=>d,x:()=>s});var r=i(7378);let l={},t=r.createContext(l);function d(e){let n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);