"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["264550"],{951223:function(n,e,r){r.r(e),r.d(e,{frontMatter:()=>t,toc:()=>d,default:()=>h,metadata:()=>i,assets:()=>c,contentTitle:()=>o});var i=JSON.parse('{"id":"dev/pattern/durable-function","title":"Durable Function","description":"- \u7528\u4E8E\u5B9E\u73B0\u6D41\u7A0B\u7F16\u6392","source":"@site/../notes/dev/pattern/durable-function.md","sourceDirName":"dev/pattern","slug":"/dev/pattern/durable-function","permalink":"/notes/dev/pattern/durable-function","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/pattern/durable-function.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1757899636000,"frontMatter":{"title":"Durable Function"},"sidebar":"docs","previous":{"title":"Control plane","permalink":"/notes/dev/pattern/control-plane"},"next":{"title":"IoC","permalink":"/notes/dev/pattern/ioc"}}'),l=r(486106),s=r(917776);let t={title:"Durable Function"},o="Durable Function",c={},d=[{value:"Cadence",id:"cadence",level:2},{value:"Temporal",id:"temporal",level:2},{value:"Azure Durable Functions",id:"azure-durable-functions",level:2}];function a(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"durable-function",children:"Durable Function"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7528\u4E8E\u5B9E\u73B0\u6D41\u7A0B\u7F16\u6392"}),"\n",(0,l.jsx)(e.li,{children:"\u7F16\u6392\u51FD\u6570\u903B\u8F91\u7684\u72B6\u6001\u53EF\u6062\u590D\u91CD\u73B0"}),"\n",(0,l.jsx)(e.li,{children:"BMPS \u4F7F\u7528 XML \u63CF\u8FF0 workflow -> Durable Functions \u4F7F\u7528\u4EE3\u7801\u76F4\u63A5\u5B9A\u4E49 workflow"}),"\n",(0,l.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://metatype.dev/blog/2024/08/27/distributed-execution-flow-paradigms",children:"Distributed execution flow paradigms"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Event-Driven Architecture with Message Queues"}),"\n",(0,l.jsx)(e.li,{children:"Saga"}),"\n",(0,l.jsx)(e.li,{children:"Stateful Orchestrators"}),"\n",(0,l.jsx)(e.li,{children:"Durable Execution"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview",children:"https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/dotnet/orleans",children:"https://github.com/dotnet/orleans"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ts",children:"// \u8BA2\u5355\u6D41\u7A0B / \u7F16\u6392\n// \u672C\u8EAB\u662F\u786E\u5B9A\u6027\u7684\n// \u5B9E\u9645\u8FD9\u4E2A\u6D41\u7A0B\u53EF\u80FD\u8FD0\u884C \u51E0\u5929\nexport async function orderProcessingWorkflow(order: OrderDetails): Promise<string> {\n  let transactionId: string | null = null;\n\n  try {\n    // \u68C0\u67E5\u5E76\u9884\u7559\u5E93\u5B58\n    await workflow.callActivity(reserveInventory, order.items);\n\n    // \u652F\u4ED8\u5904\u7406\n    // \u5E42\u7B49\u64CD\u4F5C\uFF0C\u81EA\u52A8\u91CD\u8BD5\n    const paymentResponse = await workflow.callActivityWithRetry(\n      processPayment,\n      {\n        initialInterval: '10s',\n        maximumAttempts: 5,\n      },\n      order.orderId,\n      order.amount,\n    );\n\n    transactionId = paymentResponse.transactionId;\n\n    // timer\uFF0C\u4EBA\u5DE5\u4EA4\u4E92\n    if (paymentResponse.status === 'REQUIRES_REVIEW') {\n      // side effect\n      await workflow.callActivity(notifyFraudTeam, order.orderId);\n\n      const approvalEvent = workflow.waitForExternalEvent<boolean>('fraudReviewApproved');\n      const timeout = workflow.createTimer('2h');\n\n      // \u7B49\u5F85\u5176\u4E2D\u4E00\u4E2A\u5B8C\u6210\n      const winner = await Promise.race([approvalEvent, timeout]);\n\n      if (winner === timeout) {\n        // \u5982\u679C\u8D85\u65F6\uFF0C\u5219\u8BA4\u4E3A\u5BA1\u6838\u5931\u8D25\uFF0C\u629B\u51FA\u5F02\u5E38\u4EE5\u89E6\u53D1\u8865\u507F\u903B\u8F91\u3002\n        throw new Error('\u6B3A\u8BC8\u5BA1\u6838\u8D85\u65F6');\n      }\n\n      const isApproved = await approvalEvent;\n      if (!isApproved) {\n        // \u5982\u679C\u5BA1\u6838\u88AB\u62D2\u7EDD\uFF0C\u4E5F\u629B\u51FA\u5F02\u5E38\u3002\n        throw new Error('\u6B3A\u8BC8\u5BA1\u6838\u88AB\u62D2\u7EDD');\n      }\n    }\n\n    // side effect\n    // \u4ECE\u5E93\u5B58\u4E2D\u6263\u9664\u5546\u54C1\u3001\u53D1\u9001\u8BA2\u5355\u786E\u8BA4\u90AE\u4EF6\n    await workflow.callActivity(deductInventory, order.items);\n    await workflow.callActivity(sendOrderConfirmationEmail, order.customerId, order.orderId);\n\n    // timer\n    // \u7B49\u5230 24 \u5C0F\u65F6\u540E\u53D1\u9001\u8DDF\u8FDB\u90AE\u4EF6\n    await workflow.sleep('24h');\n    await workflow.callActivity(sendFollowUpEmail, order.customerId, order.orderId);\n\n    return `\u8BA2\u5355 ${order.orderId} \u5904\u7406\u6210\u529F\u3002`;\n  } catch (error) {\n    // \u8865\u507F\n    if (transactionId) {\n      await workflow.callActivity(refundPayment, transactionId);\n    }\n    console.error(`\u8BA2\u5355 ${order.orderId} \u5904\u7406\u5931\u8D25:`, error);\n    return `\u8BA2\u5355 ${order.orderId} \u5904\u7406\u5931\u8D25\u3002`;\n  }\n}\n"})}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u539F\u7406"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4E8B\u4EF6\u6EAF\u6E90 (Event Sourcing)\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4EE5 AOL/Append Only Log \u7684\u65B9\u5F0F\u8BB0\u5F55\u6240\u6709\u64CD\u4F5C"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u68C0\u67E5\u70B9 (Checkpointing)\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7B49\u5F85\u8FDB\u5165\u68C0\u67E5\u70B9\uFF0C\u8BB0\u5F55\u5F53\u524D\u72B6\u6001"}),"\n",(0,l.jsx)(e.li,{children:"\u72B6\u6001\u8BB0\u5F55\u540E\uFF0C\u5B9E\u9645\u7684\u903B\u8F91\u53EF\u4EE5 offload"}),"\n",(0,l.jsxs)(e.li,{children:["\u4F8B\u5982 ",(0,l.jsx)(e.code,{children:"await sleep('5m')"})," \u672C\u8D28\u662F throw \u4E00\u4E2A Error, \u5916\u90E8\u68C0\u6D4B\u7136\u540E checkpoint"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u91CD\u653E (Replay)\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u901A\u8FC7\u4E8B\u4EF6\u65E5\u5FD7\u91CD\u653E\u72B6\u6001"}),"\n",(0,l.jsx)(e.li,{children:"\u6062\u590D \u903B\u8F91\u72B6\u6001\uFF0C\u786E\u4FDD\u4E0E\u539F\u59CB\u6267\u884C\u8DEF\u5F84\u4E00\u81F4"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u786E\u5B9A\u6027\u7684 (deterministic)\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Workflow \u4E3B\u4F53\u662F\u65E0 side effect \u7684"}),"\n",(0,l.jsx)(e.li,{children:"side effect \u62BD\u79BB\u5230 activity"}),"\n",(0,l.jsx)(e.li,{children:"\u4FDD\u969C replay \u80FD\u8FDB\u5165\u540C\u6837\u7684\u72B6\u6001"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u573A\u666F"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4EFB\u52A1\u961F\u5217 (Task Queues)"}),"\n",(0,l.jsx)(e.li,{children:"Saga \u6A21\u5F0F"}),"\n",(0,l.jsx)(e.li,{children:"Cron \u4F5C\u4E1A\u4E0E\u8C03\u5EA6\u5668"}),"\n",(0,l.jsx)(e.li,{children:"\u4E8B\u4EF6\u9A71\u52A8\u67B6\u6784 (Event-Driven Architecture, EDA)"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u5E94\u7528\u6A21\u5F0F"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u51FD\u6570\u94FE\u63A5 (Function Chaining) - \u7528\u4E8E\u987A\u5E8F\u6D41\u7A0B"}),"\n",(0,l.jsx)(e.li,{children:"\u6247\u51FA/\u6247\u5165 (Fan-out/Fan-in) - \u7528\u4E8E\u5E76\u884C\u5904\u7406"}),"\n",(0,l.jsx)(e.li,{children:"\u5F02\u6B65 HTTP API - \u7528\u4E8E\u957F\u65F6\u64CD\u4F5C"}),"\n",(0,l.jsx)(e.li,{children:"\u76D1\u63A7 (Monitoring) - \u7528\u4E8E\u72B6\u6001\u9A71\u52A8\u7684\u8F6E\u8BE2"}),"\n",(0,l.jsx)(e.li,{children:"\u4EBA\u5DE5\u4EA4\u4E92 (Human Interaction) - \u7528\u4E8E\u5BA1\u6279\u5DE5\u4F5C\u6D41"}),"\n",(0,l.jsx)(e.li,{children:"\u805A\u5408\u5668 (Aggregator) - \u7528\u4E8E\u72B6\u6001\u5316\u6570\u636E\u6536\u96C6"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"Awesome"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u5546\u4E1A\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Azure Durable Functions"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://cloud.google.com/composer",children:"Google Cloud Composer"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://aws.amazon.com/step-functions/",children:"AWS Step Functions"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Amazon States Language (ASL)\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html",children:"https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"serverless orchestration service for coordinating distributed applications and microservices into visual workflows"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"Temporal Cloud"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"/notes/service/workflow/temporal/",children:"temporal"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"cadence fork"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"/notes/service/workflow/cadence",children:"cadence"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"by Uber"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"/notes/service/workflow/dbos",children:"dbos"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u72B6\u6001\u8BB0\u5F55\u5728 PostgreSQL, \u4E0D\u9700\u8981\u5F15\u5165\u5916\u90E8\u670D\u52A1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/Azure/durabletask",children:"Azure/durabletask"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Apache-2.0, C#"}),"\n",(0,l.jsx)(e.li,{children:"Durable Task Framework allows users to write long running persistent workflows in C# using the async/await capabilities."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/Azure-Samples/Durable-Task-Scheduler",children:"Azure-Samples/Durable-Task-Scheduler"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"cadence",children:"Cadence"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Workflow\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u786E\u5B9A\u6027"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"Activity"}),"\n",(0,l.jsx)(e.li,{children:"Task List"}),"\n",(0,l.jsxs)(e.li,{children:["Signal\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5F02\u6B65\u6D88\u606F"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["Synchronous Query\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u76F4\u63A5\u63A5\u6536\u540C\u6B65\u67E5\u8BE2"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["Archival\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5B8C\u6210\u7684 workflow \u5F52\u6863\u5230 s3\uFF0C\u51CF\u5C11\u4E3B\u6570\u636E\u5E93\u538B\u529B"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"temporal",children:"Temporal"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"fork by Cadence \u7684\u4E24\u4F4D\u6838\u5FC3\u521B\u59CB\u4EBA Maxim Fateev \u3001 Samar Abbas"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"azure-durable-functions",children:"Azure Durable Functions"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Orchestrator Functions / Workflow"}),"\n",(0,l.jsx)(e.li,{children:"Activity Functions / Side effect"}),"\n",(0,l.jsxs)(e.li,{children:["Entity Functions\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Durable Functions 2.0 \u5F15\u5165"}),"\n",(0,l.jsx)(e.li,{children:"\u5BF9 Actor \u8FDB\u884C\u5EFA\u6A21"}),"\n"]}),"\n"]}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(a,{...n})}):a(n)}},917776:function(n,e,r){r.d(e,{R:()=>t,x:()=>o});var i=r(7378);let l={},s=i.createContext(l);function t(n){let e=i.useContext(s);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),i.createElement(s.Provider,{value:e},n.children)}}}]);