"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["876243"],{782531:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>i,toc:()=>o,default:()=>h,metadata:()=>l,assets:()=>d,contentTitle:()=>c});var l=JSON.parse('{"id":"os/alpine/alpine-lbu","title":"Alpine local backup","description":"- lbu - Alpine local backup","source":"@site/../notes/os/alpine/alpine-lbu.md","sourceDirName":"os/alpine","slug":"/os/alpine/lbu","permalink":"/notes/os/alpine/lbu","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/alpine/alpine-lbu.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1719892411000,"frontMatter":{"title":"Alpine local backup"},"sidebar":"docs","previous":{"title":"Alpine \u5165\u95E8","permalink":"/notes/os/alpine/intro"},"next":{"title":"Alpine QEMU Manual","permalink":"/notes/os/alpine/manual"}}'),t=s(486106),r=s(917776);let i={title:"Alpine local backup"},c="Alpine local backup",d={},o=[{value:"lbu.conf",id:"lbuconf",level:2},{value:"rootfs.apkvol",id:"rootfsapkvol",level:2},{value:"restore from apkvol",id:"restore-from-apkvol",level:2},{value:"exclude boot",id:"exclude-boot",level:2}];function a(n){let e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"alpine-local-backup",children:"Alpine local backup"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["lbu - ",(0,t.jsx)(e.a,{href:"https://wiki.alpinelinux.org/wiki/Alpine_local_backup",children:"Alpine local backup"})]}),"\n",(0,t.jsx)(e.li,{children:"apkvol.tar.gz"}),"\n"]}),"\n",(0,t.jsx)(e.admonition,{type:"tip",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"diskless \u5B89\u88C5\u5FC5\u5907 - commit \u4FEE\u6539\u5230\u5916\u90E8 media"}),"\n",(0,t.jsxs)(e.li,{children:["\u9ED8\u8BA4\u53EA\u5173\u5FC3 /etc \u4E0B\u5185\u5BB9\uFF0C\u4E0D\u5305\u542B ",(0,t.jsx)(e.code,{children:"/etc/init.d"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u76F8\u5F53\u4E8E\u628A\u6240\u6709 /etc \u4E0B\u7684\u5185\u5BB9\u8FDB\u884C\u5907\u4EFD\u6216\u6062\u590D"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"apk fix"})," \u4F1A\u5B89\u88C5\u6240\u9700\u5305"]}),"\n"]})}),"\n",(0,t.jsx)(e.admonition,{type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u8981\u6062\u590D\u5230\u4E0D\u540C boot \u7684\u7CFB\u7EDF\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4F8B\u5982\u4E0D\u8981\u5C06 extlinux \u7684\u914D\u7F6E\u6062\u590D\u5230 grub \u7CFB\u7EDF"}),"\n",(0,t.jsx)(e.li,{children:"\u5982\u679C\u9700\u8981\uFF0C\u6CE8\u610F\u5907\u4EFD\u6216\u6062\u590D\u7684\u65F6\u5019\u6392\u9664\u76F8\u5173\u6587\u4EF6"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u6CE8\u610F\u6DFB\u52A0\u81EA\u5B9A\u4E49\u7684 initd \u811A\u672C - symlink \u9ED8\u8BA4\u4F1A\u590D\u5236"}),"\n",(0,t.jsxs)(e.li,{children:["\u7CFB\u7EDF\u6062\u590D\u6CE8\u610F \u4FEE\u6539 rootfs UUID \u540E\u518D\u91CD\u542F\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"/etc/update-extlinux.conf"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4FEE\u6539\u6216\u5220\u9664 root"}),"\n",(0,t.jsxs)(e.li,{children:["\u9ED8\u8BA4 ",(0,t.jsx)(e.code,{children:"blkid -o export /dev/root"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"/etc/fstab"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4FEE\u6539 UUID"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u91CD\u65B0 mkinitfs \u6216 \u4FEE\u6539 ",(0,t.jsx)(e.code,{children:"/boot/extlinux.conf"})]}),"\n",(0,t.jsxs)(e.li,{children:["\u9519\u8BEF\u53EF\u80FD\u5BFC\u81F4 rootfs \u53EA\u8BFB\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"sudo mount -o remount,rw /dev/vda2 /"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"abbr."}),(0,t.jsx)(e.th,{children:"command"}),(0,t.jsx)(e.th,{children:"desc"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"ci"}),(0,t.jsx)(e.td,{children:"commit"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pkg"}),(0,t.jsx)(e.td,{children:"package"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"st"}),(0,t.jsx)(e.td,{children:"status"}),(0,t.jsx)(e.td,{children:"\u5BF9\u6BD4\u4E0A\u6B21 commit"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"ls"}),(0,t.jsx)(e.td,{children:"list"}),(0,t.jsxs)(e.td,{children:["\u53D8\u5316\u5217\u8868 - \u7C7B\u4F3C ",(0,t.jsx)(e.code,{children:"lbu status -a"}),", \u4E0E ",(0,t.jsx)(e.code,{children:"lbu package -v /dev/null"})," \u8F93\u51FA\u76F8\u540C"]})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{children:"diff"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"inc,add"}),(0,t.jsx)(e.td,{children:"include"}),(0,t.jsxs)(e.td,{children:["\u4FEE\u6539 ",(0,t.jsx)(e.code,{children:"/etc/apk/protected_paths.d/lbu.list"})]})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"ex,delete"}),(0,t.jsx)(e.td,{children:"exclude"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"lb"}),(0,t.jsx)(e.td,{children:"list-backup"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{children:"revert"}),(0,t.jsxs)(e.td,{children:[(0,t.jsx)(e.strong,{children:"\u4E0D\u4F1A\u4FEE\u6539\u7CFB\u7EDF"})," - \u4FEE\u6539\u5F53\u524D\u6D3B\u8DC3\u7684 apkvol\uFF0C\u4E0B\u6B21\u542F\u52A8\u65F6\u52A0\u8F7D"]})]})]})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'# \u9ED8\u8BA4\u63A8\u8350\u914D\u7F6E\nsudo mkdir /root/config-backups/\nsudo lbu pkg /root/config-backups/\n\nlbu st -a # \u5F53\u524D\u7CFB\u7EDF\u4FEE\u6539\n\nmkdir backups      # \u51C6\u5907\u5907\u4EFD\u76EE\u5F55\nlbu pkg -v backups # \u5907\u4EFD\nls backups         # \u751F\u6210 <hostname>.apkovl.tar.gz\n\n# \u5907\u4EFD\u5230\u672C\u5730\nmkdir /root/lbu-backups\nsed -ri "s@^(#\\s*)?LBU_BACKUPDIR=.*@LBU_BACKUPDIR=/root/lbu-backups@" /etc/lbu/lbu.conf\nlbu ci               # commit\nls /root/lbu-backups # <hostname>.apkovl.tar.gz\nlbu st               # \u5DF2\u7ECF\u6CA1\u6709\u53D8\u5316\n\nlbu ci\nls /root/lbu-backups # \u65E7\u7684\u53D8\u6210 <hostname>.<YYYYMMDDHHmmSS>.apkovl.tar.gz\nlbu lb               # \u4F1A\u663E\u793A <hostname>.<YYYYMMDDHHmmSS>.apkovl.tar.gz\n\n# \u5224\u65AD\u662F\u5426\u6709\u4FEE\u6539\n[ $(lbu st | wc -c) = 0 ] && echo No change || lbu ci -v\n\n# \u8FDC\u7A0B\u5907\u4EFD\nssh root@server "lbu package -" > server.apkovl.tar.gz\nssh admin@server "sudo lbu package -" > server.apkovl.tar.gz\n# \u6062\u590D\ncat server.aplovl.tar.gz | ssh admin@server \'sudo tar -C / --numeric-owner -zxvf - > /tmp/ovlfiles\'\n\n# diff\ntar df os.apkvol.tar.gz -C / # \u6C47\u62A5\u4FEE\u6539\n'})}),"\n",(0,t.jsx)(e.h2,{id:"lbuconf",children:"lbu.conf"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"/etc/lbu/lbu.conf"}),"\n",(0,t.jsx)(e.li,{children:"/etc/lbu/pre-package.d"}),"\n",(0,t.jsx)(e.li,{children:"/etc/lbu/post-package.d"}),"\n",(0,t.jsxs)(e.li,{children:["/etc/apk/protected_paths.d/lbu.list\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"+var/lib/tailscale"})," - inlcude - \u589E\u52A0\u5907\u4EFD\u6587\u4EF6"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"-etc/ssh/sshd_host*"})," - exclude - \u6392\u9664\u5907\u4EFD\u6587\u4EF6"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-conf",metastring:'title="lbu.conf"',children:"# -e\nDEFAULT_CIPHER=aes-256-cbc\n\n# \u5F00\u542F\u52A0\u5BC6\n# ENCRYPTION=$DEFAULT_CIPHER\n\n# \u5B58\u50A8\u7684\u5916\u90E8\u5A92\u4F53\u8BBE\u5907\n# \u4E5F\u53EF\u4EE5\u8BBE\u7F6E\u4E3A floppy\n# LBU_MEDIA=usb\n\n# \u5B58\u50A8\u5230\u672C\u5730\u76EE\u5F55\u800C\u4E0D\u662F\u5916\u90E8 \u5A92\u4F53\n# LBU_BACKUPDIR=/root/config-backups\n\n# \u6700\u591A\u5B58\u50A8\u591A\u5C11\u5907\u4EFD\n# BACKUP_LIMIT=3\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"\u63A8\u8350"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-pre",metastring:"/etc/apk/protected_paths.d/lbu.list",children:"home/admin/.ssh\nroot/.ssh\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"MISC"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-pre",metastring:"/etc/apk/protected_paths.d/lbu.list",children:"+var/lib/tailscale/\n-etc/ssh/ssh_host*\n# /etc/init.d/tincd.netname\n"})}),"\n",(0,t.jsx)(e.h2,{id:"rootfsapkvol",children:"rootfs.apkvol"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"curl -LO https://mirrors.aliyun.com/alpine/v3.12/releases/x86_64/alpine-minirootfs-3.12.0-x86_64.tar.gz\nmkdir -p rootfs\ntar zxf alpine-minirootfs-3.12.0-x86_64.tar.gz -C rootfs\n\ncp /etc/apk/repositories rootfs/etc/apk/\n# \u53EF\u9009 - chroot \u540E\u53EF apk add\n# echo nameserver 114.114.114.114 > rootfs/etc/resolv.conf\napk --root rootfs add alpine-conf\n\n# \u83B7\u53D6\u5230 rootfs.apkvol\nchroot rootfs/ lbu pkg rootfs.apkvol.tar.gz\nmv rootfs/rootfs.apkvol.tar.gz .\n"})}),"\n",(0,t.jsx)(e.h2,{id:"restore-from-apkvol",children:"restore from apkvol"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"tar -C / --numeric-owner -zxvf os.apkvol.tar.gz > /tmp/ovlfiles\n\napk fix                   # /etc/apk/world\nhostname -F /etc/hostname # /etc/hostname\nservice modules restart   # /etc/modules-load.d\nservice sysctl restart    # /etc/sysctl.d\nservice sshd reload       # /etc/ssh/sshd_config\n\ngrep etc/tinc/ /tmp/ovlfiles > /dev/null && service tincd restart\ngrep etc/sockd.conf /tmp/ovlfiles > /dev/null && service sockd restart\n\n# service xyz start       # start needed services\n"})}),"\n",(0,t.jsx)(e.h2,{id:"exclude-boot",children:"exclude boot"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"-etc/default/grub\n-etc/fstab\n-etc/mkinitfs/mkinitfs.conf\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u540C\u7684 boot \u9700\u8981\u4E0D\u540C\u7684\u5305\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"grub-efi"}),"\n",(0,t.jsx)(e.li,{children:"extlinux"}),"\n"]}),"\n"]}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(a,{...n})}):a(n)}},917776:function(n,e,s){s.d(e,{R:()=>i,x:()=>c});var l=s(7378);let t={},r=l.createContext(t);function i(n){let e=l.useContext(r);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:i(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);