"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["40901"],{97347:function(n,e,s){s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>a,frontMatter:()=>d,metadata:()=>l,toc:()=>o});var l=s(35234),r=s(86106),i=s(17776);let d={slug:"sni-proxy",title:"\u57FA\u4E8E SNI \u5B9E\u73B0\u65E0\u611F\u5168\u5C40\u4EE3\u7406",tags:["\u4EE3\u7406","\u8FD0\u7EF4"]},t="\u57FA\u4E8E SNI \u5B9E\u73B0\u65E0\u611F\u5168\u5C40\u4EE3\u7406",c={authorsImageUrls:[]},o=[{value:"\u624B\u52A8\u914D\u7F6E\u8282\u70B9",id:"\u624B\u52A8\u914D\u7F6E\u8282\u70B9",level:2},{value:"Docker \u542F\u52A8\u670D\u52A1",id:"docker-\u542F\u52A8\u670D\u52A1",level:2},{value:"\u65E0\u6CD5\u4FEE\u6539\u8DEF\u7531\u5668",id:"\u65E0\u6CD5\u4FEE\u6539\u8DEF\u7531\u5668",level:2},{value:"\u4E3A\u4EC0\u4E48\u7528 172.32.1.1",id:"\u4E3A\u4EC0\u4E48\u7528-1723211",level:2},{value:"\u4E3A\u4EC0\u4E48\u9009\u62E9 DNS+SNI \u4F5C\u4E3A\u5168\u5C40\u4EE3\u7406",id:"\u4E3A\u4EC0\u4E48\u9009\u62E9-dnssni-\u4F5C\u4E3A\u5168\u5C40\u4EE3\u7406",level:2},{value:"\u80FD\u4E0D\u80FD\u4E0D\u9650\u5236\u57DF\u540D\u6240\u6709\u90FD\u4EE3\u7406",id:"\u80FD\u4E0D\u80FD\u4E0D\u9650\u5236\u57DF\u540D\u6240\u6709\u90FD\u4EE3\u7406",level:2},{value:"\u5173\u4E8E\u4E0A\u6E38 DNS",id:"\u5173\u4E8E\u4E0A\u6E38-dns",level:2},{value:"\u5176\u4ED6\u65E0\u611F\u5168\u5C40\u4EE3\u7406\u7684\u65B9\u5F0F",id:"\u5176\u4ED6\u65E0\u611F\u5168\u5C40\u4EE3\u7406\u7684\u65B9\u5F0F",level:2}];function h(n){let e={code:"code",h1:"h1",h2:"h2",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u57FA\u672C\u7ED3\u6784"})}),"\n",(0,r.jsx)(e.mermaid,{value:"flowchart TD\n    Router[\u8DEF\u7531] --\x3e |DNS| Lan[\u4EE3\u7406\u8282\u70B9<br/>dnsmasq]\n    Lan --\x3e |172.32.1.1| SNI[SNI \u4EE3\u7406<br/>gost] --\x3e |\u4E0A\u6E38\u4EE3\u7406| Proxy[clash/socket/http]"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u8DEF\u7531\u5668\u4E0A\u914D\u7F6E DNS \u4E3A\u5C40\u57DF\u7F51\u5185\u7684\u4E00\u4E2A\u8282\u70B9"}),"\n",(0,r.jsx)(e.li,{children:"\u8DEF\u7531\u5668\u4E0A\u914D\u7F6E \u8DEF\u7531 172.32.1.1 \u5230\u5185\u7F51\u7684\u4E00\u4E2A IP"}),"\n",(0,r.jsx)(e.li,{children:"DNS \u5339\u914D\u9700\u8981\u4EE3\u7406\u7684\u8DEF\u7531\u8FD4\u56DE 172.32.1.1"}),"\n",(0,r.jsx)(e.li,{children:"172.32.1.1 \u4E0A\u90E8\u7F72 sni \u4EE3\u7406\uFF0C\u76D1\u542C 80\u3001443"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u524D\u7F6E\u6761\u4EF6"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5DF2\u6709\u76F8\u5173\u4EE3\u7406\u670D\u52A1"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u540E\u7F6E\u6761\u4EF6"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4FEE\u6539\u8DEF\u7531\u5668\u914D\u7F6E"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u5E94\u7528\u573A\u666F"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5BB6\u5EAD\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u65E0\u611F"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u670D\u52A1\u5668\u8FD0\u7EF4 - \u4E91\u670D\u52A1\u5668\u3001\u7269\u7406\u670D\u52A1\u5668\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u65E0\u611F"}),"\n",(0,r.jsx)(e.li,{children:"\u80FD\u652F\u6301\u4EFB\u610F\u573A\u666F"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u516C\u53F8\u5C40\u57DF\u7F51\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u80FD\u9650\u5236\u8303\u56F4"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u624B\u52A8\u914D\u7F6E\u8282\u70B9",children:"\u624B\u52A8\u914D\u7F6E\u8282\u70B9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"ip addr add 172.32.1.1/32 dev eth0 # \u589E\u52A0 IP\n\n# \u5B89\u88C5\u90E8\u7F72 gost - \u63D0\u4F9B SNI \u4EE3\u7406\n# ===============\ncurl -LO https://github.com/go-gost/gost/releases/download/v3.0.0-rc8/gost_3.0.0-rc8_linux_amd64.tar.gz\ntar zxvf gost*.tar.gz\n# \u76D1\u542C 80, 443 - \u4E0A\u6E38\u4EE3\u7406\u4E3A 192.168.1.2:7890\uFF0C\u5982\u679C\u5728\u5F53\u524D\u8282\u70B9\u4E5F\u53EF\u4EE5 127.0.0.1:7890\n./gost -L sni://:80 -L sni://:443 -F socks5://192.168.1.2:7890\n# \u6D4B\u8BD5 gost \u4EE3\u7406\u662F\u5426\u6210\u529F\ncurl -H 'Host: google.com' 127.0.0.1\n\n# \u5B89\u88C5\u90E8\u7F72 dnsmasq\n# ===============\napk add dnsmasq\n# \u4E0A\u6E38\u914D\u7F6E\ncat << EOF > /etc/dnsmasq.d/main.conf\nserver=223.5.5.5\nlog-queries=extra\nEOF\n\n# \u914D\u7F6E\u4EE3\u7406\u5E38\u7528\u7684\u57DF\u540D\ncurl -L https://ghproxy.com/raw.githubusercontent.com/wenerme/wener/master/notes/service/dns/gfwlist.txt \\\n  | sed -E 's#.+#address=/&/172.32.1.1#' > /etc/dnsmasq.d/gfwlist.conf\n\n# \u6D4B\u8BD5\u542F\u52A8\ndnsmasq -d\n# \u6D4B\u8BD5\uFF0C\u8FD4\u56DE 172.32.1.1 \u4E3A\u6B63\u5E38\u7ED3\u679C\nnslookup google.com 127.0.0.1\n\n# service dnsmasq start # \u670D\u52A1\u542F\u52A8\n# rc-update add dnsmasq # \u5F00\u673A\u81EA\u52A8\u542F\u52A8\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u914D\u7F6E\u8DEF\u7531\u5668\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"DNS"}),"\n",(0,r.jsx)(e.li,{children:"\u8DEF\u7531 172.32.1.1 \u5230\u5185\u7F51\u8282\u70B9"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"docker-\u542F\u52A8\u670D\u52A1",children:"Docker \u542F\u52A8\u670D\u52A1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# --network=host or -p 80:80 -p 443:443 -p 53:53/udp\n# -e FAKEIP=172.32.1.1\ndocker run --rm -it -e PROXY=socks5://192.168.66.1:7890 -p 80:80 -p 443:443 -p 53:53/udp --name proxy wener/sni-rev-proxy\n\nnslookup google.com 127.0.0.1\ncurl --resolve google.com:80:127.0.0.1 google.com\n\n# \u6DFB\u52A0 FAKEIP\nip addr add 172.32.1.1/32 dev eth0\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u914D\u7F6E\u8DEF\u7531\u5668\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"DNS"}),"\n",(0,r.jsx)(e.li,{children:"\u8DEF\u7531 172.32.1.1 \u5230\u5185\u7F51\u8282\u70B9"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(e.h2,{id:"\u65E0\u6CD5\u4FEE\u6539\u8DEF\u7531\u5668",children:"\u65E0\u6CD5\u4FEE\u6539\u8DEF\u7531\u5668"}),"\n",(0,r.jsx)(e.p,{children:"\u672C\u5730\u4F7F\u7528\u76F4\u63A5\u4FEE\u6539 resolv.conf \u6216\u8005 hosts"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-txt",metastring:'title="/etc/resolv.conf"',children:"nameserver 127.0.0.1\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4F7F\u7528\u90E8\u7F72 DNS \u7684\u8282\u70B9 IP"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-txt",metastring:'title="/etc/hosts"',children:"172.32.1.1 docker.io\n172.32.1.1 registry-1.docker.io\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u76F4\u63A5\u6620\u5C04\u5355\u4E2A\u57DF\u540D"}),"\n",(0,r.jsx)(e.li,{children:"\u6CE8\u610F\uFF1A CNAME \u7684\u57DF\u540D\u4E5F\u9700\u8981\u6620\u5C04"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u4E3A\u4EC0\u4E48\u7528-1723211",children:"\u4E3A\u4EC0\u4E48\u7528 172.32.1.1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"172.32.1.1 \u4E3A\u516C\u7F51 IP \u5730\u5740\uFF0C\u4F46\u8FD9\u4E2A\u5730\u5740\u88AB\u4F7F\u7528\u7684\u6982\u7387\u975E\u5E38\u4F4E"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679C\u4E0D\u7ED9\u4EE3\u7406\u8282\u70B9\u4E00\u4E2A\u516C\u7F51\u5730\u5740\u800C\u662F\u4F7F\u7528\u5185\u7F51\u5730\u5740\uFF0C\u90A3\u4E48 iOS \u8BBF\u95EE\u7F51\u7EDC\u65F6\u4F1A\u63D0\u793A \u201C\u662F\u5426\u5141\u8BB8\u5E94\u7528\u8BBF\u95EE\u672C\u5730\u7F51\u7EDC\u201D\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u4E3A\u4EC0\u4E48\u9009\u62E9-dnssni-\u4F5C\u4E3A\u5168\u5C40\u4EE3\u7406",children:"\u4E3A\u4EC0\u4E48\u9009\u62E9 DNS+SNI \u4F5C\u4E3A\u5168\u5C40\u4EE3\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5BA2\u6237\u7AEF\u65E0\u611F\uFF0C\u4E0D\u9700\u8981\u6539\u4EFB\u4F55\u914D\u7F6E"}),"\n",(0,r.jsx)(e.li,{children:"\u80FD\u5B9E\u73B0\u5168\u5C40 - \u4F8B\u5982 docker \u4E0D\u9700\u8981\u5C31\u884C\u914D\u7F6E\uFF0Ck8s \u4E0D\u9700\u8981\u5C31\u884C\u914D\u7F6E \u5C31\u80FD\u62C9\u53D6\u955C\u50CF"}),"\n",(0,r.jsx)(e.li,{children:"\u4EE3\u7406\u8303\u56F4\u6613\u4E8E\u63A7\u5236 - DNS \u5C42\u63A7\u5236"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u80FD\u4E0D\u80FD\u4E0D\u9650\u5236\u57DF\u540D\u6240\u6709\u90FD\u4EE3\u7406",children:"\u80FD\u4E0D\u80FD\u4E0D\u9650\u5236\u57DF\u540D\u6240\u6709\u90FD\u4EE3\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\uFF0Cdnsmasq \u9ED8\u8BA4\u5168\u90E8\u8FD4\u56DE\u56FA\u5B9A ip"}),"\n",(0,r.jsx)(e.li,{children:"\u786E\u4FDD\u4E0A\u6E38\u4EE3\u7406\u652F\u6301\u7B56\u7565\u63A7\u5236\u5373\u53EF\uFF0C\u4F8B\u5982 clash"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u5173\u4E8E\u4E0A\u6E38-dns",children:"\u5173\u4E8E\u4E0A\u6E38 DNS"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u9009\u62E9\u516C\u5171\u7684\uFF0C\u4F8B\u5982 223.5.5.5"}),"\n",(0,r.jsxs)(e.li,{children:["\u4E5F\u53EF\u4EE5\u9009\u62E9\u81EA\u5DF1\u90E8\u7F72\u7684 adguard \u4E4B\u7C7B\u7684\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u652F\u6301\u62E6\u622A\u9690\u79C1\u76F8\u5173\u57DF\u540D"}),"\n",(0,r.jsx)(e.li,{children:"\u907F\u514D DNS \u6C61\u67D3"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u5176\u4ED6\u65E0\u611F\u5168\u5C40\u4EE3\u7406\u7684\u65B9\u5F0F",children:"\u5176\u4ED6\u65E0\u611F\u5168\u5C40\u4EE3\u7406\u7684\u65B9\u5F0F"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u4FEE\u6539\u7F51\u5173\uFF0Ctproxy - \u65E0\u611F\uFF0C\u4F46\u662F\u91CD\u65B0\u90E8\u7F72 dhcp\uFF0C\u66FF\u4EE3\u8DEF\u7531\u4F5C\u4E3A\u7F51\u5173"}),"\n",(0,r.jsx)(e.li,{children:"\u5728 WiFi+Lan \u7684\u8282\u70B9\u4E0A\uFF0C\u5C06 WiFi \u914D\u7F6E\u4E3A\u8D70\u4EE3\u7406\uFF0C\u8FDE WiFi \u5219\u8D70\u4EE3\u7406\uFF0C\u589E\u52A0\u4E00\u4E2A lan \u4E0D\u4FEE\u6539\u73B0\u6709\u3002"}),"\n"]})]})}function a(n={}){let{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(h,{...n})}):h(n)}},17776:function(n,e,s){s.d(e,{R:()=>d,x:()=>t});var l=s(7378);let r={},i=l.createContext(r);function d(n){let e=l.useContext(i);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:d(n.components),l.createElement(i.Provider,{value:e},n.children)}},35234:function(n){n.exports=JSON.parse('{"permalink":"/story/sni-proxy","editUrl":"https://github.com/wenerme/wener/edit/master/story/../story/2023/2023-06-21-sni-proxy.md","source":"@site/../story/2023/2023-06-21-sni-proxy.md","title":"\u57FA\u4E8E SNI \u5B9E\u73B0\u65E0\u611F\u5168\u5C40\u4EE3\u7406","description":"\u57FA\u672C\u7ED3\u6784","date":"2023-06-21T00:00:00.000Z","tags":[{"inline":true,"label":"\u4EE3\u7406","permalink":"/story/tags/\u4EE3\u7406"},{"inline":true,"label":"\u8FD0\u7EF4","permalink":"/story/tags/\u8FD0\u7EF4"}],"readingTime":2.93,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"sni-proxy","title":"\u57FA\u4E8E SNI \u5B9E\u73B0\u65E0\u611F\u5168\u5C40\u4EE3\u7406","tags":["\u4EE3\u7406","\u8FD0\u7EF4"]},"unlisted":false,"prevItem":{"title":"\u4E3A\u4EC0\u4E48\u9009\u62E9 Alpine Linux?","permalink":"/story/why-alpine"},"nextItem":{"title":"\u6062\u590D\u7FA4\u6656\u6570\u636E\u76D8","permalink":"/story/recover-synology"}}')}}]);