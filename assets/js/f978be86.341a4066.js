"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["317621"],{213675:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>r,toc:()=>h,default:()=>j,metadata:()=>s,assets:()=>c,contentTitle:()=>t});var s=JSON.parse('{"id":"dev/design/design-schema","title":"Schema Design","description":"- \u8868\u5C3D\u91CF\u4E0D\u8981\u524D\u7F00 - \u6E05\u6670\u660E\u4E86","source":"@site/../notes/dev/design/design-schema.md","sourceDirName":"dev/design","slug":"/dev/design/schema","permalink":"/notes/dev/design/schema","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/design/design-schema.md","tags":[{"inline":true,"label":"Design","permalink":"/notes/tags/design"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1759988681000,"frontMatter":{"title":"Schema Design","tags":["Design"]},"sidebar":"docs","previous":{"title":"Schema Migration","permalink":"/notes/dev/design/schema-migration"},"next":{"title":"\u670D\u52A1","permalink":"/notes/dev/design/service"}}'),l=i(486106),d=i(917776);let r={title:"Schema Design",tags:["Design"]},t="Schema Design",c={},h=[{value:"\u4E3B\u952E\u751F\u6210",id:"id",level:2},{value:"\u4E3B\u952E\u7C7B\u578B",id:"typed-id",level:2},{value:"\u5143\u6570\u636E",id:"metadata",level:2},{value:"current_tenant_id",id:"current_tenant_id",level:2},{value:"\u79DF\u6237 ID/TID \u5B57\u7B26\u4E32\u8FD8\u662F\u6570\u5B57",id:"choose-tid",level:2},{value:"created_at vs create_time",id:"created_at-vs-create_time",level:2},{value:"\u6269\u5C55",id:"extension",level:2},{value:"\u5355\u6570\u8FD8\u662F\u590D\u6570\u8868\u540D",id:"plural",level:2},{value:"\u5C3D\u91CF\u4F7F\u7528\u5916\u952E",id:"fk",level:2},{value:"User Defined Order",id:"user-defined-order",level:2},{value:"serial id",id:"serial-id",level:2},{value:"table prefix vs schema",id:"table-prefix-vs-schema",level:2},{value:"date vs timestamptz",id:"date-vs-timestamptz",level:2},{value:"\u901A\u8FC7\u751F\u6210\u5B9E\u73B0\u591A\u6001 ID \u5173\u8054",id:"entity_id_type",level:2}];function x(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"schema-design",children:"Schema Design"})}),"\n",(0,l.jsx)(e.admonition,{title:"Schema \u8BBE\u8BA1\u53C2\u8003",type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u8868\u5C3D\u91CF\u4E0D\u8981\u524D\u7F00 - \u6E05\u6670\u660E\u4E86\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"MySQL \u989D\u5916\u8003\u8651"}),"\n",(0,l.jsx)(e.li,{children:"PG \u652F\u6301 Schema \u9694\u79BB - \u907F\u514D\u76F4\u63A5\u4F7F\u7528 public schema"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u5B57\u6BB5\u5C3D\u91CF\u4E0D\u8981\u7F29\u5199"}),"\n",(0,l.jsxs)(e.li,{children:["\u5C3D\u91CF\u4E0D\u8981\u7528 \u62FC\u97F3\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u505A\u56FD\u5185\u73AF\u5883\u9664\u5916 - \u4F8B\u5982\uFF1A\u653F\u4F01\u6570\u636E\u65E0\u6CD5\u5F88\u597D\u7FFB\u8BD1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7EF4\u62A4\u5F00\u53D1\u5B57\u5178 - \u4F8B\u5982 ",(0,l.jsx)(e.a,{href:"https://wener.me/notes/dev/dict",children:"\u5F00\u53D1\u7528\u8BCD\u5B57\u5178"})]}),"\n",(0,l.jsxs)(e.li,{children:["\u5C3D\u91CF ",(0,l.jsx)(e.strong,{children:"\u4E0D\u8981"})," \u7528\u81EA\u589E\u957F ID\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5BB9\u6613\u88AB\u904D\u5386"}),"\n",(0,l.jsx)(e.li,{children:"\u9762\u5411\u7528\u6237\u7684\u53EF\u4EE5 \u589E\u52A0\u989D\u5916\u7684 \u81EA\u589E\u957F \u7F16\u53F7/\u5E8F\u53F7"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u4F7F\u7528 \u6709\u5E8F\u7684 \u968F\u673A\u4E3B\u952E - ULID, UUID"}),"\n",(0,l.jsx)(e.li,{children:"\u5EFA\u8BAE\u4E3B\u952E\u589E\u52A0 type tag"}),"\n",(0,l.jsxs)(e.li,{children:["PostgreSQL\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5C3D\u91CF\u7528 text, bigint, jsonb, bool, timestamptz"}),"\n",(0,l.jsxs)(e.li,{children:["\u770B\u60C5\u51B5\u7528 array - array \u80FD\u7B80\u5316\u4E0D\u5C11\u9700\u8981 join \u8868\u7684\u573A\u666F - \u4F8B\u5982 ",(0,l.jsx)(e.code,{children:"tags text[]"})]}),"\n",(0,l.jsxs)(e.li,{children:["\u907F\u514D varchar(n) \u9650\u5B9A\u957F\u5EA6\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E1A\u52A1\u5C42\u63A7\u5236 validation"}),"\n",(0,l.jsx)(e.li,{children:"\u901A\u8FC7 check \u9A8C\u8BC1"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,l.jsx)(e.h2,{id:"id",children:"\u4E3B\u952E\u751F\u6210"}),"\n",(0,l.jsx)(e.admonition,{type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5EFA\u8BAE K-Sortable"}),"\n",(0,l.jsx)(e.li,{children:"\u5EFA\u8BAE\u5C0F\u5199"}),"\n",(0,l.jsx)(e.li,{children:"\u4E0D\u8981\u5927\u5C0F\u5199\u6DF7\u5408"}),"\n",(0,l.jsx)(e.li,{children:"\u53EF\u4EE5\u8003\u8651\u52A0\u7C7B\u578B tag"}),"\n",(0,l.jsxs)(e.li,{children:["\u53EF\u4EE5\u7528 ",(0,l.jsx)(e.code,{children:"_"}),", \u907F\u514D\u7528 ",(0,l.jsx)(e.code,{children:"-"}),", \u65B9\u4FBF\u53CC\u51FB\u9009\u4E2D \u4F8B\u5982 usr_123"]}),"\n"]})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"/notes/db/ulid",children:"ULID"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"128bit - \u7F16\u7801\u540E 26 \u5B57\u7B26 - base32"}),"\n",(0,l.jsx)(e.li,{children:"timestamp 48bits + random 80bits"}),"\n",(0,l.jsx)(e.li,{children:"\u6709\u5E8F - \u53EF\u4EE5\u7528\u4E8E\u6392\u5E8F"}),"\n",(0,l.jsx)(e.li,{children:"\u987A\u5E8F\u8BBF\u95EE\u66F4\u5BB9\u6613\u547D\u4E2D\u7F13\u5B58"}),"\n",(0,l.jsxs)(e.li,{children:["\u7F3A\u70B9\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53EA\u80FD\u5B58\u50A8\u4E3A string"}),"\n",(0,l.jsx)(e.li,{children:"\u9700\u8981\u989D\u5916\u7684 function - \u6BD4\u8F83\u5C11\u6709\u5185\u90E8\u5B9E\u73B0"}),"\n",(0,l.jsx)(e.li,{children:"\u4E0D\u4E00\u5B9A\u80FD\u4FDD\u8BC1\u5168\u5C40\u9012\u589E - \u56E0\u4E3A\u9700\u8981\u7EF4\u62A4\u5168\u5C40\u72B6\u6001 - \u5927\u591A\u65F6\u5019\u6CA1\u95EE\u9898"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["UUIDv4\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["128bit - \u7F16\u7801\u540E 36 \u5B57\u7B26 - hex+4dash - ",(0,l.jsx)(e.code,{children:"8-4-4-4-12"})," - 32+4"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"2*int64"})," / ",(0,l.jsx)(e.code,{children:"2*long"})]}),"\n",(0,l.jsx)(e.li,{children:"\u6570\u636E\u5E93\u652F\u6301 UUID \u7C7B\u578B\u7684\u8BDD\u80FD\u4F7F\u7528\u66F4\u5C11\u7A7A\u95F4 - 36 -> 16"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://en.wikipedia.org/wiki/Snowflake_ID",children:"Snowflake ID"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"by Twitter 2010-06"}),"\n",(0,l.jsxs)(e.li,{children:["64bit - \u5B9E\u9645\u53EA\u7528\u4E86 63bit - ",(0,l.jsx)(e.strong,{children:"\u80FD\u653E\u5728 long \u91CC"})]}),"\n",(0,l.jsxs)(e.li,{children:["timestamp 41bits + instance 10bits + sequence 12bits\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["sequence - 4096 \u4E2A - \u6B63\u5E38 1ms \u5185\u8FBE\u5230\u4E86\u4F1A\u9012\u589E timestamp - ",(0,l.jsx)(e.strong,{children:"\u9700\u8981\u7EF4\u62A4\u5168\u5C40\u72B6\u6001"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["69 years\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["timestamp \u901A\u8FC7 offset \u8C03\u6574 - e.g ",(0,l.jsx)(e.code,{children:"(2023-1970)*31536000*1000"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["instance - Machine ID\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6CE8\u610F\u9009\u62E9\uFF0C\u901A\u5E38\u4F7F\u7528 IP/Hostname/Mac"}),"\n",(0,l.jsx)(e.li,{children:"AmazonEC2MachineID"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679C instance \u6709\u4E1A\u52A1\u542B\u4E49\uFF0C\u90A3\u4E48\u65E0\u6CD5 DB \u76F4\u63A5 \u751F\u6210"}),"\n",(0,l.jsxs)(e.li,{children:["adopted by Discord, Instagram, Mastodon\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Discord: epoch 2015-01-01"}),"\n",(0,l.jsx)(e.li,{children:"Instagram: ts 41bits + shard id 13bits + sequence 10bits"}),"\n",(0,l.jsx)(e.li,{children:"Mastodon: ts ms 48bits + sequence 16bits"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/sony/sonyflake",children:"sony/sonyflake"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"ts 10msec 39bit + machine 16bit + sequence 8bit"}),"\n",(0,l.jsx)(e.li,{children:"174 years"}),"\n",(0,l.jsx)(e.li,{children:"\u5904\u7406\u66F4\u591A\u7684 instance"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://www.ietf.org/archive/id/draft-ietf-uuidrev-rfc4122bis-00.html#name-uuid-version-7",children:"UUIDv7"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"{unix_ts_ms:48 bit}{ver:4bit}{rand_a:12bit}{var:2bit}{rand_b:64bit}"})}),"\n",(0,l.jsx)(e.li,{children:"\u517C\u5BB9 UUID"}),"\n",(0,l.jsx)(e.li,{children:"\u6709\u5E8F - \u65F6\u95F4\u6233"}),"\n",(0,l.jsx)(e.li,{children:"\u7C7B\u4F3C\u4E8E ULID"}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/craigpastro/pg_uuidv7",children:"craigpastro/pg_uuidv7"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Postgres extension"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/ai/nanoid",children:"NanoID"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E00\u822C\u4E0D\u76F4\u63A5\u7528\u4E8E DB, \u524D\u7AEF\u7528\u7684\u591A"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"A-Za-z0-9_-"})}),"\n",(0,l.jsx)(e.li,{children:"26 bytes"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://hashids.org/",children:"hashid"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6570\u5B57+\u5B57\u7B26\u4E32\u751F\u6210"}),"\n",(0,l.jsx)(e.li,{children:"\u53EF\u7528\u4E8E\u9690\u85CF\u90E8\u5206\u4FE1\u606F"}),"\n",(0,l.jsx)(e.li,{children:"\u4F8B\u5982 \u5FAE\u4FE1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/segmentio/ksuid",children:"segmentio/ksuid"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"0ujsswThIGTUYm2K8FjOOfXtY1K"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/beyonddream/snowid",children:"beyonddream/snowid"})}),"\n",(0,l.jsxs)(e.li,{children:["K-Sortable\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u57FA\u672C\u6709\u5E8F"}),"\n",(0,l.jsx)(e.li,{children:"Prefetch \u4F18\u5316 - \u975E\u5E38\u5BB9\u6613\u8FDE\u7EED\u547D\u4E2D"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://sqids.org/",children:"https://sqids.org/"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["HN ",(0,l.jsx)(e.a,{href:"https://news.ycombinator.com/item?id=38414914",children:"https://news.ycombinator.com/item?id=38414914"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"typed-id",children:"\u4E3B\u952E\u7C7B\u578B"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"type-RANDOM"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["OpenAI ",(0,l.jsx)(e.code,{children:"sk-"}),",",(0,l.jsx)(e.code,{children:"org-"}),", ",(0,l.jsx)(e.code,{children:"chat-"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"type_RANDOM"})}),"\n",(0,l.jsxs)(e.li,{children:["GraphQL \u7684 NodeID \u5305\u542B Type \u4FE1\u606F\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Github ",(0,l.jsx)(e.a,{href:"https://docs.github.com/en/graphql/guides/using-global-node-ids",children:"Using global node IDs"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["MDQ6VXNlcjU4MzIzMQ==\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"04:User583231"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://graphql.org/learn/global-object-identification/",children:"Global Object Identification"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/jetpack-io/typeid",children:"jetpack-io/typeid"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Type-safe, K-sortable, globally unique identifier inspired by Stripe IDs"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://news.ycombinator.com/item?id=36508811",children:"HN"})}),"\n",(0,l.jsxs)(e.li,{children:["Tagged Id ",(0,l.jsx)(e.a,{href:"https://joist-orm.io/docs/advanced/tagged-ids",children:"https://joist-orm.io/docs/advanced/tagged-ids"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"TAG:ID"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["Reddit\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"tN_ID"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u{1F4A1} \u4F7F\u7528 ",(0,l.jsx)(e.code,{children:"_"})," \u53EF\u4EE5\u53CC\u51FB\u9009\u4E2D\u590D\u5236"]}),"\n",(0,l.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://en.wikipedia.org/wiki/Strongly_typed_identifier",children:"Strongly typed identifier"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"metadata",children:"\u5143\u6570\u636E"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"Note"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5143\u6570\u636E\u4E0D\u8981\u7528\u4E8E\u4E1A\u52A1\u4F9D\u8D56"}),"\n",(0,l.jsx)(e.li,{children:"\u53EF\u4EE5\u521B\u5EFA\u6A21\u677F\u8868\u7136\u540E CREATE TABLE LIKE"}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"column"}),(0,l.jsx)(e.th,{children:"for"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"id"}),(0,l.jsx)(e.td,{children:"\u4E3B\u952E - ULID, tagged ID"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"sid"}),(0,l.jsx)(e.td,{children:"\u79DF\u6237\u7EF4\u5EA6\u5355\u8C03\u9012\u589E - \u7528\u6237\u53CB\u597D"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"uid"}),(0,l.jsx)(e.td,{children:"UUID"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"tid"}),(0,l.jsx)(e.td,{children:"\u79DF\u6237 ID"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"eid"}),(0,l.jsx)(e.td,{children:"\u7528\u4E8E\u5BFC\u5165\u6570\u636E\u5173\u8054 - tid+eid \u552F\u4E00"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"cid"}),(0,l.jsx)(e.td,{children:"\u5916\u90E8\u7CFB\u7EDF\u79DF\u6237 ID - Colocate ID/Corp ID - tid+cid+rid \u552F\u4E00"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"rid"}),(0,l.jsx)(e.td,{children:"\u5916\u90E8\u7CFB\u7EDF\u8D44\u6E90 ID - Ref ID/Relative ID"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"created_at"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"updated_at"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"deleted_at"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"version"}),(0,l.jsx)(e.td,{children:"\u57FA\u4E8E\u7248\u672C\u7684\u4E50\u89C2\u9501"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"metadata"}),(0,l.jsx)(e.td,{children:"\u8865\u5145\u6570\u636E"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"attributes"}),(0,l.jsx)(e.td,{children:"\u4F7F\u7528\u7AEF\u81EA\u5B9A\u4E49\u6570\u636E - \u5BA2\u6237\u7AEF \u8BFB\u5199"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"properties"}),(0,l.jsx)(e.td,{children:"\u670D\u52A1\u7AEF\u81EA\u5B9A\u4E49\u6570\u636E - \u5BA2\u6237\u7AEF \u53EA\u8BFB"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"extensions"}),(0,l.jsx)(e.td,{children:"\u5185\u90E8\u6269\u5C55\u6570\u636E - \u5BA2\u6237\u7AEF \u4E0D\u53EF\u89C1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"owner_id"}),(0,l.jsx)(e.td,{children:"\u6240\u6709\u8005"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"owner_type"}),(0,l.jsx)(e.td,{children:"User, Team, Department, Organization"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"owner_user_id"}),(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"case owner_type when 'User' then owner_id end"})})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"owner_team_id"}),(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"case owner_type when 'Team' then owner_id end"})})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"entity_id"}),(0,l.jsx)(e.td,{children:"\u5173\u8054\u4EFB\u610F\u5B9E\u4F53"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"entity_type"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"created_by_id"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"updated_by_id"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"deleted_by_id"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"state"}),(0,l.jsx)(e.td,{children:"\u72B6\u6001 - \u9762\u5411\u7CFB\u7EDF\uFF0C\u4E0D\u53EF\u81EA\u5B9A\u4E49"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"status"}),(0,l.jsx)(e.td,{children:"\u4E1A\u52A1\u72B6\u6001\u3001\u9636\u6BB5\u3001\u539F\u56E0\u3001\u7EC6\u8282 - \u53EF\u81EA\u5B9A\u4E49"})]})]})]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["eid\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u540C\u8D28\u7CFB\u7EDF\u5BFC\u5165\u5916\u5EFA\u5173\u8054 - \u4F8B\u5982: SaaS <-> \u73B0\u5B58\u5185\u90E8\u7CFB\u7EDF"}),"\n",(0,l.jsx)(e.li,{children:"\u4E5F\u53EF\u80FD\u4F1A\u5BFC\u51FA\u518D\u5BFC\u5165"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["cid & rid\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u975E\u540C\u8D28\u7CFB\u7EDF - \u4F8B\u5982: \u670D\u52A1\u5546\u3001\u5E73\u53F0"}),"\n",(0,l.jsx)(e.li,{children:"-> sourceType+sourceId"}),"\n",(0,l.jsx)(e.li,{children:"-> vendorType+vendorId"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"create table tpl_res\n(\n    -- \u57FA\u7840\n    id                  text        not null default gen_ulid(),\n    tid                 bigint      not null default current_tenant_id(), -- \u79DF\u6237\n    uid                 uuid        not null default gen_random_uuid(),\n    sid                 bigint      not null default (next_res_sid('tpl_pri_resources')),\n    eid                 text        null , -- \u7528\u4E8E\u5BFC\u5165\u6570\u636E\u5173\u8054\n    created_at          timestamptz not null default current_timestamp,\n    updated_at          timestamptz not null default current_timestamp,\n    deleted_at          timestamptz,\n    -- auditor \u4FE1\u606F\n    created_by_id       text                 default current_setting('app.user.id'),\n    updated_by_id       text                 default current_setting('app.user.id'),\n    deleted_by_id       text,\n    -- \u6309\u9700\u9644\u52A0\u4EFB\u610F\u5C42\u9762\u7684\u6570\u636E\n    -- \u4F8B\u5982: attributes \u5141\u8BB8\u5BA2\u6237\u7AEF\u4FEE\u6539, properties \u4E0D\u5141\u8BB8\u5BA2\u6237\u7AEF\u4FEE\u6539, extensions \u5BA2\u6237\u7AEF\u4E0D\u53EF\u89C1\n    extensions          jsonb,\n    properties          jsonb,\n    attributes          jsonb,\n    -- \u4E1A\u52A1 owner \u4FE1\u606F\n    owner_id            text,\n    owner_type          text,\n    owner_uid           uuid,\n    owner_id            text,\n    owner_type          text, -- User, Team, Department\n    owner_user_id       text generated always as ( case owner_type when 'User' then owner_id end ) stored,\n    owner_team_id       text generated always as ( case owner_type when 'Team' then owner_id end ) stored,\n    owner_department_id text,\n    primary key (tid, id),\n    unique (tid, sid),\n    unique (tid, uid)\n);\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["id \u53EF\u6309\u7167\u4E1A\u52A1\u903B\u8F91\u751F\u6210 - \u4F8B\u5982: ",(0,l.jsx)(e.code,{children:"<tid>-<\u8D44\u6E90\u540D\u79F0>-UUID/ULID"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u7C7B\u4F3C\u4E8E GraphQL NodeID\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4F8B\u5982: ",(0,l.jsx)(e.code,{children:"1-user-xxxxxxxxxxx"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u7C7B\u4F3C\u4E8E AIP \u7684 resource-name"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"sid \u79DF\u6237\u7EF4\u5EA6\u5355\u8C03\u9012\u589E - \u7528\u6237\u53CB\u597D"}),"\n",(0,l.jsx)(e.li,{children:"owner \u903B\u8F91\u53D6\u51B3\u4E8E\u4E1A\u52A1 - \u4F8B\u5982: \u6743\u9650\uFF0C\u5B64\u513F\u5BF9\u8C61\u5224\u65AD"}),"\n",(0,l.jsxs)(e.li,{children:["\u5176\u4ED6\u5143\u6570\u636E\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"version - \u7528\u4E8E\u652F\u6301\u573A\u666F\u7684\u66F4\u65B0\u903B\u8F91 - \u4F8B\u5982: Hibernate"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u8868\u5206\u7C7B\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["primary - \u4E3B\u8981\u8D44\u6E90\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4F8B\u5982: accounts, orders"}),"\n",(0,l.jsx)(e.li,{children:"\u6709 owener\u3001\u9644\u52A0\u5143\u4FE1\u606F\u3001auditor"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7528\u6237\u65E0\u5173\u8868\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u65E0 owner\u3001auditor"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5173\u8054\u8868 - \u4E2D\u95F4\u8868\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53EF\u80FD\u6709\u989D\u5916\u4FE1\u606F\u3001\u53EF\u80FD\u6709 tid"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7CFB\u7EDF\u8868\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53EA\u6709\u57FA\u7840\u5B57\u6BB5 - id\u3001sid\u3001tid\u3001uid"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"current_tenant_id",children:"current_tenant_id"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"create function current_tenant_id() returns text\n    stable\n    parallel safe\n    language plpgsql\nas\n$$\nDECLARE\n    tid text := coalesce(\n            nullif(current_setting('tenant.id', true), '')::text,\n            ((regexp_match(current_user, '(^|_)tenant_([^_]+)$'))[1])::text\n        );\nBEGIN\n    IF tid IS NULL THEN\n        RAISE EXCEPTION 'Missing tenant in context'\n            USING HINT = 'Please check your execution context';\n    END IF;\n    RETURN tid;\nEND;\n$$;\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"select set_config('tenant.id','1', true);\n"})}),"\n",(0,l.jsx)(e.h2,{id:"choose-tid",children:"\u79DF\u6237 ID/TID \u5B57\u7B26\u4E32\u8FD8\u662F\u6570\u5B57"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E0D\u505A\u7279\u6B8A\u8003\u8651\u53EF\u9009\u62E9\u5B57\u7B26\u4E32"}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u6570\u5B57\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5185\u90E8\u597D\u5904\u7406"}),"\n",(0,l.jsx)(e.li,{children:"\u77ED\u5C0F\u597D\u8BB0"}),"\n",(0,l.jsx)(e.li,{children:"\u4E0D\u6613\u4E8E\u8FC1\u79FB"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5B57\u7B26\u4E32\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u65E0\u7279\u6B8A\u8BED\u4E49"}),"\n",(0,l.jsx)(e.li,{children:"\u53EF\u4EE5\u5FFD\u7565"}),"\n",(0,l.jsxs)(e.li,{children:["\u5EFA\u8BAE\u7B26\u5408 domain \u89C4\u8303\uFF0C\u6216\u8005\u80FD\u5904\u7406\u4E3A domain \u89C4\u8303\uFF0C\u65B9\u4FBF ",(0,l.jsx)(e.code,{children:"<TID>.wener.me"})," \u5F62\u5F0F\u57DF\u540D\u8BBF\u95EE"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(e.h2,{id:"created_at-vs-create_time",children:"created_at vs create_time"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["created_at, ",(0,l.jsx)(e.code,{children:"*_at"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u8BED\u4E49 \u51C6\u786E"}),"\n",(0,l.jsxs)(e.li,{children:["\u4E0E ",(0,l.jsx)(e.code,{children:"created_by_id"})," \u5F62\u5F0F\u4E0A\u7C7B\u4F3C"]}),"\n",(0,l.jsx)(e.li,{children:"\u4F7F\u7528: Spring, Gorm \u9ED8\u8BA4"}),"\n",(0,l.jsxs)(e.li,{children:["\u9762\u5411 ",(0,l.jsx)(e.strong,{children:"\u7CFB\u7EDF"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["create_time, ",(0,l.jsx)(e.code,{children:"*_time"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4F7F\u7528: AIP"}),"\n",(0,l.jsxs)(e.li,{children:["\u9762\u5411 ",(0,l.jsx)(e.strong,{children:"\u7528\u6237"}),", \u4E1A\u52A1"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"extension",children:"\u6269\u5C55"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["extensions\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5185\u90E8\u4F7F\u7528"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["properties\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u670D\u52A1\u7AEF\u4F7F\u7528\uFF0C\u524D\u7AEF\u53EF\u89C1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["attributes\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u524D\u7AEF\u4F7F\u7528\uFF0C\u670D\u52A1\u7AEF\u53EF\u89C1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["metadata\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5BF9\u6570\u636E\u5185\u5BB9\u7684\u8865\u5145\u8BF4\u660E"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["raw\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5916\u90E8\u5BFC\u5165\u539F\u59CB\u6570\u636E"}),"\n",(0,l.jsx)(e.li,{children:"\u4E5F\u53EF\u4EE5\u8BB0\u5F55\u5230 metadata, properties.raw, extensions.raw"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"plural",children:"\u5355\u6570\u8FD8\u662F\u590D\u6570\u8868\u540D"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u63A8\u8350\u5355\u6570\u5F62\u5F0F\u3002\n\u90E8\u5206\u5173\u952E\u8BCD\u4F7F\u7528\u590D\u6570: users, groups\u3002"}),"\n"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u590D\u6570\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5927\u591A\u6846\u67B6\u9ED8\u8BA4"}),"\n",(0,l.jsx)(e.li,{children:"\u8BED\u4E49\u4E0A\u66F4\u51C6\u786E"}),"\n",(0,l.jsx)(e.li,{children:"\u903B\u8F91\u4E0A\u66F4\u590D\u6742"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5355\u6570\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4EE3\u7801\u5C42\u9762\u66F4\u597D\u7EDF\u4E00"}),"\n",(0,l.jsx)(e.li,{children:"\u4F46\u90E8\u5206\u5355\u6570\u5F62\u5F0F\u53EF\u80FD\u9700\u8981 quote"}),"\n",(0,l.jsxs)(e.li,{children:["user \u4E5F\u53EF\u4EE5\u7528 ",(0,l.jsx)(e.code,{children:"app_user"})," \u4E4B\u7C7B\u7684\u4F5C\u4E3A\u533A\u5206"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://stackoverflow.com/questions/338156",children:"https://stackoverflow.com/questions/338156"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"fk",children:"\u5C3D\u91CF\u4F7F\u7528\u5916\u952E"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u80FD\u4E00\u5B9A\u7A0B\u5EA6\u63D0\u5347\u67E5\u8BE2\u6027\u80FD"}),"\n",(0,l.jsx)(e.li,{children:"\u589E\u52A0\u90E8\u5206 \u63D2\u5165 \u548C \u66F4\u65B0 \u6210\u672C"}),"\n",(0,l.jsx)(e.li,{children:"\u786E\u4FDD\u4E1A\u52A1\u903B\u8F91\u51C6\u786E"}),"\n",(0,l.jsx)(e.li,{children:"\u975E\u5F3A\u4E1A\u52A1\u770B\u60C5\u51B5"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"user-defined-order",children:"User Defined Order"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u76EE\u524D\u65B9\u6848\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5168\u5C40\u4F7F\u7528\u4E00\u4E2A sequence"}),"\n",(0,l.jsx)(e.li,{children:"\u5B58\u50A8\u4E3A numberic"}),"\n",(0,l.jsx)(e.li,{children:"\u901A\u8FC7\u4E2D\u95F4\u503C\u6765\u6392\u5E8F"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://begriffs.com/posts/2018-03-20-user-defined-order.html",children:"https://begriffs.com/posts/2018-03-20-user-defined-order.html"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"serial-id",children:"serial id"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u5F88\u591A\u65F6\u5019\u9700\u8981\u4E00\u4E2A\u6709\u5E8F\u7684 id\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4F8B\u5982 \u81EA\u52A8\u7684\u5BA2\u6237\u7F16\u53F7"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u8FD9\u6837\u7684 ID \u53EF\u80FD\u662F\u9650\u5B9A\u79DF\u6237\u6216\u8005\u4E0A\u4E0B\u6587\u7684"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"create table if not exists users\n(\n\n  id  text   not null default 'user_' || public.gen_ulid() primary key,\n  uid uuid   not null default gen_random_uuid() unique,\n  sid bigint not null default next_entity_sid('user')\n);\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"create table if not exists public.entity_sequence\n(\n  tid        text      not null,\n  type_name  text      not null,\n  sequence   bigint    not null,\n  created_at timestamp not null,\n  updated_at timestamp not null,\n  primary key (tid, type_name),\n  foreign key (tid) references public.tenant (tid)\n);\n\ncreate or replace function public.next_entity_sid(in_type_name text,\n                                                  in_tid public.tenant.tid%TYPE = public.current_tenant_id())\n  returns bigint\n  language plpgsql\n  volatile\nas\n$$\ndeclare\n  out_next entity_sequence.sequence%TYPE;\nbegin\n  if in_type_name is null then\n    raise exception 'Empty sequence'\n      using hint = 'check you table definition';\n  end if;\n  -- trigger less default computing\n  update entity_sequence\n  set sequence=sequence + 1\n  where tid = in_tid\n    and type_name = in_type_name\n    and updated_at = now()\n  returning sequence into out_next;\n  if out_next is null\n  then\n    insert into entity_sequence(tid, type_name, sequence, created_at, updated_at)\n    values (in_tid, in_type_name, 1, now(), now())\n    on conflict(tid,type_name) do update set (sequence, updated_at)= (excluded.sequence + 1, excluded.updated_at)\n    returning sequence into out_next;\n  end if;\n  return out_next;\nend;\n$$;\n"})}),"\n",(0,l.jsx)(e.h2,{id:"table-prefix-vs-schema",children:"table prefix vs schema"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E0D\u8981\u7528 public schema"}),"\n",(0,l.jsx)(e.li,{children:"SQL \u6807\u51C6\u91CC\u6CA1\u6709 public schema"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["schema - crm.account\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4F18\u70B9\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u66F4\u597D\u9694\u79BB"}),"\n",(0,l.jsx)(e.li,{children:"\u66F4\u597D\u6743\u9650\u63A7\u5236"}),"\n",(0,l.jsx)(e.li,{children:"\u540D\u5B57\u6613\u8BFB\uFF0C\u907F\u514D\u51B2\u7A81"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7F3A\u70B9\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u589E\u52A0\u7BA1\u7406\u7684\u590D\u6742\u6027"}),"\n",(0,l.jsx)(e.li,{children:"\u8DE8 schema \u67E5\u8BE2\u590D\u6742"}),"\n",(0,l.jsxs)(e.li,{children:["schema \u67D0\u79CD\u7A0B\u5EA6\u9690\u542B\u4E86\u4E1A\u52A1\u903B\u8F91 - \u4F8B\u5982 \u53EA\u652F\u6301 PG\uFF0C\u542F\u52A8\u9650\u5B9A\u4E86 schema\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E5F\u53EF\u4EE5\u4F5C\u4E3A\u53EF\u914D\u7F6E\uFF0C\u7C7B\u4F3C\u4E8E\u4EE5\u524D\u7684 PHP \u5E94\u7528\u5957\u9910\u652F\u6301\u4FEE\u6539 table prefix"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["prefix - crm_account\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4F18\u70B9\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7B80\u5355"}),"\n",(0,l.jsx)(e.li,{children:"\u67E5\u8BE2\u7B80\u4FBF"}),"\n",(0,l.jsx)(e.li,{children:"\u6240\u6709 DB \u90FD\u652F\u6301"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7F3A\u70B9\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9694\u79BB\u6027\u8F83\u5DEE"}),"\n",(0,l.jsx)(e.li,{children:"\u5BB9\u6613\u51B2\u7A81"}),"\n",(0,l.jsx)(e.li,{children:"\u6743\u9650\u63A7\u5236\u590D\u6742"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/ddl-schemas.html",children:"https://www.postgresql.org/docs/current/ddl-schemas.html"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"date-vs-timestamptz",children:"date vs timestamptz"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u5EFA\u8BAE\u7EDF\u4E00\u4F7F\u7528 timestamptz\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u907F\u514D\u5904\u7406\u65F6\u533A\u548C\u8F6C\u6362\u95EE\u9898"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5EFA\u8BAE\u901A\u8FC7 column \u540D\u5B57\u6765\u533A\u5206, \u4F8B\u5982 ",(0,l.jsx)(e.code,{children:"start_date timestamptz"})]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["timestamptz\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E0D\u662F immutable \u7684\uFF0C\u4F9D\u8D56\u5F53\u524D TZ \u4FE1\u606F"}),"\n",(0,l.jsxs)(e.li,{children:["\u5728 immutable \u573A\u666F\u4F7F\u7528\u65F6\uFF0C\u9700\u8981\u5148\u8F6C\u6362\u4E3A\u65E0 tz \u7684\u683C\u5F0F\uFF0C\u4F8B\u5982 ",(0,l.jsx)(e.code,{children:"payment_time at time zone 'Asia/Shanghai'"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["date\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u662F immutable \u7684"}),"\n",(0,l.jsx)(e.li,{children:"\u4F46\u5176\u503C\u53D6\u51B3\u4E8E\u5F53\u524D\u8F6C\u6362\u7684\u4E0A\u4E0B\u6587 TZ"}),"\n",(0,l.jsx)(e.li,{children:"\u9664\u975E\u786E\u5B9A\u662F date \u7684\u4E0A\u4E0B\u6587\uFF0C\u5426\u5219\u5C3D\u91CF\u7528 timestamptz"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"entity_id_type",children:"\u901A\u8FC7\u751F\u6210\u5B9E\u73B0\u591A\u6001 ID \u5173\u8054"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53EF\u4EE5\u5B9E\u73B0\u5916\u6309\u952E\u5173\u8054\u591A\u6001\u7C7B\u578B"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"create table entity_label(\n  id                  text        not null default gen_ulid(),\n\n  -- \u591A\u6001\u5173\u8054\uFF0C\u65E0\u6CD5\u5916\u952E\n  entity_id           text        not null,\n  entity_type         text        not null,\n\n  account_id text generated always as ( case entity_type when 'Account' then entity_id end ) stored,\n\n  foreign key (account_id) references account(id),\n)\n"})})]})}function j(n={}){let{wrapper:e}={...(0,d.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(x,{...n})}):x(n)}},917776:function(n,e,i){i.d(e,{R:()=>r,x:()=>t});var s=i(7378);let l={},d=s.createContext(l);function r(n){let e=s.useContext(d);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:r(n.components),s.createElement(d.Provider,{value:e},n.children)}}}]);