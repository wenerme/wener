"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["25791"],{9307:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>c,toc:()=>l,default:()=>u,metadata:()=>s,assets:()=>i,contentTitle:()=>a});var s=JSON.parse('{"id":"web/react/zustand","title":"zustand","description":"- pmndrs/zustand \u662F\u4EC0\u4E48\uFF1F","source":"@site/../notes/web/react/zustand.md","sourceDirName":"web/react","slug":"/web/react/zustand","permalink":"/notes/web/react/zustand","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/web/react/zustand.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1737304142000,"frontMatter":{"title":"zustand"},"sidebar":"docs","previous":{"title":"vercel/og","permalink":"/notes/web/react/vercel-og"},"next":{"title":"robots.txt","permalink":"/notes/web/robots.txt"}}'),r=n(86106),o=n(17776);let c={title:"zustand"},a="zustand",i={},l=[{value:"\u5728\u5916\u90E8\u89E6\u53D1\u72B6\u6001",id:"\u5728\u5916\u90E8\u89E6\u53D1\u72B6\u6001",level:2},{value:"\u901A\u8FC7\u5F15\u7528\u65B9\u5F0F\u4F18\u5316\u5FEB\u901F\u53D8\u5316\u7684\u72B6\u6001",id:"\u901A\u8FC7\u5F15\u7528\u65B9\u5F0F\u4F18\u5316\u5FEB\u901F\u53D8\u5316\u7684\u72B6\u6001",level:2},{value:"The result of getSnapshot should be cached to avoid an infinite loop Error Component Stack",id:"the-result-of-getsnapshot-should-be-cached-to-avoid-an-infinite-loop-error-component-stack",level:2},{value:"Zustand v4",id:"zustand-v4",level:2}];function d(e){let t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"zustand",children:"zustand"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://github.com/pmndrs/zustand",children:"pmndrs/zustand"})," \u662F\u4EC0\u4E48\uFF1F\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["out of tree \u72B6\u6001\u7BA1\u7406\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u53EF\u5916\u90E8\u67E5\u8BE2\u3001\u4FEE\u6539\u3001\u8BA2\u9605"}),"\n",(0,r.jsx)(t.li,{children:"\u53EF\u591A\u4E2A\u6E32\u67D3\u6811\u4F7F\u7528"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.li,{children:"\u652F\u6301 react concurrency"}),"\n",(0,r.jsx)(t.li,{children:"Context \u53EF\u9009"}),"\n",(0,r.jsx)(t.li,{children:"\u9ED8\u8BA4\u5168\u5C40 store \u5355\u4F8B"}),"\n",(0,r.jsx)(t.li,{children:"\u53EF\u5728\u5176\u5B83\u6846\u67B6\u4F7F\u7528 - \u4E0D\u4F9D\u8D56 react"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.li,{children:"subscribeWithSelector"}),"\n"]}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"useStore \u65F6\u63A8\u8350 memoize \u9009\u62E9\u5668\uFF0C\u907F\u514D\u6BCF\u6B21 render \u8BA1\u7B97"}),"\n",(0,r.jsx)(t.li,{children:"\u53EF\u4EE5\u5C06\u9009\u62E9\u5668\u5B9A\u4E49\u5728\u5916\u90E8\u907F\u514D\u52A8\u6001\u521B\u5EFA\u4EA7\u751F\u53D8\u5316"}),"\n",(0,r.jsx)(t.li,{children:"\u53EF\u914D\u5408 immer \u7B80\u5316\u64CD\u4F5C"}),"\n",(0,r.jsx)(t.li,{children:"create \u5305\u542B\u4E09\u4E2A\u53C2\u6570 - set,get,api - \u53EF\u62E6\u622A\u5B9E\u73B0\u4E2D\u95F4\u4EF6\u6A21\u5F0F"}),"\n"]})}),"\n",(0,r.jsx)(t.admonition,{type:"caution",children:(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u4E0A\u4E0B\u6587\u6A21\u5F0F\u5FC5\u987B\u8981\u6C42\u6709 Provider/Context - \u5426\u5219\u4F1A\u5F02\u5E38"}),"\n",(0,r.jsxs)(t.li,{children:["zustand \u4E0D\u597D\u5206\u9694\u72B6\u6001\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/issues/178",children:"#178"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/issues/520#issuecomment-891087525",children:"#520"})}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"// https://github.com/pmndrs/zustand\nimport create from 'zustand';\nimport shallow from 'zustand/shallow';\n\n// \u5B9A\u4E49\nconst useStore = create((set, get) => ({\n  count: 0,\n  add: () => set((state) => ({ count: state.count + 1 })),\n  reset: () => set({ count: 0 }),\n  clear: () => set({}, true), // true \u8868\u793A\u91CD\u7F6E\u6574\u4E2A state\n  fetch: async (pond) => {\n    // \u652F\u6301 async\n    const response = await fetch(pond);\n    set({ fishies: await response.json() });\n  },\n  action: () => {\n    const count = get().count; // \u65B9\u6CD5\u5185\u4F7F\u7528 get \u8BBF\u95EE\u72B6\u6001\n  },\n}));\n// \u4F7F\u7528\nconst state = useStore();\nconst count = useStore((state) => state.count);\nconst add = useStore((state) => state.add);\nconst count = useStore(\n  (state) => state.count,\n  (a, b) => compare(a, b), // \u81EA\u5B9A\u4E49 compare\n);\n// shallow compare\nconst [nuts, honey] = useStore((state) => [state.nuts, state.honey], shallow);\n// \u5EFA\u8BAE Memoizing selector\nconst fruit = useStore(useCallback((state) => state.fruits[id], [id]));\n// \u76F4\u63A5\u8BBF\u95EE\nuseStore.getState().count;\n// \u76F4\u63A5\u8BBE\u7F6E\nuseStore.setState({ paw: false });\n// \u8BA2\u9605 - \u53EF\u9650\u5B9A\u53D8\u5316\u8303\u56F4\u548C\u6BD4\u8F83\u65B9\u5F0F\nuseStore.subscribe(console.log, (state) => [state.paw, state.fur], shallow);\n// \u6E05\u9664\u6240\u6709 listener\nuseStore.destroy();\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"import create from 'zustand';\nconst useStore = create((set) => ({\n  count: 0,\n  reset: () => set({ count: 0 }),\n}));\n\n// shallow compare\nimport shallow from 'zustand/shallow';\nconst { count } = useStore(({ count }) => ({ count }), shallow);\n// useCallback \u53EF\u907F\u514D\u6BCF\u6B21 render \u90FD\u8BA1\u7B97\nconst count = useStore(useCallback((state) => state.count, []));\n// \u5B9A\u4E49\u5728\u7EC4\u5EFA\u4E4B\u5916\u4E5F\u53EF\u4EE5\u907F\u514D\nconst selectCount = (state) => state.count;\nconst Counter: React.FC = () => {\n  const count = useStore(selectCount);\n  return <div>{count}</div>;\n};\n\n// vanilla \u53EF\u5728 react \u4E4B\u5916\u4F7F\u7528\nimport createVanilla from 'zustand/vanilla';\nconst store = createVanilla(() => ({}));\nconst { getState, setState, subscribe, destroy } = store;\n\n// \u652F\u6301\u8BA2\u9605 - \u4E4B\u524D\u662F\u5185\u7F6E\u7684\nimport { subscribeWithSelector } from 'zustand/middleware';\nconst useStore = create(subscribeWithSelector(() => ({ count: 0 })));\nconst unsub = useStore.subscribe((state) => state.count, console.log);\n\n// log to redux devtool\nimport { devtools } from 'zustand/middleware';\nconst useStore = create(devtools(store));\n\n// \u4E0A\u4E0B\u6587\u6A21\u5F0F\nimport createContext from 'zustand/context';\n// \u53EF\u4EE5\u5728\u7EC4\u5EFA\u5185 \u521D\u59CB\u5316\n// \u53EF\u4EE5\u63D0\u4F9B\u591A\u4E2A context\ninterface DemoState {}\nconst { Provider, useStore, useStoreApi } = createContext<DemoState>();\nconst createStore = () => create((set, get, api) => ({}));\nconst Demo = ({ children }) => {\n  return <Provider createStore={createStore}>{children}</Provider>;\n};\n"})}),"\n",(0,r.jsx)(t.h2,{id:"\u5728\u5916\u90E8\u89E6\u53D1\u72B6\u6001",children:"\u5728\u5916\u90E8\u89E6\u53D1\u72B6\u6001"}),"\n",(0,r.jsx)(t.p,{children:"\u56E0\u4E3A react \u662F\u540C\u6B65\u5904\u7406 setState\uFF0C\u56E0\u6B64\u5EFA\u8BAE\u5305\u88C5\u5728 batchedUpdates \u5904\u7406\u3002"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"import { unstable_batchedUpdates } from 'react-dom'; // or 'react-native'\n\nconst useStore = create((set) => ({\n  fishes: 0,\n  increaseFishes: () => set((prev) => ({ fishes: prev.fishes + 1 })),\n}));\n\nconst nonReactCallback = () => {\n  unstable_batchedUpdates(() => {\n    useStore.getState().increaseFishes();\n  });\n};\n"})}),"\n",(0,r.jsx)(t.h2,{id:"\u901A\u8FC7\u5F15\u7528\u65B9\u5F0F\u4F18\u5316\u5FEB\u901F\u53D8\u5316\u7684\u72B6\u6001",children:"\u901A\u8FC7\u5F15\u7528\u65B9\u5F0F\u4F18\u5316\u5FEB\u901F\u53D8\u5316\u7684\u72B6\u6001"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u4E0D\u76F4\u63A5 useStore - \u907F\u514D rerender"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"const useStore = create((set) => ({ scratches: 0 }));\n\nfunction Component() {\n  // \u521D\u59CB\u72B6\u6001\n  const scratchRef = useRef(useStore.getState().scratches);\n  // \u5C06\u53D8\u5316\u6355\u83B7\u5230\u5F15\u7528 - \u6216\u76F4\u63A5\u8C03\u7528\u5916\u90E8 set\n  useEffect(\n    () =>\n      useStore.subscribe(\n        (scratches) => (scratchRef.current = scratches),\n        (state) => state.scratches,\n      ),\n    [],\n  );\n  return;\n}\n"})}),"\n",(0,r.jsx)(t.h2,{id:"the-result-of-getsnapshot-should-be-cached-to-avoid-an-infinite-loop-error-component-stack",children:"The result of getSnapshot should be cached to avoid an infinite loop Error Component Stack"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u5347\u7EA7 zustand v5 \u51FA\u73B0"}),"\n",(0,r.jsx)(t.li,{children:"\u4F7F\u7528 useShallow \u786E\u4FDD\u8FD4\u56DE\u540C\u6837\u5185\u5BB9"}),"\n",(0,r.jsxs)(t.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/discussions/1936",children:"https://github.com/pmndrs/zustand/discussions/1936"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.h1,{id:"version",children:"version"}),"\n",(0,r.jsx)(t.h2,{id:"zustand-v4",children:"Zustand v4"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"import { createWithEqualityFn } from 'zustand/traditional'\nconst useFooStore = createWithEqualityFn(..., Object.is)\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"useStoreWithEqualityFn"}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/discussions/1937",children:"https://github.com/pmndrs/zustand/discussions/1937"})}),"\n"]})]})}function u(e={}){let{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},17776:function(e,t,n){n.d(t,{R:()=>c,x:()=>a});var s=n(7378);let r={},o=s.createContext(r);function c(e){let t=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);