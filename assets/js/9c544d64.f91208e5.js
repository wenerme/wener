"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["82159"],{52405:function(e,l,n){n.r(l),n.d(l,{frontMatter:()=>a,toc:()=>t,default:()=>g,metadata:()=>s,assets:()=>d,contentTitle:()=>r});var s=JSON.parse('{"id":"dev/build/bazel/bazel-go","title":"Brazel Go","description":"Brazel Go","source":"@site/../notes/dev/build/bazel/bazel-go.md","sourceDirName":"dev/build/bazel","slug":"/dev/build/bazel/go","permalink":"/notes/dev/build/bazel/go","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/build/bazel/bazel-go.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1731048203000,"frontMatter":{"title":"Brazel Go"},"sidebar":"docs","previous":{"title":"Bazel FAQ","permalink":"/notes/dev/build/bazel/faq"},"next":{"title":"Bazel Java","permalink":"/notes/dev/build/bazel/java"}}'),o=n(86106),i=n(17776);let a={title:"Brazel Go"},r,d={},t=[{value:"Brazel Go",id:"brazel-go",level:2},{value:"cross compile",id:"cross-compile",level:3},{value:"go_repository does not support file path replacements",id:"go_repository-does-not-support-file-path-replacements",level:2},{value:"rules_go",id:"rules_go",level:2},{value:"gazelle",id:"gazelle",level:2},{value:"go_sdk",id:"go_sdk",level:2},{value:"found but does not contain package",id:"found-but-does-not-contain-package",level:2},{value:"is not visible from target",id:"is-not-visible-from-target",level:2},{value:"\u7F13\u5B58\u76F8\u5173\u95EE\u9898",id:"\u7F13\u5B58\u76F8\u5173\u95EE\u9898",level:2},{value:"go: cannot find GOROOT directory: /usr/local/go",id:"go-cannot-find-goroot-directory-usrlocalgo",level:2}];function c(e){let l={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.h2,{id:"brazel-go",children:"Brazel Go"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:[(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle",children:"bazelbuild/bazel-gazelle"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u4E3A go \u548C protobuf \u751F\u6210 BUILD"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.li,{children:"deps.bzl"}),"\n",(0,o.jsxs)(l.li,{children:["\u53C2\u8003\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://www.tweag.io/blog/2021-09-08-rules_go-gazelle/",children:"BUILDING A GO PROJECT USING BAZEL"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.admonition,{type:"tip",children:(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u9ED8\u8BA4\u5F00\u542F trimpath"}),"\n",(0,o.jsx)(l.li,{children:"\u6682\u4E0D\u652F\u6301 coverage"}),"\n"]})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"# cross compile no cgo\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd\n# cross compile with cgo\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64_cgo //cmd\n"})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",children:'workspace(name = "my_project")\n\nload("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")\n\nhttp_archive(\n    name = "io_bazel_rules_go",\n    sha256 = "2b1641428dff9018f9e85c0384f03ec6c10660d935b750e3fa1492a281a53b0f",\n    urls = [\n        "https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip",\n        "https://github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip",\n    ],\n)\n\nhttp_archive(\n    name = "bazel_gazelle",\n    sha256 = "de69a09dc70417580aabf20a28619bb3ef60d038470c7cf8442fafcf627c21cb",\n    urls = [\n        "https://mirror.bazel.build/github.com/bazelbuild/bazel-gazelle/releases/download/v0.24.0/bazel-gazelle-v0.24.0.tar.gz",\n        "https://github.com/bazelbuild/bazel-gazelle/releases/download/v0.24.0/bazel-gazelle-v0.24.0.tar.gz",\n    ],\n)\n\nload("@io_bazel_rules_go//go:deps.bzl", "go_register_toolchains", "go_rules_dependencies")\nload("@bazel_gazelle//:deps.bzl", "gazelle_dependencies", "go_repository")\n\n#\ngo_rules_dependencies()\ngo_register_toolchains(version = "1.17.2")\ngazelle_dependencies()\n'})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",metastring:'title="BUILD"',children:'load("@bazel_gazelle//:def.bzl", "gazelle")\n\n# gazelle:prefix wener.me/wode/core\ngazelle(name = "gazelle")\n\ngazelle(\n    name = "gazelle-update-repos",\n    args = [\n        "-from_file=go.mod",\n        "-to_macro=deps.bzl%go_dependencies",\n        "-prune",\n        "-build_file_proto_mode=disable_global",\n    ],\n    command = "update-repos",\n)\n'})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"bazel run //:gazelle\n\nbazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=deps.bzl%go_dependencies\nbazel run //:gazelle-update-repos\n"})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"go get github.com/bazelbuild/bazel-gazelle/cmd/gazelle\ngazelle -go_prefix github.com/example/project\n"})}),"\n",(0,o.jsx)(l.h3,{id:"cross-compile",children:"cross compile"}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",children:'go_library(\n    name = "foo",\n    srcs = [\n        "foo_linux.go",\n        "foo_windows.go",\n    ],\n    deps = select({\n        "@io_bazel_rules_go//go/platform:linux_amd64": [\n            "//bar_linux",\n        ],\n        "@io_bazel_rules_go//go/platform:windows_amd64": [\n            "//bar_windows",\n        ],\n        "//conditions:default": [],\n    }),\n)\n'})}),"\n",(0,o.jsx)(l.h2,{id:"go_repository-does-not-support-file-path-replacements",children:"go_repository does not support file path replacements"}),"\n",(0,o.jsx)(l.h2,{id:"rules_go",children:"rules_go"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/rules_go",children:"bazelbuild/rules_go"})}),"\n",(0,o.jsxs)(l.li,{children:[(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/rules_go/blob/master/go/modes.rst#mode-attributes",children:"Build modes"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"static, race, msan, pure, strip, debug, gotags, linkmode"}),"\n",(0,o.jsxs)(l.li,{children:["\u547D\u4EE4\u884C ",(0,o.jsx)(l.code,{children:"--@io_bazel_rules_go//go/config:<mode>"})]}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.code,{children:'go_binary(<mode> = "")'})}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(l.li,{children:["toolchain\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"go_register_toolchains -> @go_sdk -> go_download_sdk"}),"\n",(0,o.jsx)(l.li,{children:"go_download_sdk - \u4E0B\u8F7D"}),"\n",(0,o.jsx)(l.li,{children:"go_local_sdk - \u6307\u5B9A\u672C\u5730 PATH"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(l.li,{children:["go_binary\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["out - \u8F93\u51FA\u540D\u5B57\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u9ED8\u8BA4\u5982\u679C name \u548C dir \u540D\u5B57\u76F8\u540C\uFF0C\u5219\u4F1A\u6DFB\u52A0\u4E0B\u5212\u7EBF"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",children:'load("@io_bazel_rules_go//go:deps.bzl", "go_rules_dependencies", "go_register_toolchains")\n\ngo_rules_dependencies()\n\ngo_register_toolchains(version = "1.15.5")\n# \u4F7F\u7528 host \u7684 go \u7248\u672C - \u7F16\u8BD1\u4E0D\u4E00\u5B9A\u53EF\u91CD\u73B0\n# \u4F46\u66F4\u5FEB\uFF0C\u5C11\u4E86\u4E0B\u8F7D\u5B89\u88C5\u8FC7\u7A0B\ngo_register_toolchains(version = "host")\n'})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"# \u4EA4\u53C9\u7F16\u8BD1\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd\n# with CGO\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64_cgo //cmd\n"})}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u4E5F\u53EF\u4EE5\u5728 go_binary \u8BBE\u7F6E goos \u548C goarch"}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"gazelle",children:"gazelle"}),"\n",(0,o.jsx)(l.admonition,{type:"caution",children:(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["\u9ED8\u8BA4\u8981\u6C42 proto \u5305\u540D\u5339\u914D\u76EE\u5F55 \u540D\u5B57 - ",(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/271",children:"#271"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.code,{children:'go_repository(build_file_proto_mode = "disable_global",)'})}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"# \u547D\u4EE4\u884C\u751F\u6210\ngazelle -go_prefix go-micro.dev/v4 -proto disable\n\ngazelle update\n"})}),"\n",(0,o.jsx)(l.h2,{id:"go_sdk",children:"go_sdk"}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:'# Host\ngo_host_sdk(name="go_sdk")\n# Local\ngo_local_sdk(\n    name = "go_sdk",\n    path = "/Users/wener/sdk/go1.18beta1",\n)\ngo_register_toolchains()\n\n# Download\ngo_register_toolchains(version = "1.17.6")\n# Host\ngo_register_toolchains(version = "host")\n'})}),"\n",(0,o.jsx)(l.h2,{id:"found-but-does-not-contain-package",children:"found but does not contain package"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/953",children:"https://github.com/bazelbuild/bazel-gazelle/issues/953"})}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"is-not-visible-from-target",children:"is not visible from target"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/1117",children:"https://github.com/bazelbuild/bazel-gazelle/issues/1117"})}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"\u7F13\u5B58\u76F8\u5173\u95EE\u9898",children:"\u7F13\u5B58\u76F8\u5173\u95EE\u9898"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["GO_REPOSITORY_USE_HOST_CACHE\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["\u4F7F\u7528 ",(0,o.jsx)(l.code,{children:"go env GOPATH"})," \u800C\u4E0D\u662F\u4F7F\u7528 bazel \u7F13\u5B58"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/701",children:"https://github.com/bazelbuild/bazel-gazelle/issues/701"})}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/549",children:"https://github.com/bazelbuild/bazel-gazelle/issues/549"})}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/543",children:"https://github.com/bazelbuild/bazel-gazelle/issues/543"})}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"go-cannot-find-goroot-directory-usrlocalgo",children:"go: cannot find GOROOT directory: /usr/local/go"}),"\n",(0,o.jsx)(l.p,{children:"/usr/lib/go"})]})}function g(e={}){let{wrapper:l}={...(0,i.R)(),...e.components};return l?(0,o.jsx)(l,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},17776:function(e,l,n){n.d(l,{R:()=>a,x:()=>r});var s=n(7378);let o={},i=s.createContext(o);function a(e){let l=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(l):{...l,...e}},[l,e])}function r(e){let l;return l=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:l},e.children)}}}]);