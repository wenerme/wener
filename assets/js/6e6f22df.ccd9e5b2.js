"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["96579"],{45105:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>l,toc:()=>c,default:()=>x,metadata:()=>t,assets:()=>d,contentTitle:()=>h});var t=JSON.parse('{"id":"web/framework/nextjs/next-auth","title":"NextAuth","description":"- nextauthjs/next-auth","source":"@site/../notes/web/framework/nextjs/next-auth.md","sourceDirName":"web/framework/nextjs","slug":"/web/framework/nextjs/next-auth","permalink":"/notes/web/framework/nextjs/next-auth","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/web/framework/nextjs/next-auth.md","tags":[{"inline":true,"label":"Auth","permalink":"/notes/tags/auth"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1753172183000,"frontMatter":{"title":"NextAuth","tags":["Auth"]},"sidebar":"docs","previous":{"title":"NextJS","permalink":"/notes/web/framework/nextjs/"},"next":{"title":"App Layout","permalink":"/notes/web/framework/nextjs/app"}}'),i=s(86106),r=s(17776);let l={title:"NextAuth",tags:["Auth"]},h="NextAuth",d={},c=[{value:"\u6570\u636E\u6A21\u578B",id:"models",level:2},{value:"REST API",id:"rest-api",level:2},{value:"\u5237\u65B0 JWT",id:"\u5237\u65B0-jwt",level:2},{value:"CORS",id:"cors",level:2},{value:"\u4E0D\u80FD\u83B7\u53D6 Cookie",id:"\u4E0D\u80FD\u83B7\u53D6-cookie",level:2}];function a(n){let e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"nextauth",children:"NextAuth"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth",children:"nextauthjs/next-auth"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"ISC, TS"}),"\n",(0,i.jsx)(e.li,{children:"NextAuth -> Auth.js"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u56DE\u8C03 ",(0,i.jsx)(e.code,{children:"/api/auth/callback/<NAME>"})]}),"\n",(0,i.jsxs)(e.li,{children:["Provider\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Gitlab\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u56DE\u8C03\u8981\u5B8C\u6574\uFF0C127.0.0.1 \u8981\u989D\u5916\u52A0"}),"\n",(0,i.jsx)(e.li,{children:"\u53EF\u4EE5\u914D\u7F6E\u591A\u4E2A\u56DE\u8C03"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["Github\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u56DE\u8C03\u914D\u524D\u7F00\uFF0C\u9ED8\u8BA4\u652F\u6301 127.0.0.1"}),"\n",(0,i.jsxs)(e.li,{children:["\u53EA\u80FD\u914D\u7F6E",(0,i.jsx)(e.strong,{children:"\u4E00\u4E2A"}),"\u56DE\u8C03"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.admonition,{type:"caution",children:(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["credentials \u53EA\u652F\u6301 JWT \u4E0D\u80FD\u6301\u4E45\u5316 session token\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://next-auth.js.org/providers/credentials",children:"https://next-auth.js.org/providers/credentials"})}),"\n"]}),"\n"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"env"}),(0,i.jsx)(e.th,{children:"for"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"NEXTAUTH_URL"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"NEXTAUTH_SECRET"}),(0,i.jsx)(e.td,{children:"\u751F\u4EA7\u73AF\u5883\u5FC5\u987B"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"NEXTAUTH_URL_INTERNAL"}),(0,i.jsx)(e.td,{children:"\u9ED8\u8BA4 NEXTAUTH_URL"})]})]})]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["AUTH_TRUST_HOST || VERCEL\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7528\u4E8E detectHost"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.admonition,{type:"caution",children:(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/issues/6710",children:"#6710"}),"\nrefresh token rotation doesn't update client session\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://next-auth.js.org/getting-started/client#updating-the-session",children:"https://next-auth.js.org/getting-started/client#updating-the-session"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/discussions/4229",children:"https://github.com/nextauthjs/next-auth/discussions/4229"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/discussions/1702",children:"#1702"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"one user, multiple account providers"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ts",children:"// \u5185\u90E8\u5168\u5C40\u4E0A\u4E0B\u6587\nconst __NEXTAUTH: NextAuthClientConfig = {\n  baseUrl: parseUrl(process.env.NEXTAUTH_URL ?? process.env.VERCEL_URL).origin,\n  basePath: parseUrl(process.env.NEXTAUTH_URL).path,\n  baseUrlServer: parseUrl(process.env.NEXTAUTH_URL_INTERNAL ?? process.env.NEXTAUTH_URL ?? process.env.VERCEL_URL)\n    .origin,\n  basePathServer: parseUrl(process.env.NEXTAUTH_URL_INTERNAL ?? process.env.NEXTAUTH_URL).path,\n  _lastSync: 0,\n  _session: undefined,\n  _getSession: () => {},\n};\n\n// profile \u8F6C account \u903B\u8F91\nconst getProfile = {\n  profile,\n  account: {\n    provider: provider.id,\n    type: provider.type,\n    providerAccountId: profile.id.toString(),\n    ...tokens,\n  },\n  OAuthProfile: profile,\n};\n\nexport const defaultCallbacks: CallbacksOptions = {\n  signIn() {\n    // \u662F\u5426\u5141\u8BB8\u767B\u5F55\n    // \u53EF\u4EE5\u8FD4\u56DE \u5B57\u7B26\u4E32\u505A redirect\n    return true;\n  },\n  redirect({ url, baseUrl }) {\n    if (url.startsWith('/')) return `${baseUrl}${url}`;\n    else if (new URL(url).origin === baseUrl) return url;\n    return baseUrl;\n  },\n  session({ session }) {\n    return session;\n  },\n  // jwt session\n  jwt({ token }) {\n    return token;\n  },\n};\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["callbacks - ",(0,i.jsx)(e.a,{href:"https://next-auth.js.org/configuration/callbacks",children:"https://next-auth.js.org/configuration/callbacks"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"signIn - \u53EF\u4EE5\u62D2\u7EDD\u7528\u6237\u767B\u5F55"}),"\n",(0,i.jsx)(e.li,{children:"redirect - \u6784\u9020\u8DF3\u8F6C URL"}),"\n",(0,i.jsxs)(e.li,{children:["jwt\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u89E6\u53D1 ",(0,i.jsx)(e.code,{children:"/api/auth/signin"}),", ",(0,i.jsx)(e.code,{children:"/api/auth/session"}),", ",(0,i.jsx)(e.code,{children:"getSession()"}),", ",(0,i.jsx)(e.code,{children:"getServerSession()"}),", ",(0,i.jsx)(e.code,{children:"useSession()"})]}),"\n",(0,i.jsx)(e.li,{children:"\u7B2C\u4E00\u6B21\u521B\u5EFA\u65F6\u6709\u7684\u53C2\u6570 user, account, profile, isNewUser"}),"\n",(0,i.jsx)(e.li,{children:"\u4E4B\u540E\u90FD\u53EA\u6709 token"}),"\n",(0,i.jsx)(e.li,{children:"token \u57FA\u7840\u5C5E\u6027 - name, email, sub, iat, exp, jti"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["session\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u89E6\u53D1 ",(0,i.jsx)(e.code,{children:"getSession()"}),", ",(0,i.jsx)(e.code,{children:"useSession()"}),", ",(0,i.jsx)(e.code,{children:"/api/auth/session"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["tokens:TokenSet\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5305\u542B access_token"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["createState - state\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"maxAge: 900 - 15m"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"\u4F1A\u5728 sessionMaxAge \u66F4\u65B0 session \u6709\u6548\u671F"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ts",children:"import { generators } from 'openid-client';\n// \u751F\u6210 state\nconst state = generators.state();\n"})}),"\n",(0,i.jsx)(e.h2,{id:"models",children:"\u6570\u636E\u6A21\u578B"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"User -1-*-> Account"}),"\n",(0,i.jsx)(e.li,{children:"User -1-*-> Session"}),"\n",(0,i.jsx)(e.li,{children:"VerificationToken"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Adapter"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u767B\u5F55\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"createUser"}),"\n",(0,i.jsx)(e.li,{children:"getUser"}),"\n",(0,i.jsx)(e.li,{children:"getUserByEmail"}),"\n",(0,i.jsx)(e.li,{children:"getUserByAccount"}),"\n",(0,i.jsx)(e.li,{children:"linkAccount"}),"\n",(0,i.jsx)(e.li,{children:"createSession"}),"\n",(0,i.jsx)(e.li,{children:"getSessionAndUser"}),"\n",(0,i.jsx)(e.li,{children:"updateSession"}),"\n",(0,i.jsx)(e.li,{children:"deleteSession"}),"\n",(0,i.jsx)(e.li,{children:"updateUser"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u90AE\u7BB1/\u65E0\u5BC6\u7801\u767B\u5F55\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"createVerificationToken"}),"\n",(0,i.jsx)(e.li,{children:"useVerificationToken"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u76EE\u524D\u6CA1\u7528\u5230\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"deleteUser"}),"\n",(0,i.jsx)(e.li,{children:"unlinkAccount"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://next-auth.js.org/adapters/models",children:"https://next-auth.js.org/adapters/models"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"rest-api",children:"REST API"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"method"}),(0,i.jsx)(e.th,{children:"url"}),(0,i.jsx)(e.th,{children:"note"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GET"}),(0,i.jsx)(e.td,{children:"/api/auth/signin"}),(0,i.jsx)(e.td,{children:"\u5185\u7F6E\u767B\u5F55\u9875"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GET"}),(0,i.jsx)(e.td,{children:"/api/auth/signout"}),(0,i.jsx)(e.td,{children:"\u5185\u7F6E\u767B\u51FA\u9875"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"POST"}),(0,i.jsx)(e.td,{children:"/api/auth/signout"}),(0,i.jsx)(e.td,{children:"\u9000\u51FA\u767B\u5F55 - CSRF"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GET"}),(0,i.jsx)(e.td,{children:"/api/auth/csrf"}),(0,i.jsx)(e.td,{children:"\u83B7\u53D6 CSRF"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GET"}),(0,i.jsx)(e.td,{children:"/api/auth/session"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GET"}),(0,i.jsx)(e.td,{children:"/api/auth/providers"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"POST"}),(0,i.jsx)(e.td,{children:"/api/auth/signin/:provider"}),(0,i.jsx)(e.td,{children:"\u5F00\u59CB\u767B\u5F55\u6D41\u7A0B"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GET"}),(0,i.jsx)(e.td,{children:"/api/auth/callback/:provider"}),(0,i.jsx)(e.td,{children:"OAuth \u56DE\u8C03"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"POST"}),(0,i.jsx)(e.td,{children:"/api/auth/callback/:provider"}),(0,i.jsx)(e.td,{children:"\u8D26\u53F7\u5BC6\u7801\u767B\u5F55 - CSRF"})]})]})]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://next-auth.js.org/getting-started/rest-api",children:"https://next-auth.js.org/getting-started/rest-api"})}),"\n"]}),"\n",(0,i.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(e.h2,{id:"\u5237\u65B0-jwt",children:"\u5237\u65B0 JWT"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u901A\u8FC7\u81EA\u5B9A\u4E49 SignIn \u6765\u5237\u65B0"}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/discussions/4229",children:"#4229"}),"\nHow to manually trigger next-auth to refresh the JWT?"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"cors",children:"CORS"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/issues/4327#issuecomment-1090389591",children:"https://github.com/nextauthjs/next-auth/issues/4327#issuecomment-1090389591"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u4E0D\u80FD\u83B7\u53D6-cookie",children:"\u4E0D\u80FD\u83B7\u53D6 Cookie"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"HTTP Only"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:"function getCookie(name) {\n  const value = `; ${document.cookie}`;\n  const parts = value.split(`; ${name}=`);\n  if (parts.length === 2) return parts.pop().split(';').shift();\n}\ngetCookie('next-auth.session-token');\n"})})]})}function x(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(a,{...n})}):a(n)}},17776:function(n,e,s){s.d(e,{R:()=>l,x:()=>h});var t=s(7378);let i={},r=t.createContext(i);function l(n){let e=t.useContext(r);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function h(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),t.createElement(r.Provider,{value:e},n.children)}}}]);