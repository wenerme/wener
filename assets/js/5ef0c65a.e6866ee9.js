"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["34291"],{78335:function(n,e,t){t.r(e),t.d(e,{frontMatter:()=>l,toc:()=>d,default:()=>T,metadata:()=>i,assets:()=>a,contentTitle:()=>o});var i=JSON.parse('{"id":"db/relational/postgresql/postgresql-partition","title":"Table Partitioning","description":"- \u67E5\u8BE2\u6027\u80FD\u63D0\u5347","source":"@site/../notes/db/relational/postgresql/postgresql-partition.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/partition","permalink":"/notes/db/relational/postgresql/partition","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-partition.md","tags":[{"inline":true,"label":"Scale","permalink":"/notes/tags/scale"},{"inline":true,"label":"Partition","permalink":"/notes/tags/partition"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1715155165000,"frontMatter":{"tags":["Scale","Partition"]},"sidebar":"docs","previous":{"title":"PostgreSQL \u8FD0\u7EF4","permalink":"/notes/db/relational/postgresql/ops"},"next":{"title":"PostgreSQL PL","permalink":"/notes/db/relational/postgresql/pl"}}'),s=t(86106),r=t(17776);let l={tags:["Scale","Partition"]},o="Table Partitioning",a={},d=[];function c(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"table-partitioning",children:"Table Partitioning"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u67E5\u8BE2\u6027\u80FD\u63D0\u5347\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5F53\u4E3B\u8981\u67E5\u8BE2\u7684\u6570\u636E\u90FD\u5728\u4E00\u4E2A\u5206\u7247\u91CC\u65F6\uFF0C\u7D22\u5F15\u52A0\u8F7D\u5230\u5185\u5B58\u4F7F\u7528\u7387\u66F4\u9AD8"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u5F53\u66F4\u65B0\u548C\u67E5\u8BE2\u5355\u4E2A\u5206\u7247\u65F6\u6027\u80FD\u63D0\u5347\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6B64\u65F6\u53EF\u80FD\u901A\u8FC7 seq scan \u800C\u4E0D\u9700\u8981\u4F7F\u7528\u7D22\u5F15\uFF0C\u5BFC\u81F4\u968F\u673A\u8BBF\u95EE"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u901A\u8FC7\u64CD\u4F5C\u5206\u7247\u8868\u6765\u6279\u91CF\u64CD\u4F5C\u6570\u636E\uFF0C\u6027\u80FD\u5927\u5E45\u5EA6\u63D0\u9AD8"}),"\n",(0,s.jsx)(e.li,{children:"\u8F83\u5C11\u4F7F\u7528\u7684\u5206\u7247\u53EF\u79FB\u5230\u66F4\u4FBF\u5B9C\u7684\u5B58\u50A8\u4E0A"}),"\n"]}),"\n",(0,s.jsxs)(e.blockquote,{children:["\n",(0,s.jsx)(e.p,{children:"\u5F53\u5355\u8868\u5927\u5C0F\u8D85\u8FC7\u7269\u7406\u5185\u5B58\u65F6\uFF0C\u5EFA\u8BAE\u5206\u8868"}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"tip",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u5206\u8868\u7D22\u5F15\u4E0D\u53EF\u4EE5 CONCURRENTLY\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u9664\u975E\u5148 DETACH"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u5206\u8868\u53EF\u4EE5\u521B\u5EFA CREATE INDEX ON ONLY\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u521B\u5EFA\u540E\u7D22\u5F15\u662F\u65E0\u6548\u7684"}),"\n",(0,s.jsx)(e.li,{children:"\u5728\u5355\u72EC\u5206\u7247\u4E0A\u521B\u5EFA\u7136\u540E ATTACH"}),"\n",(0,s.jsx)(e.li,{children:"\u53EF\u4EE5\u4F7F\u7528\u8BE5\u65B9\u5F0F\u6765\u521B\u5EFA UNIQUE \u548C PRIMARY KEY"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u6709\u65F6\u5019\u8868\u7EE7\u627F\u6BD4\u5206\u7247\u66F4\u597D\u7528"}),"\n"]})}),"\n",(0,s.jsx)(e.admonition,{type:"caution",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u552F\u4E00 \u9650\u5236\u5FC5\u987B\u5305\u542B\u6240\u6709 partition key columns"}),"\n",(0,s.jsxs)(e.li,{children:["\u4E0D\u80FD\u521B\u5EFA\u8DE8\u8868 exclusion constraint\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4E0D\u652F\u6301\u8DE8\u5206\u7247\u9650\u5236"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u9488\u5BF9 INSERT \u7684 BEFORE ROW \u89E6\u53D1\u5668\u65E0\u6CD5\u66F4\u6539\u5206\u7247"}),"\n",(0,s.jsx)(e.li,{children:"\u4E34\u65F6\u8868\u548C\u6301\u4E45\u8868\u4E0D\u53EF\u4EE5\u6DF7\u7528"}),"\n"]})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.enterprisedb.com/blog/postgres-table-partitioning",children:"https://www.enterprisedb.com/blog/postgres-table-partitioning"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/ddl-partitioning.html",children:"https://www.postgresql.org/docs/current/ddl-partitioning.html"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5206\u8868\u7B56\u7565"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8303\u56F4 - \u4F8B\u5982 \u65F6\u95F4\u5B57\u6BB5"}),"\n",(0,s.jsx)(e.li,{children:"\u5217\u8868 - \u4F8B\u5982 \u5E74\u5B57\u6BB5"}),"\n",(0,s.jsx)(e.li,{children:"\u54C8\u5E0C - \u4F8B\u5982 UUID \u5B57\u6BB5"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5E38\u89C1\u7B56\u7565"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u57FA\u4E8E\u4F7F\u7528\u573A\u666F\u7684\u51B7\u70ED\u6570\u636E\u533A\u5206 - \u4F8B\u5982 \u6700\u8FD1\u4E00\u5468\u6570\u636E\u5355\u72EC\u8868"}),"\n",(0,s.jsx)(e.li,{children:"\u57FA\u4E8E\u6570\u636E\u672C\u8EAB\u7684\u903B\u8F91\u7ED3\u6784\u533A\u5206 - \u4F8B\u5982 \u533A\u57DF\u3001\u5E74\u4EFD"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:"-- RANGE \u5206\u7247\n-- \u521B\u5EFA\u865A\u62DF\u8868\nCREATE TABLE measurement (\n    city_id         int not null,\n    logdate         date not null,\n    peaktemp        int,\n    unitsales       int\n) PARTITION BY RANGE (logdate);\n\n-- LIST \u5206\u7247\nCREATE TABLE cities (\n    city_id      bigserial not null,\n    name         text not null,\n    population   bigint\n) PARTITION BY LIST (left(lower(name), 1));\n-- LIST \u5B50\u8868\nCREATE TABLE cities_ab\n    PARTITION OF cities (\n    CONSTRAINT city_id_nonzero CHECK (city_id != 0)\n) FOR VALUES IN ('a', 'b');\n-- \u9ED8\u8BA4\u5206\u7247\nCREATE TABLE cities_partdef\n    PARTITION OF cities DEFAULT;\n\n-- HASH \u5206\u7247\nCREATE TABLE orders (\n    order_id     bigint not null,\n    cust_id      bigint not null,\n    status       text\n) PARTITION BY HASH (order_id);\n-- HASH \u5B50\u8868\nCREATE TABLE orders_p1 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 0);\nCREATE TABLE orders_p2 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 1);\nCREATE TABLE orders_p3 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 2);\nCREATE TABLE orders_p4 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 3);\n\n-- \u53EF\u76F4\u63A5\u521B\u5EFA\u7D22\u5F15 - \u5F53\u589E\u52A0\u5206\u7247\u65F6\u4F1A\u5BF9\u5206\u7247\u52A0\u7D22\u5F15\nCREATE INDEX ON measurement (logdate);\n\nCREATE TABLE measurement_y2006m02 PARTITION OF measurement\n    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01');\n-- \u53EF\u4FEE\u6539 TABLESPACE \u9009\u62E9\u4E0D\u540C\u5B58\u50A8\u4ECB\u8D28\nCREATE TABLE measurement_y2006m03 PARTITION OF measurement\n    FOR VALUES FROM ('2006-03-01') TO ('2006-04-01')\n    TABLESPACE fasttablespace;;\n\n-- \u5206\u7247\u8868\u53EF\u4EE5\u518D\u5206\u7247\nCREATE TABLE measurement_y2006m02 PARTITION OF measurement\n    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01')\n    PARTITION BY RANGE (peaktemp);\n\n-- \u53D6\u4FDD\u5F00\u542F\u5206\u7247\u88C1\u526A\u914D\u7F6E - \u9ED8\u8BA4\u5F00\u542F\nselect * from pg_settings where name='enable_partition_pruning';\n\n-- \u53EF\u4EE5\u76F4\u63A5\u5220\u9664\u5206\u7247\u8868 - \u4F1A\u9501\u4E3B\u8868\nDROP TABLE measurement_y2006m02;\n-- \u53EF\u4EE5\u6392\u9664\u5206\u7247\nALTER TABLE measurement DETACH PARTITION measurement_y2006m02;\n\n\n-- \u5355\u72EC\u521B\u5EFA\u5206\u7247\uFF0C\u6DFB\u52A0\u6821\u9A8C\uFF0C\u5BFC\u5165\u6570\u636E\uFF0C\u52A0\u5165\u5230\u5206\u7247\nCREATE TABLE measurement_y2008m02\n  (LIKE measurement INCLUDING DEFAULTS INCLUDING CONSTRAINTS)\n  TABLESPACE fasttablespace;\n-- \u63D0\u524D\u521B\u5EFA\u597D CONSTRAINT - \u5426\u5219 ATTACH \u65F6\u8FD8\u662F\u4F1A\u521B\u5EFA\u4E14\u9700\u8981 ACCESS EXCLUSIVE\nALTER TABLE measurement_y2008m02 ADD CONSTRAINT y2008m02\n   CHECK ( logdate >= DATE '2008-02-01' AND logdate < DATE '2008-03-01' );\n\\copy measurement_y2008m02 from 'measurement_y2008m02'\n-- possibly some other data preparation work\n-- SHARE UPDATE EXCLUSIVE\n-- ATTACH \u540E\u53EF\u4EE5\u5220\u9664\u521B\u5EFA\u7684 CHECK\n-- \u5982\u679C\u6709 DEFAULT \u4E5F\u4F1A\u68C0\u67E5\uFF0C\u9664\u975E\u521B\u5EFA\u4E86\u6392\u9664 CHECK\nALTER TABLE measurement ATTACH PARTITION measurement_y2008m02\n    FOR VALUES FROM ('2008-02-01') TO ('2008-03-01' );\n"})})]})}function T(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(c,{...n})}):c(n)}},17776:function(n,e,t){t.d(e,{R:()=>l,x:()=>o});var i=t(7378);let s={},r=i.createContext(s);function l(n){let e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);