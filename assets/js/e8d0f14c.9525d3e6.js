"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["36337"],{58695:function(e,n,l){l.r(n),l.d(n,{frontMatter:()=>t,toc:()=>a,default:()=>o,metadata:()=>i,assets:()=>d,contentTitle:()=>c});var i=JSON.parse('{"id":"dev/build/bazel/README","title":"Bazel","description":"- bazelbuild/bazel","source":"@site/../notes/dev/build/bazel/README.md","sourceDirName":"dev/build/bazel","slug":"/dev/build/bazel/","permalink":"/notes/dev/build/bazel/","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/build/bazel/README.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1642767775000,"frontMatter":{"title":"Bazel"},"sidebar":"docs","previous":{"title":"\u6784\u5EFA","permalink":"/notes/dev/build/"},"next":{"title":"Bazel Awesome","permalink":"/notes/dev/build/bazel/awesome"}}'),s=l(86106),r=l(17776);let t={title:"Bazel"},c="Bazel",d={},a=[{value:"Starlark",id:"starlark",level:2},{value:"Notes",id:"notes",level:2},{value:"Remote Execution",id:"remote-execution",level:2},{value:"Remote Caching",id:"remote-caching",level:2},{value:"The remote downloader can only be used in combination with gRPC caching",id:"the-remote-downloader-can-only-be-used-in-combination-with-grpc-caching",level:2},{value:"Failed to query remote execution capabilities: INTERNAL: http2 exception",id:"failed-to-query-remote-execution-capabilities-internal-http2-exception",level:2},{value:".bazelrc",id:"bazelrc",level:2},{value:"Notes",id:"notes-1",level:2},{value:"query",id:"query",level:2},{value:"bzlmod",id:"bzlmod",level:2},{value:"BUILD vs BUILD.bazel",id:"build-vs-buildbazel",level:2},{value:"Fetching @local_config_xcode",id:"fetching-local_config_xcode",level:2},{value:"from google",id:"from-google",level:2},{value:"output",id:"output",level:2}];function h(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",mdxadmonitiontitle:"mdxadmonitiontitle",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"bazel",children:"Bazel"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/bazel",children:"bazelbuild/bazel"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u652F\u6301\u591A\u8BED\u8A00"}),"\n",(0,s.jsx)(n.li,{children:"\u652F\u6301\u591A\u5E73\u53F0"}),"\n",(0,s.jsx)(n.li,{children:"Starlark DSL"}),"\n",(0,s.jsx)(n.li,{children:"reproduce build"}),"\n",(0,s.jsxs)(n.li,{children:["remote cache\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"WebDAV"}),"\n",(0,s.jsx)(n.li,{children:"bazel-remote"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"remote build"}),"\n",(0,s.jsx)(n.li,{children:"\u81EA\u884C\u51C6\u5907\u73AF\u5883 - \u4E0B\u8F7D JDK\u3001\u4E0B\u8F7D Golang SDK \u7B49"}),"\n",(0,s.jsx)(n.li,{children:"\u81EA\u884C\u7EF4\u62A4\u4F9D\u8D56 - \u4E0B\u8F7D JAR\u3001\u4E0B\u8F7D go mod"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/examples",children:"bazelbuild/examples"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/google/bazel-common",children:"google/bazel-common"})}),"\n",(0,s.jsxs)(n.li,{children:["\u955C\u50CF\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://mirror.bazel.build",children:"https://mirror.bazel.build"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/rules_python/issues/400#issuecomment-776810051",children:"https://github.com/bazelbuild/rules_python/issues/400#issuecomment-776810051"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Bazel \u955C\u50CF\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://mirrors.huaweicloud.com/bazel/",children:"https://mirrors.huaweicloud.com/bazel/"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://bazel.build/users.html",children:"Users"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Abseil, TensorFlow, gRPC"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Kubernetes 1.21 \u79FB\u9664 bazel \u6784\u5EFA - ",(0,s.jsx)(n.a,{href:"https://github.com/BenTheElder/enhancements/blob/master/keps/sig-testing/2420-reducing-kubernetes-build-maintenance/README.md",children:"KEP#2420"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"go build cache \u8DB3\u591F\u4F18\u79C0"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Pants, Buck: created and developed by ex-Googlers at Twitter and Foursquare, and Facebook"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{title:"When to use Bazel",type:"tip",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u58F0\u660E\u5F0F\u6784\u5EFA"}),"\n",(0,s.jsx)(n.li,{children:"\u589E\u91CF\u7F16\u8BD1"}),"\n",(0,s.jsx)(n.li,{children:"Remote Cache \u548C Remote Execution"}),"\n",(0,s.jsx)(n.li,{children:"Reproduce \u6784\u5EFA"}),"\n",(0,s.jsx)(n.li,{children:"\u591A\u8BED\u8A00\u591A\u5E73\u53F0\u590D\u6742\u6784\u5EFA"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"\u5927\u591A\u65F6\u5019\u4E0D\u9700\u8981\u4F7F\u7528 Bazel"})}),"\n"]})}),"\n",(0,s.jsxs)(n.admonition,{type:"caution",children:[(0,s.jsxs)(n.mdxadmonitiontitle,{children:["When ",(0,s.jsx)(n.strong,{children:"not"})," to use Bazel"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6240\u6709\u88AB\u4F9D\u8D56\u7684\u5185\u5BB9\u90FD\u4F1A\u8FDB\u884C\u660E\u786E\u5B9A\u4E49 - \u76EE\u5F55\u4E0B\u5305\u542B BUILD.bazel"}),"\n",(0,s.jsxs)(n.li,{children:["\u4F9D\u8D56\u53D8\u5316\u9700\u8981\u91CD\u65B0\u751F\u6210\u5404\u79CD BUILD.bazel\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u662F\u4E00\u79CD\u5F00\u53D1\u8D1F\u62C5 - \u56E0\u6B64\u89C4\u6A21\u4E0D\u5927\u65F6\u4E0D\u5EFA\u8BAE\u4F7F\u7528 Bazel"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Bazel \u4F1A\u7EF4\u62A4\u81EA\u5DF1\u7684\u7F13\u5B58\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u4E0D\u4F1A\u4F7F\u7528 go \u7684\u5168\u5C40\u7F13\u5B58"}),"\n",(0,s.jsx)(n.li,{children:"\u4E0D\u4F1A\u4F7F\u7528 npm/yarn \u7684\u5168\u5C40\u7F13\u5B58"}),"\n",(0,s.jsx)(n.li,{children:"\u597D\u5904: Remote \u6267\u884C, \u8DE8\u4E3B\u673A\u5171\u4EAB"}),"\n",(0,s.jsx)(n.li,{children:"\u574F\u5904: \u78C1\u76D8\u7A7A\u95F4, \u7F51\u7EDC\u73AF\u5883"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Bazel \u4F1A\u7EF4\u62A4\u81EA\u5DF1\u7684\u5DE5\u5177\u94FE\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6BCF\u4E2A WORKSPACE \u90FD\u4F1A\u4E0B\u8F7D toolchain - \u4F8B\u5982 go,node"}),"\n",(0,s.jsx)(n.li,{children:"\u597D\u5904: \u786E\u4FDD\u73AF\u5883\u7248\u672C"}),"\n",(0,s.jsx)(n.li,{children:"\u574F\u5904: \u5360\u7528\u78C1\u76D8\u7A7A\u95F4, \u56FD\u5185\u73AF\u5883\u4E0B\u8F7D\u53EF\u80FD\u6709\u95EE\u9898"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Bazel \u8FD0\u884C\u73AF\u5883\u590D\u6742 - \u5982\u679C\u9700\u8981\u5206\u53D1\u7ED9\u5176\u4ED6\u4EBA\u7F16\u8F91\u6784\u5EFA\u7684\u573A\u666F\u4E0D\u5EFA\u8BAE\u4F7F\u7528\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"JDK, Python, coreutils"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Bazel \u542F\u52A8\u548C\u5206\u6790\u9700\u8981\u65F6\u95F4 - \u5982\u679C\u73B0\u884C\u6784\u5EFA\u65F6\u95F4 < 10m \u65F6\u4E0D\u5EFA\u8BAE\u4F7F\u7528"}),"\n"]})]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Bazel \u5B98\u65B9\u6784\u5EFA\u7684\u4E0D\u652F\u6301 musl"}),"\n"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'brew install bazel\n\n# \u6784\u5EFA\nbazel build //:ProjectRunner\n# \u67E5\u770B\u4F9D\u8D56\u56FE\nbazel query  --nohost_deps --noimplicit_deps "deps(//:ProjectRunner)" --output graph | dot -Tpng -o graph.png\nimgcat graph.png\n\n# \u505C\u6B62\u540E\u53F0\u670D\u52A1\nbazel shutdown\n\n# Build all\nbazel build //...\n'})}),"\n",(0,s.jsx)(n.h2,{id:"starlark",children:"Starlark"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/master/skylark/language.html",children:"https://docs.bazel.build/versions/master/skylark/language.html"})}),"\n",(0,s.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["workspace - \u5DE5\u4F5C\u7A7A\u95F4\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"WORKSPACE, WORKSPACE.bazel \u6240\u5728\u76EE\u5F55"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["repository - \u4ED3\u5E93\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"@"})," - root repository - WORKSPACE \u6240\u5728\u76EE\u5F55"]}),"\n",(0,s.jsxs)(n.li,{children:["\u53EF\u5B9A\u4E49\u5916\u90E8\u4ED3\u5E93 - ",(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/external.html",children:"external"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"bind, local_repository, new_local_repository"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["package\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"BUILD \u6240\u5728\u76EE\u5F55"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["target\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"=files+rules"}),"\n",(0,s.jsx)(n.li,{children:"files \u5206\u4E3A\u6E90\u6587\u4EF6\u548C\u751F\u6210\u6587\u4EF6"}),"\n",(0,s.jsx)(n.li,{children:"package_group"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["label - \u6807\u7B7E\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"target \u7684\u540D\u5B57\u53EB\u505A label - label \u552F\u4E00\u6807\u8BC6 target"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"@myrepo//my/app/main:app_binary"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["@myrepo// - \u4ED3\u5E93\u540D\u5B57\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u5728 repo \u5185\u53EF\u5FFD\u7565\uFF0C\u5199\u4F5C ",(0,s.jsx)(n.code,{children:"//my/app/main:app_binary"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["my/app/main - un-qualified package name - \u5305\u540D\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"+repo=fully-qualified package name"}),"\n",(0,s.jsxs)(n.li,{children:["\u5728\u5305\u5185\u53EF\u5FFD\u7565\uFF0C\u5199\u4F5C ",(0,s.jsx)(n.code,{children:":app_binary"})," \u6216 ",(0,s.jsx)(n.code,{children:"app_binary"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["app_binary - un-qualified target name\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u5982\u679C\u540D\u5B57\u4E0E\u6700\u540E\u90E8\u5206\u540D\u5B57\u76F8\u540C\uFF0C\u53EF\u5FFD\u7565\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"//my/app/lib:lib"})," = ",(0,s.jsx)(n.code,{children:"//my/app/lib"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:".bzl - extension"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/be/overview.html",children:"be"})," - Bazel BUILD Encyclopedia"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"remote-execution",children:"Remote Execution"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/master/remote-execution.html",children:"Remote Execution"})}),"\n",(0,s.jsxs)(n.li,{children:["Self Host\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/twitter/scoot",children:"twitter/scoot"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/bazel-buildfarm",children:"bazelbuild/bazel-buildfarm"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"remote-caching",children:"Remote Caching"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/master/remote-caching.html",children:"Remote Caching"})}),"\n",(0,s.jsxs)(n.li,{children:["\u5B58\u50A8\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"nginx"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/buchgr/bazel-remote/",children:"bazel-remote"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["ac.v2 cas.v2 raw.v2\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"hash, blob"}),"\n",(0,s.jsx)(n.li,{children:"cas=Content addressed storage"}),"\n",(0,s.jsx)(n.li,{children:"ac=Action cache"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"bazel \u4E0D\u8D1F\u8D23\u5220\u9664\u7F13\u5B58"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/command-line-reference.html#flag--experimental_remote_downloader",children:"--experimental_remote_downloader"})}),"\n",(0,s.jsx)(n.li,{children:"HTTP 8080"}),"\n",(0,s.jsx)(n.li,{children:"gRPC 9092"}),"\n",(0,s.jsx)(n.li,{children:"Profiling 6060"}),"\n",(0,s.jsx)(n.li,{children:"--config_file BAZEL_REMOTE_CONFIG_FILE"}),"\n",(0,s.jsx)(n.li,{children:"--experimental_remote_asset_api"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it \\\n  -u 1000 \\\n  -v $PWD/cache:/data -p 8080:8080 -p 9092:9092 \\\n  --name bazel-remote-cache buchgr/bazel-remote-cache\ncurl http://localhost:8080/status\n\nbazel build //src/main:app --remote_cache=http://localhost:9092\n# remote asset\nbazel build //src/main:app --experimental_remote_downloader=grpc://localhost:9092 --remote_cache=grpc://localhost:9092\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"remote asset is broken",type:"caution",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["not works with go-sdk ",(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/bazel/issues/13206",children:"#13206"})]}),"\n"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"build:cache --remote_download_minimal\nbuild:cache --remote_cache=http://localhost:8080\n"})}),"\n",(0,s.jsx)(n.h2,{id:"the-remote-downloader-can-only-be-used-in-combination-with-grpc-caching",children:"The remote downloader can only be used in combination with gRPC caching"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# from\nbazel build //src/main:app --experimental_remote_downloader=grpc://localhost:9090 --remote_cache=http://localhost:9090\n# to\nbazel build //src/main:app --experimental_remote_downloader=grpc://localhost:9090 --remote_cache=grpc://localhost:9090\n"})}),"\n",(0,s.jsx)(n.h2,{id:"failed-to-query-remote-execution-capabilities-internal-http2-exception",children:"Failed to query remote execution capabilities: INTERNAL: http2 exception"}),"\n",(0,s.jsx)(n.h2,{id:"bazelrc",children:".bazelrc"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:".bazelignore"}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u4E0D\u80FD\u4F7F\u7528\u4EFB\u610F\u73AF\u5883\u53D8\u91CF\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u53EF\u8003\u8651\u9884\u5148\u751F\u6210 ",(0,s.jsx)(n.a,{href:"https://github.com/stratum/stratum/pull/878/files",children:"https://github.com/stratum/stratum/pull/878/files"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["system\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"/etc/bazel.bazelrc"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"%ProgramData%\\bazel.bazelrc"})}),"\n",(0,s.jsx)(n.li,{children:"BAZEL_SYSTEM_BAZELRC_PATH"}),"\n",(0,s.jsx)(n.li,{children:"--nosystem_rc"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["workspace\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:".bazelrc"}),"\n",(0,s.jsx)(n.li,{children:"--noworkspace_rc"}),"\n",(0,s.jsx)(n.li,{children:"$workspace/tools/bazel.rc"}),"\n",(0,s.jsx)(n.li,{children:"--nomaster_bazelrc"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["home\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"$HOME/.bazelrc"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"%USERPROFILE%\\.bazelrc"}),", ",(0,s.jsx)(n.code,{children:"%HOME%/.bazelrc"})]}),"\n",(0,s.jsx)(n.li,{children:"--nohome_rc"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"--bazelrc"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/tensorflow/tensorflow/blob/master/.bazelrc",children:"https://github.com/tensorflow/tensorflow/blob/master/.bazelrc"})}),"\n",(0,s.jsxs)(n.li,{children:["\u53D8\u91CF\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"%workspace%"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"build --announce_rc\nbuild --copt -O0\nbuild --disk_cache=/tmp/bazel-disk-cache\n# Set convenient location for Bazel files to cache\nstartup --output_user_root=/tmp/bazel-cache/output-root\n\nbuild --verbose_failures=true\n# Profile build\nbuild --profile=/tmp/bazel.profile.json\n\n# JVM \u9650\u5236\n# startup --host_jvm_args=-Xmx3g --host_jvm_args=-Xms2g\n\n\ntry-import %workspace%/.bazelrc.user\n\n# Include git version info\nbuild --stamp\nbuild --workspace_status_command 'echo STABLE_GIT_COMMIT $(git rev-parse HEAD)'\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# https://github.com/bazelbuild/bazelisk/blob/master/stamp.sh\nbuild:release -c opt --stamp --workspace_status_command="$PWD/stamp.sh"\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"# Running bazel inside a `docker build` command causes trouble, cf:\n#   https://github.com/bazelbuild/bazel/issues/134\n# The easiest solution is to set up a bazelrc file forcing --batch.\nstartup --batch\n\n# Similarly, we need to workaround sandboxing issues:\n#   https://github.com/bazelbuild/bazel/issues/418\nbuild  --verbose_failures --spawn_strategy=standalone --strategy=Genrule=standalone\ntest --spawn_strategy=standalone\n\n# Force bazel output to use colors (good for jenkins) and print useful errors.\ncommon --color=yes\n\n# Configure tests - increase timeout, print errors and timeout warnings\ntest --verbose_failures --test_output=errors --test_verbose_timeout_warnings\n"})}),"\n",(0,s.jsx)(n.h2,{id:"notes-1",children:"Notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/build-ref.html",children:"https://docs.bazel.build/versions/main/build-ref.html"})}),"\n",(0,s.jsx)(n.li,{children:"workspace"}),"\n",(0,s.jsxs)(n.li,{children:["package\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"BUILD"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"target"}),"\n",(0,s.jsx)(n.li,{children:"label"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"query",children:"query"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"bazel-collector"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/query.html",children:"https://docs.bazel.build/versions/main/query.html"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/query-how-to.html",children:"https://docs.bazel.build/versions/main/query-how-to.html"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'bazel query //...\n\nbazel query set(BUILD, some-dir/BUILD)\nbazel query rdeps(//..., set(//:all //some-dir:all))\nbazel query rdeps(//..., set(some-file.java, some-file.sh))\n\nbazel query rebuildfiles(some-ext.bzl, some-dir/another-ext.bzl)\n\nbazel query kind("*_test", <sub query>)\nbazel query kind("artifact_ci_release", <sub query>)\n\nbazel query "allpaths(//foo, third_party/...)" --notool_deps --output graph | dot -Tsvg > /tmp/deps.svg\n'})}),"\n",(0,s.jsx)(n.h2,{id:"bzlmod",children:"bzlmod"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"bazel 5.0+"}),"\n",(0,s.jsx)(n.li,{children:"MODULE.bazel"}),"\n",(0,s.jsx)(n.li,{children:"--experimental_enable_bzlmod"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/bazel-central-registry",children:"https://github.com/bazelbuild/bazel-central-registry"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/bzlmod.html",children:"https://docs.bazel.build/versions/main/bzlmod.html"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.google.com/document/d/1moQfNcEIttsk6vYanNKIy3ZuK53hQUFq1b1r0rmsYVg/edit",children:"https://docs.google.com/document/d/1moQfNcEIttsk6vYanNKIy3ZuK53hQUFq1b1r0rmsYVg/edit"})}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(n.h2,{id:"build-vs-buildbazel",children:"BUILD vs BUILD.bazel"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/bazel/issues/4517",children:"bazel#4517"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"fetching-local_config_xcode",children:"Fetching @local_config_xcode"}),"\n",(0,s.jsx)(n.h2,{id:"from-google",children:"from google"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"google"}),(0,s.jsx)(n.th,{children:"os"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"blaze"}),(0,s.jsx)(n.td,{children:"bazel"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"sponge"}),(0,s.jsx)(n.td,{children:"bru, BuildBuddy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"tap"}),(0,s.jsx)(n.td,{children:"BuildKite, CircleCI"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"forge"}),(0,s.jsx)(n.td,{children:"BuildFarm, BuildBarn"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"cider"}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"output",children:"output"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"macOS /private/var/tmp"}),"\n",(0,s.jsx)(n.li,{children:"Linux ~/.cache/bazel"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.bazel.build/versions/main/output_directories.html",children:"https://docs.bazel.build/versions/main/output_directories.html"})}),"\n",(0,s.jsxs)(n.li,{children:["out/\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"_bazel_$USER"})," - outputUserRoot - ",(0,s.jsx)(n.code,{children:"--output_user_root"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["install/ - installBase\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["$MD5(installation manifest)\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"_embedded_binaries/"}),"\n",(0,s.jsx)(n.li,{children:"builtins_bzl/"}),"\n",(0,s.jsx)(n.li,{children:"platforms/"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["$MD5(workspace path) - outputBase - ",(0,s.jsx)(n.code,{children:"--output_base"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"command.log"}),"\n",(0,s.jsx)(n.li,{children:"java.log"}),"\n",(0,s.jsx)(n.li,{children:"action_cache/"}),"\n",(0,s.jsx)(n.li,{children:"action_outs/"}),"\n",(0,s.jsxs)(n.li,{children:["external/\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"go_sdk/ - \u7F13\u5B58\u7684 Go SDK"}),"\n",(0,s.jsx)(n.li,{children:"bazel_gazelle_go_repository_cache/ - \u7F13\u5B58\u7684 Go \u4ED3\u5E93"}),"\n",(0,s.jsx)(n.li,{children:"org_golang_google_genproto/"}),"\n",(0,s.jsx)(n.li,{children:"remotejdk11_macos/"}),"\n",(0,s.jsx)(n.li,{children:"remote_java_tools_darwin/"}),"\n",(0,s.jsx)(n.li,{children:"com_google_protobuf/"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["server/\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"jvm.out"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["execroot/\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"__main__"}),"/ - $WORKSPACE\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["bazel-out/ - outputPath\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"stable-status.txt"}),"\n",(0,s.jsx)(n.li,{children:"volatile-status.txt"}),"\n",(0,s.jsxs)(n.li,{children:["darwin-fastbuild/\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"bin/ - $(BINDIR)"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"host/ - BuildConfiguration"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"external"}),"\n",(0,s.jsx)(n.li,{children:"$PACKAGES -> realpath"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"bazel-remote-logs/"}),"\n",(0,s.jsx)(n.li,{children:"bazel-workers/"}),"\n",(0,s.jsx)(n.li,{children:"install -> installBase"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"bazel-out"}),"\n",(0,s.jsx)(n.li,{children:"bazel-bin"}),"\n",(0,s.jsx)(n.li,{children:"bazel-testlogs"}),"\n",(0,s.jsx)(n.li,{children:"bazel-$WORKSPACE"}),"\n",(0,s.jsx)(n.li,{children:"TEST_TMPDIR=~/.cache/bazel"}),"\n",(0,s.jsx)(n.li,{children:"--output_user_root"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"project_dir = ctx.path(ctx.attr.file_in_project).dirname"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"__workspace_dir__"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# all go_sdk - \u6BCF\u4E2A 400MB\ndu -csh /private/var/tmp/_bazel_$USER/*/external/go_sdk\n\n# outputPath & action_cache\nbazel clean\n"})})]})}function o(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},17776:function(e,n,l){l.d(n,{R:()=>t,x:()=>c});var i=l(7378);let s={},r=i.createContext(s);function t(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);