"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["67478"],{11155:function(n,e,t){t.r(e),t.d(e,{frontMatter:()=>o,toc:()=>c,default:()=>d,metadata:()=>s,assets:()=>l,contentTitle:()=>a});var s=JSON.parse('{"id":"os/alpine/alpine-takeover","title":"takeover","description":"- \u5C06 VPS \u66FF\u6362\u4E3A AlpineLinux \u73AF\u5883","source":"@site/../notes/os/alpine/alpine-takeover.md","sourceDirName":"os/alpine","slug":"/os/alpine/takeover","permalink":"/notes/os/alpine/takeover","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/alpine/alpine-takeover.md","tags":[{"inline":true,"label":"Trick","permalink":"/notes/tags/trick"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1737304142000,"frontMatter":{"title":"takeover","tags":["Trick"]},"sidebar":"docs","previous":{"title":"AlpineLinux Setup","permalink":"/notes/os/alpine/setup"},"next":{"title":"Alpine Tip","permalink":"/notes/os/alpine/tip"}}'),i=t(86106),r=t(17776);let o={title:"takeover",tags:["Trick"]},a="takeover",l={},c=[{value:"\u51C6\u5907\u73AF\u5883",id:"prepare",level:2},{value:"takeover",id:"takeover-1",level:2},{value:"reinstall",id:"reinstall",level:2},{value:"pivot_root: (null): Resource busy",id:"pivot_root-null-resource-busy",level:2}];function u(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"takeover",children:"takeover"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5C06 VPS \u66FF\u6362\u4E3A AlpineLinux \u73AF\u5883"}),"\n",(0,i.jsx)(e.li,{children:"\u7528\u4E8E\u5E73\u53F0\u4E0D\u652F\u6301\u81EA\u5B9A\u4E49\u955C\u50CF\u6216\u8005\u6CA1\u6709 AlpineLinux \u7684\u573A\u666F"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"prepare",children:"\u51C6\u5907\u73AF\u5883"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'mkdir /takeover\nmount -t tmpfs tmpfs /takeover\n\ncd /takeover\nmkdir -p etc\ncp /etc/resolv.conf etc # \u4FDD\u7559 DNS \u914D\u7F6E\n\ncurl -LO https://raw.githubusercontent.com/marcan/takeover.sh/master/takeover.sh\ncurl -LO https://raw.githubusercontent.com/marcan/takeover.sh/master/fakeinit.c\ncurl -LO https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox\n\ncurl -LO https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.21/main/x86_64/apk-tools-static-2.14.6-r2.apk\nmkdir apk-tools-static\ntar zxvf apk-tools-static-*.apk -C .\n./sbin/apk.static --version\n\nchmod +x takeover.sh\nchmod +x busybox\n# apt update; apt install -y gcc # for debian/ubuntu\ngcc fakeinit.c -o fakeinit -static # compile fakeinit as static\nldd fakeinit                       # ensure it\'s static: not a dynamic executable\n\n# Setup the chroot environment\nchroot /takeover /busybox sh\n# --root /takeover\n# apk.static -X http://mirrors.tuna.tsinghua.edu.cn/alpine/v3.17/main --allow-untrusted --initdb add alpine-base\n#apk.static -X http://mirrors.tuna.tsinghua.edu.cn/alpine/latest-stable/main --allow-untrusted --initdb add alpine-base\napk.static -X http://dl-cdn.alpinelinux.org/latest-stable/main --allow-untrusted --initdb add alpine-base\n\n# /etc/apk/repositories\n# for China\n# setup-apkrepos http://mirrors.tuna.tsinghua.edu.cn/alpine/v3.21/main http://mirrors.tuna.tsinghua.edu.cn/alpine/v3.21/community\nsetup-apkrepos -c -1 # choose first mirror dl-cdn.alpinelinux.org\napk add shadow util-linux\n# ln -s /usr/bin/passwd /bin/passwd               # takeover.sh use this\nsetup-sshd -c openssh                              # \u5B89\u88C5 ssh\necho "PermitRootLogin yes" >> /etc/ssh/sshd_config # \u5141\u8BB8 root \u4F7F\u7528\u5BC6\u7801\u767B\u5F55\nexit                                               # \u9000\u51FA chroot\n'})}),"\n",(0,i.jsx)(e.h2,{id:"takeover-1",children:"takeover"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"takeover \u524D\u6CE8\u610F /etc/network/interfaces \u662F\u5426\u662F\u7279\u6B8A\u60C5\u51B5"}),"\n",(0,i.jsx)(e.li,{children:"\u5B8C\u6210 takeover \u540E\u539F\u5148\u7CFB\u7EDF\u7684 init \u5C31\u548C ssh \u8FDB\u5165\u7684\u73AF\u5883\u6CA1\u5173\u7CFB\u4E86"}),"\n",(0,i.jsx)(e.li,{children:"takeover \u4E0D\u4F1A\u5BF9\u539F\u7CFB\u7EDF\u6709\u4EFB\u4F55\u5F71\u54CD"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'TO=/takeover\n# e.g. systemd\nOLD_INIT=$(readlink /proc/1/exe)\nPORT=80\n\n# \u4E3A SSH \u8BBE\u7F6E\u65B0\u7684\u5BC6\u7801\n./busybox chroot . /usr/bin/passwd\n# \u4F7F\u7528 busybox \u51C6\u5907\u73AF\u5883\n./busybox sh\nrm -f etc/mtab\nln -s /proc/mounts etc/mtab\nmkdir -p old_root\nmount -t tmpfs tmp tmp\nmount -t proc proc proc\nmount -t sysfs sys sys\nmount -t devtmpfs dev dev\nmount --bind /dev/pts dev/pts\nexit\n\n# /dev/pts/0\nTTY="$(./busybox tty)"\n\nexec < "$TO/$TTY" > "$TO/$TTY" 2> "$TO/$TTY"\n# \u51C6\u5907\u65B0\u7684 init\n./busybox cat > tmp/${OLD_INIT##*/} << EOF\n#!${TO}/busybox sh\n\nexec <"${TO}/${TTY}" >"${TO}/${TTY}" 2>"${TO}/${TTY}"\ncd "${TO}"\n\n./busybox echo "Init takeover successful"\n./busybox echo "Pivoting root..."\n./busybox mount --make-rprivate /\n./busybox unshare -m\n./busybox pivot_root . old_root\n./busybox echo "Chrooting and running init..."\nexec ./busybox chroot . /fakeinit\nEOF\n./busybox chmod +x tmp/${OLD_INIT##*/}\n\n# \u542F\u52A8 SSH\n# ssh root@HOSTNAME -p 80\n./busybox chroot . /usr/bin/ssh-keygen -A\n./busybox chroot . /usr/sbin/sshd -p $PORT -o PermitRootLogin=yes\n\n./busybox mount --bind tmp/${OLD_INIT##*/} ${OLD_INIT} # \u5207\u6362 init\ntelinit u                                              # \u91CD\u65B0\u52A0\u8F7D init\n'})}),"\n",(0,i.jsx)(e.h2,{id:"reinstall",children:"reinstall"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# \u8FDB\u5165\u65B0\u7684 ssh \u73AF\u5883\nssh root@HOSTNAME -p 80\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"cleanup"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u6E05\u7406\u65E7\u7684\u8FDB\u7A0B"}),"\n",(0,i.jsx)(e.li,{children:"\u6700\u7EC8 unmount /old_root"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"umount -R /old_root\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"setup"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"setup-disk \u4F1A\u628A\u5F53\u524D\u7CFB\u7EDF\u73AF\u5883\u505A\u5230\u786C\u76D8"}),"\n",(0,i.jsx)(e.li,{children:"\u56E0\u6B64 apk add \u7684\u5185\u5BB9\u4E5F\u4F1A\u5728\u5B89\u88C5\u540E\u7684\u7CFB\u7EDF\u91CC"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"apk add curl nano bash file util-linux\n# setup /etc/network/interfaces \u5982\u679C\u4E0D\u662F DHCP \u9700\u8981\u6839\u636E\u60C5\u51B5\u8C03\u6574\nsetup-interfaces -a\n\n# \u786E\u4FDD\u7F51\u7EDC\u542F\u52A8\n# ln -fs /etc/init.d/networking /etc/runlevels/boot\nrc-update add networking boot\n\n# \u5047\u8BBE /dev/vda \u4E3A\u5B89\u88C5\u76D8\n# \u5047\u8BBE\u662F\u5728\u4E91\u5E73\u53F0\u56E0\u6B64\u4F7F\u7528 virt\nERASE_DISKS=/dev/vda setup-disk -m sys -s 0 -k virt /dev/vda\n\n# \u53EF\u4EE5\u4E8C\u6B21\u68C0\u67E5\nmount /dev/vda2 /mnt\nmount /dev/vda1 /mnt/boot\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u91CD\u542F\u8FDB\u5165\u65B0\u7684\u7CFB\u7EDF"}),"\n"]}),"\n",(0,i.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://github.com/marcan/takeover.sh",children:"marcan/takeover.sh"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"pivot_root-null-resource-busy",children:"pivot_root: (null): Resource busy"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u9700\u8981\u4FEE\u6539\u811A\u672C\u589E\u52A0 ",(0,i.jsx)(e.code,{children:"unshare -m"})]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"./busybox unshare -m\n"})})]})}function d(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(u,{...n})}):u(n)}},17776:function(n,e,t){t.d(e,{R:()=>o,x:()=>a});var s=t(7378);let i={},r=s.createContext(i);function o(n){let e=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);