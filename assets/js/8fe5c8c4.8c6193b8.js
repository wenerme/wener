"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["90840"],{49852:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>l,toc:()=>a,default:()=>d,metadata:()=>r,assets:()=>h,contentTitle:()=>o});var r=JSON.parse('{"id":"devops/web/haproxy/haproxy-faq","title":"HAProxy FAQ","description":"Memory Usage","source":"@site/../notes/devops/web/haproxy/haproxy-faq.md","sourceDirName":"devops/web/haproxy","slug":"/devops/web/haproxy/faq","permalink":"/notes/devops/web/haproxy/faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/haproxy/haproxy-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1694402622000,"frontMatter":{"tags":["FAQ"]},"sidebar":"docs","previous":{"title":"HAProxy Data Plane","permalink":"/notes/devops/web/haproxy/dataplane"},"next":{"title":"HAProxy Logging","permalink":"/notes/devops/web/haproxy/logging"}}'),i=s(86106),t=s(17776);let l={tags:["FAQ"]},o="HAProxy FAQ",h={},a=[{value:"Memory Usage",id:"memory-usage",level:2},{value:"perf debug",id:"perf-debug",level:2},{value:"req_ssl_sni vs ssl_fc_sni",id:"req_ssl_sni-vs-ssl_fc_sni",level:2},{value:"TLS handshake, Client hello \u540E\u65E0\u54CD\u5E94",id:"tls-handshake-client-hello-\u540E\u65E0\u54CD\u5E94",level:2},{value:"HAProxy exit code 143",id:"haproxy-exit-code-143",level:2},{value:"cannot parse Content-Length: too long int",id:"cannot-parse-content-length-too-long-int",level:2},{value:"Cannot raise FD limit to 20637, limit is 4096.",id:"cannot-raise-fd-limit-to-20637-limit-is-4096",level:2},{value:"ERR_HTTP2_SERVER_REFUSED_STREAM",id:"err_http2_server_refused_stream",level:2},{value:"h3",id:"h3",level:2},{value:"Whitelist",id:"whitelist",level:2}];function c(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"haproxy-faq",children:"HAProxy FAQ"})}),"\n",(0,i.jsx)(n.h2,{id:"memory-usage",children:"Memory Usage"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["e.g.\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"16 kB buffers"}),"\n",(0,i.jsx)(n.li,{children:"34 kB/session"}),"\n",(0,i.jsx)(n.li,{children:"30000 sessions/GB"}),"\n",(0,i.jsx)(n.li,{children:"20000 sessions/GB - \u8003\u8651\u7CFB\u7EDF\u4E5F\u4F1A\u9700\u8981\u5185\u5B58"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://sysadminxpert.com/what-is-haproxy-and-important-performance-factors/",children:"https://sysadminxpert.com/what-is-haproxy-and-important-performance-factors/"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"perf-debug",children:"perf debug"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sysctl net.ipv4.ip_local_port_range\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"net.core.wmem_max\nnet.core.rmem_max\nnet.ipv4.tcp_rmem\nnet.ipv4.tcp_wmem\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"nbproc $(nproc)"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"req_ssl_sni-vs-ssl_fc_sni",children:"req_ssl_sni vs ssl_fc_sni"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["req_ssl_sni\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u7528\u4E8E ssl paththrough \u65F6"}),"\n",(0,i.jsxs)(n.li,{children:["\u4F1A\u6BD4 hdr(host) \u5FEB\u4E00\u70B9\u70B9\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"http://marc.info/?l=haproxy&m=144490809910124&w=2",children:"http://marc.info/?l=haproxy&m=144490809910124&w=2"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["ssl_fc_sni\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u7528\u4E8E ssl offload \u65F6"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-haproxy",children:"use_backend s1 if { ssl_fc_sni my.domain.org }\nuse_backend s2 if { hdr(host) -i my2.domain.org }\n"})}),"\n",(0,i.jsx)(n.h2,{id:"tls-handshake-client-hello-\u540E\u65E0\u54CD\u5E94",children:"TLS handshake, Client hello \u540E\u65E0\u54CD\u5E94"}),"\n",(0,i.jsx)(n.p,{children:"\u5728 AlpineLinux 3.14 \u4E0A\uFF0CHost \u5185\u8FD0\u884C HAProxy\uFF0C\u4F7F\u7528 SNI Passthrough \u51FA\u73B0\u8BE5\u95EE\u9898\uFF0C\u4FEE\u6539\u4E3A\u5728\u5BB9\u5668\u5185\u8FD0\u884C\u540E\u95EE\u9898\u89E3\u51B3\u3002\n\u5728\u5BB9\u5668\u5185\u4F7F\u7528\u5B8C\u5168\u76F8\u540C\u7684 HAProxy \u7248\u672C\u4E5F\u6CA1\u6709\u95EE\u9898\uFF0C\u4E00\u6B21\u65AD\u5B9A\u662F Host \u73AF\u5883\u7684\u95EE\u9898\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u53EF\u80FD\u7684\u539F\u56E0"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u7CFB\u7EDF\u4F9D\u8D56\u5347\u7EA7\u540E\u672A\u91CD\u542F"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"haproxy-exit-code-143",children:"HAProxy exit code 143"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SIGTERM"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"cannot-parse-content-length-too-long-int",children:"cannot parse Content-Length: too long int"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"H2, ssl-passthrough \u65F6\u4F1A\u6709\u95EE\u9898"}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/haproxy/haproxy/issues/1561",children:"#1561"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"cannot-raise-fd-limit-to-20637-limit-is-4096",children:"Cannot raise FD limit to 20637, limit is 4096."}),"\n",(0,i.jsx)(n.h2,{id:"err_http2_server_refused_stream",children:"ERR_HTTP2_SERVER_REFUSED_STREAM"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://confluence.atlassian.com/jirakb/some-jira-pages-fail-to-render-or-some-actions-fail-to-complete-with-the-error-err_http2_server_refused_stream-1085441145.html",children:"https://confluence.atlassian.com/jirakb/some-jira-pages-fail-to-render-or-some-actions-fail-to-complete-with-the-error-err_http2_server_refused_stream-1085441145.html"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/opnsense/plugins/issues/2013",children:"https://github.com/opnsense/plugins/issues/2013"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"libressl"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"h3",children:"h3"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/haproxytech/kubernetes-ingress/issues/546",children:"https://github.com/haproxytech/kubernetes-ingress/issues/546"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"whitelist",children:"Whitelist"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"acl white_list src 192.168.1.0/24 192.168.10.0/24\ntcp-request content accept if white_list\ntcp-request content reject\n"})})]})}function d(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},17776:function(e,n,s){s.d(n,{R:()=>l,x:()=>o});var r=s(7378);let i={},t=r.createContext(i);function l(e){let n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);