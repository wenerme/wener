"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["46762"],{27126:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>t,toc:()=>o,default:()=>x,metadata:()=>r,assets:()=>c,contentTitle:()=>d});var r=JSON.parse('{"id":"languages/go/lib/gorm","title":"GORM","description":"gorm","source":"@site/../notes/languages/go/lib/gorm.md","sourceDirName":"languages/go/lib","slug":"/languages/go/lib/gorm","permalink":"/notes/languages/go/lib/gorm","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/languages/go/lib/gorm.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1681281594000,"frontMatter":{"title":"GORM"},"sidebar":"docs","previous":{"title":"goreleaser","permalink":"/notes/languages/go/lib/goreleaser"},"next":{"title":"gqlgen","permalink":"/notes/languages/go/lib/gqlgen"}}'),l=s(86106),i=s(17776);let t={title:"GORM"},d,c={},o=[{value:"gorm",id:"gorm",level:2},{value:"Model",id:"model",level:2},{value:"\u94A9\u5B50",id:"\u94A9\u5B50",level:2},{value:"Upsert",id:"upsert",level:2},{value:"DryRun \u67E5\u770B\u6267\u884C\u8BED\u53E5",id:"dryrun-\u67E5\u770B\u6267\u884C\u8BED\u53E5",level:2},{value:"\u8DF3\u56DE\u94A9\u5B50\u5904\u7406",id:"\u8DF3\u56DE\u94A9\u5B50\u5904\u7406",level:2},{value:"\u591A\u6001",id:"\u591A\u6001",level:2},{value:"\u4F7F\u7528 UID \u5B9E\u73B0\u7C7B\u4F3C\u591A\u6001",id:"\u4F7F\u7528-uid-\u5B9E\u73B0\u7C7B\u4F3C\u591A\u6001",level:2},{value:"\u6DFB\u52A0 SQL \u51FD\u6570 \u9ED8\u8BA4\u503C",id:"\u6DFB\u52A0-sql-\u51FD\u6570-\u9ED8\u8BA4\u503C",level:2},{value:"\u907F\u514D\u63D2\u5165\u7A7A\u503C",id:"\u907F\u514D\u63D2\u5165\u7A7A\u503C",level:2},{value:"ErrRecordNotFound",id:"errrecordnotfound",level:2}];function a(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h2,{id:"gorm",children:"gorm"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"Golang \u7684 ORM \u5B9E\u73B0\n\u57FA\u4E8E Entity \u6A21\u578B"}),"\n"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/go-gorm/gorm",children:"go-gorm/gorm"})}),"\n",(0,l.jsxs)(e.li,{children:["\u6267\u884C\u8FC7\u7A0B\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6784\u5EFA Statement \u5BF9\u8C61"}),"\n",(0,l.jsx)(e.li,{children:"\u67E5\u8BE2 - \u6267\u884C query \u56DE\u8C03"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u51E0\u4E4E\u6240\u6709\u5B9E\u9645\u64CD\u4F5C\u90FD\u662F\u901A\u8FC7 callback \u4E32\u8054\u8D77\u6765\u7684"}),"\n",(0,l.jsx)(e.li,{children:"callbacks \u7BA1\u7406 processor \u7EC4"}),"\n",(0,l.jsx)(e.li,{children:"processor \u4E0B\u6709\u5B9E\u9645\u56DE\u8C03\u5904\u7406"}),"\n",(0,l.jsxs)(e.li,{children:["\u56DE\u8C03 \u64CD\u4F5C Statement \u4E0A\u5173\u8054\u7684\u503C\u5BF9\u8C61\u8FDB\u884C\u67E5\u8BE2\u4FEE\u6539\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"func(db *gorm.DB)"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"db.Statement.ReflectValue"})," - \u7ED3\u679C\u6570\u636E"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5165\u53E3 processor - \u8C03\u7528\u540E\u5F00\u59CB\u5B9E\u9645\u6267\u884C\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["create\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"gorm:begin_transaction"}),"\n",(0,l.jsx)(e.li,{children:"gorm:before_create"}),"\n",(0,l.jsx)(e.li,{children:"gorm:save_before_associations"}),"\n",(0,l.jsx)(e.li,{children:"gorm:create"}),"\n",(0,l.jsx)(e.li,{children:"gorm:save_after_associations"}),"\n",(0,l.jsx)(e.li,{children:"gorm:after_create"}),"\n",(0,l.jsx)(e.li,{children:"gorm:commit_or_rollback_transaction"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["query\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"gorm:query"}),"\n",(0,l.jsx)(e.li,{children:"gorm:preload"}),"\n",(0,l.jsx)(e.li,{children:"gorm:after_query"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["update\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4E0E create \u7C7B\u4F3C"}),"\n",(0,l.jsx)(e.li,{children:"gorm:setup_reflect_value - \u5728 begin_transaction \u540E"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["delete\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"gorm:begin_transaction"}),"\n",(0,l.jsx)(e.li,{children:"gorm:before_delete"}),"\n",(0,l.jsx)(e.li,{children:"gorm:delete_before_associations"}),"\n",(0,l.jsx)(e.li,{children:"gorm:delete"}),"\n",(0,l.jsx)(e.li,{children:"gorm:after_delete"}),"\n",(0,l.jsx)(e.li,{children:"gorm:commit_or_rollback_transaction"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["row\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"gorm:row"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["raw\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"gorm:raw"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["RegisterDefaultCallbacks - \u9ED8\u8BA4 callback \u6CE8\u518C\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u80FD\u770B\u5F97\u51FA\u6765\u6267\u884C\u8FC7\u7A0B"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5173\u7CFB - Relationship\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u521B\u5EFA\u65F6\u4F1A\u81EA\u52A8\u521B\u5EFA\u5173\u8054"}),"\n",(0,l.jsxs)(e.li,{children:["\u5176\u4ED6\u64CD\u4F5C\u53EF\u9009 - ",(0,l.jsx)(e.code,{children:"Select(clause.Associations)"})," ",(0,l.jsx)(e.code,{children:'Select("Profile")'})]}),"\n",(0,l.jsxs)(e.li,{children:["\u4E5F\u53EF\u4EE5\u76F4\u63A5\u9488\u5BF9\u5173\u8054\u8FDB\u884C\u64CD\u4F5C - ",(0,l.jsx)(e.code,{children:'Association("Profile")'})]}),"\n",(0,l.jsx)(e.li,{children:"\u5173\u7CFB\u5904\u7406\u65B9\u5F0F\u5206\u4E3A JoinTable \u548C Reference"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["gorm:preload\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u591A\u5C42\u7EA7 Preload \u4F1A\u6309\u5E8F - \u4F8B\u5982 ",(0,l.jsx)(e.code,{children:'Preload("Profile.Address")'})," \u4F1A\u5206\u6210 ",(0,l.jsx)(e.code,{children:"Profile"})," \u548C ",(0,l.jsx)(e.code,{children:"Profile.Address"})," \u4E24\u6B21\u5B8C\u6210"]}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679C\u5173\u7CFB\u4E0D\u5B58\u5728\uFF0C\u627E\u4E0D\u5230 Relationship \u76EE\u524D\u4F1A NPE"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u8BED\u53E5\u6784\u5EFA\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"clause.Expression{ Build(Builder) }"})," - \u8868\u793A\u4EFB\u610F\u8BED\u53E5"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"clause.Builder"})," - WriteString, AddVar, WriteQuoted - \u6784\u5EFA\u4E0A\u4E0B\u6587"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"clause.Interface"})," - \u5E26 Name \u7684 \u8868\u8FBE\u5F0F - \u53EF\u4EE5\u88AB\u5408\u5E76\u548C\u66FF\u6362 - \u4F8B\u5982 LIMIT, SELECT"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"clause.Table"}),", ",(0,l.jsx)(e.code,{children:"clause.Column"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"Relationship \u5173\u8054\u7684 Schema \u53EF\u80FD\u548C\u5B9E\u9645 Schema \u4E0D\u540C - \u5BFC\u81F4\u65E0\u6CD5 Preload"}),"\n",(0,l.jsxs)(e.li,{children:["Embed Struct \u4E5F\u662F\u5F53\u4F5C embedded \u6765\u5904\u7406\u7684\uFF0C\u53EA\u4E0D\u8FC7\u6CA1\u6709\u524D\u7F00\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u73B0\u5728\u5D4C\u5957\u591A\u5C42\u89E3\u6790\u7684 schema \u4F1A\u6709\u95EE\u9898 - ",(0,l.jsx)(e.a,{href:"https://github.com/go-gorm/gorm/issues/3964",children:"#3964"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/pilagod/gorm-cursor-paginator",children:"pilagod/gorm-cursor-paginator"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/go-gorm/datatypes",children:"go-gorm/datatypes"})," - gorm.io/datatypes\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5B9E\u73B0\u4E86\u5176\u4ED6\u6570\u636E\u7C7B\u578B - \u4F8B\u5982 JSON"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"go get -u gorm.io/gorm\n\n# \u57FA\u4E8E cgo \u7684 sqlite\ngo get -u gorm.io/driver/sqlite\n\n# \u4E0D\u9700\u8981 cgo\ngo get -u github.com/glebarez/sqlite\ngo get -u github.com/glebarez/go-sqlite\n\ngo get -u gorm.io/driver/postgres\n"})}),"\n",(0,l.jsx)(e.admonition,{type:"caution",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4E0D\u5EFA\u8BAE\u5B57\u6BB5\u8BBE\u7F6E\u4E3A default:null\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"OnConflict UpdateAll \u4E0D\u4F1A\u5904\u7406"}),"\n",(0,l.jsx)(e.li,{children:"Null \u65E0\u6CD5\u88AB\u8BFB\u53D6\u4E3A \u975E Ptr \u6216 \u975E sql.Null"}),"\n"]}),"\n"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"tag"}),(0,l.jsx)(e.th,{children:"mean"}),(0,l.jsx)(e.th,{children:"e.g."})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"column:"}),(0,l.jsx)(e.td,{children:"\u5217\u540D"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"type:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"size:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"primaryKey"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"unique"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"default:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"precision:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"scale:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"not null"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"autoIncrement"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"autoIncrementIncrement:"}),(0,l.jsx)(e.td,{children:"\u81EA\u589E\u6B65\u957F"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"embedded"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"embeddedPrefix:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"autoCreateTime:nano/milli"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"autoUpdateTime:nano/milli"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"index"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"uniqueIndex"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"check:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"<-"}),(0,l.jsx)(e.td,{children:"\u53EF\u6743\u9650: create,update,false"}),(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:'gorm:"<-:create"'})})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"->"}),(0,l.jsx)(e.td,{children:"\u8BFB\u6743\u9650"}),(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:'gorm:"->:false"'})})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"-"}),(0,l.jsx)(e.td,{children:"\u5FFD\u7565\u5B57\u6BB5"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"comment:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"foreignKey:"}),(0,l.jsxs)(e.td,{children:["\u5916\u5EFA\u540D\u5B57 - \u9ED8\u8BA4 ",(0,l.jsx)(e.code,{children:"{ForeignModel}ID"})]}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"references:"}),(0,l.jsx)(e.td,{children:"\u88AB\u5173\u8054\u5BF9\u8C61\u5B57\u6BB5"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"polymorphic:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"polymorphicValue:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"many2many:"}),(0,l.jsx)(e.td,{children:"join table"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"joinForeignKey:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"joinReferences:"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"constraint:"}),(0,l.jsx)(e.td,{children:"OnUpdate,OnDelete"}),(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:'gorm:"constraint:OnUpdate:CASCADE,OnDelete:SET NULL;"'})})]})]})]}),"\n",(0,l.jsx)(e.admonition,{type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Tag \u4E0D\u5206\u5927\u5C0F\u5199"}),"\n"]})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["index\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"unique"}),"\n",(0,l.jsx)(e.li,{children:"priority"}),"\n",(0,l.jsx)(e.li,{children:"class, type, where, comment, expression, sort, collate, option"}),"\n",(0,l.jsx)(e.li,{children:"composite"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"uniqueIndex"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",metastring:'title="\u7279\u6B8A\u503C"',children:'const (\n	PrimaryKey   string = "~~~py~~~" // primary key\n	CurrentTable string = "~~~ct~~~" // current table\n	Associations string = "~~~as~~~" // associations\n)\n'})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'import (\n  "gorm.io/driver/sqlite"\n  _ "github.com/glebarez/sqlite"\n  "gorm.io/gorm"\n)\n\ndb, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{})\n'})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'// \u76F4\u63A5\u8C03\u7528 processor\nfunc TestPreloadOnly(t *testing.T){\n  // \u6A21\u578B\u53EA\u5305\u542B\u4E3B\u952E\n  var m models.User\n  m.ID = 1\n  // \u901A\u5E38\u903B\u8F91 - \u4F46\u6784\u9020\u51FA\u6765\u7684 stmt \u5305\u542B\u57FA\u7840\u4FE1\u606F\n  stmt := db.Model(&m).Preload("Profile")\n  // \u586B\u5145\u9700\u8981\u7684\u4FE1\u606F - \u6B63\u5E38\u903B\u8F91\u8FD9\u4E9B\u5B57\u6BB5\u4F1A\u88AB\u586B\u5145\n  stmt.Statement.Dest = stmt.Statement.Model\n  stmt.Statement.ReflectValue = reflect.ValueOf(stmt.Statement.Dest).Elem()\n  assert.NoError(t, stmt.Statement.Parse(stmt.Statement.Model))\n\n  // \u76F4\u63A5\u8C03\u7528 preload\n  callbacks.Preload(stmt)\n  assert.NoError(t, stmt.Error)\n\n  // \u5B57\u6BB5\u88AB\u6210\u529F preload\n  fmt.Println(m.Profile)\n}\n'})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u521B\u5EFA\u3001\u66F4\u65B0\u3001\u5220\u9664 \u9ED8\u8BA4\u5728\u4E8B\u52A1\u4E2D\u6267\u884C\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"SkipDefaultTransaction \u53EF\u5173\u95ED - \u7EA6 30% \u6027\u80FD"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"Tag \u4E0D\u533A\u5206\u5927\u5C0F\u5199"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'// \u67E5\u8BE2\u6761\u4EF6\u4E0E\u6570\u636E\u4E0D\u540C\u4F46\u53EF\u4EE5\u4E00\u6B21\u64CD\u4F5C\ndb.Where(User{Name: "non_existing"}).Assign(User{Age: 20}).FirstOrCreate(&user)\n'})}),"\n",(0,l.jsx)(e.h2,{id:"model",children:"Model"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'import (\n  "github.com/google/uuid"\n  "github.com/lib/pq"\n)\n\ntype Post struct {\n  ID     uuid.UUID `gorm:"type:uuid;default:uuid_generate_v4()"`\n  Title  string\n  Tags   pq.StringArray `gorm:"type:text[]"` // \u9700\u8981\u6307\u5B9A\u7C7B\u578B\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u94A9\u5B50",children:"\u94A9\u5B50"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u521B\u5EFA\u548C\u66F4\u65B0\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"BeforeSave"}),"\n",(0,l.jsx)(e.li,{children:"BeforeCreate/BeforeUpdate"}),"\n",(0,l.jsx)(e.li,{children:"AfterCreate/AfterUpdate"}),"\n",(0,l.jsx)(e.li,{children:"AfterSave"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5220\u9664\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"BeforeDelete"}),"\n",(0,l.jsx)(e.li,{children:"AfterDelete"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u67E5\u8BE2\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"AfterFind"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'// \u64CD\u4F5C\u5F53\u524D\u7684 Statement \u53EF\u4FEE\u6539\u8BED\u53E5\nfunc (u *User) BeforeCreate(tx *gorm.DB) error {\n  // \u901A\u8FC7 tx.Statement \u4FEE\u6539\u5F53\u524D\u64CD\u4F5C\uFF0C\u4F8B\u5982\uFF1A\n  tx.Statement.Select("Name", "Age")\n  tx.Statement.AddClause(clause.OnConflict{DoNothing: true})\n\n  // tx \u662F\u5E26\u6709 `NewDB` \u9009\u9879\u7684\u65B0\u4F1A\u8BDD\u6A21\u5F0F\n  // \u57FA\u4E8E tx \u7684\u64CD\u4F5C\u4F1A\u5728\u540C\u4E00\u4E2A\u4E8B\u52A1\u4E2D\uFF0C\u4F46\u4E0D\u4F1A\u5E26\u4E0A\u4EFB\u4F55\u5F53\u524D\u7684\u6761\u4EF6\n  err := tx.First(&role, "name = ?", user.Role).Error\n  // SELECT * FROM roles WHERE name = "admin"\n  // ...\n  return err\n}\n'})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/go-gorm/gorm/issues/3611#issuecomment-729673788",children:"https://github.com/go-gorm/gorm/issues/3611#issuecomment-729673788"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4F7F\u7528 BeforeCreate \u505A upsert"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"upsert",children:"Upsert"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'// \u66F4\u65B0\u90E8\u5206\u5B57\u6BB5\ndb.Clauses(clause.OnConflict{\n  Columns:   []clause.Column{{Name: "id"}},\n  DoUpdates: clause.AssignmentColumns([]string{"name", "age"}),\n}).Create(&users)\n\n// \u4ECE\u65B0\u6620\u5C04\ndb.Clauses(clause.OnConflict{\n  Columns:   []clause.Column{{Name: "id"}},\n  DoUpdates: clause.Assignments(map[string]interface{}{\n    "role": "user"\uFF0C\n    "count": gorm.Expr("GREATEST(count, VALUES(count))"),\n  }),\n}).Create(&users)\n\n// \u66F4\u65B0\u6240\u6709\ndb.Clauses(clause.OnConflict{\n  Columns:   []clause.Column{{Name: "id"}},\n  UpdateAll: true,\n}).Create(&users)\n'})}),"\n",(0,l.jsx)(e.h2,{id:"dryrun-\u67E5\u770B\u6267\u884C\u8BED\u53E5",children:"DryRun \u67E5\u770B\u6267\u884C\u8BED\u53E5"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:"stmt := db.Session(&gorm.Session{DryRun: true}).First(&user, 1).Statement\nstmt.SQL.String() //=> SELECT * FROM `users` WHERE `id` = $1 ORDER BY `id`\nstmt.Vars         //=> []interface{}{1}\n\n// \u53EF\u751F\u6210\u5B8C\u6574 SQL - \u4E0D\u8981\u7528\u4E8E\u67E5\u8BE2\uFF0C\u6709 SQL \u6CE8\u5165\u98CE\u9669\ndb.Dialector.Explain(stmt.SQL.String(), stmt.Vars...)\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u8DF3\u56DE\u94A9\u5B50\u5904\u7406",children:"\u8DF3\u56DE\u94A9\u5B50\u5904\u7406"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:"db.Session(&gorm.Session{SkipHooks: true}).Create(&user)\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u591A\u6001",children:"\u591A\u6001"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9ED8\u8BA4\u591A\u6001\u503C\u4E3A\u8868\u540D"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'type Cat struct {\n  ID    int\n  Name  string\n  Toy   Toy `gorm:"polymorphic:Owner;"`\n}\n\ntype Dog struct {\n  ID   int\n  Name string\n  Toy  Toy `gorm:"polymorphic:Owner;"`\n}\n\ntype Toy struct {\n  ID        int\n  Name      string\n  OwnerID   int\n  OwnerType string\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u4F7F\u7528-uid-\u5B9E\u73B0\u7C7B\u4F3C\u591A\u6001",children:"\u4F7F\u7528 UID \u5B9E\u73B0\u7C7B\u4F3C\u591A\u6001"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'type Model struct {\n  ID    int\n  UID   string // uuid\n}\ntype Cat struct {\n  Model\n  Name  string\n  Toy   Toy `gorm:"polymorphic:Owner;"`\n}\n\ntype Dog struct {\n  Model\n  Name string\n  Toy  Toy `gorm:"polymorphic:Owner;"`\n}\n\ntype Toy struct {\n  ID        int\n  Name      string\n  OwnerID   int\n  OwnerType string\n  OwnerUID string\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u6DFB\u52A0-sql-\u51FD\u6570-\u9ED8\u8BA4\u503C",children:"\u6DFB\u52A0 SQL \u51FD\u6570 \u9ED8\u8BA4\u503C"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'type User struct {\n    ID          int       `sql:"DEFAULT:myfunction"`\n    XID         int       `sql:"type:bigint; DEFAULT:id_generator()"`\n    CreatedAt   time.Time `sql:"DEFAULT:current_timestamp"`\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u907F\u514D\u63D2\u5165\u7A7A\u503C",children:"\u907F\u514D\u63D2\u5165\u7A7A\u503C"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'type User struct {\n    gorm.Model\n    Email  string    `gorm:"unique;not null;type:varchar(100);default:null"`\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"errrecordnotfound",children:"ErrRecordNotFound"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"First, Last, Take"}),"\n"]})]})}function x(n={}){let{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(a,{...n})}):a(n)}},17776:function(n,e,s){s.d(e,{R:()=>t,x:()=>d});var r=s(7378);let l={},i=r.createContext(l);function t(n){let e=r.useContext(i);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),r.createElement(i.Provider,{value:e},n.children)}}}]);