"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["97778"],{693053:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>o,toc:()=>d,default:()=>m,metadata:()=>t,assets:()=>a,contentTitle:()=>l});var t=JSON.parse('{"id":"web/nodejs/mikro-orm/README","title":"mikro-orm","description":"- mikro-orm/mikro-orm","source":"@site/../notes/web/nodejs/mikro-orm/README.md","sourceDirName":"web/nodejs/mikro-orm","slug":"/web/nodejs/mikro-orm/","permalink":"/notes/web/nodejs/mikro-orm/","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/web/nodejs/mikro-orm/README.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1766368312000,"frontMatter":{"title":"mikro-orm"},"sidebar":"docs","previous":{"title":"JSR","permalink":"/notes/web/nodejs/jsr"},"next":{"title":"MikroORM FAQ","permalink":"/notes/web/nodejs/mikro-orm/faq"}}'),r=i(486106),s=i(917776);let o={title:"mikro-orm"},l="mikro-orm",a={},d=[{value:"STI",id:"sti",level:2},{value:"Collection",id:"collection",level:2},{value:"RequestContext",id:"requestcontext",level:2},{value:"Relationships",id:"relationships",level:2},{value:"Metadata",id:"metadata",level:2},{value:"Entity",id:"entity",level:2},{value:"EntitySchema",id:"entityschema",level:2},{value:"defineEntity",id:"defineentity",level:2},{value:"Migration",id:"migration",level:2},{value:"ObjectHydrator",id:"objecthydrator",level:2}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"mikro-orm",children:"mikro-orm"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mikro-orm/mikro-orm",children:"mikro-orm/mikro-orm"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"MIT, Typescript"}),"\n",(0,r.jsx)(n.li,{children:"ORM"}),"\n",(0,r.jsx)(n.li,{children:"\u652F\u6301 Data Mapper, Unit of Work, Identity Map"}),"\n",(0,r.jsx)(n.li,{children:"\u652F\u6301 MongoDB, MySQL, MariaDB, PostgreSQL, SQLite"}),"\n",(0,r.jsx)(n.li,{children:"\u652F\u6301 dataloader"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["@mikro-orm/knex\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Builder"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["mikro-orm \u4F7F\u7528 knex\uFF0C knex pool \u9ED8\u8BA4 ",(0,r.jsx)(n.code,{children:"min:2, max:10"})]}),"\n",(0,r.jsx)(n.li,{children:"\u4E0D\u652F\u6301\u590D\u6742\u591A\u6837\u7684 JOIN \u903B\u8F91"}),"\n",(0,r.jsxs)(n.li,{children:["\u9ED8\u8BA4 cascade \u4E3A persist\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u65B0 entity \u603B\u4F1A persist - \u5FFD\u7565 cascade"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u7C7B\u540D\u4E0D\u80FD\u91CD\u590D"})}),"\n",(0,r.jsxs)(n.li,{children:["\u4E0D\u652F\u6301\u591A\u6001 ",(0,r.jsx)(n.a,{href:"https://github.com/mikro-orm/mikro-orm/issues/706",children:"#706"})]}),"\n",(0,r.jsxs)(n.li,{children:["ManyToOne join \u5FC5\u987B\u4E3A\u4E3B\u952E ",(0,r.jsx)(n.a,{href:"https://github.com/mikro-orm/mikro-orm/issues/593",children:"#593"})]}),"\n",(0,r.jsxs)(n.li,{children:["join \u5217\u4E0D\u80FD\u91CD\u590D\u5B9A\u4E49\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4F8B\u5982 user, userId \u4E0D\u80FD\u540C\u65F6\u5B58\u5728"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u4E0D\u80FD\u914D\u5408 ts-mixer\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u8003\u8651\u5229\u7528 EntitySchema \u505A mixin"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/mikro-orm/mikro-orm/discussions/5371",children:"https://github.com/mikro-orm/mikro-orm/discussions/5371"})}),"\n"]}),"\n"]}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// \u8BA9 user \u548C userId \u540C\u65F6\u5B58\u5728\n@Property({ persist: false })\nget userId(): string {\n  return this.user.id;\n}\n"})}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5168\u5C40 filter ",(0,r.jsx)(n.a,{href:"https://github.com/mikro-orm/mikro-orm/issues/3009",children:"#3009"})]}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const filters = em.applyFilters('EntityName', {}, {}, 'read');\nqb.andWhere(filters);\n"})})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# mongodb, mysql, mariadb, sqlite\nnpm add @mikro-orm/core @mikro-orm/postgresql\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",metastring:'title="tsconfig.json"',children:'{\n  "experimentalDecorators": true,\n  "emitDecoratorMetadata": true,\n  "esModuleInterop": true\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import type { PostgreSqlDriver } from '@mikro-orm/postgresql'; // or any other driver package\nimport { EntityManager } from '@mikro-orm/postgresql';\n\nconst orm = await MikroORM.init<PostgreSqlDriver>({\n  // \u81EA\u52A8\u53D1\u73B0 - \u4E0D\u63A8\u8350\n  // entities: ['./dist/entities'], // path to our JS entities (dist), relative to `baseDir`\n  // entitiesTs: ['./src/entities'], // path to our TS entities (src), relative to `baseDir`\n  // entities: ['./dist/app/**/entities'],\n  // entitiesTs: ['./src/app/**/entities'],\n  // entities: ['./dist/app/**/entities/*.entity.js'],\n  // entitiesTs: ['./src/app/**/entities/*.entity.ts'],\n\n  // \u624B\u52A8\u914D\u7F6E\n  entities: [Author, Book, BookTag, Publisher, Test],\n  discovery: { disableDynamicFileAccess: true },\n\n  dbName: 'my-db-name',\n  type: 'postgresql',\n});\nconst em = orm.em as EntityManager;\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://mikro-orm.io/docs/configuration#using-environment-variables",children:"https://mikro-orm.io/docs/configuration#using-environment-variables"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm add -D @mikro-orm/cli\n# mikro-orm.config.js\nnpx mikro-orm\n\nmikro-orm generate-entities\n\n# by dlx\npnpm --package=@mikro-orm/cli dlx mikro-orm\n\nNODE_OPTIONS='--loader tsx' pnpm mikro-orm generate-entities --schema public -p ./src/server/db/entities/ -d\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["mikro-orm.config.ts\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4F9D\u8D56 ts-node"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"export type MinimalOptionalEntityFields =\n  | 'id'\n  | 'uid'\n  | 'createdAt'\n  | 'updatedAt'\n  | 'sid'\n  | 'tid'\n  | 'attributes'\n  | 'properties'\n  | 'extensions';\n\n@Entity({ abstract: true })\nexport abstract class MinimalBaseEntity<Entity extends MinimalBaseEntity<any>> extends BaseEntity<Entity, 'id'> {\n  // \u5728\u5B50\u7C7B\u4E2D\u5B9A\u4E49 - Base \u91CC\u7684\u5B9A\u4E49\u65E0\u6CD5\u8986\u76D6\n  [OptionalProps]?: MinimalOptionalEntityFields;\n\n  @PrimaryKey({ type: 'text', defaultRaw: 'public.gen_ulid()' })\n  id!: string;\n\n  //@PrimaryKey({ type: 'uuid', defaultRaw: 'uuid_generate_v4()' })\n  @PrimaryKey({ type: 'uuid', defaultRaw: 'gen_random_uuid()' })\n  uid!: string;\n\n  @Property()\n  createdAt: Date = new Date();\n\n  @Property({ type: 'timestamptz', defaultRaw: 'current_timestamp' })\n  createdAt!: Date;\n\n  @Property({ onUpdate: () => new Date() })\n  updatedAt: Date = new Date();\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"sti",children:"STI"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"STI -> Single Table Inheritance \u5355\u8868\u7EE7\u627F"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"@Entity({\n  discriminatorColumn: 'type',\n  // discriminatorMap: { person: 'Person', employee: 'Employee' },\n  // discriminatorValue: 'person',\n  abstract: true, // discriminatorMap \u4E0D\u5305\u542B\u81EA\u5DF1\n})\nexport class BasePerson {\n  @Enum()\n  type!: 'person' | 'employee';\n}\n@Entity({\n  discriminatorValue: 'person',\n})\nexport class Person extends BasePerson {\n  // ...\n}\n@Entity({\n  discriminatorValue: 'employee',\n})\nexport class Employee extends BasePerson {}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://mikro-orm.io/docs/inheritance-mapping#single-table-inheritance",children:"https://mikro-orm.io/docs/inheritance-mapping#single-table-inheritance"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"collection",children:"Collection"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"interface Collection<T> {\n  load(): Promise<this>;\n  loadItems(): Promise<T[]>;\n  loadCount(): Promise<number>;\n\n  matching(cond: FilterQuery<T>): this;\n\n  getItems(): T[];\n\n  add(...items: T[]): this;\n  remove(...items: T[]): this;\n  contains(item: T): boolean;\n  count(): number;\n\n  // \u6570\u7EC4\n  slice(start?: number, end?: number): T[];\n  exists(cb: (item: T) => boolean): boolean;\n  find(cb: (item: T, index: number) => boolean): T | undefined;\n  filter(cb: (item: T, index: number) => boolean): T[];\n  map<R>(mapper: (item: T, index: number) => R): R[];\n  indexBy<K extends keyof T>(prop: K): Record<string, T>;\n\n  shouldPopulate(populated?: boolean): boolean;\n  populated(populated?: boolean): boolean;\n  init(): Promise<this>;\n\n  toJSON(): any;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"requestcontext",children:"RequestContext"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Middleware ",(0,r.jsx)(n.code,{children:"RequestContext.create(orm.em, next)"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"relationships",children:"Relationships"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://mikro-orm.io/docs/relationships",children:"https://mikro-orm.io/docs/relationships"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"metadata",children:"Metadata"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["MetadataStorage\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Key ->EntityMetadata"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"key = entity && path ? entity + '-' + Utils.hash(path) : null"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Utils.lookupPathFromDecorator\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u83B7\u53D6 Decorator \u8C03\u7528\u7684 path"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// true\nDemoEntity.prototype.__entity;\n// boolean\nDemoEntity.prototype.__baseEntity;\n// EntityMetadata\nDemoEntity.prototype.__meta;\nDemoEntity.prototype.__config;\nDemoEntity.prototype.__platform;\nDemoEntity.prototype.__factory;\nDemoEntity.prototype.__helper;\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"MetadataStorage.getMetadataFromDecorator(UserEntity);\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// @Entity\nexport function Entity(options: EntityOptions<any> = {}) {\n  return function <T>(target: T & Dictionary) {\n    const meta = MetadataStorage.getMetadataFromDecorator(target);\n    Utils.mergeConfig(meta, options);\n    meta.class = target as unknown as Constructor<T>;\n\n    if (!options.abstract || meta.discriminatorColumn) {\n      meta.name = target.name;\n    }\n\n    return target;\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"entity",children:"Entity"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u597D\u5904\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4F7F\u7528 class \u5B9A\u4E49 Entity"}),"\n",(0,r.jsx)(n.li,{children:"\u65B9\u4FBF setter/getter \u7B49\u8F85\u52A9\u65B9\u6CD5"}),"\n",(0,r.jsx)(n.li,{children:"\u4E0E\u5176\u4ED6 OOP \u8BED\u8A00\u8BED\u6CD5\u7C7B\u4F3C"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u574F\u5904\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4E0D\u65B9\u4FBF mixin \u548C reuse \u90E8\u5206\u5B9A\u4E49"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"entityschema",children:"EntitySchema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u597D\u5904\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u52A8\u6001\u5B9A\u4E49"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u590D\u7528\u5B57\u6BB5"}),"\n",(0,r.jsx)(n.li,{children:"mixin"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u574F\u5904\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9700\u8981\u91CD\u590D\u5B9A\u4E49\u4E00\u4E2A \u7C7B\u578B"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const schema = new EntitySchema({\n  tableName: 'myNewTable',\n  name: 'myNewTable',\n  properties: {\n    id: { primary: true, type: 'string' },\n    price: { type: 'number', nullable: true, columnType: 'float' },\n  },\n});\norm.discoverEntity(schema);\nem.create('myNewTable', { id: 'abc-123', price: 1.5 });\nawait em.flush();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"defineentity",children:"defineEntity"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"v6.5+"}),"\n",(0,r.jsx)(n.li,{children:"\u57FA\u4E8E EntitySchema, \u4F46\u540C\u65F6\u5B9A\u4E49 \u7C7B\u578B"}),"\n",(0,r.jsx)(n.li,{children:"\u4F7F\u7528\u7C7B\u4F3C zod \u7684 DSL"}),"\n",(0,r.jsx)(n.li,{children:"Virtual Propertie \u8FD8\u662F\u4F1A\u7528\u5230 class"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"migration",children:"Migration"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"MigrationRunner"}),"\n",(0,r.jsx)(n.li,{children:"umzug"}),"\n",(0,r.jsxs)(n.li,{children:["Migration\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u8C03\u7528 up/down"}),"\n",(0,r.jsx)(n.li,{children:"\u8C03\u7528 getQueries \u83B7\u53D6\u751F\u6210\u7684\u67E5\u8BE2"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"pnpm add -D @mikro-orm/cli\nnpx mikro-orm migration:create --initial\n\npnpm --package=@mikro-orm/cli dlx mikro-orm migration:create --initial\n"})}),"\n",(0,r.jsx)(n.h2,{id:"objecthydrator",children:"ObjectHydrator"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DB -> ORM"}),"\n",(0,r.jsx)(n.li,{children:"\u52A8\u6001\u7F16\u8BD1\u7684 Code"}),"\n"]})]})}function m(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},917776:function(e,n,i){i.d(n,{R:()=>o,x:()=>l});var t=i(7378);let r={},s=t.createContext(r);function o(e){let n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);