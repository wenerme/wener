"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["825740"],{294414:function(e,o,t){t.r(o),t.d(o,{frontMatter:()=>s,toc:()=>l,default:()=>h,metadata:()=>r,assets:()=>d,contentTitle:()=>i});var r=JSON.parse('{"id":"devops/web/haproxy/haproxy-cookbook","title":"HAProxy Cookbook & Useful Snippets","description":"Collection of useful HAProxy configuration snippets for common tasks like URL rewriting and header manipulation.","source":"@site/../notes/devops/web/haproxy/haproxy-cookbook.md","sourceDirName":"devops/web/haproxy","slug":"/devops/web/haproxy/cookbook","permalink":"/notes/devops/web/haproxy/cookbook","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/haproxy/haproxy-cookbook.md","tags":[{"inline":true,"label":"DevOps","permalink":"/notes/tags/dev-ops"},{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"HAProxy","permalink":"/notes/tags/ha-proxy"},{"inline":true,"label":"Snippets","permalink":"/notes/tags/snippets"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1770607102000,"frontMatter":{"title":"HAProxy Cookbook & Useful Snippets","tags":["DevOps","Web","HAProxy","Snippets"]},"sidebar":"docs","previous":{"title":"HAProxy \u914D\u7F6E","permalink":"/notes/devops/web/haproxy/conf"},"next":{"title":"HAProxy Data Plane","permalink":"/notes/devops/web/haproxy/dataplane"}}'),n=t(486106),a=t(917776);let s={title:"HAProxy Cookbook & Useful Snippets",tags:["DevOps","Web","HAProxy","Snippets"]},i="HAProxy Cookbook & Useful Snippets",d={},l=[{value:"URL Rewriting",id:"url-rewriting",level:2},{value:"Map Subdomain to Path",id:"map-subdomain-to-path",level:3},{value:"Header Manipulation",id:"header-manipulation",level:2},{value:"Update X-Forwarded-For",id:"update-x-forwarded-for",level:3},{value:"Strip Port from Host Header",id:"strip-port-from-host-header",level:3},{value:"Advanced Logic",id:"advanced-logic",level:2},{value:"Layer 7 Control",id:"layer-7-control",level:3},{value:"Logging",id:"logging",level:2}];function p(e){let o={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(o.header,{children:(0,n.jsx)(o.h1,{id:"haproxy-cookbook--useful-snippets",children:"HAProxy Cookbook & Useful Snippets"})}),"\n",(0,n.jsx)(o.p,{children:"Collection of useful HAProxy configuration snippets for common tasks like URL rewriting and header manipulation."}),"\n",(0,n.jsx)(o.h2,{id:"url-rewriting",children:"URL Rewriting"}),"\n",(0,n.jsx)(o.h3,{id:"map-subdomain-to-path",children:"Map Subdomain to Path"}),"\n",(0,n.jsxs)(o.p,{children:["Example: ",(0,n.jsx)(o.code,{children:"http://sub1.example.com/a/b/c"})," -> ",(0,n.jsx)(o.code,{children:"http://example.com/sub1/a/b/c"})]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-haproxy",children:"# Extract subdomain\nhttp-request set-var(req.rewrite_example) req.hdr(host),lower,regsub(\\.example\\.com$,) if { hdr_end(host) -i .example.com }\n\n# Set path to /subdomain/path\nhttp-request set-path /%[var(req.rewrite_example)]%[path] if { var(req.rewrite_example) -m found }\n\n# Forward to main domain\nhttp-request set-header Host example.com if { var(req.rewrite_example) -m found }\n"})}),"\n",(0,n.jsx)(o.h2,{id:"header-manipulation",children:"Header Manipulation"}),"\n",(0,n.jsx)(o.h3,{id:"update-x-forwarded-for",children:"Update X-Forwarded-For"}),"\n",(0,n.jsx)(o.p,{children:"Add client IP to the top of the list:"}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-haproxy",children:"acl h_xff_exists req.hdr(X-Forwarded-For) -m found\nhttp-request replace-header X-Forwarded-For (.*) %[src],1 if h_xff_exists\n"})}),"\n",(0,n.jsx)(o.h3,{id:"strip-port-from-host-header",children:"Strip Port from Host Header"}),"\n",(0,n.jsxs)(o.p,{children:["Example: ",(0,n.jsx)(o.code,{children:"www.domain.com:80"})," -> ",(0,n.jsx)(o.code,{children:"www.domain.com"})]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-haproxy",children:"http-request replace-value Host (.*):.* 1\n"})}),"\n",(0,n.jsx)(o.h2,{id:"advanced-logic",children:"Advanced Logic"}),"\n",(0,n.jsx)(o.h3,{id:"layer-7-control",children:"Layer 7 Control"}),"\n",(0,n.jsxs)(o.p,{children:["Refer to ",(0,n.jsx)(o.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#4-http-request",children:"HAProxy Documentation - http-request"}),"."]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-haproxy",children:"# Replace host suffix\nhttp-request replace-header Host (.*)[.]([^.])+[.]wode[.]co \\1.incos.wode.co if { hdr_end(host) -i .wode.co }\n\n# Set variables and headers based on host\nhttp-request set-var(req.xRawHost) req.hdr(host) if { hdr_end(host) -i .zhensi.wode.co }\nhttp-request set-var(req.xName) req.hdr(host),lower,regsub(([^.])\\.wode\\.co,\\1) if { hdr_end(host) -i .zhensi.wode.co }\nhttp-request set-header X-IncOS-Name req.xName if { var(req.xName) -m found }\nhttp-request set-header X-IncOS-Host req.xRawHost if { var(req.xRawHost) -m found }\n"})}),"\n",(0,n.jsx)(o.h2,{id:"logging",children:"Logging"}),"\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsx)(o.li,{children:(0,n.jsx)(o.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#8.2.4",children:"Custom Log Format"})}),"\n"]})]})}function h(e={}){let{wrapper:o}={...(0,a.R)(),...e.components};return o?(0,n.jsx)(o,{...e,children:(0,n.jsx)(p,{...e})}):p(e)}},917776:function(e,o,t){t.d(o,{R:()=>s,x:()=>i});var r=t(7378);let n={},a=r.createContext(n);function s(e){let o=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function i(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),r.createElement(a.Provider,{value:o},e.children)}}}]);