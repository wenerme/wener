"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["60587"],{20430:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>i,toc:()=>d,default:()=>a,metadata:()=>s,assets:()=>t,contentTitle:()=>o});var s=JSON.parse('{"id":"web/dev/turborepo","title":"turborepo","description":"- vercel/turborepo","source":"@site/../notes/web/dev/turborepo.md","sourceDirName":"web/dev","slug":"/web/dev/turborepo","permalink":"/notes/web/dev/turborepo","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/web/dev/turborepo.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1718394381000,"frontMatter":{"title":"turborepo"},"sidebar":"docs","previous":{"title":"turbopack","permalink":"/notes/web/dev/turbopack"},"next":{"title":"unminify","permalink":"/notes/web/dev/unminify"}}'),l=r(86106),c=r(17776);let i={title:"turborepo"},o="turborepo",t={},d=[{value:"Caching",id:"caching",level:2},{value:"Pipeline",id:"pipeline",level:2},{value:"turborepo-remote-cache",id:"turborepo-remote-cache",level:2},{value:"error hashing files: could not hash file package-lock.json",id:"error-hashing-files-could-not-hash-file-package-lockjson",level:2},{value:"No caches are enabled",id:"no-caches-are-enabled",level:2},{value:"turbo 2.0",id:"turbo-20",level:2}];function h(e){let n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"turborepo",children:"turborepo"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/vercel/turborepo",children:"vercel/turborepo"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u589E\u91CF\u6784\u5EFA"}),"\n",(0,l.jsx)(n.li,{children:"\u7C7B\u4F3C nx\uFF0C\u4F46\u652F\u6301\u591A package\uFF1B\u7C7B\u4F3C bazel"}),"\n",(0,l.jsx)(n.li,{children:"\u9002\u7528\u4E8E monorepo \u6784\u5EFA"}),"\n",(0,l.jsx)(n.li,{children:"\u652F\u6301\u7F13\u5B58\u3001\u4F9D\u8D56"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u7F13\u5B58\u76EE\u5F55\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"node_modules/.cache/turbo/<HASH>"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u9879\u76EE\u914D\u7F6E .turbo/config.json\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["teamid - ",(0,l.jsx)(n.code,{children:"team_XXX"})," - TURBO_TEAM"]}),"\n",(0,l.jsx)(n.li,{children:"apiurl - TURBO_API"}),"\n",(0,l.jsx)(n.li,{children:"TURBO_TOKEN"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"\u5168\u5C40 $XDG_CONFIG_HOME/turborepo/config.json"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"npx -y create-turbo@latest\ncd my-turborepo/\nnpm run dev\nnpm run build\n\n# \u6DFB\u52A0\u5230\u5DF2\u6709\u9879\u76EE\nnpm install turbo -D\n\n# \u8FD0\u884C\u5B9A\u4E49\u7684 pipeline\nturbo run build\nturbo run dev --parallel\nturbo run lint\n\n# vercel remote cache\nnpx turbo login\n# team remote cache\nnpx turbo login --sso-team=<team-slug>\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",metastring:'title="turbo.json"',children:'{\n  "$schema": "https://turborepo.org/schema.json",\n  "baseBranch": "origin/main"\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"starter"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["/apps/\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"web/"}),"\n",(0,l.jsx)(n.li,{children:"docs/"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["/packages/\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"ui/"}),"\n",(0,l.jsx)(n.li,{children:"config/ - eslint"}),"\n",(0,l.jsx)(n.li,{children:"tsconfig/"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"env"})}),"\n",(0,l.jsxs)(n.p,{children:["| env                              |\n| -------------------------------- | ------------------------------------- |\n| TURBO_API                        |\n| TURBO_TEAM                       |\n| TURBO_TOKEN                      | remote_cache \u6388\u6743                     |\n| TURBO_REMOTE_CACHE_SIGNATURE_KEY |\n| TURBO_HASH                       |\n| TURBO_REMOTE_ONLY                | ",(0,l.jsx)(n.code,{children:"--remote-only"})," - \u53EA\u4F7F\u7528 remote cache |\n| TURBO_FORCE                      | ",(0,l.jsx)(n.code,{children:"--force"}),"                             |\n| FORCE_COLOR                      |"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"flags"})}),"\n",(0,l.jsx)(n.p,{children:"flag | default | for\n---|---\n--env-mode | strict | \u73AF\u5883\u53D8\u91CF\u6A21\u5F0F: strict, loose"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["--env-mode=strict\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u53EA\u4F1A\u4F20\u9012\u5B9A\u4E49\u7684\u73AF\u5883\u53D8\u91CF\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"env"}),"\n",(0,l.jsx)(n.li,{children:"passThroughEnv"}),"\n",(0,l.jsx)(n.li,{children:"globalEnv"}),"\n",(0,l.jsx)(n.li,{children:"globalPassThroughEnv"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"caching",children:"Caching"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://turbo.build/repo/docs/core-concepts/caching",children:"https://turbo.build/repo/docs/core-concepts/caching"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"pipeline",children:"Pipeline"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7F13\u5B58\u8F93\u51FA\u7684\u6587\u4EF6\u548C\u547D\u4EE4\u6267\u884C\u7684\u8F93\u51FA"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:".turbo/run-<task>.log"})}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"node_modules/.cache/turbo"})," - \u5F88\u5FEB\u5C31\u4F1A\u53D8\u5F97 ",(0,l.jsx)(n.strong,{children:"\u975E\u5E38\u5927"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u73AF\u5883\u53D8\u91CF TURBO_HASH \u4F9D\u636E\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"inputs, package.json \u4E2D\u4F9D\u8D56, \u5185\u90E8\u4F9D\u8D56"}),"\n",(0,l.jsx)(n.li,{children:"\u4EFB\u52A1\u540D\u5B57"}),"\n",(0,l.jsx)(n.li,{children:"dependsOn"}),"\n",(0,l.jsx)(n.li,{children:"lockfile"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u7279\u6B8A\u4EFB\u52A1\u540D\u5B57\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"//#test"})," - ",(0,l.jsx)(n.code,{children:"turbo run test"})," \u5305\u542B root package.json \u7684 test \u4EFB\u52A1\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5982\u679C\u672A\u5728 pipeline \u4E2D\u5B9A\u4E49 ",(0,l.jsx)(n.code,{children:"test"})," \u8FD9\u5219\u53EA\u8FD0\u884C root \u7684 test \u4EFB\u52A1"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"turbo run build --force             # \u5F3A\u5236 - \u5FFD\u7565\u5B58\u5728\u7F13\u5B58\nturbo run dev --parallel --no-cache # \u4E0D\u7F13\u5B58\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "$schema": "https://turborepo.org/schema.json",\n  // hash \u4F1A\u7528\u5230 git \u4FE1\u606F\n  // \u9ED8\u8BA4 origin/master\n  "baseBranch": "origin/main",\n  // \u5168\u5C40\u4F9D\u8D56\n  "globalDependencies": ["Makefile", "package.json", "tsconfig.json", ".env"],\n  "pipeline": {\n    "build": {\n      // \u7F13\u5B58\u5185\u5BB9\n      // \u9ED8\u8BA4 ["dist/**", "build/**"]\n      "outputs": ["dist/**", "lib/**", ".next/**"],\n      // \u7F13\u5B58\u4F9D\u636E\n      // \u9ED8\u8BA4 [] - \u4EFB\u610F\u6587\u4EF6\u4FEE\u6539\u90FD\u4F1A\u91CD\u65B0\u8FD0\u884C\n      "inputs": ["Makefile", "package.json", "tsconfig.json", "src/**/*.ts", "src/**/*.tsx", "src/**/*.css"],\n      // \u7F13\u5B58\u4F9D\u8D56 ENV\n      "dependsOn": ["^build", "$SOME_ENV_VAR"],\n      // hash-only - \u53EA\u8F93\u51FA hash\n      // new-only - \u53EA\u8F93\u51FA \u65B0\u589E\n      // none - \u4E0D\u8F93\u51FA\n      "outputMode": "full",\n      // \u662F\u5426\u7F13\u5B58\n      "cache": true\n    },\n    "test": {\n      // \u53EA\u7F13\u5B58\u65E5\u5FD7\n      "outputs": [],\n      "dependsOn": ["build"]\n    },\n    "dev": {\n      // dev \u4E0D\u7F13\u5B58\n      "cache": false\n    }\n  },\n  // \u5168\u5C40\u4F9D\u8D56\n  "globalDependencies": ["$GITHUB_TOKEN", "tsconfig.json", ".env.*"]\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"turborepo-remote-cache",children:"turborepo-remote-cache"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Note"})}),"\n",(0,l.jsxs)(n.p,{children:["local \u5B58\u50A8\u4F1A\u6DFB\u52A0 /tmp \u524D\u7F00\u5230 STORAGE_PATH ",(0,l.jsx)(n.a,{href:"https://github.com/fox1t/turborepo-remote-cache/blob/main/src/plugins/remote-cache/storage/local.ts",children:"src/plugins/remote-cache/storage/local.ts"})]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker run \\\n  -v $PWD/cache:/cache --env-file=.env \\\n  -p 3000:3000 \\\n  --name turborepo-remote-cache ducktors/turborepo-remote-cache\n\n# npx \u542F\u52A8\n# npx turborepo-remote-cache\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-env",children:"# development\nNODE_ENV=production\nPORT=3000\nTURBO_TOKEN=\nLOG_LEVEL=info\n# s3\nSTORAGE_PROVIDER=local\nSTORAGE_PATH=/cache\nS3_ACCESS_KEY=\nS3_SECRET_KEY=\nS3_REGION=\nS3_ENDPOINT=\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# --api\nturbo run build --token=$TURBO_TOKEN\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",metastring:'title=".turbo/config.json"',children:'{\n  "teamId": "team_FcALQN9XEVbeJ1NjTQoS9Wup",\n  "apiUrl": "http://localhost:3000"\n}\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/ducktors/turborepo-remote-cache",children:"ducktors/turborepo-remote-cache"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"open-source implementation of the Turborepo custom remote cache server"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://turborepo.org/docs/core-concepts/remote-caching",children:"remote-caching"})}),"\n"]}),"\n",(0,l.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(n.h2,{id:"error-hashing-files-could-not-hash-file-package-lockjson",children:"error hashing files: could not hash file package-lock.json"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5982\u679C\u4ECE npm \u5207\u6362\u5230\u4E86 pnpm\uFF0C\u8FD8\u9700\u8981\u4FEE\u6539 package.json \u91CC\u7684 packageManager"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"no-caches-are-enabled",children:"No caches are enabled"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:'No caches are enabled. You can try "turbo login", "turbo link", or ensuring you are not passing --remote-only to enable caching'}),"\n"]}),"\n",(0,l.jsx)(n.h1,{id:"version",children:"Version"}),"\n",(0,l.jsx)(n.h2,{id:"turbo-20",children:"turbo 2.0"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u652F\u6301 watch \u6A21\u5F0F"}),"\n",(0,l.jsx)(n.li,{children:"\u652F\u6301 \u4EA4\u4E92\u5F0F \u547D\u4EE4 - \u4F8B\u5982 dev \u8FD9\u79CD"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"node_modules/.cache"})," -> ",(0,l.jsx)(n.code,{children:".turbo/cache"})]}),"\n",(0,l.jsx)(n.li,{children:"package.json \u8981\u6C42\u5B9A\u4E49 packageManager"}),"\n",(0,l.jsx)(n.li,{children:"pipeline -> tasks"}),"\n",(0,l.jsxs)(n.li,{children:["\u73AF\u5883\u53D8\u91CF\u9ED8\u8BA4 Strict Mode\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"--env-mode=strict"})}),"\n",(0,l.jsxs)(n.li,{children:["\u53EF\u80FD\u5BFC\u81F4\u4EE5\u524D\u7684\u73AF\u5883\u53D8\u91CF\u4E0D\u751F\u6548\uFF0C\u53EF\u4EE5\u8003\u8651\u4FEE\u6539\u4E3A ",(0,l.jsx)(n.code,{children:"--env-mode=loose"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"\u6240\u6709\u5305\u9ED8\u8BA4\u4F9D\u8D56 Workspace root"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"npx @turbo/codemod migrate\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://turbo.build/repo/docs/crafting-your-repository/upgrading",children:"https://turbo.build/repo/docs/crafting-your-repository/upgrading"})}),"\n"]})]})}function a(e={}){let{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}},17776:function(e,n,r){r.d(n,{R:()=>i,x:()=>o});var s=r(7378);let l={},c=s.createContext(l);function i(e){let n=s.useContext(c);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:i(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);