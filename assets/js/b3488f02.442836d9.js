"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["739947"],{315191:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>r,toc:()=>i,default:()=>d,metadata:()=>t,assets:()=>c,contentTitle:()=>o});var t=JSON.parse('{"id":"devops/kubernetes/app/k8s-consul","title":"Consul","description":"- Consul K8S \u4F7F\u7528\u573A\u666F","source":"@site/../notes/devops/kubernetes/app/k8s-consul.md","sourceDirName":"devops/kubernetes/app","slug":"/devops/kubernetes/app/k8s-consul","permalink":"/notes/devops/kubernetes/app/k8s-consul","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/app/k8s-consul.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1693122196000,"frontMatter":{"title":"Consul"},"sidebar":"docs","previous":{"title":"Kubernetest Application FAQ","permalink":"/notes/devops/kubernetes/app/k8s-app-faq"},"next":{"title":"Kubernetes Metrics & Monitoring","permalink":"/notes/devops/kubernetes/app/k8s-metric"}}'),l=s(486106),a=s(917776);let r={title:"Consul"},o="Consul",c={},i=[{value:"DNS",id:"dns",level:2},{value:"ACL",id:"acl",level:2}];function u(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"consul",children:"Consul"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/hashicorp/consul-k8s",children:"Consul K8S"})," \u4F7F\u7528\u573A\u666F\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u90E8\u7F72 Consul \u96C6\u7FA4\u670D\u52A1"}),"\n",(0,l.jsx)(n.li,{children:"\u5141\u8BB8 Consol \u5BA2\u6237\u7AEF\u6253\u901A\u670D\u52A1"}),"\n",(0,l.jsx)(n.li,{children:"Connect Service Mesh"}),"\n",(0,l.jsx)(n.li,{children:"\u540C\u6B65 K8S \u670D\u52A1\u5230 Consul"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"\u5B89\u88C5\u4F9D\u8D56 PV \u5B58\u50A8"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.consul.io/docs/k8s",children:"\u6587\u6863"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'helm repo add hashicorp https://helm.releases.hashicorp.com\n\n# \u9ED8\u8BA4\u90E8\u7F72    server client dns ui\n# \u9ED8\u8BA4\u4E0D\u90E8\u7F72 tls acl federation externalService snapshotAgent syncCatalog\n#   connectInject centralConfig meshGateway ingressGateways terminatingGateways\n# \u9ED8\u8BA4 datacenter \u4E3A dc1\n# \u5B89\u88C5\u5230 service \u7A7A\u95F4\n# --set server.affinity=null \u5141\u8BB8\u5B89\u88C5\u5230\u5355\u673A\n# server.storageClass \u4FEE\u6539\u5B58\u50A8\u7C7B\u578B\nhelm install consul hashicorp/consul \\\n  -n consul --create-namespace \\\n  --set global.name=consul --set global.datacenter=center\n\n# \u8F6C\u53D1 UI\n# \u9ED8\u8BA4\u6CA1\u6709 tls \u548C acl\nkubectl port-forward -n consul svc/consul-server 8500:8500\n# \u5982\u679C\u542F\u7528\u4E86 ACL\nkubectl get -n consul secrets/consul-bootstrap-acl-token --template={{.data.token}} | base64 -d\n\n# \u8BBF\u95EE consul\n# \u6BCF\u4E2A\u8282\u70B9\u90FD\u6709 agent \u56E0\u6B64\u76F4\u63A5\u4F7F\u7528 HOST_IP \u5373\u53EF\nexport CONSUL_HTTP_ADDR="${HOST_IP}:8500"\nconsul kv put hello world\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"env:\n  - name: ADVERTISE_IP\n    valueFrom:\n      fieldRef:\n        fieldPath: status.podIP\n  - name: NAMESPACE\n    valueFrom:\n      fieldRef:\n        fieldPath: metadata.namespace\n  - name: NODE\n    valueFrom:\n      fieldRef:\n        fieldPath: status.nodeName\n  - name: HOST_IP\n    valueFrom:\n      fieldRef:\n        fieldPath: status.hostIP\n  - name: CONSUL_HTTP_ADDR\n    value: $(HOST_IP):8500\n"})}),"\n",(0,l.jsx)(n.h2,{id:"dns",children:"DNS"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# KubeDNS\n# ==========\nCONSUL_DNS_IP=$(kubectl get svc consul-dns -o jsonpath=\'{.spec.clusterIP}\' -n service)\ncat << EOF | kubectl apply -f -\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: EnsureExists\n  name: kube-dns\n  namespace: kube-system\ndata:\n  stubDomains: |\n    {"consul": ["$CONSUL_DNS_IP"]}\nEOF\n\nkubectl get configmap kube-dns -n kube-system -o yaml\n\n# CoreDNS\n# ==========\nkubectl edit configmap coredns -n kube-system\n# Corefile: |\n#   consul {\n#     errors\n#     cache 30\n#     forward . <consul-dns-service-cluster-ip>\n#   }\n\n# \u6D4B\u8BD5\u89E3\u6790\nkubectl run --rm -i -t dns-test --image=wener/base --restart=Never -- nslookup consul.service.consul\n'})}),"\n",(0,l.jsx)(n.h2,{id:"acl",children:"ACL"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.consul.io/docs/security/acl/auth-methods/kubernetes",children:"Kubernetes Auth Method"})}),"\n"]})]})}function d(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(u,{...e})}):u(e)}},917776:function(e,n,s){s.d(n,{R:()=>r,x:()=>o});var t=s(7378);let l={},a=t.createContext(l);function r(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);