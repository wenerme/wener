"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["41409"],{68545:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>a,toc:()=>c,default:()=>u,metadata:()=>s,assets:()=>i,contentTitle:()=>r});var s=JSON.parse('{"id":"devops/infra/ansible/ansible-cookbook","title":"Ansible Cookbook","description":"\u52A8\u6001\u53D8\u91CF","source":"@site/../notes/devops/infra/ansible/ansible-cookbook.md","sourceDirName":"devops/infra/ansible","slug":"/devops/infra/ansible/cookbook","permalink":"/notes/devops/infra/ansible/cookbook","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/infra/ansible/ansible-cookbook.md","tags":[{"inline":true,"label":"Cookbook","permalink":"/notes/tags/cookbook"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1693463269000,"frontMatter":{"title":"Ansible Cookbook","tags":["Cookbook"]},"sidebar":"docs","previous":{"title":"Ansible Collection","permalink":"/notes/devops/infra/ansible/collection"},"next":{"title":"Ansible FAQ","permalink":"/notes/devops/infra/ansible/faq"}}'),o=t(86106),l=t(17776);let a={title:"Ansible Cookbook",tags:["Cookbook"]},r="Ansible Cookbook",i={},c=[{value:"\u52A8\u6001\u53D8\u91CF",id:"\u52A8\u6001\u53D8\u91CF",level:2},{value:"\u6279\u91CF\u6A21\u7248",id:"\u6279\u91CF\u6A21\u7248",level:2},{value:"\u5BC6\u7801\u751F\u6210",id:"\u5BC6\u7801\u751F\u6210",level:2},{value:"\u4E34\u65F6\u6587\u4EF6\u5B58\u50A8\u6A21\u677F",id:"\u4E34\u65F6\u6587\u4EF6\u5B58\u50A8\u6A21\u677F",level:2},{value:"\u7B49\u5F85\u547D\u4EE4\u6210\u529F",id:"\u7B49\u5F85\u547D\u4EE4\u6210\u529F",level:2}];function d(e){let n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"ansible-cookbook",children:"Ansible Cookbook"})}),"\n",(0,o.jsx)(n.h2,{id:"\u52A8\u6001\u53D8\u91CF",children:"\u52A8\u6001\u53D8\u91CF"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"- name: Render deployment templates\n  set_fact:\n    '{{ item }}': \"{{ lookup('template', item + '.yml.j2') }}\"\n  with_items:\n    - 'configmap'\n    - 'secret'\n    - 'deployment'\n    - 'supervisor'\n    - 'launch_awx'\n  no_log: true\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u6279\u91CF\u6A21\u7248",children:"\u6279\u91CF\u6A21\u7248"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"- name: create x template\n  template:\n    src: '{{item}}'\n    dest: /tmp/{{ item | basename | regex_replace('\\.j2','') }}\n  with_fileglob:\n    - ../templates/*.j2\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u5BC6\u7801\u751F\u6210",children:"\u5BC6\u7801\u751F\u6210"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"lookup('password', 'credentials/db.passwd length=8 chars=digits')"})," - \u8BFB\u53D6\u6216\u968F\u673A\u751F\u6210\u5BC6\u7801"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"# \u751F\u6210\u5BC6\u7801\u4E14\u4E0D\u8BB0\u5F55\n- name: Generate broadcast websocket secret\n  set_fact:\n    broadcast_websocket_secret: \"{{ lookup('password', '/dev/null length=128') }}\"\n  run_once: true\n  no_log: true\n  when: broadcast_websocket_secret is not defined\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u4E34\u65F6\u6587\u4EF6\u5B58\u50A8\u6A21\u677F",children:"\u4E34\u65F6\u6587\u4EF6\u5B58\u50A8\u6A21\u677F"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"- name: Create Temporary Values File (Kubernetes)\n  tempfile:\n    state: file\n    suffix: .yml\n  register: values_file\n\n- name: Populate Temporary Values File (Kubernetes)\n  template:\n    # \u4F1A\u76F4\u63A5\u4F7F\u7528\u6A21\u7248\u76EE\u5F55\u4E0B\u6587\u4EF6\n    src: postgresql-values.yml.j2\n    dest: '{{ values_file.path }}'\n  no_log: true\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u7B49\u5F85\u547D\u4EE4\u6210\u529F",children:"\u7B49\u5F85\u547D\u4EE4\u6210\u529F"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'- name: Wait for management pod to start\n  shell: |\n    {{ kubectl_or_oc }} -n {{ kubernetes_namespace }} \\\n      get pod ansible-tower-management -o jsonpath="{.status.phase}"\n  register: result\n  # \u6761\u4EF6\n  until: result.stdout == "Running"\n  retries: 60\n  delay: 10\n'})})]})}function u(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},17776:function(e,n,t){t.d(n,{R:()=>a,x:()=>r});var s=t(7378);let o={},l=s.createContext(o);function a(e){let n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);