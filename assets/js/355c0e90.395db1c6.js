"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["504970"],{475847:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>l,toc:()=>p,default:()=>d,metadata:()=>r,assets:()=>a,contentTitle:()=>s});var r=JSON.parse('{"id":"service/network/proxy/tproxy","title":"TProxy","description":"- \u900F\u660E\u4EE3\u7406 - \u8F6C\u53D1\u6D41\u91CF\u5230\u7ED9\u5B9A\u7AEF\u53E3","source":"@site/../notes/service/network/proxy/tproxy.md","sourceDirName":"service/network/proxy","slug":"/service/network/proxy/tproxy","permalink":"/notes/service/network/proxy/tproxy","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/network/proxy/tproxy.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1739157197000,"frontMatter":{"title":"TProxy"},"sidebar":"docs","previous":{"title":"Tor","permalink":"/notes/service/network/proxy/tor"},"next":{"title":"tuic","permalink":"/notes/service/network/proxy/tuic"}}'),i=n(486106),o=n(917776);let l={title:"TProxy"},s="TProxy",a={},p=[{value:"nftables",id:"nftables",level:2}];function c(e){let t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"tproxy",children:"TProxy"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"\u900F\u660E\u4EE3\u7406 - \u8F6C\u53D1\u6D41\u91CF\u5230\u7ED9\u5B9A\u7AEF\u53E3"}),"\n",(0,i.jsx)(t.li,{children:"\u652F\u6301 TCP, UDP"}),"\n",(0,i.jsx)(t.li,{children:"Linux 2.2+"}),"\n",(0,i.jsx)(t.li,{children:"Linux 4.18+ nf_tables"}),"\n",(0,i.jsx)(t.li,{children:"\u670D\u52A1\u652F\u6301: Squid, Envoy, HAProxy, Clash"}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://man7.org/linux/man-pages/man7/ip.7.html#:~:text=IP_TRANSPARENT%20(since%20Linux%202.6.24)",children:"IP_TRANSPARENT"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"\u5141\u8BB8\u4EE3\u7406\u7A0B\u5E8F\u63A5\u53D7\u539F\u672C\u4E0D\u5C5E\u4E8E\u672C\u673A IP \u7684\u8FDE\u63A5\uFF0C\u5E76\u83B7\u53D6\u6570\u636E\u5305\u4E2D\u7684\u539F\u59CB\u76EE\u6807\u5730\u5740\u4FE1\u606F\u3002"}),"\n",(0,i.jsx)(t.li,{children:"\u9700\u8981 CAP_NET_ADMIN \u6743\u9650"}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"getsockopt(SO_ORIGINAL_DST)"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.kernel.org/doc/Documentation/networking/tproxy.txt",children:"networking/tproxy.txt"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://blog.csdn.net/dog250/article/details/13161945",children:"https://blog.csdn.net/dog250/article/details/13161945"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://toutyrater.github.io/app/tproxy.html",children:"https://toutyrater.github.io/app/tproxy.html"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://gost.run/en/tutorials/redirect/#tproxy",children:"https://gost.run/en/tutorials/redirect/#tproxy"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://asphaltt.github.io/post/linux-how-tproxy-works/",children:"https://asphaltt.github.io/post/linux-how-tproxy-works/"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"#\nmodinfo xt_TPROXY\n\n# Legacy IPTables\niptables -t mangle -N DIVERT\niptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT\niptables -t mangle -A DIVERT -j MARK --set-mark 1\niptables -t mangle -A DIVERT -j TPROXY --on-port 1080\n\nip rule add fwmark 1 lookup 100\nip route add local 0.0.0.0/0 dev lo table 100\n\n# \u91CD\u5B9A\u5411\niptables -t mangle -A PREROUTING -p tcp --dport 50080 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 80\niptables -t mangle -A PREROUTING -p tcp -m multiport --dport 50080 -j REDIRECR --to-port 1234\n\niptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080\n\n#\niptables -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3128\n"})}),"\n",(0,i.jsx)(t.h2,{id:"nftables",children:"nftables"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"# enable forwarding\ncat /proc/sys/net/ipv4/ip_forward\n\n# \u521B\u5EFA\u65B0\u7684\u8DEF\u7531\u8868\u5E76\u8BBE\u7F6E\u8DEF\u7531\u89C4\u5219\necho 100 mytable >> /etc/iproute2/rt_tables\n\n# \u6DFB\u52A0\u8DEF\u7531\u89C4\u5219\uFF0C\u6307\u5B9A\u901A\u8FC7\u4EE3\u7406\u63A5\u53E3\u8F6C\u53D1\u6D41\u91CF\nip rule add fwmark 1 table mytable\nip route add default via 192.168.1.100 dev eth0 table mytable\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-nft",children:'# \u5141\u8BB8 IP \u900F\u660E\u4EE3\u7406\uFF08TProxy\uFF09\u6D41\u91CF\ntable inet filter {\n    chain input {\n        type filter hook input priority 0; policy accept;\n\n        # \u5141\u8BB8\u5230\u8FBE TProxy \u7684\u6D41\u91CF\uFF0C\u901A\u5E38\u4F1A\u662F\u4EE3\u7406\u7AEF\u53E3\uFF08\u5982 1080 \u6216\u5176\u4ED6\uFF09\n        ip daddr 0.0.0.0/0 tcp dport 1080 tproxy\n    }\n}\n\n# \u900F\u660E\u4EE3\u7406\u8F6C\u53D1\u6D41\u91CF\ntable ip nat {\n    chain prerouting {\n        type nat hook prerouting priority -100; policy accept;\n\n        # \u5C06\u6D41\u91CF\u91CD\u5B9A\u5411\u5230\u900F\u660E\u4EE3\u7406\u7AEF\u53E3\uFF08\u5982 1080\uFF09\n        iifname "eth0" ip daddr 0.0.0.0/0 tcp dport {80,443} counter tproxy to :1080\n    }\n}\n\n# \u8F6C\u53D1\u914D\u7F6E\ntable inet filter {\n    chain forward {\n        type filter hook forward priority 0; policy accept;\n\n        # \u5141\u8BB8\u900F\u660E\u4EE3\u7406\u8F6C\u53D1\n        ip protocol {tcp, udp} accept\n    }\n}\n'})})]})}function d(e={}){let{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},917776:function(e,t,n){n.d(t,{R:()=>l,x:()=>s});var r=n(7378);let i={},o=r.createContext(i);function l(e){let t=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);