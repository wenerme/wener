"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["15962"],{80467:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>t,toc:()=>a,default:()=>h,metadata:()=>r,assets:()=>i,contentTitle:()=>l});var r=JSON.parse('{"id":"db/document/mongo","title":"MongoDB","description":"- \u7BA1\u7406\u5DE5\u5177\u5217\u8868","source":"@site/../notes/db/document/mongo.md","sourceDirName":"db/document","slug":"/db/document/mongo","permalink":"/notes/db/document/mongo","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/document/mongo.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1672817159000,"frontMatter":{"title":"MongoDB"},"sidebar":"docs","previous":{"title":"FerretDB","permalink":"/notes/db/document/ferretdb"},"next":{"title":"RethinkDB","permalink":"/notes/db/document/rethinkdb"}}'),d=s(86106),o=s(17776);let t={title:"MongoDB"},l="MongoDB",i={},a=[{value:"Operaters",id:"operaters",level:2},{value:"\u7D22\u5F15\u7BA1\u7406",id:"\u7D22\u5F15\u7BA1\u7406",level:3},{value:"\u89D2\u8272\u6743\u9650\u7BA1\u7406",id:"\u89D2\u8272\u6743\u9650\u7BA1\u7406",level:3},{value:"\u66F4\u65B0\u65E0\u6CD5\u5F15\u7528\u5F53\u524D\u503C",id:"\u66F4\u65B0\u65E0\u6CD5\u5F15\u7528\u5F53\u524D\u503C",level:3},{value:"parameters",id:"parameters",level:3},{value:"Versions",id:"versions",level:2},{value:"3.2",id:"32",level:3},{value:"FAQ",id:"faq",level:2},{value:"\u542F\u52A8",id:"\u542F\u52A8",level:3}];function c(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...n.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(e.header,{children:(0,d.jsx)(e.h1,{id:"mongodb",children:"MongoDB"})}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/ecosystem/tools/administration-interfaces/",children:"\u7BA1\u7406\u5DE5\u5177\u5217\u8868"})}),"\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.a,{href:"https://github.com/rsercano/mongoclient",children:"mongoclient"})," \u57FA\u4E8E Web \u7684\u7BA1\u7406\u5DE5\u5177"]}),"\n",(0,d.jsxs)(e.li,{children:["Reference\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/reference/mongo-shell/",children:"mongo-shell"})}),"\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/reference/connection-string/",children:"Connection String"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.code,{children:"mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:"authSource \u4F7F\u7528\u4E0D\u540C\u7684\u5E93\u505A\u6388\u6743"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsxs)(e.li,{children:["\u5EFA\u6A21\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://www.mongodb.com/blog/post/6-rules-of-thumb-for-mongodb-schema-design-part-1",children:"6 Rules of Thumb for MongoDB Schema Design"})}),"\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/data-modeling/",children:"Data Model"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/applications/data-models/",children:"Data Model Examples and Patterns"})}),"\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/reference/database-references/",children:"DBRef"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/reference/glossary",children:"Glossary"})}),"\n",(0,d.jsxs)(e.li,{children:["FAQ\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:"Java \u76EE\u524D\u65E0\u6CD5\u901A\u8FC7 SSH \u8F6C\u53D1\u94FE\u63A5 ReplicaSet"}),"\n",(0,d.jsxs)(e.li,{children:["DBRef \u7684 ",(0,d.jsx)(e.code,{children:"$ref"})," \u5FC5\u987B\u8981\u5728 ",(0,d.jsx)(e.code,{children:"$id"})," \u4E4B\u524D"]}),"\n",(0,d.jsx)(e.li,{children:"SSH \u8F6C\u53D1 Mongo \u53EF\u80FD\u4F1A\u5BFC\u81F4\u94FE\u63A5\u4E0D\u4F1A\u88AB\u91CA\u653E"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:'# \u5728\u524D\u53F0\u542F\u52A8\n# \u6570\u636E\u5B58\u50A8\u5230 ~/data/mgo\n# Ctrl-C \u505C\u6B62\ndocker run --rm -it -p 27017:27017 --name my-mongo -v ~/data/mgo:/data/db mongo\n# \u53E6\u5916\u4E00\u4E2A\u7EC8\u7AEF\u8FDE\u63A5\u5230\u670D\u52A1\u7AEF\nmongo\n\n# https://docs.mongodb.com/manual/reference/program/mongodump/\n# \u5BFC\u51FA\u4E00\u4E2A\u5E93\nmongodump -v --db test --host myhost --port 27017 --out mg-$(date +%Y%m%d)\n# \u5BFC\u5165\u4E00\u4E2A\u5E93\nmongorestore -v --db test --host myhost --port 27017 mg-$(date +%Y%m%d)/db\n# \u4F7F\u7528 URI \u53C2\u6570\nmongodump -v --uri mongodb://root:pass@host:27017/dbname?authSource=admin\n\n# \u5BFC\u51FA json\nmongoexport --db db-name --collection collection-name --out exp.json\n\nmongoexport -h localhost -d databse -c collection --csv \\\n  --fields erpNum,orderId,time,status \\\n  -q \'{"time":{"$gt":1438275600000}, "status":{"$ne" :"Cancelled"}}\' \\\n  --out report.csv\n'})}),"\n",(0,d.jsx)(e.h2,{id:"operaters",children:"Operaters"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/reference/operator/",children:"https://docs.mongodb.com/manual/reference/operator/"})}),"\n",(0,d.jsxs)(e.li,{children:["FAQ\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsxs)(e.li,{children:["ObjectId \u8F6C\u5B57\u7B26\u4E32\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsxs)(e.li,{children:["\u4F7F\u7528 ",(0,d.jsx)(e.code,{children:"str"})," \u5C5E\u6027, \u4E0D\u8981\u4F7F\u7528 ",(0,d.jsx)(e.code,{children:"toString"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-js",children:'disableTelemetry()\ndb.disableFreeMonitoring()\n\n// \u67E5\u770B\u670D\u52A1\u72B6\u6001\ndb.serverStatus()\n// \u67E5\u770B\u96C6\u5408\u72B6\u6001\ndb.list.stats()\n\n// \u67E5\u8BE2\ndb.users.find({});\n// \u8981\u6C42\u67D0\u4E2A\u5B57\u6BB5\u4E3A null\ndb.users.find({name:null});\n// \u5B57\u6BB5\u4E0D\u4E3A null\ndb.users.find({name:{$ne:null});\n// \u5B57\u6BB5\u5B58\u5728\ndb.users.find({name:{$exists:true});\n// \u8FD4\u56DE id \u548C name \u5B57\u6BB5\ndb.users.find({}, {name:1});\n// \u53EA\u8FD4\u56DE name \u5B57\u6BB5, \u5E76\u505A explain\ndb.users.find({}, {_id:0, name:1}).explain()\n// \u8981\u6C42\u7C7B\u578B\u4E3A string\n// https://docs.mongodb.com/manual/reference/operator/query/type/#op._S_type\ndb.users.find({name:{$type:2});\n// \u8FD4\u56DE\u4E00\u7EC4\u5B57\u7B26\u4E32\ndb.users.find().snapshot().forEach((e) => {\n    print(e._id.str)\n});\n// \u65E5\u671F\u67E5\u8BE2\ndb.users.find({\n    "birth" : {"$gte": new Date("2013-10-01T00:00:00.000Z")},\n    "regDate" : {"$gte": ISODate("2013-10-01T00:00:00.000Z")}\n});\n// \u5B8C\u6574\u7684\u67E5\u8BE2\ndb.books.find({publishDate:{$gt:ISODate(\'2017-09-14 10:49:47.132Z\')}}).sort({publishDate:1}).limit(1)\n\n// \u90E8\u5206\u66F4\u65B0\u5355\u6761\ndb.users.update({name:null},{$set:{name:"UNKNOWN"}});\n// \u90E8\u5206\u66F4\u65B0\u591A\u6761\ndb.users.updateMany({name:null},{$set:{name:"UNKNOWN"}});\n// \u4F7F\u7528 DBRef\ndb.users.update({role:null},{$set:{role:{"$ref" : "roles","$id" : ObjectId("598041d5e90a5d1e23d4518e")}}});\n// \u5728\u6570\u7EC4\u6700\u540E\u6DFB\u52A0\u4E00\u4E2A\u503C\ndb.students.update({_id: 1},{ $set: { "grades.$" : 82 } });\n// \u4FEE\u6539\u6570\u7EC4\u4E2D\u5BF9\u8C61\u503C\ndb.students.update({_id: 1},{ $set: { "grades.$.std" : 79 } });\n\ndb.collection.find().sort({age:-1}).limit(1) // for MAX\ndb.collection.find().sort({age:+1}).limit(1) // for MIN\n\n// \u67E5\u627E\u91CD\u590D\u7684 id\ndb.list.aggregate([\n	{\n		$group: {\n			_id: {cid: "$cid"},\n			uniqueIds: {$addToSet: "$_id"},\n			count: {$sum: 1}\n		}\n	},\n	{\n		$match: {\n			count: {"$gt": 1}\n		}\n	},\n	{\n		$sort: {\n			count: -1\n		}\n	}\n]);\n// \u5220\u9664\u91CD\u590D\u6570\u636E\n// .forEach(v=>{v.uniqueIds.pop();db.list.remove({\'_id\':{\'$in\':v.uniqueIds}})})\n\n// \u67E5\u627E\u4E0D\u4E3A\u7A7A\u7684\u5BF9\u8C61\ndb.col.find({\'score.user\': { "$gt": {}}});\n'})}),"\n",(0,d.jsx)(e.h3,{id:"\u7D22\u5F15\u7BA1\u7406",children:"\u7D22\u5F15\u7BA1\u7406"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-js",children:"// \u521B\u5EFA\u552F\u4E00\u7D22\u5F15\ndb.list.createIndex({ cid: -1 }, { name: 'cid_unique', unique: true });\n\n// \u83B7\u53D6\u7D22\u5F15\ndb.list.getIndexes();\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u89D2\u8272\u6743\u9650\u7BA1\u7406",children:"\u89D2\u8272\u6743\u9650\u7BA1\u7406"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/tutorial/enable-authentication/",children:"https://docs.mongodb.com/manual/tutorial/enable-authentication/"})}),"\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/",children:"https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/"})}),"\n",(0,d.jsxs)(e.li,{children:["\u542F\u52A8\u65F6\u9700\u8981 ",(0,d.jsx)(e.code,{children:"--auth"})," \u6765\u542F\u7528\u6388\u6743, \u6216\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u52A0 ",(0,d.jsx)(e.code,{children:"security.authorization"})," \u914D\u7F6E"]}),"\n",(0,d.jsxs)(e.li,{children:["\u5167\u5EFA\u89D2\u8272\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:"\u6570\u636E\u5E93\u7528\u6237: read,readWrite"}),"\n",(0,d.jsx)(e.li,{children:"\u6570\u636E\u5E93\u7BA1\u7406\u5458: dbAdmin, dbOwner, userAdmin"}),"\n",(0,d.jsx)(e.li,{children:"\u96C6\u7FA4\u7BA1\u7406: clusterAdmin, clusterManager, clusterMonitor, hostManager"}),"\n",(0,d.jsx)(e.li,{children:"\u5907\u4EFD\u6062\u590D: backup, restore"}),"\n",(0,d.jsx)(e.li,{children:"\u6240\u6709\u6570\u636E\u5E93: readAnyDatabase, readWriteAnyDatabase, userAdminAnyDatabase, dbAdminAnyDatabase"}),"\n",(0,d.jsxs)(e.li,{children:["\u8D85\u7EA7\u7BA1\u7406\u5458\u89D2\u8272: root\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:"readWriteAnyDatabase, dbAdminAnyDatabase, userAdminAnyDatabase, clusterAdmin, restore, backup"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/v3.0/reference/method/js-user-management/",children:"https://docs.mongodb.com/v3.0/reference/method/js-user-management/"})}),"\n"]}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-js",children:"// use admin;\n// \u521B\u5EFA\u7BA1\u7406\u5458\ndb.createUser({\n  user: 'admin',\n  pwd: 'abc123',\n  roles: [{ role: 'userAdminAnyDatabase', db: 'admin' }],\n});\ndb.changeUserPassword('admin', 'myPassword');\ndb.getUser('admin');\ndb.getUsers();\n\ndb.getRole('read', { showPrivileges: true });\n\n// root \u6743\u9650\ndb.grantRolesToRole('admin', ['root']);\n// \u6307\u5B9A\u5230\u67D0\u4E2A\u5E93\ndb.grantRolesToRole('admin', [{ role: 'readWrite', db: 'list' }]);\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u66F4\u65B0\u65E0\u6CD5\u5F15\u7528\u5F53\u524D\u503C",children:"\u66F4\u65B0\u65E0\u6CD5\u5F15\u7528\u5F53\u524D\u503C"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-js",children:"// \u4FEE\u6539\u6587\u6863\u7ED3\u6784, \u4E0D\u6539\u53D8\u503C\ndb.events\n  .find()\n  .snapshot()\n  .forEach(function (e) {\n    // update document, using its own properties\n    e.coords = { lat: e.lat, lon: e.lon };\n\n    // remove old properties\n    delete e.lat;\n    delete e.lon;\n\n    // save the updated document\n    db.events.save(e);\n  });\n"})}),"\n",(0,d.jsx)(e.h3,{id:"parameters",children:"parameters"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/v3.4/reference/parameters/",children:"https://docs.mongodb.com/v3.4/reference/parameters/"})}),"\n"]}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-js",children:"db.adminCommand({ setParameter: 1, disableJavaScriptJIT: true });\n"})}),"\n",(0,d.jsx)(e.h2,{id:"versions",children:"Versions"}),"\n",(0,d.jsx)(e.h3,{id:"32",children:"3.2"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:(0,d.jsx)(e.a,{href:"https://docs.mongodb.com/manual/release-notes/3.2/",children:"https://docs.mongodb.com/manual/release-notes/3.2/"})}),"\n",(0,d.jsxs)(e.li,{children:["js\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsx)(e.li,{children:"V8 \u66F4\u6539\u4E3A SpiderMonkey"}),"\n",(0,d.jsx)(e.li,{children:"arrow functions"}),"\n",(0,d.jsx)(e.li,{children:"destructuring assignment"}),"\n",(0,d.jsx)(e.li,{children:"for-of loops"}),"\n",(0,d.jsx)(e.li,{children:"generators"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(e.h2,{id:"faq",children:"FAQ"}),"\n",(0,d.jsx)(e.h3,{id:"\u542F\u52A8",children:"\u542F\u52A8"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"mongod --config ./mongo.conf --fork\n"})}),"\n",(0,d.jsx)(e.p,{children:(0,d.jsx)(e.strong,{children:"mongod.conf"})}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-yaml",children:"# https://docs.mongodb.com/manual/reference/configuration-options/\nsystemLog:\n  destination: file\n  path: mongo.log\n  logAppend: true\nstorage:\n  dbPath: . # \u6570\u636E\u5B58\u50A8\u4E8E\u5F53\u524D\u76EE\u5F55\nnet:\n  bindIp: 127.0.0.1\n"})})]})}function h(n={}){let{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,d.jsx)(e,{...n,children:(0,d.jsx)(c,{...n})}):c(n)}},17776:function(n,e,s){s.d(e,{R:()=>t,x:()=>l});var r=s(7378);let d={},o=r.createContext(d);function t(n){let e=r.useContext(o);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(d):n.components||d:t(n.components),r.createElement(o.Provider,{value:e},n.children)}}}]);