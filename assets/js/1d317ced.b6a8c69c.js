"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["996530"],{358331:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>o,toc:()=>c,default:()=>u,metadata:()=>t,assets:()=>l,contentTitle:()=>a});var t=JSON.parse('{"id":"service/observability/metrics/prometheus/promql","title":"PromQL","description":"- PromQL","source":"@site/../notes/service/observability/metrics/prometheus/promql.md","sourceDirName":"service/observability/metrics/prometheus","slug":"/service/observability/metrics/prometheus/promql","permalink":"/notes/service/observability/metrics/prometheus/promql","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/observability/metrics/prometheus/promql.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1757294976000,"frontMatter":{"title":"PromQL"},"sidebar":"docs","previous":{"title":"TSDB","permalink":"/notes/service/observability/metrics/prometheus/tsdb"},"next":{"title":"promxy","permalink":"/notes/service/observability/metrics/promxy"}}'),r=s(486106),i=s(917776);let o={title:"PromQL"},a="PromQL",l={},c=[{value:"\u5E38\u7528",id:"\u5E38\u7528",level:2},{value:"irate vs rate",id:"irate-vs-rate",level:2}];function m(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"promql",children:"PromQL"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://prometheus.io/docs/prometheus/latest/querying/basics/",children:"PromQL"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://prometheus.io/docs/prometheus/latest/querying/examples/",children:"QUERY EXAMPLES"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://medium.com/@valyala/9ab455142085",children:"PromQL tutorial for beginners and humans"})}),"\n",(0,r.jsxs)(n.li,{children:["\u652F\u6301 PromQL \u7684\u5E94\u7528\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/VictoriaMetrics/VictoriaMetrics",children:"VictoriaMetrics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"long-term remote storage for Prometheus"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.robustperception.io/rate-then-sum-never-sum-then-rate",children:"Rate then sum, never sum then rate"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-promql",children:'# \u6307\u6807\nnode_cpu_seconds_total\n# \u6807\u7B7E\u8FC7\u6EE4\uFF0C\u652F\u6301\u64CD\u4F5C\u7B26\u53F7 = != \u5339\u914D =~ \u4E0D\u5339\u914D !~\nnode_cpu_seconds_total{mode="user"}\n# 5 \u5206\u949F\u5747\u503C\nrate(node_cpu_seconds_total{mode="user"}[5m])\n# \u805A\u5408\u7ED3\u679C\nsum(rate(node_cpu_seconds_total{mode="user"}[5m]))\n# \u6309\u7167 mode \u5206\u7EC4\nsum(rate(node_cpu_seconds_total[5m])) by (mode)\n# \u4E0D\u770B idle \u548C nice\nsum(rate(node_cpu_seconds_total{mode!~"idle|nice"}[5m])) by (mode)\n# \u53EA\u770B user \u548C system\nsum(rate(node_cpu_seconds_total{mode=~"user|system"}[5m])) by (mode)\n# \u5206\u522B\u8FD4\u56DE\n# by (mode) \u662F\u5FC5\u987B\u7684\uFF0C\u5982\u679C\u4E22\u5931\u4E86 label\uFF0C\u5219\u4F1A\u8BA4\u4E3A\u662F\u540C\u6837\u7684\u6307\u6807\uFF0C\u4F1A\u88AB\u4E22\u5F03\nsum(rate(node_cpu_seconds_total{mode="user"}[5m])) by (mode) or sum(rate(node_cpu_seconds_total{mode="system"}[5m])) by (mode)\n# \u7ED3\u679C\u52A0\u4E0A\u53E6\u5916\u4E00\u4E2A\u6307\u6807\nsum(rate(node_cpu_seconds_total{mode=~"user|system"}[5m])) by (mode) or node_load15\n\n# unifiVapNumStations \u7ED3\u679C join unifiVapEssId label\nsum(unifiVapNumStations * on(unifiVapIndex,instance) group_left(unifiVapEssId) unifiVapEssId{}) by (unifiVapEssId)\n\n# \u66FF\u6362\u6807\u7B7E\n# grafana \u91CC\u80FD\u8BA9\u4E00\u5217\u51FA\u73B0\u4E24\u6B21\n# \u4F46 grafana \u4E0D\u80FD\u5168\u6587\u5339\u914D https://github.com/grafana/grafana/issues/11418\nlabel_replace(unifiIfMac, "unifiLabel", "$0", "unifiIfMac", ".+")\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Histogram\n-- =========\n-- Heatmap\n-- increase \u8BA9 value \u53D8\u4E3A\u6574\u6570, rate \u5219\u662F\u6BD4\u4F8B\n-- legend {{le}}\nsum(increase(body_size_bucket[5m])) by (le)\n\n--\nhistogram_quantile(0.50, sum(rate(body_size_bucket[$__rate_interval])) by (le))\nhistogram_quantile(0.90, sum(rate(body_size_bucket[$__rate_interval])) by (le))\nhistogram_quantile(0.95, sum(rate(body_size_bucket[$__rate_interval])) by (le))\nhistogram_quantile(0.99, sum(rate(body_size_bucket[$__rate_interval])) by (le))\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5E38\u7528",children:"\u5E38\u7528"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-promql",children:'# \u67E5\u8BE2\u5728\u7EBF\u8282\u70B9\n{__name__=~"probe_success|up"}\n# \u6210\u529F\u7387\nsum({__name__=~"probe_success|up"})/count({__name__=~"probe_success|up"})*100\n# \u5168\u8282\u70B9\u4FE1\u606F\nlabel_replace({__name__=~"probe_success|up"}, "instance_ip", "$2", "instance", "(192[.]168[.]|http?://)?([0-9.+]+|.*).*")\n\n# \u6392\u9664 kube \u5185\u7F6E\u7EC4\u4EF6\n{job!~"apiserver|kubelet"}\n'})}),"\n",(0,r.jsx)(n.p,{children:"| metric              |\n| ------------------- | ------------------------------------------------- |\n| node_uname_info     | Linux \u8282\u70B9\u4FE1\u606F                                    |\n| windows_os_info     | Windows \u8282\u70B9\u4FE1\u606F                                  |\n| windows_cs_hostname | ComputerSystem.DNSHostName, ComputerSystem.Domain |"}),"\n",(0,r.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(n.h2,{id:"irate-vs-rate",children:"irate vs rate"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EA\u7528\u4E8E counter - \u589E\u957F\u503C"}),"\n",(0,r.jsx)(n.li,{children:"\u5C3D\u91CF\u4F7F\u7528 rate - irate \u4E0D\u6BD4 rate \u5FEB\uFF0C\u65E0\u6CD5\u6355\u83B7\u5CF0\u503C"}),"\n",(0,r.jsxs)(n.li,{children:["irate\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EA\u4F7F\u7528\u8303\u56F4\u5185\u6700\u8FD1\u4E24\u4E2A\u65F6\u95F4\u70B9\u6570\u636E"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["rate\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6240\u6709\u95F4\u9694\u8FDB\u884C\u6C42\u5E73\u5747\u6BCF\u79D2"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://medium.com/@valyala/why-irate-from-prometheus-doesnt-capture-spikes-45f9896d7832",children:"Why irate from Prometheus doesn't capture spikes"})}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(m,{...e})}):m(e)}},917776:function(e,n,s){s.d(n,{R:()=>o,x:()=>a});var t=s(7378);let r={},i=t.createContext(r);function o(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);