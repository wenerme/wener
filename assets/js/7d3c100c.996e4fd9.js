"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["59493"],{1330:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>c,toc:()=>i,default:()=>d,metadata:()=>t,assets:()=>a,contentTitle:()=>l});var t=JSON.parse('{"id":"devops/web/haproxy/haproxy-logging","title":"HAProxy Logging","description":"- https://www.haproxy.com/documentation/hapee/latest/onepage/#8","source":"@site/../notes/devops/web/haproxy/haproxy-logging.md","sourceDirName":"devops/web/haproxy","slug":"/devops/web/haproxy/logging","permalink":"/notes/devops/web/haproxy/logging","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/haproxy/haproxy-logging.md","tags":[{"inline":true,"label":"Logging","permalink":"/notes/tags/logging"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1712053653000,"frontMatter":{"tags":["Logging"]},"sidebar":"docs","previous":{"title":"HAProxy FAQ","permalink":"/notes/devops/web/haproxy/faq"},"next":{"title":"HAProxy Proxy Protocol","permalink":"/notes/devops/web/haproxy/proxy-protocol"}}'),o=r(86106),s=r(17776);let c={tags:["Logging"]},l="HAProxy Logging",a={},i=[{value:"Log format",id:"log-format",level:2},{value:"Custom log format",id:"custom-log-format",level:2},{value:"SNI",id:"sni",level:2},{value:"JSON",id:"json",level:2}];function h(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"haproxy-logging",children:"HAProxy Logging"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-haproxy",children:"global\n  # syslog UNIX socket\n  log /dev/log local0\n\n  # \u672C\u5730 syslog server\n  log 127.0.0.1 local1 notice\n  # log \u5230 hostname \u4E3A rsyslog \u7684\u670D\u52A1\u5668\n  log rsyslog:514 local0\n\n  # stdout - \u7528\u4E8E\u5BB9\u5668\u73AF\u5883\n  log stdout format raw local0\n  log stdout format raw daemon debug\n\ndefaults\n  log global\n  mode http\n  option httplog\n\nbackend s1\n  mode tcp\n  option tcplog\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#8",children:"https://www.haproxy.com/documentation/hapee/latest/onepage/#8"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.haproxy.com/documentation/hapee/latest/observability/logging/overview/",children:"https://www.haproxy.com/documentation/hapee/latest/observability/logging/overview/"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.haproxy.com/blog/introduction-to-haproxy-logging/",children:"https://www.haproxy.com/blog/introduction-to-haproxy-logging/"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"log-format",children:"Log format"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.haproxy.com/documentation/haproxy-configuration-manual/latest/#8.2.2",children:"https://www.haproxy.com/documentation/haproxy-configuration-manual/latest/#8.2.2"})}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"TCP log format"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"mode tcp\noption tcplog\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Feb  6 12:12:56 localhost haproxy[14387]: 10.0.1.2:33313 [06/Feb/2009:12:12:51.443] fnt bck/srv1 0/0/5007 212 -- 0/0/0/0/3 0/0\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:" Field   Format                                Extract from the example above\n      1   process_name '[' pid ']:'                            haproxy[14387]:\n      2   client_ip ':' client_port                             10.0.1.2:33313\n      3   '[' accept_date ']'                       [06/Feb/2009:12:12:51.443]\n      4   frontend_name                                                    fnt\n      5   backend_name '/' server_name                                bck/srv1\n      6   Tw '/' Tc '/' Tt*                                           0/0/5007\n      7   bytes_read*                                                      212\n      8   termination_state                                                 --\n      9   actconn '/' feconn '/' beconn '/' srv_conn '/' retries*    0/0/0/0/3\n     10   srv_queue '/' backend_queue                                      0/0\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"HTTP log format"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"mode http\noption httplog\n"})}),"\n",(0,o.jsx)(n.p,{children:"\u7B49\u540C\u4E8E"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'Jan 27 21:52:56 localhost hapee-lb[3098]: 192.168.50.1:61818 [27/Jan/2021:21:52:56.086] fe_main be_servers/s1 0/0/1/1/2 200 517 - - ---- 1/1/0/0/0 0/0 {1wt.eu} {} "GET / HTTP/1.1"\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"CLF log format"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"mode http\noption httplog clf\n"})}),"\n",(0,o.jsx)(n.p,{children:"\u7B49\u540C\u4E8E"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'log-format "%{+Q}o %{-Q}ci - - [%trg] %r %ST %B \\"\\" \\"\\" %cp %ms %ft %b %s %TR %Tw %Tc %Tr %Ta %tsc %ac %fc  %bc %sc %rc %sq %bq %CC %CS %hrl %hsl"\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"HTTPS log format"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"mode http\noption httpslog\n"})}),"\n",(0,o.jsx)(n.p,{children:"\u7B49\u540C\u4E8E"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r %[fc_err]/%[ssl_fc_err,hex]/%[ssl_c_err]/%[ssl_c_ca_err]/%[ssl_fc_is_resumed] %[ssl_fc_sni]/%sslv/%sslc"\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'Feb  6 12:14:14 localhost hapee-lb[3098]: 192.168.50.1:61818 [27/Jan/2021:21:52:56.086] fe_main be_servers/s1 0/0/1/1/2 200 517 - - ---- 1/1/0/0/0 0/0 {1wt.eu} {} "GET / HTTP/1.1" 0/0/0/0/0 1wt.eu/TLSv1.3/TLS_AES_256_GCM_SHA384\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.haproxy.com/documentation/haproxy-enterprise/administration/logs/",children:"https://www.haproxy.com/documentation/haproxy-enterprise/administration/logs/"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"custom-log-format",children:"Custom log format"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'global\n  setenv HAPROXY_TCP_LOG_FMT "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"\n  setenv HAPROXY_HTTP_LOG_FMT "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"\n  setenv HAPROXY_HTTPS_LOG_FMT "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r %[fc_err]/%[ssl_fc_err,hex]/%[ssl_c_err]/%[ssl_c_ca_err]/%[ssl_fc_is_resumed] %[ssl_fc_sni]/%sslv/%sslc"\n\ndefaults\n  http-request set-var(txn.mypath) path\n  log-format "$HAPROXY_HTTP_LOG_FMT %[var(txn.mypath)]"\n'})}),"\n",(0,o.jsx)(n.h2,{id:"sni",children:"SNI"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'tcp-request inspect-delay 3s\ntcp-request content capture req.ssl_sni len 100\nlog-format "%[capture.req.hdr(0)]"\n'})}),"\n",(0,o.jsx)(n.h2,{id:"json",children:"JSON"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'log-format \'{"host":"%H","ident":"haproxy","pid":%pid,"time":"%Tl","haproxy":{"conn":{"act":%ac,"fe":%fc,"be":%bc,"srv":%sc},"queue":{"backend":%bq,"srv":%sq},"time":{"tq":%Tq,"tw":%Tw,"tc":%Tc,"tr":%Tr,"tt":%Tt},"termination_state":"%tsc","retries":%rc,"network":{"client_ip":"%ci","client_port":%cp,"frontend_ip":"%fi","frontend_port":%fp},"ssl":{"version":"%sslv","ciphers":"%sslc"},"request":{"method":"%HM","hu":"%HU",hp:"%HP",hq:"%HQ","protocol":"%HV","header":{"host":"%[capture.req.hdr(0),json(utf8s)]","xforwardfor":"%[capture.req.hdr(1),json(utf8s)]","referer":"%[capture.req.hdr(2),json(utf8s)]"}},"name":{"backend":"%b","frontend":"%ft","server":"%s"},"response":{"status_code":%ST,"header":{"xrequestid":"%[capture.res.hdr(0),json(utf8s)]"}},"bytes":{"uploaded":%U,"read":%B}}}\'\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"frontend whatever\n    capture request header Host len 40\n    capture request header X-Forwarded-For len 50\n    capture request header Referer len 200\n    capture request header User-Agent len 200\n\n    capture response header X-Request-ID len 50\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://gist.github.com/vr/c9e158e298e6e316544c399b2ff3ef22",children:"https://gist.github.com/vr/c9e158e298e6e316544c399b2ff3ef22"})}),"\n"]})]})}function d(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},17776:function(e,n,r){r.d(n,{R:()=>c,x:()=>l});var t=r(7378);let o={},s=t.createContext(o);function c(e){let n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);