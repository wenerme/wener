"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["742803"],{40162:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>i,toc:()=>o,default:()=>p,metadata:()=>t,assets:()=>l,contentTitle:()=>a});var t=JSON.parse('{"id":"security/cert/smallstep","title":"smallstep","description":"- \u51FA\u4E8E\u5546\u4E1A\u51B3\u5B9A\u79FB\u9664\u4E86 EAB #897","source":"@site/../notes/security/cert/smallstep.md","sourceDirName":"security/cert","slug":"/security/cert/smallstep","permalink":"/notes/security/cert/smallstep","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/security/cert/smallstep.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1699003495000,"frontMatter":{"title":"smallstep"},"sidebar":"docs","previous":{"title":"Let\'s Encrypt","permalink":"/notes/security/cert/letsencrypt"},"next":{"title":"cowire","permalink":"/notes/security/cowrie"}}'),c=s(486106),r=s(917776);let i={title:"smallstep"},a="smallstep",l={},o=[{value:"Endpoint",id:"endpoint",level:2},{value:"Get Started",id:"get-started",level:2},{value:"ACME",id:"acme",level:2},{value:"Yubikey KMS",id:"yubikey-kms",level:2},{value:"\u914D\u7F6E",id:"config",level:2},{value:"Concepts",id:"concepts",level:2},{value:"ssh",id:"ssh",level:2},{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"K8S",id:"k8s",level:2},{value:"adminHandler.authorizeToken; unable to load admin with subject(s) and provisioner &#39;Admin JWK&#39;",id:"adminhandlerauthorizetoken-unable-to-load-admin-with-subjects-and-provisioner-admin-jwk",level:2},{value:"ACME EAB not enabled for provisioner",id:"acme-eab-not-enabled-for-provisioner",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"smallstep",children:"smallstep"})}),"\n",(0,c.jsx)(n.admonition,{type:"caution",children:(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u51FA\u4E8E\u5546\u4E1A\u51B3\u5B9A\u79FB\u9664\u4E86 EAB ",(0,c.jsx)(n.a,{href:"https://github.com/smallstep/certificates/issues/897",children:"#897"})]}),"\n"]})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.a,{href:"https://github.com/smallstep/certificates",children:"smallstep/certificates"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Apache-2.0, Go"}),"\n",(0,c.jsx)(n.li,{children:"CA, ACME server"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://github.com/smallstep/cli",children:"smallstep/cli"})}),"\n",(0,c.jsxs)(n.li,{children:["kubernetes\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["step-certificates ",(0,c.jsx)(n.a,{href:"https://hub.helm.sh/charts/smallstep/step-certificates",children:"https://hub.helm.sh/charts/smallstep/step-certificates"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.a,{href:"https://github.com/smallstep/autocert",children:"smallstep/autocert"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\u6CE8\u5165 TLS/HTTPS \u8BC1\u4E66\u5230\u5BB9\u5668"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://smallstep.com/blog/everything-pki",children:"Everything you should know about certificates and PKI but are too afraid to ask"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://smallstep.com/blog/use-tls",children:"The case for using TLS everywhere"})}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["step-ca\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u652F\u6301\u6570\u636E\u5E93 Badger, BoltDB, MySQL, PostgreSQL\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u76EE\u524D\u6B63\u5728\u5C06 NoSQL \u8C03\u6574\u4E3A SQL \u903B\u8F91 - \u4F1A\u652F\u6301\u66F4\u591A DB ",(0,c.jsx)(n.a,{href:"https://github.com/smallstep/certificates/issues/282",children:"smallstep/certificates#282"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\u652F\u6301\u7684\u8FD0\u884C\u6A21\u5F0F\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\u79BB\u7EBF - \u4E0D\u542F\u52A8\u670D\u52A1\uFF0C\u79BB\u7EBF\u7BA1\u7406\u8BC1\u4E66"}),"\n",(0,c.jsx)(n.li,{children:"\u5728\u7EBF - \u542F\u52A8 step-ca\uFF0C\u63D0\u4F9B\u63A5\u53E3\u80FD\u529B"}),"\n",(0,c.jsxs)(n.li,{children:["RA - Registration Authority\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"RA \u4F5C\u4E3A CA \u7684\u524D\u7AEF"}),"\n",(0,c.jsx)(n.li,{children:"\u4F8B\u5982\u4E3A Vault \u63D0\u4F9B ACMEv2 server \u7684\u80FD\u529B"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.admonition,{type:"tip",children:(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["vault \u4E0D\u652F\u6301\u4F5C\u4E3A acme server\uFF0C\u5982\u679C\u9700\u8981\u79C1\u6709\u5316 acme \u53EF\u4EE5\u8003\u8651 step-ca\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://github.com/hashicorp/vault/issues/8690",children:"hashicorp/vault#8690"})}),"\n",(0,c.jsx)(n.li,{children:"step-ca \u652F\u6301\u5C06 vault \u4F5C\u4E3A RA/registration authority"}),"\n",(0,c.jsxs)(n.li,{children:["\u4E5F\u53EF\u4EE5\u4F7F\u7528 ",(0,c.jsx)(n.a,{href:"https://github.com/letsencrypt/boulder",children:"letsencrypt/boulder"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# macOS\nbrew install step\n# AlpineLinux\napk add step-cli step-certificates -X http://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing/\n\nstep path # \u6570\u636E\u76EE\u5F55 $HOME/.step\nSTEPPATH=/tmp/step step path\n# \u914D\u7F6E $(step path)/config/ca.json\nmkdir -p $STEPPATH && cd $_\n\n# \u751F\u6210 CA $HOME/.step/certs/root_ca.crt $HOME/.step/secrets/root_ca_key\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4E5F\u652F\u6301\u5730\u5740\nstep ca init \\\n  --name \"Wener CA\" --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address \":443\" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --provisioner-password-file ./provisioner.passwd \\\n  --remote-management\nstep-ca $(step path)/config/ca.json --password-file ./ca.passwd\n\nstep certificate fingerprint certs/root_ca.crt\n\n# step ca certificate --offline foo.smallstep.com foo.crt foo.key\n\n\n# \u83B7\u53D6\u5F53\u524D\u7684 root fingerprint\nstep certificate fingerprint $(step path)/certs/root_ca.crt\n# \u53E6\u5916\u4E00\u4E2A\u8282\u70B9\nstep ca bootstrap --ca-url 127.0.0.1:443 --fingerprint <root fingerprint>\n\n# \u751F\u6210\u8BC1\u4E66\nstep ca certificate localhost srv.crt srv.key\n# \u4FDD\u6301 root ca - \u6709\u4E9B\u573A\u666F\u9700\u8981\u7528\u4E8E\u8BA4\u8BC1\nstep ca root root.crt\n\n# \u67E5\u770B\u8BC1\u4E66\u4FE1\u606F\nstep certificate inspect srv.crt --short\n\n# \u751F\u6210 CSR\nstep certificate create --csr foo.example.com foo.csr foo.key\n# \u5BF9 CSR \u7B7E\u540D\nstep ca sign foo.csr foo.crt\n# renew \u8BC1\u4E66\nstep ca renew foo.crt foo.key\n# \u56DE\u6536\u8BC1\u4E66\nstep ca revoke --cert svc.crt --key svc.key\n\n\n# \u5F53\u524D\u652F\u6301 provisioner\nstep ca provisioner list\n# \u6DFB\u52A0\u540E\u9700\u8981\u91CD\u542F ca \u751F\u6548\nstep ca provisioner add you@example.com --create\n\n# step \u5305\u542B jwt \u89E3\u7801\u903B\u8F91\necho $TOKEN | step crypto jwe decrypt  | jq\n\n# \u751F\u6210\u8BC1\u4E66\u4F1A\u8981\u6C42\u9009\u62E9 provisioner\nstep ca certificate mike@example.com mike.crt mike.key\n\nstep certificate inspect --short mike.crt\n\n# \u6DFB\u52A0 google \u4F5C\u4E3A IdP\nstep ca provisioner add Google --type oidc --ca-config $(step path)/config/ca.json \\\n  --client-id 650445034027-jsjdrkiskeq9ke99ud2rqkst82ft8uch.apps.googleusercontent.com \\\n  --client-secret 6Q7lGMua_Oox4nA92QBXYypT \\\n  --configuration-endpoint https://accounts.google.com/.well-known/openid-configuration \\\n  --domain smallstep.com --domain gmail.com\n\n\n# X5C - \u53EF\u4EE5\u518D\u7528\u4E8E\u751F\u6210\u8BC1\u4E66\nstep ca provisioner add x5c-smallstep --type X5C --x5c-root $(step path)/certs/root_ca.crt\n# SSHPOP - renew, revoke, rekey an SSH certificate\nstep ca provisioner add sshpop --type SSHPOP\n# ACME - https://smallstep.com/docs/tutorials/acme-challenge\n# \u4F5C\u4E3A ACMEv2 server\n# https://{ca-host}/acme/{provisioner-name}/directory\nstep ca provisioner add acme --type ACME\n# step certificate install\n\n# K8S SA\nstep ca provisioner add my-kube-provisioner --type K8sSA --pem-keys key.pub\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://hub.docker.com/r/smallstep/step-ca",children:"https://hub.docker.com/r/smallstep/step-ca"})}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"endpoint",children:"Endpoint"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://github.com/smallstep/certificates/blob/master/acme/api/handler.go",children:"https://github.com/smallstep/certificates/blob/master/acme/api/handler.go"})}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.a,{href:"https://ca.wener.me/acme/acme/directory",children:"https://ca.wener.me/acme/acme/directory"})})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",children:'{\n  "newNonce": "https://ca.wener.me/acme/acme/new-nonce",\n  "newAccount": "https://ca.wener.me/acme/acme/new-account",\n  "newOrder": "https://ca.wener.me/acme/acme/new-order",\n  "revokeCert": "https://ca.wener.me/acme/acme/revoke-cert",\n  "keyChange": "https://ca.wener.me/acme/acme/key-change"\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"get-started",children:"Get Started"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it \\\n  -v $PWD/data:/data \\\n  --entrypoint bash \\\n  --hostname ca.wener.me \\\n  -w /data \\\n  -p 443:443 \\\n  --name stepca smallstep/step-ca\n\n# \u521D\u59CB\u5316 CA\n# =====================\nexport STEPPATH=/data/ca\n\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4E5F\u652F\u6301\u5730\u5740\nstep ca init \\\n  --name \"Wener CA\" \\\n  --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address \":443\" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --ssh --acme \\\n  --remote-management\n\n# \u6309\u9700\u4FEE\u6539 $(step path)/config/ca.json\n# \u4F8B\u5982\u4FEE\u6539 db \u5B58\u50A8\n\n# \u542F\u52A8 CA\nstep-ca $(step path)/config/ca.json --password-file ./ca.passwd\n\n# \u521D\u59CB\u5316 \u5BA2\u6237\u7AEF\n# =====================\ndocker exec -u root -e STEPPATH=/data/step -it stepca bash\n# \u4E0B\u8F7D CA \u8BC1\u4E66\n# $HOME/.step/certs/root_ca.crt\n# $HOME/.step/config/defaults.json\n#   ca-url, fingerprint, root\nstep ca bootstrap --ca-url ca.wener.me --fingerprint $(step certificate fingerprint /data/ca/certs/root_ca.crt)\n\n# \u9700\u8981 root\nstep certificate install $(step path)/certs/root_ca.crt\nls -lash /etc/ssl/certs | grep Wener\n\n# --ca-url https://ca.smallstep.com --root /home/user/.step/certs/root_ca.crt\n# TOKEN=$(step ca token internal.example.com)\n# --token $TOKEN\nstep ca health\n\n# \u7BA1\u7406\u5458\u7528\u6237\nstep ca admin list --super --admin-name step --password-file ca.passwd\n\n# \u751F\u6210\u8BC1\u4E66\nstep ca certificate localhost svr.crt svr.key --provisioner-password-file ./ca.passwd\n# 6m \u6709\u6548\nstep certificate inspect svr.crt --short\n# 1h \u6709\u6548\n# 8760h \u4E3A 1\u5E74, 43800h \u4E3A 5\u5E74, 87600h \u4E3A 10\u5E74\nstep ca certificate localhost svr.crt svr.key --not-after 1h --provisioner-password-file ./ca.passwd\n\n# ACME\nstep ca provisioner add acme --type ACME --password-file ca.passwd\n\ncurl https://ca.wener.me/acme/acme/directory\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://ypbind.de/maus/notes/real_life_step-ca_with_multiple_users/",children:"https://ypbind.de/maus/notes/real_life_step-ca_with_multiple_users/"})}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"acme",children:"ACME"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients/",children:"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients/"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"https://{ca-host}/acme/{provisioner-name}/directory"})}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"yubikey-kms",children:"Yubikey KMS"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Yubikey \u7BA1\u7406 PKI \u7684\u5BC6\u7801"}),"\n",(0,c.jsx)(n.li,{children:"\u7B2C\u4E8C\u6B21\u751F\u6210\u7684 CA \u4F7F\u7528 Yubikey \u4F5C\u4E3A KMS"}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:'docker run --rm -it \\\n  -v $PWD/data:/data \\\n  --entrypoint bash \\\n  --hostname ca.wener.me \\\n  -w /data \\\n  -p 443:443 \\\n  --name stepca smallstep/step-ca\n\n# PKI\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./pki.passwd\nSTEPPATH=/data/pki step ca init --pki --name="Wener" --deployment-type standalone --password-file ./pki.passwd\ncp /data/pki/certs/{intermediate_ca.crt,root_ca.crt} .\n\n# \u6DFB\u52A0 crt \u548C key \u5230 yubikey\nykman piv certificates import 9a /data/pki/certs/root_ca.crt\nykman piv keys import 9a /data/pki/secrets/root_ca_key\nykman piv certificates import 9c /data/pki/certs/intermediate_ca.crt\nykman piv keys import 9c /data/pki/secrets/intermediate_ca_key\n\nykman piv info\n\n# \u5C06 data/pki \u4FDD\u5B58\u5230\u5916\u90E8\u5B58\u50A8\u540E\u5220\u9664\n\n# CA\nexport STEPPATH=/data/ca\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4E5F\u652F\u6301\u5730\u5740\nstep ca init \\\n  --name "Wener CA" --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address ":443" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --provisioner-password-file ./provisioner.passwd \\\n  --remote-management\n\n# use pki cert\nmv root_ca.crt intermediate_ca.crt $STEPPATH/certs\nrm -rf $STEPPATH/secrets\n\n# \u4FEE\u6539 ca.json \u7684 "key": "/data/ca/secrets/intermediate_ca_key",\n# "key": "yubikey:slot-id=9c",\n# "kms": {\n#     "type": "yubikey",\n#     "pin": "123456"\n# },\nstep-ca $STEPPATH/config/ca.json --password-file ./pki.passwd --provisioner-password-file ./provisioner.passwd\n'})}),"\n",(0,c.jsx)(n.h2,{id:"config",children:"\u914D\u7F6E"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"env"}),(0,c.jsx)(n.th,{children:"for"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"STEPPATH"}),(0,c.jsx)(n.td,{children:"\u6570\u636E\u76EE\u5F55"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"STEPDEBUG"}),(0,c.jsx)(n.td,{})]})]})]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["authority.claims\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["maxTLSCertDuration\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\u9ED8\u8BA4 24h"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["db\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["KV - \u672C\u5730 - \u4E0D\u652F\u6301 \u5E76\u53D1/\u591A\u8FDB\u7A0B\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"badger -> badgerv1"}),"\n",(0,c.jsx)(n.li,{children:"badgerv1"}),"\n",(0,c.jsx)(n.li,{children:"badgerv2"}),"\n",(0,c.jsx)(n.li,{children:"bbolt"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["SQL - \u8FDC\u7A0B - \u4E5F\u662F\u4F5C\u4E3A KV - nkey, nvalue - 25\u4E2A\u8868\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"mysql"}),"\n",(0,c.jsx)(n.li,{children:"postgresql"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://smallstep.com/docs/step-ca/certificate-authority-core-concepts",children:"https://smallstep.com/docs/step-ca/certificate-authority-core-concepts"})}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"ssh",children:"ssh"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# \u521D\u59CB\u5316 CA \u5E26 ssh \u8BC1\u4E66\u652F\u6301\nstep ca init --ssh\n# \u751F\u6210\u914D\u7F6E\nstep ssh config --roots > /path/to/ssh_user_key.pub\n# \u914D\u7F6E CA\ncat << EOF >> /etc/ssh/sshd_config\n# This is the CA's public key for authenticating user certificates:\nTrustedUserCAKeys /path/to/ssh_user_key.pub\nEOF\n# \u751F\u6210\u8BC1\u4E66\nstep ssh certificate alice@smallstep.com id_ecdsa\n# \u67E5\u770B\u751F\u6210\u7684\u8BC1\u4E66\u4FE1\u606F\ncat id_ecdsa-cert.pub | tail -1 | step ssh inspect\n\n# \u751F\u6210 host key\nstep ssh certificate --host internal.example.com ssh_host_ecdsa_key\ncat ssh_host_ecdsa_key-cert.pub | step ssh inspect\n# \u914D\u7F6E host key\nmv ssh_host_ecdsa_key ssh_host_ecdsa_key-cert.pub /etc/ssh\ncat << EOF >> /etc/ssh/sshd_config\n# This is our host private key and certificate:\nHostKey /etc/ssh/ssh_host_ecdsa_key\nHostCertificate /etc/ssh/ssh_host_ecdsa_key-cert.pub\nEOF\n\n# \u81EA\u52A8\u66F4\u65B0 host key\ncat << EOF > /etc/cron.weekly/rotate-ssh-certificate\n#!/bin/sh\nexport STEPPATH=/root/.step\ncd /etc/ssh && step ssh renew ssh_host_ecdsa_key-cert.pub ssh_host_ecdsa_key --force 2> /dev/null\nexit 0\nEOF\nchmod 755 /etc/cron.weekly/rotate-ssh-certificate\n\n# \u6DFB\u52A0\u5230 known_hosts \u4FE1\u4EFB\u4E3B\u673A\nstep ssh config --host --roots\n"})}),"\n",(0,c.jsx)(n.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"STEPPATH"}),"\n",(0,c.jsxs)(n.li,{children:["$(step path --base)/\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"contexts.json"}),"\n",(0,c.jsx)(n.li,{children:"current-context.json"}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"authorities/<AUTHORITY>/"})}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"profiles/<PROFILE>/"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["config/\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"defaults.json"}),"\n",(0,c.jsx)(n.li,{children:"ca.json"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["AUTHORITY/ - \u5982\u679C\u6CA1\u6709 context \u5219\u76EE\u5F55\u4E3A ",(0,c.jsx)(n.code,{children:"$(step path --base)"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["certs/\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"intermediate_ca.crt"}),"\n",(0,c.jsx)(n.li,{children:"root_ca.crt"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["config/\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"ca.json"}),"\n",(0,c.jsx)(n.li,{children:"defaults.json"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.li,{children:"db"}),"\n",(0,c.jsxs)(n.li,{children:["secrets\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"intermediate_ca_key"}),"\n",(0,c.jsx)(n.li,{children:"root_ca_key"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.li,{children:"templates"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",metastring:'tite="contexts.json"',children:'{\n  "alpha-one": {\n    "authority": "alpha-one.ca.smallstep.com",\n    "profile": "alpha-one"\n  },\n  "alpha-two": {\n    "authority": "alpha-two.ca.smallstep.com",\n    "profile": "alpha-two"\n  },\n  "beta": {\n    "authority": "beta.ca.smallstep.com",\n    "profile": "beta"\n  }\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"k8s",children:"K8S"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://smallstep.com/docs/tutorials/kubernetes-acme-ca",children:"https://smallstep.com/docs/tutorials/kubernetes-acme-ca"})}),"\n"]}),"\n",(0,c.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,c.jsx)(n.h2,{id:"adminhandlerauthorizetoken-unable-to-load-admin-with-subjects-and-provisioner-admin-jwk",children:"adminHandler.authorizeToken; unable to load admin with subject(s) and provisioner 'Admin JWK'"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"--admin-name=step\n"})}),"\n",(0,c.jsx)(n.h2,{id:"acme-eab-not-enabled-for-provisioner",children:"ACME EAB not enabled for provisioner"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"add acme --type ACME --require-eab\n"})})]})}function p(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},917776:function(e,n,s){s.d(n,{R:()=>i,x:()=>a});var t=s(7378);let c={},r=t.createContext(c);function i(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);