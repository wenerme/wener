"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["141086"],{126713:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>c,toc:()=>d,default:()=>a,metadata:()=>l,assets:()=>t,contentTitle:()=>o});var l=JSON.parse('{"id":"languages/go/go-cgo","title":"CGO","description":"Note","source":"@site/../notes/languages/go/go-cgo.md","sourceDirName":"languages/go","slug":"/languages/go/cgo","permalink":"/notes/languages/go/cgo","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/languages/go/go-cgo.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1722850468000,"frontMatter":{"title":"CGO"},"sidebar":"docs","previous":{"title":"Go Build","permalink":"/notes/languages/go/build"},"next":{"title":"Concurrent","permalink":"/notes/languages/go/concurrent"}}'),s=i(486106),r=i(917776);let c={title:"CGO"},o="CGO",t={},d=[{value:"\u7C7B\u578B\u8F6C\u6362",id:"\u7C7B\u578B\u8F6C\u6362",level:2},{value:"dlopen",id:"dlopen",level:2},{value:"sqlite",id:"sqlite",level:2},{value:"\u67E5\u627E\u7528\u5230\u4E86 cgo \u7684\u6A21\u5757",id:"find-cgo-modules",level:2},{value:"zig cgo cross compile",id:"zig-cgo-cross-compile",level:2}];function h(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"cgo",children:"CGO"})}),"\n",(0,s.jsxs)(e.blockquote,{children:["\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"Note"}),"\nCGO is not GO"]}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/ebitengine/purego",children:"ebitengine/purego"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4E0D\u9700\u8981 go \u8C03\u7528 lib"}),"\n",(0,s.jsx)(e.li,{children:"\u901A\u8FC7 asm \u8C03\u7528"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u907F\u514D CGO\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/hashicorp/go-plugin",children:"hashicorp/go-plugin"})}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/notti/nocgo",children:"notti/nocgo"})," - dlopen without cgo\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"dlopen, dlclose, dlerror, dlsym"}),"\n",(0,s.jsx)(e.li,{children:"ffi \u6C47\u7F16, \u652F\u6301 386 \u548C amd64"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/rainycape/dl",children:"rainycape/dl"})," - dlopen / dlsym"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://jonwillia.ms/2022/03/09/isolating-problematic-cgo-code",children:"Isolating problematic Cgo code"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/golang/go/issues/18296",children:"golang/go#18296"})," - runtime: dlopen/dlsym without CGo"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://gist.github.com/zchee/b9c99695463d8902cd33",children:"\u7C7B\u578B\u8F6C\u6362"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["C -> CGO\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://pkg.go.dev/modernc.org/ccgo/v3",children:"modernc.org/ccgo/v3"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://pkg.go.dev/modernc.org/libc",children:"modernc.org/libc"})}),"\n",(0,s.jsxs)(e.li,{children:["\u6848\u4F8B\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://pkg.go.dev/modernc.org/sqlite",children:"modernc.org/sqlite"})}),"\n",(0,s.jsxs)(e.li,{children:["PCRE2 ",(0,s.jsx)(e.a,{href:"https://pkg.go.dev/go.arsenm.dev/pcre",children:"go.arsenm.dev/pcre"})]}),"\n",(0,s.jsxs)(e.li,{children:["uber/h3 ",(0,s.jsx)(e.a,{href:"https://github.com/akhenakh/goh3",children:"akhenakh/goh3"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"caution",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u907F\u514D Go \u7684\u540D\u5B57\u548C C \u91CC\u7684\u540D\u5B57\u51B2\u7A81\uFF0C\u5426\u5219\u65E0\u6CD5\u76F4\u63A5\u4F7F\u7528 ",(0,s.jsx)(e.code,{children:"C.<name>"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4F8B\u5982 \u5982\u679C Go \u91CC\u6709 MyStruct\uFF0C\u5219\u65E0\u6CD5\u4F7F\u7528 C.MyStruct"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(e.admonition,{title:"\u907F\u514D\u4F7F\u7528 CGO",type:"tip",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"CGO_ENABLED=0 \u7981\u7528 CGO"}),"\n",(0,s.jsx)(e.li,{children:"CGO \u4F9D\u8D56\u7CFB\u7EDF"}),"\n",(0,s.jsx)(e.li,{children:"\u8DE8\u5E73\u53F0\u7F16\u8BD1\u590D\u6742"}),"\n",(0,s.jsx)(e.li,{children:"\u65E0 CGO \u65B9\u4FBF\u6784\u5EFA -static binary"}),"\n",(0,s.jsxs)(e.li,{children:["\u65B9\u6848\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u627E\u66FF\u4EE3\u5E93"}),"\n",(0,s.jsx)(e.li,{children:"\u7528\u5230 cgo \u7684\u4F5C\u4E3A\u5916\u90E8\u8FDB\u7A0B\u901A\u8FC7 io \u4EA4\u4E92 - \u51CF\u5C11 cgo \u8303\u56F4"}),"\n",(0,s.jsx)(e.li,{children:"dlopen"}),"\n",(0,s.jsx)(e.li,{children:"exec"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u5E38\u7528\u7684 CGO \u4F9D\u8D56\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"sqlite"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(e.h2,{id:"\u7C7B\u578B\u8F6C\u6362",children:"\u7C7B\u578B\u8F6C\u6362"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://pkg.go.dev/cmd/cgo",children:"https://pkg.go.dev/cmd/cgo"})}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Go"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type InteropFunctions interface {\n	// CString malloc - \u8C03\u7528\u8005 C.free\n	CString(s string) *C.char\n	// CBytes malloc - \u8C03\u7528\u8005 C.free\n	CBytes([]byte) unsafe.Pointer\n	GoString(*C.char) string\n	GoStringN(*C.char, C.int) string\n	GoBytes(unsafe.Pointer, C.int) []byte\n}\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"C.malloc \u4E0D\u56DE\u76F4\u63A5\u8C03\u7528 C \u7684 malloc"}),"\n",(0,s.jsx)(e.li,{children:"C.malloc \u786E\u4FDD\u4E0D\u4F1A\u8FD4\u56DE NULL - \u5982\u679C\u7533\u8BF7\u5931\u8D25\u5219\u76F4\u63A5 crash"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"func GetString(in *C.char, l C.int) *C.char {\n	input := C.GoBytes(unsafe.Pointer(in), C.int(l))\n  // \u4F7F\u7528\u8005\u9700\u8981 free \u8FD4\u56DE\u7684\u6307\u9488\n	return C.CString(string(input))\n}\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// #include <stdio.h>\n// #include <errno.h>\n// #cgo CFLAGS: -DPNG_DEBUG=1\n// #cgo amd64 386 CFLAGS: -DX86=1\n// #cgo LDFLAGS: -lpng\n// #include <png.h>\n// #cgo pkg-config: png cairo\n// #cgo LDFLAGS: -L${SRCDIR}/libs -lfoo\nimport "C"\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",metastring:'title="C \u6CE8\u91CA\u4E2D\u53EF\u7528\u7684\u7279\u6B8A\u51FD\u6570"',children:"size_t _GoStringLen(_GoString_ s);\nconst char *_GoStringPtr(_GoString_ s);\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"SRCDIR -> x.go \u7684\u4F4D\u7F6E"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"C"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"typedef void *GoMap;\ntypedef void *GoChan;\ntypedef struct { void *t; void *v; } GoInterface;\ntypedef struct { void *data; GoInt len; GoInt cap; } GoSlice;\n\ntypedef struct { const char *p; ptrdiff_t n; } _GoString_;\ntypedef _GoString_ GoString;\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["GODEBUG=cgocheck=1\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"0 - \u4E0D\u68C0\u67E5"}),"\n",(0,s.jsx)(e.li,{children:"2 - \u66F4\u4E25\u683C\u7684\u68C0\u67E5"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://pkg.go.dev/runtime/cgo",children:"runtime/cgo"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5B89\u5168\u4F20\u9012 Go \u5185\u6570\u636E"}),"\n",(0,s.jsx)(e.li,{children:"interface{} -> cgo.Handle - uintptr - C.uintptr_t"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"go tool cgo\n"})}),"\n",(0,s.jsx)(e.h2,{id:"dlopen",children:"dlopen"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# \u67E5\u770B so symbol\n# \u6CA1\u6709\u5730\u5740\u7684 symbol \u662F\u52A8\u6001\u7684\nnm -gDC /usr/lib/libsqlite3.so\nobjdump -TC libz.so\nreadelf -Ws libz.so\n# \u53EA\u770B symbol\nreadelf -Ws /usr/lib/libsqlite3.so | awk '{print $8}'\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// +build !cgo\n\npackage dlopen\n\n// we have to use the 3 argument format here :( - 2 argument format is only allowed from inside cgo\n\n//go:cgo_import_dynamic libc_dlopen_x dlopen "libdl.so.2"\n//go:cgo_import_dynamic libc_dlclose_x dlclose "libdl.so.2"\n//go:cgo_import_dynamic libc_dlsym_x dlsym "libdl.so.2"\n//go:cgo_import_dynamic libc_dlerror_x dlerror "libdl.so.2"\n\n// on amd64 we don\'t need the following line - on 386 we do...\n// anyway - with those lines the output is better (but doesn\'t matter) - without it on amd64 we get multiple DT_NEEDED with "libc.so.6" etc\n\n//go:cgo_import_dynamic _ _ "libdl.so.2"\n'})}),"\n",(0,s.jsx)(e.h2,{id:"sqlite",children:"sqlite"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://gitlab.com/cznic/sqlite",children:"cznic/sqlite"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"CGo-free port of SQLite/SQLite3 v3.37.0"}),"\n",(0,s.jsx)(e.li,{children:"C to Go"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/glebarez/go-sqlite",children:"glebarez/go-sqlite"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"driver"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/mattn/go-sqlite3",children:"mattn/go-sqlite3"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"-tags libsqlite3"})," \u53EF link libsqlite3.so"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["No CGO\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/iamacarpet/go-sqlite3-win64",children:"iamacarpet/go-sqlite3-win64"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"sqlite3.dll wrapper"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/cvilsmeier/sqinn-go",children:"cvilsmeier/sqinn-go"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u57FA\u4E8E sqlite \u547D\u4EE4\u884C\u8FDB\u884C IO \u64CD\u4F5C"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/zombiezen/go-sqlite",children:"zombiezen/go-sqlite"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u53EF\u6267\u884C SQL"}),"\n",(0,s.jsx)(e.li,{children:"\u4E0D\u63D0\u4F9B database/sql driver"}),"\n",(0,s.jsx)(e.li,{children:"fork crawshaw/sqlite"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/crawshaw/sqlite",children:"crawshaw/sqlite"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"low-level Go interface to SQLite 3"}),"\n",(0,s.jsxs)(e.li,{children:["[Go and SQLite: when database/sql chafes](",(0,s.jsx)(e.a,{href:"https://crawshaw.io/blog/go-and-sqlite",children:"https://crawshaw.io/blog/go-and-sqlite"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/alicebob/sqlittle",children:"alicebob/sqlittle"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u76F4\u63A5\u8BFB\u53D6\u6587\u4EF6 - \u4E0D\u652F\u6301 SQL"}),"\n",(0,s.jsx)(e.li,{children:"\u53EA\u8BFB"}),"\n",(0,s.jsxs)(e.li,{children:["incompatible database version\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8981\u6C42 journal mode"}),"\n",(0,s.jsx)(e.li,{children:"\u4E0D\u652F\u6301 WAL"}),"\n",(0,s.jsx)(e.li,{children:"schema format > 1"}),"\n",(0,s.jsx)(e.li,{children:"UTF8 encoding"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(e.h2,{id:"find-cgo-modules",children:"\u67E5\u627E\u7528\u5230\u4E86 cgo \u7684\u6A21\u5757"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'go list -f "{{if .CgoFiles}}{{.ImportPath}}{{end}}" $(go list -f "{{.ImportPath}}{{range .Deps}} {{.}}{{end}}" ./...)\n'})}),"\n",(0,s.jsx)(e.h2,{id:"zig-cgo-cross-compile",children:"zig cgo cross compile"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Go 1.18+\nCGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux-musl" CXX="zig c++ -target x86_64-linux-musl" go build --tags extended\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"amd64 -> x86_64"}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://dev.to/kristoff/zig-makes-go-cross-compilation-just-work-29ho",children:"Zig Makes Go Cross Compilation Just Work"})}),"\n"]})]})}function a(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(h,{...n})}):h(n)}},917776:function(n,e,i){i.d(e,{R:()=>c,x:()=>o});var l=i(7378);let s={},r=l.createContext(s);function c(n){let e=l.useContext(r);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:c(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);