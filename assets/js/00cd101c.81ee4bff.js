"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["527710"],{738533:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>l,toc:()=>a,default:()=>h,metadata:()=>i,assets:()=>c,contentTitle:()=>d});var i=JSON.parse('{"id":"db/relational/postgresql/citus","title":"Citus","description":"Citus is not PostgreSQL","source":"@site/../notes/db/relational/postgresql/citus.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/citus","permalink":"/notes/db/relational/postgresql/citus","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/citus.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1656205646000,"frontMatter":{"title":"Citus"},"sidebar":"docs","previous":{"title":"Citus Version","permalink":"/notes/db/relational/postgresql/citus-version"},"next":{"title":"cstore_fdw","permalink":"/notes/db/relational/postgresql/cstore_fdw"}}'),t=s(486106),r=s(917776);let l={title:"Citus"},d="Citus",c={},a=[{value:"Tenant Demo",id:"tenant-demo",level:2},{value:"Notes",id:"notes",level:2},{value:"Cluster",id:"cluster",level:2},{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"\u5E7F\u64AD set \u4FE1\u606F",id:"\u5E7F\u64AD-set-\u4FE1\u606F",level:2},{value:"Docker",id:"docker",level:2},{value:"Kuberetes",id:"kuberetes",level:2},{value:"Citus MX",id:"citus-mx",level:2},{value:"\u9009\u62E9\u5206\u7247\u6570\u91CF",id:"\u9009\u62E9\u5206\u7247\u6570\u91CF",level:2},{value:"\u591A\u7528\u6237",id:"\u591A\u7528\u6237",level:2},{value:"\u591A\u6570\u636E\u5E93",id:"\u591A\u6570\u636E\u5E93",level:2},{value:"connection to the remote node failed with the following error: FATAL: &quot;trust&quot; authentication failed",id:"connection-to-the-remote-node-failed-with-the-following-error-fatal-trust-authentication-failed",level:2},{value:"\u8BBE\u7F6E\u8FD0\u884C\u8D85\u65F6\u65F6\u95F4",id:"\u8BBE\u7F6E\u8FD0\u884C\u8D85\u65F6\u65F6\u95F4",level:2},{value:"\u8BCA\u65AD\u547D\u4EE4",id:"\u8BCA\u65AD\u547D\u4EE4",level:2}];function o(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",del:"del",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"citus",children:"Citus"})}),"\n",(0,t.jsx)(e.p,{children:"Citus is not PostgreSQL"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/citusdata/citus",children:"citusdata/citus"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"AGPL-3.0, C"}),"\n",(0,t.jsx)(e.li,{children:"\u88AB \u5FAE\u8F6F \u6536\u8D2D"}),"\n",(0,t.jsx)(e.li,{children:"\u76EE\u524D PG \u552F\u4E00\u7684\u6C34\u5E73\u6269\u5BB9\u65B9\u6848"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://docs.citusdata.com/en/stable/get_started/what_is_citus.html#when-to-use-citus",children:"When to use"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["When\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Multi-Tenant Database"}),"\n",(0,t.jsx)(e.li,{children:"Real-Time Analytics"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["Inappropriate\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Traditional data warehousing with long, free-form SQL"}),"\n",(0,t.jsx)(e.li,{children:"Many distributed transactions across multiple shards"}),"\n",(0,t.jsx)(e.li,{children:"Queries that return data-heavy ETL results rather than summaries"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://www.citusdata.com/blog/2019/01/24/microsoft-acquires-citus-data/",children:"Microsoft Acquires Citus Data"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://news.ycombinator.com/item?id=18990469",children:"HN"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.citusdata.com/blog/2021/03/13/scaling-out-postgres-with-citus-open-source-shard-rebalancer",children:"Scaling out Postgres with the Citus open source shard rebalancer"})}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://www.citusdata.com/blog/2021/03/20/sharding-postgres-on-a-single-citus-node/",children:"Sharding Postgres on a single Citus node, how why & when"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"scale-out-ready"}),"\n",(0,t.jsx)(e.li,{children:"query parallelization, multi-shard queries"}),"\n",(0,t.jsx)(e.li,{children:"smaller indexes to create/maintain"}),"\n",(0,t.jsx)(e.li,{children:"smaller tables to auto-vacuum (in parallel!), and"}),"\n",(0,t.jsx)(e.li,{children:"faster bulk data loads"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://docs.citusdata.com/en/stable/sharding/data_modeling.html#choosing-distribution-column",children:"Choosing Distribution Column"})}),"\n",(0,t.jsxs)(e.li,{children:["pg_conftool ",(0,t.jsx)(e.a,{href:"https://github.com/credativ/postgresql-common/blob/master/pg_conftool",children:"https://github.com/credativ/postgresql-common/blob/master/pg_conftool"})]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://www.citusdata.com/blog/2016/12/18/schema-sharding-lessons/",children:"Lessons learned from Postgres schema sharding"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"db/tenant"}),"\n",(0,t.jsx)(e.li,{children:"schema/tenant"}),"\n",(0,t.jsx)(e.li,{children:"tenant_id/tenant - Scale \u552F\u4E00\u53EF\u884C\u7684\u65B9\u5F0F"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.admonition,{type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u4F1A\u4F20\u64AD ",(0,t.jsx)(e.code,{children:"SET"}),"/",(0,t.jsx)(e.code,{children:"set_config"}),", \u914D\u7F6E\u540E\u53EF\u4EE5\u4F20\u64AD ",(0,t.jsx)(e.code,{children:"SET LOCAL"}),", \u6CE8\u610F RLS \u5B9E\u73B0\u65B9\u5F0F\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u63A8\u8350\u4F7F\u7528\u5E38\u91CF\u503C - \u53EF\u4EE5\u4F18\u5316"}),"\n",(0,t.jsx)(e.li,{children:"\u901A\u8FC7 current_user \u5B9E\u73B0\u6CA1\u95EE\u9898 - \u6CE8\u610F authinfo \u540C\u6B65"}),"\n",(0,t.jsxs)(e.li,{children:["\u914D\u7F6E\u540C\u6B65 ",(0,t.jsx)(e.a,{href:"https://github.com/citusdata/citus/issues/1327",children:"citus#1327"})]}),"\n",(0,t.jsxs)(e.li,{children:["session \u4FE1\u606F\u540C\u6B65 ",(0,t.jsx)(e.a,{href:"https://github.com/citusdata/citus/issues/462",children:"citus#462"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u4F1A\u4F20\u64AD ",(0,t.jsx)(e.code,{children:"search_path"})]}),"\n",(0,t.jsx)(e.li,{children:"\u6570\u636E\u526F\u672C\u95EE\u9898\u9700\u8981\u81EA\u5DF1\u5904\u7406"}),"\n",(0,t.jsx)(e.li,{children:"\u8FD0\u884C\u5728\u9ED8\u8BA4\u6570\u636E\u5E93 - postgres - \u6BCF\u4E2A\u6570\u636E\u5E93\u72EC\u7ACB\uFF0C\u65B0\u7684\u6570\u636E\u5E93\u9700\u8981\u91CD\u65B0\u7EF4\u62A4\u8282\u70B9\u5173\u7CFB"}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/citusdata/citus/issues/906",children:"#906"})," \u4E0D\u652F\u6301 trigger"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/citusdata/citus/issues/3854",children:"#3854"})," \u4E0D\u652F\u6301 ARM"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.del,{children:"\u5F00\u539F\u7248 rebalancer \u4F1A\u963B\u585E\uFF0C\u5546\u4E1A\u7248\u4F7F\u7528 \u903B\u8F91\u670D\u590D\u5236\uFF0C\u4E0D\u4F1A\u9501"})}),"\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u652F\u6301\u529F\u80FD\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"ALTER SEQUENCE"}),"\n",(0,t.jsx)(e.li,{children:"Correlated subqueries"}),"\n",(0,t.jsx)(e.li,{children:"Recursive CTEs"}),"\n",(0,t.jsx)(e.li,{children:"Table sample"}),"\n",(0,t.jsx)(e.li,{children:"SELECT \u2026 FOR UPDATE"}),"\n",(0,t.jsx)(e.li,{children:"Grouping sets"}),"\n",(0,t.jsx)(e.li,{children:"Window Functions"}),"\n",(0,t.jsx)(e.li,{children:"CTEs"}),"\n",(0,t.jsx)(e.li,{children:"Set operations"}),"\n",(0,t.jsx)(e.li,{children:"Transactional semantics for queries that span across multiple shards"}),"\n",(0,t.jsx)(e.li,{children:"\u4E34\u65F6\u8868"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"Co-Location \u652F\u6301\u7684\u529F\u80FD\u66F4\u591A"}),"\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u4F1A \u4F20\u64AD \u7684\u5BF9\u8C61\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"CREATE DATABASE"}),"\n",(0,t.jsx)(e.li,{children:"ALTER \u2026 SET SCHEMA"}),"\n",(0,t.jsx)(e.li,{children:"ALTER TABLE ALL IN TABLESPACE"}),"\n",(0,t.jsx)(e.li,{children:"v11+ CREATE ROLE/USER, GRANT/REVOKE"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(e.admonition,{type:"tip",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"statement-based shard replication for scaling reads"}),"\n"]})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# macOS \u4E0A\u4E3A PostgresSQL \u52A0 citus \u6269\u5C55\n# brew install citus\n# echo \"shared_preload_libraries = 'citus'\" >> postgresql.conf\n\n# Docker \u5355\u8282\u70B9\ndocker run --rm -it \\\n  -p 5432:5432 \\\n  -e POSTGRES_PASSWORD=mypass \\\n  -v $PWD/data:/var/lib/postgresql/data \\\n  --name citus citusdata/citus:11-alpine\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT * FROM master_get_active_worker_nodes();\n\nSELECT version();\nSELECT citus_is_coordinator();\n\n-- \u5206\u7247\u8868\nSELECT create_distributed_table('orgs', 'id');\n-- \u5728\u6240\u6709\u8282\u70B9\u4E0A\u90FD\u5B58\u5728\nSELECT create_reference_table('geo_ips');\n-- \u53D6\u6D88 colocated - \u9ED8\u8BA4\u57FA\u4E8E \u5206\u5E03\u5217 \u7684\u503C\u8FDB\u884C colocated\nSELECT create_distributed_table('A', 'foo', colocate_with => 'none');\n-- \u53D6\u6D88\nSELECT undistribute_table('table_name');\n"})}),"\n",(0,t.jsx)(e.h2,{id:"tenant-demo",children:"Tenant Demo"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"create table orgs\n(\n    id   bigserial primary key,\n    name text not null\n);\n\ncreate table users\n(\n    id     bigserial,\n    org_id bigint references orgs (id),\n    name   text not null,\n    primary key (org_id, id)\n);\n\ncreate table notes\n(\n    id      bigserial,\n    org_id  bigint,\n    user_id bigint,\n    title   text not null,\n    content text not null,\n    primary key (org_id, id),\n    foreign key (org_id, user_id)\n        references users (org_id, id)\n);\nSELECT create_distributed_table('orgs', 'id');\nSELECT create_distributed_table('users', 'org_id');\nSELECT create_distributed_table('notes', 'org_id');\n\n-- \u51C6\u5907\u6570\u636E\ninsert into orgs(name)\nselect 'org-' || num\nfrom generate_series(1, 100) num;\n\ninsert into users(org_id, name)\nselect coalesce(nullif(num % 100, 0), 10), 'user-' || num\nfrom generate_series(1, 10000) num;\n\ninsert into notes(org_id, user_id, title, content)\nselect coalesce(nullif(num % 100, 0), 10), coalesce(nullif(num % 10000, 0), 100), 'note-' || num, 'content-' || num\nfrom generate_series(1, 1000000) num;\n\n-- \u91CD\u65B0\u5E73\u8861\u5206\u7247\nSELECT rebalance_table_shards('notes');\n-- \u9694\u79BB\u79DF\u6237\u5206\u7247 - \u8F93\u51FA\u65B0\u7684\u5206\u7247 ID\nSELECT isolate_tenant_to_new_shard('orgs', 5, 'CASCADE');\n\n-- \u67E5\u770B\u5206\u7247\u6240\u5904\u4F4D\u7F6E\nSELECT shardid, nodename, nodeport\nFROM pg_dist_placement AS placement,\n     pg_dist_node AS node\nWHERE placement.groupid = node.groupid\n  AND node.noderole = 'primary'\n--   AND shardid = 102105\nORDER BY shardid\n;\n\n-- \u79FB\u52A8\u5206\u7247\u4F4D\u7F6E\n-- SELECT citus_move_shard_placement(\n--                102240,\n--                'source_host', source_port,\n--                'dest_host', dest_port);\n\n"})}),"\n",(0,t.jsx)(e.h2,{id:"notes",children:"Notes"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u8868\u7C7B\u578B\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5206\u5E03\u5F0F\u8868/\u5206\u7247\u8868 - table -> table_1001\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"create_distributed_table"}),"\n",(0,t.jsx)(e.li,{children:"\u6BCF\u4E2A\u8282\u70B9\u5B58\u5728\u90E8\u5206\u6570\u636E"}),"\n",(0,t.jsx)(e.li,{children:"\u6307\u5B9A\u5206\u5E03\u5217"}),"\n",(0,t.jsxs)(e.li,{children:["Co-Location \u5C3D\u91CF\u8BA9 join \u8868\u5728\u76F8\u540C\u8282\u70B9\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"SELECT create_distributed_table('page', 'tenant_id', colocate_with => 'event');"})}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"colocate_with => 'none'"})," \u53D6\u6D88"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5F15\u7528\u8868\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"create_reference_table"}),"\n",(0,t.jsx)(e.li,{children:"\u6240\u6709\u8282\u70B9\u6570\u636E\u76F8\u540C - \u6570\u636E\u91CF\u5C11\uFF0C\u7528\u4E8E join"}),"\n",(0,t.jsx)(e.li,{children:"\u4F7F\u7528 2PC"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u672C\u5730\u8868 - \u4E0D\u53D7 citus \u7BA1\u7406\u7684\u8868"}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"table/view"}),(0,t.jsx)(e.th,{children:"for"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_shard"}),(0,t.jsx)(e.td,{children:"\u8BB0\u5F55\u8868\u5206\u7247"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_placement"}),(0,t.jsx)(e.td,{children:"\u8BB0\u5F55\u5206\u7247\u6240\u5904\u8282\u70B9"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_node"}),(0,t.jsx)(e.td,{children:"\u8BB0\u5F55\u8282\u70B9"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_colocation"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_partition"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_authinfo"}),(0,t.jsx)(e.td,{children:"\u591A\u7528\u6237\u8282\u70B9\u8FDE\u63A5\u4FE1\u606F"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pg_dist_poolinfo"}),(0,t.jsx)(e.td,{children:"\u5185\u90E8\u94FE\u63A5\u6C60"})]})]})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5206\u7247\u6570\u91CF - \u63A8\u8350 32 - 128\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"< 100GB \u63A8\u8350 32 \u5373\u53EF"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u8282\u70B9\u548C\u5143\u6570\u636E\u7BA1\u7406\u914D\u7F6E - pg_dist_node\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["citus_add_node('name',5432,-1,'primary','default')\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u8282\u70B9\u540D\u5B57\uFF0C\u7AEF\u53E3\uFF0Cgroupid\uFF0Cprimary/secondary\uFF0C\u96C6\u7FA4\u540D\u5B57"}),"\n",(0,t.jsx)(e.li,{children:"\u8FD4\u56DE\u5728 pg_dist_node \u4E2D\u7684 ID"}),"\n",(0,t.jsx)(e.li,{children:"\u6DFB\u52A0\u5230 pg_dist_node"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"citus_update_node(node_id, node_name, node_port)"}),"\n",(0,t.jsxs)(e.li,{children:["citus_set_node_property(node_name, node_port, property, value)\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"property - \u76EE\u524D\u53EA\u6709 shouldhaveshards"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"citus_add_inactive_node(node_name, node_port, group_id, node_role, node_cluster)"}),"\n",(0,t.jsx)(e.li,{children:"citus_activate_node(node_name, node_port)"}),"\n",(0,t.jsx)(e.li,{children:"citus_disable_node(node_name, node_port)"}),"\n",(0,t.jsx)(e.li,{children:"citus_add_secondary_node(node_name, node_port, primary_name, primary_port, node_cluster)"}),"\n",(0,t.jsx)(e.li,{children:"citus_remove_node(node_name, node_port)"}),"\n",(0,t.jsx)(e.li,{children:"citus_get_active_worker_nodes()"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["citus_backend_gpid()\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"GPID - global process identifier"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"citus_check_cluster_node_health()"}),"\n",(0,t.jsxs)(e.li,{children:["citus_set_coordinator_host(host,port=current_setting('port'),node_role='primary',node_cluster='default')\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u8BBE\u7F6E\u4E3A localhost \u5219\u662F\u5355\u8282\u70B9\u96C6\u7FA4"}),"\n",(0,t.jsx)(e.li,{children:"\u6DFB\u52A0\u5230 pg_dist_node"}),"\n",(0,t.jsx)(e.li,{children:"groupid=0,shouldhaveshards=false"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5206\u7247\u4FE1\u606F\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"master_get_table_metadata(table_name)"}),"\n",(0,t.jsx)(e.li,{children:"get_shard_id_for_distribution_column(table_name,distribution_value)"}),"\n",(0,t.jsxs)(e.li,{children:["column_to_column_name(table_name, column_var_text)\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"pg_dist_partition"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"citus_relation_size(logical_rel_id)"}),"\n",(0,t.jsx)(e.li,{children:"citus_table_size(logical_rel_id)"}),"\n",(0,t.jsx)(e.li,{children:"citus_total_relation_size(logical_rel_id)"}),"\n",(0,t.jsx)(e.li,{children:"citus_stat_statements_reset()"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u96C6\u7FA4\u7BA1\u7406\u548C\u4FEE\u590D\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"citus_move_shard_placement"}),"\n",(0,t.jsx)(e.li,{children:"rebalance_table_shards"}),"\n",(0,t.jsx)(e.li,{children:"get_rebalance_table_shards_plan"}),"\n",(0,t.jsx)(e.li,{children:"get_rebalance_progress"}),"\n",(0,t.jsxs)(e.li,{children:["citus_add_rebalance_strategy\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"pg_dist_rebalance_strategy"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"citus_set_default_rebalance_strategy"}),"\n",(0,t.jsx)(e.li,{children:"citus_remote_connection_stats"}),"\n",(0,t.jsx)(e.li,{children:"citus_drain_node"}),"\n",(0,t.jsx)(e.li,{children:"isolate_tenant_to_new_shard"}),"\n",(0,t.jsx)(e.li,{children:"citus_create_restore_point"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u624B\u52A8\u67E5\u8BE2 - \u53EA\u80FD\u5904\u7406\u8FD4\u56DE\u5355\u884C,\u4E0D\u4FDD\u8BC1\u4E8B\u52A1\u548C\u4E00\u81F4\u6027\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"run_command_on_workers($cmd$ show ssl $cmd$)"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"run_command_on_shards(table_name, $cmd$ $cmd$)"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"run_command_on_colocated_placements(var_a, var_b, $cmd$ $cmd$)"})}),"\n",(0,t.jsx)(e.li,{children:"run_command_on_coordinator"}),"\n",(0,t.jsx)(e.li,{children:"run_command_on_all_nodes"}),"\n",(0,t.jsx)(e.li,{children:"citus_is_coordinator"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["pg_dist_authinfo\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["authinfo \u53EA\u5141\u8BB8 password,sslcert,sslkey - ",(0,t.jsx)(e.a,{href:"https://github.com/citusdata/citus/blob/57455dc64dba521514c3bd85b2aab7f3cb2eecf8/src/backend/distributed/metadata/metadata_cache.c#L5203-L5217",children:"authinfo_valid"})]}),"\n",(0,t.jsx)(e.li,{children:"nodeid=0 \u5339\u914D\u6240\u6709"}),"\n",(0,t.jsx)(e.li,{children:"nodeid=-1 \u4E3A loopback"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["pg_dist_poolinfo\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"poolinfo \u53EA\u5141\u8BB8 dbname, hostm port"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- \u5206\u7247\u6570\u91CF\nshow citus.shard_count;\n\n-- relation=table/index\n-- main fork - https://www.postgresql.org/docs/current/static/storage-file-layout.html\nselect citus_relation_size('orgs');\n-- citus_relation_size + free space map + visibility map\nselect citus_table_size('orgs');\n-- citus_table_size + indices\nselect citus_total_relation_size('orgs');\n"})}),"\n",(0,t.jsx)(e.h2,{id:"cluster",children:"Cluster"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"coordinator - \u8DEF\u7531\u63A5\u6536\u8BF7\u6C42 - \u5355\u8282\u70B9\u6216\u591A\u8282\u70B9"}),"\n",(0,t.jsx)(e.li,{children:"worker - \u5B9E\u9645\u5904\u7406"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- coordinator\n-- \u8BBE\u7F6E worker \u5E94\u8BE5\u600E\u4E48\u8FDE\u63A5 coordinator\nSELECT citus_set_coordinator_host('coord.example.com', 5432);\n\n-- \u5355\u8282\u70B9\u53EA\u9700\u8981\u8BBE\u7F6E\u4E3A localhost\uFF0C\u4E0D\u518D\u9700\u8981 add_node\nSELECT citus_set_coordinator_host('localhost', 5432);\n\n-- \u6DFB\u52A0\u8282\u70B9\nSELECT * from citus_add_node('worker-101', 5432);\nSELECT * from citus_add_node('worker-102', 5432);\n-- \u5220\u9664\u8282\u70B9\nSELECT * from citus_remove_node('worker-102', 5432);\n-- \u6DFB\u52A0\u5197\u4F59\u8282\u70B9\nselect * from citus_add_secondary_node('new-node', 12345, 'primary-node', 12345);\n-- \u6DFB\u52A0\u4E0D\u542F\u7528\nselect * from citus_add_inactive_node('new-node', 12345);\n-- \u6FC0\u6D3B\nselect * from citus_activate_node('new-node', 12345);\n\n-- \u6E05\u7A7A\u8282\u70B9 - \u79FB\u9664\u8282\u70B9\u51C6\u5907\nSELECT * from citus_drain_node('10.0.0.1', 5432);\n-- \u8BBE\u7F6E\u8282\u70B9\u65E0 \u5206\u7247\nSELECT * FROM citus_set_node_property('localhost', 5433, 'shouldhaveshards', false);\n-- \u91CD\u65B0\u5E73\u8861\nSELECT * FROM rebalance_table_shards(drain_only := true);\n\nSELECT * FROM citus_get_active_worker_nodes();\n-- \u5065\u5EB7\u68C0\u67E5\nSELECT * FROM citus_check_cluster_node_health();\n\n-- \u521B\u5EFA\u6062\u590D\u70B9\nselect citus_create_restore_point('\u540D\u5B57');\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"; \u57FA\u7840\u914D\u7F6E\n; ==========\ncitus.max_worker_nodes_tracked=2048\ncitus.cluster_name=\n; always - \u603B\u662F\u8BFB secondary_node\ncitus.use_secondary_nodes=never\n\ncitus.log_distributed_deadlock_detection=false\n; -1 \u7981\u6B62\ncitus.distributed_deadlock_detection_factor=2\n\ncitus.node_connection_timeout=3000\n\n; citus.node_conninfo\n; \u81EA\u5DF1\u8FDE\u81EA\u5DF1\u65F6\u4F7F\u7528\n; citus.local_hostname\n\ncitus.show_shards_for_app_name_prefixes=\n\n; \u67E5\u8BE2\u7EDF\u8BA1\n; ==========\n; \u5355\u4F4D \u79D2\ncitus.stat_statements_purge_interval=10\ncitus.stat_statements_max=50000\n; none\ncitus.stat_statements_track=all\n\n; Data Loading\n; ============\n; 1pc\ncitus.multi_shard_commit_protocol = 2pc\ncitus.shard_count = 32\ncitus.shard_max_size = 1GB\n\n; \u5728\u8282\u70B9\u6FC0\u6D3B\u65F6\u540C\u6B65 reference \u8868\n; \u8BBE\u7F6E\u4E3A off \u53EF\u589E\u52A0 add_node \u901F\u5EA6 - \u5728\u521B\u5EFA shard \u65F6\u540C\u6B65\ncitus.replicate_reference_tables_on_activate = on\n\n; Planner\n; ============\ncitus.local_table_join_policy=auto\n; \u9650\u5236\u62C9\u53D6\u884C\u6570\ncitus.limit_clause_row_fetch_count=-1\ncitus.count_distinct_error_rate=\n; greedy, round-robin, first-replica\ncitus.task_assignment_policy=\n\n; Intermediate Data Transfer\n; ==========================\n; pg >= 14 = true\ncitus.binary_worker_copy_format =\n; \u9ED8\u8BA4 1GB, \u5355\u4F4D KB, -1 \u4E0D\u9650\u5236\ncitus.max_intermediate_result_size =\n\n; DDL\n; ==========================\ncitus.enable_ddl_propagation=true\n; coordinator \u5FC5\u987B\u901A\u8FC7 citus_add_node \u6CE8\u518C\u81EA\u5DF1\ncitus.enable_local_reference_table_foreign_keys=true\n\n; \u6267\u884C\u914D\u7F6E\n; ==========================\ncitus.all_modifications_commutative=\n; off,debug,log,notice,warning,error\ncitus.multi_task_query_log_level=\n; local - \u5E7F\u64AD SET LOCAL\ncitus.propagate_set_commands=none\n; join \u975E\u5206\u5E03\u5217\ncitus.enable_repartition_joins=false\n; INSERT INTO \u2026 SELECT\ncitus.enable_repartitioned_insert_select=\ncitus.enable_binary_protocol = true\n; = max_connections\n; -1 \u7981\u7528\ncitus.max_shared_pool_size =\ncitus.max_adaptive_executor_pool_size = 16\n; \u5355\u4F4D ms\ncitus.executor_slow_start_interval = 10\ncitus.max_cached_conns_per_worker = 1\ncitus.force_max_query_parallelization =\n; Explain\n; ==========================\ncitus.explain_all_tasks=false\n; taskId\ncitus.explain_analyze_sort_method = execution-time\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://docs.citusdata.com/en/v11.0/develop/api_guc.html",children:"https://docs.citusdata.com/en/v11.0/develop/api_guc.html"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"\u5E7F\u64AD-set-\u4FE1\u606F",children:"\u5E7F\u64AD set \u4FE1\u606F"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"set local citus.propagate_set_commands = 'local';\nset local app.tenant.id = 123;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"docker",children:"Docker"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://github.com/citusdata/docker",children:"citusdata/docker"})}),"\n",(0,t.jsxs)(e.li,{children:["FROM postgres\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u6DFB\u52A0 citus \u6269\u5C55"}),"\n",(0,t.jsx)(e.li,{children:"\u6DFB\u52A0 001-create-citus-extension.sql \u5230 /docker-entrypoint-initdb.d/"}),"\n",(0,t.jsx)(e.li,{children:"\u6DFB\u52A0 /pg_healthcheck"}),"\n",(0,t.jsxs)(e.li,{children:["\u5165\u53E3\u540C\u4E0A\u6E38 ",(0,t.jsx)(e.a,{href:"https://github.com/docker-library/postgres/blob/master/14/alpine/docker-entrypoint.sh",children:"14/alpine/docker-entrypoint.sh"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5982\u679C\u6267\u884C postgres \u5219\u4F1A\u542F\u7528\u5F88\u591A\u9884\u5904\u7406\u903B\u8F91"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u26A0\uFE0F Alpine \u7248\u6CA1\u6709 wait-for-manager.sh"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",metastring:'title="001-create-citus-extension.sql"',children:"BEGIN;\nCREATE EXTENSION citus;\n-- add Docker flag to node metadata\nUPDATE pg_dist_node_metadata SET metadata=jsonb_insert(metadata, '{docker}', 'true');\nCOMMIT;\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sh",metastring:'title="wait-for-manager.sh"',children:'#!/bin/bash\nset -e\n\nuntil test -f /healthcheck/manager-ready; do\n  echo >&2 "Manager is not ready - sleeping"\n  sleep 1\ndone\n\necho >&2 "Manager is up - starting worker"\n\n# exec gosu postgres "/usr/local/bin/docker-entrypoint.sh" "postgres"\n\n# AlpineLinux\nsu-exec postgres "/usr/local/bin/docker-entrypoint.sh" "postgres"\n'})}),"\n",(0,t.jsx)(e.h2,{id:"kuberetes",children:"Kuberetes"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/docteurklein/citus-test",children:"docteurklein/citus-test"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u53EF\u4EE5\u4F5C\u4E3A\u53C2\u8003"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"citus-mx",children:"Citus MX"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"hash-distributed tables from any node"}),"\n",(0,t.jsx)(e.li,{children:"direct reading and writing from worker nodes"}),"\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u652F\u6301\u6240\u6709\u547D\u4EE4\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"DDL commands."}),"\n",(0,t.jsx)(e.li,{children:"Citus Utility Functions that change Citus metadata."}),"\n",(0,t.jsx)(e.li,{children:"Queries accessing append distributed tables."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u4E0D\u652F\u6301 FDW"}),"\n",(0,t.jsx)(e.li,{children:"seerial \u5217\u5FC5\u987B\u4E3A bigserial"}),"\n"]}),"\n",(0,t.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,t.jsx)(e.h2,{id:"\u9009\u62E9\u5206\u7247\u6570\u91CF",children:"\u9009\u62E9\u5206\u7247\u6570\u91CF"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u9ED8\u8BA4 32"}),"\n",(0,t.jsxs)(e.li,{children:["\u591A\u79DF\u6237\u573A\u666F\u63A8\u8350 32 - 128\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"< 100GB \u53EF\u4EE5\u4ECE 32 \u5F00\u59CB"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5B9E\u65F6\u5206\u6790\u573A\u666F\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u53D6\u51B3\u4E8E worker \u7684\u6838\u5FC3\u6570"}),"\n",(0,t.jsx)(e.li,{children:"\u4E3A\u4FDD\u8BC1\u5B8C\u5168\u5E76\u884C\uFF0C\u786E\u4FDD\u6BCF\u4E2A worker \u90FD\u6709\u8DB3\u591F\u591A\u7684 shard"}),"\n",(0,t.jsx)(e.li,{children:"2xCPU - 4xCPU - \u6DFB\u52A0\u65B0\u8282\u70B9\u4E5F\u80FD\u7EE7\u7EED\u5206\u6563\u7B97\u529B"}),"\n",(0,t.jsxs)(e.li,{children:["\u8981\u6CE8\u610F: \u6BCF\u4E2A\u67E5\u8BE2\u7684 \u6BCF\u4E2A share \u90FD\u4F1A\u5F00\u542F\u4E00\u4E2A\u94FE\u63A5\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5355\u4E2A\u8FDE\u63A5\u6570: (max concurrent queries * shard count)"}),"\n",(0,t.jsx)(e.li,{children:"\u53EF\u80FD\u603B\u6570: (number of workers * max_connections per worker)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"\u591A\u7528\u6237",children:"\u591A\u7528\u6237"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u9700\u8981\u5728 pg_dist_authinfo \u914D\u7F6E\u7528\u6237\u8FDE\u63A5\u4FE1\u606F"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"create role test with login password 'test';\ninsert into pg_dist_authinfo(nodeid, rolename, authinfo)\nvalues (0, 'test', 'password=test');\nset role test;\nselect * from test;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u591A\u6570\u636E\u5E93",children:"\u591A\u6570\u636E\u5E93"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"citus \u5DE5\u4F5C\u5728\u9ED8\u8BA4\u6570\u636E\u5E93 postgres"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"SELECT run_command_on_workers($cmd$\n SELECT current_database() db;\n$cmd$);\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u5728 coordinator \u4E0A create database \u4E0D\u4F1A\u4F20\u64AD\u5230 worker \u8282\u70B9"}),"\n",(0,t.jsx)(e.admonition,{type:"tip",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6BCF\u4E2A\u65B0\u589E\u7684 \u6570\u636E\u5E93 \u90FD\u9700\u8981 ",(0,t.jsx)(e.code,{children:"CREATE EXTENSION citus"})]}),"\n",(0,t.jsx)(e.li,{children:"\u6BCF\u4E2A\u6570\u636E\u5E93\u8FD8\u9700\u8981\u989D\u5916\u7EF4\u62A4 \u8282\u70B9"}),"\n"]})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- \u5728\u6240\u6709 worker \u8282\u70B9\u6267\u884C\nSELECT run_command_on_workers($cmd$\n create database test;\n$cmd$);\n"})}),"\n",(0,t.jsx)(e.h2,{id:"connection-to-the-remote-node-failed-with-the-following-error-fatal-trust-authentication-failed",children:'connection to the remote node failed with the following error: FATAL: "trust" authentication failed'}),"\n",(0,t.jsx)(e.h2,{id:"\u8BBE\u7F6E\u8FD0\u884C\u8D85\u65F6\u65F6\u95F4",children:"\u8BBE\u7F6E\u8FD0\u884C\u8D85\u65F6\u65F6\u95F4"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- \u9ED8\u8BA4 5 \u5206\u949F\nALTER DATABASE citus\n  SET statement_timeout TO 300000;\nSELECT run_command_on_workers($cmd$\n  ALTER DATABASE citus\n    SET statement_timeout TO 300000;\n$cmd$);\n\n\n-- \u5355\u72EC\u4E8B\u52A1\u4FEE\u6539\nBEGIN;\nSET LOCAL statement_timeout TO 300000;\n-- ...\nCOMMIT;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u8BCA\u65AD\u547D\u4EE4",children:"\u8BCA\u65AD\u547D\u4EE4"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- \u79DF\u6237\u6240\u5904\u5206\u7247\nSELECT shardid, shardstate, shardlength, nodename, nodeport, placementid\n  FROM pg_dist_placement AS placement,\n       pg_dist_node AS node\n WHERE placement.groupid = node.groupid\n   AND node.noderole = 'primary'\n   AND shardid = (\n     SELECT get_shard_id_for_distribution_column('stores', 4)\n   );\n\n-- \u8868\u7684\u5206\u5E03\u5217\nSELECT column_to_column_name(logicalrelid, partkey) AS dist_col_name\nFROM pg_dist_partition\nWHERE logicalrelid='products'::regclass;\n\n-- \u68C0\u6D4B \u9501\nSELECT * FROM citus_lock_waits;\n\n-- \u5206\u7247\u5927\u5C0F\nSELECT shardid, table_name, shard_size\nFROM citus_shards\nWHERE table_name = 'my_table';\n\n-- \u6240\u6709\u5206\u5E03\u5F0F\u8868\u7684\u5927\u5C0F\nSELECT table_name, table_size\nFROM citus_tables;\n\n\n-- \u5224\u65AD\u672A\u4F7F\u7528\u7684\u7D22\u5F15\nSELECT *\nFROM run_command_on_shards('my_distributed_table', $cmd$\n  SELECT array_agg(a) as infos\n  FROM (\n    SELECT (\n      schemaname || '.' || relname || '##' || indexrelname || '##'\n                 || pg_size_pretty(pg_relation_size(i.indexrelid))::text\n                 || '##' || idx_scan::text\n    ) AS a\n    FROM  pg_stat_user_indexes ui\n    JOIN  pg_index i\n    ON    ui.indexrelid = i.indexrelid\n    WHERE NOT indisunique\n    AND   idx_scan < 50\n    AND   pg_relation_size(relid) > 5 * 8192\n    AND   (schemaname || '.' || relname)::regclass = '%s'::regclass\n    ORDER BY\n      pg_relation_size(i.indexrelid) / NULLIF(idx_scan, 0) DESC nulls first,\n      pg_relation_size(i.indexrelid) DESC\n  ) sub\n$cmd$);\n\n-- \u5BA2\u6237\u7AEF\u8FDE\u63A5\u6570\nSELECT state, count(*)\nFROM pg_stat_activity\nGROUP BY state;\n\n-- \u7CFB\u7EDF\u6D3B\u8DC3\u67E5\u8BE2\nSELECT global_pid, query, state\nFROM citus_stat_activity\nWHERE state != 'idle';\n\n-- \u67E5\u8BE2\u7B49\u5F85\u539F\u56E0\nSELECT wait_event || ':' || wait_event_type AS type, count(*) AS number_of_occurences\nFROM pg_stat_activity\nWHERE state != 'idle'\nGROUP BY wait_event, wait_event_type\nORDER BY number_of_occurences DESC;\n\n-- \u7D22\u5F15\u547D\u4E2D\u7387\n-- on coordinator\nSELECT 100 * (sum(idx_blks_hit) - sum(idx_blks_read)) / sum(idx_blks_hit) AS index_hit_rate\n  FROM pg_statio_user_indexes;\n\n-- on workers\nSELECT nodename, result as index_hit_rate\nFROM run_command_on_workers($cmd$\n  SELECT 100 * (sum(idx_blks_hit) - sum(idx_blks_read)) / sum(idx_blks_hit) AS index_hit_rate\n    FROM pg_statio_user_indexes;\n$cmd$);\n\n\n-- \u7F13\u5B58\u547D\u4E2D\u7387\n-- on coordinator\nSELECT\n  sum(heap_blks_read) AS heap_read,\n  sum(heap_blks_hit)  AS heap_hit,\n  100 * sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS cache_hit_rate\nFROM\n  pg_statio_user_tables;\n\n-- on workers\nSELECT nodename, result as cache_hit_rate\nFROM run_command_on_workers($cmd$\n  SELECT\n    100 * sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS cache_hit_rate\n  FROM\n    pg_statio_user_tables;\n$cmd$);\n"})})]})}function h(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(o,{...n})}):o(n)}},917776:function(n,e,s){s.d(e,{R:()=>l,x:()=>d});var i=s(7378);let t={},r=i.createContext(t);function l(n){let e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:l(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);