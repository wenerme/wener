"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["615824"],{960912:function(e,n,l){l.r(n),l.d(n,{frontMatter:()=>r,toc:()=>c,default:()=>h,metadata:()=>s,assets:()=>d,contentTitle:()=>i});var s=JSON.parse('{"id":"devops/kubernetes/network/metallb","title":"MetalLB","description":"- danderson/metallb","source":"@site/../notes/devops/kubernetes/network/metallb.md","sourceDirName":"devops/kubernetes/network","slug":"/devops/kubernetes/network/metallb","permalink":"/notes/devops/kubernetes/network/metallb","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/network/metallb.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1666003394000,"frontMatter":{"title":"MetalLB"},"sidebar":"docs","previous":{"title":"kube-router","permalink":"/notes/devops/kubernetes/network/kube-router"},"next":{"title":"Nginx Ingress \u5E38\u89C1\u95EE\u9898","permalink":"/notes/devops/kubernetes/network/nginx-ingress-faq"}}'),t=l(486106),a=l(917776);let r={title:"MetalLB"},i="MetalLB",d={},c=[{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"L2",id:"l2",level:3},{value:"BGP",id:"bgp",level:3},{value:"\u670D\u52A1\u7279\u6B8A\u914D\u7F6E",id:"\u670D\u52A1\u7279\u6B8A\u914D\u7F6E",level:2},{value:"FAQ",id:"faq",level:2},{value:"\u4FEE\u6539 IP \u5730\u5740\u6C60",id:"\u4FEE\u6539-ip-\u5730\u5740\u6C60",level:3},{value:"Annotations",id:"annotations",level:2}];function o(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"metallb",children:"MetalLB"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/metallb/metallb",children:"danderson/metallb"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u57FA\u4E8E\u4E3B\u673A L2 \u63D0\u4F9B LB \u80FD\u529B - VIP/\u865A\u62DF IP/\u8D1F\u8F7D\u5747\u8861"}),"\n",(0,t.jsx)(n.li,{children:"\u652F\u6301 L2 \u548C BGP \u6A21\u5F0F"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://metallb.universe.tf/concepts/layer2/",children:"L2"})," \u4F7F\u7528 ARP/NDP - ",(0,t.jsx)(n.strong,{children:"\u914D\u7F6E\u7B80\u5355"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u4F1A\u76D1\u542C\u6240\u6709\u7F51\u5361"}),"\n",(0,t.jsxs)(n.li,{children:["\u6D41\u91CF\u53EA\u4F1A\u5230 ",(0,t.jsx)(n.strong,{children:"\u4E00\u4E2A\u8282\u70B9"})," \u4E0D\u662F\u771F\u6B63\u7684\u8D1F\u8F7D\u5747\u8861"]}),"\n",(0,t.jsx)(n.li,{children:"\u5B9E\u73B0\u4E86 failover \u673A\u5236 - \u65E7\u7684 leader \u6709 10s \u7684\u79DF\u7EA6"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://metallb.universe.tf/concepts/bgp/",children:"BGP"})," - \u914D\u7F6E\u76F8\u5BF9\u590D\u6742\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u6BCF\u4E2A\u8282\u70B9\u4E8E\u7F51\u7EDC\u8DEF\u7531\u5668\u5EFA\u7ACB BGP \u4F1A\u8BDD"}),"\n",(0,t.jsxs)(n.li,{children:["\u5982\u679C\u8DEF\u7531\u914D\u7F6E\u4E86\u591A\u8DEF\u652F\u6301 - \u90A3\u4E48\u914D\u5408 metallb \u5BA3\u544A\u7684\u5730\u5740\u5219\u80FD\u5B9E\u73B0 ",(0,t.jsx)(n.strong,{children:"\u771F\u6B63\u7684\u8D1F\u8F7D\u5747\u8861"})," - \u800C\u4E0D\u53EA\u662F\u4F7F\u7528\u4E00\u4E2A\u4F5C\u4E3A \u4E0B\u4E00\u8DF3/nexthop"]}),"\n",(0,t.jsx)(n.li,{children:"\u7F51\u7EDC\u53D8\u5316\u65F6\u4F1A\u6709\u4E00\u77AC\u95F4\u7684\u4E2D\u65AD"}),"\n",(0,t.jsx)(n.li,{children:"\u4E00\u822C\u4F7F\u7528\u57FA\u4E8E hash \u7684\u8D1F\u8F7D\u5747\u8861 - \u90E8\u5206\u573A\u666F\u4E0B\u4F1A\u6709\u95EE\u9898"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"MetalLB \u5B89\u88C5\u540E\u5982\u679C\u4E0D\u914D\u7F6E\u4E5F\u662F\u6CA1\u6709\u5F00\u59CB\u5DE5\u4F5C\u7684"}),"\n",(0,t.jsxs)(n.li,{children:["\u539F\u7406\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"metallb-system/controller"})," deployment \u5904\u7406 IP \u5206\u53D1"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"metallb-system/speaker"})," daemonset \u5728\u6BCF\u4E2A\u8282\u70B9\u4E0A\u54CD\u5E94\u8DEF\u7531\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u54CD\u5E94 ARP\uFF0C\u7533\u660E\u8282\u70B9\u6709 IP \u5E76\u8FD4\u56DE MAC"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Helm ",(0,t.jsx)(n.a,{href:"https://github.com/wenerme/charts/tree/master/metallb",children:"https://github.com/wenerme/charts/tree/master/metallb"})]}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u4E0D\u80FD PING ",(0,t.jsx)(n.a,{href:"https://github.com/danderson/metallb/issues/259",children:"https://github.com/danderson/metallb/issues/259"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u652F\u6301 ",(0,t.jsx)(n.code,{children:"externalTrafficPolicy"})," \u9009\u9879 - BGP \u548C L2 \u884C\u4E3A\u4E0D\u4E00\u6837"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://metallb.universe.tf/installation/network-addons/",children:"\u7F51\u7EDC\u517C\u5BB9"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Canal Cilium Flannel"}),"\n"]}),"\n"]}),"\n"]}),(0,t.jsx)(n.p,{children:"::"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u901A\u8FC7 arping \u68C0\u6D4B\u7F51\u7EDC\u4E92\u901A\n# interface \u548C\u5730\u5740\u9700\u8981\u5BF9\u5E94\narping -I eth0 192.168.10.1\n\n# \u5728\u53E6\u5916\u7684\u8282\u70B9\u4E0A\u53EF\u4EE5\u901A\u8FC7 tcpdump \u68C0\u6D4B\u7F51\u7EDC\u4E92\u901A\ntcpdump -n -i eth0 arp src host 192.168.1.240\n\n# metallb\n# \u4E0B\u8F7D\u5230\u672C\u5730\u5B89\u88C5\nver=$(curl -Ls https://api.github.com/repos/danderson/metallb/releases/latest | jq -r .tag_name)\ncurl https://raw.githubusercontent.com/danderson/metallb/$ver/manifests/metallb.yaml -Lo metallb-$ver.yaml\ncurl https://raw.githubusercontent.com/danderson/metallb/$ver/manifests/namespace.yaml -Lo metallb-namespace-$ver.yaml\nkubectl apply -f metallb-namespace-$ver.yaml\nkubectl apply -f metallb-$ver.yaml\n\n# \u7B2C\u4E00\u6B21\u5B89\u88C5\nkubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"\n\n# \u914D\u7F6E\u751F\u6548\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: metallb-system\n  name: config\ndata:\n  config: |\n    address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - 192.168.128.0/17\nEOF\n'})}),(0,t.jsx)(n.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/danderson/metallb/blob/main/manifests/example-config.yaml",children:"example-config.yaml"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://metallb.universe.tf/configuration",children:"\u914D\u7F6E\u6587\u6863"})}),"\n"]}),(0,t.jsx)(n.h3,{id:"l2",children:"L2"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: metallb-system\n  name: config\ndata:\n  config: |\n    address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - 192.168.1.240-192.168.1.250\n      - 192.168.144.0/20\n"})}),(0,t.jsx)(n.h3,{id:"bgp",children:"BGP"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: metallb-system\n  name: config\ndata:\n  config: |\n    peers:\n    - peer-address: 10.0.0.1\n      peer-asn: 64501\n      my-asn: 64500\n    address-pools:\n    - name: default\n      protocol: bgp\n      addresses:\n      - 192.168.10.0/24\n"})}),(0,t.jsx)(n.h2,{id:"\u670D\u52A1\u7279\u6B8A\u914D\u7F6E",children:"\u670D\u52A1\u7279\u6B8A\u914D\u7F6E"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\n  annotations:\n    # \u9009\u62E9\u5730\u5740\u6C60 - \u5426\u5219\u4F7F\u7528\u9ED8\u8BA4\n    metallb.universe.tf/address-pool: production-public-ips\n    # \u5982\u679C\u5141\u8BB8\u5171\u4EAB IP \u90A3\u4E48\u53EF\u80FD\u4E24\u6B21\u62FF\u5230\u76F8\u540C\u7684\n    metallb.universe.tf/allow-shared-ip: true\nspec:\n  ports:\n    - port: 80\n      targetPort: 80\n  selector:\n    app: nginx\n  type: LoadBalancer\n"})}),(0,t.jsx)(n.h2,{id:"faq",children:"FAQ"}),(0,t.jsx)(n.h3,{id:"\u4FEE\u6539-ip-\u5730\u5740\u6C60",children:"\u4FEE\u6539 IP \u5730\u5740\u6C60"}),(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/danderson/metallb/issues/308",children:"danderson/metallb#308"})}),"\n"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u786E\u8BA4\u4E0A\u6B21\u5206\u53D1\u7684 IP\nkubectl get svc\n# \u5220\u9664\u65E7\u7684\u914D\u7F6E\nkubectl -n metallb-system delete cm config\n# \u5E94\u7528\u65B0\u7684\u914D\u7F6E\nkubectl apply -f new.yml\n# \u5220\u9664 metallb \u5BB9\u5668\nkubectl -n metallb-system delete pod --all\n# \u786E\u4FDD\u6062\u590D\nkubectl -n metallb-system get pods -w\n# \u67E5\u770B\u65B0\u83B7\u53D6\u5230\u7684 IP\nkubectl get svc\n"})}),(0,t.jsx)(n.h2,{id:"annotations",children:"Annotations"}),(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"metallb.universe.tf/allow-shared-ip"}),"\n"]})]})]})}function h(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},917776:function(e,n,l){l.d(n,{R:()=>r,x:()=>i});var s=l(7378);let t={},a=s.createContext(t);function r(e){let n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);