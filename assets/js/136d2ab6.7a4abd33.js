"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["52587"],{17342:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>c,toc:()=>d,default:()=>h,metadata:()=>l,assets:()=>a,contentTitle:()=>t});var l=JSON.parse('{"id":"db/relational/postgresql/postgresql-sql-faq","title":"Pg SQL \u5E38\u89C1\u95EE\u9898","description":"Note","source":"@site/../notes/db/relational/postgresql/postgresql-sql-faq.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/sql-faq","permalink":"/notes/db/relational/postgresql/sql-faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-sql-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1754277663000,"frontMatter":{"title":"Pg SQL \u5E38\u89C1\u95EE\u9898","tags":["FAQ"]},"sidebar":"docs","previous":{"title":"Postgresql Scale","permalink":"/notes/db/relational/postgresql/scale"},"next":{"title":"PostgreSQL Tenant","permalink":"/notes/db/relational/postgresql/tenant"}}'),r=s(86106),i=s(17776);let c={title:"Pg SQL \u5E38\u89C1\u95EE\u9898",tags:["FAQ"]},t="PostgreSQL SQL \u95EE\u9898",a={},d=[{value:"XML xpath \u8FD4\u56DE\u7ED3\u679C\u5305\u542B CDATA",id:"xml-xpath-\u8FD4\u56DE\u7ED3\u679C\u5305\u542B-cdata",level:2},{value:"\u9759\u6001\u6570\u636E\u884C",id:"\u9759\u6001\u6570\u636E\u884C",level:2},{value:"\u5206\u7EC4\u805A\u5408",id:"\u5206\u7EC4\u805A\u5408",level:2},{value:"function vs procedure",id:"function-vs-procedure",level:2},{value:"plpgsql vs sql",id:"plpgsql-vs-sql",level:2},{value:"\u51FD\u6570\u8FD4\u56DE\u5F71\u54CD\u884C",id:"\u51FD\u6570\u8FD4\u56DE\u5F71\u54CD\u884C",level:2},{value:"\u6B63\u5219",id:"\u6B63\u5219",level:2},{value:"\u751F\u6210\u5E26\u524D\u7F00\u7684 UUID \u4E3B\u952E",id:"\u751F\u6210\u5E26\u524D\u7F00\u7684-uuid-\u4E3B\u952E",level:2},{value:"\u63A8\u8350\u4E3B\u952E\u521B\u5EFA\u65B9\u5F0F",id:"\u63A8\u8350\u4E3B\u952E\u521B\u5EFA\u65B9\u5F0F",level:2},{value:"Operator",id:"operator",level:2},{value:"\u5206\u7EC4\u91CC\u9009\u62E9\u6700\u540E\u4E00\u6761\u6570\u636E",id:"\u5206\u7EC4\u91CC\u9009\u62E9\u6700\u540E\u4E00\u6761\u6570\u636E",level:2},{value:"ON CONFLICT \u591A\u5217 UNIQUE",id:"on-conflict-\u591A\u5217-unique",level:2},{value:"LATERAL JOIN",id:"lateral-join",level:2},{value:"\u4E0D\u53EF\u4EE5\u518D WHERE \u4F7F\u7528\u522B\u540D",id:"\u4E0D\u53EF\u4EE5\u518D-where-\u4F7F\u7528\u522B\u540D",level:2},{value:"csv",id:"csv",level:2},{value:"create role if not exists",id:"create-role-if-not-exists",level:2},{value:"role cannot be dropped because some objects depend on it - privileges for table users",id:"role-cannot-be-dropped-because-some-objects-depend-on-it---privileges-for-table-users",level:2},{value:"create role if not exists",id:"create-role-if-not-exists-1",level:2},{value:"create policy if not exists",id:"create-policy-if-not-exists",level:2},{value:"add foreign key if not exists",id:"add-foreign-key-if-not-exists",level:2},{value:"array",id:"array",level:2},{value:"any",id:"any",level:2},{value:"sequence gap",id:"sequence-gap",level:2},{value:"histgram",id:"histgram",level:2}];function o(e){let n={a:"a",blockquote:"blockquote",code:"code",del:"del",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"postgresql-sql-\u95EE\u9898",children:"PostgreSQL SQL \u95EE\u9898"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Note"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"comment \u4E0D\u80FD\u5728\u521B\u5EFA\u8868\u65F6\u6307\u5B9A"}),"\n",(0,r.jsx)(n.li,{children:"column \u7684 generated \u4E0D\u80FD\u4FEE\u6539"}),"\n",(0,r.jsx)(n.li,{children:"column \u53EA\u652F\u6301 STORE \u7684\u751F\u6210\u5217\uFF0C\u4E0D\u652F\u6301\u865A\u62DF\u5217"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Diagnostic\nselect version();\nshow server_version;\nshow server_version_num;\nshow server_encoding;\nselect current_user, current_schema, current_catalog, current_database();\n\nSHOW server_encoding;\nSHOW client_encoding;\n\nSHOW timezone;\nSELECT now();\nSELECT current_timestamp;\n\nSELECT inet_server_addr() AS server_ip, inet_client_addr() AS client_ip;\nSELECT inet_server_port() AS server_port, inet_client_port() AS client_port;\n\nSELECT pg_size_pretty(pg_database_size(current_database())) AS database_size;\n\nSHOW data_directory;\nSHOW max_connections;\nSHOW shared_buffers;\nSHOW default_transaction_isolation;\nSHOW ALL;\n\n-- Database \u548C Owner\nSELECT\n    datname AS database_name,\n    pg_get_userbyid(datdba) AS owner\nFROM\n    pg_database;\n\n-- Schema \u548C Owner\nSELECT\n  nspname AS schema_name,\n  pg_get_userbyid(nspowner) AS owner\nFROM\n  pg_namespace;\n\n-- \u8868\u548C Owner\nSELECT n.nspname                   AS schema_name,\n       c.relname                   AS table_name,\n       pg_get_userbyid(c.relowner) AS owner\nFROM pg_class c\n         JOIN\n     pg_namespace n ON n.oid = c.relnamespace\nWHERE c.relkind = 'r'\n-- r -> relation - \u666E\u901A\u8868\n--   AND n.nspname = 'public'\n--   AND c.relname = 'customers';\norder by schema_name, table_name\n;\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM pg_stat_activity;\nSELECT * FROM pg_locks;\nselect * from pg_user;  -- \u67E5\u770B\u6240\u6709 user\nSELECT usename, usesuper AS superuser, usecreatedb AS createdb, valuntil AS expiration\nFROM pg_user;\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/functions-json.html",children:"JSON Functions and Operators"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PRIMARY KEY"})," ~= ",(0,r.jsx)(n.code,{children:"UNIQUE"})," + ",(0,r.jsx)(n.code,{children:"NOT NULL"})]}),"\n",(0,r.jsxs)(n.li,{children:["FK\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"MATCH SIMPLE"})}),"\n",(0,r.jsxs)(n.li,{children:["MATCH FULL\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u90FD\u4E0D null\uFF0C\u6216\u90FD null"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.del,{children:"MATCH PARTIAL"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["CONSTRAINTS\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DEFERRED | IMMEDIATE"}),"\n",(0,r.jsxs)(n.li,{children:["\u521B\u5EFA\u65F6\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DEFERRABLE INITIALLY DEFERRED"}),"\n",(0,r.jsx)(n.li,{children:"DEFERRABLE INITIALLY IMMEDIATE"}),"\n",(0,r.jsx)(n.li,{children:"NOT DEFERRABLE"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- regexp_matches \u83B7\u53D6\u4E3A\u6570\u7EC4\u800C\u4E0D\u662F\u4F5C\u4E3A set \u8FD4\u56DE\nselect array(select array_to_string(regexp_matches(text, '@(\\S+?)\\u2005', 'g'), '')), text\nfrom wecom_archive_message\nwhere type in ('text')\n-- \u83B7\u53D6\u5B57\u7B26\u51FA\u73B0\u7684\u6B21\u6570\n-- \u4E5F\u53EF\u4EE5\u7528 replace \u5982\u679C\u7528\u4E0D\u5230 regex \u7684\u529F\u80FD `\\u2005` \u4F9D\u8D56 regex \u7684\u529F\u80FD\n  and (LENGTH(text) - LENGTH(regexp_replace(text, '\\u2005', ''))) > 0\n;\n\n-- \u57FA\u672C\u7684\u5E94\u7528\u521D\u59CB\u5316\ncreate user app with password 'app'; -- \u521B\u5EFA\u7528\u6237\ncreate database app with owner app; -- \u521B\u5EFA\u6570\u636E\u5E93\n\\c app; -- \u8FDE\u63A5\u6570\u636E\u5E93\nset session authorization app; -- \u5207\u6362\u7528\u6237\nselect current_user; -- \u67E5\u770B\u5F53\u524D\u7528\u6237\ncreate schema main; -- \u521B\u5EFA schema, \u907F\u514D\u4F7F\u7528 public\nalter user app set search_path to main,public; -- \u8BBE\u7F6E\u7528\u6237\u9ED8\u8BA4 schema\n"})}),"\n",(0,r.jsx)(n.h2,{id:"xml-xpath-\u8FD4\u56DE\u7ED3\u679C\u5305\u542B-cdata",children:"XML xpath \u8FD4\u56DE\u7ED3\u679C\u5305\u542B CDATA"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/message-id/5DB23068.3080601%40anastigmatix.net",children:"BUG #16046: xpath returns CDATA tag along with the value in postgres 12"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- PG 12+ \u8FD4\u56DE  <![CDATA[text]]>\n-- PG 11 \u8FD4\u56DE text\nselect unnest(xpath('/s/text()','<s><![CDATA[text]]></s>'));\n-- \u6DFB\u52A0 string \u8F6C\u6362\u8FD4\u56DE\u6B63\u5E38\nselect unnest(xpath('string(/s)','<s><![CDATA[text]]></s>'::xml));\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u9759\u6001\u6570\u636E\u884C",children:"\u9759\u6001\u6570\u636E\u884C"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM (VALUES (1, 'one'), (2, 'two'), (3, 'three')) AS t (num, letter);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5206\u7EC4\u805A\u5408",children:"\u5206\u7EC4\u805A\u5408"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/cube.html",children:"cube"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/devel/queries-table-expressions.html#QUERIES-GROUPING-SETS",children:"GROUPING SETS, CUBE, ROLLUP"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"rollup(a,b,c)"})," => ",(0,r.jsx)(n.code,{children:"grouping sets((a,b,c),(a,b),(a),())"})]}),"\n",(0,r.jsx)(n.li,{children:"cube((a),(b),(c)) grouping sets((a,b,c),(a,b),(a,c),(a),(b,c),(b),(c),())"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"GROUP BY a, b, c\n-- \u5BF9\u7B49\n\n\nROLLUP ( a, b , c)\n-- \u5BF9\u7B49\nGROUPING SETS (\n    ( a, b, c ),\n    ( a, b    ),\n    ( a       ),\n    (         )\n)\n\nCUBE ( a, b, c )\n-- \u5BF9\u7B49\nGROUPING SETS (\n    ( a, b, c ),\n    ( a, b    ),\n    ( a,    c ),\n    ( a       ),\n    (    b, c ),\n    (    b    ),\n    (       c ),\n    (         )\n)\n\nCUBE ( (a, b), (c, d) )\n-- \u5BF9\u7B49\nGROUPING SETS (\n    ( a, b, c, d ),\n    ( a, b       ),\n    (       c, d ),\n    (            )\n)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"function-vs-procedure",children:"function vs procedure"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["function\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4E0D\u53EF\u4EE5\u64CD\u4F5C\u4E8B\u7269"}),"\n",(0,r.jsx)(n.li,{children:"\u4F7F\u7528 SELECT \u8C03\u7528"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["procedure\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6CA1\u6709\u8FD4\u56DE\u503C"}),"\n",(0,r.jsx)(n.li,{children:"\u6709 INOUT \u53C2\u6570"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5 commit \u548C rollback"}),"\n",(0,r.jsx)(n.li,{children:"\u4F7F\u7528 CALL \u8C03\u7528"}),"\n",(0,r.jsx)(n.li,{children:"\u4E0D\u53EF\u4EE5\u5D4C\u5957\u5230\u5176\u4ED6 DDL - SELECT,INSERT,UPDATE,DELETE"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"plpgsql-vs-sql",children:"plpgsql vs sql"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["sql\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7B80\u5355"}),"\n",(0,r.jsx)(n.li,{children:"\u5DF2\u7ECF\u719F\u6089 SQL"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["plpgsql\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u652F\u6301\u590D\u6742\u8BED\u6CD5"}),"\n",(0,r.jsx)(n.li,{children:"\u652F\u6301\u63A7\u5236\u6D41 - \u80FD\u505A\u5230\u5355\u4E2A SQL \u505A\u4E0D\u5230\u7684\u4E8B\u60C5"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://stackoverflow.com/a/24771561/1870054",children:"https://stackoverflow.com/a/24771561/1870054"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u51FD\u6570\u8FD4\u56DE\u5F71\u54CD\u884C",children:"\u51FD\u6570\u8FD4\u56DE\u5F71\u54CD\u884C"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"get diagnostics cnt = row_count;\nreturn cnt;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u6B63\u5219",children:"\u6B63\u5219"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"regexp_match(string, pattern [, flags ]) returns text[]\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["flags\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"g - global"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT (regexp_match('200\u4E07\u4EBA\u6C11\u5E01', '[\\d.]+'))[1];\nSELECT (regexp_match('200\u4E07\u4EBA\u6C11\u5E01', '\\D+$'))[1];\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u751F\u6210\u5E26\u524D\u7F00\u7684-uuid-\u4E3B\u952E",children:"\u751F\u6210\u5E26\u524D\u7F00\u7684 UUID \u4E3B\u952E"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4F8B\u5982\u7528\u4E8E GraphQL \u901A\u8FC7 ID \u5224\u65AD\u7C7B\u578B"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"create table test\n(\n    id    text default 'test-' || public.gen_random_uuid() primary key,\n    value text\n);\n\ninsert into test(value)\nvalues ('test');\n\nselect *\nfrom test;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u63A8\u8350\u4E3B\u952E\u521B\u5EFA\u65B9\u5F0F",children:"\u63A8\u8350\u4E3B\u952E\u521B\u5EFA\u65B9\u5F0F"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5BF9\u6BD4 serial\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6709\u5F52\u5C5E\u5173\u7CFB"}),"\n",(0,r.jsx)(n.li,{children:"\u66F4\u52A0\u89C4\u8303"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GENERATED { ALWAYS | BY DEFAULT } AS IDENTITY"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ALWAYS"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["INSERT \u6307\u5B9A ID \u4E0D\u4F1A\u751F\u6548\uFF0C\u9700\u8981 ",(0,r.jsx)(n.code,{children:"OVERRIDING SYSTEM VALUE"})]}),"\n",(0,r.jsx)(n.li,{children:"UPDATE \u4E0D\u5141\u8BB8\u4FEE\u6539 ID"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"BY DEFAULT"})," - \u7528\u6237\u6307\u5B9A\u503C\u4F18\u5148\u7EA7\u66F4\u9AD8"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE users (\n   id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY\n);\n-- \u4E5F\u53EF\u4EE5\u9488\u5BF9\u751F\u6210\u8BBE\u7F6E\u66F4\u591A\u53C2\u6570\nCREATE TABLE users (\n   id bigint GENERATED ALWAYS AS IDENTITY\n             (MINVALUE 0 START WITH 0 CACHE 20)\n             PRIMARY KEY,\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"operator",children:"Operator"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u64CD\u4F5C\u7B26\u4E5F\u662F\u51FD\u6570\nSELECT 3 OPERATOR(pg_catalog.+) 4;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5206\u7EC4\u91CC\u9009\u62E9\u6700\u540E\u4E00\u6761\u6570\u636E",children:"\u5206\u7EC4\u91CC\u9009\u62E9\u6700\u540E\u4E00\u6761\u6570\u636E"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"distinct - \u63A8\u8350"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"select distinct on (id) id, date, another_info\nfrom the_table\norder by id, date desc;\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"window"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"select data\nfrom (\n        select data,\n                row_number()\n                over (partition by data ->> 'groupId' order by item_date desc) as rn\n        from pulled_items\n    ) lt\nwhere rn = 1\n"})}),"\n",(0,r.jsx)(n.h2,{id:"on-conflict-\u591A\u5217-unique",children:"ON CONFLICT \u591A\u5217 UNIQUE"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT",children:"https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT"})}),"\n",(0,r.jsx)(n.li,{children:"conflict_target can perform unique index inference"}),"\n",(0,r.jsxs)(n.li,{children:["\u591A\u5217 UNIQUE \u4F1A\u6709\u95EE\u9898 - ",(0,r.jsx)(n.a,{href:"https://stackoverflow.com/a/38066008/1870054",children:"https://stackoverflow.com/a/38066008/1870054"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5EFA\u8BAE\u901A\u8FC7 generate \u5217\u8C03\u6574 uniqe \u903B\u8F91"}),"\n",(0,r.jsx)(n.li,{children:"\u6216\u8005\u518D\u5EFA\u4E00\u4E2A\u5305\u542B\u6240\u6709 unique \u5217\u7684\u7D22\u5F15"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679C\u60F3\u8981\u8FD4\u56DE EXCLUDED \u53EF\u4EE5\u4F7F\u7528 CTE \u591A\u6B65\u6267\u884C ",(0,r.jsx)(n.a,{href:"https://stackoverflow.com/a/35953488/1870054",children:"https://stackoverflow.com/a/35953488/1870054"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"lateral-join",children:"LATERAL JOIN"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6267\u884C\u4E00\u6B21"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EA4\u53C9\u5F15\u7528\u5176\u4ED6 FROM"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-LATERAL",children:"https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-LATERAL"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u4E0D\u53EF\u4EE5\u518D-where-\u4F7F\u7528\u522B\u540D",children:"\u4E0D\u53EF\u4EE5\u518D WHERE \u4F7F\u7528\u522B\u540D"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4E0D\u53EF\u4EE5\u518D WHERE \u548C HAVING \u4F7F\u7528\u522B\u540D\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/sql-select.html#SQL-SELECT-LIST",children:"https://www.postgresql.org/docs/current/sql-select.html#SQL-SELECT-LIST"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679C\u4E00\u5B9A\u8981\uFF0C\u53EF\u4EE5\u8003\u8651 CTE \u6216 subquery"}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["An output column's name can be used to refer to the column's value in ",(0,r.jsx)(n.code,{children:"ORDER BY"})," and ",(0,r.jsx)(n.code,{children:"GROUP BY"})," clauses, but ",(0,r.jsx)(n.strong,{children:"not"})," in the ",(0,r.jsx)(n.code,{children:"WHERE"})," or ",(0,r.jsx)(n.code,{children:"HAVING"})," clauses; there you must write out the expression instead."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"select username, profiles.age as profile_age\nfrom users,\n  left join profiles on (profiles.user_id = users.id)\n-- \u4E0D\u652F\u6301 \u5F15\u7528\nwhere profile_age > 18;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"csv",children:"csv"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"COPY (SELECT * FROM foo) TO '/tmp/test.csv' WITH CSV DELIMITER ',' HEADER;\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"psql"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"\\copy (SELECT * FROM foo) TO '/tmp/test.csv' WITH CSV DELIMITER ',' HEADER;\n\\copy (SELECT * FROM foo) TO STDOUT WITH CSV DELIMITER ',' HEADER;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-role-if-not-exists",children:"create role if not exists"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"DO\n$do$\nBEGIN\n   IF EXISTS (\n      SELECT FROM pg_catalog.pg_roles\n      WHERE  rolname = 'my_user') THEN\n\n      RAISE NOTICE 'Role \"my_user\" already exists. Skipping.';\n   ELSE\n      CREATE ROLE my_user LOGIN PASSWORD 'my_password';\n   END IF;\nEND\n$do$;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"role-cannot-be-dropped-because-some-objects-depend-on-it---privileges-for-table-users",children:"role cannot be dropped because some objects depend on it - privileges for table users"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"REASSIGN OWNED BY test TO postgres;\nDROP OWNED BY test;\n\nDROP USER test;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-role-if-not-exists-1",children:"create role if not exists"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"DO\n$do$\nBEGIN\n   IF EXISTS (\n      SELECT FROM pg_catalog.pg_roles\n      WHERE  rolname = 'my_user') THEN\n\n      RAISE NOTICE 'Role \"my_user\" already exists. Skipping.';\n   ELSE\n      CREATE ROLE my_user;\n   END IF;\nEND\n$do$;\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5904\u7406 EXCEPTION \u6BD4\u63D0\u524D\u68C0\u6D4B\u66F4\u6162"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"create-policy-if-not-exists",children:"create policy if not exists"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"do\n$do$\n    begin\n        if exists(select *\n                  from pg_catalog.pg_policies\n                  where (schemaname, tablename, policyname) = ('app', 'service_accounts', 'tid'))\n        then\n            raise notice 'policy already exists';\n        else\n            create policy tid on app.service_accounts using (tid = current_tenant_id());\n        end if;\n    end\n$do$;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"add-foreign-key-if-not-exists",children:"add foreign key if not exists"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://stackoverflow.com/q/12855631/1870054",children:"https://stackoverflow.com/q/12855631/1870054"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"DO\n$$\n    BEGIN\n        IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'flow_active_stage_id_fkey') THEN\n            alter table flow\n                add constraint flow_active_stage_id_fkey foreign key (active_stage_id) references flow_stage (id);\n        END IF;\n    END;\n$$;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"array",children:"array"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@> ARRAY(1,2,3)"})," - \u5305\u542B\u6240\u6709"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"<@"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"&& ARRAY(1,2,3)"})," - \u5305\u542B\u4EFB\u610F, overlap"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"||"})," Concatenates"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"'\u5176\u4ED6' like any(tags)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4E0D\u80FD\u505A pattern like\uFF0C\u9700\u8981\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"unnest"})," \u6216\u8005 ",(0,r.jsx)(n.code,{children:"array_to_string"})]}),"\n",(0,r.jsx)(n.li,{children:"pg \u8981\u6C42 any \u5FC5\u987B\u5728\u53F3\u8FB9"}),"\n",(0,r.jsxs)(n.li,{children:["\u7ED3\u679C\u548C ",(0,r.jsx)(n.code,{children:"'\u5176\u4ED6' = any(tags)"})," \u76F8\u540C"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ARRAY[1,2,3]"})," - array constructor"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"'{1,2,3}'"})," - array literal"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u901A\u8FC7\u81EA\u5B9A\u4E49 operator \u5B9E\u73B0 array like \u641C\u7D22\nCREATE OR REPLACE FUNCTION reverse_like (text, text)\n  RETURNS boolean LANGUAGE sql IMMUTABLE PARALLEL SAFE AS\n'SELECT $2 LIKE $1';\n\nCREATE OPERATOR <~~ (function = reverse_like, leftarg = text, rightarg = text);\n\nSELECT *\nFROM   mac_ip_addresses\nWHERE  '192.168.2%.255' <~~ ANY (ipaddress);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://stackoverflow.com/a/55484447/1870054",children:"https://stackoverflow.com/a/55484447/1870054"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/functions-array.html",children:"https://www.postgresql.org/docs/current/functions-array.html"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"any",children:"any"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"expr IN (subquery)"})," -> ",(0,r.jsx)(n.code,{children:"expr operator ANY (subquery)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"expr IN (value [, ...])"})," -> ",(0,r.jsx)(n.code,{children:"expr operator ANY (array expr)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4F1A\u505A\u5185\u90E8\u91CD\u5199 - ",(0,r.jsx)(n.code,{children:"IN"})," -> ",(0,r.jsx)(n.code,{children:"= ANY"}),", ",(0,r.jsx)(n.code,{children:"NOT IN"})," -> ",(0,r.jsx)(n.code,{children:"<> ALL"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"sequence-gap",children:"sequence gap"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u627E\u5230\u5E8F\u5217\u4E2D\u7684\u95F4\u9694"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"select sequence + 1 as gap_start,\n       next_nr - 1  as gap_end\nfrom (select sequence,\n             lead(sequence) over (order by sequence) as next_nr\n      from wecom_archive_message) nr\nwhere sequence + 1 <> next_nr;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"histgram",children:"histgram"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT\n    width_bucket(value, 0, 100, 10) AS bucket,\n    count(*) AS count\nFROM\n    your_table\nGROUP BY\n1\n"})})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},17776:function(e,n,s){s.d(n,{R:()=>c,x:()=>t});var l=s(7378);let r={},i=l.createContext(r);function c(e){let n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);