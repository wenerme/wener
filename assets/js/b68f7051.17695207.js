"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["92971"],{20758:function(e,n,l){l.r(n),l.d(n,{frontMatter:()=>o,toc:()=>i,default:()=>u,metadata:()=>r,assets:()=>t,contentTitle:()=>d});var r=JSON.parse('{"id":"platform/cloudflare/cloudflared","title":"cloudflared","description":"- cloudflare/cloudflared","source":"@site/../notes/platform/cloudflare/cloudflared.md","sourceDirName":"platform/cloudflare","slug":"/platform/cloudflare/cloudflared","permalink":"/notes/platform/cloudflare/cloudflared","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/platform/cloudflare/cloudflared.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1669574227000,"frontMatter":{"title":"cloudflared"},"sidebar":"docs","previous":{"title":"Cloudflare Workers","permalink":"/notes/platform/cloudflare/worker"},"next":{"title":"WARP","permalink":"/notes/platform/cloudflare/warp"}}'),c=l(86106),s=l(17776);let o={title:"cloudflared"},d="cloudflared",t={},i=[{value:"tunnel",id:"tunnel",level:2},{value:"\u8FDC\u7A0B\u542F\u52A8 tunnel",id:"\u8FDC\u7A0B\u542F\u52A8-tunnel",level:2},{value:"config.yaml",id:"configyaml",level:2},{value:"ingress",id:"ingress",level:3},{value:"Unable to establish connection with Cloudflare edge",id:"unable-to-establish-connection-with-cloudflare-edge",level:2},{value:"failed to sufficiently increase receive buffer size",id:"failed-to-sufficiently-increase-receive-buffer-size",level:2}];function a(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"cloudflared",children:"cloudflared"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.a,{href:"https://github.com/cloudflare/cloudflared",children:"cloudflare/cloudflared"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Cloudflare Tunnel client - Argo Tunnel"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\u914D\u7F6E\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"~/.cloudflared/config.yml"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"~/.cloudflared/<UUID>.json"})}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://github.com/cloudflare/argo-tunnel-examples",children:"cloudflare/argo-tunnel-examples"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/",children:"Get started"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/tutorials/warp-to-tunnel/",children:"Warp to Tunnel"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/technical-limitations/",children:"Technical limitations"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.admonition,{type:"caution",children:(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["support haproxy proxy protocol ",(0,c.jsx)(n.a,{href:"https://github.com/cloudflare/cloudflared/issues/369",children:"#369"})]}),"\n"]})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# macOS \u5B89\u88C5\nbrew install cloudflare/cloudflare/cloudflared\n# Docker \u8FD0\u884C\n# https://hub.docker.com/r/cloudflare/cloudflared\ndocker run -v ~/.cloudflared:/etc/cloudflared \\\n  --name cfd cloudflare/cloudflared:2021.4.0 \\\n  tunnel --no-autoupdate --hostname demo.wener.me --url http://localhost:8080\n# Linux \u5B89\u88C5\ncurl -Lo cloudflared https://github.com/cloudflare/cloudflared/releases/download/2021.4.0/cloudflared-linux-amd64\nchmod +x cloudflared\nsudo mv cloudflared /usr/local/bin/\n\n# \u5347\u7EA7\u7248\u672C\ncloudflared update\n\n# \u624B\u52A8\u66F4\u65B0\ncurl -Lo $(which cloudflared) https://github.com/cloudflare/cloudflared/releases/download/2021.11.0/cloudflared-linux-amd64\n"})}),"\n",(0,c.jsx)(n.h2,{id:"tunnel",children:"tunnel"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# \u767B\u9646\u540E\u751F\u6210\u8BC1\u4E66 ~/.cloudflared/cert.pem\ncloudflared tunnel login\n\n# \u521B\u5EFA\u540E\u751F\u6210\u914D\u7F6E ~/.cloudflared/UUID.json\ncloudflared tunnel create dev\ncloudflared tunnel list\n\n# cloudflared tunnel delete dev\n\nTUNNEL_ID=6ff42ae2-765d-4adf-8112-31c55c1551ef\ncat << YAML > ~/.cloudflared/config.yml\ntunnel: dev\ncredentials-file: $HOME/.cloudflared/$TUNNEL_ID.json\n\ningress:\n  - hostname: demo.wener.me\n    service: http://localhost:3000\n  - service: http_status:404\nYAML\n# \u6821\u9A8C\u8DEF\u7531\u89C4\u5219\ncloudflared tunnel ingress validate\n# \u6D4B\u8BD5\u8DEF\u7531\ncloudflared tunnel ingress rule https://demo.wener.me\n# \u542F\u52A8\ncloudflared tunnel run dev\n\n# \u8BBF\u95EE\u670D\u52A1\u9700\u8981\n# CNAME demo.wener.me \u5230 ${TUNNEL_ID}.cfargotunnel.com\ncloudflared tunnel route dns dev demo.wener.me\n# \u81F3\u6B64\u53EF\u4EE5\u901A\u8FC7\u901A\u9053\u8BBF\u95EE\u670D\u52A1\ncurl -L demo.wener.me\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["ArgoTunnel Ports and IPs\n",(0,c.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/ports-and-ips/",children:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/ports-and-ips/"})]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"dig SRV _v2-origintunneld._tcp.argotunnel.com\n\n# --alt-svc altsvc.cache\ncurl --http3 https://region1.v2.argotunnel.com:7844 -kv\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://bagder.github.io/HTTP3-test/",children:"https://bagder.github.io/HTTP3-test/"})}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"\u8FDC\u7A0B\u542F\u52A8-tunnel",children:"\u8FDC\u7A0B\u542F\u52A8 tunnel"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"cloudflared tunnel list\n# \u53EA\u9700\u8981 tunnel json\nTUNNEL_ID=6ff42ae2-765d-4adf-8112-31c55c1551ef\n# rsync \u65B9\u4FBF\u521B\u5EFA\u76EE\u5F55\nrsync --no-owner ~/.cloudflared/$TUNNEL_ID.json admin@192.168.1.1:~/.cloudflared/\nrsync --no-owner ~/.cloudflared/config.yml admin@192.168.1.1:~/.cloudflared/\n"})}),"\n",(0,c.jsx)(n.h2,{id:"configyaml",children:"config.yaml"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-yaml",children:"# \u53EF\u662F\u540D\u5B57\u6216\u8005 ID\n# cloudflared tunnel run NAME-OR-ID\ntunnel: dev\ncredentials-file: /root/.cloudflared/6ff42ae2-765d-4adf-8112-31c55c1551ef.json\ningress:\n  - service: hello_world\n"})}),"\n",(0,c.jsx)(n.h3,{id:"ingress",children:"ingress"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-yaml",children:"# \u8DEF\u7531\u89C4\u5219\ningress:\n  # \u57DF\u540D\u8DEF\u7531\n  - hostname: example.com\n    service: https://localhost:8000\n  # \u57DF\u540D+\u8DEF\u5F84\u89C4\u5219\n  - hostname: '*.example.com'\n    path: /.well-known/acme-challenge/\n    service: https://localhost:8000\n  - hostname: static.example.com\n    path: /*.(jpg|png|css|js)\n    service: https://localhost:8001\n  # \u6CDB\u57DF\u540D\n  - hostname: '*.example.com'\n    service: https://localhost:8002\n  # \u5339\u914D\u6240\u6709 - \u5FC5\u987B\u5305\u542B\u4E00\u4E2A\u6355\u83B7\u6240\u6709\u7684\u89C4\u5219\n  # \u672A\u5339\u914D\u7684\u8BF7\u6C42\u8FD9\u4E2A\u670D\u52A1\n  - service: https://localhost:8003\n  # \u672A\u5339\u914D\u7684\u8FD4\u56DE 404\n  - service: http_status:404\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"service \u89C4\u5219"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://localhost:8000",children:"https://localhost:8000"})}),"\n",(0,c.jsxs)(n.li,{children:["ssh://localhost:2222\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"TCP, RDP, SSH, SMB, kubectl"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["bastion\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"TCP, RDP, SSH, SMB, kubectl"}),"\n",(0,c.jsx)(n.li,{children:"cloudflared \u4F5C\u4E3A\u8DF3\u677F\u673A"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["hello_world\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\u6D4B\u8BD5\u670D\u52A1"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.li,{children:"tcp://localhost:8000"}),"\n",(0,c.jsx)(n.li,{children:"unix:/home/production/echo.sock"}),"\n",(0,c.jsxs)(n.li,{children:["http_status:404\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\u8FD4\u56DE\u72B6\u6001\u7801"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u5982\u679C\u9700\u8981\u8DEF\u7531 Root Domain \u53EA\u9700\u8981\u6DFB\u52A0\u4E00\u4E2A ",(0,c.jsx)(n.strong,{children:"A"})," \u8BB0\u5F55\u5373\u53EF\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"IP \u4EFB\u610F\uFF0C\u4E0D\u91CD\u8981"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/configuration-file/ingress/",children:"Ingress rules"})}),"\n"]}),"\n",(0,c.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,c.jsx)(n.h2,{id:"unable-to-establish-connection-with-cloudflare-edge",children:"Unable to establish connection with Cloudflare edge"}),"\n",(0,c.jsx)(n.p,{children:"7844 \u7AEF\u53E3\u53EF\u80FD\u88AB block\uFF0C \u65E0\u6CD5\u8FDB\u884C quic \u94FE\u63A5"}),"\n",(0,c.jsx)(n.h2,{id:"failed-to-sufficiently-increase-receive-buffer-size",children:"failed to sufficiently increase receive buffer size"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# \u9ED8\u8BA4 208kiB\nsysctl net.core.rmem_max\n\n# \u4FEE\u6539\u4E3A 2.5 MB\nsysctl -w net.core.rmem_max=2500000\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"UDP receive buffer"}),"\n",(0,c.jsx)(n.li,{children:"was: 208 kiB, wanted: 2048 kiB, got: 416 kiB"}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://github.com/lucas-clemente/quic-go/wiki/UDP-Receive-Buffer-Size",children:"https://github.com/lucas-clemente/quic-go/wiki/UDP-Receive-Buffer-Size"})}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(a,{...e})}):a(e)}},17776:function(e,n,l){l.d(n,{R:()=>o,x:()=>d});var r=l(7378);let c={},s=r.createContext(c);function o(e){let n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);