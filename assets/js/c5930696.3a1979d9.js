"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["918617"],{312996:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>r,toc:()=>o,default:()=>h,metadata:()=>i,assets:()=>t,contentTitle:()=>c});var i=JSON.parse('{"id":"db/relational/postgresql/postgresql-index","title":"PostgreSQL Index","description":"- B-tree, Hash, GiST, SP-GiST, GIN, BRIN","source":"@site/../notes/db/relational/postgresql/postgresql-index.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/index","permalink":"/notes/db/relational/postgresql/index","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-index.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1633940899000,"frontMatter":{"title":"PostgreSQL Index"},"sidebar":"docs","previous":{"title":"Functions","permalink":"/notes/db/relational/postgresql/func"},"next":{"title":"PostgreSQL High Performance Insert","permalink":"/notes/db/relational/postgresql/insert"}}'),l=s(486106),d=s(917776);let r={title:"PostgreSQL Index"},c="PostgreSQL Index",t={},o=[{value:"hypopg",id:"hypopg",level:2},{value:"access method &quot;hash&quot; does not support unique indexes",id:"access-method-hash-does-not-support-unique-indexes",level:2},{value:"\u91CD\u590D\u503C\u7D22\u5F15",id:"\u91CD\u590D\u503C\u7D22\u5F15",level:2}];function a(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"postgresql-index",children:"PostgreSQL Index"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"B-tree, Hash, GiST, SP-GiST, GIN, BRIN"}),"\n",(0,l.jsx)(n.li,{children:"\u9ED8\u8BA4 B-tree"}),"\n",(0,l.jsxs)(n.li,{children:["B-tree\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u76F8\u7B49\u548C\u8303\u56F4\u4E0A\u4E0B\u9650 ",(0,l.jsx)(n.code,{children:"<"}),",",(0,l.jsx)(n.code,{children:"<="}),",",(0,l.jsx)(n.code,{children:"="}),",",(0,l.jsx)(n.code,{children:">="}),",",(0,l.jsx)(n.code,{children:">"}),", BETWEEN, IN, IS NULL, IS NOT NULL"]}),"\n",(0,l.jsxs)(n.li,{children:["\u524D\u7F00\u5339\u914D ",(0,l.jsx)(n.code,{children:"LIKE 'foo%'"}),", ",(0,l.jsx)(n.code,{children:"~ '^foo'"}),", ILIKE, ~* \u4E14\u5927\u5C0F\u5199\u5904\u7406\u903B\u8F91\u76F8\u540C"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["HASH - ",(0,l.jsx)(n.code,{children:"="})," \u64CD\u4F5C - \u5982\u679C\u5B58\u5728 HASH \u7D22\u5F15\uFF0C\u4F1A\u4F18\u5148\u4F7F\u7528\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5982\u679C\u786E\u5B9A\u53EA\u4F1A\u7528\u5230 ",(0,l.jsx)(n.code,{children:"="})," \u5EFA\u8BAE\u4F7F\u7528 HASH"]}),"\n",(0,l.jsx)(n.li,{children:"\u5360\u7528\u7A7A\u95F4\u6BD4 B-tree \u5C11\uFF0C\u901F\u5EA6\u66F4\u5FEB"}),"\n",(0,l.jsx)(n.li,{children:"\u4E0D\u53D7\u503C\u957F\u5EA6\u5F71\u54CD"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["GiST\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u652F\u6301\u4E8C\u7EF4\u6570\u636E - ",(0,l.jsx)(n.code,{children:"<<"}),",",(0,l.jsx)(n.code,{children:"&<"}),",",(0,l.jsx)(n.code,{children:"&>"}),",",(0,l.jsx)(n.code,{children:">>"}),",",(0,l.jsx)(n.code,{children:"<<|"}),",",(0,l.jsx)(n.code,{children:"&<|"}),",",(0,l.jsx)(n.code,{children:"|&>"}),",",(0,l.jsx)(n.code,{children:"|>>"}),",",(0,l.jsx)(n.code,{children:"@>"}),",",(0,l.jsx)(n.code,{children:"<@"}),",",(0,l.jsx)(n.code,{children:"~="}),",",(0,l.jsx)(n.code,{children:"&&"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u652F\u6301 nearest-neighbor/\u4E34\u8FD1 \u641C\u7D22 - ",(0,l.jsx)(n.code,{children:"location <-> point '(101,456)'"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["SP-GiST - Space partitioned GiST\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["non-balanced disk-based data structures\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"quadtrees, k-d trees, and radix trees (tries)"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u652F\u6301\u4E8C\u7EF4\u70B9 - ",(0,l.jsx)(n.code,{children:"<<"}),",",(0,l.jsx)(n.code,{children:">>"}),",",(0,l.jsx)(n.code,{children:"~="}),",",(0,l.jsx)(n.code,{children:"<@"}),",",(0,l.jsx)(n.code,{children:"<^"}),",",(0,l.jsx)(n.code,{children:">^"})]}),"\n",(0,l.jsx)(n.li,{children:"\u652F\u6301 nearest-neighbor"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["GIN - inverted indexes\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u9006\u5411\u7D22\u5F15 - \u9002\u7528\u4E8E\u7C7B\u4F3C\u6570\u7EC4\u8FD9\u6837\u7684\u573A\u666F"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"<@"}),",",(0,l.jsx)(n.code,{children:"@>"}),",",(0,l.jsx)(n.code,{children:"="}),",",(0,l.jsx)(n.code,{children:"&&"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["BRIN - Block Range INdexes\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"store summaries about the values stored in consecutive physical block ranges"}),"\n",(0,l.jsx)(n.li,{children:"\u9002\u7528\u4E8E\u8FDE\u7EED\u76F8\u90BB\u6570\u636E"}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"<"}),",",(0,l.jsx)(n.code,{children:"<="}),",",(0,l.jsx)(n.code,{children:"="}),",",(0,l.jsx)(n.code,{children:">="}),",",(0,l.jsx)(n.code,{children:">"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Bloom - ",(0,l.jsx)(n.code,{children:"CREATE EXTENSION bloom;"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u7D22\u5F15\u7C7B\u578B\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u90E8\u5206\u7D22\u5F15"}),"\n",(0,l.jsx)(n.li,{children:"\u8868\u8FBE\u5F0F\u7D22\u5F15"}),"\n",(0,l.jsx)(n.li,{children:"\u552F\u4E00\u7D22\u5F15"}),"\n",(0,l.jsx)(n.li,{children:"\u591A\u5217\u7D22\u5F15"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/powa-team/pg_qualstats",children:"pg_qualstats"})," - An extension collecting statistics about quals\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"quals -> predicates"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/HypoPG/hypopg",children:"hypopg"})," - Hypothetical indexes for PostgreSQL\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u8BC4\u4F30\u7D22\u5F15\u548C Query Plan"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Bitmap Index Scan"}),"\n",(0,l.jsx)(n.li,{children:"Bitmap Heap Scan"}),"\n",(0,l.jsx)(n.li,{children:"Index Scan"}),"\n"]}),"\n",(0,l.jsx)(n.admonition,{type:"tip",children:(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4ECE\u65E7\u7248\u672C pg_upgrade \u5347\u7EA7\u540E\u9700\u8981 REINDEX \u624D\u4F1A\u5229\u7528\u5230\u65B0\u7684\u7D22\u5F15\u7279\u6027"}),"\n",(0,l.jsx)(n.li,{children:"VACUUM FULL \u4F1A\u91CD\u5EFA\u7D22\u5F15"}),"\n",(0,l.jsxs)(n.li,{children:["PostgreSQL 13 BTree \u7D22\u5F15\u4F1A\u53BB\u91CD - \u51CF\u5C11\u78C1\u76D8\u548C\u5185\u5B58\u7A7A\u95F4\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5982\u679C\u5E0C\u671B\u65E7\u7248\u672C\u884C\u4E3A\uFF0C\u53EF\u4EE5 ",(0,l.jsx)(n.code,{children:"deduplicate_items=off"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"null \u4E0D\u60F3\u7B49 - \u56E0\u6B64\u4E0D\u4F1A\u7B97\u5728 unique"}),"\n"]})}),"\n",(0,l.jsx)(n.admonition,{type:"caution",children:(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"UNIQUE INDEX \u53EA\u80FD\u4F7F\u7528 B-tree"}),"\n",(0,l.jsx)(n.li,{children:"\u6392\u5E8F\u53EA\u80FD B-tree"}),"\n",(0,l.jsxs)(n.li,{children:["\u6392\u5E8F\u9690\u542B NULLS LAST, \u9ED8\u8BA4 ASC NULLS LAST - \u56E0\u6B64\u9ED8\u8BA4 DESC NULLS LAST ",(0,l.jsx)(n.strong,{children:"\u4E0D\u4F1A"}),"\u7528\u5230\u7D22\u5F15"]}),"\n"]})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",metastring:'title="\u7D22\u5F15\u652F\u6301\u7684\u64CD\u4F5C"',children:"SELECT am.amname              AS index_method,\n       opc.opcname            AS opclass_name,\n       opc.opcintype::regtype AS indexed_type,\n       opc.opcdefault         AS is_default\nFROM pg_am am,\n     pg_opclass opc\nWHERE opc.opcmethod = am.oid\nORDER BY index_method, opclass_name;\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- Hash \u7D22\u5F15\nCREATE INDEX name ON table USING HASH (column);\n-- \u5982\u679C\u60F3\u8981 Hash unique \u53EF\u4EE5\u4F7F\u7528 constraint\n-- \u4F46 ON CONFLICT \u9700\u8981\u4F7F\u7528 constraint \u540D\u5B57\uFF0Cpg \u4E0D\u80FD\u81EA\u5DF1\u63A8\u5BFC\nalter table tab add constraint cst_exc_id exclude using hash (id with =);\n\n-- \u5185\u7F6E Hash \u51FD\u6570\nSELECT hashtext('text'),\n       hashchar('c'),\n       hash_array(array [1,2,3]),\n       jsonb_hash('{\n         \"me\": \"haki\"\n       }'::jsonb),\n       timestamp_hash(now()::timestamp);\n\n-- \u4E34\u8FD1\u641C\u7D22\nSELECT * FROM places ORDER BY location <-> point '(101,456)' LIMIT 10;\n-- \u7D22\u5F15\u652F\u6301 ORDER \u548C NULL \u987A\u5E8F\nCREATE INDEX test3_desc_index ON test3 (id DESC NULLS LAST);\n\n-- \u7D22\u5F15\u6DFB\u52A0\u989D\u5916\u503C - \u53EF\u4EE5\u8BA9\u5E38\u7528\u67E5\u8BE2\u53EA\u9700\u8981\u8D70\u7D22\u5F15\nCREATE INDEX idx_cust2 ON customer(active) INCLUDE (email);\n\n\n-- \u67E5\u627E\u91CD\u590D\u7D22\u5F15\n  SELECT array_agg(indexname) AS indexes, replace(indexdef, indexname, '') AS defn\n    FROM pg_indexes\nGROUP BY defn\n  HAVING count(*) > 1;\n\n-- \u7D22\u5F15\u4F7F\u7528\u60C5\u51B5\nSELECT relname, indexrelname, idx_scan\nFROM   pg_catalog.pg_stat_user_indexes\nWHERE  schemaname = 'public';\n\n-- \u5E76\u884C\u6784\u5EFA\u7D22\u5F15\n\nSET max_parallel_workers = 32;\nSET max_parallel_maintenance_workers = 16;\n\nCREATE INDEX CONCURRENTLY idx_address1 ON address(district);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"hypopg",children:"hypopg"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM hypopg_create_index('CREATE INDEX ON test (id)');\n\nSELECT * FROM hypopg_list_indexes();\nEXPLAIN SELECT * FROM test WHERE id = 1;\n"})}),"\n",(0,l.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(n.h2,{id:"access-method-hash-does-not-support-unique-indexes",children:'access method "hash" does not support unique indexes'}),"\n",(0,l.jsx)(n.p,{children:"\u652F\u6301 BTree \u53EF\u4EE5 create unique index"}),"\n",(0,l.jsx)(n.h2,{id:"\u91CD\u590D\u503C\u7D22\u5F15",children:"\u91CD\u590D\u503C\u7D22\u5F15"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"PG 13 BTree \u4F1A\u53BB\u91CD\uFF0C\u662F\u6BD4\u8F83\u597D\u7684\u9009\u62E9"}),"\n",(0,l.jsx)(n.li,{children:"\u6839\u636E\u6570\u91CF\u5DEE\u5F02\u60C5\u51B5\uFF0C\u53EF\u4EE5\u9009\u62E9\u90E8\u5206\u7D22\u5F15"}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},917776:function(e,n,s){s.d(n,{R:()=>r,x:()=>c});var i=s(7378);let l={},d=i.createContext(l);function r(e){let n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);