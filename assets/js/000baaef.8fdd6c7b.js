"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["538775"],{954793:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>a,toc:()=>o,default:()=>u,metadata:()=>l,assets:()=>c,contentTitle:()=>i});var l=JSON.parse('{"id":"devops/kubernetes/app/fleet","title":"FleetCD","description":"* rancher/fleet","source":"@site/../notes/devops/kubernetes/app/fleet.md","sourceDirName":"devops/kubernetes/app","slug":"/devops/kubernetes/app/fleet","permalink":"/notes/devops/kubernetes/app/fleet","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/app/fleet.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1606055087000,"frontMatter":{"title":"FleetCD"},"sidebar":"docs","previous":{"title":"external-secrets","permalink":"/notes/devops/kubernetes/app/external-secrets"},"next":{"title":"FluxCD","permalink":"/notes/devops/kubernetes/app/flux"}}'),r=t(486106),s=t(917776);let a={title:"FleetCD"},i="Rancher Fleet",c={},o=[{value:"\u6982\u5FF5",id:"\u6982\u5FF5",level:2},{value:"\u7ED3\u6784",id:"\u7ED3\u6784",level:2},{value:"fleet.yaml",id:"fleetyaml",level:2},{value:"\u8D44\u6E90",id:"\u8D44\u6E90",level:2}];function h(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"rancher-fleet",children:"Rancher Fleet"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/rancher/fleet",children:"rancher/fleet"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u591A\u96C6\u7FA4 GitOps\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4F7F\u7528 clusterSelector, clusterGroupSelector, clusterGroup \u4E3A GitRepo \u9009\u62E9\u96C6\u7FA4 - \u76F4\u63A5\u5E94\u7528\u5230\u591A\u4E2A\u96C6\u7FA4"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5E94\u7528\u81EA\u52A8\u53D1\u73B0\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u68C0\u6D4B fleet.yaml"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u9ED8\u8BA4\u81EA\u52A8\u90E8\u7F72"}),"\n",(0,r.jsx)(n.li,{children:"\u652F\u6301 helm+kustomize \u540C\u65F6"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://fleet.rancher.io/",children:"\u6587\u6863"})}),"\n",(0,r.jsx)(n.li,{children:"\u5B89\u88C5 rancher 2.5+ \u4F1A\u9ED8\u8BA4\u5B89\u88C5 fleet"}),"\n",(0,r.jsxs)(n.li,{children:["\u6CE8\u610F\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u76EE\u524D\u8981\u6C42\u538B\u7F29\u540E\u7684 Repo < 1MB\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5BF9\u4E8E\u975E Helm \u5E94\u7528\uFF0C 1 MB \u9650\u5236\u5C31\u6BD4\u8F83\u5C0F\uFF0C\u56E0\u4E3A CDR \u5305\u542B\u4E86\u5F88\u591A\u5185\u5BB9\uFF0C\u4F8B\u5982 cert-manager 1.6 MB"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://fleet.rancher.io/gitrepo-structure/",children:"https://fleet.rancher.io/gitrepo-structure/"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"ssh \u5BC6\u94A5\u4F1A\u76F4\u63A5\u5B58\u50A8\u5230\u5BF9\u5E94\u7A7A\u95F4\u4E0B\u7684 secret"}),"\n",(0,r.jsxs)(n.li,{children:["namespace \u5FC5\u987B\u8981\u5148\u4E0D\u5B58\u5728\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"fleet \u76F8\u5F53\u4E8E\u662F\u5F3A\u5236\u53D7\u7BA1\u7406\u72B6\u6001"}),"\n",(0,r.jsx)(n.li,{children:"argocd \u4F1A\u5408\u5E76"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/rancher/fleet-examples",children:"rancher/fleet-examples"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# fleet \u5BF9 ssh \u5BC6\u94A5\u6709\u4E00\u5B9A\u8981\u6C42\uFF0C\u683C\u5F0F\u5FC5\u987B\u4E3A EC PRIVATE KEY, RSA PRIVATE KEY, PRIVATE KEY \u56E0\u6B64\u9700\u8981 -m pem\n# \u751F\u6210 SSH \u5BC6\u94A5\u5230 /tmp/fleet /tmp/fleet.pub\nssh-keygen -t rsa -b 4096 -m pem -C "fleet@example" -q -N "" -f /tmp/fleet\n\n# fleet \u7528\u7684 ssh secret\nkubectl create secret generic --dry-run=client -o yaml \\\n  fleet-ssh \\\n  --type kubernetes.io/ssh-auth \\\n  --from-file=ssh-privatekey=/tmp/fleet \\\n  --from-file=ssh-publickey=/tmp/fleet.pub > fleet-ssh.secret.yaml\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u6982\u5FF5",children:"\u6982\u5FF5"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Fleet Manager\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4E2D\u63A7 - \u591A\u96C6\u7FA4\u53EA\u9700\u8981\u542F\u4E00\u4E2A"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Fleet controller\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EA\u662F\u6982\u5FF5\u5C42\uFF0C\u5B9E\u9645\u4F7F\u7528 manager \u4E0E controller \u65E0\u533A\u522B"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5355\u96C6\u7FA4\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Manager \u4E0E\u53D7\u63A7\u96C6\u7FA4\u5728\u4E00\u8D77"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u591A\u96C6\u7FA4\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Manager \u4F4D\u4E8E\u5176\u4ED6\u96C6\u7FA4\uFF0CController \u5728\u53D7\u63A7\u96C6\u7FA4"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Fleet agent\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53D7\u63A7\u96C6\u7FA4\u7684\u4EE3\u7406\uFF0C\u4E0E manager \u4EA4\u4E92"}),"\n",(0,r.jsx)(n.li,{children:"\u4E00\u7EC4\u7EC4\u4EF6"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u7ED3\u6784",children:"\u7ED3\u6784"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["/\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Chart.yaml"}),"\n",(0,r.jsx)(n.li,{children:"kustomization.yaml"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u4EFB\u610F\u76EE\u5F55/fleet.yaml"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"*.yaml"})," - \u6CA1\u6709 Chart \u548C kustomization \u5219\u4F1A\u90E8\u7F72\u6240\u6709 yaml"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"overlays/{name}"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"fleetyaml",children:"fleet.yaml"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://fleet.rancher.io/gitrepo-structure/#fleetyaml",children:"fleet.yaml"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# \u53EF\u5728\u914D\u7F6E\u65F6\u4FEE\u6539\ndefaultNamespace: default\n\n# \u5F3A\u5236\u6307\u5B9A - \u8D44\u6E90\u5DF2\u5B58\u5728\u4F1A\u90E8\u7F72\u5931\u8D25\nnamespace: ""\n\n# kustomize \u90E8\u7F72\nkustomize:\n  # \u76EE\u5F55\u4E0B\u5305\u542B kustomization.yaml\n  dir: ./kustomize\n\n# helm \u90E8\u7F72\nhelm:\n  # chart \u4F4D\u7F6E - \u652F\u6301 https://github.com/hashicorp/go-getter URL\n  chart: ./chart\n  # \u6307\u5B9A chart \u4ED3\u5E93 - \u6307\u5B9A\u540E chart \u5219\u53D8\u4E3A\u4ED3\u5E93\u4E2D\u7684 chart \u540D\u800C\u975E chart \u4F4D\u7F6E\n  repo: https://charts.rancher.io\n  # release \u540D\u5B57 - \u4E0D\u6307\u5B9A\u4F1A\u751F\u6210\n  releaseName: my-release\n  # chart \u7248\u672C - \u652F\u6301 semver \u7248\u672C \u8303\u56F4\u9650\u5B9A\n  version: 0.1.0\n  # inline \u7684 value \u503C\n  values:\n    any-custom: value\n  # \u8986\u76D6\u4E0D\u53EF\u53D8\u8D44\u6E90 - \u5F00\u542F\u6709\u4E00\u5B9A\u5371\u9669\n  force: false\n\n# \u5982\u679C\u6682\u505C\uFF0C\u5219\u9700\u8981\u624B\u52A8\u540C\u6B65\npaused: false\n\nrolloutStrategy:\n    # A number or percentage of clusters that can be unavailable during an update\n    # of a bundle. This follows the same basic approach as a deployment rollout\n    # strategy.\n    # default: 10%\n    maxUnavailable: 15%\n    # A number or percentage of cluster partitions that can be unavailable during\n    # an update of a bundle.\n    # default: 0\n    maxUnavailablePartitions: 20%\n    # A number of percentage of how to automatically partition clusters if not\n    # specific partitioning strategy is configured.\n    # default: 25%\n    autoPartitionSize: 10%\n    # A list of definitions of partitions.  If any target clusters do not match\n    # the configuration they are added to partitions at the end following the\n    # autoPartitionSize.\n    partitions:\n      # A user friend name given to the partition used for Display (optional).\n      # default: ""\n    - name: canary\n      # A number or percentage of clusters that can be unavailable in this\n      # partition before this partition is treated as done.\n      # default: 10%\n      maxUnavailable: 10%\n      # Selector matching cluster labels to include in this partition\n      clusterSelector:\n        matchLabels:\n          env: prod\n      # A cluster group name to include in this partition\n      clusterGroup: agroup\n      # Selector matching cluster group labels to include in this partition\n      clusterGroupSelector: agroup\n\n# \u9009\u62E9\u76EE\u6807\u81EA\u5B9A\u4E49 - \u76EE\u6807\u6309\u5E8F\u9009\u62E9\ntargetCustomizations:\n- name: prod # \u540D\u5B57\u4EC5\u7528\u4E8E\u5C55\u793A - \u4E0D\u8BBE\u7F6E\u4F1A\u751F\u6210\n  # \u8986\u76D6\u547D\u540D\u7A7A\u95F4\n  namespace: newvalue\n  # \u8986\u76D6 kustomize \u9009\u9879\n  kustomize: {}\n  # \u8986\u76D6 helm \u9009\u9879\n  helm: {}\n  # YAML \u6E05\u5355\u90E8\u7F72\n  # \u5B9A\u4E49 overlays/{name} \u8986\u76D6\u7684\u540D\u5B57\u5217\u8868 - \u7528\u4E8E\u4FEE\u6539\u548C\u6DFB\u52A0\u8D44\u6E90\n  # \u4F8B\u5982\n  #   ./overlays/myoverlay/subdir/resource.yaml \u4F1A\u66FF\u4EE3 ./subdir/resource.yaml\n  #   ./overlays/myoverlay/subdir/resource_patch.yaml \u4F1A\u4FEE\u6539 ./subdir/resource.yaml\n  yaml:\n    overlays:\n    - custom2\n    - custom3\n  # \u96C6\u7FA4\u9009\u62E9\u5668 - metav1.LabelSelector\n  clusterSelector:\n    matchLabels:\n      env: prod\n  # \u96C6\u7FA4\u5206\u7EC4\u9009\u62E9\u5668\n  clusterGroupSelector:\n    matchLabels:\n      region: us-east\n  # \u9009\u62E9\u6307\u5B9A\u5206\u7EC4\n  clusterGroup: group1\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u8D44\u6E90",children:"\u8D44\u6E90"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"---\n# \u5B9A\u4E49 Repo\nkind: GitRepo\napiVersion: fleet.cattle.io/v1alpha1\nmetadata:\n  name: helm\n  namespace: fleet-local\nspec:\n  repo: https://github.com/rancher/fleet-examples/\n  paths:\n  - single-cluster/helm\n---\n# \u590D\u6742 Repo\napiVersion: fleet.cattle.io/v1alpha1\nkind: GitRepo\nmetadata:\n  name: my-deploy\n  # fleet \u7A7A\u95F4\n  namespace: fleet-default\nspec:\n  branch: master\n  # ssh \u5BC6\u94A5\n  clientSecretName: fleet-ssh-secret\n  paths:\n  - subpath\n  repo: git@gitea-ssh.gitea:my/repo\n  # \u9009\u62E9\u76EE\u6807\u96C6\u7FA4\n  targets:\n  - clusterSelector: {}\n---\n# \u5B9A\u4E49\u96C6\u7FA4\u5206\u7EC4\napiVersion: fleet.cattle.io/v1alpha1\nkind: ClusterGroup\nmetadata:\n  name: default\n  namespace: fleet-default\nspec:\n  selector:\n    matchLabels:\n      env: prod\n    matchExpressions:\n#      - key: string\n#        operator: string\n#        values:\n#          - string\n"})})]})}function u(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},917776:function(e,n,t){t.d(n,{R:()=>a,x:()=>i});var l=t(7378);let r={},s=l.createContext(r);function a(e){let n=l.useContext(s);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),l.createElement(s.Provider,{value:n},e.children)}}}]);