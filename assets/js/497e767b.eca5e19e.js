"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["606627"],{130215:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>l,toc:()=>a,default:()=>h,metadata:()=>i,assets:()=>c,contentTitle:()=>d});var i=JSON.parse('{"id":"ai/agent/openclaw","title":"OpenClaw \u9879\u76EE\u5206\u6790","description":"- openclaw/openclaw","source":"@site/../notes/ai/agent/openclaw.md","sourceDirName":"ai/agent","slug":"/ai/agent/openclaw","permalink":"/notes/ai/agent/openclaw","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/ai/agent/openclaw.md","tags":[{"inline":true,"label":"AI","permalink":"/notes/tags/ai"},{"inline":true,"label":"Gateway","permalink":"/notes/tags/gateway"},{"inline":true,"label":"TypeScript","permalink":"/notes/tags/type-script"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1772429368000,"frontMatter":{"title":"OpenClaw \u9879\u76EE\u5206\u6790","tags":["AI","Gateway","TypeScript"]},"sidebar":"docs","previous":{"title":"NanoBot","permalink":"/notes/ai/agent/nanobot"},"next":{"title":"opencode","permalink":"/notes/ai/agent/opencode"}}'),t=s(486106),r=s(917776);let l={title:"OpenClaw \u9879\u76EE\u5206\u6790",tags:["AI","Gateway","TypeScript"]},d="OpenClaw",c={},a=[{value:"\u6838\u5FC3\u67B6\u6784",id:"\u6838\u5FC3\u67B6\u6784",level:2},{value:"1. \u6D88\u606F\u5904\u7406\u6D41\u7A0B",id:"1-\u6D88\u606F\u5904\u7406\u6D41\u7A0B",level:3},{value:"2. Channel \u7CFB\u7EDF",id:"2-channel-\u7CFB\u7EDF",level:3},{value:"\u5185\u7F6E\u6E20\u9053 (dock.ts)",id:"\u5185\u7F6E\u6E20\u9053-dockts",level:4},{value:"\u63D2\u4EF6\u7C7B\u578B (ChannelPlugin)",id:"\u63D2\u4EF6\u7C7B\u578B-channelplugin",level:4},{value:"\u6E20\u9053\u6CE8\u518C (registry.ts)",id:"\u6E20\u9053\u6CE8\u518C-registryts",level:4},{value:"3. \u8DEF\u7531\u7CFB\u7EDF (resolve-route.ts)",id:"3-\u8DEF\u7531\u7CFB\u7EDF-resolve-routets",level:3},{value:"4. Gateway \u670D\u52A1\u5668 (server.impl.ts)",id:"4-gateway-\u670D\u52A1\u5668-serverimplts",level:3},{value:"Agent \u4E8B\u4EF6\u5904\u7406 (server-chat.ts)",id:"agent-\u4E8B\u4EF6\u5904\u7406-server-chatts",level:4},{value:"5. Agent \u8FD0\u884C\u65F6",id:"5-agent-\u8FD0\u884C\u65F6",level:3},{value:"Pi Embedded Runner (pi-embedded-subscribe.ts)",id:"pi-embedded-runner-pi-embedded-subscribets",level:4},{value:"6. \u6D88\u606F\u5C01\u88C5 (envelope.ts)",id:"6-\u6D88\u606F\u5C01\u88C5-envelopets",level:3},{value:"7. \u914D\u7F6E\u7CFB\u7EDF",id:"7-\u914D\u7F6E\u7CFB\u7EDF",level:3},{value:"\u8BBE\u8BA1\u7279\u70B9",id:"\u8BBE\u8BA1\u7279\u70B9",level:2}];function o(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"openclaw",children:"OpenClaw"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/openclaw/openclaw",children:"openclaw/openclaw"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"MIT, TypeScript"}),"\n",(0,t.jsx)(n.li,{children:"\u591A\u6E20\u9053 AI \u7F51\u5173\uFF0C\u53EF\u6269\u5C55\u7684\u6D88\u606F\u96C6\u6210\u5E73\u53F0"}),"\n",(0,t.jsx)(n.li,{children:"\u652F\u6301 Telegram\u3001WhatsApp\u3001Discord\u3001Slack\u3001Signal\u3001iMessage \u7B49 35+ \u6E20\u9053"}),"\n",(0,t.jsxs)(n.li,{children:["\u5185\u7F6E OpenAI \u517C\u5BB9 API (",(0,t.jsx)(n.code,{children:"/v1/chat/completions"}),")\uFF0C\u652F\u6301\u591A Agent \u8DEF\u7531"]}),"\n",(0,t.jsx)(n.li,{children:"\u63D0\u4F9B WebSocket Gateway\u3001Control UI\u3001\u539F\u751F\u5BA2\u6237\u7AEF (macOS/iOS/Android)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"openclaw/\n\u251C\u2500\u2500 src/                    # \u6838\u5FC3\u6E90\u7801\n\u2502   \u251C\u2500\u2500 agents/             # AI Agent \u8FD0\u884C\u65F6\uFF08Pi embedded runner\uFF09\n\u2502   \u251C\u2500\u2500 auto-reply/         # \u6D88\u606F\u8C03\u5EA6\u4E0E\u56DE\u590D\u5904\u7406\n\u2502   \u251C\u2500\u2500 channels/           # \u6E20\u9053\u5B9A\u4E49\uFF08dock/registry/plugin types\uFF09\n\u2502   \u2502   \u2514\u2500\u2500 plugins/        # \u6E20\u9053\u63D2\u4EF6\u7C7B\u578B\u5B9A\u4E49\n\u2502   \u251C\u2500\u2500 cli/                # CLI \u5165\u53E3\u4E0E\u547D\u4EE4\n\u2502   \u251C\u2500\u2500 commands/           # \u5404CLI\u5B50\u547D\u4EE4\u5B9E\u73B0\n\u2502   \u251C\u2500\u2500 config/             # \u914D\u7F6E\u52A0\u8F7D/\u6821\u9A8C/\u8FC1\u79FB\uFF08JSON5\uFF09\n\u2502   \u251C\u2500\u2500 gateway/            # WebSocket/HTTP \u7F51\u5173\u670D\u52A1\u5668\n\u2502   \u251C\u2500\u2500 infra/              # \u57FA\u7840\u8BBE\u65BD\uFF08\u65E5\u5FD7/\u4E8B\u4EF6/\u66F4\u65B0\u68C0\u67E5\u7B49\uFF09\n\u2502   \u251C\u2500\u2500 media/              # \u5A92\u4F53\u5904\u7406\u7BA1\u9053\n\u2502   \u251C\u2500\u2500 provider-web.ts     # Web Provider\n\u2502   \u2514\u2500\u2500 routing/            # \u6D88\u606F\u8DEF\u7531\n\u251C\u2500\u2500 extensions/             # \u6E20\u9053\u6269\u5C55\u63D2\u4EF6\uFF0835+\u4E2A workspace packages\uFF09\n\u251C\u2500\u2500 apps/                   # \u539F\u751F\u5BA2\u6237\u7AEF\uFF08macOS/iOS/Android\uFF09\n\u251C\u2500\u2500 ui/                     # Control UI \u524D\u7AEF\n\u251C\u2500\u2500 docs/                   # \u6587\u6863\n\u2514\u2500\u2500 skills/                 # Agent Skills\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u6838\u5FC3\u67B6\u6784",children:"\u6838\u5FC3\u67B6\u6784"}),"\n",(0,t.jsx)(n.h3,{id:"1-\u6D88\u606F\u5904\u7406\u6D41\u7A0B",children:"1. \u6D88\u606F\u5904\u7406\u6D41\u7A0B"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u7528\u6237\u6D88\u606F \u2500\u2192 Channel Plugin (inbound)\n              \u2502\n              \u25BC\n         MsgContext (envelope \u5C01\u88C5)\n              \u2502  [channel, from, body, timestamp, chatType, sessionKey]\n              \u25BC\n    dispatchInboundMessage()          \u2190 src/auto-reply/dispatch.ts\n              \u2502\n              \u25BC\n      getReplyFromConfig()            \u2190 src/auto-reply/reply/get-reply.ts\n         \u2502  1. \u89E3\u6790 agent/session (resolveSessionAgentId)\n         \u2502  2. \u89E3\u6790 model/provider (resolveDefaultModel)\n         \u2502  3. \u5E94\u7528 media/link understanding\n         \u2502  4. \u6821\u9A8C\u547D\u4EE4\u6743\u9650 (resolveCommandAuthorization)\n         \u2502  5. \u521D\u59CB\u5316 session state\n         \u2502  6. \u5904\u7406 directives (model\u5207\u6362/think/verbose/elevated)\n         \u2502  7. \u5904\u7406 inline actions (status/reset/compact \u7B49\u547D\u4EE4)\n         \u2502\n         \u25BC\n    runPreparedReply()                \u2190 \u8C03\u7528 Pi embedded runner\n         \u2502\n         \u25BC\n    subscribeEmbeddedPiSession()      \u2190 src/agents/pi-embedded-subscribe.ts\n         \u2502  - \u8BA2\u9605 LLM provider stream\n         \u2502  - strip thinking/final tags\n         \u2502  - block chunking (\u5206\u5757\u56DE\u590D)\n         \u2502  - reasoning stream \u5904\u7406\n         \u2502  - tool output \u683C\u5F0F\u5316\n         \u2502  - compaction retry \u7BA1\u7406\n         \u2502\n         \u25BC\n    ReplyDispatcher (\u56DE\u590D\u5206\u53D1)\n         \u2502  - onBlockReply: \u5206\u5757\u53D1\u9001\n         \u2502  - onToolResult: \u5DE5\u5177\u7ED3\u679C\n         \u2502  - typing indicator \u7BA1\u7406\n         \u2502\n         \u25BC\n    Channel Plugin (outbound)  \u2500\u2192  \u7528\u6237\u6536\u5230\u56DE\u590D\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-channel-\u7CFB\u7EDF",children:"2. Channel \u7CFB\u7EDF"}),"\n",(0,t.jsx)(n.h4,{id:"\u5185\u7F6E\u6E20\u9053-dockts",children:"\u5185\u7F6E\u6E20\u9053 (dock.ts)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"DOCKS"})," \u5E38\u91CF\u5B9A\u4E49\u4E86 8 \u4E2A\u5185\u7F6E\u6E20\u9053\u7684\u5143\u6570\u636E\uFF1A"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u6E20\u9053"}),(0,t.jsx)(n.th,{children:"capabilities"}),(0,t.jsx)(n.th,{children:"\u7279\u6027"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Telegram"}),(0,t.jsx)(n.td,{children:"outbound, streaming, groups, mentions"}),(0,t.jsx)(n.td,{children:"\u652F\u6301 thread reply"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"WhatsApp"}),(0,t.jsx)(n.td,{children:"outbound, groups, mentions"}),(0,t.jsx)(n.td,{children:"JID \u683C\u5F0F\u5904\u7406"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Discord"}),(0,t.jsx)(n.td,{children:"outbound, streaming, groups, mentions"}),(0,t.jsx)(n.td,{children:"\u9891\u9053/DM \u9002\u914D"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"IRC"}),(0,t.jsx)(n.td,{children:"outbound, groups, mentions"}),(0,t.jsx)(n.td,{children:"\u4F20\u7EDF IRC \u534F\u8BAE"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Google Chat"}),(0,t.jsx)(n.td,{children:"outbound, groups"}),(0,t.jsx)(n.td,{children:"Google Workspace \u96C6\u6210"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Slack"}),(0,t.jsx)(n.td,{children:"outbound, streaming, groups, mentions"}),(0,t.jsx)(n.td,{children:"Bot + App \u6A21\u5F0F"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Signal"}),(0,t.jsx)(n.td,{children:"outbound, groups, mentions"}),(0,t.jsx)(n.td,{children:"\u7AEF\u5230\u7AEF\u52A0\u5BC6"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"iMessage"}),(0,t.jsx)(n.td,{children:"outbound, groups, mentions"}),(0,t.jsx)(n.td,{children:"AppleScript \u6865\u63A5"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["\u6BCF\u4E2A dock \u5305\u542B: ",(0,t.jsx)(n.code,{children:"capabilities"}),", ",(0,t.jsx)(n.code,{children:"streamingDefaults"}),", ",(0,t.jsx)(n.code,{children:"groupAdapter"}),", ",(0,t.jsx)(n.code,{children:"mentionAdapter"}),", ",(0,t.jsx)(n.code,{children:"threadingAdapter"}),", ",(0,t.jsx)(n.code,{children:"outboundAdapter"})," \u7B49\u3002"]}),"\n",(0,t.jsx)(n.h4,{id:"\u63D2\u4EF6\u7C7B\u578B-channelplugin",children:"\u63D2\u4EF6\u7C7B\u578B (ChannelPlugin)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"type ChannelPlugin<ResolvedAccount, Probe, Audit> = {\n  id: ChannelId;\n  meta: ChannelMeta; // label, docs, image \u7B49\n  capabilities: ChannelCapabilities; // outbound, streaming, groups, mentions\n  config: ChannelConfigAdapter; // \u914D\u7F6E\u89E3\u6790\n  setup?: ChannelSetupAdapter; // \u521D\u59CB\u5316\n  pairing?: ChannelPairingAdapter; // \u914D\u5BF9\u8FDE\u63A5\n  security?: ChannelSecurityAdapter; // DM\u7B56\u7565/\u6743\u9650\n  groups?: ChannelGroupAdapter; // \u7FA4\u7EC4\u5904\u7406\n  mentions?: ChannelMentionAdapter; // @\u63D0\u53CA\u5904\u7406\n  outbound?: ChannelOutboundAdapter; // \u53D1\u9001\u6D88\u606F\n  streaming?: ChannelStreamingAdapter; // \u6D41\u5F0F\u56DE\u590D\n  threading?: ChannelThreadingAdapter; // \u7EBF\u7A0B\u56DE\u590D\n  messaging?: ChannelMessagingAdapter; // \u6D88\u606F\u683C\u5F0F\u5316\n  gateway?: ChannelGatewayAdapter; // \u7F51\u5173\u96C6\u6210\n  heartbeat?: ChannelHeartbeatAdapter; // \u5FC3\u8DF3\u68C0\u6D4B\n  agentTools?: ChannelAgentToolFactory; // \u6E20\u9053\u4E13\u5C5E\u5DE5\u5177\n  // ... \u66F4\u591A\u9002\u914D\u5668\n};\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u6E20\u9053\u6CE8\u518C-registryts",children:"\u6E20\u9053\u6CE8\u518C (registry.ts)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"CHAT_CHANNEL_META"})," \u7EF4\u62A4\u6BCF\u4E2A\u6E20\u9053\u7684:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"label / alias (\u522B\u540D)"}),"\n",(0,t.jsx)(n.li,{children:"docs path (\u6587\u6863\u8DEF\u5F84)"}),"\n",(0,t.jsx)(n.li,{children:"system image (\u7CFB\u7EDF\u56FE\u6807)"}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"normalizeChatChannelId()"})," \u7EDF\u4E00\u6E20\u9053ID"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"3-\u8DEF\u7531\u7CFB\u7EDF-resolve-routets",children:"3. \u8DEF\u7531\u7CFB\u7EDF (resolve-route.ts)"}),"\n",(0,t.jsx)(n.p,{children:"\u6839\u636E\u591A\u7EF4\u5EA6\u7ED1\u5B9A\u89E3\u6790\u6D88\u606F\u5E94\u8BE5\u8DEF\u7531\u5230\u54EA\u4E2A Agent\uFF1A"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u4F18\u5148\u7EA7 (\u4ECE\u9AD8\u5230\u4F4E):\n  1. peer binding    \u2192 \u7279\u5B9A\u8054\u7CFB\u4EBA\u7ED1\u5B9A\n  2. guild binding   \u2192 \u7FA4\u7EC4/\u670D\u52A1\u5668\u7ED1\u5B9A\n  3. team binding    \u2192 \u56E2\u961F\u7ED1\u5B9A\n  4. account binding \u2192 \u8D26\u53F7\u7EA7\u7ED1\u5B9A\n  5. channel binding \u2192 \u6E20\u9053\u7EA7\u7ED1\u5B9A\n  6. default agent   \u2192 \u5168\u5C40\u9ED8\u8BA4\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8F93\u51FA ",(0,t.jsx)(n.code,{children:"ResolvedAgentRoute"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"agentId"})," \u2014 \u76EE\u6807 agent"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"sessionKey"})," \u2014 session \u6301\u4E45\u5316 key (\u683C\u5F0F: ",(0,t.jsx)(n.code,{children:"channel:accountId:agentId:peer/guild"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"mainSessionKey"})," \u2014 \u4E3B session key (\u4E0D\u542B agent \u540E\u7F00)"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"4-gateway-\u670D\u52A1\u5668-serverimplts",children:"4. Gateway \u670D\u52A1\u5668 (server.impl.ts)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"startGatewayServer()"})," \u7F16\u6392\u6240\u6709\u7F51\u5173\u7EC4\u4EF6:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Gateway Server (\u9ED8\u8BA4\u7AEF\u53E3 18789)\n\u2502\n\u251C\u2500\u2500 WebSocket Server (attachGatewayWsHandlers)\n\u2502   \u251C\u2500\u2500 \u5BA2\u6237\u7AEF\u7BA1\u7406 (clients, broadcast)\n\u2502   \u251C\u2500\u2500 Node Registry (\u8FDC\u7A0B\u8282\u70B9)\n\u2502   \u251C\u2500\u2500 \u65B9\u6CD5\u6CE8\u518C (coreGatewayHandlers + plugin handlers)\n\u2502   \u2514\u2500\u2500 Agent Event \u8BA2\u9605 (createAgentEventHandler)\n\u2502\n\u251C\u2500\u2500 HTTP Endpoints\n\u2502   \u251C\u2500\u2500 Control UI (SPA \u524D\u7AEF)\n\u2502   \u251C\u2500\u2500 POST /v1/chat/completions (OpenAI \u517C\u5BB9)\n\u2502   \u2514\u2500\u2500 POST /v1/responses (OpenResponses API)\n\u2502\n\u251C\u2500\u2500 Channel Manager (createChannelManager)\n\u2502   \u251C\u2500\u2500 \u6E20\u9053\u8FD0\u884C\u65F6\u7BA1\u7406 (start/stop/status)\n\u2502   \u2514\u2500\u2500 Runtime Snapshot (\u76D1\u63A7)\n\u2502\n\u251C\u2500\u2500 Discovery Service (mDNS/Bonjour + Wide Area)\n\u251C\u2500\u2500 Cron Service (\u5B9A\u65F6\u4EFB\u52A1)\n\u251C\u2500\u2500 Heartbeat Runner (\u5FC3\u8DF3)\n\u251C\u2500\u2500 Config Reloader (\u914D\u7F6E\u70ED\u91CD\u8F7D)\n\u251C\u2500\u2500 TLS Runtime (\u53EF\u9009)\n\u251C\u2500\u2500 Tailscale Exposure (\u53EF\u9009)\n\u251C\u2500\u2500 Canvas Host (\u53EF\u9009, \u4EE3\u7801\u6267\u884C\u6C99\u7BB1)\n\u2514\u2500\u2500 Browser Control (\u53EF\u9009)\n"})}),"\n",(0,t.jsx)(n.h4,{id:"agent-\u4E8B\u4EF6\u5904\u7406-server-chatts",children:"Agent \u4E8B\u4EF6\u5904\u7406 (server-chat.ts)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"createAgentEventHandler"})," \u5904\u7406 agent \u8FD0\u884C\u65F6\u4EA7\u751F\u7684\u4E8B\u4EF6:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"assistant stream"})," \u2192 \u5E7F\u64AD ",(0,t.jsx)(n.code,{children:"chat.delta"})," \u7ED9 WebSocket \u5BA2\u6237\u7AEF"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"run lifecycle"})," \u2192 \u5E7F\u64AD ",(0,t.jsx)(n.code,{children:"chat.run.start"})," / ",(0,t.jsx)(n.code,{children:"chat.run.end"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"tool events"})," \u2192 \u5E7F\u64AD\u7ED9\u5DF2\u6CE8\u518C\u7684 tool event \u8BA2\u9605\u8005"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"chat finalization"})," \u2192 \u53D1\u9001\u6700\u7EC8\u56DE\u590D\u6D88\u606F"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ChatRunState"})," \u7BA1\u7406:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"buffers"}),": \u6BCF\u4E2A runId \u7684\u6D88\u606F\u7F13\u51B2"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"deltaSentAt"}),": \u6D41\u5F0F delta \u53D1\u9001\u65F6\u95F4\u6233"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"abortedRuns"}),": \u88AB\u4E2D\u6B62\u7684\u8FD0\u884C\u8BB0\u5F55"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"5-agent-\u8FD0\u884C\u65F6",children:"5. Agent \u8FD0\u884C\u65F6"}),"\n",(0,t.jsx)(n.h4,{id:"pi-embedded-runner-pi-embedded-subscribets",children:"Pi Embedded Runner (pi-embedded-subscribe.ts)"}),"\n",(0,t.jsx)(n.p,{children:"\u6838\u5FC3\u7684 LLM \u4EA4\u4E92\u8BA2\u9605\u5668\uFF0C600+ \u884C:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"stream \u4E8B\u4EF6\u8BA2\u9605"}),": \u5904\u7406 ",(0,t.jsx)(n.code,{children:"text_delta"}),", ",(0,t.jsx)(n.code,{children:"text_end"}),", ",(0,t.jsx)(n.code,{children:"message_end"})," \u7B49\u4E8B\u4EF6"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"thinking tag \u8FC7\u6EE4"}),": \u6B63\u5219\u5339\u914D ",(0,t.jsx)(n.code,{children:"<think>/<thinking>/<thought>/<antthinking>"})," \u6807\u7B7E"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"block chunking"}),": \u5C06\u957F\u56DE\u590D\u6309\u5757\u5206\u53D1 (",(0,t.jsx)(n.code,{children:"emitBlockChunk"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"reasoning stream"}),": \u72EC\u7ACB\u7684\u63A8\u7406\u8FC7\u7A0B\u8F93\u51FA (",(0,t.jsx)(n.code,{children:"emitReasoningStream"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"tool \u7ED3\u679C\u683C\u5F0F\u5316"}),": ",(0,t.jsx)(n.code,{children:"emitToolSummary"}),", ",(0,t.jsx)(n.code,{children:"emitToolOutput"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"compaction"}),": \u4E0A\u4E0B\u6587\u538B\u7F29\u4E0E\u91CD\u8BD5"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"usage tracking"}),": token \u4F7F\u7528\u91CF\u8BB0\u5F55"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"6-\u6D88\u606F\u5C01\u88C5-envelopets",children:"6. \u6D88\u606F\u5C01\u88C5 (envelope.ts)"}),"\n",(0,t.jsx)(n.p,{children:"\u5165\u7AD9\u6D88\u606F\u88AB\u683C\u5F0F\u5316\u4E3A\u6807\u51C6\u4FE1\u5C01\u683C\u5F0F:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[Channel From +elapsed Timestamp] body\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4F8B\u5982: ",(0,t.jsx)(n.code,{children:"[Telegram Alice +5m Wed 2025-01-15 14:30:00] Hello, how are you?"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u652F\u6301\u591A\u79CD\u65F6\u533A\u6A21\u5F0F: ",(0,t.jsx)(n.code,{children:"utc"}),", ",(0,t.jsx)(n.code,{children:"local"}),", ",(0,t.jsx)(n.code,{children:"user"}),", IANA timezone"]}),"\n",(0,t.jsx)(n.li,{children:"\u7FA4\u7EC4\u6D88\u606F\u81EA\u52A8\u6DFB\u52A0\u53D1\u9001\u8005\u524D\u7F00"}),"\n",(0,t.jsx)(n.li,{children:"header \u90E8\u5206\u5B89\u5168\u6E05\u7406\uFF08\u9632\u6B62\u6CE8\u5165\uFF09"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"7-\u914D\u7F6E\u7CFB\u7EDF",children:"7. \u914D\u7F6E\u7CFB\u7EDF"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u683C\u5F0F"}),": JSON5 \u914D\u7F6E\u6587\u4EF6"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u6821\u9A8C"}),": Zod schema \u9A8C\u8BC1"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u70ED\u91CD\u8F7D"}),": ",(0,t.jsx)(n.code,{children:"startGatewayConfigReloader"})," \u76D1\u542C\u914D\u7F6E\u53D8\u5316"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u9057\u7559\u8FC1\u79FB"}),": ",(0,t.jsx)(n.code,{children:"migrateLegacyConfig"})," \u81EA\u52A8\u8FC1\u79FB\u65E7\u683C\u5F0F"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u63D2\u4EF6\u81EA\u52A8\u52A0\u8F7D"}),": ",(0,t.jsx)(n.code,{children:"applyPluginAutoEnable"})," \u6839\u636E\u73AF\u5883\u53D8\u91CF\u81EA\u52A8\u542F\u7528"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u5173\u952E\u914D\u7F6E\u7ED3\u6784:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"OpenClawConfig = {\n  agents: { defaults, bindings },  // Agent \u914D\u7F6E\n  channels: { ... },               // \u6E20\u9053\u914D\u7F6E\n  session: { ... },                // Session \u914D\u7F6E\n  gateway: {                       // Gateway \u914D\u7F6E\n    http: { endpoints },\n    tls, controlUi, auth\n  },\n  discovery: { mdns, wideArea },   // \u53D1\u73B0\u670D\u52A1\n  commands: { ... },               // \u547D\u4EE4\u914D\u7F6E\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u8BBE\u8BA1\u7279\u70B9",children:"\u8BBE\u8BA1\u7279\u70B9"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"adapter \u6A21\u5F0F"}),": \u901A\u8FC7 adapter \u63A5\u53E3\u5B9E\u73B0\u6E20\u9053\u80FD\u529B\u7684\u53EF\u9009\u7EC4\u5408\uFF08outbound/streaming/threading/groups/mentions\uFF09"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u63D2\u4EF6\u5316"}),": extensions/ \u76EE\u5F55\u4E0B\u7684 35+ \u6E20\u9053\u5B9E\u73B0\u4E3A\u72EC\u7ACB workspace packages\uFF0C\u6309\u9700\u52A0\u8F7D"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u591A\u5C42\u8DEF\u7531"}),": \u652F\u6301 peer \u2192 guild \u2192 team \u2192 account \u2192 channel \u2192 default \u516D\u7EA7\u7ED1\u5B9A\u4F18\u5148\u7EA7"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u6D41\u5F0F\u5904\u7406"}),": Pi embedded subscriber \u5904\u7406 LLM \u6D41\u5F0F\u8F93\u51FA\uFF0C\u652F\u6301 block chunking \u548C thinking tag \u8FC7\u6EE4"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u70ED\u91CD\u8F7D"}),": Gateway \u652F\u6301\u914D\u7F6E\u6587\u4EF6\u76D1\u542C\u4E0E\u8FD0\u884C\u65F6 hot reload"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"OpenAI \u517C\u5BB9"}),": \u63D0\u4F9B\u6807\u51C6 ",(0,t.jsx)(n.code,{children:"/v1/chat/completions"})," \u548C ",(0,t.jsx)(n.code,{children:"/v1/responses"})," HTTP \u63A5\u53E3"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u591A\u5BA2\u6237\u7AEF"}),": \u652F\u6301 WebSocket \u5BA2\u6237\u7AEF + \u539F\u751F apps (macOS/iOS/Android) + Node \u8FDC\u7A0B\u8282\u70B9"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},917776:function(e,n,s){s.d(n,{R:()=>l,x:()=>d});var i=s(7378);let t={},r=i.createContext(t);function l(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);