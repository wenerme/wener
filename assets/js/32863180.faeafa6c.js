"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["98015"],{39241:function(n,e,l){l.r(e),l.d(e,{frontMatter:()=>i,toc:()=>c,default:()=>h,metadata:()=>s,assets:()=>o,contentTitle:()=>d});var s=JSON.parse('{"id":"db/relational/mysql/mysql-log","title":"MySQL \u65E5\u5FD7","description":"| conf                          | default               | for                                               |","source":"@site/../notes/db/relational/mysql/mysql-log.md","sourceDirName":"db/relational/mysql","slug":"/db/relational/mysql/log","permalink":"/notes/db/relational/mysql/log","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/mysql/mysql-log.md","tags":[{"inline":true,"label":"Debug","permalink":"/notes/tags/debug"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1690351481000,"frontMatter":{"title":"MySQL \u65E5\u5FD7","tags":["Debug"]},"sidebar":"docs","previous":{"title":"InnoDB","permalink":"/notes/db/relational/mysql/innodb"},"next":{"title":"MySQL \u6027\u80FD","permalink":"/notes/db/relational/mysql/perf"}}'),r=l(86106),t=l(17776);let i={title:"MySQL \u65E5\u5FD7",tags:["Debug"]},d="MySQL Log",o={},c=[{value:"general log",id:"general-log",level:2},{value:"slow log",id:"slow-log",level:2},{value:"maintain",id:"maintain",level:2}];function a(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"mysql-log",children:"MySQL Log"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"conf"}),(0,r.jsx)(e.th,{children:"default"}),(0,r.jsx)(e.th,{children:"for"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_output"}),(0,r.jsx)(e.td,{children:"FILE"}),(0,r.jsx)(e.td,{children:"TABLE,FILE,NONE"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"slow_query_log"}),(0,r.jsx)(e.td,{children:"OFF"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"slow_query_log_file"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"<HOSTNAME>-slow.log"})}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"general_log"}),(0,r.jsx)(e.td,{children:"OFF"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"general_log_file"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"<HOSTNAME>.log"})}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"sql_log_off"}),(0,r.jsx)(e.td,{children:"OFF"}),(0,r.jsx)(e.td,{children:"\u63A7\u5236\u5F53\u524D\u4F1A\u8BDD\u7684 general log"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"long_query_time"}),(0,r.jsx)(e.td,{children:"10"}),(0,r.jsx)(e.td,{children:"\u6162\u67E5\u8BE2 \u9600\u503C"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_slow_admin_statements"}),(0,r.jsx)(e.td,{children:"OFF"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_queries_not_using_indexes"}),(0,r.jsx)(e.td,{children:"OFF"}),(0,r.jsxs)(e.td,{children:["e.g ",(0,r.jsx)(e.code,{children:"[ALTER,ANALYZE,CHECK,OPTIMIZE,REPAIR] TABLE"})]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_slow_extra"}),(0,r.jsx)(e.td,{children:"OFF"}),(0,r.jsx)(e.td,{children:"\u5728 FILE \u8F93\u51FA\u4E2D\u5305\u542B\u989D\u5916\u4FE1\u606F"})]})]})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"select *\nfrom performance_schema.global_variables\nwhere VARIABLE_NAME in (\n                        'log_output', 'slow_query_log', 'long_query_time', 'slow_query_log_file',\n                        'log_queries_not_using_indexes', 'log_throttle_queries_not_using_indexes',\n                        'general_log', 'general_log_file'\n    )\norder by VARIABLE_NAME;\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"mysql.slow_log"})," \u8868\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5B9E\u9645\u5BF9\u5E94 csv - \u67E5\u8BE2\u5F88\u6162 - CSV storage engine"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/log-destinations.html",children:"https://dev.mysql.com/doc/refman/8.0/en/log-destinations.html"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"show variables like 'log_queries_not_using_indexes';\n\n\nset global log_queries_not_using_indexes = 'ON'\n\n--\nset global general_log = 'ON';\nselect * from mysql.general_log\norder by event_time desc;\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"head /var/lib/mysql/mysql/slow_log.CSV\nwc -l /var/lib/mysql/mysql/slow_log.CSV\n\napk add mariadb-client\nmysqldumpslow -t 10 slow.log\n\n# percona-toolkit\ncurl -LO http://www.percona.com/get/pt-query-digest\nchmod +x pt-query-digest\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://docs.percona.com/percona-toolkit/pt-query-digest.html",children:"https://docs.percona.com/percona-toolkit/pt-query-digest.html"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Analyze MySQL queries from logs, processlist, and tcpdump"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"general-log",children:"general log"}),"\n",(0,r.jsx)(e.h2,{id:"slow-log",children:"slow log"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"var"}),(0,r.jsx)(e.th,{children:"for"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_slow_admin_statements"}),(0,r.jsx)(e.td,{children:"OFF"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_slow_extra"}),(0,r.jsx)(e.td,{children:"OFF"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_slow_replica_statements"}),(0,r.jsx)(e.td,{children:"OFF"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_slow_slave_statements"}),(0,r.jsx)(e.td,{children:"OFF"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"slow_launch_time"}),(0,r.jsx)(e.td,{children:"2"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"slow_query_log"}),(0,r.jsx)(e.td,{children:"ON"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"slow_query_log_file"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"long_query_time"}),(0,r.jsx)(e.td,{children:"10"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_output"}),(0,r.jsx)(e.td,{children:"FILE"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"log_queries_not_using_indexes"}),(0,r.jsx)(e.td,{})]})]})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"show variables like '%slow%';\nshow variables like 'long_query_time';-- \u9ED8\u8BA4 10s\nshow variables like 'log_output';-- \u9ED8\u8BA4 FILE\nshow variables like 'log_queries_not_using_indexes';\nshow variables like 'slow_query_log_file';\n\n-- slow_query_log_file \u63A7\u5236\u6587\u4EF6\u8DEF\u5F84\nset global log_output = 'FILE,TABLE';\nset global slow_query_log='ON';\nset global log_queries_not_using_indexes = 'ON';\n\nset global long_query_time=3;\nset session long_query_time=3;\n\n-- \u6D4B\u8BD5\nselect sleep(5);\nselect * from mysql.slow_log limit 2;\n\n\n-- \u6392\u67E5\u5176\u4ED6\nshow processlist;\nshow engine innodb status;\n\nflush logs;\nflush slow logs;\ntruncate mysql.slow_log;\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://mariadb.com/kb/en/mariadb/writing-logs-into-tables/",children:"Write logs into tables"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://mariadb.com/kb/en/mariadb/mysqlslow_log-table/",children:"TABLE mysql.slow_log"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://mariadb.com/kb/en/mariadb/slow-query-log-overview/",children:"Slow Query Log Overview"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_slow_query_log_file",children:"http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_slow_query_log_file"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"http://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html",children:"http://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"maintain",children:"maintain"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"binlog_expire_logs_seconds \u9ED8\u8BA4 30 \u5929"}),"\n",(0,r.jsx)(e.li,{children:"binlog_expire_logs_auto_purge=ON"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-txt",children:"PURGE { BINARY | MASTER } LOGS {\n    TO 'log_name'\n  | BEFORE datetime_expr\n}\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"FLUSH LOGS ;\nFLUSH BINARY LOGS;\n\nSHOW BINARY LOGS;\nSHOW MASTER LOGS;\nPURGE BINARY LOGS BEFORE now();\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"mysqladmin flush-logs\n"})})]})}function h(n={}){let{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(a,{...n})}):a(n)}},17776:function(n,e,l){l.d(e,{R:()=>i,x:()=>d});var s=l(7378);let r={},t=s.createContext(r);function i(n){let e=s.useContext(t);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),s.createElement(t.Provider,{value:e},n.children)}}}]);