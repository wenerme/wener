"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["22297"],{61331:function(n,e,t){t.r(e),t.d(e,{frontMatter:()=>i,toc:()=>c,default:()=>p,metadata:()=>s,assets:()=>l,contentTitle:()=>a});var s=JSON.parse('{"id":"web/react/valtio","title":"valtio","description":"- pmndrs/valtio","source":"@site/../notes/web/react/valtio.md","sourceDirName":"web/react","slug":"/web/react/valtio","permalink":"/notes/web/react/valtio","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/web/react/valtio.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1663122612000,"frontMatter":{"title":"valtio"},"sidebar":"docs","previous":{"title":"use-context-selector","permalink":"/notes/web/react/use-context-selector"},"next":{"title":"vercel/og","permalink":"/notes/web/react/vercel-og"}}'),r=t(86106),o=t(17776);let i={title:"valtio"},a="valtio",l={},c=[{value:"Context",id:"context",level:2},{value:"yjs",id:"yjs",level:2},{value:"useProxy marco",id:"useproxy-marco",level:2},{value:"&#39;set&#39; on proxy: trap returned falsish for property &#39;validated&#39;",id:"set-on-proxy-trap-returned-falsish-for-property-validated",level:2},{value:"\u81EA\u5B9A\u4E49\u6BD4\u8F83",id:"\u81EA\u5B9A\u4E49\u6BD4\u8F83",level:2},{value:"TypeError: Cannot read properties of undefined (reading &#39;Symbol(SNAPSHOT)&#39;)",id:"typeerror-cannot-read-properties-of-undefined-reading-symbolsnapshot",level:2}];function d(n){let e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"valtio",children:"valtio"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/pmndrs/valtio",children:"pmndrs/valtio"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"7kB/2.5kB - use-sync-external-store+proxy-compare"}),"\n",(0,r.jsx)(e.li,{children:"\u57FA\u4E8E proxy \u7684\u72B6\u6001\u7BA1\u7406"}),"\n",(0,r.jsx)(e.li,{children:"\u7C7B\u4F3C mobx, vue"}),"\n",(0,r.jsx)(e.li,{children:"\u9ED8\u8BA4\u72B6\u6001\u53D8\u5316\u662F\u5F02\u6B65\u89E6\u53D1\u76D1\u542C"}),"\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u4F7F\u7528 Class \u4F5C\u4E3A \u88AB\u4EE3\u7406\u5BF9\u8C61"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/pmndrs/eslint-plugin-valtio",children:"pmndrs/eslint-plugin-valtio"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/dai-shi/proxy-memoize",children:"dai-shi/proxy-memoize"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/dai-shi/valtio-yjs",children:"dai-shi/valtio-yjs"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/Noitidart/valtio-persist",children:"Noitidart/valtio-persist"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/pmndrs/valtio/wiki/How-valtio-works",children:"How valtio works"})}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://codesandbox.io/s/valtio-render-test-lzqhf7",children:"valtio-render-test"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9ED8\u8BA4\u4F7F\u7528 Object.is \u5BF9\u6BD4\uFF0C\u53EF\u80FD\u4F1A\u4EA7\u751F\u5F88\u591A\u4E0D\u5FC5\u8981\u7684\u66F4\u65B0"}),"\n",(0,r.jsx)(e.li,{children:"StrictMode \u4F1A double render"}),"\n",(0,r.jsxs)(e.li,{children:["\u8BBE\u7F6E\u5BF9\u8C61\u4F1A\u88AB\u521B\u5EFA\u4EE3\u7406 - \u56E0\u6B64\u4E0D\u80FD\u8BBE\u7F6E\u4EFB\u610F\u5BF9\u8C61\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u548C immer \u903B\u8F91\u4E0D\u540C\uFF0Cimmer \u5728 produce \u91CC\u548C\u5916\u4E0D\u540C"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.admonition,{type:"tip",children:(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5927\u72B6\u6001\u597D\u62C6\u5206\u5408\u5E76"}),"\n",(0,r.jsxs)(e.li,{children:["\u88AB proxy \u5BF9\u8C61\u90FD\u9700\u8981\u901A\u8FC7 snaoshot \u7684\u65B9\u5F0F\u8BFB\u53D6\u6570\u636E - \u6240\u4EE5\u624D\u53EF\u4EE5\u76D1\u542C\u5D4C\u5957\u5BF9\u8C61\u7684\u53D8\u5316\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"snaoshot \u8FD4\u56DE\u7684\u662F \u4E0D\u53EF\u53D8 \u5BF9\u8C61"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u4FEE\u6539\u4F1A\u8FDB\u884C batch - input \u65F6 useSnapshot \u53EF\u80FD\u9700\u8981\u52A0 sync"}),"\n",(0,r.jsx)(e.li,{children:"\u7279\u6B8A\u503C\u9700\u8981\u7279\u6B8A\u5904\u7406"}),"\n",(0,r.jsx)(e.li,{children:"ref/object \u8D4B\u503C\u90FD\u4F1A\u89E6\u53D1\u53D8\u5316\uFF0C\u4E0D\u4F1A\u5224\u65AD\u662F\u5426\u76F8\u7B49"}),"\n"]})}),"\n",(0,r.jsx)(e.admonition,{type:"note",children:(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["support async in watch ",(0,r.jsx)(e.a,{href:"https://github.com/pmndrs/valtio/issues/507",children:"#507"})]}),"\n"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-tsx",children:"import {proxy, useSnapshot, ref, subscribe, snapshot} from 'valtio';\n\n// \u4E0D\u4F9D\u8D56 react\nimport {proxy, subscribe, snapshot} from 'valtio/vanilla';\n\nimport {\n  subscribeKey,\n  watch,\n  devtools,\n  derive,\n  underive,\n  proxyWithComputed,\n  proxyWithHistory,\n  proxySet,\n  proxyMap,\n  getVersion,\n} from 'valtio/utils';\n\n// \u56E0\u4E3A\u57FA\u4E8E proxy - \u6240\u4EE5\u53EF\u4EE5\u76F4\u63A5\u62C6\u5206\u5408\u5E76\nconst state = proxy({\n  a: {v: 1},\n  b: {v: 2},\n});\n// \u62C6\u5206\nconst a = state.a;\n// \u5408\u5E76\nconst s = proxy({\n  obj1: a,\n  obj2: {v: 3},\n});\n\n// \u53EF\u5728\u4EFB\u610F\u5730\u65B9\u8BA2\u9605\u53D8\u5316\nconst unsubscribe = subscribe(state, () => console.log('changed to', state));\n// \u8BA2\u9605\u90E8\u5206\u5BF9\u8C61\nconst unsubscribe = subscribe(state.a, () => console.log('changed to', state));\n// \u8BA2\u9605 primitive value\nconst unsubscribe = subscribeKey(state, 'a.v', () => console.log('changed to', state));\n\n// \u57FA\u4E8E\u4F7F\u7528\u8BA2\u9605\nconst stop = watch((get) => {\n  console.log('state has changed to', get(state)); // auto-subscribe on use\n});\n\n// React \u7EC4\u4EF6\u5185\u4F7F\u7528 snapshot \u8BA2\u9605\u53D8\u5316\nconst Counter = () => {\n  const snap = useSnapshot(state);\n  // \u76F4\u63A5\u8BFB\u72B6\u6001\uFF0C\u4E0D\u8BA2\u9605\n  const {count} = state;\n  return (\n    <div>\n      {/* \u8BA2\u9605 count \u53D8\u5316 */}\n      {snap.count}\n      <button\n        onClick={() => {\n          // \u64CD\u4F5C state \u8FDB\u884C\u76F4\u63A5\u4FEE\u6539\n          ++state.count;\n        }}\n      >\n        +1\n      </button>\n    </div>\n  );\n};\n\nfunction TextBox() {\n  // \u4FEE\u6539\u9ED8\u8BA4\u4F1A batch - sync \u5219\u907F\u514D batch\n  // https://github.com/pmndrs/valtio/issues/270\n  const snap = useSnapshot(state, {sync: true});\n  return <input value={snap.text} onChange={(e) => (state.text = e.target.value)} />;\n}\n\n// useSnapshot \u65F6\u5019\u4F1A Suspense\nconst state = proxy({post: fetch(url).then((res) => res.json())});\n\n// \u7279\u6B8A\u503C - ref \u4E0D\u8DDF\u8E2A\nconst state = proxy({\n  count: 0,\n  // ref \u4E0D\u8DDF\u8E2A\n  dom: ref(document.body),\n});\n// Set \u63A5\u53E3\nconst state = proxySet([1, 2, 3]);\n// Map \u63A5\u53E3\nconst state = proxyMap([\n  ['key', 'value'],\n  ['key2', 'value2'],\n]);\n\n// derive - \u8BA1\u7B97\u72B6\u6001\nconst derived = derive({\n  doubled: (get) => get(state).count * 2,\n});\n\n// alternatively, attach derived properties to an existing proxy\nderive(\n  {\n    tripled: (get) => get(state).count * 3,\n  },\n  {\n    proxy: state,\n  },\n);\n\n// \u8BA1\u7B97\u72B6\u6001\nimport memoize from 'proxy-memoize';\nimport {proxyWithComputed} from 'valtio/utils';\n\nconst state = proxyWithComputed(\n  {\n    count: 1,\n    firstName: 'Alec',\n    lastName: 'Baldwin',\n  },\n  {\n    doubled: memoize((snap) => snap.count * 2),\n    // \u5305\u542B setter\u3001getter\n    fullName: {\n      get: memoize((snap) => snap.firstName + ' ' + snap.lastName),\n      set: (state, newValue) => {\n        [state.firstName, state.lastName] = newValue.split(' ');\n      },\n    },\n  },\n);\n\n// state \u652F\u6301 undo\u3001redo\nconst state = proxyWithHistory({count: 0});\n\n// Redux DevTool\nconst unsub = devtools(state, {name: 'state name', enabled: true});\n\n// \u66F4\u677E\u6563\u7684 \u7C7B\u578B - \u9ED8\u8BA4 readtonly T\ndeclare module 'valtio' {\n  function useSnapshot<T extends object>(p: T): T;\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"import {proxy} from 'valtio/vanilla'"})," - \u8DDF\u8E2A\u4FEE\u6539 \u5199\u5165"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"import {createProxy} from 'proxy-compare'"})," - \u8DDF\u8E2A\u4F7F\u7528 \u8BFB\u53D6"]}),"\n",(0,r.jsxs)(e.li,{children:["snapshot - \u521B\u5EFA\u4E0D\u53EF\u53D8\u5BF9\u8C61\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u672A resolve \u503C\u4F1A throw error"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"useSnapshot - \u5C01\u88C5 snapshot \u7ED3\u679C\uFF0C\u914D\u5408 createProxy \u8DDF\u8E2A\u4F7F\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u5185\u90E8\u4F7F\u7528\u7248\u672C\u53F7\u8DDF\u8E2A\u53D8\u5316"}),"\n",(0,r.jsxs)(e.li,{children:["React.memo \u65E0\u6CD5\u5904\u7406\u4EE3\u7406\u5BF9\u8C61\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u4F7F\u7528 react-tracked \u91CC\u7684 memo"}),"\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u5728\u7EC4\u4EF6\u5185\u4F7F\u7528 useSnapshot \u8BFB\u53D6\u4F20\u5165\u5BF9\u8C61"}),"\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u8BFB\u53D6\u539F\u59CB\u503C\u8FDB\u884C\u4F20\u9012"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"context",children:"Context"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-tsx",children:"import {createContext, useContext} from 'react';\nimport {proxy, useSnapshot} from 'valtio';\nconst MyContext = createContext();\n\nconst MyProvider = ({children}) => {\n  const state = useRef(proxy({count: 0})).current;\n  return <MyContext.Provider value={state}>{children}</MyContext.Provider>;\n};\n\nconst MyCounter = () => {\n  const state = useContext(MyContext);\n  const snap = useSnapshot(state);\n  return (\n    <>\n      {snap.count} <button onClick={() => ++state.count}>+1</button>\n    </>\n  );\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"yjs",children:"yjs"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-js",children:"import * as Y from 'yjs';\nimport {proxy} from 'valtio';\nimport {bindProxyAndYMap} from 'valtio-yjs';\n\nconst ydoc = new Y.Doc();\nconst ymap = ydoc.getMap('mymap');\n\nconst state = proxy({});\n\nbindProxyAndYMap(state, ymap);\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/dai-shi/valtio-yjs",children:"dai-shi/valtio-yjs"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"useproxy-marco",children:"useProxy marco"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-tsx",children:"import {useProxy} from 'valtio/macro';\n// useProxy \u4F1A\u53D8\u6210 useSnapshot\n// read state \u7684\u5730\u65B9\u4F1A\u53D8\u5473 snapshot\nconst Component = () => {\n  useProxy(state);\n  return (\n    <div>\n      {state.count}\n      <button onClick={() => ++state.count}>+1</button>\n    </div>\n  );\n};\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.npmjs.com/package/babel-plugin-macros",children:"babel-plugin-macros"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"npm i --save-dev aslemammad-vite-plugin-macro babel-plugin-macros\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-js",metastring:'title="vite.config.js"',children:"import {defineConfig} from 'vite';\nimport macro from 'valtio/macro/vite';\n\nexport default defineConfig({\n  plugins: [macro],\n});\n"})}),"\n",(0,r.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(e.h2,{id:"set-on-proxy-trap-returned-falsish-for-property-validated",children:"'set' on proxy: trap returned falsish for property 'validated'"}),"\n",(0,r.jsx)(e.p,{children:"\u5C1D\u8BD5\u4FEE\u6539 snapshot \u8FD4\u56DE\u503C"}),"\n",(0,r.jsx)(e.h2,{id:"\u81EA\u5B9A\u4E49\u6BD4\u8F83",children:"\u81EA\u5B9A\u4E49\u6BD4\u8F83"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ts",children:"import eq from 'react-fast-compare';\nimport {typeOf} from 'react-is';\nimport {unstable_buildProxyFunction} from 'valtio';\n\nconst canProxyOrig = unstable_buildProxyFunction()[7];\nexport const proxyWithCompare = unstable_buildProxyFunction(eq, undefined, (v) => {\n  if (typeOf(v)) {\n    return false;\n  }\n  return canProxyOrig(v);\n})[0];\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["unstable_buildProxyFunction\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Object.is"}),"\n",(0,r.jsx)(e.li,{children:"new Proxy(target, handler)"}),"\n",(0,r.jsx)(e.li,{children:"canProxy"}),"\n",(0,r.jsx)(e.li,{children:"PROMISE_RESULT"}),"\n",(0,r.jsx)(e.li,{children:"PROMISE_ERROR"}),"\n",(0,r.jsx)(e.li,{children:"snapshotCache = new WeakMap"}),"\n",(0,r.jsx)(e.li,{children:"createSnapshot"}),"\n",(0,r.jsx)(e.li,{children:"proxyCacge = new WeakMap"}),"\n",(0,r.jsx)(e.li,{children:"versionHolder = [1]"}),"\n",(0,r.jsx)(e.li,{children:"proxyFunction"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u8FD4\u56DE\u7ED3\u679C"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ts",children:"const [\n  // public functions\n  proxyFunction,\n  // shared state\n  refSet,\n  VERSION,\n  LISTENERS,\n  SNAPSHOT,\n  // internal things\n  objectIs,\n  newProxy,\n  canProxy,\n  PROMISE_RESULT,\n  PROMISE_ERROR,\n  snapshotCache,\n  createSnapshot,\n  proxyCache,\n  versionHolder,\n] = unstable_buildProxyFunction();\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u9ED8\u8BA4 canProxy \u903B\u8F91"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ts",children:"const isObject = (x: unknown): x is object => typeof x === 'object' && x !== null;\n\nconst canProxy = (x: unknown) =>\n  isObject(x) &&\n  !refSet.has(x) &&\n  (Array.isArray(x) || !(Symbol.iterator in x)) &&\n  !(x instanceof WeakMap) &&\n  !(x instanceof WeakSet) &&\n  !(x instanceof Error) &&\n  !(x instanceof Number) &&\n  !(x instanceof Date) &&\n  !(x instanceof String) &&\n  !(x instanceof RegExp) &&\n  !(x instanceof ArrayBuffer);\n"})}),"\n",(0,r.jsx)(e.h2,{id:"typeerror-cannot-read-properties-of-undefined-reading-symbolsnapshot",children:"TypeError: Cannot read properties of undefined (reading 'Symbol(SNAPSHOT)')"}),"\n",(0,r.jsx)(e.p,{children:"\u4F20\u5165\u4E86 undefined \u7ED9 useSnapshot"})]})}function p(n={}){let{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},17776:function(n,e,t){t.d(e,{R:()=>i,x:()=>a});var s=t(7378);let r={},o=s.createContext(r);function i(n){let e=s.useContext(o);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),s.createElement(o.Provider,{value:e},n.children)}}}]);