"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["109280"],{774461:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>d,toc:()=>t,default:()=>x,metadata:()=>i,assets:()=>h,contentTitle:()=>c});var i=JSON.parse('{"id":"devops/web/varnish","title":"varnish","description":"- varnishcache/varnish-cache","source":"@site/../notes/devops/web/varnish.md","sourceDirName":"devops/web","slug":"/devops/web/varnish","permalink":"/notes/devops/web/varnish","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/varnish.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1664062247000,"frontMatter":{"title":"varnish"},"sidebar":"docs","previous":{"title":"Tyk","permalink":"/notes/devops/web/tyk"},"next":{"title":"Awesome","permalink":"/notes/devops/web/awesome"}}'),r=s(486106),l=s(917776);let d={title:"varnish"},c="varnish",h={},t=[{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"FAQ",id:"faq",level:2},{value:"\u591A\u4E2A Storage",id:"\u591A\u4E2A-storage",level:2}];function a(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"varnish",children:"varnish"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/varnishcache/varnish-cache",children:"varnishcache/varnish-cache"})}),"\n",(0,r.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://varnish-cache.org/docs/index.html",children:"Varnish Documentation"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://info.varnish-software.com/blog/using-varnish-cache-secured-aws-s3-gateway",children:"S3 as a Backend"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://gist.github.com/fevangelou/84d2ce05896cab5f730a",children:"https://gist.github.com/fevangelou/84d2ce05896cab5f730a"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u7BA1\u7406\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"cli, telnet, web"}),"\n",(0,r.jsx)(e.li,{children:"child process mgmt"}),"\n",(0,r.jsx)(e.li,{children:"initializtion"}),"\n",(0,r.jsx)(e.li,{children:"vlc compiler -> c -> shared object -> child/cache"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["child/cache\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"storage/hashing"}),"\n",(0,r.jsx)(e.li,{children:"log/stats"}),"\n",(0,r.jsx)(e.li,{children:"accep"}),"\n",(0,r.jsx)(e.li,{children:"backend comm"}),"\n",(0,r.jsx)(e.li,{children:"worker threads"}),"\n",(0,r.jsx)(e.li,{children:"object expiry"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["CLI\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"varnishd - \u4E3B\u7A0B\u5E8F"}),"\n",(0,r.jsx)(e.li,{children:"varnishadm"}),"\n",(0,r.jsx)(e.li,{children:"varnishtest"}),"\n",(0,r.jsx)(e.li,{children:"varnish_reload_vcl"}),"\n",(0,r.jsxs)(e.li,{children:["log\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"varnishlog"}),"\n",(0,r.jsx)(e.li,{children:"varnishstat"}),"\n",(0,r.jsx)(e.li,{children:"varnishhist"}),"\n",(0,r.jsx)(e.li,{children:"varnishtop"}),"\n",(0,r.jsx)(e.li,{children:"varnishncsa"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# macOS\nbrew install varnish\n\nvarnishd -V # \u67E5\u770B\u7248\u672C\nvarnishd -x cli\n\nuuidgen > varnish-secret\n# github pages\n# -f default.vcl\nvarnishd -a 127.0.0.1:8080 -b 185.199.109.153:80 -T 127.0.0.1:6082 -d -S $PWD/varnish-secret -s file,/tmp/varnish-storage,1G\nvarnishadm -S $PWD/varnish-secret -T 127.0.0.1:6082 start\n\ncurl -H 'Host: wener.me' 127.0.0.1:8080\ncurl -H 'Host: charts.wener.tech' 127.0.0.1:8080/index.yaml -sv > /dev/null\n\nvarnishadm -S $PWD/varnish-secret -T 127.0.0.1:6082 status -j\n\n# docker\n# VARNISH_SIZE\n# VARNISH_HTTP_PORT=80\n# VARNISH_PROXY_PORT=8443\n# feature=+http2\ndocker run --rm -it \\\n  -p 8080:80 \\\n  -v $PWD/default.vcl:/etc/varnish/default.vcl:ro \\\n  --tmpfs /var/lib/varnish/varnishd:exec \\\n  --name varnish varnish:alpine\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"auth <response>"})}),"\n",(0,r.jsx)(e.li,{children:"help"}),"\n",(0,r.jsxs)(e.li,{children:["vcl\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.load <configname> <filename> [auto|cold|warm]"})}),"\n",(0,r.jsx)(e.li,{children:"vcl.list"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.use <configname|label>"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.show [-v] [<configname>]"})}),"\n",(0,r.jsx)(e.li,{children:"vcl.deps"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.discard <name_pattern>..."})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.inline <configname> <quoted_VCLstring> [auto|cold|warm]"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.label <label> <configname>"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"vcl.state <configname> [auto|cold|warm]"})}),"\n",(0,r.jsx)(e.li,{children:"vcl.symtab"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["backend\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"backend.list"}),"\n",(0,r.jsx)(e.li,{children:"backend.set_health"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"ban <field> <operator> <arg> [&& <field> <oper> <arg> ...]"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ban.list"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"banner"}),"\n",(0,r.jsx)(e.li,{children:"panic.clear"}),"\n",(0,r.jsx)(e.li,{children:"panic.show"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"param.reset <param>"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"param.set [-j] <param> <value>"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"param.show [-l|-j] [<param>|changed]"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"pid [-j]"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"ping [-j] [<timestamp>]"})}),"\n",(0,r.jsx)(e.li,{children:"quit"}),"\n",(0,r.jsx)(e.li,{children:"start, stop"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"status [-j]"})}),"\n",(0,r.jsx)(e.li,{children:"storage.list"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"varnishd"}),(0,r.jsx)(e.th,{children:"for"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-a"}),(0,r.jsx)(e.td,{children:"listen address"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-b none"}),(0,r.jsx)(e.td,{children:"\u65E0\u540E\u7AEF"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-b [addr[:port]|path]"})}),(0,r.jsx)(e.td,{children:"backend - \u9ED8\u8BA4 :80"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-f <vclfile>"})}),(0,r.jsx)(e.td,{children:"VCL program"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-n <dir>"})}),(0,r.jsx)(e.td,{children:"Working directory"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-F"}),(0,r.jsx)(e.td,{children:"foreground"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-T address[:port]"})}),(0,r.jsx)(e.td,{children:"CLI address"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-M address:port"}),(0,r.jsx)(e.td,{children:"reverse cli"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-i identity"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-I clifile"}),(0,r.jsx)(e.td,{children:"Initialization cli"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-E extension"}),(0,r.jsx)(e.td,{children:"\u52A0\u8F7D\u6269\u5C55"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-x <topic>"})}),(0,r.jsx)(e.td,{children:"\u6587\u6863 - parameter,vsl,cli,builtin,optstring"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"Tuning"})}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-t TTL"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-p param=value"}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-s [name=]kind[,options]"})}),(0,r.jsx)(e.td,{children:"\u5B58\u50A8\u9009\u9879"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-l <vsl>"})}),(0,r.jsx)(e.td,{children:"Size of shared memory log"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"Security"})}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-r param[,param...]"})}),(0,r.jsx)(e.td,{children:"parameters read-only from CLI"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-S <secret-file>"})}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-j jail[,options]"})}),(0,r.jsx)(e.td,{children:"unix, none"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"Advanced/Dev/Debug"})}),(0,r.jsx)(e.td,{})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-d"}),(0,r.jsx)(e.td,{children:"debug mode"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-C"}),(0,r.jsx)(e.td,{children:"Output VCL code compiled to C language"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-V"}),(0,r.jsx)(e.td,{children:"version"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"-h kind[,options]"})}),(0,r.jsx)(e.td,{children:"Hash specification"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-W waiter"}),(0,r.jsx)(e.td,{children:"Waiter implementation"})]})]})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["storage\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"malloc"}),"\n",(0,r.jsx)(e.li,{children:"umem - libumem"}),"\n",(0,r.jsxs)(e.li,{children:["file - ",(0,r.jsx)(e.code,{children:"file,path[,size[,granularity[,advice]]]"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"\u91CD\u542F\u7F13\u5B58\u5931\u6548"})}),"\n",(0,r.jsx)(e.li,{children:"\u957F\u671F\u8FD0\u884C\u4F1A\u788E\u7247\u5316"}),"\n",(0,r.jsx)(e.li,{children:"mmap \u4F5C\u4E3A memory, \u800C\u975E\u5355\u4E2A\u6587\u4EF6\u72EC\u7ACB, \u4F1A\u9884\u5148 alloc \u7ED9\u5B9A\u7684 size"}),"\n",(0,r.jsx)(e.li,{children:"\u5355\u6587\u4EF6\u8981\u80FD\u5B58\u5165 \u865A\u62DF\u5185\u5B58 - ulimit -v"}),"\n",(0,r.jsx)(e.li,{children:"granularity \u9ED8\u8BA4\u4E3A page size - \u4E00\u822C 4k"}),"\n",(0,r.jsx)(e.li,{children:"advice=random - normal, random, sequential"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"mse - \u4F01\u4E1A\u7248"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"/etc/varnish/varnish.params"}),"\n",(0,r.jsxs)(e.li,{children:["/etc/varnish/default.vcl\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"macOS brew /usr/local/etc/varnish/default.vcl"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"faq",children:"FAQ"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"x-proxy-cache: MISS"}),"\n",(0,r.jsx)(e.li,{children:"X-Varnish"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u591A\u4E2A-storage",children:"\u591A\u4E2A Storage"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"varnishd -s disk=file,/var/lib/varnish/storage,250G -s memory=malloc,32G\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-vcl",children:'sub backend_response {\n    if(beresp.http.Content-Type ~ "^(image|video)/") {\n        set beresp.storage = "file";\n    } else {\n        set beresp.storage = "memory";\n    }\n}\n'})})]})}function x(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(a,{...n})}):a(n)}},917776:function(n,e,s){s.d(e,{R:()=>d,x:()=>c});var i=s(7378);let r={},l=i.createContext(r);function d(n){let e=i.useContext(l);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:d(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);