"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["357010"],{626840:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>i,toc:()=>o,default:()=>c,metadata:()=>a,assets:()=>m,contentTitle:()=>r});var a=JSON.parse('{"id":"network/route/iptables","title":"iptables","description":"- Routing Tables","source":"@site/../notes/network/route/iptables.md","sourceDirName":"network/route","slug":"/network/route/iptables","permalink":"/notes/network/route/iptables","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/network/route/iptables.md","tags":[{"inline":true,"label":"Network","permalink":"/notes/tags/network"},{"inline":true,"label":"Firewall","permalink":"/notes/tags/firewall"},{"inline":true,"label":"Linux","permalink":"/notes/tags/linux"},{"inline":true,"label":"iptables","permalink":"/notes/tags/iptables"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1767451770000,"frontMatter":{"title":"iptables","tags":["Network","Firewall","Linux","iptables"]},"sidebar":"docs","previous":{"title":"DMVPN","permalink":"/notes/network/route/dmvpn"},"next":{"title":"Quagga","permalink":"/notes/network/route/quagga"}}'),s=n(486106),l=n(917776);let i={title:"iptables",tags:["Network","Firewall","Linux","iptables"]},r="iptables",m={},o=[];function p(e){let t={a:"a",annotation:"annotation",br:"br",code:"code",h1:"h1",header:"header",li:"li",math:"math",mi:"mi",mn:"mn",mrow:"mrow",p:"p",pre:"pre",semantics:"semantics",span:"span",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"iptables",children:"iptables"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n-A INPUT -s 127.0.0.0/255.0.0.0 -j ACCEPT\n....\n-A INPUT -m icmp --icmp-state 8 -j ACCEPT\n-A INPUT -m icmp --icmp-state 0 -j ACCEPT\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"http://linux-ip.net/html/routing-tables.html",children:"Routing Tables"})}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"ip route add default dev $ISP1_IFACE table ISP1\nip route add default dev $ISP2_IFACE table ISP2\n\nip rule add fwmark 20 table ISP1 prio 33000\nip rule add fwmark 10 table ISP2 prio 33000\n\n# iptables -t mangle -A PREROUTING -j CONNMARK --restore-mark\n# iptables -t mangle -A PREROUTING -m mark ! --mark 0 -j ACCEPT\n# iptables -t mangle -A PREROUTING -j MARK --set-mark 10\n# iptables -t mangle -A PREROUTING -m statistic --mode random --probability 0.5 -j MARK --set-mark 20\n# iptables -t mangle -A PREROUTING -j CONNMARK --save-mark\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"ttl (IPv4-specific)\nThis module matches the time to live field in the IP header.\n[!] --ttl-eq ttl\nMatches the given TTL value.\n--ttl-gt ttl\nMatches if TTL is greater than the given TTL value.\n--ttl-lt ttl\nMatches if TTL is less than the given TTL value.\n"})}),"\n",(0,s.jsxs)(t.p,{children:["ip route add default scope global nexthop via ",(0,s.jsxs)(t.span,{className:"katex",children:[(0,s.jsx)(t.span,{className:"katex-mathml",children:(0,s.jsx)(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,s.jsxs)(t.semantics,{children:[(0,s.jsxs)(t.mrow,{children:[(0,s.jsx)(t.mi,{children:"P"}),(0,s.jsx)(t.mn,{children:"1"}),(0,s.jsx)(t.mi,{children:"d"}),(0,s.jsx)(t.mi,{children:"e"}),(0,s.jsx)(t.mi,{children:"v"})]}),(0,s.jsx)(t.annotation,{encoding:"application/x-tex",children:"P1 dev "})]})})}),(0,s.jsx)(t.span,{className:"katex-html","aria-hidden":"true",children:(0,s.jsxs)(t.span,{className:"base",children:[(0,s.jsx)(t.span,{className:"strut",style:{height:"0.6944em"}}),(0,s.jsx)(t.span,{className:"mord mathnormal",style:{marginRight:"0.13889em"},children:"P"}),(0,s.jsx)(t.span,{className:"mord",children:"1"}),(0,s.jsx)(t.span,{className:"mord mathnormal",children:"d"}),(0,s.jsx)(t.span,{className:"mord mathnormal",children:"e"}),(0,s.jsx)(t.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"v"})]})})]}),"IF1 weight 1 ",(0,s.jsx)(t.br,{}),"\nnexthop via ",(0,s.jsxs)(t.span,{className:"katex",children:[(0,s.jsx)(t.span,{className:"katex-mathml",children:(0,s.jsx)(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,s.jsxs)(t.semantics,{children:[(0,s.jsxs)(t.mrow,{children:[(0,s.jsx)(t.mi,{children:"P"}),(0,s.jsx)(t.mn,{children:"2"}),(0,s.jsx)(t.mi,{children:"d"}),(0,s.jsx)(t.mi,{children:"e"}),(0,s.jsx)(t.mi,{children:"v"})]}),(0,s.jsx)(t.annotation,{encoding:"application/x-tex",children:"P2 dev "})]})})}),(0,s.jsx)(t.span,{className:"katex-html","aria-hidden":"true",children:(0,s.jsxs)(t.span,{className:"base",children:[(0,s.jsx)(t.span,{className:"strut",style:{height:"0.6944em"}}),(0,s.jsx)(t.span,{className:"mord mathnormal",style:{marginRight:"0.13889em"},children:"P"}),(0,s.jsx)(t.span,{className:"mord",children:"2"}),(0,s.jsx)(t.span,{className:"mord mathnormal",children:"d"}),(0,s.jsx)(t.span,{className:"mord mathnormal",children:"e"}),(0,s.jsx)(t.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"v"})]})})]}),"IF2 weight 1"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://superuser.com/questions/510147/load-balancing-with-multiple-gateways",children:"https://superuser.com/questions/510147/load-balancing-with-multiple-gateways"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"http://linux-ip.net/html/adv-multi-internet.html",children:"http://linux-ip.net/html/adv-multi-internet.html"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://lartc.org/howto/lartc.rpdb.multiple-links.html",children:"https://lartc.org/howto/lartc.rpdb.multiple-links.html"})}),"\n",(0,s.jsx)(t.p,{children:"Kubernetes uses this method to load balance traffic between pods in the cluster."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"iptables -t nat -N LB_PORT80\niptables -t nat -N LB_PORT80_SERVER1\niptables -t nat -A LB_PORT80 \\\n  -m statistic --mode random --probability 0.5000 \\\n  -j LB_PORT80_SERVER1\niptables -t nat -N LB_PORT80_SERVER2\niptables -t nat -A LB_PORT80 \\\n  -j LB_PORT80_SERVER2\niptables -t nat -A INPUT -p tcp -m tcp --dport 80 -j LB_PORT80\n"})}),"\n",(0,s.jsx)(t.p,{children:"\u4E22\u5F03 x% \u7684\u5305"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"iptables -A INPUT \\\n  -s IP_ADDRESS \\\n  -m statistic --mode random --probability 0.5000 \\\n  -j DROP\n"})}),"\n",(0,s.jsx)(t.p,{children:"depending on origin"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"ip route add table gw1 default via $GW1_IP dev $ETH metric 100\nip route add table gw2 default via $GW2_IP dev $ETH metric 100\n\nip rule add prio 100 from all fwmark 1 lookup gw1\nip rule add prio 110 from all fwmark 2 lookup gw2\n\n# Make sure mark exists before routing happens\n#   The first handles incoming packets\n-t mangle -A PREROUTING -j CONNMARK --restore-mark\n#   The second handles outgoing packets\n-t mangle -A OUTPUT -j CONNMARK --restore-mark\n\n# Mark packets and save the mark\n-t mangle -A INPUT -m mac --mac-source $GW1_MAC -j MARK --set-mark 1\n-t mangle -A INPUT -m mac --mac-source $GW2_MAC -j MARK --set-mark 2\n-t mangle -A INPUT -j CONNMARK --save-mark\n"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"http://ipset.netfilter.org/iptables-extensions.man.html",children:"http://ipset.netfilter.org/iptables-extensions.man.html"})}),"\n",(0,s.jsx)(t.p,{children:"iptables -p icmp -h"}),"\n",(0,s.jsx)(t.p,{children:"iptables-persistent\niptables-save > ~/iptables-export\niptables-restore < ~/iptables-export"}),"\n",(0,s.jsx)(t.p,{children:"iptables -t nat -A PREROUTING -p tcp -i ppp0 --dport 8001 -j DNAT --to-destination 192.168.1.200:8080\niptables -A FORWARD -p tcp -d 192.168.1.200 --dport 8080 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT"})]})}function c(e={}){let{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},917776:function(e,t,n){n.d(t,{R:()=>i,x:()=>r});var a=n(7378);let s={},l=a.createContext(s);function i(e){let t=a.useContext(l);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(l.Provider,{value:t},e.children)}}}]);