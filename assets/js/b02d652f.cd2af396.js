"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["27377"],{10039:function(o,t,n){n.r(t),n.d(t,{frontMatter:()=>i,toc:()=>d,default:()=>m,metadata:()=>e,assets:()=>c,contentTitle:()=>l});var e=JSON.parse('{"id":"os/linux/fs/rootfs","title":"rootfs","description":"- chroot \u6216 switch_root \u4F1A\u9690\u85CF rootfs","source":"@site/../notes/os/linux/fs/rootfs.md","sourceDirName":"os/linux/fs","slug":"/os/linux/fs/rootfs","permalink":"/notes/os/linux/fs/rootfs","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/fs/rootfs.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1666003394000,"frontMatter":{"title":"rootfs"},"sidebar":"docs","previous":{"title":"RAID","permalink":"/notes/os/linux/fs/raid"},"next":{"title":"sfdisk","permalink":"/notes/os/linux/fs/sfdisk"}}'),r=n(86106),s=n(17776);let i={title:"rootfs"},l="rootfs",c={},d=[{value:"switch_root",id:"switch_root",level:2},{value:"pivot_root",id:"pivot_root",level:2}];function a(o){let t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...o.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"rootfs",children:"rootfs"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"chroot \u6216 switch_root \u4F1A\u9690\u85CF rootfs"}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt",children:"ramfs-rootfs-initramfs"})}),"\n",(0,r.jsxs)(t.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://man7.org/linux/man-pages/man8/switch_root.8.html",children:"switch_root.8"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://man7.org/linux/man-pages/man8/pivot_root.8.html",children:"pivot_root.8"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://unix.stackexchange.com/a/455136/47774",children:"Why is there no rootfs file system present on my system?"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-fstab",children:"rootfs / rootfs rw 0 0\n"})}),"\n",(0,r.jsx)(t.h2,{id:"switch_root",children:"switch_root"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["\u5207\u6362\u5230 newroot \u5E76\u8C03\u7528 init \u7A0B\u5E8F\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u7528\u5728 initramfs \u4E2D\uFF0C\u5207\u6362\u5230\u771F\u6B63\u7684 rootfs"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.li,{children:"\u5FC5\u987B\u7531 PID=1 \u8C03\u7528"}),"\n",(0,r.jsx)(t.li,{children:"\u4F1A\u79FB\u52A8\u5DF2\u7ECF\u6302\u8F7D\u7684 /proc, /dev, /sys, /run \u5230\u65B0 root"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"# -c /dev/console\nswitch_root newroot init # init args...\n"})}),"\n",(0,r.jsx)(t.h2,{id:"pivot_root",children:"pivot_root"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u4FEE\u6539\u5F53\u524D\u8FDB\u7A0B\u7684 root"}),"\n",(0,r.jsx)(t.li,{children:"\u8981\u6CE8\u610F\u63D0\u524D\u51C6\u5907\u597D\u73AF\u5883"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"pivot_root new_root put_old\n\n# \u5207\u6362 root\nmount /dev/hda1 /new-root\ncd /new-root\npivot_root . old-root\nexec chroot . sh < dev/console > dev/console 2>&1\numount /old-root\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"umount rootfs"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"fuser -vm /\n# killall\numount -a\n\nmkdir /tmp/tmproot\nmount -t tmpfs none /tmp/tmproot\nmkdir /tmp/tmproot/{proc,sys,dev,run,usr,var,tmp,oldroot}\n\ncp -ax /{bin,etc,mnt,sbin,lib,lib64} /tmp/tmproot/\ncp -ax /usr/{bin,sbin,lib,lib64} /tmp/tmproot/usr/\ncp -ax /var/{account,empty,lib,local,lock,nis,opt,preserve,run,spool,tmp,yp} /tmp/tmproot/var/\n\nmount --make-rprivate / # necessary for pivot_root to work\npivot_root /tmp/tmproot /tmp/tmproot/oldroot\nfor i in dev proc sys run; do mount --move /oldroot/$i /$i; done\n\nfuser -vm /oldroot\n\numount /oldroot\n# \u64CD\u4F5C\u539F\u6765 rootfs block device\n\n# \u64CD\u4F5C\u5B8C\u6210\u540E\u91CD\u65B0 mount\nmount /dev/vda2 /oldroot\nmount --make-rprivate /\npivot_root /oldroot /oldroot/tmp/tmproot\nfor i in dev proc sys run; do mount --move /tmp/tmproot/$i /$i; done\n\n# \u79FB\u9664\u4E34\u65F6 rootfs\numount /tmp/tmproot\nrmdir /tmp/tmproot\n\nmount -a\n\n# \u542F\u52A8\u670D\u52A1\n\nmount --make-rshared /\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://unix.stackexchange.com/a/227318/47774",children:"https://unix.stackexchange.com/a/227318/47774"})}),"\n"]})]})}function m(o={}){let{wrapper:t}={...(0,s.R)(),...o.components};return t?(0,r.jsx)(t,{...o,children:(0,r.jsx)(a,{...o})}):a(o)}},17776:function(o,t,n){n.d(t,{R:()=>i,x:()=>l});var e=n(7378);let r={},s=e.createContext(r);function i(o){let t=e.useContext(s);return e.useMemo(function(){return"function"==typeof o?o(t):{...t,...o}},[t,o])}function l(o){let t;return t=o.disableParentContext?"function"==typeof o.components?o.components(r):o.components||r:i(o.components),e.createElement(s.Provider,{value:t},o.children)}}}]);