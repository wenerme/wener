"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["51442"],{57401:function(n,e,r){r.r(e),r.d(e,{frontMatter:()=>l,toc:()=>c,default:()=>h,metadata:()=>s,assets:()=>t,contentTitle:()=>d});var s=JSON.parse('{"id":"service/storage/s3/garage","title":"garage","description":"- Deuxfleurs/garage","source":"@site/../notes/service/storage/s3/garage.md","sourceDirName":"service/storage/s3","slug":"/service/storage/s3/garage","permalink":"/notes/service/storage/s3/garage","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/storage/s3/garage.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1741072966000,"frontMatter":{"title":"garage"},"sidebar":"docs","previous":{"title":"S3","permalink":"/notes/service/storage/s3/"},"next":{"title":"s3fs","permalink":"/notes/service/storage/s3/s3fs"}}'),i=r(86106),a=r(17776);let l={title:"garage"},d="garage",t={},c=[{value:"\u914D\u7F6E",id:"config",level:2},{value:"cluster",id:"cluster",level:2},{value:"Internal",id:"internal",level:2},{value:"K2V",id:"k2v",level:2},{value:"gateways",id:"gateways",level:2},{value:"admin",id:"admin",level:2},{value:"Handshake error: i/o: unexpected end of file",id:"handshake-error-io-unexpected-end-of-file",level:2},{value:"Response: error 400 Bad Request, Parts given to CompleteMultipartUpload do not match uploaded parts",id:"response-error-400-bad-request-parts-given-to-completemultipartupload-do-not-match-uploaded-parts",level:2}];function o(n){let e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"garage",children:"garage"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://git.deuxfleurs.fr/Deuxfleurs/garage",children:"Deuxfleurs/garage"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"AGPLv3, Rust"}),"\n",(0,i.jsx)(e.li,{children:"\u5206\u5E03\u5F0F S3-compatible object store"}),"\n",(0,i.jsxs)(e.li,{children:["metadata + chunk\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"metadata - lmdb, sqlite"}),"\n",(0,i.jsxs)(e.li,{children:["chunk - 1M\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5BF9\u5C0F\u6587\u4EF6\u53CB\u597D"}),"\n",(0,i.jsx)(e.li,{children:"\u5982\u679C\u8282\u70B9\u4E4B\u95F4\u7F51\u901F\u7406\u60F3\uFF0C\u53EF\u4FEE\u6539\u4E3A\u8F83\u5927\u503C \u4F8B\u5982 1 Gbps -> 10MiB"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7279\u6027\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"S3"}),"\n",(0,i.jsx)(e.li,{children:"GEO Distribution"}),"\n",(0,i.jsx)(e.li,{children:"Standalone - \u81EA\u5305\u542B metadata & data\uFF0C\u4E0D\u4F9D\u8D56\u5916\u90E8\uFF0C\u5355 binary"}),"\n",(0,i.jsx)(e.li,{children:"\u538B\u7F29 & \u53BB\u91CD"}),"\n",(0,i.jsx)(e.li,{children:"K2V API - \u5B9E\u9A8C\u6027"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["gateway\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u53EA\u63D0\u4F9B\u63A5\u53E3\u4E0D\u5B58\u50A8\u6570\u636E"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7AEF\u53E3\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"3900 - S3 API"}),"\n",(0,i.jsx)(e.li,{children:"3901 - RPC"}),"\n",(0,i.jsx)(e.li,{children:"3902 - S3 Website"}),"\n",(0,i.jsx)(e.li,{children:"3903 - Admin API"}),"\n",(0,i.jsx)(e.li,{children:"3904 - K2V API"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://git.deuxfleurs.fr/garage-sdk/garage-admin-sdk-js.git",children:"https://git.deuxfleurs.fr/garage-sdk/garage-admin-sdk-js.git"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7BA1\u7406 SDK"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["mirror ",(0,i.jsx)(e.a,{href:"https://github.com/deuxfleurs-org/garage",children:"deuxfleurs-org/garage"})]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://garagehq.deuxfleurs.fr/documentation/reference-manual/s3-compatibility/",children:"S3 Compatibility"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4E0D\u652F\u6301 ACL, Policies, Versioning, Replication, Locking, Encryption, Tagging"}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u652F\u6301 Notification"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://git.deuxfleurs.fr/Deuxfleurs/bagage",children:"Deuxfleurs/bagage"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"AGPLv3, Go"}),"\n",(0,i.jsx)(e.li,{children:"WebDAV -> S3 proxy"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://news.ycombinator.com/item?id=41013004",children:"https://news.ycombinator.com/item?id=41013004"})}),"\n",(0,i.jsxs)(e.li,{children:["\u5B9E\u73B0\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"The Dynamo ring"}),"\n",(0,i.jsx)(e.li,{children:"CRDTs"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.admonition,{type:"tip",children:[(0,i.jsx)(e.p,{children:"garage \u662F\u4E00\u4E2A\u5206\u5E03\u5F0F\u5BF9\u8C61\u5B58\u50A8\u7CFB\u7EDF\uFF0C\u517C\u5BB9 S3 API\uFF0C\u652F\u6301 GEO \u5206\u5E03\uFF0C\u538B\u7F29\u548C\u53BB\u91CD\u3002"}),(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5982\u679C\u6838\u5FC3\u9700\u6C42\u662F \u5206\u5E03\u5F0F \u548C S3 API \u90A3\u4E48 garage \u662F\u76EE\u524D\u5F00\u6E90\u7684\u6700\u4F73\u9009\u62E9\u3002"}),"\n",(0,i.jsx)(e.li,{children:"\u5982\u679C\u6838\u5FC3\u9700\u6C42\u662F \u5C3D\u91CF\u517C\u5BB9 S3 \u4E14\u9700\u8981\u5E94\u7528\u5C42\u80FD\u529B\uFF0C\u90A3\u4E48 minio \u662F\u6700\u4F73\u9009\u62E9\u3002"}),"\n"]}),(0,i.jsx)(e.hr,{}),(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["vs Minio - AGPLv3, Go\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"minio \u5206\u5E03\u5F0F\u5B9E\u65BD\u8D77\u6765\u66F4\u590D\u6742"}),"\n",(0,i.jsx)(e.li,{children:"minio \u4F1A\u4FDD\u6301\u76EE\u5F55\u6587\u4EF6\u7ED3\u6784"}),"\n",(0,i.jsx)(e.li,{children:"minio \u8F85\u52A9\u529F\u80FD\u66F4\u591A"}),"\n",(0,i.jsx)(e.li,{children:"minio Erasure Coding \u6BD4\u591A\u526F\u672C\u66F4\u8282\u7701\u7A7A\u95F4"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["vs seaweedfs - Apache-2.0, Go\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"seaweedfs \u9ED8\u8BA4\u662F \u5BF9\u8C61\u5B58\u50A8"}),"\n",(0,i.jsx)(e.li,{children:"S3 API \u9700\u8981 filer\uFF0C\u9700\u8981\u989D\u5916\u7684 metadata \u670D\u52A1"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["vs juicefs - Apache-2.0, Go\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"juicefs \u662F metadata+chunk \u5957\u58F3\u63D0\u4F9B POSIX \u63A5\u53E3"}),"\n",(0,i.jsx)(e.li,{children:"juicefs \u672C\u8EAB\u4E0D\u5B58\u50A8\u6570\u636E\uFF0C\u4E0D\u63D0\u4F9B S3 API"}),"\n"]}),"\n"]}),"\n"]})]}),"\n",(0,i.jsx)(e.admonition,{type:"caution",children:(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4E0D\u652F\u6301\u533F\u540D Bucket \u8BBF\u95EE - \u652F\u6301\u66B4\u9732 website"}),"\n"]})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'# \u7981\u7528\u7684\u529F\u80FD bundled-libs, sqlite, k2v\napk add garage # Alpine\n\ndocker run --rm -it dxflrs/garage:v1.0.0\n\ncat > garage.toml << EOF\nmetadata_dir = "/tmp/meta"\ndata_dir = "/tmp/data"\ndb_engine = "sqlite"\n\nreplication_factor = 1\n\nrpc_bind_addr = "[::]:3901"\nrpc_public_addr = "127.0.0.1:3901"\nrpc_secret = "$(openssl rand -hex 32)"\n\n[s3_api]\ns3_region = "garage"\napi_bind_addr = "[::]:3900"\nroot_domain = ".s3.garage.localhost"\n\n[s3_web]\nbind_addr = "[::]:3902"\nroot_domain = ".web.garage.localhost"\nindex = "index.html"\n\n[k2v_api]\napi_bind_addr = "[::]:3904"\n\n[admin]\napi_bind_addr = "[::]:3903"\nadmin_token = "$(openssl rand -base64 32)"\nmetrics_token = "$(openssl rand -base64 32)"\nEOF\n\nRUST_LOG=garage=info garage -c garage.toml server\n\nsudo chmod 0600 /etc/garage/rpc_secret\n\nsu -l garage garage -c /etc/garage/garage.toml server\n\n# Docker\n# ==================\n# \u63A8\u8350 docker\uFF0C\u56E0\u4E3A garage \u7684\u529F\u80FD\u66F4\u5168\n# \u9ED8\u8BA4\u547D\u4EE4 /garage server\n# -p 3900:3900 -p 3901:3901 -p 3902:3902\ndocker run \\\n  --restart always \\\n  --network host \\\n  -v /etc/garage.toml:/etc/garage.toml \\\n  -v /var/lib/garage/meta:/var/lib/garage/meta \\\n  -v /var/lib/garage/data:/var/lib/garage/data \\\n  --name garage \\\n  dxflrs/garage:v1.0.0\n\nalias garage="docker exec -ti garage /garage"\n\ngarage status     # \u96C6\u7FA4\u72B6\u6001\ngarage node id    # \u5F53\u524D\u8282\u70B9\ngarage node id -q # \u53EA\u8F93\u51FA <full-node-id>@<ip>:<port>\n\n# garage node connect <full-node-id>@<ip>:<port> # \u8FDE\u63A5\u522B\u7684\u8282\u70B9\uFF0C\u52A0\u5165\u96C6\u7FA4\ngarage status   # \u52A0\u5165\u540E\u7684\u72B6\u6001\ngarage stats -a # \u6240\u6709\u8282\u70B9\u7684\u7EDF\u8BA1\n\ngarage layout show # \u5F53\u524D layout\n# zone=shhome capacity=200G tags=sh,phy,sshd\ngarage layout assign $(garage node id -q | head -c 10) -z shhome -c 200G -t sh -t phy -t ssd\ngarage layout show              # \u4FEE\u6539\u540E\u7684\u72B6\u6001\ngarage layout apply --version 2 # \u5E94\u7528 layout\ngarage status                   # \u589E\u52A0\u65B0\u7684\u8282\u70B9\u548C\u5BB9\u91CF\n\ngarage bucket list # \u5217\u51FA\u6240\u6709 bucket\ngarage bucket create public\ngarage bucket info public\ngarage key create pub-key\n\ngarage key list\ngarage key info pub-key\ngarage bucket allow --read --write --owner public --key pub-key\n\n# block-rc      \u91CD\u65B0\u8BA1\u7B97 block ref \u8BA1\u6570\u5668\n# block-refs    \u91CD\u65B0\u4F20\u64AD\u7248\u672C\u5220\u9664\u5230 block ref \u8868\n# blocks        \u4FEE\u590D\uFF08\u91CD\u65B0\u540C\u6B65/\u91CD\u65B0\u5E73\u8861\uFF09\u96C6\u7FA4\u4E2D\u5B58\u50A8\u7684\u5757\n# mpu           \u91CD\u65B0\u4F20\u64AD\u5BF9\u8C61\u5220\u9664\u5230 multipart upload \u8868\n# rebalance     \u5728\u5404\u4E2A\u8282\u70B9\u7684\u786C\u76D8\u9A71\u52A8\u5668\u4E4B\u95F4\u91CD\u65B0\u5E73\u8861\u6570\u636E\u5757\n# scrub         \u9A8C\u8BC1\u78C1\u76D8\u4E0A\u6240\u6709\u5757\u7684\u5B8C\u6574\u6027\n# tables        \u5B8C\u5168\u540C\u6B65\u5143\u6570\u636E\u8868\n# versions      \u91CD\u65B0\u4F20\u64AD\u5BF9\u8C61\u5220\u9664\u5230\u7248\u672C\u8868\ngarage repair --yes -a blocks\n# resync queue length\n# blocks with resync errors\ngarage stats -a\n\ngarage bucket alias public assets    # assets -> public\ngarage bucket website --allow assets # \u5141\u8BB8\u76F4\u63A5\u8BBF\u95EE $BUCKET.$s3_web_root_domain\n'})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"env"}),(0,i.jsx)(e.th,{children:"for"}),(0,i.jsx)(e.th,{children:"note"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_ADMIN_TOKEN"}),(0,i.jsx)(e.td,{children:"--admin-token"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_ADMIN_TOKEN_FILE"}),(0,i.jsx)(e.td,{children:"--admin-token-file"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_ALLOW_WORLD_READABLE_SECRETS"}),(0,i.jsx)(e.td,{children:"--allow-world-readable-secrets"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_CONFIG_FILE"}),(0,i.jsx)(e.td,{children:"-c,--config"}),(0,i.jsx)(e.td,{children:"/etc/garage.toml"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_RPC_SECRET"}),(0,i.jsx)(e.td,{children:"--rpc-secret"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_RPC_SECRET_FILE"}),(0,i.jsx)(e.td,{children:"--rpc-secret-file"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_METRICS_TOKEN"}),(0,i.jsx)(e.td,{children:"--metrics-token"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_METRICS_TOKEN_FILE"}),(0,i.jsx)(e.td,{children:"--metrics-token-file"}),(0,i.jsx)(e.td,{})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"GARAGE_RPC_HOST"}),(0,i.jsx)(e.td,{children:"--rpc-host"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"<node-id>@<ip>:<port>"})})]})]})]}),"\n",(0,i.jsx)(e.h2,{id:"config",children:"\u914D\u7F6E"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# \u5355\u8282\u70B9\nnode_id=$(garage node id -q | cut -d@ -f1)\ngarage layout assign -c1 -z garage $node_id\ngarage layout apply --version 1\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["replication_factor\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"1 - \u5355\u8282\u70B9\u5B58\u50A8"}),"\n",(0,i.jsx)(e.li,{children:"2 - \u4E24\u4E2A\u8282\u70B9\u5B58\u50A8\uFF0C\u4F1A\u5C3D\u91CF\u5B58\u50A8\u5230\u4E0D\u540C zone"}),"\n",(0,i.jsx)(e.li,{children:"3 -"}),"\n",(0,i.jsx)(e.li,{children:"5,7 - \u5355\u9009\u62E9\u5927\u4E8E 3 \u8282\u70B9\u7684\u65F6\u5019\uFF0C\u5EFA\u8BAE\u9009\u62E9\u5947\u6570"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.admonition,{title:"replication_factor",type:"caution",children:(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u786E\u4FDD\u6240\u6709\u8282\u70B9\u7684\u914D\u7F6E\u76F8\u540C"}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u652F\u6301\u76F4\u63A5\u4FEE\u6539"}),"\n",(0,i.jsxs)(e.li,{children:["\u4FEE\u6539\u6B65\u9AA4\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5173\u95ED\u96C6\u7FA4"}),"\n",(0,i.jsx)(e.li,{children:"\u5220\u9664 meta/custer_layout"}),"\n",(0,i.jsx)(e.li,{children:"\u66F4\u65B0\u6240\u6709\u7684 replication_factor"}),"\n",(0,i.jsx)(e.li,{children:"\u91CD\u542F\u96C6\u7FA4"}),"\n",(0,i.jsx)(e.li,{children:"\u91CD\u5EFA layout"}),"\n",(0,i.jsx)(e.li,{children:"\u96C6\u7FA4\u4F1A rebalance"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["consistency_mode\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["consistent - \u9ED8\u8BA4\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8BFB\u5199\u90FD\u9700\u8981 quorum"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["degraded\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8BFB\u4E0D\u9700\u8981 quorum"}),"\n",(0,i.jsx)(e.li,{children:"\u5199\u540C consistent"}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u652F\u6301 read-after-write consistency"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["dangerous\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8BFB\u5199\u90FD\u4E0D\u9700\u8981 quorum"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["db_engine\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["lmdb - \u9ED8\u8BA4\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u6027\u80FD\u66F4\u597D"}),"\n",(0,i.jsx)(e.li,{children:"\u6570\u636E\u9700\u8981\u80FD fit \u5230\u5185\u5B58"}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u80FD\u8DE8\u67B6\u6784\uFF1A arm64\u3001amd64 \u7684\u5B58\u50A8\u7ED3\u6784\u4E0D\u540C"}),"\n",(0,i.jsx)(e.li,{children:"\u53EF\u80FD\u5BFC\u81F4\u635F\u574F"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["sqlite\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Alpine \u9ED8\u8BA4\u6CA1\u6709\u6784\u5EFA"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-toml",children:'# \u5143\u6570\u636E\u76EE\u5F55\nmetadata_dir = "/var/lib/garage/meta"\n# \u6570\u636E\u76EE\u5F55\ndata_dir = "/var/lib/garage/data"\n\n# \u6570\u636E\u5E93\u5F15\u64CE\u662F\u5426\u542F\u7528\u540C\u6B65\u6A21\u5F0F\n#metadata_fsync = false\n\n# \u662F\u5426\u5728\u6570\u636E\u5757\u4FDD\u5B58\u5230\u78C1\u76D8\u540E\uFF0C\u5BF9\u5176\u53CA\u5176\u6240\u5728\u7684\u76EE\u5F55\u8FDB\u884C fsync \u64CD\u4F5C\u3002\n#data_fsync = false\n\n# \u662F\u5426\u6BCF\u6708\u5927\u7EA6\u81EA\u52A8\u8FD0\u884C\u4E00\u6B21\u6570\u636E\u76EE\u5F55\u7684\u64E6\u6D17\u64CD\u4F5C\u3002\u5982\u679C\u4F60\u5DF2\u7ECF\u5728\u6587\u4EF6\u7CFB\u7EDF\u7EA7\u522B\u8FDB\u884C\u64E6\u6D17\uFF0C\u53EF\u4EE5\u8BBE\u7F6E\u6B64\u9009\u9879\u4E3A true \u4EE5\u7981\u7528\u81EA\u52A8\u64E6\u6D17\u3002\n#disable_scrub = false\n\n# \u7528\u4E8E\u5B58\u50A8\u5143\u6570\u636E\u7684\u6570\u636E\u5E93\u5F15\u64CE\u3002\u53EF\u9009\u503C\uFF1Almdb\u3001sqlite\u3002\n#db_engine = "lmdb"\n\n# \u5B58\u50A8\u5BF9\u8C61\u7684\u5757\u5927\u5C0F\u3002\n#block_size = "1M"\n\n# S3 API \u8282\u70B9\u5728\u53D1\u9001\u5230\u5B58\u50A8\u8282\u70B9\u4E4B\u524D\u5F02\u6B65\u4FDD\u5B58\u5230\u5185\u5B58\u4E2D\u7684\u6570\u636E\u5757\u7684\u603B\u5927\u5C0F\u9650\u5236\u3002\n#block_ram_buffer_max = "256MiB"\n\n# LMDB \u4F7F\u7528\u7684\u6620\u5C04\u5927\u5C0F\uFF0C\u5373\u7528\u4E8E\u6620\u5C04\u6570\u636E\u5E93\u6587\u4EF6\u7684\u865A\u62DF\u5185\u5B58\u533A\u57DF\u7684\u5927\u5C0F\u3002\u5B83\u4E0D\u53D7\u8FD0\u884C Garage \u7684\u673A\u5668\u7684\u7269\u7406 RAM \u5927\u5C0F\u7684\u9650\u5236\u3002\n#lmdb_map_size = "1T"\n\n# \u8FD9\u4E2A\u503C\u53EF\u4EE5\u662F\u4EFB\u4F55\u6BD4\u4F60\u7684\u96C6\u7FA4\u8282\u70B9\u6570\u5C0F\u7684\u6B63\u6574\u6570\u3002\u5B83\u5728\u6240\u6709\u8282\u70B9\u7684\u914D\u7F6E\u6587\u4EF6\u4E2D\u5FC5\u987B\u4E00\u81F4\uFF01\u5982\u679C\u4F60\u8FD0\u884C\u7684\u662F Garage \u8282\u70B9\u96C6\u7FA4\uFF0C\u8BF7\u5C06\u6B64\u503C\u66F4\u6539\u4E3A\u81F3\u5C11 2\uFF01\nreplication_factor = 1\n\n# \u8FD9\u4E2A\u9009\u9879\u51B3\u5B9A\u4E86\u4F60\u7684\u96C6\u7FA4\u7684\u8BFB\u5199\u884C\u4E3A\u3002\u5728\u66F4\u6539\u4E4B\u524D\u8BF7\u5148\u9605\u8BFB\u53C2\u8003\u624B\u518C\uFF01\n#consistency_mode = "consistent"\n\n# \u7528\u4E8E\u5B58\u50A8\u5757\u7684 Zstd \u538B\u7F29\u7EA7\u522B\u3002\u9ED8\u8BA4\u503C\u4E3A 1\u3002\n#compression_level = 1\n\n# \u7ED1\u5B9A\u7528\u4E8E\u96C6\u7FA4\u95F4\u901A\u4FE1\u7684\u5730\u5740\u548C\u7AEF\u53E3\u3002\n# \u63D0\u793A\uFF1A\u5982\u679C\u8FD0\u884C\u7684\u662F\u5355\u8282\u70B9\u96C6\u7FA4\uFF0C\u8BF7\u5C06\u5176\u66F4\u6539\u4E3A 127.0.0.1:3901\u3002\nrpc_bind_addr = "[::]:3901"\n\n# \u5982\u679C\u542F\u7528\uFF0C\u5728\u5C1D\u8BD5\u8FDE\u63A5\u5230\u8FDC\u7A0B\u8282\u70B9\u4E4B\u524D\uFF0C\u5C06\u4E3A\u4F20\u51FA\u8FDE\u63A5\u7ED1\u5B9A\u6240\u6709\u4E0E\u4FA6\u542C\u4F7F\u7528\u76F8\u540C IP \u5730\u5740\u7684\u5957\u63A5\u5B57\uFF08rpc_bind_addr\uFF09\u3002\n#rpc_bind_outgoing = false\n\n# \u5176\u4ED6\u8282\u70B9\u9700\u8981\u4F7F\u7528\u6B64\u5730\u5740\u548C\u7AEF\u53E3\u6765\u8054\u7CFB\u6B64\u8282\u70B9\u4EE5\u8FDB\u884C RPC \u8C03\u7528\u3002\n# rpc_public_addr = "127.0.0.1:3901"\n\n# \u5728\u96C6\u7FA4\u4E2D\u7684\u6240\u6709\u8282\u70B9\u4E4B\u95F4\u5171\u4EAB\u7684\u5BC6\u94A5\u6587\u4EF6\uFF0C\u7528\u4E8E\u8BC6\u522B\u8FD9\u4E9B\u8282\u70B9\u5E76\u5141\u8BB8\u5B83\u4EEC\u76F8\u4E92\u901A\u4FE1\u3002\u8BE5\u5BC6\u94A5\u662F\u4E00\u4E2A 32 \u5B57\u8282\u7684\u5341\u516D\u8FDB\u5236\u7F16\u7801\u968F\u673A\u5B57\u7B26\u4E32\u3002\n# \u5982\u679C\u6B64\u6587\u4EF6\u4E0D\u5B58\u5728\uFF0C\u5B83\u5C06\u5728\u670D\u52A1\u542F\u52A8\u65F6\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2A\u968F\u673A\u5B57\u7B26\u4E32\u3002\nrpc_secret_file = "/etc/garage/rpc_secret"\n\n# \u7528\u4E8E\u8054\u7CFB\u6B64\u96C6\u7FA4\u7684\u5176\u4ED6 Garage \u8282\u70B9\u7684\u5BF9\u7B49\u6807\u8BC6\u7B26\u5217\u8868\u3002\u683C\u5F0F\uFF1A<\u8282\u70B9\u516C\u94A5>@<\u8282\u70B9\u516C\u7F51 IP \u6216\u4E3B\u673A\u540D>:<\u7AEF\u53E3>\u3002\n#bootstrap_peers = []\n\n[s3_api]\n# \u7ED1\u5B9A IP \u548C\u7AEF\u53E3\u4EE5\u63A5\u53D7 S3 API \u8C03\u7528\u3002\napi_bind_addr = "[::]:3900"\n\n# \u533A\u57DF\u540D\u79F0\u3002\ns3_region = "garage"\n\n# \u5141\u8BB8\u901A\u8FC7 vhost \u98CE\u683C\uFF08\u800C\u975E\u8DEF\u5F84\u98CE\u683C\uFF09\u8BBF\u95EE bucket \u65F6\u7684\u53EF\u9009\u540E\u7F00\u3002\nroot_domain = ""\n\n[s3_web]\n# \u7ED1\u5B9A IP \u548C\u7AEF\u53E3\u4EE5\u63A5\u53D7 HTTP \u8BF7\u6C42\u8BBF\u95EE\u5DF2\u914D\u7F6E\u4E3A\u7F51\u7AD9\u8BBF\u95EE\u7684\u5B58\u50A8\u6876\u3002\nbind_addr = "127.0.0.1:3902"\n\n# \u8FFD\u52A0\u5230\u5B58\u50A8\u6876\u540D\u79F0\u540E\u7684\u53EF\u9009\u540E\u7F00\uFF0C\u7528\u4E8E\u5BF9\u5E94\u7684 HTTP \u4E3B\u673A\u3002\nroot_domain = ""\n\n[admin]\n# \u5982\u679C\u6307\u5B9A\uFF0CGarage \u5C06\u7ED1\u5B9A\u4E00\u4E2A HTTP \u670D\u52A1\u5668\u5230\u6B64\u7AEF\u53E3\u548C\u5730\u5740\uFF0C\u5E76\u5728\u6B64\u4E0A\u76D1\u542C\u7BA1\u7406\u529F\u80FD\u7684\u8BF7\u6C42\u3002\n#api_bind_addr = ""\n\n# \u7528\u4E8E\u8BBF\u95EE\u6240\u6709\u5176\u4ED6\u7BA1\u7406\u7AEF\u70B9\u7684\u4EE4\u724C\u3002\n# \u5982\u679C\u672A\u8BBE\u7F6E\uFF0C\u5219\u5B8C\u5168\u7981\u7528\u5BF9\u8FD9\u4E9B\u7AEF\u70B9\u7684\u8BBF\u95EE\u3002\n#admin_token = ""\n# \u6216\u4ECE\u6587\u4EF6\u4E2D\u8BFB\u53D6\u3002\n# admin_token_file = "/etc/garage/admin_token"\n\n# \u7528\u4E8E\u8BBF\u95EE Metrics \u7AEF\u70B9\u7684\u4EE4\u724C\u3002\u5982\u679C\u672A\u8BBE\u7F6E\uFF0C\u5219\u53EF\u4EE5\u5728\u6CA1\u6709\u8BBF\u95EE\u63A7\u5236\u7684\u60C5\u51B5\u4E0B\u8BBF\u95EE Metrics \u7AEF\u70B9\uFF01\n#metrics_token = ""\n# \u6216\u4ECE\u6587\u4EF6\u4E2D\u8BFB\u53D6\u3002\n# metrics_token_file = "/etc/garage/metrics_token"\n'})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://garagehq.deuxfleurs.fr/documentation/reference-manual/configuration/",children:"https://garagehq.deuxfleurs.fr/documentation/reference-manual/configuration/"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"cluster",children:"cluster"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'cat << EOF > garage.toml\nmetadata_dir = "/var/lib/garage/meta"\ndata_dir = "/var/lib/garage/data"\ndb_engine = "sqlite"\nmetadata_auto_snapshot_interval = "6h"\n\nreplication_factor = 3\n\ncompression_level = 2\n\nrpc_bind_addr = "[::]:3901"\nrpc_public_addr = "<this node\'s public IP>:3901"\nrpc_secret = "<RPC secret>"\n\n[s3_api]\ns3_region = "garage"\napi_bind_addr = "[::]:3900"\nroot_domain = ".s3.garage"\n\n[s3_web]\nbind_addr = "[::]:3902"\nroot_domain = ".web.garage"\nindex = "index.html"\nEOF\n'})}),"\n",(0,i.jsx)(e.h2,{id:"internal",children:"Internal"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["CAS / Content Addressable Storage\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5185\u90E8 chunk dedup"}),"\n",(0,i.jsx)(e.li,{children:"\u4F7F\u7528 zstd \u538B\u7F29"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"k2v",children:"K2V"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5E2E\u52A9\u9AD8\u6548\u5730\u5728\u6876\u4E2D\u5B58\u50A8\u8BB8\u591A\u5C0F\u503C\uFF08\u4E0E S3\u66F4\u9002\u5408\u5B58\u50A8\u5927\u5757\u6570\u636E \u76F8\u53CD\uFF09\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"gateways",children:"gateways"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4E0D\u5B58\u50A8\u6570\u636E\uFF0C\u66B4\u9732 s3 API \u548C website"}),"\n",(0,i.jsx)(e.li,{children:"\u51CF\u5C11 1-2 \u7684\u7F51\u7EDC RTT"}),"\n",(0,i.jsx)(e.li,{children:"\u7B80\u5316\u670D\u52A1\u7BA1\u7406 - \u4E0D\u9700\u8981\u914D\u7F6E\u6240\u6709\u4E0A\u6E38\u670D\u52A1"}),"\n",(0,i.jsx)(e.li,{children:"\u7B80\u5316\u5B89\u5168 - gateway \u53EA\u66B4\u9732\u4E3A 127.0.0.1, \u901A\u8FC7\u5185\u90E8\u7F51\u7EDC\u8BBF\u95EE, \u5185\u90E8\u7F51\u7EDC\u672C\u8EAB\u6709\u52A0\u5BC6"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# \u6DFB\u52A0 Gateway\ngarage layout assign --gateway --tag gw1 -z dc1 $NODE_ID\ngarage layout show\ngarage layout apply\n\n# \u5982\u679C gateway \u6CA1\u751F\u6548\ngarage repair -a --yes tables\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://garagehq.deuxfleurs.fr/documentation/cookbook/gateways/",children:"https://garagehq.deuxfleurs.fr/documentation/cookbook/gateways/"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"admin",children:"admin"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"garage worker get\ngarage worker list\n\ngarage repair scrub start\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://garagehq.deuxfleurs.fr/documentation/operations/durability-repairs/",children:"https://garagehq.deuxfleurs.fr/documentation/operations/durability-repairs/"})}),"\n"]}),"\n",(0,i.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(e.h2,{id:"handshake-error-io-unexpected-end-of-file",children:"Handshake error: i/o: unexpected end of file"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["garage node connect \u53D1\u751F\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Pubkey \u9519\u4E86"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"garage_net::error: Error: ServerConn::run: Handshake error: performing handshake: failed opening client secret box\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/Kuska-ssb/handshake",children:"https://github.com/Kuska-ssb/handshake"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"RecvClientAuthSecretbox"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"response-error-400-bad-request-parts-given-to-completemultipartupload-do-not-match-uploaded-parts",children:"Response: error 400 Bad Request, Parts given to CompleteMultipartUpload do not match uploaded parts"})]})}function h(n={}){let{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}},17776:function(n,e,r){r.d(e,{R:()=>l,x:()=>d});var s=r(7378);let i={},a=s.createContext(i);function l(n){let e=s.useContext(a);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),s.createElement(a.Provider,{value:e},n.children)}}}]);