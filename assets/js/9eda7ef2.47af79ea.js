"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["37037"],{22712:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>r,toc:()=>a,default:()=>h,metadata:()=>l,assets:()=>c,contentTitle:()=>t});var l=JSON.parse('{"id":"os/linux/sys/linux-sys-faq","title":"Linux System FAQ","description":"- fork \u4F1A CoW \u5185\u5B58","source":"@site/../notes/os/linux/sys/linux-sys-faq.md","sourceDirName":"os/linux/sys","slug":"/os/linux/sys/faq","permalink":"/notes/os/linux/sys/faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/sys/linux-sys-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1757294976000,"frontMatter":{"tags":["FAQ"]},"sidebar":"docs","previous":{"title":"limits","permalink":"/notes/os/linux/sys/limits"},"next":{"title":"LSM","permalink":"/notes/os/linux/sys/lsm"}}'),i=s(86106),o=s(17776);let r={tags:["FAQ"]},t="Linux System FAQ",c={},a=[];function d(n){let e={a:"a",code:"code",h1:"h1",header:"header",li:"li",pre:"pre",ul:"ul",...(0,o.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"linux-system-faq",children:"Linux System FAQ"})}),"\n",(0,i.jsx)(e.h1,{id:"cow-memory",children:"CoW Memory"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["fork \u4F1A CoW \u5185\u5B58\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"parent's private, writable pages as read-only"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"copy_page_range"}),"\n",(0,i.jsx)(e.li,{children:"copy_page_rank"}),"\n",(0,i.jsx)(e.li,{children:"Mach vm_copy"}),"\n",(0,i.jsx)(e.li,{children:"vm_area_struct VMA"}),"\n",(0,i.jsx)(e.li,{children:"do_wp_page"}),"\n",(0,i.jsx)(e.li,{children:"Page Table Entry (PTE)"}),"\n",(0,i.jsx)(e.li,{children:"memfd_create + mmap(MAP_PRIVATE) Linux 3.17+"}),"\n",(0,i.jsxs)(e.li,{children:["userfaultfd Linux 4.3+\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"UFFDIO_REGISTER_MODE_WP \u5199\u4FDD\u62A4 - Linux 5.7+"}),"\n",(0,i.jsx)(e.li,{children:"UFFD_EVENT_PAGEFAULT"}),"\n",(0,i.jsx)(e.li,{children:"\u7528\u6237\u5904\u7406 Page Fault"}),"\n",(0,i.jsx)(e.li,{children:"\u63D0\u4F9B\u5185\u5B58\u9875 UFFDIO_COPY UFFDIO_ZEROPAGE"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["Firecracker create_snapshot\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"snapshot.snap - \u914D\u7F6E\u4FE1\u606F"}),"\n",(0,i.jsxs)(e.li,{children:["memory.snap\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u542F\u52A8\u65F6 mmap MAP_SHARED"}),"\n",(0,i.jsx)(e.li,{children:"clone \u89E6\u53D1 sync memory.snap"}),"\n",(0,i.jsxs)(e.li,{children:["cp --reflink memory.snap memory.snap.clone\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"fs \u5C42\u80FD CoW \u56E0\u6B64\u80FD\u5FEB\u901F\u521B\u5EFA\u51FA\u6765\u65B0\u7684 memory.snap"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"\u65B0 VM \u8FD0\u884C\u4F7F\u7528 memory.snap.clone"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["userfaultfd clone - \u7528\u6237\u81EA\u5B9A\u4E49\u5904\u7406\u903B\u8F91\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7236 VM \u5185\u5B58\u6620\u5C04\u5230 child"}),"\n",(0,i.jsx)(e.li,{children:"\u989D\u5916\u6CE8\u518C UFFDIO_REGISTER_MODE_WP"}),"\n",(0,i.jsx)(e.li,{children:"\u4ECE\u7236 VM \u590D\u5236\u5185\u5B58\u9875\uFF0C\u7136\u540E\u79FB\u9664 UFFDIO_WRITEPROTECT"}),"\n",(0,i.jsx)(e.li,{children:"\u26A0\uFE0F \u9891\u7E41\u4E0A\u4E0B\u6587\u5207\u6362"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"\u4E8B\u540E\u590D\u5236\uFF08Post-copy\uFF09\u5B9E\u65F6\u8FC1\u79FB"}),"\n",(0,i.jsx)(e.li,{children:"mprotect"}),"\n",(0,i.jsx)(e.li,{children:"Qcow2 + NBD"}),"\n",(0,i.jsx)(e.li,{children:"ZFS + Snapshot + Clone"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"qemu-img create -f qcow2 base.qcow2 1G\nqemu-img create -f qcow2 -b base.qcow2 -F qcow2 snapshot.qcow2\n\nsudo modprobe nbd\n# --cache-none\nqemu-nbd --connect=/dev/nbd0 snapshot.qcow2\n# \u5C06 /dev/nbd0 \u4F5C\u4E3A\u5185\u5B58\n\n# \u65AD\u5F00\u540E\u80FD\u83B7\u53D6 snapshot \u4F5C\u4E3A diff\nsudo nbd-client -d /dev/nbd0\n\n# -o sync=disabled primarycache=all\nzfs create -V 1G mypool/myvol\n# \u5C06 /dev/zvol/mypool/myvol \u4F5C\u4E3A\u5185\u5B58\nzfs snapshot mypool/myvol@before\nzfs snapshot mypool/myvol@after\nzfs send -i mypool/myvol@before mypool/myvol@after > myvol.diff\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://news.ycombinator.com/item?id=36666782",children:"https://news.ycombinator.com/item?id=36666782"})}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://codesandbox.io/blog/how-we-clone-a-running-vm-in-2-seconds",children:"https://codesandbox.io/blog/how-we-clone-a-running-vm-in-2-seconds"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://news.ycombinator.com/item?id=32683834",children:"https://news.ycombinator.com/item?id=32683834"})}),"\n"]}),"\n"]}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},17776:function(n,e,s){s.d(e,{R:()=>r,x:()=>t});var l=s(7378);let i={},o=l.createContext(i);function r(n){let e=l.useContext(o);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),l.createElement(o.Provider,{value:e},n.children)}}}]);