"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["474583"],{211748:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>r,toc:()=>c,default:()=>h,metadata:()=>i,assets:()=>a,contentTitle:()=>d});var i=JSON.parse('{"id":"os/linux/fs/zfs/zfs-tuning","title":"ZFS \u8C03\u4F18","description":"- \u63D0\u5347 \u5E94\u7528\u6027\u80FD - \u9488\u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u8C03\u4F18 - recordsize\uFF0Clogbias\u3001sync=off","source":"@site/../notes/os/linux/fs/zfs/zfs-tuning.md","sourceDirName":"os/linux/fs/zfs","slug":"/os/linux/fs/zfs/tuning","permalink":"/notes/os/linux/fs/zfs/tuning","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/fs/zfs/zfs-tuning.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1767451770000,"frontMatter":{"title":"ZFS \u8C03\u4F18"},"sidebar":"docs","previous":{"title":"Stat","permalink":"/notes/os/linux/fs/zfs/stat"},"next":{"title":"OpenZFS Version","permalink":"/notes/os/linux/fs/zfs/version"}}'),t=s(486106),l=s(917776);let r={title:"ZFS \u8C03\u4F18"},d="ZFS Tuning",a={},c=[{value:"ZIL SLOG",id:"zil-slog",level:2},{value:"sync",id:"sync",level:3},{value:"logbias",id:"logbias",level:2},{value:"ashift",id:"ashift",level:2},{value:"L2ARC",id:"l2arc",level:2},{value:"\u78C1\u76D8\u4FE1\u606F",id:"\u78C1\u76D8\u4FE1\u606F",level:2},{value:"atime on temporary",id:"atime-on-temporary",level:2},{value:"zfs_vdev_mirror_rotating_inc",id:"zfs_vdev_mirror_rotating_inc",level:2},{value:"SSD TRIM",id:"ssd-trim",level:2},{value:"\u53C2\u8003",id:"\u53C2\u8003",level:2},{value:"RAIDZ",id:"raidz",level:2},{value:"recordsize",id:"recordsize",level:3},{value:"Tuning",id:"tuning",level:2},{value:"RESULT",id:"result",level:2},{value:"raidz1 randwrite 4k x 2",id:"raidz1-randwrite-4k-x-2",level:3},{value:"raidz1 seqwrite 512k x 2",id:"raidz1-seqwrite-512k-x-2",level:3}];function o(n){let e={a:"a",admonition:"admonition",annotation:"annotation",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",math:"math",mi:"mi",mn:"mn",mrow:"mrow",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"zfs-tuning",children:"ZFS Tuning"})}),"\n",(0,t.jsx)(e.admonition,{title:"\u76EE\u7684",type:"tip",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u63D0\u5347 \u5E94\u7528\u6027\u80FD - \u9488\u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u8C03\u4F18 - recordsize\uFF0Clogbias\u3001sync=off"}),"\n",(0,t.jsx)(e.li,{children:"\u63D0\u5347 \u8BFB - cache\u3001\u5185\u5B58"}),"\n",(0,t.jsx)(e.li,{children:"\u63D0\u5347 \u5199 - slog\u3001zfs_txg_timeout"}),"\n",(0,t.jsx)(e.li,{children:"\u63D0\u5347 \u7A7A\u95F4\u4F7F\u7528\u7387 - \u538B\u7F29\u3001recordsize\u3001draid"}),"\n",(0,t.jsx)(e.li,{children:"\u63D0\u5347 \u5B89\u5168 - \u70ED\u5907\u3001\u51B7\u5907\u3001sync"}),"\n"]})}),"\n",(0,t.jsx)(e.admonition,{type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"slog \u4E0D\u662F write buffer"}),"\n"]})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"/proc/spl/kstat/zfs/main/iostats"}),"\n",(0,t.jsxs)(e.li,{children:["/sys/module/zfs/parameters\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"ZFS \u5185\u6838\u6A21\u5757\u53C2\u6570"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.admonition,{type:"tip",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4F7F\u7528\u673A\u68B0\u76D8\u65F6\uFF0C\u5EFA\u8BAE\u914D\u5907\u4E00\u4E2A SSD \u5206\u4E24\u4E2A\u533A\uFF0C\u4E00\u4E2A\u505A SLOG \u4E00\u4E2A\u505A L2ARC - \u5E76\u589E\u52A0 zfs_txg_timeout"}),"\n",(0,t.jsxs)(e.li,{children:["compressratio \u53D7 recordsize \u5F71\u54CD\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://github.com/openzfs/zfs/discussions/11293",children:"https://github.com/openzfs/zfs/discussions/11293"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u603B\u662F\u5F00\u542F compression"}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"zpool prop"}),(0,t.jsx)(e.th,{children:"default"}),(0,t.jsx)(e.th,{children:"recommand"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"ashift"}),(0,t.jsx)(e.td,{children:"0"}),(0,t.jsx)(e.td,{children:"12"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"atime"}),(0,t.jsx)(e.td,{children:"on"}),(0,t.jsx)(e.td,{children:"off"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"recordsize"}),(0,t.jsx)(e.td,{children:"128K"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"logbias"}),(0,t.jsx)(e.td,{children:"latency"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"autotrim"}),(0,t.jsx)(e.td,{children:"off"}),(0,t.jsx)(e.td,{children:"SDD \u63A8\u8350 on"})]})]})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"zdb | grep ashift # \u67E5\u770B\u4F7F\u7528\u7684 ashift\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["ashift\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"2^n - block size/sector size"}),"\n",(0,t.jsx)(e.li,{children:"\u5339\u914D\u5E95\u5C42\u7269\u7406 sector size"}),"\n",(0,t.jsx)(e.li,{children:"0 \u4E3A\u81EA\u52A8\u68C0\u6D4B"}),"\n",(0,t.jsx)(e.li,{children:"\u4E00\u822C\u4E3A 12 - 4K"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.hr,{}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["source\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"default"}),"\n",(0,t.jsxs)(e.li,{children:["temporary\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4E34\u65F6\u6302\u8F7D\u70B9\u5C5E\u6027 - \u4F1A\u6620\u5C04\u5230 mount"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"inherited from"}),"\n",(0,t.jsx)(e.li,{children:"local"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["xattrs=on\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5B58\u50A8\u6269\u5C55\u4FE1\u606F\u5230\u9690\u85CF\u76EE\u5F55\uFF0C\u8BBF\u95EE\u6587\u4EF6\u65F6\u9700\u8981\u989D\u5916 lookup"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["xattr=sa\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5B58\u50A8\u6269\u5C55\u4FE1\u606F\u5230 inode"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"zfs set compression=lz4 data\nzfs set atime=off data\nzfs set relatime=on data\nzfs set xattr=sa data\n\n# \u65AD\u7535\u53EF\u80FD\u4E22\u5931\u4E00\u5B9A\u6570\u636E\nzfs set sync=disabled POOL\n\n# primarycache=metadata - \u770B\u60C5\u51B5\nzfs set atime=off relatime=on xattr=sa compression=lz4 sync=disabled POOL\n\nzfs get all POOL | grep -E 'compression|atime|xattr|sync|primarycache|recordsize'\n"})}),"\n",(0,t.jsx)(e.h2,{id:"zil-slog",children:"ZIL SLOG"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["ZIL - ZFS Intent Log\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u77ED\u671F\u5B58\u50A8"}),"\n",(0,t.jsx)(e.li,{children:"ZIL \u9ED8\u8BA4\u5B58\u5728\u4E8E\u786C\u76D8\u4E0A\u7684\u7279\u6B8A\u533A\u57DF - \u4EA7\u751F\u53CC\u5199 - \u5148\u5199 ZIL \u5728\u5199\u56DE\u5230\u78C1\u76D8\u533A\u57DF"}),"\n",(0,t.jsxs)(e.li,{children:["\u4E0D\u4F1A\u4F7F\u7528 ZIL \u7684\u573A\u666F\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"logbias=throughput"}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"\u5927\u5757"})," - \u4F8B\u5982\uFF1A \u6570\u636E\u540C\u6B65\u65F6\u4E0D\u4F1A\u7528\u5230"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"\u53EA\u7528\u4E8E\u7CFB\u7EDF crash \u6062\u590D"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["SLOG - Separate ZFS Intent Log\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"ZIL \u5B58\u50A8\u4E8E\u989D\u5916\u7684\u78C1\u76D8"}),"\n",(0,t.jsx)(e.li,{children:"\u66FF\u4EE3\u5B58\u50A8\u78C1\u76D8\u4E0A\u7684 ZIL - \u907F\u514D\u53CC\u5199"}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"\u4E0D\u662F\u5199\u7F13\u5B58"})}),"\n",(0,t.jsxs)(e.li,{children:["\u7528\u4E0D\u4E86\u591A\u5C11\u7A7A\u95F4\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4E00\u822C 16G \u6216 32G \u8DB3\u77E3"}),"\n",(0,t.jsx)(e.li,{children:"max amount of write traffic per second x 15"}),"\n",(0,t.jsxs)(e.li,{children:["TXG commit interval - transaction group commit interval - 5s-10s\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"zfs_txg_synctime"}),"\n",(0,t.jsx)(e.li,{children:"\u589E\u52A0 \u4E8B\u52A1 \u5EF6\u65F6\u6765\u589E\u52A0\u4F7F\u7528\u7684 slog"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.admonition,{type:"tip",children:[(0,t.jsx)(e.p,{children:"\u5C0F\u7684\u5199\u64CD\u4F5C\u4F1A\u5148\u805A\u5408\u91CD\u6392\u5E8F\uFF0C\u7136\u540E\u4E00\u6B21\u6027\u5199\u5165\uFF0C\u6B64\u65F6\u4F7F\u7528 SLOG \u80FD\u63D0\u5347\u6027\u80FD"}),(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u907F\u514D write IOPS amplification"}),"\n"]}),(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"\u65E0 SLOG"})}),(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"async write -> TXG RAM -> ZPool"}),"\n",(0,t.jsx)(e.li,{children:"sync write -> TXG RAM & ZIL"}),"\n",(0,t.jsx)(e.li,{children:"TXG RAM -> ZPool"}),"\n"]}),(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"\u6709 SLOG"})}),(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"sync write -> TXG RAM & SLOG"}),"\n",(0,t.jsx)(e.li,{children:"\u7CFB\u7EDF\u6062\u590D\u65F6 SLOG -> TXG RAM -> replay TXG -> ZPool"}),"\n"]})]}),"\n",(0,t.jsx)(e.h3,{id:"sync",children:"sync"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["sync=standard\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"POSIX-compatible"}),"\n",(0,t.jsx)(e.li,{children:"synchronous only if requested"}),"\n",(0,t.jsx)(e.li,{children:"\u90E8\u5206\u60C5\u51B5\u4F1A\u5199\u5165\u5230 slog"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["sync=always\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4E3B\u8981\u4FDD\u969C\u6570\u636E\u5B89\u5168"}),"\n",(0,t.jsx)(e.li,{children:"\u6709\u4E9B\u4E0D\u652F\u6301 journal \u7684 DB \u5FC5\u987B\u8981 sync"}),"\n",(0,t.jsx)(e.li,{children:"slog \u5F88\u5FEB \u53EF\u4EE5\u8003\u8651"}),"\n",(0,t.jsxs)(e.li,{children:["\u4F1A\u5F3A\u5236\u5148\u5199\u5165\u5230 log \u8BBE\u5907 - ",(0,t.jsx)(e.strong,{children:"\u4E0D\u4F1A\u589E\u52A0\u6027\u80FD"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["sync=disabled - sync=never, sync=off\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u8BA9\u5199\u5165\u66F4\u5FEB"}),"\n",(0,t.jsx)(e.li,{children:"\u5FFD\u7565 O_SYNC"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'# txg \u63D0\u4EA4\u95F4\u9694 - 5\u79D2\ncat /sys/module/zfs/parameters/zfs_txg_timeout\n# \u589E\u52A0 slog \u4F7F\u7528\u91CF, 180s \u63D0\u4EA4\u4E00\u6B21\necho 180 | sudo tee /sys/module/zfs/parameters/zfs_txg_timeout\n\n# \u6301\u4E45\u5316\necho "options zfs zfs_txg_timeout=180" | sudo tee /etc/modprobe.d/zfs.conf\n'})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"parameter"}),(0,t.jsx)(e.th,{children:"default"}),(0,t.jsx)(e.th,{children:"prefer"}),(0,t.jsx)(e.th,{children:"note"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"zfs_txg_timeout"}),(0,t.jsx)(e.td,{children:"5"}),(0,t.jsx)(e.td,{children:"120"}),(0,t.jsx)(e.td,{children:"\u5F3A\u5236\u63D0\u4EA4 Transaction Group (TXG) \u7684\u65F6\u95F4\u95F4\u9694,\u66F4\u5927\u7684\u503C\u53EF\u4EE5\u805A\u5408\u66F4\u591A\u6570\u636E"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"---"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"zfs_dirty_data_max"}),(0,t.jsx)(e.td,{children:"10% RAM"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"zfs_dirty_data_max_percent"}),(0,t.jsx)(e.td,{children:"10% RAM"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"zfs_dirty_data_sync_percent"}),(0,t.jsx)(e.td,{children:"20"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{children:"\u8FBE\u5230 zfs_dirty_data_max \u6BD4\u4F8B\u540E\u51FA\u53D1 sync"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"zfs_dirty_data_max_max"}),(0,t.jsx)(e.td,{children:"25% RAM"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"zfs_dirty_data_max_max_percent"}),(0,t.jsx)(e.td,{children:"25% RAM"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]})]})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://jrs-s.net/2019/05/02/zfs-sync-async-zil-slog/",children:"https://jrs-s.net/2019/05/02/zfs-sync-async-zil-slog/"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.truenas.com/blog/zfs-zil-and-slog-demystified/",children:"https://www.truenas.com/blog/zfs-zil-and-slog-demystified/"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"logbias",children:"logbias"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["logbias=latency\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u65E0 SLOG\uFF0Cblock \u8F83\u5927\u80FD\u63D0\u5347\u6027\u80FD"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["logbias=throughput\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5C0F block \u5199\u5165\u4EA7\u751F\u975E\u5E38\u591A\u788E\u7247"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"zfs send dataset > /dev/null\n\nzpool iostat -r 1\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias",children:"https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"ashift",children:"ashift"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{style:{textAlign:"right"},children:"ashift"}),(0,t.jsx)(e.th,{style:{textAlign:"right"},children:"sector"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"9"}),(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"512 B"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"10"}),(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"1 KB"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"11"}),(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"2 KB"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"12"}),(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"4 KB"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"13"}),(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"8 KB"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"14"}),(0,t.jsx)(e.td,{style:{textAlign:"right"},children:"16 KB"})]})]})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"12=4KB - \u5E38\u7528\u7684 PageSize"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"l2arc",children:"L2ARC"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u8BFB\u7F13\u5B58"}),"\n",(0,t.jsx)(e.li,{children:"ARC \u4E3A\u5185\u5B58"}),"\n",(0,t.jsx)(e.li,{children:"L2ARC \u4E3A cache \u8BBE\u5907"}),"\n",(0,t.jsx)(e.li,{children:"\u4E4B\u524D\u662F\u8986\u76D6\u5199"}),"\n",(0,t.jsxs)(e.li,{children:["\u76EE\u524D\u652F\u6301 TRIM - ",(0,t.jsx)(e.a,{href:"https://github.com/zfsonlinux/zfs/pull/9789",children:"https://github.com/zfsonlinux/zfs/pull/9789"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"l2arc_trim_ahead - \u9700\u8981\u65F6\u591A trim \u591A\u5C11"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# \u53EF\u67E5\u770B SSD trim \u652F\u6301\u60C5\u51B5\nzpool status -t\n# \u89E6\u53D1 pool\nzpool trim pool\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u78C1\u76D8\u4FE1\u606F",children:"\u78C1\u76D8\u4FE1\u606F"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# sector size\n# phy sector size\nblockdev --getss --getpbsz /dev/sda\n\ncat /sys/block/sd{a,b}/queue/{logical_block_size,physical_block_size,optimal_io_size}\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/bradfa/flashbench",children:"bradfa/flashbench"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u68C0\u6D4B\u95EA\u5B58\u7684 block size"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"atime-on-temporary",children:"atime on temporary"}),"\n",(0,t.jsx)(e.p,{children:"atime \u603B\u662F\u4E3A on"}),"\n",(0,t.jsx)(e.h2,{id:"zfs_vdev_mirror_rotating_inc",children:"zfs_vdev_mirror_rotating_inc"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["mirror ssd + hdd\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4FDD\u7559\u8BFB\u6027\u80FD"}),"\n",(0,t.jsx)(e.li,{children:"\u5199\u6027\u80FD\u65E0\u6CD5\u4FDD\u969C"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"ssd-trim",children:"SSD TRIM"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"zpool set autotrim=on"})," + cron ",(0,t.jsx)(e.code,{children:"zpool trim"})]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7",children:"https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/man/8/zpool-trim.8.html",children:"https://openzfs.github.io/openzfs-docs/man/8/zpool-trim.8.html"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"\u53C2\u8003",children:"\u53C2\u8003"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://www.youtube.com/watch?v=1Wo3i2gkAIk",children:"How the ZFS Adaptive Replacement Cache works"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Free RAM is wasted RAM"})}),"\n",(0,t.jsx)(e.li,{children:"ARC \u7EF4\u62A4 LRU,LFU"}),"\n",(0,t.jsx)(e.li,{children:"\u7F13\u5B58 fs \u548C metadata - metadata \u9ED8\u8BA4 25% cache"}),"\n",(0,t.jsx)(e.li,{children:"Compress ARC - \u5B58\u50A8\u66F4\u591A\u7F13\u5B58"}),"\n",(0,t.jsx)(e.li,{children:"block - 512b - 16MB"}),"\n",(0,t.jsx)(e.li,{children:"\u57FA\u4E8E\u5185\u5B58\u538B\u529B\u8C03\u6574\u4F7F\u7528\u7684\u7F13\u5B58\u91CF - adaptive"}),"\n",(0,t.jsxs)(e.li,{children:["tuning\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"file server - \u5927 ARC, \u7F13\u5B58\u66F4\u591A metadata, \u53EF\u8003\u8651 L2ARC"}),"\n",(0,t.jsx)(e.li,{children:"block storage/iSCSI - \u5927 ARC, \u914D\u7F6E volblocksize"}),"\n",(0,t.jsx)(e.li,{children:"Database/A - \u5C0F ARC, \u53EA\u7F13\u5B58 metadata, large db buffer cache"}),"\n",(0,t.jsx)(e.li,{children:"Database/B - \u4E2D ARC, \u53EA\u7F13\u5B58 metadata, small db buffer cache, compression \u80FD\u8BA9 ARC \u547D\u4E2D\u66F4\u591A\u7F13\u5B58"}),"\n",(0,t.jsx)(e.li,{children:"Hypervisor - \u4E2D\u5C0F ARC, \u4E3A VM \u9884\u7559\u5185\u5B58, \u907F\u514D\u53CC\u7F13\u5B58"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html",children:"Workload Tuning"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["PosstgreSQL - ",(0,t.jsx)(e.a,{href:"https://vadosware.io/post/everything-ive-seen-on-optimizing-postgres-on-zfs-on-linux/",children:"Everything I've seen on optimizing Postgres on ZFS"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"recordsize=8K"}),"\n",(0,t.jsx)(e.li,{children:"logbias=throughput"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["MySQL InnoDB\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"recordsize=16K"}),"\n",(0,t.jsx)(e.li,{children:"primarycache=metadata"}),"\n",(0,t.jsx)(e.li,{children:"logbias=throughput"}),"\n",(0,t.jsxs)(e.li,{children:["my.cnf\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"skip-innodb_doublewrite"}),"\n",(0,t.jsx)(e.li,{children:"innodb_use_native_aio=0"}),"\n",(0,t.jsx)(e.li,{children:"innodb_use_atomic_writes=0"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.delphix.com/blog/delphix-engineering/zfs-raidz-stripe-width-or-how-i-learned-stop-worrying-and-love-raidz",children:"ZFS RAIDZ stripe width, or: How I Learned to Stop Worrying and Love RAIDZ"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.unixarena.com/2013/07/zfs-how-to-extend-zpool-and-re-layout.html",children:"ZFS \u2013 How to Extend ZPOOL and Re-layout ?"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://docs.oracle.com/cd/E23824_01/html/821-1448/ftyue.html",children:"ZFS Terminology"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://docs.google.com/spreadsheets/d/1pdu_X2tR4ztF6_HLtJ-Dc4ZcwUdt6fkCjpnXxAEFlyA",children:"ZFS overhead calc.xlsx"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://blogs.oracle.com/roch/tuning-zfs-recordsize",children:"Tuning ZFS recordsize"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Module%20Parameters.html",children:"Module Parameters"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://calomel.org/freebsd_network_tuning.html",children:"https://calomel.org/freebsd_network_tuning.html"})}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://docs.freebsd.org/en/books/handbook/zfs/#zfs-advanced-tuning",children:"https://docs.freebsd.org/en/books/handbook/zfs/#zfs-advanced-tuning"}),"\n\\n## Tuning Reference\\n"]}),"\n"]}),"\n",(0,t.jsx)(e.hr,{}),"\n",(0,t.jsx)(e.p,{children:"id: zfs-tuning\ntitle: \u8C03\u4F18"}),"\n",(0,t.jsx)(e.hr,{}),"\n",(0,t.jsx)(e.h1,{id:"zfs-tuning-1",children:"ZFS Tuning"}),"\n",(0,t.jsx)(e.h2,{id:"raidz",children:"RAIDZ"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.a,{href:"https://serverfault.com/a/1021299/190601",children:"https://serverfault.com/a/1021299/190601"})}),"\n",(0,t.jsx)(e.p,{children:"record size \u9ED8\u8BA4 128KiB\nValid options are 512b to 1024KiB in powers of 2.\nsector size / ashift = 512/4096\nzfs set recordsize=64k mypool/myfs"}),"\n",(0,t.jsx)(e.p,{children:"ARC Adaptive Replacement Cache"}),"\n",(0,t.jsx)(e.p,{children:"cat /proc/spl/kstat/zfs/arcstats\nc \u76EE\u6807 arc\nc_max \u6700\u5927 arc\nsize \u5F53\u524D arc"}),"\n",(0,t.jsx)(e.p,{children:"modprobe zfs zfs_arc_max=N\n/sys/module/zfs/parameters/zfs_arc_max"}),"\n",(0,t.jsxs)(e.p,{children:["awk '/^size/ { print ",(0,t.jsxs)(e.span,{className:"katex",children:[(0,t.jsx)(e.span,{className:"katex-mathml",children:(0,t.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,t.jsxs)(e.semantics,{children:[(0,t.jsxs)(e.mrow,{children:[(0,t.jsx)(e.mn,{children:"1"}),(0,t.jsx)(e.mi,{mathvariant:"normal",children:'"'}),(0,t.jsx)(e.mi,{mathvariant:"normal",children:'"'})]}),(0,t.jsx)(e.annotation,{encoding:"application/x-tex",children:'1 " " '})]})})}),(0,t.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,t.jsxs)(e.span,{className:"base",children:[(0,t.jsx)(e.span,{className:"strut",style:{height:"0.6944em"}}),(0,t.jsx)(e.span,{className:"mord",children:'1""'})]})})]}),"3 / 1048576 }' < /proc/spl/kstat/zfs/arcstats"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.a,{href:"https://superuser.com/a/1137417/242730",children:"https://superuser.com/a/1137417/242730"}),"\n",(0,t.jsx)(e.a,{href:"https://github.com/openzfs/zfs/blob/384328e544b1847236a07df231e1b7b10e4cc6ce/cmd/arc_summary/arc_summary.py",children:"https://github.com/openzfs/zfs/blob/384328e544b1847236a07df231e1b7b10e4cc6ce/cmd/arc_summary/arc_summary.py"})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"http://open-zfs.org/wiki/Performance_tuning",children:"Performance tuning"}),"\n",(0,t.jsx)(e.a,{href:"https://docs.oracle.com/cd/E18752_01/html/819-5461/ftyue.html",children:"https://docs.oracle.com/cd/E18752_01/html/819-5461/ftyue.html"})]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"\u5C5E\u6027"}),(0,t.jsx)(e.th,{children:"\u9ED8\u8BA4"}),(0,t.jsx)(e.th,{children:"\u8BF4\u660E"})]})}),(0,t.jsx)(e.tbody,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"recordsize"}),(0,t.jsx)(e.td,{children:"128K"}),(0,t.jsx)(e.td,{children:"\u5185\u90E8 COW \u7684\u57FA\u672C\u5355\u4F4D, \u53EF\u9009\u503C x^2 can be set to any power of 2 from 512 bytes to 128 kilobytes"})]})})]}),"\n",(0,t.jsx)(e.p,{children:"zdb"}),"\n",(0,t.jsx)(e.h3,{id:"recordsize",children:"recordsize"}),"\n",(0,t.jsx)(e.p,{children:"\u5185\u90E8 COW \u7684\u57FA\u672C\u5355\u4F4D\n\u53EF\u9009\u503C x^2\n\u5BF9\u65B0\u7684\u6587\u4EF6\u751F\u6548"}),"\n",(0,t.jsxs)(e.p,{children:["ZFS: Performance and Capacity Impact of Ashift=9 on 4K Sector Drives\n",(0,t.jsx)(e.a,{href:"http://louwrentius.com/zfs-performance-and-capacity-impact-of-ashift9-on-4k-sector-drives.html",children:"http://louwrentius.com/zfs-performance-and-capacity-impact-of-ashift9-on-4k-sector-drives.html"})]}),"\n",(0,t.jsx)(e.p,{children:"ZAP (ZFS Attribute Processor)"}),"\n",(0,t.jsx)(e.p,{children:"basic unit of data used for internal copy-on-write on files"}),"\n",(0,t.jsx)(e.p,{children:"read from either ARC (cheap) or disk (expensive)"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://wiki.freebsd.org/ZFSTuningGuide",children:"https://wiki.freebsd.org/ZFSTuningGuide"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"http://fibrevillage.com/storage/171-zfs-on-linux-performance-tuning",children:"http://fibrevillage.com/storage/171-zfs-on-linux-performance-tuning"})}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["Introducing ZFS Properties\n",(0,t.jsx)(e.a,{href:"https://docs.oracle.com/cd/E53394_01/html/E54801/gazss.html",children:"https://docs.oracle.com/cd/E53394_01/html/E54801/gazss.html"})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# \u8BBE\u7F6E\u548C\u67E5\u770B dedup\n# \u5F00\u542F dedup \u540E\u53EA\u5BF9\u65B0\u5199\u5165\u7684\u6570\u636E\u6709\u6548\nzfs set dedup=on main\nzfs get dedup main\n# Simulated DDT histogram\n# \u6A21\u62DF\u4F7F\u7528 dedup \u4F1A\u5E26\u6765\u7684\u597D\u5904\nzdb -S main\n\n# \u83B7\u53D6 pool \u7684 dedup \u7387\nzpool get dedupratio main\n# \u67E5\u770B dedup \u72B6\u6001\n# Total allocated blocks \u5B9E\u9645\u4F7F\u7528\u5927\u5C0F Total referenced blocks \u53BB\u91CD\u524D\u7684\u5927\u5C0F\n# \u5185\u5B58\u5360\u7528 DDT entries 2530438, size 682B on disk, 151B in core = 2530438*151/1024/1024 = 364m\nzpool status -D main\n#  dedup: DDT entries 2530438, size 682B on disk, 151B in core\n#\n# bucket              allocated                       referenced\n# ______   ______________________________   ______________________________\n# refcnt   blocks   LSIZE   PSIZE   DSIZE   blocks   LSIZE   PSIZE   DSIZE\n# ------   ------   -----   -----   -----   ------   -----   -----   -----\n#      1    2.37M    285G    276G    276G    2.37M    285G    276G    276G\n#      2    42.5K   5.30G   5.18G   5.18G    92.5K   11.5G   11.3G   11.3G\n#      4    2.01K    255M    239M    239M    8.89K   1.10G   1.04G   1.04G\n#      8      444   55.5M   54.1M   54.0M    4.74K    606M    594M    594M\n#     16      108   13.5M   13.5M   13.5M    2.21K    282M    282M    282M\n#  Total    2.41M    290G    281G    282G    2.47M    298G    289G    289G\n\n# atime - \u4E0A\u6B21\u8BBF\u95EE\u65F6\u95F4, \u4E00\u822C\u4E0D\u9700\u8981, \u5E76\u4E14\u975E\u5E38\u5F71\u54CD\u8BFB\u6027\u80FD\nzfs set atime=off main\n# relatime - atime \u7684\u6298\u4E2D\u65B9\u6848, \u7C7B\u4F3C\u4E8E ext4/xfs atime \u8BED\u4E49, \u53EA\u6709\u5728\u4FEE\u6539\u65F6\u95F4\u6216\u66F4\u65B0\u65F6\u95F4\u53D8\u5316\u65F6\u66F4\u65B0 atime, \u6216\u8005\u73B0\u5728\u7684 atime \u6709 24h \u672A\u66F4\u65B0\n# \u53EA\u6709\u5728\u5F00\u542F atime \u65F6\u624D\u4F1A\u751F\u6548\nzfs set atime=on relatime=on main\n\n# compression - \u538B\u7F29, \u9ED8\u8BA4 lz4, \u53EF\u9009\u503C on, off, zstd, lzjb, lz4, gzip, gzip-N\n# \u76EE\u524D\u8BBE\u7F6E\u4E3A lzjb, gzip, or gzip-N \u7B49\u540C\u4E8E\u8BBE\u7F6E\u4E3A on\n# \u5C5E\u6027\u53EF\u7F29\u5199\u4E3A compress\n# \u8BBE\u7F6E\u538B\u7F29\u540E\u53EA\u5BF9\u65B0\u7684\u6570\u636E\u6709\u5F71\u54CD\nzfs set compression=lz4 main\n# \u53EA\u8BFB\u5C5E\u6027, \u83B7\u53D6\u5F53\u524D\u7684\u538B\u7F29\u7387\nzfs get compressratio main\n\n# logbias - \u63A7\u5236 zfs \u5982\u4F55\u4F18\u5316\u540C\u6B65\u8BF7\u6C42, \u9ED8\u8BA4 latency\n# latency \u4EE5\u4F18\u5316\u5EF6\u8FDF\u4E3A\u4E3B, \u4F7F\u7528\u989D\u5916\u7684\u65E5\u5FD7\u8BBE\u5907\u6765\u5904\u7406\n# throughput \u4E0D\u4F1A\u4F7F\u7528\u989D\u5916\u7684\u65E5\u5FD7\u8BBE\u5907\n# \u5728\u6CA1\u6709 log \u8BBE\u5907\u65F6, \u9ED8\u8BA4\u4F1A\u5728 pool \u4E0A\u9884\u7559\u90E8\u5206\u7A7A\u95F4\u7528\u4E8E\u5B58\u50A8 ZIL, zfs \u4F7F\u7528 ZIL \u7528\u4E8E\u5D29\u6E83\u6062\u590D\nzfs set logbias=all main\n# \u4F46\u6570\u636E\u5E93\u4E00\u822C\u90FD\u4F1A\u76F4\u63A5\u505A\u540C\u6B65\u64CD\u4F5C, \u5F00\u542F\u8BE5\u529F\u80FD\u76F8\u5F53\u4E8E\u5BF9\u78C1\u76D8\u8FDB\u884C\u4E24\u6B21\u63D0\u4EA4, \u5F71\u54CD\u6027\u80FD\n# \u5728\u975E\u6570\u636E\u5E93\u6587\u4EF6\u7CFB\u7EDF\u548C\u4E00\u7EA7\u914D\u7F6E\u4E86 log \u8BBE\u5907\u7684\u6587\u4EF6\u7CFB\u7EDF\u4E0A, \u8BBE\u7F6E\u8FD9\u4E2A\u53EF\u80FD\u5BF9\u6027\u80FD\u6709\u4E0D\u597D\u7684\u5F71\u54CD\nzfs set logbias=throughput main/postgres\n\n# recordsize - \u63A8\u8350\u5757\u5927\u5C0F, \u9ED8\u8BA4\u60C5\u51B5\u4E0B, \u4F7F\u7528\u9ED8\u8BA4\u503C\u5373\u53EF, \u9ED8\u8BA4 128KiB\n# \u53EF\u4F7F\u7528\u7F29\u5199  recsize\n# \u8BE5\u5C5E\u6027\u4E3B\u8981\u9488\u5BF9\u6570\u636E\u5E93\u8BBE\u8BA1, \u6BCF\u6B21\u8BBF\u95EE\u6587\u4EF6\u90FD\u662F\u56FA\u5B9A\u5927\u5C0F. ZFS \u4F1A\u6839\u636E\u5185\u90E8\u7B97\u6CD5\u81EA\u52A8\u8C03\u6574\u5757\u5927\u5C0F, \u6570\u636E\u5E93\u4F1A\u521B\u5EFA\u6BD4\u8F83\u5927\u7684\u6587\u4EF6, \u4F46\u6BCF\u6B21\u8BBF\u95EE\u90FD\u662F\u975E\u5E38\u5C0F\u7684\u968F\u673A\u5757.\n# \u4F46\u9488\u5BF9\u6570\u636E\u5E93, \u5EFA\u8BAE\u4F7F\u7528\u6570\u636E\u5E93\u8BB0\u5F55\u5927\u5C0F, \u5927\u591A\u6570\u5173\u7CFB\u578B\u6570\u636E\u5E93\u90FD\u662F 8K \u7684\u5757\nzfs set recordsize=8K main/postgres\nzfs get recordsize main/archive\n\n# primarycache - \u63A7\u5236\u4EC0\u4E48\u4F1A\u88AB\u7F13\u5B58\u5728\u4E3B\u8981\u7F13\u5B58\u4E2D ARC, \u9ED8\u8BA4 all \u53EF\u9009\u503C all, none, metadata\n# \u4E00\u822C\u6570\u636E\u5E93\u90FD\u4F1A\u7528\u81EA\u5DF1\u7684\u65B9\u5F0F\u5B9E\u73B0\u7F13\u5B58, \u56E0\u6B64\u6CA1\u6709\u5FC5\u8981\u8BA9 zfs \u518D\u7F13\u5B58\u6570\u636E\nzfs set primarycache=metadata main/postgres\n\n# secondarycache - \u63A7\u5236\u4EC0\u4E48\u4F1A\u8FDB\u5165\u5230\u4E8C\u7EA7\u7F13\u5B58 L2ARC, \u9ED8\u8BA4 all, \u53EF\u9009\u503C  all, none, metadata\nzfs get secondarycache main\n\n# type - \u53EA\u8BFB, \u83B7\u53D6\u6570\u636E\u96C6\u7C7B\u578B filesystem, volume, \u6216 snapshot.\nzfs get type main\n# used - \u53EA\u8BFB, \u83B7\u53D6\u5DF2\u4F7F\u7528\u7A7A\u95F4\nzfs get used main\n# available - \u53EA\u8BFB, \u53EF\u7528\u7A7A\u95F4\nzfs get available main\n# creation - \u53EA\u8BFB, \u521B\u5EFA\u65F6\u95F4\nzfs get creation main\n# mounted - \u53EA\u8BFB, \u662F\u5426\u5DF2\u7ECF\u6302\u8F7D\n# mountpoint - \u6302\u8F7D\u70B9\n# quota - \u9650\u989D\n# readonly - \u662F\u5426\u53EA\u8BFB\n\n# version - \u53EA\u8BFB, \u78C1\u76D8\u6587\u4EF6\u7CFB\u7EDF\u7248\u672C, \u72EC\u7ACB\u4E8E pool \u7248\u672C\nzfs get version main\n# xattr - \u662F\u5426\u542F\u7528\u6269\u5C55\u5C5E\u6027\nzfs get xattr main\n\n# \u6240\u6709\u914D\u7F6E\u53C2\u6570\n# ======\nzfs get all p1\n# NAME  PROPERTY              VALUE           SOURCE\n# p1    type                  filesystem      -\n# p1    creation              1507714508      -\n# p1    used                  400K            -\n# p1    available             138M            -\n# p1    referenced            128K            -\n# p1    compressratio         1.00x           -\n# p1    mounted               yes             -\n# p1    quota                 none            default\n# p1    reservation           none            default\n# p1    recordsize            128K            default\n# p1    mountpoint            /mnt/data       local\n# p1    sharenfs              off             default\n# p1    checksum              on              default\n# p1    compression           off             default\n# p1    atime                 on              default\n# p1    devices               on              default\n# p1    exec                  on              default\n# p1    setuid                on              default\n# p1    readonly              off             default\n# p1    zoned                 off             default\n# p1    snapdir               hidden          default\n# p1    aclinherit            restricted      default\n# p1    canmount              on              default\n# p1    xattr                 on              default\n# p1    copies                1               default\n# p1    version               5               -\n# p1    utf8only              off             -\n# p1    normalization         none            -\n# p1    casesensitivity       sensitive       -\n# p1    vscan                 off             default\n# p1    nbmand                off             default\n# p1    sharesmb              off             default\n# p1    refquota              none            default\n# p1    refreservation        none            default\n# p1    primarycache          all             default\n# p1    secondarycache        all             default\n# p1    usedbysnapshots       0               -\n# p1    usedbydataset         128K            -\n# p1    usedbychildren        272K            -\n# p1    usedbyrefreservation  0               -\n# p1    logbias               latency         default\n# p1    dedup                 off             default\n# p1    mlslabel              none            default\n# p1    sync                  standard        default\n# p1    refcompressratio      1.00x           -\n# p1    written               128K            -\n# p1    logicalused           92.5K           -\n# p1    logicalreferenced     40K             -\n# p1    filesystem_limit      none            default\n# p1    snapshot_limit        none            default\n# p1    filesystem_count      none            default\n# p1    snapshot_count        none            default\n# p1    snapdev               hidden          default\n# p1    acltype               off             default\n# p1    context               none            default\n# p1    fscontext             none            default\n# p1    defcontext            none            default\n# p1    rootcontext           none            default\n# p1    relatime              off             default\n# p1    redundant_metadata    all             default\n# p1    overlay               off             default\n"})}),"\n",(0,t.jsx)(e.h2,{id:"tuning",children:"Tuning"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/openzfs/zfs/issues/9375",children:"#9375"})," - Subpar performance of RAIDZ, reads are slower than writes"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/ZFS%20on%20Linux%20Module%20Parameters.html",children:"\u6A21\u5757\u53C2\u6570"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/man/8/zfs.8.html",children:"zfs.8"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/man/8/zfsprops.8.html",children:"zfsprops.8"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://openzfs.github.io/openzfs-docs/man/8/zpoolprops.8.html",children:"zpoolprops.8"})}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"zpool get -o all all main | egrep 'ashift'\nzfs get all main/data | egrep 'ashift|relatime|canmount|compression|xattr|dnodesize|acltype|normalization'"}),"\n",(0,t.jsx)(e.p,{children:"ashift=12\nrelatime=on\ncanmount=off\ncompression=lz4\nxattr=sa\ndnodesize=auto\nacltype=posixacl\nnormalization=formD"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# https://jrs-s.net/2018/03/13/zvol-vs-qcow2-with-kvm/\n# 4k \u968F\u673A\n# randread - \u968F\u673A\u8BFB\nfio --name=random-write --ioengine=sync --iodepth=4 \\\n  --rw=randwrite --bs=4k --direct=0 --size=256m --numjobs=2 \\\n  --end_fsync=1\n"})}),"\n",(0,t.jsx)(e.h2,{id:"result",children:"RESULT"}),"\n",(0,t.jsx)(e.h3,{id:"raidz1-randwrite-4k-x-2",children:"raidz1 randwrite 4k x 2"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"fio --name=random-write --ioengine=sync --iodepth=4 \\\n  --rw=randwrite --bs=4k --direct=0 --size=256m --numjobs=2 \\\n  --end_fsync=1\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"Jobs: 1 (f=1): [F(1),_(1)][100.0%][w=232MiB/s][w=59.5k IOPS][eta 00m:00s]\nrandom-write: (groupid=0, jobs=1): err= 0: pid=27959: Thu Jul 16 00:22:03 2020\n  write: IOPS=2338, BW=9353KiB/s (9578kB/s)(256MiB/28027msec); 0 zone resets\n    clat (usec): min=4, max=495041, avg=415.40, stdev=4703.61\n     lat (usec): min=4, max=495042, avg=415.48, stdev=4703.63\n    clat percentiles (usec):\n     |  1.00th=[     5],  5.00th=[     5], 10.00th=[     5], 20.00th=[     6],\n     | 30.00th=[     6], 40.00th=[     6], 50.00th=[     6], 60.00th=[     6],\n     | 70.00th=[     6], 80.00th=[     7], 90.00th=[    12], 95.00th=[    54],\n     | 99.00th=[ 13042], 99.50th=[ 20841], 99.90th=[ 67634], 99.95th=[ 82314],\n     | 99.99th=[149947]\n   bw (  KiB/s): min=   71, max=14744, per=4.02%, avg=751.23, stdev=2173.43, samples=47\n   iops        : min=   17, max= 3686, avg=187.70, stdev=543.36, samples=47\n  lat (usec)   : 10=89.76%, 20=2.80%, 50=2.36%, 100=2.50%, 250=0.21%\n  lat (usec)   : 500=0.23%, 750=0.02%, 1000=0.01%\n  lat (msec)   : 2=0.03%, 4=0.09%, 10=0.81%, 20=0.65%, 50=0.38%\n  lat (msec)   : 100=0.12%, 250=0.04%, 500=0.01%\n  cpu          : usr=0.33%, sys=3.28%, ctx=2037, majf=0, minf=13\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%\n     issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=4\nrandom-write: (groupid=0, jobs=1): err= 0: pid=27960: Thu Jul 16 00:22:03 2020\n  write: IOPS=3768, BW=14.7MiB/s (15.4MB/s)(256MiB/17392msec); 0 zone resets\n    clat (usec): min=4, max=122329, avg=253.68, stdev=2705.38\n     lat (usec): min=4, max=122329, avg=253.78, stdev=2705.40\n    clat percentiles (usec):\n     |  1.00th=[    5],  5.00th=[    5], 10.00th=[    5], 20.00th=[    6],\n     | 30.00th=[    6], 40.00th=[    6], 50.00th=[    6], 60.00th=[    6],\n     | 70.00th=[    7], 80.00th=[   15], 90.00th=[   20], 95.00th=[   57],\n     | 99.00th=[10159], 99.50th=[18220], 99.90th=[39584], 99.95th=[52167],\n     | 99.99th=[82314]\n   bw (  KiB/s): min=  312, max=209976, per=45.19%, avg=8454.06, stdev=36298.89, samples=33\n   iops        : min=   78, max=52494, avg=2113.52, stdev=9074.72, samples=33\n  lat (usec)   : 10=78.23%, 20=13.08%, 50=2.80%, 100=4.46%, 250=0.05%\n  lat (usec)   : 500=0.18%, 750=0.01%, 1000=0.01%\n  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.16%, 20=0.59%, 50=0.37%\n  lat (msec)   : 100=0.05%, 250=0.01%\n  cpu          : usr=0.65%, sys=5.59%, ctx=1290, majf=0, minf=12\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%\n     issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=4\n\nRun status group 0 (all jobs):\n  WRITE: bw=18.3MiB/s (19.2MB/s), 9353KiB/s-14.7MiB/s (9578kB/s-15.4MB/s), io=512MiB (537MB), run=17392-28027msec\n"})}),"\n",(0,t.jsx)(e.h3,{id:"raidz1-seqwrite-512k-x-2",children:"raidz1 seqwrite 512k x 2"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"fio --name=seq-write --ioengine=libaio --iodepth=4 \\\n  --rw=seqread --bs=4k --direct=0 --size=256m --numjobs=2 \\\n  --end_fsync=1\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.a,{href:"https://superuser.com/questions/1137416/how-can-i-determine-the-current-size-of-the-arc-in-zfs-and-how-does-the-arc-rel",children:"https://superuser.com/questions/1137416/how-can-i-determine-the-current-size-of-the-arc-in-zfs-and-how-does-the-arc-rel"}),"\n",(0,t.jsx)(e.a,{href:"https://www.unixarena.com/2013/07/zfs-zpool-cache-and-log-devices.html/",children:"https://www.unixarena.com/2013/07/zfs-zpool-cache-and-log-devices.html/"})]}),"\n",(0,t.jsx)(e.p,{children:"\u7F13\u5B58\u4F7F\u7528\u60C5\u51B5\nzpool iostat -v"}),"\n",(0,t.jsx)(e.p,{children:"ZFS Caches:\nZFS Caching mechanisms will also use LRU (Least Recently Used) caching algorithm which is used processor caching technology. ZFS has two type of caches.1.ZFS ARC 2.ZFS L2ARC"}),"\n",(0,t.jsx)(e.p,{children:"ZFS ARC:\nZFS Adjustable Replacement Cache will typically occupy 7/8 of available physical memory and this memory will be released for applications whenever required, ZFS ARC will adjust the memory usage according to the kernel needs."}),"\n",(0,t.jsx)(e.p,{children:"ZFS L2ARC:\nZFS L2ARC is level 2 adjustable replacement cache and normally L2ARC resides on fastest LUNS or SSD.L2ARC Cache devices provide an additional layer of caching between main memory and disk.It increases the great performance of random-read workloads of static content.Here we will see how to setup L2ARC on physical disks."}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.a,{href:"https://www.servethehome.com/zfs-on-ubuntu-create-zfs-pool-with-nvme-l2arc-and-share-via-smb/",children:"https://www.servethehome.com/zfs-on-ubuntu-create-zfs-pool-with-nvme-l2arc-and-share-via-smb/"})})]})}function h(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(o,{...n})}):o(n)}},917776:function(n,e,s){s.d(e,{R:()=>r,x:()=>d});var i=s(7378);let t={},l=i.createContext(t);function r(n){let e=i.useContext(l);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:r(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);