"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["98120"],{55062:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>r,toc:()=>o,default:()=>a,metadata:()=>s,assets:()=>t,contentTitle:()=>d});var s=JSON.parse('{"id":"service/forge/coding","title":"Coding","description":"- https://coding.net","source":"@site/../notes/service/forge/coding.md","sourceDirName":"service/forge","slug":"/service/forge/coding","permalink":"/notes/service/forge/coding","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/forge/coding.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1708697175000,"frontMatter":{"title":"Coding"},"sidebar":"docs","previous":{"title":"CI FAQ","permalink":"/notes/service/forge/ci-faq"},"next":{"title":"ConcourseCI","permalink":"/notes/service/forge/concourse/"}}'),c=i(86106),l=i(17776);let r={title:"Coding"},d="coding",t={},o=[{value:"Worker",id:"worker",level:2},{value:"Jenkins Deploy",id:"jenkins-deploy",level:3},{value:"CI Env",id:"ci-env",level:2},{value:"\u5236\u54C1",id:"\u5236\u54C1",level:2},{value:"Shadow Clone Depths",id:"shadow-clone-depths",level:2}];function h(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(e.header,{children:(0,c.jsx)(e.h1,{id:"coding",children:"coding"})}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsxs)(e.li,{children:[(0,c.jsx)(e.a,{href:"https://coding.net",children:"https://coding.net"}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"\u529F\u80FD\u975E\u5E38\u591A\u975E\u5E38\u5168"}),"\n",(0,c.jsx)(e.li,{children:"\u56E2\u961F -> \u9879\u76EE -> \u4ED3\u5E93"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\u514D\u8D39\u7248 - ",(0,c.jsx)(e.a,{href:"https://coding.net/pricing",children:"https://coding.net/pricing"}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"\u4ED3\u5E93 10G"}),"\n",(0,c.jsx)(e.li,{children:"Docker \u5236\u54C1 1000 \u4E2A"}),"\n",(0,c.jsx)(e.li,{children:"\u975E Docker \u5236\u54C1 5G"}),"\n",(0,c.jsx)(e.li,{children:"\u9879\u76EE\u7BA1\u7406 5000 \u6761\u8BB0\u5F55"}),"\n",(0,c.jsx)(e.li,{children:"\u6D4B\u8BD5\u7528\u4F8B 3000 \u6761\u8BB0\u5F55"}),"\n",(0,c.jsx)(e.li,{children:"\u7F51\u76D8 20G"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.h2,{id:"worker",children:"Worker"}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsxs)(e.li,{children:["CI/CD \u57FA\u4E8E Jenkins\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"Jenkinsfile"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.li,{children:"/etc/qci.conf"}),"\n",(0,c.jsx)(e.li,{children:"/etc/cci_daemon.conf"}),"\n",(0,c.jsx)(e.li,{children:"/root/codingci - CI_HOME"}),"\n",(0,c.jsx)(e.li,{children:"/root/codingci/tools/jenkins_home/workspace/"}),"\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.code,{children:"/root/codingci/msg/msg_<TIMESTAMP>.json"})}),"\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.code,{children:"/root/codingci/cci_daemon.log"})}),"\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.code,{children:"/root/codingci/jenkins.log"})}),"\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.code,{children:"/root/codingci/ci_log_YYYY-MM-DD.log"})}),"\n"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:'apk add git make java python\n\nmkdir -p /root/codingci/tools\ncd /root/codingci/tools\ncurl -fL "https://coding-public-generic.pkg.coding.net/cci/release/cci-agent/jenkins.war?version=2.293-cci" -o jenkins.war\ncurl -fL "https://coding-public-generic.pkg.coding.net/cci/release/jenkinsHome.zip?version=latest" -o jenkins_home.zip\nunzip jenkins_home.zip\n\n# py \u811A\u672C\nqci_worker version\n\n# \u5B98\u65B9\u5B89\u88C5\u547D\u4EE4\n# VERSION=2023.04.06-98504ecfdfc8699d3b557059c3fe79b8ebc2c668\ncurl -fL "https://public-files.coding.net/public-files/coding-ci/install/linux/install.sh?version=2023.04.06-98504ecfdfc8699d3b557059c3fe79b8ebc2c668" | CODING_SERVER=wss://$PROJECT.coding.net PACKAGE_URL=https://public-files.coding.net JENKINS_VERSION=2.293-cci-v2.5 JENKINS_HOME_VERSION=v65 PYPI_HOST=https://$PROJECT.coding.net/ci/pypi/simple PYPI_EXTRA_INDEX_URL= LOG_REPORT=http://worker-beat.coding.net CI_HOME=/root/codingci bash -s $TOKEN false default\n# \u91CD\u65B0\u542F\u52A8\nqci_worker up -d\n'})}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-ini",metastring:"title=/etc/qci.conf",children:"[default]\nPYPI_PACKAGE_URL = https://PROJECT.coding.net/ci/pypi/simple/qci-worker/\nPYPI_INDEX_URL = https://PROJECT.coding.net/ci/pypi/simple\nNODE_LOG_REPORT_HOST = http://worker-beat.coding.net\nCI_HOME = /root/codingci\nAPI_HOST = https://PROJECT.coding.net\nNODE_CLIENT_ID =\nNODE_CLIENT_FINGERPRINT =\nNODE_TOKEN =\n"})}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.a,{href:"https://coding.net/help/docs/ci/node/customize.html",children:"https://coding.net/help/docs/ci/node/customize.html"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(e.table,{children:[(0,c.jsx)(e.thead,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.th,{children:"\u5305\u7BA1\u7406\u5DE5\u5177"}),(0,c.jsx)(e.th,{children:"\u7F13\u5B58\u76EE\u5F55"})]})}),(0,c.jsxs)(e.tbody,{children:[(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"Maven"}),(0,c.jsx)(e.td,{children:"/root/.m2/"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"Gradle"}),(0,c.jsx)(e.td,{children:"/root/.gradle/"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"npm"}),(0,c.jsx)(e.td,{children:"/root/.npm/"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"composer"}),(0,c.jsx)(e.td,{children:"/root/.cache/composer/"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"pip3"}),(0,c.jsx)(e.td,{children:"/root/.cache/pip/"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"yarn"}),(0,c.jsx)(e.td,{children:"/usr/local/share/.cache/yarn/"})]})]})]}),"\n",(0,c.jsx)(e.h3,{id:"jenkins-deploy",children:"Jenkins Deploy"}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsxs)(e.li,{children:["\u6302\u8F7D\u76EE\u5F55\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsxs)(e.li,{children:["/cache\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"\u5168\u5C40\u7F13\u5B58"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["/root\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"\u7528\u6237\u7F13\u5B58"}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["/var/run/docker\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"\u8BBF\u95EE docker"}),"\n",(0,c.jsx)(e.li,{children:"\u901A\u8FC7 dind \u90E8\u7F72\uFF0C\u4F46\u8C03\u6574\u4E86 sock \u76EE\u5F55\u65B9\u4FBF\u6302\u8F7D"}),"\n",(0,c.jsxs)(e.li,{children:["\u4FEE\u6539\u73AF\u5883\u53D8\u91CF ",(0,c.jsx)(e.code,{children:"DOCKER_HOST=unix:///var/run/docker/docker.sock"})]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["/etc/local.d/worker.start\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"Jenkins \u542F\u52A8\u811A\u672C"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.h2,{id:"ci-env",children:"CI Env"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(e.table,{children:[(0,c.jsx)(e.thead,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.th,{children:"env"}),(0,c.jsx)(e.th,{children:"for"})]})}),(0,c.jsx)(e.tbody,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"DEPOT_NAME"}),(0,c.jsx)(e.td,{children:"\u4ED3\u5E93\u540D"})]})})]}),"\n",(0,c.jsx)(e.h2,{id:"\u5236\u54C1",children:"\u5236\u54C1"}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"Composer"}),"\n",(0,c.jsx)(e.li,{children:"Maven"}),"\n",(0,c.jsx)(e.li,{children:"Docker"}),"\n",(0,c.jsx)(e.li,{children:"Generic"}),"\n",(0,c.jsx)(e.li,{children:"Npm"}),"\n"]}),"\n",(0,c.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"CI \u8FD0\u884C\u53EF\u80FD\u6CA1\u6709 HOME \u53D8\u91CF"}),"\n",(0,c.jsxs)(e.li,{children:["\u5065\u5EB7\u68C0\u67E5\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.code,{children:"ps -ef | grep jenkins.war | grep -v grep"})}),"\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.code,{children:"pgrep -f jenkins.war"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"java -Dsun.java2d.debugfonts=warning -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 -jar /root/codingci/tools/jenkins.war --httpPort=15740 --httpListenAddress=127.0.0.1\n"})}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-groovy",children:"stage('\u68C0\u51FA') {\n  when {\n    branch 'env/*'\n    expression {\n      env.BRANCH_NAME=='123'\n      env.BRANCH_NAME ==~ /feature\\/[0-9]+\\.[0-9]+\\.[0-9]+/\n    }\n  }\n}\n"})}),"\n",(0,c.jsx)(e.h2,{id:"shadow-clone-depths",children:"Shadow Clone Depths"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-groovy",children:"checkout(\n  [$class: 'GitSCM',\n  // branches: [[name: '*/master']],\n  branches: [[name: GIT_BUILD_REF]],\n  // extensions: [[$class: 'CloneOption', noTags: false, shallow: true, depth: 1, /*timeout: 30*/]],\n  userRemoteConfigs: [[ url: GIT_REPO_URL, credentialsId: CREDENTIALS_ID ]]]\n)\n"})}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:(0,c.jsx)(e.a,{href:"https://javadoc.jenkins.io/plugin/git/hudson/plugins/git/extensions/impl/CloneOption.html",children:"https://javadoc.jenkins.io/plugin/git/hudson/plugins/git/extensions/impl/CloneOption.html"})}),"\n"]})]})}function a(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,c.jsx)(e,{...n,children:(0,c.jsx)(h,{...n})}):h(n)}},17776:function(n,e,i){i.d(e,{R:()=>r,x:()=>d});var s=i(7378);let c={},l=s.createContext(c);function r(n){let e=s.useContext(l);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(c):n.components||c:r(n.components),s.createElement(l.Provider,{value:e},n.children)}}}]);