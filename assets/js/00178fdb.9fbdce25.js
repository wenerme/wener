"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["61128"],{76817:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>r,toc:()=>h,default:()=>a,metadata:()=>t,assets:()=>d,contentTitle:()=>c});var t=JSON.parse('{"id":"db/relational/postgresql/postgresql-plan","title":"PostgreSQL Plan","description":"- explain","source":"@site/../notes/db/relational/postgresql/postgresql-plan.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/plan","permalink":"/notes/db/relational/postgresql/plan","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-plan.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1715155165000,"frontMatter":{"title":"PostgreSQL Plan"},"sidebar":"docs","previous":{"title":"PostgreSQL PL","permalink":"/notes/db/relational/postgresql/pl"},"next":{"title":"PL/pgSQL","permalink":"/notes/db/relational/postgresql/plpgsql"}}'),l=s(86106),i=s(17776);let r={title:"PostgreSQL Plan"},c="PostgreSQL Plan",d={},h=[{value:"cost",id:"cost",level:2},{value:"statistic",id:"statistic",level:2}];function o(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"postgresql-plan",children:"PostgreSQL Plan"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["explain\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"rows = selectivity * reltuples"})}),"\n",(0,l.jsxs)(e.li,{children:["scalarltsel\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u57FA\u4E8E histogram_bounds \u8BA1\u7B97 rows"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"selectivity = (1 + (reltuples - bucket[2].min)/(bucket[2].max - bucket[2].min))/num_buckets"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"rows = rel_cardinality * selectivity"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["eqsel\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u57FA\u4E8E MCVs \u8BA1\u7B97 rows"}),"\n",(0,l.jsxs)(e.li,{children:["\u4E0D\u5728 MCV \u5219\u6392\u9664\u6240\u6709\u8BA1\u7B97\u6982\u7387 \u8BA1\u7B97 rows\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"selectivity=(1 - sum(mvf))/(num_distinct - num_mcv)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"merge, hash, nested loop"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/runtime-config-query.html",children:"Query Planning"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/performance-tips.html",children:"Performance Tips"})}),"\n",(0,l.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"http://tatiyants.com/pev",children:"PEV"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"cost",children:"cost"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["cost=0.00..40397.82 rows=3698 width=86\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"cost=\u521D\u59CB\u6210\u672C..\u603B\u6210\u672C"}),"\n",(0,l.jsx)(e.li,{children:"rows=\u9884\u8BA1\u884C\u6570"}),"\n",(0,l.jsx)(e.li,{children:"width=\u5E73\u5747\u5BBD\u5EA6"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["actual time=15.281..15.299 rows=5 loops=1\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5B9E\u9645\u6267\u884C"}),"\n",(0,l.jsx)(e.li,{children:"time=\u4ECE..\u5230"}),"\n",(0,l.jsx)(e.li,{children:"rows=\u884C\u6570"}),"\n",(0,l.jsx)(e.li,{children:"loops=\u904D\u5386"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"select name, setting, unit\nfrom pg_settings ps\nwhere name like '%_cost'\norder by 1;\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{style:{textAlign:"right"},children:"name"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"setting"}),(0,l.jsx)(e.th,{children:"note"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"cpu_index_tuple_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"0.005"}),(0,l.jsx)(e.td,{children:"\u5904\u7406\u4E00\u4E2A\u7D22\u5F15\u884C"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"cpu_operator_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"0.0025"}),(0,l.jsx)(e.td,{children:"\u5904\u7406 operator \u548C\u51FD\u6570\u8C03\u7528"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"cpu_tuple_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"0.01"}),(0,l.jsx)(e.td,{children:"\u5904\u7406\u4E00\u4E2A\u6570\u636E\u884C"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"random_page_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"4"}),(0,l.jsx)(e.td,{children:"\u968F\u673A\u8BBF\u95EE"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"seq_page_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"1"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"jit_above_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"100000"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"jit_inline_above_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"500000"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"jit_optimize_above_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"500000"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"parallel_setup_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"1000"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"right"},children:"parallel_tuple_cost"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"0.1"}),(0,l.jsx)(e.td,{})]})]})]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["random_page_cost\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5F71\u54CD\u662F\u5426\u9009\u62E9 index scan - \u8D8A\u4F4E\u8D8A\u503E\u5411 index scan"}),"\n",(0,l.jsx)(e.li,{children:"\u8BC4\u4F30\u5B58\u50A8\u7F13\u5B58\u547D\u4E2D\u3001\u5B58\u50A8\u4ECB\u8D28\u8BBF\u95EE"}),"\n",(0,l.jsx)(e.li,{children:"\u503C\u76F8\u5BF9\u4E8E seq_page_cost"}),"\n",(0,l.jsxs)(e.li,{children:["\u9ED8\u8BA4 4\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53EF\u7406\u89E3\u4E3A\u7B14 seq \u8BBF\u95EE\u6162 40 \u500D"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"ssd \u4E00\u822C 1.1"}),"\n",(0,l.jsx)(e.li,{children:"raw \u4E00\u822C 1 - seq_page_cost=random_page_cost"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["seq_page_cost\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5B58\u50A8\u76F8\u5BF9\u4E8E cpu \u7684 cost"}),"\n",(0,l.jsx)(e.li,{children:"\u8C03\u4F4E\u5219\u76F8\u5F53\u4E8E \u5B58\u50A8\u8BBF\u95EE \u548C CPU \u8BA1\u7B97\u66F4\u63A5\u8FD1\uFF0C\u4F8B\u5982 RAW \u573A\u666F"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"statistic",children:"statistic"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/planner-stats.html",children:"https://www.postgresql.org/docs/current/planner-stats.html"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-DEFAULT-STATISTICS-TARGET",children:"default_statistics_target"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"most_common_vals, histogram_bounds \u7EDF\u8BA1\u591A\u5C11\u6761\u6570\u636E"}),"\n",(0,l.jsxs)(e.li,{children:["\u9ED8\u8BA4 100\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"100 * 300"})," (magic number) pages"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["VACUUM, ANALYZE\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u66F4\u65B0 pg_class\u3001pg_statistic"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/catalog-pg-statistic.html",children:"pg_statistic"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"ALTER TABLE SET STATISTICS \u4FEE\u6539 most_common_vals, histogram_bounds \u6570\u91CF"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/view-pg-stats.html",children:"pg_stats"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u89C6\u56FE\u3001\u66F4\u52A0\u76F4\u89C2"}),"\n",(0,l.jsxs)(e.li,{children:["correlation - \u5B57\u6BB5\u76F8\u5173\u6027\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u503C\u63A5\u8FD1 -1 \u6216 +1 \u65F6 index \u626B\u63CF\u6210\u672C\u66F4\u4F4E"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["n_distinct\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["< 0 \u8868\u793A\u4F1A\u968F\u8868\u589E\u52A0\u800C\u589E\u52A0\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"n_distinct = rows / - n_distinct"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/catalog-pg-statistic-ext-data.html",children:"pg_statistic_ext_data"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"ndistinct"}),"\n",(0,l.jsx)(e.li,{children:"mcv"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/row-estimation-examples.html",children:"Row Estimation Examples"})}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- reltuples \u884C\nSELECT relname, relkind, reltuples, relpages\nFROM pg_class\nWHERE relname LIKE 'tenk1%';\n\n-- attname \u5B57\u6BB5\n-- n_distinct \u5DEE\u5F02\n-- most_common_vals \u5E38\u89C1\u503C\nSELECT attname,\n       inherited,\n       n_distinct,\n       array_to_string(most_common_vals, E'\\n') as most_common_vals\nFROM pg_stats\nWHERE tablename = 'table';\n"})}),"\n",(0,l.jsx)(e.h1,{id:"faq",children:"FAQ"})]})}function a(n={}){let{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(o,{...n})}):o(n)}},17776:function(n,e,s){s.d(e,{R:()=>r,x:()=>c});var t=s(7378);let l={},i=t.createContext(l);function r(n){let e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:r(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);