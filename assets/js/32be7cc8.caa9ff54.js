"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["54233"],{432806:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>c,toc:()=>h,default:()=>a,metadata:()=>r,assets:()=>d,contentTitle:()=>t});var r=JSON.parse('{"id":"devops/web/haproxy/haproxy-conf","title":"HAProxy \u914D\u7F6E","description":"- http-tunnel","source":"@site/../notes/devops/web/haproxy/haproxy-conf.md","sourceDirName":"devops/web/haproxy","slug":"/devops/web/haproxy/conf","permalink":"/notes/devops/web/haproxy/conf","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/haproxy/haproxy-conf.md","tags":[{"inline":true,"label":"Configuration","permalink":"/notes/tags/configuration"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1770607102000,"frontMatter":{"title":"HAProxy \u914D\u7F6E","tags":["Configuration"]},"sidebar":"docs","previous":{"title":"HAProxy","permalink":"/notes/devops/web/haproxy/"},"next":{"title":"HAProxy Cookbook & Useful Snippets","permalink":"/notes/devops/web/haproxy/cookbook"}}'),i=s(486106),l=s(917776);let c={title:"HAProxy \u914D\u7F6E",tags:["Configuration"]},t="HAProxy \u914D\u7F6E",d={},h=[{value:"Timeout",id:"timeout",level:2},{value:"env",id:"env",level:2},{value:"\u63A7\u5236\u6D41",id:"control-flow",level:2},{value:"acl",id:"acl",level:2},{value:"balance",id:"balance",level:2},{value:"HAProxy \u900F\u660E\u4EE3\u7406+Traefik",id:"haproxy-\u900F\u660E\u4EE3\u7406traefik",level:2},{value:"\u4FDD\u7559\u72B6\u6001",id:"\u4FDD\u7559\u72B6\u6001",level:2},{value:"\u4EA4\u4E92\u547D\u4EE4",id:"\u4EA4\u4E92\u547D\u4EE4",level:2},{value:"SNI Proxy",id:"sni-proxy",level:2},{value:"SSL \u914D\u7F6E",id:"ssl-\u914D\u7F6E",level:2},{value:"\u53C2\u8003",id:"\u53C2\u8003",level:2},{value:"\u5B9E\u9A8C",id:"\u5B9E\u9A8C",level:2},{value:"redispatch",id:"redispatch",level:2},{value:"Health Check",id:"health-check",level:2}];function o(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"haproxy-\u914D\u7F6E",children:"HAProxy \u914D\u7F6E"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"haproxy -c -V -f /etc/haproxy/haproxy.cfg # \u68C0\u6D4B\u914D\u7F6E\n\nulimit -n 8036\nhaproxy -f /etc/haproxy/haproxy.cfg -d # Debug \u542F\u52A8\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["http-tunnel\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5904\u7406 HTTP CONNECT"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv",children:"https://cbonte.github.io/haproxy-dconv"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage",children:"https://www.haproxy.com/documentation/hapee/latest/onepage"})}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["maxconn\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"frontend \u63A5\u53D7\u7684\u6700\u5927\u8FDE\u63A5\u6570"}),"\n",(0,i.jsx)(e.li,{children:"4096 fd \u9ED8\u8BA4 maxconn ~ 1700"}),"\n",(0,i.jsx)(e.li,{children:"10000 \u8FDE\u63A5 ~450MB - ~580MB"}),"\n",(0,i.jsx)(e.li,{children:"fd ~= maxconn*2 + 1000"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"/proc/sys/fs/file-max"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"timeout",children:"Timeout"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"HTTP or TCP"}),"\n",(0,i.jsx)(e.li,{children:"One Shot or Stream"}),"\n",(0,i.jsx)(e.li,{children:"Latency or Bandwidth"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"# HTTP \u573A\u666F\ntimeout connect 5s    # \u5BA2\u6237\u7AEF connect \u4E0A\u7684\u65F6\u95F4\ntimeout client 50s    # \u5BA2\u6237\u7AEF idle \u65F6\u957F\uFF0C\u4E00\u822C 5m\ntimeout server 50s    # \u670D\u52A1\u7AEF\u54CD\u5E94\u65F6\u957F - 504\n\nretries                 3\ntimeout http-request    10s\ntimeout queue           1m\ntimeout connect         10s\ntimeout client          10m\ntimeout server          10m\ntimeout http-keep-alive 10s\ntimeout check           10s\nmaxconn                 30000\n\ntimeout http-request    10s # \u6574\u4E2A\u8BF7\u6C42\u65F6\u957F\ntimeout http-keep-alive 2s\ntimeout queue           5s  # concurrent connections\uFF0C\u9ED8\u8BA4 timeout connect\ntimeout tunnel          2m  # WebSockets\uFF0C\u7C7B\u4F3C keep-alive\ntimeout client-fin      1s  # dropped client side connections \u53EF\u80FD\u4F1A\u6062\u590D\u7684\u65F6\u95F4\ntimeout server-fin      1s\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.papertrail.com/solution/tips/haproxy-logging-how-to-tune-timeouts-for-performance/",children:"https://www.papertrail.com/solution/tips/haproxy-logging-how-to-tune-timeouts-for-performance/"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"env",children:"env"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"${ENV_NAME-\u9ED8\u8BA4\u503C}"})}),"\n",(0,i.jsxs)(e.li,{children:["HAPROXY_LOCALPEER\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"-L"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_CFGFILES"}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_HTTP_LOG_FMT"}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_HTTPS_LOG_FMT"}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_TCP_LOG_FMT"}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_MWORKER"}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_MASTER_CLI"}),"\n",(0,i.jsx)(e.li,{children:"HAPROXY_STARTUP_VERSION"}),"\n",(0,i.jsxs)(e.li,{children:["\u4F2A\u53D8\u91CF\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:".FILE"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:".LINE"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:".SECTION"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"control-flow",children:"\u63A7\u5236\u6D41"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:".if"}),",",(0,i.jsx)(e.code,{children:".elif"}),",",(0,i.jsx)(e.code,{children:".else"}),",",(0,i.jsx)(e.code,{children:".endif"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u65AD\u8A00\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"defined(<name>)"})}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"feature(<name>)"})," - ",(0,i.jsx)(e.code,{children:"haproxy -vv"})]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"streq(<str1>,<str2>)"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"strneq(<str1>,<str2>)"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"version_atleast(<ver>)"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"version_before(<ver>)"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:'.diag "message"'}),"\n",(0,i.jsx)(e.li,{children:".notice"}),"\n",(0,i.jsx)(e.li,{children:".warning"}),"\n",(0,i.jsx)(e.li,{children:".alert"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"acl",children:"acl"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["named acl\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"acl is_static path -i -m beg /static/"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["in-line acl\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"use_backend be_static if { path -i -m beg /static/ }"})}),"\n",(0,i.jsx)(e.li,{children:"if, unless"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u591A\u4E2A\u6761\u4EF6\u9ED8\u8BA4\u4E3A and \u5173\u7CFB\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"http-request deny if { path -i -m beg /api/ } { src 10.0.0.0/16 }"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u652F\u6301\u903B\u8F91: || or && and !\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"http-request deny if { path -i -m beg /api/ } || !{ src 10.0.0.0/16 }"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["fetch - \u6307\u5339\u914D\u7684\u6765\u6E90\u4FE1\u606F\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4F8B\u5982: src, path, hdr \u7B49"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["converter - \u8F6C\u6362\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4F8B\u5982: lower, upper, base64, field, bytes, map"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"flag - fetch \u64CD\u4F5C\u652F\u6301\u901A\u8FC7 flag \u4FEE\u6539\u884C\u4E3A"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"flag"}),(0,i.jsx)(e.th,{children:"for"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"-i"}),(0,i.jsx)(e.td,{children:"\u5FFD\u7565\u5927\u5C0F\u5199\uFF0C\u5339\u914D\u540E\u7EED\u6240\u6709"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"-f"}),(0,i.jsx)(e.td,{children:"\u5339\u914D\u6587\u4EF6\u5185 patterns"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"-m"}),(0,i.jsx)(e.td,{children:"\u6307\u5B9A\u5339\u914D\u65B9\u5F0F"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"-n"}),(0,i.jsx)(e.td,{children:"\u7981\u6B62 DNS \u89E3\u6790"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"-M"}),(0,i.jsx)(e.td,{children:"load the file pointed by -f like a map file."})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"-u"}),(0,i.jsx)(e.td,{children:"force the unique id of the ACL"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"--"}),(0,i.jsx)(e.td,{children:"force end of flags. Useful when a string looks like one of the flags."})]})]})]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u5339\u914D\u65B9\u6CD5 - -m\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u90E8\u5206 fetch \u6709\u53D8\u79CD ",(0,i.jsx)(e.code,{children:"path_beg"})," -> ",(0,i.jsx)(e.code,{children:"path -m beg"})]}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"-m"}),(0,i.jsx)(e.th,{children:"for"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"str"}),(0,i.jsx)(e.td,{children:"\u5B8C\u6574\u5339\u914D"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"sub"}),(0,i.jsx)(e.td,{children:"\u5305\u542B"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"end"}),(0,i.jsx)(e.td,{children:"\u5F00\u5934"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"beg"}),(0,i.jsx)(e.td,{children:"\u7ED3\u5C3E"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"dir"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"/"})," \u5206\u9694\uFF0C\u8DEF\u5F84\u5339\u914D"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"dom"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"."})," \u5206\u9694\uFF0C\u57DF\u540D\u5339\u914D"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"reg"}),(0,i.jsxs)(e.td,{children:["\u6B63\u5219\u5339\u914D - ",(0,i.jsx)(e.strong,{children:"\u6CE8\u610F\u6027\u80FD\u95EE\u9898"})]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"found"}),(0,i.jsx)(e.td,{children:"\u5B58\u5728"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"len"}),(0,i.jsx)(e.td,{children:"\u957F\u5EA6\u5339\u914D"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"bin"}),(0,i.jsx)(e.td,{children:"\u4E8C\u8FDB\u5236\u6570\u636E\u5339\u914D - Hex"})]})]})]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"dom"}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"hdr_end(host) .wener.me"})," \u4E0D\u4F1A\u5339\u914D ",(0,i.jsx)(e.code,{children:"wener.me"})]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"hdr_end(host) wener.me"})," \u4F1A\u5339\u914D ",(0,i.jsx)(e.code,{children:"xyzwener.me"})]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"hdr_dom(host) wener.me"})," \u4F1A\u5339\u914D ",(0,i.jsx)(e.code,{children:"wener.me"})," \u548C ",(0,i.jsx)(e.code,{children:"*.wener.me"}),", \u4E0D\u4F1A\u5339\u914D ",(0,i.jsx)(e.code,{children:"xyzwener.me"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5927\u591A\u65F6\u5019\u671F\u671B\u7ED3\u679C"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"_beg, _dir, _dom, _end, _len, _reg, _sub"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"method"}),(0,i.jsx)(e.th,{children:"alias"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"base_beg"}),(0,i.jsx)(e.td,{children:"base -m beg"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"hdr_end"}),(0,i.jsx)(e.td,{children:"hdr -m end"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"path_beg"}),(0,i.jsx)(e.td,{children:"path -m beg"})]})]})]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-haproxy",children:"redirect scheme code 301 https if !{ ssl_fc }\n\n# \u52A8\u6001\u540D\u5B57\nuse_backend be_%[path,map_beg(/etc/haproxy/paths.map, mydefault)]\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"%[var()]"})}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"http://wtarreau.blogspot.com/2011/12/elastic-binary-trees-ebtree.html",children:"ebtree"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"balance",children:"balance"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#4.2-balance",children:"balance"})}),"\n",(0,i.jsx)(e.li,{children:"hash - 2.6+"}),"\n",(0,i.jsxs)(e.li,{children:["roundrobin\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u6839\u636E weight \u8F6E\u8BAD - weight \u53EF\u52A8\u6001\u8C03\u6574"}),"\n",(0,i.jsx)(e.li,{children:"\u6700\u591A 4095 server"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["static-rr\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u540C roundrobin \u4F46\u4E0D\u652F\u6301\u8C03\u6574 weight\uFF0C\u4E0D\u9650\u5236 server \u6570\u91CF"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["leastconn\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u9009\u62E9\u6700\u5C11\u8FDE\u63A5\u6570\u7684 server"}),"\n",(0,i.jsx)(e.li,{children:"\u5728 server \u4E2D\u4F7F\u7528 rr \u5C31\u884C\u9009\u62E9 - \u652F\u6301\u52A8\u6001 weight"}),"\n",(0,i.jsx)(e.li,{children:"\u9002\u7528\u4E8E\u957F\u94FE\u63A5 \uFF08\u4F8B\u5982\uFF1ALDAP, SQL, TSE\uFF09 \u4E0D\u9002\u7528\u4E8E\u77ED\u94FE\u63A5 \uFF08\u4F8B\u5982\uFF1A HTTP\uFF09"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["first\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u901A\u8FC7 server id \u987A\u5E8F\u9009\u62E9\u7B2C\u4E00\u4E2A slot - id \u9ED8\u8BA4\u4E3A server \u987A\u5E8F"}),"\n",(0,i.jsx)(e.li,{children:"\u5F53 server \u8FBE\u5230 maxconn \u65F6\u9009\u62E9\u4E0B\u4E00\u4E2A - \u4F7F\u7528\u8BE5\u7B97\u6CD5\u8981\u8BBE\u7F6E\u4E86 maxconn \u624D\u6709\u610F\u4E49"}),"\n",(0,i.jsx)(e.li,{children:"\u8BE5\u7B97\u6CD5\u53EF\u4EE5\u4F7F\u540E\u9762\u7684 server \u6309\u9700\u542F\u52A8 - \u914D\u5408\u57FA\u7840\u8BBE\u65BD\u52A8\u6001\u63A7\u5236\u670D\u52A1\u5668\u8D77\u505C"}),"\n",(0,i.jsx)(e.li,{children:"\u5FFD\u7565 weight\uFF0C\u66F4\u9002\u7528\u4E8E\u957F\u94FE\u63A5"}),"\n",(0,i.jsxs)(e.li,{children:["\u53EF\u4F7F\u7528 ",(0,i.jsx)(e.code,{children:"http-check send-state"})," \u544A\u77E5\u670D\u52A1\u5668\u8D1F\u8F7D"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["source\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u901A\u8FC7 IP hash \u53D6\u6A21\u9009\u62E9 server"}),"\n",(0,i.jsx)(e.li,{children:"\u4FEE\u6539 server \u6570\u91CF\u4F1A\u5F71\u54CD\u9009\u53D6\u7ED3\u679C - server up\u3001down \u4E5F\u4F1A\u5F71\u54CD"}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u9759\u6001 weight \u65E0\u6548\uFF0C\u53EF\u914D\u7F6E hash-type"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["uri\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"URL hash \u53D6\u6A21\u9009\u62E9 server"}),"\n",(0,i.jsxs)(e.li,{children:["URL \u4F7F\u7528\u8DEF\u5F84 ",(0,i.jsx)(e.code,{children:"?"})," \u524D\u9762\u90E8\u5206\uFF0C\u53EF\u6307\u5B9A\u4E3A ",(0,i.jsx)(e.code,{children:"whole"})," \u4F7F\u7528\u6240\u6709"]}),"\n",(0,i.jsx)(e.li,{children:"\u53EF\u589E\u52A0\u7F13\u5B58\u547D\u4E2D\uFF0C\u53EA\u9002\u7528\u4E8E HTTP \u540E\u7AEF"}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u9759\u6001 weight \u65E0\u6548\uFF0C\u53EF\u914D\u7F6E hash-type"}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u6570\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"len - \u622A\u53D6\u957F\u5EA6"}),"\n",(0,i.jsx)(e.li,{children:"depth - \u76EE\u5F55\u6DF1\u5EA6"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["url_param\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4F7F\u7528 HTTP GET \u8BF7\u6C42\u4E0A\u7684 URL \u53C2\u6570"}),"\n",(0,i.jsx)(e.li,{children:"\u672A\u627E\u5230\u53C2\u6570\u5219\u4F7F\u7528 rr"}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u9759\u6001 weight \u65E0\u6548\uFF0C\u53EF\u914D\u7F6E hash-type"}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u6570\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"check_post - \u9488\u5BF9 POST \u4E5F\u68C0\u6D4B"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"hdr(<name>)"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u4F7F\u7528 HTTP \u5934 ",(0,i.jsx)(e.code,{children:"<name>"})," - \u5927\u5C0F\u5199\u4E0D\u654F\u611F\uFF0C\u4E0D\u5B58\u5728\u5219\u4F7F\u7528 rr"]}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u9759\u6001 weight \u65E0\u6548\uFF0C\u53EF\u914D\u7F6E hash-type"}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u6570\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["use_domain_only - HASH \u57DF\u540D\uFF0C\u4E5F\u5C31\u662F ",(0,i.jsx)(e.code,{children:"Host"})," \u5934"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"random"}),", ",(0,i.jsx)(e.code,{children:"random(<draws>)"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u968F\u673A\u6570\uFF0C\u4E00\u81F4\u6027 hash - weight \u52A8\u6001"}),"\n",(0,i.jsx)(e.li,{children:"\u9002\u7528\u4E8E server \u6570\u91CF\u591A\u4E14\u9891\u7E41\u52A0\u51CF\u573A\u666F - \u6BD4 roundrobin \u548C leastconn \u5F71\u54CD\u66F4\u5C0F"}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"<draws>"})," - number of draws before selecting the least loaded of these servers\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4 2"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u6570\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["hash-balance-factor\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u53EF\u589E\u5F3A\u516C\u5E73\u6027"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"http://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf",children:"Power of Two Random Choices"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["rdp-cookie, ",(0,i.jsx)(e.code,{children:"rdp-cookie(<name>)"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["name \u9ED8\u8BA4 ",(0,i.jsx)(e.code,{children:"mstshash"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u9700\u8981 ",(0,i.jsx)(e.code,{children:"tcp-request content accept"})," + ",(0,i.jsx)(e.code,{children:"req_rdp_cookie_cnt"})]}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u9759\u6001 weight \u65E0\u6548\uFF0C\u53EF\u914D\u7F6E hash-type"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"haproxy-\u900F\u660E\u4EE3\u7406traefik",children:"HAProxy \u900F\u660E\u4EE3\u7406+Traefik"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.com/blog/haproxy/proxy-protocol",children:"haproxy/proxy-protocol"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.org/download/2.2/doc/proxy-protocol.txt",children:"proxy-protocol.txt"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://docs.traefik.io/routing/entrypoints/#proxyprotocol",children:"traefik proxy protocol"})}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://stackoverflow.com/a/57503161/1870054",children:"HAProxy tcp mode source client ip"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://yq.aliyun.com/articles/492367",children:"Haproxy \u5168\u900F\u660E\u4EE3\u7406"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-haproxy",children:"global\n  log /dev/log    local0\n  log /dev/log    local1 notice\n  chroot /var/lib/haproxy\n  # \u5E38\u89C1\u4F4D\u7F6E\n  # /run/haproxy/admin.sock\n  # /var/run/haproxy.sock\n  stats socket /var/lib/haproxy/stats mode 660 level admin\n  # stats socket ipv4@192.168.0.1:9999 level admin\n  stats timeout 30s\n  user haproxy\n  group haproxy\n  daemon\n\ndefaults\n  log global\n  retries 2\n  option  dontlognull\n  timeout connect 10000\n  timeout server 600000\n  timeout client 600000\n\nfrontend https\n  bind 0.0.0.0:443\n  default_backend https\n\nbackend https\n  mode tcp\n  balance roundrobin\n  option tcp-check\n  # traefik \u540E\u7AEF\u4E5F\u652F\u6301 proxy \u534F\u8BAE\n  server traefik 192.168.128.5:9443 check fall 3 rise 2 send-proxy\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"iptables -F\niptables -t mangle -N DIVERT\niptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT\niptables -t mangle -A DIVERT -j MARK --set-mark 222\niptables -t mangle -A DIVERT -j ACCEPT\nip rule add fwmark 222 lookup 100\nip route add local 0.0.0.0/0 dev lo table 100\n\n# \u5141\u8BB8ip\u8F6C\u53D1\necho 1 > /proc/sys/net/ipv4/conf/all/forwarding\n\n# \u8BBE\u7F6E\u677E\u6563\u9006\u5411\u8DEF\u5F84\u8FC7\u6EE4\necho 2 > /proc/sys/net/ipv4/conf/default/rp_filter\necho 2 > /proc/sys/net/ipv4/conf/all/rp_filter\necho 0 > /proc/sys/net/ipv4/conf/enp0s8/rp_filter\n\n# \u5141\u8BB8ICMP\u91CD\u5B9A\u5411\necho 1 > /proc/sys/net/ipv4/conf/all/send_redirects\necho 1 > /proc/sys/net/ipv4/conf/enp0s8/send_redirects\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u4FDD\u7559\u72B6\u6001",children:"\u4FDD\u7559\u72B6\u6001"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4E0D\u4F1A\u4FDD\u7559\u7EDF\u8BA1\u4FE1\u606F"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"global\n  # \u72B6\u6001\u6587\u4EF6\n  server-state-file /var/lib/haproxy/server-state\n  stats socket /var/lib/haproxy/stats\n\ndefaults\n  # \u52A0\u8F7D\u7EDF\u8BA1\n  load-server-state-from-file global\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'# \u4FDD\u7559\u72B6\u6001\necho "show servers state" | socat /var/lib/haproxy/stats stdio > /var/lib/haproxy/server-state\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u4EA4\u4E92\u547D\u4EE4",children:"\u4EA4\u4E92\u547D\u4EE4"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/2.2/management.html#9.3",children:"Unix Socket commands"})}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'# \u811A\u672C\u4E00\u6B21\u6267\u884C\n# socat \u53EF\u80FD\u9700\u8981 sudo\necho "show info;show stat;show table" | socat /var/lib/haproxy/stats stdio\n# \u4EA4\u4E92\u5F0F\nsocat /var/lib/haproxy/stats readline\n# prompt\n'})}),"\n",(0,i.jsx)(e.h2,{id:"sni-proxy",children:"SNI Proxy"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"http://blog.haproxy.com/2012/04/13/enhanced-ssl-load-balancing-with-server-name-indication-sni-tls-extension/",children:"http://blog.haproxy.com/2012/04/13/enhanced-ssl-load-balancing-with-server-name-indication-sni-tls-extension/"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.liip.ch/en/blog/haproxy-selective-tls-termination",children:"HAProxy selective TLS termination"})}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-haproxy",children:"backend bk_ssl\n  mode tcp\n  no option checkcache\n  no option httpclose\n  tcp-request inspect-delay 5s\n  tcp-request content accept if { req.ssl_hello_type 1 }\n  tcp-request content reject\n  use-server server1 if { req.ssl_sni -m beg app1. }\n  server server1 server1:8443 check id 1 weight 0\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-haproxy",children:"backend https\n  option tcplog\n  bind 0.0.0.0:443\n  tcp-request inspect-delay 5s\n  tcp-request content accept if { req_ssl_hello_type 1 }\n\n  use_backend s1 if { req.ssl_sni -i site1.example.com or site1alias.example.com }\n\n  use_backend s2 if { ssl_fc_sni_end s2.example.com }\n"})}),"\n",(0,i.jsx)(e.p,{children:"-m end\nuse_backend apache if { ssl_fc_sni_end domain.com }"}),"\n",(0,i.jsx)(e.p,{children:"hdr(host)\nhdr_end(host) -i .wener.me\nhdr_beg(host) -i .wener.me"}),"\n",(0,i.jsx)(e.h2,{id:"ssl-\u914D\u7F6E",children:"SSL \u914D\u7F6E"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.com/blog/haproxy-ssl-termination/",children:"HAProxy SSL Termination"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://ssl-config.mozilla.org/#server=haproxy",children:"Mozilla SSL Configuration Generator"})}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-haproxy",children:"global\n    ssl-default-bind-options ssl-min-ver TLSv1.2\n\nfrontend www.mysite.com\n    bind 10.0.0.3:80\n    bind 10.0.0.3:443 ssl crt /etc/ssl/certs/mysite.pem ssl-min-ver TLSv1.2\n\n    # HTTP -> HTTPS\n    http-request redirect scheme https unless { ssl_fc }\n    default_backend web_servers\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u53C2\u8003",children:"\u53C2\u8003"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/",children:"HAProxy Documentation Converter"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/2.6/configuration.html#4.1",children:"Proxy keywords matrix"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.com/blog/the-four-essential-sections-of-an-haproxy-configuration/",children:"The Four Essential Sections of an HAProxy Configuration"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/2.2/configuration.html#7.4",children:"Pre-defined ACLs"})}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u5B9E\u9A8C",children:"\u5B9E\u9A8C"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-haproxy",children:"global\n  log stdout format raw local0\n  log stdout format raw daemon debug\n\ndefaults\n  log global\n  option httplog\n  timeout client 300s\n  timeout server 300s\n  timeout connect 5s\n\n  mode http\n\nfrontend f1\n  bind 0.0.0.0:8088\n\n  use_backend http:b1 if { hdr_dom(host) -i wener.me }\n\nbackend http:b1\n  mode http\n\nbackend tcp:b1\n  mode tcp\n\nlisten stats\n  bind :8084\n  mode http\n\n  http-request use-service prometheus-exporter if { path /metrics }\n\n  stats enable\n  stats hide-version\n  stats uri /\n  stats refresh 5s\n  stats realm Haproxy\\ Statistics\n  # stats auth Username:Password\n\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"haproxy -c -f haproxy.cfg # Check\nhaproxy -f haproxy.cfg    # Run\n# stats http://127.0.0.1:8083\n\n# \u9A8C\u8BC1\u8DEF\u7531\ncurl -H 'Host: wener.me' 127.0.0.1:8088\n"})}),"\n",(0,i.jsx)(e.h2,{id:"redispatch",children:"redispatch"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"session redistribution in case of connection failure"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"health-check",children:"Health Check"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"agent-check"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"option ldap-check\n# user USER\noption mysql-check\noption pgsql-check\noption redis-check\n\noption smtpchk\n# [HELO|EHLO] [<domain>]\noption smtpchk EHLO mydomain.com\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5982\u679C\u8BBE\u7F6E\u4E86\u5BC6\u7801\uFF0C PING \u4E5F\u9700\u8981\u5BC6\u7801"}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/service-reliability/health-checking/active-checks/",children:"https://www.haproxy.com/documentation/hapee/latest/service-reliability/health-checking/active-checks/"})}),"\n"]})]})}function a(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}},917776:function(n,e,s){s.d(e,{R:()=>c,x:()=>t});var r=s(7378);let i={},l=r.createContext(i);function c(n){let e=r.useContext(l);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),r.createElement(l.Provider,{value:e},n.children)}}}]);