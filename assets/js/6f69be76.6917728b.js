"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["53493"],{2319:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>t,toc:()=>o,default:()=>k,metadata:()=>r,assets:()=>a,contentTitle:()=>c});var r=JSON.parse('{"id":"devops/kubernetes/distro/k0s/README","title":"k0s","description":"- [k0s] \u662F\u4EC0\u4E48\uFF1F","source":"@site/../notes/devops/kubernetes/distro/k0s/README.md","sourceDirName":"devops/kubernetes/distro/k0s","slug":"/devops/kubernetes/distro/k0s/","permalink":"/notes/devops/kubernetes/distro/k0s/","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/distro/k0s/README.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1758158840000,"frontMatter":{"title":"k0s"},"sidebar":"docs","previous":{"title":"autok3s","permalink":"/notes/devops/kubernetes/distro/autok3s"},"next":{"title":"K0S FAQ","permalink":"/notes/devops/kubernetes/distro/k0s/faq"}}'),i=s(86106),l=s(17776);let t={title:"k0s"},c="k0s",a={},o=[{value:"\u5B89\u88C5",id:"\u5B89\u88C5",level:2},{value:"File structure",id:"file-structure",level:2},{value:"k0s supervisor",id:"k0s-supervisor",level:2},{value:"k0s.yaml",id:"k0syaml",level:2},{value:"containerd.toml",id:"containerdtoml",level:2},{value:"helm crd",id:"helm-crd",level:2},{value:"openrc",id:"openrc",level:2},{value:"\u73AF\u5883\u76D1\u6D4B",id:"\u73AF\u5883\u76D1\u6D4B",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"k0s",children:"k0s"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/k0sproject/k0s",children:"k0s"})," \u662F\u4EC0\u4E48\uFF1F\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u7C7B\u4F3C k3s \u7684\u7CBE\u7B80 k8s\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u65E0\u7CFB\u7EDF\u4F9D\u8D56 - \u9759\u6001"}),"\n",(0,i.jsx)(n.li,{children:"\u65E0\u5916\u90E8\u4F9D\u8D56"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"\u652F\u6301 amd64 Windows"}),"\n",(0,i.jsx)(n.li,{children:"\u652F\u6301 amd64, arm, arm64"}),"\n",(0,i.jsxs)(n.li,{children:["\u7F51\u7EDC\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["kube-router - \u9ED8\u8BA4\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u8D44\u6E90\u5360\u7528\u66F4\u5C11 - \u6BD4 calico \u5C11 15%"}),"\n",(0,i.jsx)(n.li,{children:"\u4E0D\u652F\u6301 DualStack"}),"\n",(0,i.jsx)(n.li,{children:"\u4E0D\u652F\u6301 Windows"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["calico\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u9ED8\u8BA4 vxlan overlay"}),"\n",(0,i.jsx)(n.li,{children:"\u4E0D\u652F\u6301 armv7"}),"\n",(0,i.jsx)(n.li,{children:"\u652F\u6301 DualStack"}),"\n",(0,i.jsx)(n.li,{children:"\u652F\u6301 Windowss"}),"\n",(0,i.jsx)(n.li,{children:"IPv6 \u4E0D\u652F\u6301 tunnal"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["etcd \u5C42\u4F7F\u7528 k3s \u7684 ",(0,i.jsx)(n.a,{href:"https://github.com/k3s-io/kine",children:"k3s-io/kine"})]}),"\n",(0,i.jsx)(n.li,{children:"\u80CC\u540E\u7531 Mirants \u516C\u53F8\u652F\u6301"}),"\n",(0,i.jsx)(n.li,{children:"bin \u5305\u542B\u4E86 containerd,runc,etcd,xtables-legacy-multi"}),"\n",(0,i.jsx)(n.li,{children:"\u81EA 2020 \u5E74 - \u76F8\u6BD4 k3s \u8981\u5E74\u8F7B\u4E00\u70B9"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u5B89\u88C5",children:"\u5B89\u88C5"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u6570\u636E\u76EE\u5F55 /var/lib/k0s - ",(0,i.jsx)(n.code,{children:"--data-dir"})]}),"\n",(0,i.jsx)(n.li,{children:"/etc/k0s/containerd.toml"}),"\n",(0,i.jsxs)(n.li,{children:["\u786E\u4FDD\u5B58\u5728 /etc/machine-id\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5B89\u88C5 dbus \u4F1A\u521B\u5EFA"}),"\n",(0,i.jsx)(n.li,{children:"alpine openrc \u76EE\u524D\u65B0\u589E\u4E86 /etc/init.d/machine-id \u670D\u52A1"}),"\n",(0,i.jsxs)(n.li,{children:["denisbrodbeck/machineid ",(0,i.jsx)(n.a,{href:"https://github.com/denisbrodbeck/machineid/blob/v1.0.1/README.md#what-you-get",children:"What you get"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# K0S_VERSION \u63A7\u5236\u7248\u672C\n# DEBUG \u5F00\u542F set -x\n# \u4ECE https://github.com/k0sproject/k0s \u4E0B\u8F7D\u5230 /usr/local/bin/k0s\n# chmod 755 /usr/local/bin/k0s\n# \u7248\u672C\u53F7\u6765\u81EA https://docs.k0sproject.io/stable.txt\ncurl -sSLf https://get.k0s.sh | sudo sh\n\n# \u547D\u4EE4\u8865\u5168\nsource <(k0s completion bash)\n# \u67E5\u770B\u7CFB\u7EDF\u4FE1\u606F\nk0s sysinfo\n# \u751F\u6210\u914D\u7F6E\nmkdir -p /etc/k0s\nk0s config create > /etc/k0s/k0s.yaml\nk0s config validate --config /etc/k0s/k0s.yaml\n\n# AlpineLinux \u63A8\u8350\u4F9D\u8D56\n# \u5B98\u65B9\u8BF4\u4E0D\u9700\u8981\u4F9D\u8D56 - \u4F46\u8FD8\u662F\u5EFA\u8BAE\u5B89\u88C5\u8FD9\u4E9B\u57FA\u7840\u5DE5\u5177\napk add conntrack-tools coreutils dbus findutils ipvsadm ipset iptables socat iproute2 nfs-utils\n\n# \u521B\u5EFA /etc/init.d/k0scontroller\n# \u7528\u6237 etcd kube-apiserver konnectivity-server kube-apiserver kube-scheduler\n# \u53EF\u4FEE\u6539 kublete \u53C2\u6570 - \u9ED8\u8BA4 k0s \u4F1A\u7528\u5230 k8s.gcr.io \u955C\u50CF - \u4F1A\u4E0B\u8F7D\u5931\u8D25\nk0s install controller --enable-worker -c /etc/k0s/k0s.yaml --kubelet-extra-args='--pod-infra-container-image=registry.cn-hongkong.aliyuncs.com/cmi/pause:3.5'\nid etcd kube-apiserver konnectivity-server kube-apiserver kube-scheduler\n\nk0s start\n\nk0s kubectl get nodes\nk0s kc -n kube-system get pods\n\n# \u670D\u52A1\u7BA1\u7406\n# k0s install|start|stop|reset|status\n# \u8FD0\u7EF4\n# k0s backup|restore\n# Daemon\n# k0s api|controller|worker\n# CLI\n# k0s ctr|kubectl|etcd\n\n# \u624B\u52A8\u524D\u53F0\u542F\u52A8 - \u65B9\u4FBF\u6392\u67E5\u95EE\u9898\nk0s controller --config=/etc/k0s/k0s.yaml --enable-worker=true\n\ncontainerd config default > /etc/k0s/containerd.toml\n\n# airegap\n# ==========\n# $K0S_DATA_DIR/images\n# /var/lib/k0s/images/bundle_file\n# \u7528\u5230\u7684\u955C\u50CF\nk0s airgap list-images\n# \u53EF\u76F4\u63A5\u4E0B\u8F7D\n# https://github.com/k0sproject/k0s/releases/download/v1.23.3%2Bk0s.1/k0s-airgap-bundle-v1.23.3+k0s.1-amd64\ncurl -LOC- 'https://echo.wener.cc/https://github.com/k0sproject/k0s/releases/download/v1.23.3%2Bk0s.1/k0s-airgap-bundle-v1.23.3+k0s.1-amd64'\nmkdir -p /var/lib/k0s/images\ncp k0s-airgap-bundle-v1.23.3+k0s.1-amd64 /var/lib/k0s/images/bundle_file\n\n# backup\n# ==========\n# k0s_backup_<ISODatetimeString>.tar.gz\n# --save-path k0s-data\n# \u4F1A\u5907\u4EFD\u8F83\u591A\u5185\u5BB9\nk0s backup\n# k0s restore\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: k0s.k0sproject.io/v1beta1\nkind: ClusterConfig\nmetadata:\n  name: k0s\nspec:\n  images:\n    # airgap \u65F6\u907F\u514D pull\n    default_pull_policy: Never\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",metastring:'title="worker"',children:"# \u5728 server \u6267\u884C\n# base64-encoded kubeconfig\n# k0s token create --role=worker --expiry=24h > worker-token\n# \u52A0 controller \u540C\u7406\n# k0s token create --role=controller --expiry=1h > controller-token\n\nk0s install worker --token-file /etc/k0s/worker-token --kubelet-extra-args='--pod-infra-container-image=registry.cn-hongkong.aliyuncs.com/cmi/pause:3.5'\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# containerd\nk0s ctr --address /run/k0s/containerd.sock\n\nk0s ctr i ls\nk0s ctr c ls\n"})}),"\n",(0,i.jsx)(n.h2,{id:"file-structure",children:"File structure"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["/var/lib/k0s/\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"kubelet.conf"}),"\n",(0,i.jsx)(n.li,{children:"kubelet-config.yaml"}),"\n",(0,i.jsxs)(n.li,{children:["kubelet-bootstrap.conf\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u542F\u52A8 \u914D\u7F6E"}),"\n",(0,i.jsx)(n.li,{children:"\u5982\u679C worker token \u8D85\u65F6\u53EF\u5C1D\u8BD5\u5220\u9664\uFF0C\u91CD\u542F\u91CD\u65B0\u521B\u5EFA"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["/var/lib/k0s/bin/\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["xtables-legacy-multi\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ip6tables, ip6tables-restore, ip6tables-save"}),"\n",(0,i.jsx)(n.li,{children:"iptables-restore, iptables-save"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"containerd, containerd-shim, containerd-shim-runc-v1, containerd-shim-runc-v2"}),"\n",(0,i.jsx)(n.li,{children:"etcd"}),"\n",(0,i.jsx)(n.li,{children:"runc"}),"\n",(0,i.jsx)(n.li,{children:"kube-apiserver, kube-controller-manager, kube-scheduler, kubelet"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"/var/lib/k0s/db/ - kine SQLite"}),"\n",(0,i.jsx)(n.li,{children:"/var/lib/k0s/etcd/ - etcd \u6570\u636E\u76EE\u5F55"}),"\n",(0,i.jsx)(n.li,{children:"/var/lib/k0s/images/bundle_file - \u79BB\u7EBF images \u5305"}),"\n",(0,i.jsxs)(n.li,{children:["/var/lib/k0s/pki/ - \u5404\u79CD\u8BC1\u4E66\u76F8\u5173\u5185\u5BB9\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"admin.conf - kubeconfig"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"/var/lib/k0s/containerd/ - containerd \u6570\u636E\u76EE\u5F55"}),"\n",(0,i.jsxs)(n.li,{children:["/var/lib/k0s/helmhome/ - HELM \u6570\u636E\u76EE\u5F55\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["repositories.yaml\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["openebs-internal -> ",(0,i.jsx)(n.a,{href:"https://openebs.github.io/charts",children:"https://openebs.github.io/charts"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"k0s \u90E8\u7F72\u65F6\u662F\u4F7F\u7528\u7684\u8FD9\u91CC\u7684 repo"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["/var/lib/k0s/manifests/ - \u542F\u52A8\u90E8\u7F72\u5185\u5BB9\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"api-config"}),"\n",(0,i.jsx)(n.li,{children:"calico"}),"\n",(0,i.jsx)(n.li,{children:"coredns"}),"\n",(0,i.jsxs)(n.li,{children:["helm\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["helm-crd-helm.k0sproject.io_charts.yaml\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CustomResourceDefinition"}),"\n",(0,i.jsx)(n.li,{children:"helm.k0sproject.io/v1beta1/Chart"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["addon_crd_manifest_openebs.yaml\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"OpenEBS"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["kubeproxy\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["kube-proxy.yaml\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"KubeProxyConfiguration"}),"\n",(0,i.jsx)(n.li,{children:"/run/xtables.lock"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["metricserver\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"metric_server.yaml"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["bootstraprbac\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ClusterRoleBinding"}),"\n",(0,i.jsx)(n.li,{children:"kubelet-bootstrap, node-autoapprove-bootstrap, node-autoapprove-certificate-rotation"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"calico_init"}),"\n",(0,i.jsxs)(n.li,{children:["defaultpsp\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["default-psp.yaml\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"00-k0s-privileged"}),"\n",(0,i.jsx)(n.li,{children:"99-k0s-restricted"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["kubelet\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"kubelet-config.yaml"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["kuberouter\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"kube-router.yaml"}),"\n",(0,i.jsx)(n.li,{children:"/etc/cni/net.d/10-kuberouter.conflist"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["/var/log/pods/\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Pod \u65E5\u5FD7\u76EE\u5F55"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"/var/lib/cni/ - CNI \u5DE5\u4F5C\u7A7A\u95F4"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"port"}),(0,i.jsx)(n.th,{children:"type"}),(0,i.jsx)(n.th,{children:"component"}),(0,i.jsx)(n.th,{children:"note"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"179"}),(0,i.jsx)(n.td,{children:"tcp"}),(0,i.jsx)(n.td,{children:"kube-router"}),(0,i.jsx)(n.td,{children:"worker <-> worker - BGP"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"2379"}),(0,i.jsx)(n.td,{}),(0,i.jsx)(n.td,{children:"kine"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"2380"}),(0,i.jsx)(n.td,{children:"tcp"}),(0,i.jsx)(n.td,{children:"etcd peers"}),(0,i.jsx)(n.td,{children:"controller <-> controller"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"4789"}),(0,i.jsx)(n.td,{children:"udp"}),(0,i.jsx)(n.td,{children:"calico"}),(0,i.jsx)(n.td,{children:"worker <-> worker - VXLAN overlay"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"6443"}),(0,i.jsx)(n.td,{children:"https"}),(0,i.jsx)(n.td,{children:"kube-apiserver"}),(0,i.jsx)(n.td,{children:"worker,cli->controller"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"8132"}),(0,i.jsx)(n.td,{children:"tcp"}),(0,i.jsx)(n.td,{children:"konnectivity agent"}),(0,i.jsx)(n.td,{children:"worker <-> controller"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"8133"}),(0,i.jsx)(n.td,{children:"tcp"}),(0,i.jsx)(n.td,{children:"konnectivity admin"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"9443"}),(0,i.jsx)(n.td,{children:"tcp"}),(0,i.jsx)(n.td,{children:"k0s-api"}),(0,i.jsx)(n.td,{children:"controller <-> controller"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"10250"}),(0,i.jsx)(n.td,{children:"tcp"}),(0,i.jsx)(n.td,{children:"kubelet"}),(0,i.jsx)(n.td,{children:"master,worker => host"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"k0s-supervisor",children:"k0s supervisor"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["k0s \u662F\u4E00\u4E2A supervisor\uFF0C\u53D6\u4FDD\u7EC4\u4EF6\u59CB\u7EC8\u8FD0\u884C\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"k0s api"}),"\n",(0,i.jsx)(n.li,{children:"containerd"}),"\n",(0,i.jsxs)(n.li,{children:["konnectivity-server\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5982\u679C\u6CA1\u6709 LB \u4E14\u5728\u5E73\u5766\u7F51\u7EDC\uFF0C\u5219\u53EF\u4EE5\u7981\u7528\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/k0sproject/k0s/issues/1352#issuecomment-994350579",children:"https://github.com/k0sproject/k0s/issues/1352#issuecomment-994350579"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"\u62C6\u5206 controller \u548C worker \u65F6\u5219\u5FC5\u987B\u9700\u8981 LB"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"etcd"}),"\n",(0,i.jsx)(n.li,{children:"kube-controller-manager"}),"\n",(0,i.jsx)(n.li,{children:"kube-scheduler"}),"\n",(0,i.jsx)(n.li,{children:"kube-apiserver"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["k0s \u9ED8\u8BA4\u90E8\u7F72\u4E86\u90E8\u5206\u7EC4\u4EF6\uFF0C\u786E\u4FDD\u96C6\u7FA4\u53EF\u7528 - manifest\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"coredns"}),"\n",(0,i.jsx)(n.li,{children:"konnectivity-agent"}),"\n",(0,i.jsx)(n.li,{children:"kube-proxy"}),"\n",(0,i.jsx)(n.li,{children:"kube-router"}),"\n",(0,i.jsx)(n.li,{children:"metrics-server"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# k0s controller \u81EA\u8EAB\n/usr/local/bin/k0s controller --config=/etc/k0s/k0s.yaml --enable-worker=true\n\n# \u67E5\u770B supervisor \u7EF4\u62A4\u7684\u6240\u6709\u8FDB\u7A0B\nps -o command -f $(pgrep -P $(k0s status | grep 'Process ID' | cut -d ':' -f 2)) | tee\n\n/usr/local/bin/k0s api \\\n  --config=/etc/k0s/k0s.yaml \\\n  --data-dir=/var/lib/k0s\n\n/var/lib/k0s/bin/containerd \\\n  --root=/var/lib/k0s/containerd \\\n  --state=/run/k0s/containerd \\\n  --address=/run/k0s/containerd.sock \\\n  --log-level=info \\\n  --config=/etc/k0s/containerd.toml\n\n# controller & worker \u901A\u8BAF\n/var/lib/k0s/bin/konnectivity-server \\\n  --admin-port=8133 \\\n  --agent-namespace=kube-system \\\n  --agent-port=8132 \\\n  --agent-service-account=konnectivity-agent \\\n  --authentication-audience=system:konnectivity-server \\\n  --cluster-cert=/var/lib/k0s/pki/server.crt \\\n  --cluster-key=/var/lib/k0s/pki/server.key \\\n  --enable-profiling=false \\\n  --kubeconfig=/var/lib/k0s/pki/konnectivity.conf \\\n  --logtostderr=true \\\n  --mode=grpc \\\n  --server-count=1 \\\n  --server-id=$(sha256sum XXX) \\\n  --server-port=0 \\\n  --stderrthreshold=1 \\\n  --uds-name=/run/k0s/konnectivity-server/konnectivity-server.sock \\\n  --v=1\n\n# \u771F\u6B63\u7684 controller\n/var/lib/k0s/bin/kube-controller-manager \\\n  --allocate-node-cidrs=true \\\n  --authentication-kubeconfig=/var/lib/k0s/pki/ccm.conf \\\n  --authorization-kubeconfig=/var/lib/k0s/pki/ccm.conf \\\n  --bind-address=127.0.0.1 \\\n  --client-ca-file=/var/lib/k0s/pki/ca.crt \\\n  --cluster-cidr=10.244.0.0/16 \\\n  --cluster-name=k0s \\\n  --cluster-signing-cert-file=/var/lib/k0s/pki/ca.crt \\\n  --cluster-signing-key-file=/var/lib/k0s/pki/ca.key \\\n  --controllers=*,bootstrapsigner,tokencleaner \\\n  --enable-hostpath-provisioner=true \\\n  --kubeconfig=/var/lib/k0s/pki/ccm.conf \\\n  --leader-elect=false \\\n  --node-cidr-mask-size=24 \\\n  --profiling=false \\\n  --requestheader-client-ca-file=/var/lib/k0s/pki/front-proxy-ca.crt \\\n  --root-ca-file=/var/lib/k0s/pki/ca.crt \\\n  --service-account-private-key-file=/var/lib/k0s/pki/sa.key \\\n  --service-cluster-ip-range=10.96.0.0/12 \\\n  --terminated-pod-gc-threshold=12500 \\\n  --use-service-account-credentials=true \\\n  --v=1\n\n# workload \u8C03\u5EA6\n/var/lib/k0s/bin/kube-scheduler \\\n  --authentication-kubeconfig=/var/lib/k0s/pki/scheduler.conf \\\n  --authorization-kubeconfig=/var/lib/k0s/pki/scheduler.conf \\\n  --bind-address=127.0.0.1 \\\n  --kubeconfig=/var/lib/k0s/pki/scheduler.conf \\\n  --leader-elect=false \\\n  --profiling=false \\\n  --v=1\n\n# etcd - \u5982\u679C\u4F7F\u7528\u7684\u662F kine \u5219\u6CA1\u6709\n/var/lib/k0s/bin/etcd \\\n  --advertise-client-urls=https://127.0.0.1:2379 \\\n  --auth-token=jwt,pub-key=/var/lib/k0s/pki/etcd/jwt.pub,priv-key=/var/lib/k0s/pki/etcd/jwt.key,sign-method=RS512,ttl=10m \\\n  --cert-file=/var/lib/k0s/pki/etcd/server.crt \\\n  --client-cert-auth=true \\\n  --data-dir=/var/lib/k0s/etcd \\\n  --enable-pprof=false \\\n  --initial-advertise-peer-urls=https://192.168.1.2:2380 \\\n  --key-file=/var/lib/k0s/pki/etcd/server.key \\\n  --listen-client-urls=https://127.0.0.1:2379 \\\n  --listen-peer-urls=https://192.168.1.2:2380 \\\n  --log-level=info \\\n  --name=$(hostname) \\\n  --peer-cert-file=/var/lib/k0s/pki/etcd/peer.crt \\\n  --peer-client-cert-auth=true \\\n  --peer-key-file=/var/lib/k0s/pki/etcd/peer.key \\\n  --peer-trusted-ca-file=/var/lib/k0s/pki/etcd/ca.crt \\\n  --trusted-ca-file=/var/lib/k0s/pki/etcd/ca.crt\n\n# k8s API - \u4E3B\u8981\u63A5\u53E3\n/var/lib/k0s/bin/kube-apiserver \\\n  --allow-privileged=true \\\n  --anonymous-auth=false \\\n  --api-audiences=https://kubernetes.default.svc,system:konnectivity-server \\\n  --authorization-mode=Node,RBAC --service-account-key-file=/var/lib/k0s/pki/sa.pub --tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 \\\n  --client-ca-file=/var/lib/k0s/pki/ca.crt --tls-cert-file=/var/lib/k0s/pki/server.crt \\\n  --egress-selector-config-file=/var/lib/k0s/konnectivity.conf \\\n  --enable-admission-plugins=NodeRestriction,PodSecurityPolicy \\\n  --enable-bootstrap-token-auth=true --advertise-address=192.168.1.2 \\\n  --feature-gates=ServiceInternalTrafficPolicy=true \\\n  --insecure-port=0 \\\n  --kubelet-certificate-authority=/var/lib/k0s/pki/ca.crt \\\n  --kubelet-client-certificate=/var/lib/k0s/pki/apiserver-kubelet-client.crt \\\n  --kubelet-client-key=/var/lib/k0s/pki/apiserver-kubelet-client.key \\\n  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\n  --profiling=false \\\n  --proxy-client-cert-file=/var/lib/k0s/pki/front-proxy-client.crt \\\n  --proxy-client-key-file=/var/lib/k0s/pki/front-proxy-client.key \\\n  --requestheader-allowed-names=front-proxy-client \\\n  --requestheader-extra-headers-prefix=X-Remote-Extra- \\\n  --requestheader-group-headers=X-Remote-Group \\\n  --requestheader-username-headers=X-Remote-User \\\n  --secure-port=6443 \\\n  --service-account-issuer=https://kubernetes.default.svc \\\n  --service-account-jwks-uri=https://kubernetes.default.svc/openid/v1/jwks \\\n  --service-account-signing-key-file=/var/lib/k0s/pki/sa.key --requestheader-client-ca-file=/var/lib/k0s/pki/front-proxy-ca.crt \\\n  --service-cluster-ip-range=10.96.0.0/12 \\\n  --tls-private-key-file=/var/lib/k0s/pki/server.key \\\n  --v=1 \\\n  --etcd-servers=https://127.0.0.1:2379 \\\n  --etcd-cafile=/var/lib/k0s/pki/etcd/ca.crt \\\n  --etcd-certfile=/var/lib/k0s/pki/apiserver-etcd-client.crt \\\n  --etcd-keyfile=/var/lib/k0s/pki/apiserver-etcd-client.key\n"})}),"\n",(0,i.jsx)(n.h2,{id:"k0syaml",children:"k0s.yaml"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: k0s.k0sproject.io/v1beta1\nkind: ClusterConfig\nmetadata:\n  creationTimestamp: null\n  # kube-controller-manager --cluster-name\n  name: k0s\nspec:\n  # kube-apiserver\n  # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/\n  api:\n    # LB \u5730\u5740 - \u4F9B woker \u4F7F\u7528\n    externalAddress:\n    address: 192.168.1.2\n    k0sApiPort: 9443\n    port: 6443\n    # \u8BC1\u4E66\u91CC\u7684 SANs\n    sans:\n      - 192.168.1.2\n      - kube.example.com\n    # \u989D\u5916\u7684 kube-apiserver \u53C2\u6570\n    extraArgs:\n    # access to KAS through konnectivity tunnel\n    tunneledNetworkingMode: false\n  storage:\n    # etcd, kine\n    type: etcd\n    etcd:\n      # etcd \u53D1\u73B0\u5730\u5740\n      peerAddress: 192.168.1.2\n    kine:\n      dataSource:\n\n  extensions:\n    # \u8981\u90E8\u7F72\u7684 Helm\n    helm:\n      # \u4ED3\u5E93\u5B9A\u4E49\n      repositories:\n        - name: stable\n          url: https://charts.helm.sh/stable\n      # Chart \u5B9A\u4E49\n      charts:\n        - name: prometheus-stack\n          chartname: prometheus-community/prometheus\n          version: '14.6.1'\n          values: |\n            # YAML values\n          namespace: default\n    # \u5B58\u50A8\u914D\u7F6E\n    storage:\n      # \u5EFA\u8BAE\u81EA\u884C\u90E8\u7F72 openebs \u4E0D\u4F7F\u7528 k0s \u90E8\u7F72\n      # external_storage \u4E0D\u90E8\u7F72\u5B58\u50A8\u76F8\u5173\u670D\u52A1\n      # openebs_local_storage \u90E8\u7F72 openebs\n      type: external_storage\n      # openebs-device, openebs-hostpath\n      # /var/openebs/\n      create_default_storage_class: false\n  images:\n    # \u9ED8\u8BA4 \u4ED3\u5E93 - \u4F1A\u52A0\u5728\u6240\u6709 image \u524D - \u652F\u6301\u5E26 path\n    repository:\n    default_pull_policy: IfNotPresent\n    # \u4E0D\u4FEE\u6539 - \u5EFA\u8BAE\u4F7F\u7528 bundle \u5BFC\u5165\n    # \u9ED8\u8BA4\u7528\u5230\u4E86 k8s.gcr.io \u955C\u50CF - \u65E0\u6CD5\u62C9\u53D6\n  installConfig:\n    # \u7528\u6237 - install \u65F6\u4F1A\u521B\u5EFA\n    users:\n      etcdUser: etcd\n      kineUser: kube-apiserver\n      konnectivityUser: konnectivity-server\n      kubeAPIserverUser: kube-apiserver\n      kubeSchedulerUser: kube-scheduler\n  konnectivity:\n    adminPort: 8133\n    agentPort: 8132\n  network:\n    # calico, kuberouter, custom\n    # \u521D\u59CB\u5316\u540E\u65E0\u6CD5\u4FEE\u6539 - \u53EA\u6709\u91CD\u65B0\u90E8\u7F72\n    provider: kuberouter\n    podCIDR: 10.244.0.0/16\n    serviceCIDR: 10.96.0.0/12\n    calico:\n      # vxlan, ipip\n      mode: vxlan\n      # Always, CrossSubnet, Never\n      # vxlan \u4E0D\u4F7F\u7528\n      overlay: Always\n      vxlanPort: 4789\n      # virtual network ID for VXLAN\n      vxlanVNI: 4096\n      mtu: 0\n      # wireguard-based encryption\n      wireguard: false\n      flexVolumeDriverPath: /usr/libexec/k0s/kubelet-plugins/volume/exec/nodeagent~uds\n      ipAutodetectionMethod:\n    # https://github.com/cloudnativelabs/kube-router/blob/master/docs/user-guide.md\n    kuberouter:\n      autoMTU: true\n      mtu: 0\n      # BGP\n      peerRouterASNs: ''\n      peerRouterIPs: ''\n    dualStack: {}\n    kubeProxy:\n      disabled: false\n      # iptables, ipvs, userspace\n      mode: iptables\n  podSecurityPolicy:\n    # 00-k0s-privileged - \u5BBD\u677E\n    # 99-k0s-restricted - \u4E25\u683C\u9650\u5236\n    defaultPolicy: 00-k0s-privileged\n  # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/\n  controllerManager:\n    extraArgs:\n      # cluster-name: wener-k0s\n  # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/\n  scheduler:\n    extraArgs:\n  # \u533A\u5206\u5B9A\u4E49 worker \u914D\u7F6E\n  workerProfiles:\n    - name: custom-role\n      values:\n        volumePluginDir: /var/libexec/k0s/kubelet-plugins/volume/exec\n  telemetry:\n    # \u9ED8\u8BA4\u5F00\u542F - \u5EFA\u8BAE\u5173\u95ED\n    enabled: false\n"})}),"\n",(0,i.jsx)(n.h2,{id:"containerdtoml",children:"containerd.toml"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md",children:"containerd-config.toml.5"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u53C2\u8003\uFF0C\u7136\u540E\u6309\u9700\u4FEE\u6539 /etc/k0s/containerd.toml\n/var/lib/k0s/bin/containerd config default > containerd.toml\n\n# \u67E5\u770B\u652F\u6301\u7684\u63D2\u4EF6\nk0s ctr plugins ls\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",metastring:'title="k3s \u6267\u884C\u7684 containerd"',children:"/var/lib/k0s/bin/containerd \\\n  --root=/var/lib/k0s/containerd \\\n  --state=/var/lib/k0s/run/containerd \\\n  --address=/var/lib/k0s/run/containerd.sock \\\n  --config=/etc/k0s/containerd.toml\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u4F7F\u7528 ZFS"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"zfs create -o mountpoint=/var/lib/k0s/containerd/io.containerd.snapshotter.v1.zfs main/containerd\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u9ED8\u8BA4\u4E3A overlayfs"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-toml",metastring:'title="/etc/k0s/containerd.toml"',children:'version = 2\n\n[plugins."io.containerd.grpc.v1.cri".containerd]\nsnapshotter = "zfs"\n\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u5E94\u8BE5\u4E3A ok \u800C\u4E0D\u662F skip\nk0s ctr plugins ls | grep zfs\n\n# \u5224\u65AD\u65E7\u7684\u662F\u5426\u8FD8\u5728\u7528\n# \u5982\u679C\u6CA1\u91CD\u542F\u4E4B\u524D\u5BB9\u5668\uFF0C\u65E7\u7684\u4E5F\u8FD8\u8FD8\u5728\u4F7F\u7528\nlsof +D /var/lib/k0s/containerd/io.containerd.snapshotter.v1.overlayfs/\n"})}),"\n",(0,i.jsx)(n.h2,{id:"helm-crd",children:"helm crd"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: helm.k0sproject.io/v1beta1\nkind: Chart\nmetadata:\n  name: k0s-addon-chart-openebs\n  namespace: 'kube-system'\n  finalizers:\n    - helm.k0sproject.io/uninstall-helm-release\nspec:\n  chartName: openebs-internal/openebs\n  values: |\n\n  version: 3.0.3\n  namespace: openebs\n"})}),"\n",(0,i.jsx)(n.h2,{id:"openrc",children:"openrc"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5728 install \u65F6\u751F\u6210"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",metastring:'title="/etc/init.d/k0scontroller"',children:'#!/sbin/openrc-run\nsupervisor=supervise-daemon\nname="k0s controller"\ndescription="k0s - Zero Friction Kubernetes"\ncommand=/usr/local/bin/k0s\ncommand_args="controller --config=/etc/k0s/k0s.yaml --enable-dynamic-config=true --enable-worker=true "\nname=$(basename $(readlink -f $command))\nsupervise_daemon_args="--stdout /var/log/${name}.log --stderr /var/log/${name}.err"\ndepend() {\n  need net\n  use dns\n  after firewall\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u73AF\u5883\u76D1\u6D4B",children:"\u73AF\u5883\u76D1\u6D4B"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# https://github.com/k0sproject/k0s/releases/download/v1.23.7%2Bk0s.0/k0s-v1.23.7+k0s.0-amd64\ncurl -LOC- 'https://echo.wener.cc/https://github.com/k0sproject/k0s/releases/download/v1.23.7%2Bk0s.0/k0s-v1.23.7+k0s.0-amd64'\nchmod +x k0s-v1.23.7+k0s.0-amd64\n./k0s-v1.23.7+k0s.0-amd64 sysinfo\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/k3s-io/k3s/blob/master/contrib/util/check-config.sh",children:"https://github.com/k3s-io/k3s/blob/master/contrib/util/check-config.sh"})}),"\n"]})]})}function k(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},17776:function(e,n,s){s.d(n,{R:()=>t,x:()=>c});var r=s(7378);let i={},l=r.createContext(i);function t(e){let n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);