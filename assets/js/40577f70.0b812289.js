"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["94122"],{22621:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>r,toc:()=>a,default:()=>h,metadata:()=>i,assets:()=>c,contentTitle:()=>d});var i=JSON.parse('{"id":"db/relational/postgresql/citus-version","title":"Citus Version","description":"| version                 | date       |","source":"@site/../notes/db/relational/postgresql/citus-version.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/citus-version","permalink":"/notes/db/relational/postgresql/citus-version","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/citus-version.md","tags":[{"inline":true,"label":"Version","permalink":"/notes/tags/version"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1690351481000,"frontMatter":{"tags":["Version"]},"sidebar":"docs","previous":{"title":"Citus Columnar","permalink":"/notes/db/relational/postgresql/citus-columnar"},"next":{"title":"Citus","permalink":"/notes/db/relational/postgresql/citus"}}'),t=s(86106),l=s(17776);let r={tags:["Version"]},d="Citus Version",c={},a=[{value:"Citus v12",id:"citus-v12",level:2},{value:"Citus v11",id:"citus-v11",level:2},{value:"Citus v10",id:"citus-v10",level:2}];function o(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"citus-version",children:"Citus Version"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"version"}),(0,t.jsx)(e.th,{children:"date"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.a,{href:"#citus-v11",children:"Citus v11"})}),(0,t.jsx)(e.td,{children:"2022-06-15"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.a,{href:"#citus-v10",children:"Citus v10"})}),(0,t.jsx)(e.td,{children:"2021-02-16"})]})]})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.citusdata.com/updates/",children:"https://www.citusdata.com/updates/"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"citus-v12",children:"Citus v12"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["schema-based sharding\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"schema=shard"}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.citusdata.com/blog/2023/07/18/citus-12-schema-based-sharding-for-postgres/",children:"https://www.citusdata.com/blog/2023/07/18/citus-12-schema-based-sharding-for-postgres/"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"set citus.enable_schema_based_sharding to on;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"citus-v11",children:"Citus v11"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5F00\u6E90\u6240\u6709\u4F01\u4E1A\u7248\u529F\u80FD\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Citus v10 \u5F00\u6E90\u4E86\u5206\u7247\u5E73\u8861"}),"\n",(0,t.jsx)(e.li,{children:"Citus v11 \u5F00\u6E90\u4E86\u6240\u6709\u5269\u4E0B\u7684\u4F01\u4E1A\u7248\u529F\u80FD"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u4F7F\u7528\u903B\u8F91\u590D\u5236\u7684 Rebalance - \u4E0D\u963B\u585E\u5199"}),"\n",(0,t.jsxs)(e.li,{children:["\u66F4\u5B8C\u5584\u7684\u5143\u6570\u636E\u540C\u6B65 - \u591A\u7528\u6237\u3001RLS - \u96C6\u7FA4\u89D2\u8272\u3001\u6388\u6743\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u56E0\u6B64\u53EF\u4EE5\u76F4\u63A5\u8FDE\u4EFB\u610F\u8282\u70B9\uFF0C\u4E0D\u518D\u9700\u8981\u8FDE coordinator\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u9ED8\u8BA4\u9690\u85CF\u5206\u7247\u8868 - \u907F\u514D\u770B\u8D77\u6765\u5F88\u4E71\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u53EF\u9488\u5BF9\u5173\u95ED ",(0,t.jsx)(e.code,{children:"SET citus.show_shards_for_app_name_prefixes TO 'psql';"})]}),"\n",(0,t.jsxs)(e.li,{children:["\u5168\u90E8\u5173\u95ED ",(0,t.jsx)(e.code,{children:"SET citus.override_table_visibility TO off;"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u79DF\u6237\u9694\u79BB\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u9488\u5BF9\u79DF\u6237\u7684 citus_stat_statements"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u7EC6\u7C92\u5EA6\u63A7\u5236\u8282\u70B9\u95F4\u6388\u6743\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"pg_dist_authinfo"}),"\n",(0,t.jsx)(e.li,{children:"citus.node_conninfo \u652F\u6301 sslkey,sslcert"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5185\u90E8\u94FE\u63A5\u8D70\u5185\u90E8\u94FE\u63A5\u6C60\u8DEF\u7531\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"pg_dist_poolinfo"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["COPY \u907F\u514D\u6821\u9A8C JSON/JSONB - \u63D0\u9AD8\u6570\u636E\u52A0\u8F7D\u6027\u80FD - \u4E4B\u524D\u4F1A\u5BFC\u81F4\u4E24\u6B21\u6821\u9A8C\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u53EF\u5173\u95ED ",(0,t.jsx)(e.code,{children:"SET citus.skip_jsonb_validation_in_copy TO off;"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u96C6\u7FA4\u4FE1\u606F\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"citus_check_cluster_node_health()"}),"\n",(0,t.jsx)(e.li,{children:"citus_backend_gpid() - gpid -> global_pid - \u5168\u5C40\u8BC6\u522B\u6BCF\u4E2A\u4F1A\u8BDD"}),"\n",(0,t.jsx)(e.li,{children:"citus_stat_activity"}),"\n",(0,t.jsx)(e.li,{children:"citus_dist_stat_activity"}),"\n",(0,t.jsx)(e.li,{children:"citus_lock_waits"}),"\n",(0,t.jsx)(e.li,{children:"pg_cancel_backend() \u548C pg_terminate_backend() \u652F\u6301 gpid"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u65B0\u589E helper\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"run_command_on_coordinator"}),"\n",(0,t.jsx)(e.li,{children:"run_command_on_all_nodes"}),"\n",(0,t.jsx)(e.li,{children:"citus_is_coordinator"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["Preview\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["Triggers on distributed tables\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"SET citus.enable_unsafe_triggers TO on;"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- \u5347\u7EA7\nALTER EXTENSION citus\nUPDATE\n;\n\nCALL citus_finish_citus_upgrade();\n\n-- \u591A\u7528\u6237\n-- =======\n-- ALTER|CREATE|DROP ROLE \u4F1A \u540C\u6B65/\u5E7F\u64AD \u5230\u5176\u4ED6\u8282\u70B9\n-- GRANT/REVOKE \u4E5F\u4F1A \u540C\u6B65 \u5230\u5176\u4ED6\u8282\u70B9\n-- \u914D\u7F6E citus.enable_alter_database_owner \u540C\u6B65\u4FEE\u6539 db owner - ALTER DATABASE \u2026 OWNER TO\nCREATE ROLE create_role_test CREATEDB CREATEROLE LOGIN REPLICATION CONNECTION\nLIMIT\n  105 PASSWORD 'type_your_passwd' VALID UNTIL '2045-05-05 00:00:00.00+00';\n\n-- \u56E0\u4E3A\u7528\u6237\u548C\u6743\u9650\u90FD\u540C\u6B65\u4E86\uFF0C\u6240\u4EE5 RLS \u4E5F\u80FD\u751F\u6548\nCREATE POLICY user_mod ON events FOR\nSELECT\n  TO rls_tenant_1 USING (current_user = 'rls_tenant_' | | tenant_id:: text);\n\n-- \u91CD\u65B0\u5E73\u8861\n-- =======\nSELECT\n  rebalance_table_shards();\n\n-- \u5355\u4E2A\u8868\nSELECT\n  rebalance_table_shards('users');\n\n-- \u6CA1\u6709 pk \u6216 replica identity,\n-- \u9002\u7528\u4E8E\u6CA1\u6709\u66F4\u65B0\u548C\u5220\u9664\u7684\u8868 - \u8FC1\u79FB\u5B8C\u6210\u540E\u6062\u590D\nSELECT\n  rebalance_table_shards(\n    'test_table',\n    shard_transfer_mode = > 'force_logical'\n  );\n\n-- \u79DF\u6237\u9694\u79BB\n-- =======\nSELECT\n  isolate_tenant_to_new_shard('table_name', tenant_id);\n\nSELECT\n  isolate_tenant_to_new_shard('orders', 135);\n\n-- CASCADE \u540C\u65F6\u9650\u5B9A co-located \u8868\nSELECT\n  isolate_tenant_to_new_shard('orders', 135, 'CASCADE');\n\n-- \u96C6\u7FA4\u4FE1\u606F\n-- =======\nselect\n  key,\n  citus_backend_gpid()\nFROM\n  distributed_table;\n\nSELECT\n  global_pid,\n  query,\n  state\nFROM\n  citus_stat_activity\nWHERE\n  query ilike 'INSER%'\n  and global_pid != citus_backend_gpid();\n\n-- \u7C7B\u4F3C citus_stat_activity\uFF0C\u4F46\u4E0D\u5305\u542B\u5185\u90E8\u540E\u7AEF\nSELECT\n  global_pid,\n  query,\n  state\nFROM\n  citus_dist_stat_activity\nWHERE\n  query ilike 'INSER%'\n  and global_pid != citus_backend_gpid();\n\nSELECT\n  *\nFROM\n  citus_lock_waits;\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u26A0\uFE0F \u5E9F\u5F03\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Shard placement invalidation"}),"\n",(0,t.jsx)(e.li,{children:"Append-distributed tables - \u63A8\u8350\u4F7F\u7528 hash-distributed tables"}),"\n",(0,t.jsx)(e.li,{children:"\u5206\u5E03\u5F0F cstore_fdw \u8868 - v10 \u5185\u7F6E\u5217\u5B58\u50A8"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.citusdata.com/updates/v11-0/",children:"https://www.citusdata.com/updates/v11-0/"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"citus-v10",children:"Citus v10"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Shard rebalance - \u4F1A\u963B\u585E\u8BFB"}),"\n",(0,t.jsx)(e.li,{children:"\u5185\u7F6E\u5217\u5B58\u50A8 - columner"}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(o,{...n})}):o(n)}},17776:function(n,e,s){s.d(e,{R:()=>r,x:()=>d});var i=s(7378);let t={},l=i.createContext(t);function r(n){let e=i.useContext(l);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:r(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);