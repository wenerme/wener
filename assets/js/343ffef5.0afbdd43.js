"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["380386"],{21245:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>r,toc:()=>o,default:()=>h,metadata:()=>l,assets:()=>a,contentTitle:()=>c});var l=JSON.parse('{"id":"service/forge/gitlab/gitlab-cicd","title":"GitaLab\u6301\u7EED\u96C6\u6210\u6301\u7EED\u4EA4\u4ED8","description":"- .gitlab-ci.yml","source":"@site/../notes/service/forge/gitlab/gitlab-cicd.md","sourceDirName":"service/forge/gitlab","slug":"/service/forge/gitlab/cicd","permalink":"/notes/service/forge/gitlab/cicd","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/forge/gitlab/gitlab-cicd.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1672043702000,"frontMatter":{"title":"GitaLab\u6301\u7EED\u96C6\u6210\u6301\u7EED\u4EA4\u4ED8"},"sidebar":"docs","previous":{"title":"gitlab-ci.yml","permalink":"/notes/service/forge/gitlab/ci-yml"},"next":{"title":"Gitlab CLI","permalink":"/notes/service/forge/gitlab/cli"}}'),s=i(486106),t=i(917776);let r={title:"GitaLab\u6301\u7EED\u96C6\u6210\u6301\u7EED\u4EA4\u4ED8"},c="Gitlab CI/CD",a={},o=[{value:"serverless",id:"serverless",level:2},{value:"echo-js example",id:"echo-js-example",level:3},{value:"gitlabktl",id:"gitlabktl",level:2},{value:"Auto DevOps",id:"auto-devops",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"gitlab-cicd",children:"Gitlab CI/CD"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:".gitlab-ci.yml"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5E94\u7528\u6784\u5EFA\u5B9A\u4E49"}),"\n",(0,s.jsx)(n.li,{children:"K8S Runner \u4E0B\u4F7F\u7528 Kaniko \u6784\u5EFA\u955C\u50CF"}),"\n",(0,s.jsxs)(n.li,{children:["\u4F7F\u7528 ",(0,s.jsx)(n.a,{href:"https://gitlab.com/gitlab-org/gitlabktl",children:"gitlabktl"})," \u90E8\u7F72\u670D\u52A1\u548C\u5E94\u7528\u5230 knative"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"serverless.yml"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u65E0\u670D\u52A1\u51FD\u6570 - \u9700\u8981 Knative"}),"\n",(0,s.jsxs)(n.li,{children:["\u53EF\u7528\u4E8E\u90E8\u7F72 ",(0,s.jsx)(n.em,{children:"\u51FD\u6570"})]}),"\n",(0,s.jsx)(n.li,{children:"\u9ED8\u8BA4\u4F1A\u751F\u6210 Dockerfile"}),"\n",(0,s.jsxs)(n.li,{children:["Gitlab ",(0,s.jsx)(n.a,{href:"https://gitlab.com/gitlab-org/serverless/runtimes",children:"\u8FD0\u884C\u65F6"})," \u652F\u6301 go ruby nodejs Dockerfile"]}),"\n",(0,s.jsx)(n.li,{children:"\u53EF\u4EE5\u4F7F\u7528 OpenFaaS \u7684\u8FD0\u884C\u65F6"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Dockerfile"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u65E0\u670D\u52A1\u5E94\u7528"}),"\n",(0,s.jsx)(n.li,{children:"\u5B9A\u4E49\u5E94\u7528\u6784\u5EFA\u65B9\u5F0F\u3001\u5E94\u7528\u8FD0\u884C\u65F6"}),"\n",(0,s.jsx)(n.li,{children:"\u9ED8\u8BA4\u9700\u8981\u66B4\u9732 8080"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u6CE8\u610F\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6784\u5EFA\u7684\u5E94\u7528\u955C\u50CF\u9700\u8981 PUSH \u5230\u4ED3\u5E93 - \u56E0\u6B64\u9700\u8981\u914D\u7F6E\u4ED3\u5E93\u4FE1\u606F"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://gitlab.com/gitlab-org/gitlab/-/issues/21619",children:"#21619"})," - \u5982\u679C\u955C\u50CF\u4E0D\u662F latest \u6807\u7B7E\u4E0D\u4F1A\u6BCF\u6B21\u62C9"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.gitlab.com/ee/ci/variables",children:"CI \u53D8\u91CF\u8BF4\u660E"})}),"\n",(0,s.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://about.gitlab.com/devops-tools/sonatype-nexus-repo-vs-gitlab.html",children:"Gitlab \u4ED3\u5E93 vs Nexus"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Nexus \u4F1A\u66F4\u597D"}),"\n",(0,s.jsx)(n.li,{children:"Gitlab \u53EA\u6709 Docker \u4ED3\u5E93\u662F\u514D\u8D39\u4F7F\u7528\u7684"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://blog.sonatype.com/how-to-use-gitlab-ci-with-nexus",children:"Gitlab CI \u4E2D\u4F7F\u7528 Nexus"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u53D8\u91CF\u4E0D\u80FD\u5305\u542B\u7F8E\u5143\u7B26 ",(0,s.jsx)(n.code,{children:"$"})," ",(0,s.jsx)(n.a,{href:"https://gitlab.com/gitlab-org/gitlab/-/issues/16442",children:"#16442"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u4F1A\u88AB\u5C55\u5F00 - \u76F4\u63A5\u5199 ",(0,s.jsx)(n.code,{children:"$$"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.h2,{id:"serverless",children:"serverless"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"[knative-examplesknative-examples)"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# \u67E5\u770B\u90E8\u7F72\u7684\u51FD\u6570\u670D\u52A1\nkubectl -n "$KUBE_NAMESPACE" get services.serving.knative.dev\n\n# \u8BF7\u6C42\ncurl \\\n--header "Content-Type: application/json" \\\n--request POST \\\n--data \'{"GitLab":"FaaS"}\' \\\nhttp://functions-echo.functions-1.functions.example.com/\n\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"OpenFaaS \u8FD0\u884C\u65F6"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"hello:\n  source: ./hello\n  runtime: openfaas/classic/ruby\n  description: 'Ruby function using OpenFaaS classic runtime'\n"})}),"\n",(0,s.jsx)(n.h3,{id:"echo-js-example",children:"echo-js example"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:".gitlab.yml"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"include:\n  # \u6A21\u677F\u7EE7\u627F\n  template: Serverless.gitlab-ci.yml\n\nfunctions:build:\n  extends: .serverless:build:functions\n  # \u8BBE\u7F6E\u73AF\u5883\u4FE1\u606F\n  environment: production\n\nfunctions:deploy:\n  extends: .serverless:deploy:functions\n  environment: production\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"serverless.yml"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# \u670D\u52A1\u540D\u5B57\nservice: functions\n# \u670D\u52A1\u63CF\u8FF0\ndescription: 'GitLab Serverless functions using Knative'\n\nprovider:\n  # \u6267\u884C serverless.yml \u7684 provider\n  name: triggermesh\n  # \u73AF\u5883\u53D8\u91CF\n  environment:\n    FOO: value\n\nfunctions:\n  echo-js:\n    # \u51FD\u6570\u540D\u5B57\n    handler: echo-js\n    # \u76EE\u5F55\n    source: ./echo-js\n    # \u8FD0\u884C\u65F6 - \u53EF\u9009 - \u53EF\u4EE5\u5728 source \u4E0B\u5B9A\u4E49 Dockerfile\n    runtime: https://gitlab.com/gitlab-org/serverless/runtimes/nodejs\n    # \u51FD\u6570\u63CF\u8FF0\n    description: 'node.js runtime function'\n    # \u73AF\u5883\u53D8\u91CF\n    environment:\n      MY_FUNCTION: echo-js\n"})}),"\n",(0,s.jsx)(n.h2,{id:"gitlabktl",children:"gitlabktl"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://gitlab.com/gitlab-org/gitlabktl",children:"GitLab Knative tool"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# \u65E0\u6CD5\u76F4\u63A5 build \u53EF\u4EE5\u4F7F\u7528\u955C\u50CF\ndocker pull registry.gitlab.com/gitlab-org/gitlabktl\n# \u4F5C\u4E3A\u547D\u4EE4\u4F7F\u7528\ngitlabktl(){ docker run --rm -it ${OPT} -v $PWD:/host -w /host registry.gitlab.com/gitlab-org/gitlabktl gitlabktl $*;}\n# \u6784\u5EFA\n# \u9700\u8981\u955C\u50CF\u73AF\u5883 CI_REGISTRY CI_REGISTRY_USER CI_REGISTRY_PASSWORD\ngitlabktl serverless build\n# \u4F1A\u5728\u76EE\u5F55\u4E0B\u751F\u6210 Dockerfile\n# \u4F1A\u5F80 registry-internal.wener.me/demo/\u51FD\u6570\u540D \u63A8\u9001\u955C\u50CF\nOPT=\"-e CI_REGISTRY=registry.wener.me -e CI_REGISTRY_USER='' -e CI_REGISTRY_PASSWORD='' -e CI_REGISTRY_IMAGE=registry-internal.wener.me/demo \" gitlabktl serverless build\n# \u8FD0\u884C\u521A\u624D\u63A8\u9001\u7684\u4ED3\u5E93 - \u4F7F\u7528\u7684 functions-echo-js\ndocker run -it --rm -p 8080:8080 registry-internal.wener.me/demo/functions-echo-js\n"})}),"\n",(0,s.jsx)(n.h2,{id:"auto-devops",children:"Auto DevOps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Auto CI/CD \u4F7F\u7528\u7C7B\u4F3C heroku \u7684 buildpack"}),"\n",(0,s.jsxs)(n.li,{children:["\u6784\u5EFA\u5B8C\u6210\u540E\u4F1A\u521B\u5EFA\u955C\u50CF\u5B58\u5165\u4ED3\u5E93 - \u57FA\u7840\u955C\u50CF ",(0,s.jsx)(n.a,{href:"https://github.com/gliderlabs/herokuish",children:"gliderlabs/herokuish"})]}),"\n",(0,s.jsx)(n.li,{children:"\u9ED8\u8BA4\u6709\u4E09\u4E2A\u6B65\u9AA4 build test deploy - \u9ED8\u8BA4 test \u5305\u542B code_quality \u548C test"}),"\n",(0,s.jsxs)(n.li,{children:["code_quality \u4F1A\u4F7F\u7528 ",(0,s.jsx)(n.a,{href:"https://github.com/codeclimate/codeclimate",children:"https://github.com/codeclimate/codeclimate"})]}),"\n",(0,s.jsx)(n.li,{children:"build \u4F7F\u7528\u5171\u4EAB runner - \u4F1A\u6BD4\u8F83\u6162"}),"\n",(0,s.jsx)(n.li,{children:"\u76F8\u8F83\u4E8E\u4E13\u95E8\u9879\u76EE\u7684 deploy - \u4F8B\u5982 now - \u4F1A\u6162\u5F88\u591A\uFF0C 10 \u5206\u949F \u548C 1 \u5206\u949F\u7684\u533A\u522B"}),"\n",(0,s.jsx)(n.li,{children:"\u8BA1\u5212\u652F\u6301 cron - \u53EF\u4EE5\u5F53\u4F5C\u4E00\u4E2A webcron \u6765\u4F7F\u7528"}),"\n",(0,s.jsxs)(n.li,{children:["\u5B9E\u9645\u64CD\u4F5C\u5185\u5BB9\u5B9A\u4E49\u5728 ",(0,s.jsx)(n.a,{href:"https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Auto-DevOps.gitlab-ci.yml",children:"Auto-DevOps.gitlab-ci.yml"})]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},917776:function(e,n,i){i.d(n,{R:()=>r,x:()=>c});var l=i(7378);let s={},t=l.createContext(s);function r(e){let n=l.useContext(t);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),l.createElement(t.Provider,{value:n},e.children)}}}]);