"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["11758"],{94882:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>d,toc:()=>a,default:()=>o,metadata:()=>l,assets:()=>t,contentTitle:()=>c});var l=JSON.parse('{"id":"devops/service/linkerd","title":"Linkerd","description":"- linkerd/linkerd2","source":"@site/../notes/devops/service/linkerd.md","sourceDirName":"devops/service","slug":"/devops/service/linkerd","permalink":"/notes/devops/service/linkerd","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/service/linkerd.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1693122196000,"frontMatter":{"title":"Linkerd"},"sidebar":"docs","previous":{"title":"Linkerd Version","permalink":"/notes/devops/service/linkerd-version"},"next":{"title":"lura","permalink":"/notes/devops/service/lura"}}'),r=i(86106),s=i(17776);let d={title:"Linkerd"},c="Linkerd",t={},a=[{value:"\u5B89\u88C5",id:"\u5B89\u88C5",level:2},{value:"Helm \u5B89\u88C5",id:"helm-\u5B89\u88C5",level:3},{value:"TLS \u8BC1\u4E66\u66F4\u65B0",id:"tls-\u8BC1\u4E66\u66F4\u65B0",level:2},{value:"\u5B9E\u9A8C",id:"\u5B9E\u9A8C",level:2},{value:"Service Profile",id:"service-profile",level:2},{value:"ingress",id:"ingress",level:2},{value:"tracing",id:"tracing",level:2},{value:"\u4EE3\u7406\u914D\u7F6E",id:"\u4EE3\u7406\u914D\u7F6E",level:2},{value:"addons",id:"addons",level:2},{value:"linker1 \u914D\u7F6E",id:"linker1-\u914D\u7F6E",level:2},{value:"\u591A\u96C6\u7FA4",id:"\u591A\u96C6\u7FA4",level:2}];function h(n){let e={a:"a",code:"code",del:"del",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",pre:"pre",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"linkerd",children:"Linkerd"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2",children:"linkerd/linkerd2"})}),"\n",(0,r.jsxs)(e.li,{children:["\u4F18\u52BF\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["linkerd2-proxy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u975E\u5E38\u8F7B\u91CF\u5FEB\u901F"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["top/tap/routes\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5DF2\u7ECF\u5305\u542B\u4E86\u7528\u4E8E\u5FEB\u901F\u8C03\u8BD5\u548C\u68C0\u67E5\u6D41\u91CF\u7684\u529F\u80FD"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"prometheus/grafana - \u5185\u5EFA\u96C6\u6210"}),"\n",(0,r.jsx)(e.li,{children:"mTLS"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u52A3\u52BF\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["linkerd2-proxy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9488\u5BF9\u6027\u5F00\u53D1 - \u529F\u80FD\u76F8\u5BF9\u7B80\u5355"}),"\n",(0,r.jsx)(e.li,{children:"\u4E0D\u80FD\u652F\u6301\u7C7B\u4F3C envoy\u3001nginx \u4E4B\u7C7B\u7684\u534F\u8BAE\u5C42\u57FA\u7840\u529F\u80FD"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u4E0D\u652F\u6301 Circuit Breaker"}),"\n",(0,r.jsx)(e.li,{children:"\u4E0D\u652F\u6301 Auth"}),"\n",(0,r.jsx)(e.li,{children:"CP \u4E0D\u80FD\u7BA1\u7406\u591A\u96C6\u7FA4"}),"\n",(0,r.jsx)(e.li,{children:"\u4E0D\u652F\u6301 Service-to-Service \u6388\u6743"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.del,{children:"\u4E0D\u652F\u6301 Header \u8DEF\u7531"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3165",children:"#3165"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u95EE\u9898\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3403",children:"linkerd/linkerd2#3403"})," - Injected nginx ingress controller doesn't have access to the remote client IP"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/2846",children:"linkerd/linkerd2#2846"})," - Circuit Breaker"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3165",children:"linkerd/linkerd2#3165"})," - Header based routing"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u6CE8\u610F\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"linkerd2 \u76F8\u5BF9\u8F83\u65B0\uFF0C\u529F\u80FD\u4E0A\u53EF\u80FD\u8FD8\u6709\u7F3A\u5931"}),"\n",(0,r.jsxs)(e.li,{children:["Prometheus \u53EF\u80FD\u4F1A\u5360\u7528\u8F83\u591A\u8D44\u6E90\uFF0C\u53EF\u4EE5\u4F7F\u7528\u5916\u90E8\u5B9E\u4F8B - ",(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/2980",children:"#2980"})]}),"\n",(0,r.jsx)(e.li,{children:"ECDSA \u8BC1\u4E66\u9700\u8981 P256"}),"\n",(0,r.jsxs)(e.li,{children:["egress \u652F\u6301\u4E0D\u592A\u597D - \u53EA\u652F\u6301 HTTP\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"TCP \u5916\u90E8\u6D41\u91CF\u65E0\u6CD5\u76D1\u63A7"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3190",children:"#3190"})," - Egress HTTPS Metrics"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/2192",children:"#2192"})," - Monitoring outbound HTTPS external call"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.del,{children:"TCP \u652F\u6301\u4E0D\u597D"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsxs)(e.del,{children:["\u4E0D\u652F\u6301 mTLS ",(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3207",children:"#3207"})]})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsxs)(e.del,{children:["\u4E0D\u652F\u6301 LB \u548C\u8F6C\u53D1 ",(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3445",children:"#3445"})]})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u6CE8\u610F Ingress \u8FDC\u7A0B IP \u95EE\u9898\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3403",children:"#3403"})}),"\n",(0,r.jsxs)(e.li,{children:["\u6DFB\u52A0 annotations - ",(0,r.jsx)(e.code,{children:"config.linkerd.io/skip-inbound-ports: '80,443'"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://linkerd.io/2/reference/architecture/",children:"\u67B6\u6784"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u7EC4\u4EF6\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["cp\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["sp-validator - Service Profile Validator\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"admission controller"}),"\n",(0,r.jsx)(e.li,{children:"\u5F53 service profile \u4FDD\u5B58\u7684\u65F6\u5019\u6821\u9A8C"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"destination"}),"\n",(0,r.jsx)(e.li,{children:"identity - CA, \u63A5\u53D7\u4EE3\u7406\u7684 CSR \u8BF7\u6C42"}),"\n",(0,r.jsx)(e.li,{children:"heartbeat"}),"\n",(0,r.jsx)(e.li,{children:"web"}),"\n",(0,r.jsxs)(e.li,{children:["tap\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u63A5\u53D7 cli \u548C dashboard \u8BF7\u6C42\u76D1\u542C\u4EE3\u7406\u7684\u6D41\u91CF"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["proxy-injector\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"admission controller"}),"\n",(0,r.jsx)(e.li,{children:"\u6DFB\u52A0\u6CE8\u5165\u903B\u8F91\uFF0C\u4F7F\u7528 initContainer \u521D\u59CB\u5316 iptables"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"grafana"}),"\n",(0,r.jsx)(e.li,{children:"prometheus"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["dp\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"proxy - linkerd2-proxy"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-init"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Control Plane\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2",children:"linkerd/linkerd2"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Dataplane\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2-proxy",children:"linkerd/linkerd2-proxy"})}),"\n",(0,r.jsx)(e.li,{children:"\u65E0\u914D\u7F6E\u4EE3\u7406 - iptable \u8F6C\u53D1"}),"\n",(0,r.jsx)(e.li,{children:"/metrics"}),"\n",(0,r.jsx)(e.li,{children:"WebSocket \u4EE3\u7406"}),"\n",(0,r.jsx)(e.li,{children:"\u5EF6\u65F6\u611F\u77E5\u7684 L7 \u8D1F\u8F7D\u5747\u8861"}),"\n",(0,r.jsx)(e.li,{children:"L4 TCP \u8D1F\u8F7D\u5747\u8861"}),"\n",(0,r.jsx)(e.li,{children:"mtls"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"tap"})," \u8BCA\u65AD\u63A5\u53E3 - \u7C7B\u4F3C tcpdump \u6982\u5FF5"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u7279\u6027\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"HTTP, HTTP/2, gRPC"}),"\n",(0,r.jsx)(e.li,{children:"TCP \u4EE3\u7406\u548C\u534F\u8BAE\u68C0\u6D4B"}),"\n",(0,r.jsx)(e.li,{children:"\u8D85\u65F6\u3001\u91CD\u8BD5"}),"\n",(0,r.jsx)(e.li,{children:"mtls"}),"\n",(0,r.jsx)(e.li,{children:"\u4E0D\u63D0\u4F9B Ingress\uFF0C\u4E0E\u73B0\u6709 Ingress \u5171\u5B58"}),"\n",(0,r.jsxs)(e.li,{children:["\u6307\u6807\u76D1\u63A7\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4E3A\u6240\u6709\u6D41\u91CF\u8BB0\u5F55\u6838\u5FC3\u6307\u6807 - request volume, success rate, latency distributions"}),"\n",(0,r.jsx)(e.li,{children:"\u8BB0\u5F55 TCP \u6307\u6807"}),"\n",(0,r.jsx)(e.li,{children:"\u6839\u636E Service Profile \u8BB0\u5F55\u8BF7\u6C42\u3001\u88AB\u8BF7\u6C42\u6307\u6807"}),"\n",(0,r.jsx)(e.li,{children:"\u751F\u6210\u62D3\u6251\u56FE"}),"\n",(0,r.jsx)(e.li,{children:"\u8BF7\u6C42\u91C7\u6837"}),"\n",(0,r.jsxs)(e.li,{children:["\u67E5\u770B\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"linkerd stat"}),", ",(0,r.jsx)(e.code,{children:"linkerd routes"})]}),"\n",(0,r.jsx)(e.li,{children:"dashboard -> Grafana"}),"\n",(0,r.jsxs)(e.li,{children:["\u5185\u5EFA Prometheus \u5B9E\u4F8B\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9ED8\u8BA4\u4FDD\u7559 6 \u5C0F\u65F6"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u8D1F\u8F7D\u5747\u8861 - EWMA \u7B97\u6CD5 - exponentially weighted moving average"}),"\n",(0,r.jsxs)(e.li,{children:["\u81EA\u52A8\u6CE8\u5165 - ",(0,r.jsx)(e.code,{children:"linkerd.io/inject: enabled"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"admission webhook \u5B9E\u73B0"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-init \u914D\u7F6E iptables"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-proxy - dp"}),"\n",(0,r.jsxs)(e.li,{children:["\u6DFB\u52A0 annotation \u540E\u9700\u8981 ",(0,r.jsx)(e.code,{children:"kubectl rollout restart"})]}),"\n",(0,r.jsxs)(e.li,{children:["\u4E3B\u52A8\u7981\u7528 ",(0,r.jsx)(e.code,{children:"linkerd.io/inject: disabled"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["CNI \u63D2\u4EF6\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4F7F\u7528\u4E86\u5219\u4E0D\u9700\u8981 linkerd-init \u914D\u7F6E iptables\uFF0C\u4F1A\u81EA\u52A8\u91CD\u5199"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u96C6\u6210 grafana"}),"\n",(0,r.jsx)(e.li,{children:"\u5206\u5E03\u5F0F\u8DDF\u8E2A"}),"\n",(0,r.jsx)(e.li,{children:"Fault Injection"}),"\n",(0,r.jsxs)(e.li,{children:["ha cp\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"linkerd install --ha --controller-replicas=2"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u8DE8\u96C6\u7FA4\u901A\u4FE1"}),"\n",(0,r.jsxs)(e.li,{children:["Service Profile\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u63D0\u4F9B\u989D\u5916\u63A5\u53E3\u4FE1\u606F"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u6D41\u91CF\u5207\u5206"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"linkerd install"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9ED8\u8BA4\u5B89\u88C5\u5230 linkerd \u7A7A\u95F4"}),"\n",(0,r.jsxs)(e.li,{children:["ClusterRole - ",(0,r.jsx)(e.code,{children:"$NAMESPACE-linkerd-$COMPONENT"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-identity"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-controller"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-destination"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-prometheus"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-proxy-injector"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-sp-validator"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-linkerd-tap"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"linkerd-heartbeat"}),"\n",(0,r.jsx)(e.li,{children:"linkerd-web"}),"\n",(0,r.jsxs)(e.li,{children:["crds\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"serviceprofiles.linkerd.io/v1alpha2"}),"\n",(0,r.jsx)(e.li,{children:"trafficsplits.split.smi-spec.io/v1alpha1"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"secret/linkerd-proxy-injector-tls"}),"\n",(0,r.jsx)(e.li,{children:"secret/linkerd-sp-validator-tls"}),"\n",(0,r.jsx)(e.li,{children:"secret/linkerd-tap-tls"}),"\n",(0,r.jsx)(e.li,{children:"cm/linkerd-config"}),"\n",(0,r.jsx)(e.li,{children:"cm/linkerd-config-addons"}),"\n",(0,r.jsx)(e.li,{children:"deploy/linkerd-identity"}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-controller\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-controller-api"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-destination\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-dst"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["cronjob/linkerd-heartbeat\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"linkerd telemetry"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-web\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-web"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-prometheus\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-prometheus"}),"\n",(0,r.jsx)(e.li,{children:"cm/linkerd-prometheus-config"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-proxy-injector\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-proxy-injector"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-sp-validator\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-sp-validator"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-tap\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-tap"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["deploy/linkerd-grafana\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"svc/linkerd-grafana"}),"\n",(0,r.jsx)(e.li,{children:"cm/linkerd-grafana-config"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.infoq.com/articles/linkerd-v2-production-adoption/",children:"Linkerd v2: How Lessons from Production Adoption Resulted in a Rewrite of the Service Mesh"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["tls\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["secret/linkerd-identity-issuer\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5305\u542B\u4E86 issuer \u8BC1\u4E66"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679C schema \u4E3A kubernetes.io/tls \u5219\u9700\u8981 tls.crt, tls.key, ca.crt"}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679C schema \u4E3A linkerd.io/tls \u5219\u9700\u8981 crt.pem, key.pem"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"secret/linkerd-trust-anchor"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"brew install linkerd\n\nlinkerd version\nlinkerd check --pre\n\nlinkerd install | kubectl apply -f -\n\nlinkerd check\n\nkubectl -n linkerd get deploy\n\nlinkerd dashboard\nlinkerd -n linkerd top deploy/linkerd-web\n\n# \u6CE8\u5165\nkubectl get -n emojivoto deploy -o yaml \\\n  | linkerd inject - \\\n  | kubectl apply -f -\n\n# \u5378\u8F7D\nlinkerd install --ignore-cluster | kubectl delete -f -\n\n\n# \u6CE8\u5165\u7A7A\u95F4\nkubectl get ns monitoring -o yaml | linkerd inject - | kubectl apply -f -\n# \u91CD\u542F\u540E\u5168\u90E8\u751F\u6548\nkubectl rollout restart -n monitoring deployment\nkubectl rollout restart -n monitoring daemonset\nkubectl rollout restart -n monitoring statefulset\n\nkubectl get ns kubernetes-dashboard -o yaml | linkerd inject - | kubectl apply -f -\nkubectl rollout restart -n kubernetes-dashboard deployment\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5B89\u88C5",children:"\u5B89\u88C5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# https://linkerd.io/2/reference/cli/install/\n# --addon-config - \u81EA\u5B9A\u4E49\u914D\u7F6E\n# --controller-replicas=1\n# --disable-heartbeat\n# --registry=gcr.io/linkerd-io \u9ED8\u8BA4\u955C\u50CF\u4ED3\u5E93\n# cmi - https://github.com/wenerme/container-mirror\nlinkerd install --disable-heartbeat --registry registry.cn-hongkong.aliyuncs.com/cmi\n\n# \u6240\u6709\u7684\u955C\u50CF\nlinkerd install | grep 'image: ' | sed -r 's/\\s*image:\\s*(.*)/\\1/' | sort -u\n\nlinkerd install | grep 'image: ' | sed -r 's/\\s*image:\\s*(.*)/\\1/' | sort -u | xargs -n 1 -I {} echo A {} B\n"})}),"\n",(0,r.jsx)(e.h3,{id:"helm-\u5B89\u88C5",children:"Helm \u5B89\u88C5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# \u751F\u6210\u8BC1\u4E66\nbrew install step\n\nstep certificate create identity.linkerd.cluster.local ca.crt ca.key --profile root-ca --no-password --insecure\n\nstep certificate create identity.linkerd.cluster.local issuer.crt issuer.key --ca ca.crt --ca-key ca.key --profile intermediate-ca --not-after 8760h --no-password --insecure\n\n# Helm \u5B89\u88C5\n# https://linkerd.io/2/tasks/install-helm/\n# helm repo add linkerd-edge https://helm.linkerd.io/edge\nhelm repo add linkerd https://helm.linkerd.io/stable\n\n# set expiry date one year from now\n# in Mac:\n# exp=$(date -v+8760H +"%Y-%m-%dT%H:%M:%SZ")\n# in Linux:\n# exp=$(date -d \'+8760 hour\' +"%Y-%m-%dT%H:%M:%SZ")\n\n# \u5982\u679C\u6709 CNI --set global.cniEnabled=true\n# \u9ED8\u8BA4\u5B89\u88C5\u5230 linkerd \u7A7A\u95F4\n# \u81EA\u5DF1\u63D0\u4F9B prometheus\n# https://linkerd.io/2/tasks/external-prometheus/\n# --set global.prometheusUrl: existing-prometheus.xyz:9090\nhelm install linkerd2 \\\n  --set-file global.identityTrustAnchorsPEM=ca.crt \\\n  --set-file identity.issuer.tls.crtPEM=issuer.crt \\\n  --set-file identity.issuer.tls.keyPEM=issuer.key \\\n  --set identity.issuer.crtExpiry=$(date -d \'+8760 hour\' +"%Y-%m-%dT%H:%M:%SZ") \\\n  --set installNamespace=false \\\n  --create-namespace \\\n  linkerd/linkerd2\n'})}),"\n",(0,r.jsx)(e.h2,{id:"tls-\u8BC1\u4E66\u66F4\u65B0",children:"TLS \u8BC1\u4E66\u66F4\u65B0"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://linkerd.io/2/tasks/automatically-rotating-control-plane-tls-credentials/",children:"https://linkerd.io/2/tasks/automatically-rotating-control-plane-tls-credentials/"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u5B9E\u9A8C",children:"\u5B9E\u9A8C"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"cat <<YAML | kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: alpine\n  namespace: default\n  annotations:\n    linkerd.io/inject: enabled\nspec:\n  containers:\n  - name: alpine\n    image: wener/base\n    command:\n    - tail\n    args:\n    - -f\n    - /dev/null\nYAML\n"})}),"\n",(0,r.jsx)(e.h2,{id:"service-profile",children:"Service Profile"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://linkerd.io/2/reference/service-profiles/",children:"https://linkerd.io/2/reference/service-profiles/"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# linkerd \u5185\u90E8\u7684 sp \u5B9A\u4E49\nlinkerd install-sp\n\n# \u6709 sp \u4FE1\u606F\u7684\u4F1A\u9644\u52A0 rt_route \u5230\u6307\u6807\nlinkerd tap -o wide <target> | grep req | grep -v rt_route\n\n\n# \u68C0\u6D4B\u6D41\u91CF\u751F\u6210 profile\nlinkerd profile -n emojivoto web-svc --tap deploy/web --tap-duration 10s\n# \u901A\u8FC7 pb \u751F\u6210\nlinkerd profile --proto web.proto web-svc\n# \u901A\u8FC7 swagger \u751F\u6210\nlinkerd profile --open-api webapp.swagger webapp\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"apiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  name: nginx-demo.default.svc.cluster.local\n  namespace: default\nspec:\n  routes:\n    - name: me.wener.apis.test.PingService#ping\n      condition:\n        method: POST\n        pathRegex: /api/service/me.wener.apis.test.PingService/ping\n      isRetryable: true\n      timeout: 3s\n      responseClasses:\n        - condition:\n            not:\n              status:\n                min: 200\n                max: 399\n          isFailure: true\n    - name: me.wener.apis.test.PingService\n      condition:\n        method: POST\n        pathRegex: /api/service/me.wener.apis.test.PingService/.*\n      isRetryable: false\n  retryBudget:\n    # \u6700\u591A\u6709 20% \u88AB\u91CD\u8BD5\n    retryRatio: 0.2\n    # \u5141\u8BB8\u7684\u6BCF\u79D2\u91CD\u8BD5\u6B21\u6570\n    minRetriesPerSecond: 10\n    # \u8BA1\u7B97 retryRatio \u7684\u65F6\u95F4\u7A97\u53E3\n    ttl: 10s\n"})}),"\n",(0,r.jsx)(e.h2,{id:"ingress",children:"ingress"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6CE8\u610F\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4F1A\u5BFC\u81F4 nginx \u7684\u7C98\u6027\u4F1A\u8BDD\u65E0\u6548"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"# nginx annotation\nnginx.ingress.kubernetes.io/configuration-snippet: |\n  proxy_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n  grpc_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n\n# with auth url\nnginx.ingress.kubernetes.io/auth-url: 'https://$host/oauth2/auth'\nnginx.ingress.kubernetes.io/auth-signin: 'https://$host/oauth2/start?rd=$escaped_request_uri'\nnginx.ingress.kubernetes.io/auth-snippet: |\n  proxy_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n  grpc_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n"})}),"\n",(0,r.jsx)(e.h2,{id:"tracing",children:"tracing"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://linkerd.io/2/tasks/distributed-tracing/",children:"Distributed tracing with Linkerd"})}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://linkerd.io/2019/08/09/service-mesh-distributed-tracing-myths/",children:"Distributed tracing in the service mesh: four myths"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5E76\u4E0D\u9700\u8981\u8DDF\u8E2A \u68C0\u6D4B \u76D1\u63A7\u3001\u5EF6\u65F6\u3001\u541E\u5410"}),"\n",(0,r.jsx)(e.li,{children:"\u5E76\u4E0D\u9700\u8981\u8DDF\u8E2A \u624D\u77E5\u9053\u670D\u52A1\u4E4B\u95F4\u7684\u8C03\u7528\u4F9D\u8D56\u5173\u7CFB"}),"\n",(0,r.jsx)(e.li,{children:"\u60F3\u8981\u77E5\u9053\u65F6\u95F4\u7247\u6BB5\u91CC\u7684\u8C03\u7528\u5173\u7CFB\u5FC5\u987B\u8981\u4FEE\u6539\u4EE3\u7801"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["linkerd \u6709\u7C7B\u4F3C tracing \u7684\u529F\u80FD\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"tap"}),"\n",(0,r.jsx)(e.li,{children:"top"}),"\n",(0,r.jsx)(e.li,{children:"service profile"}),"\n",(0,r.jsx)(e.li,{children:"\u670D\u52A1\u62D3\u6251"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u6CE8\u610F\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Linkerd \u4F7F\u7528 ",(0,r.jsx)(e.a,{href:"https://github.com/openzipkin/b3-propagation",children:"openzipkin/b3-propagation"})," \u683C\u5F0F"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"OpenCensus"})," \u652F\u6301\u73AF\u5883\u53D8\u91CF ",(0,r.jsx)(e.code,{children:"OC_AGENT_HOST=linkerd-collector.linkerd:55678"})]}),"\n",(0,r.jsx)(e.li,{children:"\u5982\u679C\u8981\u4F7F\u7528 Tracing \u5219\u4E00\u5B9A\u8981\u5BF9 Ingress \u4E5F\u5F00\u542F\uFF0C\u56E0\u4E3A Ingress \u4F1A\u521B\u5EFA\u6700\u5F00\u59CB\u7684 Span"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"cat << EOF >> config.yaml\ntracing:\n  enabled: true\nEOF\n# \u90E8\u7F72\n# linker-collector\n# linkerd-jaeger\nlinkerd upgrade --addon-config config.yaml | kubectl apply -f -\n\nkubectl -n linkerd rollout status deploy/linkerd-collector\nkubectl -n linkerd rollout status deploy/linkerd-jaeger\n\n# POD Annotation\n# config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678\n# config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector\n\n# \u8BBE\u7F6E\u73AF\u5883\u53D8\u91CF\u652F\u6301\nkubectl -n emojivoto set env --all deploy OC_AGENT_HOST=linkerd-collector.linkerd:55678\n\nkubectl -n linkerd port-forward svc/linkerd-jaeger 16686\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u4EE3\u7406\u914D\u7F6E",children:"\u4EE3\u7406\u914D\u7F6E"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://linkerd.io/2/reference/proxy-configuration/",children:"Proxy Configuration"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"spec:\n  template:\n    metadata:\n      annotations:\n        config.linkerd.io/proxy-cpu-limit: '1.5'\n        config.linkerd.io/proxy-cpu-request: '0.2'\n        config.linkerd.io/proxy-memory-limit: 2Gi\n        config.linkerd.io/proxy-memory-request: 128Mi\n"})}),"\n",(0,r.jsx)(e.h2,{id:"addons",children:"addons"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://linkerd.io/2/tasks/enabling-addons/",children:"Enabling Add-Ons"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"tracing:\n  enabled: true\n  collector:\n    resources:\n      cpu:\n        limit: 100m\n        request: 10m\n      memory:\n        limit: 100Mi\n        request: 50Mi\n"})}),"\n",(0,r.jsx)(e.h2,{id:"linker1-\u914D\u7F6E",children:"linker1 \u914D\u7F6E"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"dtabs - delegate tables \u2014 a backtracking, hierarchical, suffix-preserving routing language used by Finagle"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://api.linkerd.io/head/linkerd/index.html",children:"https://api.linkerd.io/head/linkerd/index.html"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"# \u540D\u5B57 -> \u5730\u5740\nnamers:\n  # Consul \u670D\u52A1\u53D1\u73B0\n  # /svc => /#/io.l5d.consul/dc1/prod;\n  - kind: io.l5d.consul\n    # \u76F4\u63A5\u8BBF\u95EE\u670D\u52A1 - \u5982\u679C\u8BBF\u95EE agent \u5219\u662F $HOST_IP:8500\n    host: consul-server.consul\n    port: 8500\n    # token:\n    includeTag: true\n    useHealthCheck: false\n    healthStatuses:\n      - 'passing'\n      - 'warning'\n    setHost: true\n    consistencyMode: stale\n    # \u901A\u8FC7 tag \u5173\u8054\u6743\u91CD\n    weights:\n      - tag: experimental\n        weight: 0.1\n      - tag: primary\n        weight: 5.0\n\n  # \u91CD\u5199\n  # /svc => /#/rewrite\n  - kind: io.l5d.rewrite\n    prefix: /rewrite\n    pattern: '/{service}/api'\n    name: '/srv/{service}'\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u591A\u96C6\u7FA4",children:"\u591A\u96C6\u7FA4"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Ingress \u57FA\u4E8E Ambassador"}),"\n"]})]})}function o(n={}){let{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(h,{...n})}):h(n)}},17776:function(n,e,i){i.d(e,{R:()=>d,x:()=>c});var l=i(7378);let r={},s=l.createContext(r);function d(n){let e=l.useContext(s);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:d(n.components),l.createElement(s.Provider,{value:e},n.children)}}}]);