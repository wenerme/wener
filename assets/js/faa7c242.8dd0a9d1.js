"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["20306"],{271920:function(n,e,l){l.r(e),l.d(e,{frontMatter:()=>r,toc:()=>d,default:()=>o,metadata:()=>s,assets:()=>t,contentTitle:()=>c});var s=JSON.parse('{"id":"db/ops/atlas","title":"atlas","description":"- ariga/atlas","source":"@site/../notes/db/ops/atlas.md","sourceDirName":"db/ops","slug":"/db/ops/atlas","permalink":"/notes/db/ops/atlas","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/ops/atlas.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1765727241000,"frontMatter":{"title":"atlas"},"sidebar":"docs","previous":{"title":"Greenplum","permalink":"/notes/db/olap/greenplum"},"next":{"title":"dbcli","permalink":"/notes/db/ops/dbcli"}}'),i=l(486106),a=l(917776);let r={title:"atlas"},c="atlas",t={},d=[{value:"SQL Schema",id:"sql-schema",level:2},{value:"atlas.hcl",id:"atlashcl",level:2},{value:"DSL",id:"dsl",level:2},{value:"avoid diff schema",id:"avoid-diff-schema",level:2},{value:"migrate set version",id:"migrate-set-version",level:2}];function h(n){let e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"atlas",children:"atlas"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/ariga/atlas",children:"ariga/atlas"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Apache-2.0, Go"}),"\n",(0,i.jsx)(e.li,{children:"Schema \u8FC1\u79FB\u5DE5\u5177"}),"\n",(0,i.jsx)(e.li,{children:"\u652F\u6301 SQL, HCL, ORM \u4F5C\u4E3A Schema \u6765\u6E90"}),"\n",(0,i.jsx)(e.li,{children:"\u652F\u6301 PostgresSQL, MySQL, MariaDB, SQLite"}),"\n",(0,i.jsx)(e.li,{children:"\u652F\u6301\u4F5C\u4E3A terraform \u7684 provider"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["dev-url\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4F7F\u7528 SQL schemas \u7684\u65F6\u5019\u9700\u8981\u4E00\u4E2A\u4E34\u65F6\u7684 \u6570\u636E\u5E93"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"atlas_schema_revisions"}),"\n",(0,i.jsxs)(e.li,{children:["\u5DE5\u4F5C\u6D41\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u58F0\u660E\u5DE5\u4F5C\u6D41 - Declarative Workflow\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"atlas schema"})}),"\n",(0,i.jsxs)(e.li,{children:["\u4F18\u70B9\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7B80\u6D01\u9AD8\u6548"}),"\n",(0,i.jsx)(e.li,{children:"\u6613\u4E8E\u5BA1\u67E5\u548C\u7406\u89E3"}),"\n",(0,i.jsx)(e.li,{children:"\u81EA\u52A8\u5316"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7F3A\u70B9\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u63A7\u5236\u529B\u8F83\u5F31"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7248\u672C\u5316\u8FC1\u79FB - Versioned Migration\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"atlas migrate"})}),"\n",(0,i.jsx)(e.li,{children:"\u201C\u57FA\u4E8E\u53D8\u66F4\u7684\u8FC1\u79FB\u201D(Change-based Migrations)"}),"\n",(0,i.jsxs)(e.li,{children:["\u4F18\u70B9\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u660E\u786E\u53EF\u63A7 (Explicit & Controlled)"}),"\n",(0,i.jsx)(e.li,{children:"\u6240\u89C1\u5373\u6240\u5F97"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7F3A\u70B9\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u7F16\u5199\u7E41\u7410\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u96BE\u4EE5\u5BA1\u67E5\u6700\u7EC8\u72B6\u6001"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7248\u672C\u5316\u8FC1\u79FB\u521B\u4F5C (Versioned Migration Authoring)\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"declarative + versioned"}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"atlas migrate diff"})}),"\n",(0,i.jsx)(e.li,{children:"\u751F\u6210\u8FC1\u79FB\u6587\u4EF6"}),"\n",(0,i.jsx)(e.li,{children:"\u9002\u7528\u4E8E\u590D\u6742\u7684\u53D8\u66F4"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://atlasgo.io/concepts/declarative-vs-versioned",children:"https://atlasgo.io/concepts/declarative-vs-versioned"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"HCL"}),"\n"]}),"\n",(0,i.jsx)(e.admonition,{title:"Pro \u529F\u80FD",type:"caution",children:(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u53EA\u6709 \u4ED8\u8D39 Pro \u624D\u80FD\u767B\u9646 $9/\u6708/\u5F00\u53D1\u8005"}),"\n",(0,i.jsxs)(e.li,{children:["Pro \u529F\u80FD - \u514D\u8D39\u7248\u529F\u80FD\u975E\u5E38\u53D7\u9650\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"function"}),"\n",(0,i.jsx)(e.li,{children:"procedure"}),"\n",(0,i.jsx)(e.li,{children:"sequence"}),"\n",(0,i.jsx)(e.li,{children:"trigger"}),"\n",(0,i.jsx)(e.li,{children:"extension"}),"\n",(0,i.jsx)(e.li,{children:"partition"}),"\n",(0,i.jsx)(e.li,{children:"system_versioned tables for SQL Server"}),"\n",(0,i.jsx)(e.li,{children:"view"}),"\n",(0,i.jsx)(e.li,{children:"materialized view"}),"\n",(0,i.jsx)(e.li,{children:"event trigger"}),"\n",(0,i.jsx)(e.li,{children:"domain"}),"\n",(0,i.jsx)(e.li,{children:"Composite Type for PostgreSQL"}),"\n",(0,i.jsx)(e.li,{children:"Range Type for PostgreSQL"}),"\n",(0,i.jsx)(e.li,{children:"row-level security policy for PostgreSQL"}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"server"})," Foreign Servers for PostgreSQL"]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'brew install ariga/tap/atlas # official tap\n# brew install atlas\n# npx @ariga/atlas\n# \u624B\u52A8\u5B89\u88C5\ncurl --create-file-mode 0755 -o atlas -L https://release.ariga.io/atlas/atlas-darwin-arm64-latest\n\n# -s/--schema \u6307\u5B9A\u591A\u4E2A schema, \u6216\u8005 pg search_path \u6307\u5B9A schema, --exclude \u6392\u9664 schema\n# --format \'{{ hcl . | split | write }}\'\n# --format \'{{ hcl . | split "type" ".pg.hcl" | write "schema/" }}\' # \u8F93\u51FA schema/table.pg.hcl schema/schema.pg.hcl\natlas schema inspect -u "sqlite://test.db"             # \u751F\u6210 HCL schema\natlas schema apply -u "sqlite://test.db" -f schema.hcl # \u5E94\u7528\u8FC1\u79FB\natlas serve --storage "sqlite://test.db"               # WebUI\n\n# dev \u73AF\u5883\u7528\u4E8E\u9884\u5148\u9A8C\u8BC1\natlas schema apply --url "sqlite://prod.db" --dev-url "sqlite://prod.db" -f schema.hcl\n\natlas migrate new          # \u751F\u6210 migrations/\u65F6\u95F4\u6233.sql\natlas migrate validate     # \u5BF9\u6BD4 migrations/atlas.sum\natlas migrate hash --force # \u5F3A\u5236\u91CD\u65B0\u751F\u6210 migrations/atlas.sum\n\n# \u751F\u6210 diff SQL \u5230 migrations\n# --to \u76EE\u6807\u72B6\u6001\n# --dir \u73B0\u5728\u72B6\u6001\natlas migrate diff \\\n  --dir "file://migrations" \\\n  --to "file://schema.pg.hcl" \\\n  --dev-url "docker://postgres/17-alpine/dev?search_path=public"\n\n# Versioned Migration Authoring\natlas schema inspect --env local > schema.pg.hcl\natlas migrate diff baseline --env local --format \'{{ sql . "  " }}\'\natlas migrate apply --env local --baseline 00000000000000\natlas migrate status --env local\n\n# \u76F4\u63A5\u4F7F\u7528 SQL \u4F5C\u4E3A Schema\natlas schema inspect -u file://schemas/main.sql --env local --format \'{{ sql . "  " }}\' > migrations/00000000000000_baseline.sql\natlas migrate hash\natlas migrate apply --env local --baseline 00000000000000\n\natlas schema diff \\\n  --to file://schemas/main.sql \\\n  --from file://migrations \\\n  --dev-url "docker://postgres/17/dev"\n\n# \u4FEE\u6539\u4E86 migrations \u9700\u8981\u91CD\u65B0 hash\natlas migrate hash\natlas migrate diff --to \'file://schemas/main.sql\' --dev-url "docker://postgres/17/dev"\n\n# Workflow\n# =======================================================================\n# \u624B\u52A8\u7F16\u8F91 0_base.sql \u6587\u4EF6 - \u56E0\u4E3A atlas \u514D\u8D39\u7248\u672C\u4E0D\u652F\u6301 function, procedure\n# \u751F\u6210 1_baseline.sql \u6587\u4EF6\n# \u6DFB\u52A0 IF NOT EXISTS - \u56E0\u4E3A\u4E0D\u652F\u6301 function, procedure \u6709\u4E9B\u4F9D\u8D56\u987A\u5E8F\u6709\u95EE\u9898\uFF0C\u9700\u8981\u624B\u52A8\u5728 base \u91CC\u6DFB\u52A0\u8868\natlas schema inspect -u file://schemas/main.sql --env local --format \'{{ sql . "  " }}\' > migrations/1_baseline.sql\n# TYPE \u4E0D\u652F\u6301 IF NOT EXISTS\n# DO $$ BEGIN CREATE TYPE ...; EXCEPTION WHEN duplicate_object THEN null; END $$;\nsed -i -E \'s/^(CREATE (TABLE|SCHEMA|(UNIQUE )?INDEX|SEQUENCE)) ([^I].*)/\\1 IF NOT EXISTS \\4/g\' migrations/*.sql\n# \u66F4\u65B0 atlas.sum\natlas migrate hash\n# \u9A8C\u8BC1\u57FA\u4E8E SQL \u7684\u8FC1\u79FB\u53EF\u6267\u884C\natlas migrate diff --to \'file://migrations\' --dev-url "docker://postgres/17/dev"\n\n# \u4FEE\u6539 schema \u540E\u751F\u6210 migration\natlas migrate diff --to \'file://schemas/main.sql\' --dev-url "docker://postgres/17/dev"\n\n# \u9A8C\u8BC1\u57FA\u4E8E Schema \u7684\u8FC1\u79FB\u662F\u5426\u53EF\u6267\u884C\n# \u7531\u4E8E\u4E0D\u652F\u6301 function, procedure \u6240\u4EE5\u53EF\u80FD\u5931\u8D25\natlas schema apply --to \'file://schemas/main.sql\' -u "docker://postgres/17/dev" --dev-url "docker://postgres/17/dev"\n\n# \u67E5\u770B docker \u955C\u50CF\u7684 tag\nregctl tag ls arigaio/mysql\n'})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"docker \u5B98\u65B9\u955C\u50CF\u662F arigaio/ \u4E0B\u7684\u955C\u50CF"}),"\n",(0,i.jsx)(e.li,{children:"docker+mysql://"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",metastring:'title="atlas.hcl"',children:'# atlas migrate hash --env diff\n# atlas migrate diff --env diff\nenv "diff" {\n  src = "file://schema.pg.hcl" # schema \u5B9A\u4E49\n  url = "file://migrations" # \u7BA1\u7406\u7684\u6570\u636E\u5E93\n  dev = "docker://postgres/17-alpine/dev?search_path=public"\n}\n'})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",metastring:'title="schema.hcl"',children:'schema "main" {\n\n}\n\ntable "users" {\n  schema = schema.main\n  column "id" {\n    null = false\n    type = int\n  }\n  column "name" {\n    null = true\n    type = varchar(100)\n  }\n  primary_key {\n    columns = [column.id]\n  }\n}\n\ntable "posts" {\n  schema = schema.main\n  column "id" {\n    null = false\n    type = int\n  }\n  column "title" {\n    null = true\n    type = varchar(100)\n  }\n  column "body" {\n    null = true\n    type = text\n  }\n  column "author_id" {\n    null = true\n    type = int\n  }\n  primary_key {\n    columns = [column.id]\n  }\n  foreign_key "fk_posts_author_id" {\n    columns     = [column.author_id]\n    ref_columns = [table.users.column.id]\n    on_update   = NO_ACTION\n    on_delete   = NO_ACTION\n  }\n  index "idx_posts_author_id" {\n    unique  = false\n    columns = [column.author_id]\n  }\n}\n'})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u652F\u6301\u8BFB\u53D6 .env"}),"\n",(0,i.jsx)(e.li,{children:"\u53EF\u4EE5\u4F7F\u7528 atlas.hcl \u914D\u7F6E"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'variable "envfile" {\n    type    = string\n    default = "/path/to/.env"\n}\n\nlocals {\n    envfile = {\n        for line in split("\\n", file(var.envfile)): split("=", line)[0] => regex("=(.*)", line)[0]\n        if !startswith(line, "#") && length(split("=", line)) > 1\n    }\n}\n\nenv {\n    name = atlas.env\n    url  = local.envfile["DATABASE_URL"]\n}\n'})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:'CREATE TABLE "atlas_schema_revisions"."atlas_schema_revisions" (\n  "version" character varying NOT NULL,\n  "description" character varying NOT NULL,\n  "type" bigint NOT NULL DEFAULT 2,\n  "applied" bigint NOT NULL DEFAULT 0,\n  "total" bigint NOT NULL DEFAULT 0,\n  "executed_at" timestamptz NOT NULL,\n  "execution_time" bigint NOT NULL,\n  "error" text NULL,\n  "error_stmt" text NULL,\n  "hash" character varying NOT NULL,\n  "partial_hashes" jsonb NULL,\n  "operator_version" character varying NOT NULL,\n  PRIMARY KEY ("version")\n);\n'})}),"\n",(0,i.jsx)(e.h2,{id:"sql-schema",children:"SQL Schema"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u6587\u4EF6\u6307\u4EE4\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"atlas:txmode\uFF1A\u63A7\u5236\u8FC1\u79FB\u662F\u5426\u5728\u4E8B\u52A1\u4E2D\u6267\u884C\uFF08\u5982\u5173\u95ED\u4E8B\u52A1\uFF09\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:nolint\uFF1A\u7981\u7528\u6574\u4E2A\u6587\u4EF6\u7684 Lint \u8B66\u544A\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:checkpoint\uFF1A\u5C06\u8BE5\u8FC1\u79FB\u6807\u8BB0\u4E3A\u201C\u68C0\u67E5\u70B9\u201D\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:delimiter\uFF1A\u81EA\u5B9A\u4E49\u8BED\u53E5\u5206\u9694\u7B26\uFF08\u5982 ;;\uFF09\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:txtar\uFF1A\u5728\u5E26\u9884\u68C0\u67E5\u7684\u8FC1\u79FB\u4E2D\u5F15\u5165\u989D\u5916\u68C0\u67E5\u6587\u4EF6\uFF0C\u5148\u6267\u884C\u518D\u8FC1\u79FB\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:assert\uFF1A\u5728\u9884\u68C0\u67E5\u6587\u4EF6\u4E2D\u63A7\u5236\u65AD\u8A00\u884C\u4E3A\uFF1Boneof \u8868\u793A\u81F3\u5C11\u4E00\u4E2A\u65AD\u8A00\u9700\u901A\u8FC7\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:sensitive\uFF1A\u907F\u514D\u5728\u65E5\u5FD7\u4E2D\u8BB0\u5F55\u654F\u611F/PII \u503C\uFF08\u53EF\u4F5C\u7528\u4E8E\u6587\u4EF6\u6216\u5355\u6761\u8BED\u53E5\uFF09\u3002"}),"\n",(0,i.jsx)(e.li,{children:"atlas:import\uFF1A\u5728 schema \u6587\u4EF6\u4E2D\u5BFC\u5165\u5176\u4ED6 schema \u6587\u4EF6\u6216\u76EE\u5F55\u3002"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u8BED\u53E5\u6307\u4EE4\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"atlas:nolint\uFF1A\u5728\u8FC1\u79FB\u6587\u4EF6\u7684\u5355\u6761 SQL \u8BED\u53E5\u4E0A\u7981\u7528 Lint \u8B66\u544A\uFF0C\u4EC5\u5BF9\u8BE5\u8BED\u53E5\u751F\u6548\u3002\u793A\u4F8B\uFF1AALTER TABLE ...; -- atlas:nolint"}),"\n",(0,i.jsx)(e.li,{children:"atlas:assert\uFF1A\u7528\u4E8E\u9884\u68C0\u67E5\u6587\u4EF6\u4E2D\u7684\u65AD\u8A00\u8BED\u53E5\uFF0C\u58F0\u660E\u5176\u8986\u76D6\u7684\u4E00\u4E2A\u6216\u591A\u4E2A Lint \u89C4\u5219\uFF0C\u88AB\u8986\u76D6\u7684\u89C4\u5219\u4E0D\u518D\u63D0\u793A\u8B66\u544A/\u9519\u8BEF\u3002\u793A\u4F8B\uFF1A-- atlas:assert destructive-changes,large-index"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- atlas:import ./schemas\n"})}),"\n",(0,i.jsx)(e.h2,{id:"atlashcl",children:"atlas.hcl"}),"\n",(0,i.jsx)(e.h2,{id:"dsl",children:"DSL"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4 DSL \u540D\u5B57 atlas.hcl"}),"\n",(0,i.jsxs)(e.li,{children:["schema\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"charset"}),"\n",(0,i.jsx)(e.li,{children:"collate"}),"\n",(0,i.jsx)(e.li,{children:"comment"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["table\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"schema - \u5F15\u7528\u5B9A\u4E49\u7684 schema"}),"\n",(0,i.jsxs)(e.li,{children:["column\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"type"}),"\n",(0,i.jsx)(e.li,{children:"null"}),"\n",(0,i.jsx)(e.li,{children:"default"}),"\n",(0,i.jsx)(e.li,{children:"as - \u751F\u6210\u5217"}),"\n",(0,i.jsx)(e.li,{children:"comment"}),"\n",(0,i.jsx)(e.li,{children:"collate"}),"\n",(0,i.jsx)(e.li,{children:"auto_increment - MySQL, SQLite"}),"\n",(0,i.jsxs)(e.li,{children:["identity\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"generated - ALWAYS"}),"\n",(0,i.jsx)(e.li,{children:"start"}),"\n",(0,i.jsx)(e.li,{children:"increment"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["primary_key\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"columns"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["foreign_key\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"columns"}),"\n",(0,i.jsx)(e.li,{children:"ref_columns"}),"\n",(0,i.jsx)(e.li,{children:"on_delete - CASCADE, NO_ACTION"}),"\n",(0,i.jsx)(e.li,{children:"on_update"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["index\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["on\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"column"}),"\n",(0,i.jsx)(e.li,{children:"desc"}),"\n",(0,i.jsx)(e.li,{children:"prefix - \u7D22\u5F15\u591A\u957F - MySQL, MariaDB"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"unique"}),"\n",(0,i.jsx)(e.li,{children:"type - HASH, GIN, BRIN, FULLTEXT"}),"\n",(0,i.jsxs)(e.li,{children:["options\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"page_per_range"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"where - \u90E8\u5206\u7D22\u5F15 - PostgreSQL, SQLite"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["check\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"expr"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["partition - PostgreSQL\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"type=RANGE"}),"\n",(0,i.jsxs)(e.li,{children:["by\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"column"}),"\n",(0,i.jsx)(e.li,{children:"expr"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"variable"}),"\n",(0,i.jsxs)(e.li,{children:["env - ",(0,i.jsx)(e.code,{children:"--env local"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"src"}),"\n",(0,i.jsx)(e.li,{children:"url"}),"\n",(0,i.jsx)(e.li,{children:"dev"}),"\n",(0,i.jsx)(e.li,{children:"schemas"}),"\n",(0,i.jsxs)(e.li,{children:["migration_dir\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["url - ",(0,i.jsx)(e.code,{children:"file://migrations"})]}),"\n",(0,i.jsx)(e.li,{children:"format - atlas, flyway, liquibase, goose, golang-migrate"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u5176\u4ED6\u5C5E\u6027\u4F1A\u4F5C\u4E3A schema.hcl \u7684\u53D8\u91CF - ",(0,i.jsx)(e.code,{children:"--var tenant=wener"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'schema "a" {}\nschema "b" {}\n\n// \u591A schema \u540C\u540D\u8868\ntable "a" "users" {\n  schema = schema.a\n}\ntable "b" "users" {\n  schema = schema.b\n}\n'})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'env "local" {\n  src = "schema.hcl"\n\n  url = "sqlite://prod.db"\n  dev = "sqlite://dev.db"\n\n  schemas = ["main"]\n}\n'})}),"\n",(0,i.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(e.h2,{id:"avoid-diff-schema",children:"avoid diff schema"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:"diff {\n	add_table {\n		if_not_exists = true\n	}\n	drop_table {\n		if_exists = true\n	}\n	skip {\n		modify_schema = true\n	}\n}\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"Error: *schema.ModifySchema is not allowed when migration plan is scoped to one schema\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"wrong alter schema"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:'-- Modify "" schema\nALTER DATABASE CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;\n'})}),"\n",(0,i.jsx)(e.h2,{id:"migrate-set-version",children:"migrate set version"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"atlas migrate set\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u76F4\u63A5\u66F4\u6539 SQL \u8BBE\u7F6E\nupdate atlas_schema_revisions set applied=total,error='',error_stmt='' where version='20251126'\n"})})]})}function o(n={}){let{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(h,{...n})}):h(n)}},917776:function(n,e,l){l.d(e,{R:()=>r,x:()=>c});var s=l(7378);let i={},a=s.createContext(i);function r(n){let e=s.useContext(a);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),s.createElement(a.Provider,{value:e},n.children)}}}]);