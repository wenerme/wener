"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["58285"],{8386:function(e,n,a){a.r(n),a.d(n,{frontMatter:()=>s,toc:()=>c,default:()=>d,metadata:()=>t,assets:()=>i,contentTitle:()=>l});var t=JSON.parse('{"id":"service/auth/opa/README","title":"OPA","description":"- open-policy-agent/opa","source":"@site/../notes/service/auth/opa/README.md","sourceDirName":"service/auth/opa","slug":"/service/auth/opa/","permalink":"/notes/service/auth/opa/","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/auth/opa/README.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1689238697000,"frontMatter":{"title":"OPA"},"sidebar":"docs","previous":{"title":"oauth2-proxy","permalink":"/notes/service/auth/oauth2-proxy"},"next":{"title":"gatekeeper","permalink":"/notes/service/auth/opa/gatekeeper"}}'),o=a(86106),r=a(17776);let s={title:"OPA"},l="OPA",i={},c=[{value:"policy-as-code repository",id:"policy-as-code-repository",level:2},{value:"OIDC",id:"oidc",level:2},{value:"Awesome",id:"awesome",level:2}];function p(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"opa",children:"OPA"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/open-policy-agent/opa",children:"open-policy-agent/opa"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"REST API\u3001gRPC API\u3001SDK"}),"\n",(0,o.jsx)(n.li,{children:"\u901A\u7528\u7684\u3001\u72EC\u7ACB\u7684\u653F\u7B56\u5F15\u64CE"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["Rego\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://play.openpolicyagent.org/",children:"https://play.openpolicyagent.org/"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/rest-api/",children:"REST API"})}),"\n",(0,o.jsxs)(n.li,{children:["npm ",(0,o.jsx)(n.a,{href:"https://github.com/open-policy-agent/npm-opa-wasm",children:"@open-policy-agent/opa-wasm"})]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/StyraInc/awesome-opa",children:"StyraInc/awesome-opa"})}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'brew install opa\nopa run --server \\\n  --log-level debug \\\n  --addr https://0.0.0.0:8181\n\ncat << EOF > example.rego\npackage example\n\nimport input.request\n\ndefault allow = false\n\nallow {\n	request.method == "GET"\n}\nEOF\n\ncat << EOF > input.json\n{\n    "request": {\n        "method": "GET"\n    }\n}\nEOF\n\n# value: true\nopa eval -i input.json -d example.rego "data.example.allow"\n\n# --set=default_decision=example/allow\nopa run --server example.rego # \u670D\u52A1\n\n# \u9ED8\u8BA4 data.system.main, \u4F20\u9012 data/example \u4FEE\u6539\u8C03\u7528\u7684 policy\ncat << EOF > request.json\n{\n    "input": $(cat input.json)\n}\nEOF\ncurl localhost:8181/v1/data/example -i -d @request.json -H \'Content-Type: application/json\'\n\n# \u4EE5\u670D\u52A1\u8FD0\u884C\uFF0C\u4E0D\u52A0\u8F7D\u9884\u8BBE\nopa run --server \\\n  --log-format=json-pretty \\\n  --log-level=debug \\\n  --set=decision_logs.console=true\n\ncurl -X PUT \'localhost:8181/v1/policies/example\' --data-binary @example.rego\ncurl localhost:8181/v1/data/example -d @request.json -H \'Content-Type: application/json\' -s | jq\n\nopa capabilities --current                      # \u7248\u672C\u529F\u80FD\nopa build -t wasm -e example/allow example.rego # bundle.tar.gz\nopa inspect bundle.tar.gz\nopa check example.rego\nopa fmt example.rego\nopa deps --data example.rego data.example.allow\n\nmkdir -p policy\ncp example.rego policy\nopa build -b policy/ # bundle.tar.gz\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"--bundle"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"foo/\n  |\n  +-- bar/\n  |     |\n  |     +-- data.json\n  |\n  +-- baz.rego\n  |\n  +-- manifest.yaml\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/management-bundles/",children:"https://www.openpolicyagent.org/docs/latest/management-bundles/"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"policy-as-code-repository",children:"policy-as-code repository"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'mkdir -p src/policies\necho \'{}\' > src/data.json\ncat << EOF > src/.manifest\n{\n  "roots": ["policies"],\n  "metadata": {\n    "required_builtins": {\n      "builtin1": []\n    }\n  }\n}\nEOF\ncat << EOF > src/policies/example.rego\npackage example\n\nimport input.request\n\ndefault allow = false\n\nallow {\n	request.method == "GET"\n}\nEOF\nopa build src/\n# echo \'{}\' > config.json\n# --manifest-config config.json:application/vnd.oci.image.config.v1+json\n# oras push ghcr.io/wenerme/opa-policy:1.0.0 bundle.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip\n# https://hub.docker.com/r/wener/opa-policy\noras push docker.io/wener/opa-policy:1.0.0 bundle.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"services:\n  dockercr:\n    url: https://dockercr.wener.me\n    #url: https://docker.io\n    type: oci\n\nbundles:\n  authz:\n    service: dockercr\n    resource: dockercr.wener.me/wener/opa-policy:1.0.0\n    persist: true\n    polling:\n      min_delay_seconds: 30\n      max_delay_seconds: 120\n# persistence_directory: ${PWD}/.opa\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"curl localhost:8181/v1/data/example -d @request.json -H 'Content-Type: application/json' -s | jq\n\nls .opa/bundles/authz/ # \u7F13\u5B58\u76EE\u5F55 bundle.tar.gz\n"})}),"\n",(0,o.jsx)(n.h2,{id:"oidc",children:"OIDC"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rego",children:'package oidc\n\njwks_request(url) := http.send({\n    "url": url,\n    "method": "GET",\n    "force_cache": true,\n    "force_cache_duration_seconds": 3600\n})\n\njwt_unverified := io.jwt.decode(input.token)\njwt_header := jwt_unverified[0]\n\n# Use the key ID (kid) from the token as a cache key - if a new kid is encountered\n# we obtain a fresh JWKS object as the keys have likely been rotated.\njwks_url := concat("?", [\n    "https://authorization-server.example.com/jwks",\n    urlquery.encode_object({"kid": jwt_header.kid}),\n])\njwks := jwks_request(jwks_url).raw_body\n\njwt_verified := jwt_unverified {\n    io.jwt.verify_rs256(input.token, jwks)\n}\n\nclaims_verified := jwt_verified[1]\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/oauth-oidc/",children:"https://www.openpolicyagent.org/docs/latest/oauth-oidc/"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"awesome",children:"Awesome"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/rond-authz/rond",children:"rond-authz/rond"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"sidecar proxy"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/aserto-dev/topaz",children:"aserto-dev/topaz"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"OPA + Zanzibar"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/notes/service/auth/opa/opal",children:"permitio/opal"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u7BA1\u7406\u548C\u81EA\u52A8\u63A8\u9001 Policy \u66F4\u65B0"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/opcr-io/policy",children:"opcr-io/policy"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"building OPA policies into OCI images"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/StyraInc/regal",children:"StyraInc/regal"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"linter"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/StyraInc/awesome-opa",children:"StyraInc/awesome-opa"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/fugue/regula",children:"fugue/regula"})}),"\n"]})]})}function d(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},17776:function(e,n,a){a.d(n,{R:()=>s,x:()=>l});var t=a(7378);let o={},r=t.createContext(o);function s(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);