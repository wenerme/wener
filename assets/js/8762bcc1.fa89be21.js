"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["699374"],{968738:function(n,e,r){r.r(e),r.d(e,{frontMatter:()=>i,toc:()=>c,default:()=>a,metadata:()=>t,assets:()=>o,contentTitle:()=>d});var t=JSON.parse('{"id":"dev/design/design-cron","title":"Design Cron","description":"- Cron \u8C03\u5EA6","source":"@site/../notes/dev/design/design-cron.md","sourceDirName":"dev/design","slug":"/dev/design/cron","permalink":"/notes/dev/design/cron","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/design/design-cron.md","tags":[{"inline":true,"label":"Scheduler","permalink":"/notes/tags/scheduler"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1743997463000,"frontMatter":{"tags":["Scheduler"]},"sidebar":"docs","previous":{"title":"CRM","permalink":"/notes/dev/design/crm"},"next":{"title":"Design Dashboard","permalink":"/notes/dev/design/dashboard"}}'),s=r(486106),l=r(917776);let i={tags:["Scheduler"]},d="Design Cron",o={},c=[{value:"quartz",id:"quartz",level:2},{value:"K8S CronJob",id:"k8s-cronjob",level:2},{value:"Nomad Perriodic",id:"nomad-perriodic",level:2},{value:"node cron",id:"node-cron",level:2},{value:"BullMQ",id:"bullmq",level:2}];function h(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"design-cron",children:"Design Cron"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Cron \u8C03\u5EA6\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u91CD\u590D\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"pattern"}),"\n",(0,s.jsx)(e.li,{children:"every"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u662F\u5426\u7ACB\u5373\u5F00\u59CB"}),"\n",(0,s.jsxs)(e.li,{children:["timezone\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"timezone id"}),"\n",(0,s.jsx)(e.li,{children:"utc offset"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u4EFB\u52A1\u8C03\u5EA6\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u662F\u5426\u5E76\u884C - \u7B49\u5F85\u4E0A\u4E00\u4E2A\u5B8C\u6210"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"* * * * * *\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u79D2\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"0-59"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u5206\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"0-59"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u65F6\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"0-23"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u65E5\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"1-31"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u6708\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"1-12"}),"\n",(0,s.jsx)(e.li,{children:"JAN-DEC"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u5468/\u661F\u671F - day of week\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"0-7"}),"\n",(0,s.jsx)(e.li,{children:"MIN-SUN"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u5E74 - \u53EF\u9009"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"symbol"}),(0,s.jsx)(e.th,{children:"for"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"*"})}),(0,s.jsx)(e.td,{children:"all"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"/"})}),(0,s.jsx)(e.td,{children:"step"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:","})}),(0,s.jsx)(e.td,{children:"list"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"-"})}),(0,s.jsx)(e.td,{children:"range"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"?"})}),(0,s.jsx)(e.td,{children:"ignore,no specific value"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"L"})}),(0,s.jsx)(e.td,{children:"last"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"W"})}),(0,s.jsx)(e.td,{children:"weekday"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"#"})}),(0,s.jsx)(e.td,{children:"nth"})]})]})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"alias"}),(0,s.jsx)(e.th,{children:"for"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@reboot"}),(0,s.jsx)(e.td,{children:"\u91CD\u542F\u540E\u6267\u884C\u4E00\u6B21, crond"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@yearly"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"0 0 1 1 *"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@annually"}),(0,s.jsx)(e.td,{children:"@yearly"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@monthly"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"0 0 1 * *"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@weekly"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"0 0 * * 0"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@daily"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"0 0 * * *"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@midnight"}),(0,s.jsx)(e.td,{children:"@daily"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"@hourly"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"0 * * * *"})})]})]})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"e.g."}),(0,s.jsx)(e.th,{children:"for"}),(0,s.jsx)(e.th,{children:"cn"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"6#3"})}),(0,s.jsx)(e.td,{children:"third Friday of the month"}),(0,s.jsx)(e.td,{children:"\u6BCF\u6708\u7B2C\u4E09\u4E2A\u661F\u671F\u4E94"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"30 10 ? * 5L"})}),(0,s.jsx)(e.td,{children:"0:30 AM on the last Thursday of every month"}),(0,s.jsx)(e.td,{children:"\u6BCF\u6708\u6700\u540E\u4E00\u4E2A\u661F\u671F\u4E94\u4E0A\u534810:30"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"0 0 0 LW * *"})}),(0,s.jsx)(e.td,{children:"last weekday of the month at midnight"}),(0,s.jsx)(e.td,{children:"\u6BCF\u6708\u6700\u540E\u4E00\u4E2A\u5DE5\u4F5C\u65E5\u5348\u591C"})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"quartz",children:"quartz"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Quartz Scheduler"}),"\n",(0,s.jsx)(e.li,{children:"org.quartz-scheduler:quartz"}),"\n",(0,s.jsx)(e.li,{children:"\u533A\u5206 Job \u548C Trigger"}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/quartz-scheduler/quartz",children:"quartz-scheduler/quartz"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://javadoc.io/doc/org.quartz-scheduler/quartz/latest/org/quartz/JobBuilder.html",children:"https://javadoc.io/doc/org.quartz-scheduler/quartz/latest/org/quartz/JobBuilder.html"})}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"k8s-cronjob",children:"K8S CronJob"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/",children:"https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.32/#cronjob-v1-batch",children:"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.32/#cronjob-v1-batch"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type CronJobSpec = {\n  concurrencyPolicy: string;\n  failedJobsHistoryLimit: number; // \u4FDD\u7559\u5931\u8D25\u4EFB\u52A1\u7684\u6570\u91CF\n  successfulJobsHistoryLimit: number; // \u4FDD\u7559\u6210\u529F\u4EFB\u52A1\u7684\u6570\u91CF\n  schedule: string; // cron\n  startingDeadlineSeconds: number;\n  suspend: boolean; // \u6682\u505C\n  timeZone: string;\n  jobTemplate: JobTemplateSpec;\n};\n\ntype JobTemplateSpec = {\n  metadata: ObjectMeta;\n  spec: JobSpec;\n};\ntype JobSpec = {\n  activeDeadlineSeconds: number; // \u8D85\u65F6\u65F6\u95F4\n  backoffLimit: number; // \u91CD\u8BD5\u6B21\u6570\n  backoffLimitPerIndex: number; //\n  completionMode: string; // \u5B8C\u6210\u6A21\u5F0F\n  completions: number; // \u5B8C\u6210\u6B21\u6570\n  managedBy: string; // \u7BA1\u7406\u8005\n  manualSelector: boolean; // \u624B\u52A8\u9009\u62E9\n  maxFailedIndexes: number; // \u6700\u5927\u5931\u8D25\u7D22\u5F15\n  parallelism: number; // \u5E76\u884C\u5EA6\n  podFailurePolicy: PodFailurePolicy;\n  podReplacementPolicy: string; // pod \u66FF\u6362\u7B56\u7565\n  successPolicy: SuccessPolicy;\n  suspend: boolean; // \u6682\u505C\n  ttlSecondsAfterFinished: number; // \u5B8C\u6210\u540E\u7684\u5B58\u6D3B\u65F6\u95F4\n  selector: LabelSelector; // \u9009\u62E9\u5668\n  template: PodTemplateSpec; // pod \u6A21\u677F\n};\n"})}),"\n",(0,s.jsx)(e.h2,{id:"nomad-perriodic",children:"Nomad Perriodic"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type Periodic = {\n  /**\n   * @deprecated\n   */\n  cron: string;\n  crons: string[];\n  prohibit_overlap: boolean;\n  time_zone: string;\n  enabled: boolean;\n};\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-hcl",children:'job "docs" {\n  periodic {\n    cron             = "*/15 * * * * *"\n    prohibit_overlap = true\n  }\n}\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://developer.hashicorp.com/nomad/docs/job-specification/periodic",children:"https://developer.hashicorp.com/nomad/docs/job-specification/periodic"})}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"node-cron",children:"node cron"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/kelektiv/node-cron",children:"https://github.com/kelektiv/node-cron"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"export type CronContext<C> = C extends null ? CronJob : NonNullable<C>;\nexport type CronCallback<C, WithOnCompleteBool extends boolean = false> = (\n  this: CronContext<C>,\n  onComplete: WithOnCompleteBool extends true ? CronOnCompleteCallback : never,\n) => void | Promise<void>;\nexport type CronOnCompleteCallback = () => void | Promise<void>;\nexport type CronSystemCommand =\n  | string\n  | {\n      command: string;\n      args?: readonly string[] | null;\n      options?: SpawnOptions | null;\n    };\nexport type CronCommand<C, WithOnCompleteBool extends boolean = false> =\n  | CronCallback<C, WithOnCompleteBool>\n  | CronSystemCommand;\n\ninterface BaseCronJobParams<OC extends CronOnCompleteCommand | null = null, C = null> {\n  cronTime: string | Date | DateTime;\n  onTick: CronCommand<C, WithOnComplete<OC>>;\n  onComplete?: OC;\n  start?: boolean | null;\n  context?: C;\n  runOnInit?: boolean | null;\n  unrefTimeout?: boolean | null;\n  waitForCompletion?: boolean | null;\n  errorHandler?: ((error: unknown) => void) | null;\n}\n\nexport type CronJobParams<OC extends CronOnCompleteCommand | null = null, C = null> = BaseCronJobParams<OC, C> &\n  (\n    | {\n        timeZone?: string | null;\n        utcOffset?: never;\n      }\n    | {\n        timeZone?: never;\n        utcOffset?: number | null;\n      }\n  );\n"})}),"\n",(0,s.jsx)(e.h2,{id:"bullmq",children:"BullMQ"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Repeatable"}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/taskforcesh/bullmq",children:"https://github.com/taskforcesh/bullmq"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"/**\n * Settings for repeatable jobs\n *\n * @see {@link https://docs.bullmq.io/guide/jobs/repeatable}\n */\nexport interface RepeatOptions extends Omit<ParserOptions, 'iterator'> {\n  /**\n   * A repeat pattern\n   */\n  pattern?: string;\n\n  /**\n   * Custom repeatable key. This is the key that holds the \"metadata\"\n   * of a given repeatable job. This key is normally auto-generated but\n   * it is sometimes useful to specify a custom key for easier retrieval\n   * of repeatable jobs.\n   */\n  key?: string;\n\n  /**\n   * Number of times the job should repeat at max.\n   */\n  limit?: number;\n\n  /**\n   * Repeat after this amount of milliseconds\n   * (`pattern` setting cannot be used together with this setting.)\n   */\n  every?: number;\n\n  /**\n   * Repeated job should start right now\n   * ( work only with cron settings)\n   */\n  immediately?: boolean;\n\n  /**\n   * The start value for the repeat iteration count.\n   */\n  count?: number;\n\n  /**\n   * Offset in milliseconds to affect the next iteration time\n   *\n   * */\n  offset?: number;\n\n  /**\n   * Internal property to store the previous time the job was executed.\n   */\n  prevMillis?: number;\n\n  /**\n   * Internal property to store de job id\n   * @deprecated\n   */\n  jobId?: string;\n}\n"})})]})}function a(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(h,{...n})}):h(n)}},917776:function(n,e,r){r.d(e,{R:()=>i,x:()=>d});var t=r(7378);let s={},l=t.createContext(s);function i(n){let e=t.useContext(l);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:i(n.components),t.createElement(l.Provider,{value:e},n.children)}}}]);