"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["48665"],{34578:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>l,toc:()=>a,default:()=>h,metadata:()=>s,assets:()=>d,contentTitle:()=>c});var s=JSON.parse('{"id":"db/kv/etcd","title":"etcd","description":"- etcd.conf.yml","source":"@site/../notes/db/kv/etcd.md","sourceDirName":"db/kv","slug":"/db/kv/etcd","permalink":"/notes/db/kv/etcd","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/kv/etcd.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1704307832000,"frontMatter":{"title":"etcd"},"sidebar":"docs","previous":{"title":"dragonflydb","permalink":"/notes/db/kv/dragonflydb"},"next":{"title":"FoundationDB","permalink":"/notes/db/kv/foundationdb"}}'),i=n(86106),r=n(17776);let l={title:"etcd"},c="etcd",d={},a=[{value:"etcdctl",id:"etcdctl",level:2},{value:"\u914D\u7F6E {configuration}",id:"\u914D\u7F6E-configuration",level:2},{value:"limits",id:"limits",level:2},{value:"the member has been permanently removed from the cluster",id:"the-member-has-been-permanently-removed-from-the-cluster",level:2},{value:"member has already been bootstrapped",id:"member-has-already-been-bootstrapped",level:2},{value:"prober detected unhealthy status",id:"prober-detected-unhealthy-status",level:2}];function o(e){let t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"etcd",children:"etcd"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://github.com/etcd-io/etcd/blob/main/etcd.conf.yml.sample",children:"etcd.conf.yml"})}),"\n",(0,i.jsxs)(t.li,{children:["adopters:\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"kubernetes"}),"\n",(0,i.jsx)(t.li,{children:"vitess"}),"\n",(0,i.jsx)(t.li,{children:"Apache APISIX"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://discovery.etcd.io",children:"https://discovery.etcd.io"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"\u53D1\u73B0\u9636\u6BB5"}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"https://discovery.etcd.io/${UUID}"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\u5B58\u50A8 ",(0,i.jsx)(t.a,{href:"https://github.com/etcd-io/bbolt",children:"etcd-io/bbolt"})]}),"\n",(0,i.jsxs)(t.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://etcd.io/docs/v3.5/integrations/",children:"https://etcd.io/docs/v3.5/integrations/"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.li,{children:"v3 API"}),"\n",(0,i.jsx)(t.li,{children:"RBAC"}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"\u9002\u7528\u4E8E \u5C11\u91CF\u66F4\u65B0\uFF0C\u5927\u91CF\u8BFB\u53D6\u7684\u573A\u666F"}),"\n",(0,i.jsx)(t.li,{children:"\u9891\u7E41\u66F4\u65B0\u5BFC\u81F4 snapshot \u589E\u957F\u5F88\u5FEB"}),"\n",(0,i.jsx)(t.li,{children:"\u9ED8\u8BA4 2GiB \u5B58\u50A8"}),"\n",(0,i.jsx)(t.li,{children:"\u9ED8\u8BA4 value \u4E0A\u9650 1.5MiB"}),"\n",(0,i.jsx)(t.li,{children:"v2 API - 3.5 \u5E9F\u5F03, 3.6 \u9000\u5F79"}),"\n"]})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'# Docker\n# ==========\ndocker run --rm -it \\\n  -v $PWD/data:/data \\\n  -p 2379:2379 \\\n  -e ETCD_AUTO_COMPACTION_MODE=revision \\\n  -e ETCD_AUTO_COMPACTION_RETENTION=1000 \\\n  -e ETCD_QUOTA_BACKEND_BYTES=4294967296 \\\n  -e ETCD_SNAPSHOT_COUNT=50000 \\\n  --name etcd quay.io/coreos/etcd:v3.5.0 \\\n  etcd --advertise-client-urls=http://127.0.0.1:2379 --listen-client-urls http://0.0.0.0:2379 --data-dir /data\n\n# macOS\n# ==========\nbrew install etcd\n\n# \u670D\u52A1\u7AEF\n# ==========\netcd\n\n# \u5BA2\u6237\u7AEF\n# ==========\netcdctl put key "value"\netcdctl get ket\n\n# \u5176\u4ED6\u670D\u52A1\n# stateless pass-through etcd TCP connection forwarding proxy\netcd gateway\n# stateless etcd v3 gRPC L7 reverse proxy\netcd grpc-proxy\n'})}),"\n",(0,i.jsx)(t.h2,{id:"etcdctl",children:"etcdctl"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"etcdctl flag"}),(0,i.jsx)(t.th,{children:"env"}),(0,i.jsx)(t.th,{children:"demo"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{children:"ETCDCTL_API"}),(0,i.jsx)(t.td,{children:"3"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"--endpoints"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{children:"localhost:2379"})]})]})]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"etcdctl check perf|datascale"}),"\n",(0,i.jsx)(t.li,{children:"etcdctl put|get|watch|lock|del"}),"\n",(0,i.jsx)(t.li,{children:"etcdctl snapshot save|status|restore"}),"\n",(0,i.jsx)(t.li,{children:"etcdctl member list|add|promote|remove|update"}),"\n",(0,i.jsx)(t.li,{children:"etcdctl user list|add|get|delete|passwd|grant-role|revoke-role"}),"\n",(0,i.jsx)(t.li,{children:"etcdctl role list|add|get|delete|grant-permission|revoke-permission"}),"\n",(0,i.jsx)(t.li,{children:"etcdctl auth enable|status|disable"}),"\n",(0,i.jsxs)(t.li,{children:["permission\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"read,readwrite"}),"\n",(0,i.jsx)(t.li,{children:"prefix"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"\u914D\u7F6E-configuration",children:"\u914D\u7F6E {configuration}"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"# Member\n# ==============================\nname: default # \u6210\u5458\u540D\u5B57\ndata-dir: ${name}.etcd # \u6570\u636E\u76EE\u5F55\nwal-dir: # WAL \u65E5\u5FD7\u76EE\u5F55\n\n# \u5FEB\u7167\u5230\u78C1\u76D8\u7684 \u4E8B\u52A1\u6570\nsnapshot-count: 10000\n# \u5FC3\u8DF3\u95F4\u9694 ms\nheartbeat-interval: 100\n# \u9009\u4E3E\u8D85\u65F6 ms\nelection-timeout: 1000\n\n# \u540E\u7AEF\u6570\u636E\u5927\u5C0F\u62A5\u8B66\u9600\u503C - 0 \u7981\u7528\nquota-backend-bytes: 0\n\n# peer traffic.\n# \u9017\u53F7\u5206\u9694\u591A\u4E2A\nlisten-peer-urls: http://localhost:2380\n# client traffic.\nlisten-client-urls: http://localhost:2379\n\n# \u4FDD\u7559\u5FEB\u7167\u6587\u4EF6 - 0 \u65E0\u9650\nmax-snapshots: 5\n# \u4FDD\u7559 WAL \u6587\u4EF6\nmax-wals: 5\n\n# CORS \u57DF\u540D - \u9017\u53F7\u5206\u9694\ncors:\n\n# List of this member's peer URLs to advertise to the rest of the cluster.\n# The URLs needed to be a comma-separated list.\ninitial-advertise-peer-urls: http://localhost:2380\n\n# List of this member's client URLs to advertise to the public.\n# The URLs needed to be a comma-separated list.\nadvertise-client-urls: http://localhost:2379\n\n# Discovery URL used to bootstrap the cluster.\ndiscovery:\n\n# exit,proxy\ndiscovery-fallback: 'proxy'\n\n# HTTP proxy to use for traffic to discovery service.\ndiscovery-proxy:\n\n# DNS domain used to bootstrap initial cluster.\ndiscovery-srv:\n\n# Initial cluster configuration for bootstrapping.\ninitial-cluster:\n\n# Initial cluster token for the etcd cluster during bootstrap.\ninitial-cluster-token: 'etcd-cluster'\n\n# Initial cluster state ('new' or 'existing').\ninitial-cluster-state: 'new'\n\n# Reject reconfiguration requests that would cause quorum loss.\nstrict-reconfig-check: false\nenable-pprof: true\n\nclient-transport-security:\n  # Path to the client server TLS cert file.\n  cert-file:\n\n  # Path to the client server TLS key file.\n  key-file:\n\n  # Enable client cert authentication.\n  client-cert-auth: false\n\n  # Path to the client server TLS trusted CA cert file.\n  trusted-ca-file:\n\n  # Client TLS using generated certificates\n  auto-tls: false\n\npeer-transport-security:\n  # Path to the peer server TLS cert file.\n  cert-file:\n\n  # Path to the peer server TLS key file.\n  key-file:\n\n  # Enable peer client cert authentication.\n  client-cert-auth: false\n\n  # Path to the peer server TLS trusted CA cert file.\n  trusted-ca-file:\n\n  # Peer TLS using generated certificates.\n  auto-tls: false\n\n# The validity period of the self-signed certificate, the unit is year.\nself-signed-cert-validity: 1\n\nlog-level: debug\nlogger: zap\n# default, stderr, stdout\nlog-outputs: [stderr]\nenable-log-rotation: false\nlog-rotation-config-json: '{\"maxsize\": 100, \"maxage\": 0, \"maxbackups\": 0, \"localtime\": false, \"compress\": false}'\n\n# Clustering\n# ==============================\n\n# periodic - \u57FA\u4E8E\u95F4\u9694\uFF0C\u9ED8\u8BA4\u5355\u4F4D\u4E3A\u5C0F\u65F6\n# revision - \u57FA\u4E8E\u7248\u672C\nauto-compaction-mode: periodic\nauto-compaction-retention: '1'\n\nenable-v2: false\n\n# v2 Proxy\n# on,off\nproxy: 'off'\nproxy-failure-wait: 5000\nproxy-refresh-interval: 30000\nproxy-dial-timeout: 1000\nproxy-write-timeout: 5000\nproxy-read-timeout: 0\n\n# Unsafe\n# ==============================\n# \u5F3A\u5236\u521B\u5EFA\u5355\u6210\u5458\u96C6\u7FA4\nforce-new-cluster: false\nunsafe-no-fsync: false\n"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://etcd.io/docs/v3.5/op-guide/configuration/",children:"https://etcd.io/docs/v3.5/op-guide/configuration/"})}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"limits",children:"limits"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"flag"}),(0,i.jsx)(t.th,{style:{textAlign:"right"},children:"default"}),(0,i.jsx)(t.th,{children:"note"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"--max-request-bytes"}),(0,i.jsx)(t.td,{style:{textAlign:"right"},children:"1.5MiB"}),(0,i.jsx)(t.td,{})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"--quota-backend-bytes"}),(0,i.jsx)(t.td,{style:{textAlign:"right"},children:"2GiB"}),(0,i.jsx)(t.td,{children:"\u63A8\u8350 8GiB"})]})]})]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://etcd.io/docs/v3.5/dev-guide/limit/",children:"https://etcd.io/docs/v3.5/dev-guide/limit/"})}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"the-member-has-been-permanently-removed-from-the-cluster",children:"the member has been permanently removed from the cluster"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://github.com/bitnami/charts/issues/16071",children:"https://github.com/bitnami/charts/issues/16071"})}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"member-has-already-been-bootstrapped",children:"member has already been bootstrapped"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"etcdctl endpoint status\netcdctl member list\netcdctl member remove 3ff1b5cd453a87df\n\n# etcdserver: member not found\n\netcdctl member add apisix-etcd-2 --peer-urls=http://apisix-etcd-2.apisix-etcd-headless.apisix.svc.cluster.local:2380,http://apisix-etcd-2.apisix-etcd-headless.apisix.svc.cluster.local:2379,http://apisix-etcd.apisix.svc.cluster.local:2379\n"})}),"\n",(0,i.jsx)(t.h2,{id:"prober-detected-unhealthy-status",children:"prober detected unhealthy status"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"connection refused"}),"\n"]})]})}function h(e={}){let{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},17776:function(e,t,n){n.d(t,{R:()=>l,x:()=>c});var s=n(7378);let i={},r=s.createContext(i);function l(e){let t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);