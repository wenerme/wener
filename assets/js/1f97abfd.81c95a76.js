"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["94806"],{5461:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>o,toc:()=>a,default:()=>d,metadata:()=>r,assets:()=>l,contentTitle:()=>c});var r=JSON.parse('{"id":"service/bi/cubejs/cubejs-conf","title":"CubeJS \u914D\u7F6E","description":"- \u73AF\u5883\u53D8\u91CF\u914D\u7F6E","source":"@site/../notes/service/bi/cubejs/cubejs-conf.md","sourceDirName":"service/bi/cubejs","slug":"/service/bi/cubejs/conf","permalink":"/notes/service/bi/cubejs/conf","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/bi/cubejs/cubejs-conf.md","tags":[{"inline":true,"label":"Configuration","permalink":"/notes/tags/configuration"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1702440128000,"frontMatter":{"title":"CubeJS \u914D\u7F6E","tags":["Configuration"]},"sidebar":"docs","previous":{"title":"CubeJS","permalink":"/notes/service/bi/cubejs/"},"next":{"title":"CubeJS Frontend","permalink":"/notes/service/bi/cubejs/frontend"}}'),s=t(86106),i=t(17776);let o={title:"CubeJS \u914D\u7F6E",tags:["Configuration"]},c="CubeJS \u914D\u7F6E",l={},a=[{value:"\u914D\u7F6E\u8BF4\u660E",id:"\u914D\u7F6E\u8BF4\u660E",level:2},{value:"Multitenancy",id:"multitenancy",level:2},{value:"\u6570\u636E\u5E93",id:"\u6570\u636E\u5E93",level:2}];function u(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"cubejs-\u914D\u7F6E",children:"CubeJS \u914D\u7F6E"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u73AF\u5883\u53D8\u91CF\u914D\u7F6E\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CUBEJS_DEV_MODE=true - \u5F00\u53D1\u6A21\u5F0F"}),"\n",(0,s.jsx)(n.li,{children:"CUBEJS_APP - APP ID"}),"\n",(0,s.jsx)(n.li,{children:"CUBEJS_TELEMETRY=false"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://cube.dev/docs/reference/environment-variables",children:"Environment Variables"})}),"\n",(0,s.jsxs)(n.li,{children:["\u6620\u5C04\u65B9\u5F0F ",(0,s.jsx)(n.code,{children:"CUBEJS_DB_TYPE"})," -> ",(0,s.jsx)(n.code,{children:"dbType"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["cube.js \u914D\u7F6E\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://cube.dev/docs/config",children:"https://cube.dev/docs/config"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["dev mode\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u65E0 auth"}),"\n",(0,s.jsx)(n.li,{children:"\u5355\u8282\u70B9 cubestore"}),"\n",(0,s.jsx)(n.li,{children:"background refresh for in-memory cache, cheduled pre-aggregations"}),"\n",(0,s.jsx)(n.li,{children:"log level trace"}),"\n",(0,s.jsxs)(n.li,{children:["playground ",(0,s.jsx)(n.a,{href:"http://localhost:4000",children:"http://localhost:4000"})]}),"\n",(0,s.jsx)(n.li,{children:"memory as the default cache/queue engine"}),"\n",(0,s.jsx)(n.li,{children:"log incorrect/invalid configuration for for externalRefresh /waitForRenew instead of throwing errors"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",metastring:'title="cube.js"',children:"module.exports = {\n  telemetry: false,\n  logger: (msg, params) => {\n    console.log(`${msg}: ${JSON.stringify(params)}`);\n  },\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u914D\u7F6E\u8BF4\u660E",children:"\u914D\u7F6E\u8BF4\u660E"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u4E0A\u4E0B\u6587\u5173\u7CFB"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u8BF7\u6C42 - ExpressRequest"}),"\n",(0,s.jsx)(n.li,{children:"appId - RequestContext"}),"\n",(0,s.jsx)(n.li,{children:"COMPILE_CONTEXT - RequestContext"}),"\n",(0,s.jsx)(n.li,{children:"jwt - securityContext"}),"\n",(0,s.jsxs)(n.li,{children:["SECURITY_CONTEXT - securityContext\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5C3D\u91CF\u4F7F\u7528 queryRewrite \u800C\u4E0D\u662F SECURITY_CONTEXT"}),"\n",(0,s.jsx)(n.li,{children:"\u7528\u4E8E row level security"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"interface CubejsConfiguration {\n  // Schema \u6587\u4EF6\u8DEF\u5F84 /schema\n  schemaPath: string;\n  // REST \u63A5\u53E3\u8DEF\u5F84 /cubejs-api\n  basePath: string;\n  // \u9ED8\u8BA4 /\n  webSocketsBasePath: string;\n  // \u81EA\u5B9A\u4E49 logger\n  // \u4F8B\u5982 console.log(`${msg}: ${JSON.stringify(params)}`);\n  logger: (msg: string, params: object) => any;\n\n  // \u6570\u636E\u5E93\u7C7B\u578B - \u6BCF\u4E2A appId \u8BF7\u6C42\u4E00\u6B21\n  dbType: string | ((context: RequestContext) => string);\n  // \u6570\u636E\u6E90\u914D\u7F6E - \u4E00\u4E2A\u6570\u636E\u6E90\u8BF7\u6C42\u4E00\u6B21\n  driverFactory: (context: DriverContext) => BaseDriver | Promise<BaseDriver>;\n  // \u5916\u90E8\u6570\u636E\u5E93\u7C7B\u578B - \u6BCF\u4E2A appId \u8BF7\u6C42\u4E00\u6B21\n  externalDbType: string | ((context: RequestContext) => string);\n  // \u5916\u90E8 rollup - \u6BCF\u4E2A appId \u8BF7\u6C42\u4E00\u6B21\n  externalDriverFactory: (context: RequestContext) => BaseDriver | Promise<BaseDriver>;\n\n  // AppID - \u6BCF\u6B21\u8BF7\u6C42\n  // \u7F13\u5B58 Key - schema compilation results, connection pool \u7B49\n  // \u4F8B\u5982 ({ securityContext }) => `CUBEJS_APP_${securityContext.tenantId}_${securityContext.user_id}`\n  contextToAppId: (context: RequestContext) => string;\n  // \u67E5\u8BE2\u7F16\u6392\u7F13\u5B58 Key - \u9ED8\u8BA4\u4E3A appId - \u6BCF\u6B21\u8BF7\u6C42\n  // \u6570\u636E\u5E93\u8FDE\u63A5, \u6267\u884C\u961F\u5217, \u9884\u805A\u5408\u8868\u7F13\u5B58\n  // \u4F8B\u5982 ({ securityContext }) => `CUBEJS_APP_${securityContext.tenantId}`\n  contextToOrchestratorId: (context: RequestContext) => string;\n  // Schema \u4ED3\u5E93 - \u6BCF AppID \u8BF7\u6C42\n  // \u5B9E\u73B0\u591A\u79DF\u6237\u4E0D\u540C schema\n  // \u4F8B\u5982 ({ securityContext }) => new FileRepository(`schema/${securityContext.appId}`)\n  repositoryFactory: (context: RequestContext) => SchemaFileRepository;\n  // REST \u548C WebSockets API \u9274\u6743\n  // \u9ED8\u8BA4 \u68C0\u67E5 Authorization JWT\uFF0C\u9A8C\u8BC1\u540E\u5185\u5BB9\u8BBE\u7F6E\u4E3A req.securityContext\n  // \u53EF\u7981\u7528 (req, auth) => {}\n  checkAuth: (req: ExpressRequest, authorization: string) => any;\n  // SQL API \u9274\u6743 - \u9ED8\u8BA4\u6821\u9A8C CUBE_SQL_USERNAME, CUBE_SQL_PASSWORD\n  checkSqlAuth: (req: SQLRequest, user: string) => any;\n  // \u67E5\u8BE2\u6267\u884C\u524D\u7684\u989D\u5916\u68C0\u67E5\n  queryRewrite: (query: object, context: RequestContext) => object;\n  // \u9884\u805A\u5408 schema - \u63A8\u8350\u751F\u4EA7\u548C\u5F00\u53D1\u4F7F\u7528\u4E0D\u540C schema - \u6BCF\u4E2A appId \u8BF7\u6C42\u4E00\u6B21\n  // \u5F00\u53D1\u6A21\u5F0F\u9ED8\u8BA4 dev_pre_aggregations\n  // \u751F\u4EA7\u6A21\u5F0F\u9ED8\u8BA4 prod_pre_aggregations\n  preAggregationsSchema: string | ((context: RequestContext) => string);\n  // schema \u7248\u672C - \u786E\u5B9A\u4EC0\u4E48\u65F6\u5019\u91CD\u65B0\u7F16\u8BD1\n  schemaVersion: (context: RequestContext) => string;\n\n  scheduledRefreshTimer: boolean | number;\n  scheduledRefreshTimeZones: string[];\n  scheduledRefreshContexts: () => Promise<object[]>;\n\n  // \u6269\u5C55 RequestContext\n  extendContext: (req: ExpressRequest) => any;\n  // \u9ED8\u8BA4 250\n  compilerCacheSize: number;\n  // \u5355\u4F4D ms\n  maxCompilerCacheKeepAlive: number;\n  updateCompilerCacheKeepAlive: boolean;\n  allowUngroupedWithoutPrimaryKey: boolean;\n  telemetry: boolean;\n\n  http: {\n    cors: {\n      methods: string | string[];\n      origin: string;\n      allowedHeaders: string | string[];\n      exposedHeaders: string | string[];\n      credentials: boolean;\n      maxAge: number;\n      preflightContinue: boolean;\n      optionsSuccessStatus: number;\n    };\n  };\n\n  jwt: {\n    jwkUrl?: ((payload: any) => string) | string;\n    key?: string;\n    algorithms?: string[];\n    issuer?: string[];\n    audience?: string;\n    subject?: string;\n    claimsNamespace?: string;\n  };\n  // \u63A8\u8350\u751F\u4EA7\u4F7F\u7528 redis\n  cacheAndQueueDriver: 'memory' | 'redis';\n  // \u63A8\u8350\u4FDD\u7559\u9ED8\u8BA4\n  orchestratorOptions: OrchestratorOptions | ((context: RequestContext) => OrchestratorOptions);\n  allowJsDuplicatePropsInSchema: boolean;\n}\n\ninterface OrchestratorOptions {\n  redisPrefix: string;\n  rollupOnlyMode: bool;\n  queryCacheOptions: {\n    refreshKeyRenewalThreshold: number;\n    backgroundRenew: boolean;\n    queueOptions: QueueOptions;\n  };\n  preAggregationsOptions: {\n    queueOptions: QueueOptions;\n  };\n}\n\ninterface QueueOptions {\n  concurrency: number;\n  continueWaitTimeout: number;\n  executionTimeout: number;\n  orphanedTimeout: number;\n  heartBeatInterval: number;\n}\n\ninterface RequestContext {\n  securityContext: object;\n  requestId: string;\n}\n\ninterface DriverContext extends RequestContext {\n  dataSource: string;\n}\n\ninterface SchemaFileRepository {\n  dataSchemaFiles(): Promise<FileContent[]>;\n}\n\ninterface FileContent {\n  fileName: string;\n  content: string;\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:'title="QueueOptions"',children:'{\n  "concurrency": 2,\n  "continueWaitTimeout": 5,\n  "executionTimeout": 600,\n  "orphanedTimeout": 120,\n  "heartBeatInterval": 30\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"multitenancy",children:"Multitenancy"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Multitenancy vs Multiple Data Sources\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Multitenancy\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u591A\u7528\u6237\uFF0C\u4E0D\u540C\u6570\u636E\u96C6"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Multiple Data Sources\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u76F8\u540C\u6570\u636E\u4E0D\u540C\u6570\u636E\u5E93"}),"\n",(0,s.jsx)(n.li,{children:"cube \u5173\u8054 dataSource"}),"\n",(0,s.jsx)(n.li,{children:"\u914D\u7F6E dbType+driverFactory \u751F\u6210\u591A\u6570\u636E\u6E90"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Security Context vs Multitenant Compile Context\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Security Context\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"row-level security within the same database for different users"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Multitenant Compile Context\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"access different databases"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Security Context vs queryRewrite\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Security Context\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"explicit control"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",metastring:'title="cube.js"',children:"const PostgresDriver = require('@cubejs-backend/postgres-driver');\n\nmodule.exports = {\n  driverFactory: ({ dataSource }) => new PostgresDriver({ database: dataSource }),\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u6570\u636E\u5E93",children:"\u6570\u636E\u5E93"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"const MySQLDriver = require('@cubejs-backend/mysql-driver');\n\nnew MySQLDriver({\n  host: process.env.CUBEJS_EXT_DB_HOST,\n  database: process.env.CUBEJS_EXT_DB_NAME,\n  port: process.env.CUBEJS_EXT_DB_PORT,\n  user: process.env.CUBEJS_EXT_DB_USER,\n  password: process.env.CUBEJS_EXT_DB_PASS,\n});\n"})})]})}function d(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},17776:function(e,n,t){t.d(n,{R:()=>o,x:()=>c});var r=t(7378);let s={},i=r.createContext(s);function o(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);