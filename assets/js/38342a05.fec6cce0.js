"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["55374"],{27094:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>s,toc:()=>c,default:()=>d,metadata:()=>a,assets:()=>i,contentTitle:()=>r});var a=JSON.parse('{"id":"db/relational/mysql/mysql-cookbook","title":"MySQL Cookbook","description":"table_size","source":"@site/../notes/db/relational/mysql/mysql-cookbook.md","sourceDirName":"db/relational/mysql","slug":"/db/relational/mysql/cookbook","permalink":"/notes/db/relational/mysql/cookbook","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/mysql/mysql-cookbook.md","tags":[{"inline":true,"label":"Cookbook","permalink":"/notes/tags/cookbook"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1734683606000,"frontMatter":{"tags":["Cookbook"]},"sidebar":"docs","previous":{"title":"MySQL \u914D\u7F6E","permalink":"/notes/db/relational/mysql/conf"},"next":{"title":"MySQL FAQ","permalink":"/notes/db/relational/mysql/faq"}}'),l=t(86106),o=t(17776);let s={tags:["Cookbook"]},r="MySQL Cookbook",i={},c=[{value:"table_size",id:"table_size",level:2},{value:"analyze_small_tables",id:"analyze_small_tables",level:2}];function m(e){let n={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"mysql-cookbook",children:"MySQL Cookbook"})}),"\n",(0,l.jsx)(n.h2,{id:"table_size",children:"table_size"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE VIEW table_size AS\nSELECT\n    table_schema AS table_schema,\n    table_name AS table_name,\n    table_rows AS row_estimate,\n    data_length + index_length AS total_bytes,\n    data_length AS table_bytes,\n    index_length AS index_bytes,\n    data_free AS free_space,\n    CONCAT(ROUND((data_length + index_length) / 1024 / 1024, 2), ' MB') AS total_pretty,\n    CONCAT(ROUND(data_length / 1024 / 1024, 2), ' MB') AS table_pretty,\n    CONCAT(ROUND(index_length / 1024 / 1024, 2), ' MB') AS index_pretty\nFROM\n    information_schema.tables\nWHERE\n    table_type = 'BASE TABLE'\nORDER BY\n    total_bytes DESC;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"analyze_small_tables",children:"analyze_small_tables"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"DELIMITER $$\n\nCREATE PROCEDURE analyze_small_tables()\nBEGIN\n  DECLARE done INT DEFAULT FALSE;\n  DECLARE schema_name VARCHAR(255);\n  DECLARE table_name VARCHAR(255);\n  DECLARE cur CURSOR FOR\n    SELECT table_schema, table_name\n    FROM table_size\n    WHERE table_schema not in ('information_schema', 'performance_schema', 'mysql','sys')\n      AND row_estimate < 10;\n  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;\n\n  OPEN cur;\n\n  read_loop: LOOP\n    FETCH cur INTO schema_name, table_name;\n    IF done THEN\n      LEAVE read_loop;\n    END IF;\n\n    SET @stmt = CONCAT('ANALYZE TABLE ', schema_name, '.', table_name);\n    PREPARE stmt FROM @stmt;\n    EXECUTE stmt;\n    DEALLOCATE PREPARE stmt;\n  END LOOP;\n\n  CLOSE cur;\nEND$$\n\nDELIMITER ;\n"})})]})}function d(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(m,{...e})}):m(e)}},17776:function(e,n,t){t.d(n,{R:()=>s,x:()=>r});var a=t(7378);let l={},o=a.createContext(l);function s(e){let n=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);