"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["563898"],{821:function(e,r,n){n.r(r),n.d(r,{frontMatter:()=>c,toc:()=>o,default:()=>h,metadata:()=>s,assets:()=>l,contentTitle:()=>d});var s=JSON.parse('{"id":"devops/docker/docker-registry","title":"Docker \u4ED3\u5E93","description":"- Docker Registry -> Distribution Registry","source":"@site/../notes/devops/docker/docker-registry.md","sourceDirName":"devops/docker","slug":"/devops/docker/registry","permalink":"/notes/devops/docker/registry","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/docker/docker-registry.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1740927882000,"frontMatter":{"title":"Docker \u4ED3\u5E93"},"sidebar":"docs","previous":{"title":"Docker \u7F51\u7EDC","permalink":"/notes/devops/docker/network"},"next":{"title":"Docker \u5B58\u50A8","permalink":"/notes/devops/docker/storage"}}'),i=n(486106),t=n(917776);let c={title:"Docker \u4ED3\u5E93"},d="Docker Registry",l={},o=[{value:"docker registry",id:"docker-registry-1",level:2},{value:"PUSH 405",id:"push-405",level:2},{value:"auth",id:"auth",level:3},{value:"apis",id:"apis",level:2},{value:"docker registry v1 vs v2",id:"docker-registry-v1-vs-v2",level:2},{value:"local",id:"local",level:2}];function a(e){let r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"docker-registry",children:"Docker Registry"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Docker Registry -> Distribution Registry"}),"\n",(0,i.jsxs)(r.li,{children:["\u5E38\u89C1\u5B9E\u73B0\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"registry:2"})," \u5B98\u65B9"]}),"\n",(0,i.jsx)(r.li,{children:"Nexus"}),"\n",(0,i.jsx)(r.li,{children:"Harbor"}),"\n",(0,i.jsx)(r.li,{children:"JForg"}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://github.com/SUSE/Portus",children:"Portus"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["containerd ",(0,i.jsx)(r.a,{href:"https://github.com/containerd/cri/blob/master/docs/registry.md",children:"registry"})]}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://github.com/google/go-containerregistry",children:"google/go-containerregistry"})}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"https://github.com/distribution/distribution",children:"distribution/distribution"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"registry:2"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"https://github.com/docker-archive/docker-registry",children:"docker-archive/docker-registry"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"registry"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"docker-registry-1",children:"docker registry"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://distribution.github.io/distribution/about/configuration/",children:"\u914D\u7F6E"})}),"\n",(0,i.jsx)(r.li,{children:"\u5B58\u50A8: \u6587\u4EF6\u7CFB\u7EDF\u3001azure\u3001gcs\u3001s3\u3001switf\u3001oss"}),"\n",(0,i.jsx)(r.li,{children:"\u6388\u6743: silly\u3001token\u3001htpasswd\u3001none"}),"\n",(0,i.jsx)(r.li,{children:"ttl \u9ED8\u8BA4 168h - 7d"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"env"}),(0,i.jsx)(r.th,{children:"for"})]})}),(0,i.jsx)(r.tbody,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"REGISTRY_HTTP_SECRET"}),(0,i.jsx)(r.td,{})]})})]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"# -v $PWD/config.yml:/etc/docker/registry/config.yml \\\ndocker run --rm -it \\\n  -p 5000:5000 \\\n  -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io \\\n  -v $PWD/data:/var/lib/registry \\\n  --name registry registry:2\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"# \u6E05\u7406\n# -d dryrun, -m untagged\nregistry garbage-collect -d -m /etc/docker/registry/config.yml\n"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://github.com/distribution/distribution/blob/main/docs/spec/api.md",children:"https://github.com/distribution/distribution/blob/main/docs/spec/api.md"})}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"version: 0.1\nlog:\n  fields:\n    service: registry\nstorage:\n  cache:\n    blobdescriptor: inmemory\n  filesystem:\n    rootdirectory: /var/lib/registry\nhttp:\n  addr: :5000\n  headers:\n    X-Content-Type-Options: [nosniff]\nhealth:\n  storagedriver:\n    enabled: true\n    interval: 10s\n    threshold: 3\nproxy:\n  remoteurl: https://8x40wsit.mirror.aliyuncs.com\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"# /etc/docker/registry/config.yml\n# REGISTRY_variable\nstorage:\n  filesystem:\n    # REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY\n    rootdirectory: /var/lib/registry\n\n# \u955C\u50CF\nproxy:\n  remoteurl: https://registry-1.docker.io\n  username: [username]\n  password: [password]\n"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://docs.docker.com/registry/configuration/",children:"https://docs.docker.com/registry/configuration/"})}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"push-405",children:"PUSH 405"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u914D\u7F6E\u4E86 remoteurl push \u4F1A\u6709\u95EE\u9898"}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://github.com/distribution/distribution/issues/2386",children:"https://github.com/distribution/distribution/issues/2386"})}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"auth",children:"auth"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:'mkdir -p auth\ndocker run \\\n  --entrypoint htpasswd \\\n  httpd:2 -Bbn pusher pusher > auth/htpasswd\n\ndocker run -d \\\n  -p 5000:5000 \\\n  --restart=always \\\n  --name registry \\\n  -v "$(pwd)"/auth:/auth \\\n  -e "REGISTRY_AUTH=htpasswd" \\\n  -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \\\n  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \\\n  -v "$(pwd)"/certs:/certs \\\n  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\\n  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\\n  registry:2\n'})}),"\n",(0,i.jsx)(r.h2,{id:"apis",children:"apis"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://docs.docker.com/registry/spec/api",children:"Docker Registry HTTP API V2"})}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"# docker hub \u6240\u6709 tag\ncurl -L -s 'https://registry.hub.docker.com/v2/repositories/wener/base/tags?page_size=1024' | jq '.\"results\"[].name'\n\n# \u5224\u65AD tag \u662F\u5426\u5B58\u5728\ncurl --silent -f -lSL https://index.docker.io/v1/repositories/wener/base/tags/latest > /dev/null\n\n# \u5224\u65AD\u662F\u5426\u652F\u6301 v2\ncurl https://index.docker.io/v2/\n\n# \u68C0\u6D4B tag \u5B58\u5728\nDOCKER_CLI_EXPERIMENTAL=enabled docker manifest inspect wener/base:latest\n\nDOCKER_CLI_EXPERIMENTAL=enabled docker manifest inspect registry.cn-shanghai.aliyuncs.com/gcr-sync/cadvisor_cadvisor:v0.36.0\n"})}),"\n",(0,i.jsx)(r.h2,{id:"docker-registry-v1-vs-v2",children:"docker registry v1 vs v2"}),"\n",(0,i.jsx)(r.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(r.h2,{id:"local",children:"local"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"service:\n  registry:\n    image: registry:2\n    ports:\n      - '5000:5000'\n    volumes:\n      - registry_data:/var/lib/registry\n    environment:\n      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry\n    restart: always\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\n  "registry-mirrors": [],\n  "insecure-registries": ["localhost:5000"]\n}\n'})})]})}function h(e={}){let{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},917776:function(e,r,n){n.d(r,{R:()=>c,x:()=>d});var s=n(7378);let i={},t=s.createContext(i);function c(e){let r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(t.Provider,{value:r},e.children)}}}]);