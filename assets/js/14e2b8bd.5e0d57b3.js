"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["40538"],{20981:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>l,toc:()=>a,default:()=>o,metadata:()=>c,assets:()=>t,contentTitle:()=>h});var c=JSON.parse('{"id":"devops/web/cdn","title":"CDN","description":"- \u63A8\u8350 nginx - poor man\'s cdn.","source":"@site/../notes/devops/web/cdn.md","sourceDirName":"devops/web","slug":"/devops/web/cdn","permalink":"/notes/devops/web/cdn","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/cdn.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1743997463000,"frontMatter":{"title":"CDN"},"sidebar":"docs","previous":{"title":"Caddy V1","permalink":"/notes/devops/web/caddy/v1"},"next":{"title":"HAProxy","permalink":"/notes/devops/web/haproxy/"}}'),i=s(86106),r=s(17776);let l={title:"CDN"},h="CDN",t={},a=[{value:"Varnish",id:"varnish",level:2},{value:"NGINX",id:"nginx",level:2},{value:"HAProxy",id:"haproxy",level:2},{value:"HTTP Cache \u7C7B\u578B",id:"http-cache-types",level:2},{value:"Caching",id:"caching",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"cdn",children:"CDN"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u63A8\u8350 nginx - poor man's cdn."}),"\n",(0,i.jsx)(n.li,{children:"Reverse proxy cache - CDN"}),"\n"]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["varnish\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u9ED8\u8BA4\u5185\u5B58\u7F13\u5B58"}),"\n",(0,i.jsx)(n.li,{children:"\u53EF mmap \u4E3A\u6587\u4EF6 - \u6240\u6709\u7F13\u5B58\u5728\u4E00\u8D77 - \u91CD\u542F\u4F1A\u5931\u6548"}),"\n",(0,i.jsx)(n.li,{children:"pro \u7248\u672C\u66F4\u591A\u5B58\u50A8\u9009\u9879"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["nginx\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"proxy_cache_path"}),"\n",(0,i.jsx)(n.li,{children:"\u9010\u6587\u4EF6\u7F13\u5B58 - \u91CD\u542F\u540E\u8FD8\u662F\u6709\u6548"}),"\n",(0,i.jsx)(n.li,{children:"\u6587\u4EF6\u540D\u4E3A md5(cache_key)"}),"\n",(0,i.jsx)(n.li,{children:"\u9ED8\u8BA4 levels=3"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["haproxy - cache\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5185\u5B58\u7F13\u5B58"}),"\n",(0,i.jsx)(n.li,{children:"total-max-size"}),"\n",(0,i.jsx)(n.li,{children:"max-object-size"}),"\n",(0,i.jsx)(n.li,{children:"max-age"}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"http-request cache-use mycache"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"http-response cache-store mycache"})}),"\n",(0,i.jsxs)(n.li,{children:["Cache \u8981\u6C42\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"HTTP 1.1 GET 200"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["HTTP cache improvements ",(0,i.jsx)(n.a,{href:"https://github.com/haproxy/haproxy/issues/214",children:"haproxy#214"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/Pixboost/transformimgs",children:"Pixboost/transformimgs"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"MIT, Go"}),"\n",(0,i.jsx)(n.li,{children:"Image CDN, WebP, AVIF, JPEG XL"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/kevinanielsen/go-fast-cdn",children:"kevinanielsen/go-fast-cdn"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"MIT, Go"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/jiangwenyuan/nuster",children:"jiangwenyuan/nuster"})}),"\n",(0,i.jsxs)(n.li,{children:["\u5546\u4E1A\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/cdnjs/cdnjs",children:"cdnjs"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/jsdelivr/jsdelivr",children:"jsdelivr"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"varnish",children:"Varnish"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"varnishd -a 127.0.0.1:8080 -b 185.199.109.153:80 -T 127.0.0.1:6082 -d -S $PWD/varnish-secret\n# \u56E0\u4E3A -d \u6240\u4EE5\u9700\u8981\u624B\u52A8\u542F\u52A8\nvarnishadm -S $PWD/varnish-secret -T 127.0.0.1:6082 start\n\ncurl -H 'Host: wener.me' 127.0.0.1:8080\n"})}),"\n",(0,i.jsx)(n.h2,{id:"nginx",children:"NGINX"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"user nginx;\n\nworker_processes auto;\npcre_jit on;\nerror_log /dev/stdout warn;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n  # https://serverfault.com/a/912897\n  # HIT, MISS, BYPASS, EXPIRED\n  log_format cache_st '$remote_addr - $upstream_cache_status [$time_local]  '\n                    '\"$request\" $status $body_bytes_sent '\n                    '\"$http_referer\" \"$http_user_agent\"';\n  access_log /dev/stdout cache_st;\n\n  proxy_cache_path  /tmp/nginx-cache levels=1:2 keys_zone=static:8m max_size=1000m inactive=600m;\n  proxy_temp_path /tmp/nginx-cache-tmp;\n\n\n  server {\n    listen 8080;\n\n    location / {\n      proxy_pass http://185.199.109.153;\n      proxy_set_header Host $host;\n      proxy_cache static;\n      proxy_cache_valid  200 302  60m;\n      proxy_cache_valid  404      1m;\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"nginx -c $PWD/nginx.conf -g 'daemon off;'\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.sheshbabu.com/posts/nginx-caching-proxy/",children:"https://www.sheshbabu.com/posts/nginx-caching-proxy/"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"haproxy",children:"HAProxy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-haproxy",children:"frontend http\n  mode http\n  bind 0.0.0.0:8080 name v4\n  default_backend gh\nbackend gh\n  http-request cache-use mycache\n  http-response cache-store mycache\n  server svr 185.199.109.153:80 check\n\ncache mycache\n  total-max-size 4095   # MB\n  max-object-size 10000 # bytes\n  max-age 30            # seconds\n"})}),"\n",(0,i.jsx)(n.h2,{id:"http-cache-types",children:"HTTP Cache \u7C7B\u578B"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Page cache - \u901A\u5E38\u4E3A HTML"}),"\n",(0,i.jsx)(n.li,{children:"Browser cache - \u8D44\u6E90"}),"\n",(0,i.jsx)(n.li,{children:"Object cache - \u6570\u636E\u5E93\u67E5\u8BE2"}),"\n",(0,i.jsx)(n.li,{children:"Bytecode cache - PHP, JS"}),"\n",(0,i.jsx)(n.li,{children:"CDN cache - HTML, Image, CSS, JS"}),"\n",(0,i.jsx)(n.li,{children:"Reverse proxy cache - \u53D1\u751F\u5728\u53CD\u5411\u4EE3\u7406\u5C42"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"caching",children:"Caching"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Cloudflare\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u57FA\u4E8E extension \u7F13\u5B58\u800C\u4E0D\u662F mime\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u9ED8\u8BA4\u4E0D\u7F13\u5B58 html"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u53EF\u901A\u8FC7 Page Rule \u6DFB\u52A0\u7F13\u5B58\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u7F13\u5B58\u6240\u6709 - Page Rule\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"charts.wener.tech/*"})}),"\n",(0,i.jsx)(n.li,{children:"Cache Level: Cache Everything"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"\u9ED8\u8BA4\u4F1A\u7F13\u5B58 robots.txt"}),"\n",(0,i.jsxs)(n.li,{children:["CF-Cache-Status\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"DYNAMIC - \u8BA4\u4E3A\u662F\u52A8\u6001\u5185\u5BB9\uFF0C\u4E0D\u4F1A\u7F13\u5B58"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -I -H 'Host: charts.wener.tech' 185.199.108.153/wener/index.yaml\ncurl -I https://charts.wener.tech/wener/index.yaml\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Github Pages\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"CacheControl: max-age=600"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://gtmetrix.com/",children:"https://gtmetrix.com/"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://web.dev/measure/",children:"https://web.dev/measure/"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://pagespeed.web.dev/",children:"https://pagespeed.web.dev/"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://developers.cloudflare.com/cache/about/default-cache-behavior/",children:"https://developers.cloudflare.com/cache/about/default-cache-behavior/"})}),"\n"]})]})}function o(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},17776:function(e,n,s){s.d(n,{R:()=>l,x:()=>h});var c=s(7378);let i={},r=c.createContext(i);function l(e){let n=c.useContext(r);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function h(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),c.createElement(r.Provider,{value:n},e.children)}}}]);