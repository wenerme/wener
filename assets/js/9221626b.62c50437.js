"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["754690"],{11038:function(n,e,s){s.r(e),s.d(e,{frontMatter:()=>d,toc:()=>h,default:()=>a,metadata:()=>r,assets:()=>c,contentTitle:()=>l});var r=JSON.parse('{"id":"voip/asterisk/asterisk-network","title":"Asterisk Network","description":"Asterisk 11+ \u652F\u6301 ICE","source":"@site/../notes/voip/asterisk/asterisk-network.md","sourceDirName":"voip/asterisk","slug":"/voip/asterisk/network","permalink":"/notes/voip/asterisk/network","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/voip/asterisk/asterisk-network.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1617462276000,"frontMatter":{"title":"Asterisk Network"},"sidebar":"docs","previous":{"title":"Asterisk Monitoring","permalink":"/notes/voip/asterisk/monitor"},"next":{"title":"Asterisk QMI","permalink":"/notes/voip/asterisk/qmi"}}'),t=s(486106),i=s(917776);let d={title:"Asterisk Network"},l="Asterisk Network",c={},h=[{value:"sip.conf",id:"sipconf",level:2},{value:"nat",id:"nat-1",level:3},{value:"tcpdump",id:"tcpdump",level:2},{value:"wireshark",id:"wireshark",level:2},{value:"nftables \u8F6C\u53D1",id:"nftables-\u8F6C\u53D1",level:2},{value:"IPTables \u8F6C\u53D1",id:"iptables-\u8F6C\u53D1",level:2}];function o(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"asterisk-network",children:"Asterisk Network"})}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"Asterisk 11+ \u652F\u6301 ICE"}),"\n"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Asterisk \u662F B2BUA back-to-back user agent - \u4E0D\u662F SIP Proxy"}),"\n",(0,t.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.voip-info.org/asterisk-sip-nat",children:"Asterisk sip nat"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.voip-info.org/asterisk-firewall-rules",children:"Asterisk Firewall Rules"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://wiki.asterisk.org/wiki/display/AST/PJSIP+with+Proxies",children:"PJSIP with Proxies"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.asteriskguru.com/tutorials/sip_nat_oneway_or_no_audio_asterisk.html",children:"SIP with NAT or Firewalls"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.asterisk.org/sip-and-rtp-routing/",children:"SIP and RTP Routing"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://blog.csdn.net/SUKHOI27SMK/article/details/40107553",children:"https://blog.csdn.net/SUKHOI27SMK/article/details/40107553"})}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"port"}),(0,t.jsx)(e.th,{children:"desc"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"5060/udp"}),(0,t.jsx)(e.td,{children:"sip"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"5060/tcp"}),(0,t.jsx)(e.td,{children:"sip"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"4569/udp"}),(0,t.jsx)(e.td,{children:"IAX2"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"5036/udp"}),(0,t.jsx)(e.td,{children:"IAX"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"10000-20000/udp"}),(0,t.jsx)(e.td,{children:"RTP"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"2727/udp"}),(0,t.jsx)(e.td,{children:"MGCP"})]})]})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"nmap 192.168.1.1 -P0 -p 5060 -sU\n"})}),"\n",(0,t.jsx)(e.h1,{id:"nat",children:"NAT"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.voip-info.org/asterisk-sip-nat-solutions/",children:"Asterisk SIP NAT solutions"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"case"}),(0,t.jsx)(e.th,{children:"asterisk role"}),(0,t.jsx)(e.th,{children:"other"}),(0,t.jsx)(e.th,{children:"nat"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#1"}),(0,t.jsx)(e.td,{children:"client nat"}),(0,t.jsx)(e.td,{children:"outside sip"}),(0,t.jsx)(e.td,{children:"yes"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#2"}),(0,t.jsx)(e.td,{children:"client nat"}),(0,t.jsx)(e.td,{children:"inside sip"}),(0,t.jsx)(e.td,{children:"no"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#3"}),(0,t.jsx)(e.td,{children:"server nat"}),(0,t.jsx)(e.td,{children:"outside client"}),(0,t.jsx)(e.td,{children:"yes"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#4"}),(0,t.jsx)(e.td,{children:"server nat"}),(0,t.jsx)(e.td,{children:"outside client nat"}),(0,t.jsx)(e.td,{children:"yes"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#5"}),(0,t.jsx)(e.td,{children:"server nat"}),(0,t.jsx)(e.td,{children:"inside client"}),(0,t.jsx)(e.td,{children:"no"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#6"}),(0,t.jsx)(e.td,{children:"client"}),(0,t.jsx)(e.td,{children:"outside sip"}),(0,t.jsx)(e.td,{children:"no"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#7"}),(0,t.jsx)(e.td,{children:"client"}),(0,t.jsx)(e.td,{children:"inside sip"}),(0,t.jsx)(e.td,{children:"yes - #3"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#8"}),(0,t.jsx)(e.td,{children:"server nat"}),(0,t.jsx)(e.td,{children:"outside client"}),(0,t.jsx)(e.td,{children:"no"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"#9"}),(0,t.jsx)(e.td,{children:"server nat"}),(0,t.jsx)(e.td,{children:"inside client"}),(0,t.jsx)(e.td,{children:"yes"})]})]})]}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"SIP outside proxy"}),"\n",(0,t.jsx)(e.li,{children:"OK"}),"\n",(0,t.jsx)(e.li,{children:"1:1 \u7AEF\u53E3\u8F6C\u53D1"}),"\n",(0,t.jsx)(e.li,{children:"\u7AEF\u53E3\u8F6C\u53D1 + \u5BA2\u6237\u7AEF STUN"}),"\n",(0,t.jsx)(e.li,{children:"OK"}),"\n",(0,t.jsx)(e.li,{children:"OK"}),"\n",(0,t.jsx)(e.li,{children:"\u540C #3"}),"\n",(0,t.jsx)(e.li,{children:"OK"}),"\n",(0,t.jsx)(e.li,{children:"nat=yes, qualify=xxx, \u5BA2\u6237\u7AEF\u53EF\u4EE5 stun \u8F85\u52A9"}),"\n"]}),"\n",(0,t.jsx)(e.h1,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,t.jsx)(e.h2,{id:"sipconf",children:"sip.conf"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["asterisk ",(0,t.jsx)(e.a,{href:"https://github.com/asterisk/asterisk/blob/master/configs/samples/sip.conf.sample#L869",children:"nat support"})]}),"\n",(0,t.jsxs)(e.li,{children:["asterisk 1.8 ",(0,t.jsx)(e.a,{href:"https://github.com/asterisk/asterisk/blob/1.8/configs/sip.conf.sample#L761",children:"nat support"})]}),"\n",(0,t.jsx)(e.li,{children:"symmetric RTP"}),"\n",(0,t.jsx)(e.li,{children:"Asterisk will always send RTP packets from the same port number it expects to receive them on."}),"\n"]}),"\n",(0,t.jsx)(e.admonition,{type:"tip",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5EFA\u8BAE\u53EA\u5728 general \u914D\u7F6E nat \u76F8\u5173\u9009\u9879\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4E0D\u540C\u7684 nat \u914D\u7F6E\u53EF\u80FD\u76F8\u4E92\u5F71\u54CD"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"\u57FA\u7840\u670D\u52A1"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"[general]\nport = 5060\nbindaddr = 0.0.0.0\ncontext = error\nqualify = no\nsrvlookup = yes\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"[general]\n; \u533A\u5206 inside \u548C outside\n; \u5224\u65AD\u662F\u5426 NAT\nlocalnet=192.168.0.0/255.255.0.0\n; SIP \u548C SDP \u4F7F\u7528\u7684\u9759\u6001\u5730\u5740 - \u7AEF\u53E3\u9ED8\u8BA4\u4E3A udpbindaddr\n; hostname \u542F\u52A8\u65F6\u67E5\u8BE2\u4E00\u6B21\n; externip\nexternaddr = 12.34.56.78:9900\n; externtcpport = 9900\n; externtlsport = 12600\n\n; \u540C externaddr - \u6BCF\u9694 externrefresh(\u9ED8\u8BA4 10s) \u67E5\u8BE2\u4E00\u6B21 hostname\nexternhost = hostname[:port]\nexternrefresh = 10\n\n; no - use rport if remote request\n; force_rport - \u5F3A\u5236 rport - \u9ED8\u8BA4\n; yes - force_rport + comedia RTP\n; comedia - no + comedia RTP\n; comedia - connection-oriented media\nnat = force_rport\n\n; \u4FEE\u6539 audio, video, text \u7B49 SDP \u5730\u5740\nmedia_address =\n"})}),"\n",(0,t.jsx)(e.h3,{id:"nat-1",children:"nat"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["nat=yes\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Asterisk \u5FFD\u7565 SIP, SDP \u5934\u4E2D\u7684\u5730\u5740\u4FE1\u606F, \u76F4\u63A5\u8FD4\u56DE\u7ED9\u53D1\u9001\u8005\u7684 IP \u5730\u5740\u548C\u7AEF\u53E3"}),"\n",(0,t.jsxs)(e.li,{children:["\u5F3A\u5236 RFC 3581\uFF0C \u5F00\u542F ",(0,t.jsx)(e.a,{href:"https://www.voip-info.org/rtp-symmetric",children:"\u5BF9\u79F0 RTP"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["net=never - 2004 \u5E74 7 \u6708 29 \u6DFB\u52A0\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u7528\u4E8E UA/\u5BA2\u6237\u7AEF \u4E0D\u652F\u6301 rport \u5E38\u89C1"}),"\n",(0,t.jsx)(e.li,{children:"\u4E4B\u540E\u6DFB\u52A0 route \u9009\u9879 - \u6DFB\u52A0\u53C2\u6570\u63A7\u5236\u662F\u5426\u652F\u6301"}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"nat"}),(0,t.jsx)(e.th,{children:"rfc3581"}),(0,t.jsx)(e.th,{children:"Symmetric RTP"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"yes"}),(0,t.jsx)(e.td,{children:"force"}),(0,t.jsx)(e.td,{children:"enable"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"no"}),(0,t.jsx)(e.td,{children:"enable"}),(0,t.jsx)(e.td,{children:"disable"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"force_rport"}),(0,t.jsx)(e.td,{children:"force"}),(0,t.jsx)(e.td,{children:"disable"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"comedia"}),(0,t.jsx)(e.td,{children:"enable"}),(0,t.jsx)(e.td,{children:"enable"})]})]})]}),"\n",(0,t.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,t.jsx)(e.h2,{id:"tcpdump",children:"tcpdump"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# UDP\ntcpdump -n dst portrange 10000-11000\n\ntcpdump -i bond3 udp port 5060 or udp portrange 10000-20000\n"})}),"\n",(0,t.jsx)(e.h2,{id:"wireshark",children:"wireshark"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"ssh 192.168.1.2 sudo tcpdump -U -s0 'port 5060 or udp portrange 10000-20000' -i eth0 -w - | wireshark -k -i -\n"})}),"\n",(0,t.jsx)(e.h2,{id:"nftables-\u8F6C\u53D1",children:"nftables \u8F6C\u53D1"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:'# SIP\niifname "wan0" udp dport 5060 counter dnat to 192.168.1.2\niifname "wan0" tcp dport 5060 counter dnat to 192.168.1.2\n# RTP\niifname "wan0" udp dport 10000-20000 counter dnat to 192.168.1.2\n# IAX\niifname "wan0" udp dport 4569 counter dnat to 192.168.1.2\niifname "wan0" udp dport 5036 counter dnat to 192.168.1.2\n# MGCP\niifname "wan0" udp dport 2727 counter dnat to 192.168.1.2\n'})}),"\n",(0,t.jsx)(e.h2,{id:"iptables-\u8F6C\u53D1",children:"IPTables \u8F6C\u53D1"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# SIP\niptables -A INPUT -p udp -m udp --dport 5060 -j ACCEPT\niptables -A INPUT -p tcp -m tcp --dport 5060 -j ACCEPT\n\n# IAX2- the IAX protocol\niptables -A INPUT -p udp -m udp --dport 4569 -j ACCEPT\n# IAX\niptables -A INPUT -p udp -m udp --dport 5036 -j ACCEPT\n# RTP\niptables -A INPUT -p udp -m udp --dport 10000:20000 -j ACCEPT\n# MGCP\niptables -A INPUT -p udp -m udp --dport 2727 -j ACCEPT\n"})})]})}function a(n={}){let{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(o,{...n})}):o(n)}},917776:function(n,e,s){s.d(e,{R:()=>d,x:()=>l});var r=s(7378);let t={},i=r.createContext(t);function d(n){let e=r.useContext(i);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:d(n.components),r.createElement(i.Provider,{value:e},n.children)}}}]);