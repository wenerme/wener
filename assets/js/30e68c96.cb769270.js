"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["45746"],{95783:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>t,toc:()=>h,default:()=>o,metadata:()=>r,assets:()=>c,contentTitle:()=>s});var r=JSON.parse('{"id":"service/media/hardware-accel","title":"HW Accel","description":"| OS      | HW Acceleration         |","source":"@site/../notes/service/media/hardware-accel.md","sourceDirName":"service/media","slug":"/service/media/hardware-accel","permalink":"/notes/service/media/hardware-accel","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/media/hardware-accel.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1659031280000,"frontMatter":{"title":"HW Accel"},"sidebar":"docs","previous":{"title":"\u5B57\u5E55","permalink":"/notes/service/media/format/subtitle"},"next":{"title":"HEVC","permalink":"/notes/service/media/hevc"}}'),l=i(86106),d=i(17776);let t={title:"HW Accel"},s="HW Accel",c={},h=[{value:"FFmpeg",id:"ffmpeg",level:2},{value:"vaInitialize failed with error code 18",id:"vainitialize-failed-with-error-code-18",level:2},{value:"\u770B\u4E0D\u5230\u663E\u5361",id:"\u770B\u4E0D\u5230\u663E\u5361",level:2}];function a(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"hw-accel",children:"HW Accel"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"OS"}),(0,l.jsx)(n.th,{children:"HW Acceleration"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Linux"}),(0,l.jsx)(n.td,{children:"QSV, NVENC, AMF, VA-API"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Windows"}),(0,l.jsx)(n.td,{children:"QSV, NVENC, AMF"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"MacOS"}),(0,l.jsx)(n.td,{children:"VideoToolbox"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"RPi"}),(0,l.jsx)(n.td,{children:"V4L2"})]})]})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Vendor"}),(0,l.jsx)(n.th,{children:"HW Acceleration"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"NVIDIA"}),(0,l.jsx)(n.td,{children:"NVENC"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"AMD"}),(0,l.jsx)(n.td,{children:"AMF, VA-API"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Intel"}),(0,l.jsx)(n.td,{children:"QSV, VA-API"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Apple"}),(0,l.jsx)(n.td,{children:"VideoToolbox"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"RPi"}),(0,l.jsx)(n.td,{children:"V4L2"})]})]})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Project"}),(0,l.jsx)(n.th,{children:"Graphics Gen"}),(0,l.jsx)(n.th,{children:"Repo"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"oneVPL"}),(0,l.jsx)(n.td,{children:"gen12+"}),(0,l.jsxs)(n.td,{children:["\u200B",(0,l.jsx)(n.a,{href:"https://github.com/oneapi-src/oneVPL",children:"https://github.com/oneapi-src/oneVPL"})]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"iHD driver"}),(0,l.jsx)(n.td,{children:"gen8+"}),(0,l.jsxs)(n.td,{children:["\u200B",(0,l.jsx)(n.a,{href:"https://github.com/intel/media-driver",children:"https://github.com/intel/media-driver"})]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Libva"}),(0,l.jsx)(n.td,{children:"gen5+"}),(0,l.jsxs)(n.td,{children:["\u200B",(0,l.jsx)(n.a,{href:"https://github.com/intel/libva",children:"https://github.com/intel/libva"})]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"MSDK"}),(0,l.jsx)(n.td,{children:"gen8 ~ gen12(Rocket Lake)"}),(0,l.jsxs)(n.td,{children:["\u200B",(0,l.jsx)(n.a,{href:"https://github.com/Intel-Media-SDK/MediaSDK",children:"https://github.com/Intel-Media-SDK/MediaSDK"})]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"i965 driver"}),(0,l.jsx)(n.td,{children:"gen5 ~ gen9.5"}),(0,l.jsxs)(n.td,{children:["\u200B",(0,l.jsx)(n.a,{href:"https://github.com/intel/intel-vaapi-driver",children:"https://github.com/intel/intel-vaapi-driver"})]})]})]})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Intel QuickSync (QSV)\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u57FA\u4E8E VAAPI"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u6CA1\u6709\u786C\u89E3\u652F\u6301 H.264 / AVC 10-bit\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5347\u7EA7\u4E3A HEVC 10-bit"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["/usr/lib/dri/ - \u5B89\u88C5\u7684\u9A71\u52A8\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"iHD_drv_video.so"}),"\n",(0,l.jsx)(n.li,{children:"i965_drv_video.so"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"/dev/dri/render*"})," DRM render node"]}),"\n",(0,l.jsx)(n.li,{children:"i915"}),"\n",(0,l.jsx)(n.li,{children:"i965"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'cat /proc/cpuinfo | grep "model name" | uniq\n\napk add pciutils\nlspci -nn | egrep -i "3d|display|vga"\n\napk add lshw\nlshw -C display\nlshw -c video\n\napk add inxi\ninxi -G\n\n# i915_cur_delayinfo\nsudo sh -c \'cat /sys/kernel/debug/dri/*/name\'\n\n\nls /dev/dri\n\n# VA-API\n# ==========\n# AlpineLinux edge/testing libva-utils\napk -X https://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing add libva-utils\nvainfo\n# https://github.com/intel/libva-utils\n# /dev/dri/renderXX\n\n# Intel QSV\n# =============\napk add intel-media-driver libva-intel-driver\nsudo LIBVA_TRACE=/tmp/libva_trace.log DRI_PRIME=1 LIBVA_DRIVER_NAME=iHD vainfo\n\nLIBVA_TRACE=/tmp/libva_trace.log DRI_PRIME=1 LIBVA_DRIVER_NAME=iHD ffmpeg -loglevel verbose -init_hw_device vaapi\n\n# options i915 enable_guc=3\n# options i915 enable_fbc=1\necho "options i915 force_probe=4692" | sudo tee /etc/modprobe.d/i915.conf\n\n# GPU freq\nsudo find /sys -type f -name gt_cur* -print0\n\n# X11\n# ==========\n# apk add vdpauinfo\n# vdpauinfo\ngrep -iE \'vdpau | dri driver\' /var/log/Xorg.0.log\n\n# FFMpeg\n# =======\nffmpeg -hide_banner -decoders | grep qsv # \u5224\u65AD\u662F\u5426\u6709\u52A0\u901F\nffmpeg -hwaccel vaapi -vaapi_device /dev/dri/renderD128 -i "video.MP4" -vf "select=eq(pict_type\\,I)" -vsync vfr -qscale:v 2 -f image2 "%08d.jpg"\n'})}),"\n",(0,l.jsx)(n.h2,{id:"ffmpeg",children:"FFmpeg"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"{h264,hevc}_{videotoolbox,amf,vaapi}"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"videotoolbox - macOS"}),"\n",(0,l.jsx)(n.li,{children:"amf - Windows"}),"\n",(0,l.jsx)(n.li,{children:"vaapi - Linux - vainfo"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["-hwaccel auto\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"dxva2,cuda,d3d11va,videotoolbox"}),"\n",(0,l.jsx)(n.li,{children:"-hwaccel_device"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"ffmpeg -encoders | grep videotoolbox # \u652F\u6301\u7684 videotoolbox \u7F16\u7801\nffmpeg -h encoder=h264_videotoolbox  # \u67E5\u770B\u7F16\u7801\u5668\u9009\u9879\n\nffprobe in.mp4                           # \u5F04\u6E05\u695A\u539F\u59CB bitrate\nffmpeg -b:v 1900k -c:v h264_videotoolbox # -b:v \u5339\u914D\u539F\u59CB bitrate\n\n# \u4F7F\u7528 hwaccel \u65B9\u5F0F - \u5916\u7F6E GPU\nffmpeg \\\n  -hwaccel videotoolbox -i in.mp4 \\\n  -c:v libx265 -preset medium -crf 28 \\\n  -c:a copy \\\n  out.mp4\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["apple ",(0,l.jsx)(n.a,{href:"https://developer.apple.com/documentation/videotoolbox",children:"VideoToolbox"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Decode H.263, H.264, HEVC, MPEG1, MPEG2, MPEG4, ProRes"}),"\n",(0,l.jsx)(n.li,{children:"Encode H.264, HEVC, ProRes"}),"\n",(0,l.jsx)(n.li,{children:"\u4E0D\u652F\u6301 CRF/constant quality - \u5FC5\u987B\u6307\u5B9A -b:v"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://trac.ffmpeg.org/wiki/HWAccelIntro",children:"HWAccelIntro"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"macOS: VideoToolbox"}),"\n",(0,l.jsx)(n.li,{children:"OpenCL \u5927\u591A\u5E73\u53F0\u652F\u6301\uFF0C\u4F46\u662F\u4E0D\u53EF\u4EE5 encode/decode - \u7528\u4E8E Filtering"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://trac.ffmpeg.org/wiki/Hardware/QuickSync",children:"Hardware/QuickSync"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Intel_Quick_Sync_Video",children:"Intel Quick Sync Video"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u67E5\u770B Intel CPU \u652F\u6301\u7684\u7F16\u7801"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/List_of_Macintosh_models_grouped_by_CPU_type#Intel_x86",children:"List of Macintosh models grouped by CPU type"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u67E5\u770B Macbook \u5BF9\u5E94\u7684 Intel CPU \u7248\u672C"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/intel/media-driver",children:"intel/media-driver"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Intel(R) Media Driver for VAAPI"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/joshuaboniface/rffmpeg",children:"joshuaboniface/rffmpeg"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"remote SSH FFmpeg"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["archlinux ",(0,l.jsx)(n.a,{href:"https://wiki.archlinux.org/title/Hardware_video_acceleration",children:"Hardware video acceleration"})]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://jellyfin.org/docs/general/administration/hardware-acceleration.html",children:"https://jellyfin.org/docs/general/administration/hardware-acceleration.html"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/intel/intel-device-plugins-for-kubernetes",children:"intel/intel-device-plugins-for-kubernetes"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.techspot.com/article/1131-hevc-h256-enconding-playback/",children:"https://www.techspot.com/article/1131-hevc-h256-enconding-playback/"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.elpamsoft.com/?p=Plex-Hardware-Transcoding",children:"https://www.elpamsoft.com/?p=Plex-Hardware-Transcoding"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/intel/vaapi-bypass",children:"intel/vaapi-bypass"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"vainitialize-failed-with-error-code-18",children:"vaInitialize failed with error code 18"}),"\n",(0,l.jsx)(n.h2,{id:"\u770B\u4E0D\u5230\u663E\u5361",children:"\u770B\u4E0D\u5230\u663E\u5361"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5C1D\u8BD5\u8C03\u6574 BIOS - \u4FEE\u6539\u4E3A\u53EF\u5207\u6362\u663E\u5361"}),"\n"]})]})}function o(e={}){let{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},17776:function(e,n,i){i.d(n,{R:()=>t,x:()=>s});var r=i(7378);let l={},d=r.createContext(l);function t(e){let n=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),r.createElement(d.Provider,{value:n},e.children)}}}]);