"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["89989"],{42773:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>l,toc:()=>o,default:()=>h,metadata:()=>r,assets:()=>d,contentTitle:()=>c});var r=JSON.parse('{"id":"devops/web/traefik/traefik-v1","title":"Traefik V1","description":"Docker","source":"@site/../notes/devops/web/traefik/traefik-v1.md","sourceDirName":"devops/web/traefik","slug":"/devops/web/traefik/v1","permalink":"/notes/devops/web/traefik/v1","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/traefik/traefik-v1.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1717644328000,"frontMatter":{"title":"Traefik V1"},"sidebar":"docs","previous":{"title":"Traefik","permalink":"/notes/devops/web/traefik/"},"next":{"title":"Tyk","permalink":"/notes/devops/web/tyk"}}'),t=s(86106),i=s(17776);let l={title:"Traefik V1"},c="Traefik V1",d={},o=[{value:"Docker",id:"docker",level:2},{value:"\u57FA\u672C\u6982\u5FF5",id:"\u57FA\u672C\u6982\u5FF5",level:2},{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"admin",id:"admin",level:2}];function a(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"traefik-v1",children:"Traefik V1"})}),"\n",(0,t.jsx)(n.h2,{id:"docker",children:"Docker"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u7B80\u5355\u542F\u52A8\ndocker run --rm -it -p 443:443 -p 80:80 -p 8080:8080 traefik --accesslog -l INFO --web\n# \u4F7F\u7528 consul\ndocker run --rm -it -p 443:443 -p 80:80 -p 8080:8080 traefik --accesslog -l INFO --web --consul.endpoint=consul:8500\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u57FA\u672C\u6982\u5FF5",children:"\u57FA\u672C\u6982\u5FF5"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5165\u53E3\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"http"}),"\n",(0,t.jsx)(n.li,{children:"https"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u524D\u7AEF\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5B9A\u4E49\u4ECE\u5165\u53E3\u8FDB\u5165\u7684\u8BF7\u6C42\u5982\u4F55\u8F6C\u53D1\u5230\u540E\u7AEF"}),"\n",(0,t.jsxs)(n.li,{children:["\u6CE8\u610F, \u6B63\u5219\u91CC\u7684\u540D\u5B57\u5E76\u6CA1\u6709\u4EFB\u4F55\u610F\u4E49, \u53EA\u662F\u56E0\u4E3A\u4F9D\u8D56\u7684 ",(0,t.jsx)(n.a,{href:"https://github.com/gorilla/mux",children:"gorilla/mux"})," \u8981\u6C42\u5FC5\u987B\u8981\u6709"]}),"\n",(0,t.jsxs)(n.li,{children:["\u53EF\u4EE5\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:"passHostHeader"})," \u5C06\u5934\u5B8C\u5168\u4F20\u9012\u5230\u540E\u7AEF"]}),"\n",(0,t.jsxs)(n.li,{children:["\u53EF\u4EE5\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:"passTLSCert"})," \u5C06\u5BA2\u6237\u7AEF\u8BC1\u4E66\u4E5F\u8F6C\u53D1\u5230\u540E\u7AEF"]}),"\n",(0,t.jsxs)(n.li,{children:["\u9ED8\u8BA4\u4F18\u5148\u7EA7\u4E3A\u89C4\u5219\u957F\u5EA6\u7684\u53CD\u5E8F, \u907F\u514D\u8DEF\u5F84\u91CD\u53E0, \u53EF\u4EE5\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:"priority"})," \u4FEE\u6539"]}),"\n",(0,t.jsx)(n.li,{children:"\u53EF\u4EE5\u6DFB\u52A0\u81EA\u5B9A\u4E49\u5934"}),"\n",(0,t.jsxs)(n.li,{children:["\u5B89\u5168\u76F8\u5173\u7684\u5934\u53EF\u4EE5\u4F7F\u7528\u7B80\u5316\u7684\u65B9\u5F0F\u542F\u7528\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/unrolled/secure#available-options",children:"unrolled/secure#available-options"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Modifiers\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u4E0D\u7BA1\u987A\u5E8F\u600E\u4E48\u6837, \u4F1A\u5728 ",(0,t.jsx)(n.code,{children:"Matchers"})," \u4E4B\u540E\u6267\u884C"]}),"\n",(0,t.jsx)(n.li,{children:"\u4FEE\u6539\u8BF7\u6C42, \u4E0D\u5F71\u54CD\u8DEF\u7531"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"AddPrefix: /products"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"ReplacePath: /serverless-path"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u66FF\u6362\u8DEF\u5F84\u5E76\u6DFB\u52A0 ",(0,t.jsx)(n.code,{children:"X-Replaced-Path"})," \u5934"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Matchers\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5B9A\u4E49\u8BF7\u6C42\u5982\u4F55\u8F6C\u53D1\u5230\u540E\u7AEF"}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:","})," \u5206\u9694\u7B26\u7528\u4E8E\u5B9A\u4E49\u591A\u4E2A ",(0,t.jsx)(n.code,{children:"\u6216"})," \u6761\u4EF6"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:";"})," \u5B9A\u4E49\u591A\u4E2A ",(0,t.jsx)(n.code,{children:"\u4E0E"})," \u6761\u4EF6"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Headers: Content-Type, application/json"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5934\u5339\u914D, \u63A5\u53D7\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:","})," \u5206\u5272\u7684 kv \u503C"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"HeadersRegexp: Content-Type, application/(text/json)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5934\u5339\u914D, \u63A5\u53D7\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:","})," \u5206\u5272\u7684 kv \u503C"]}),"\n",(0,t.jsx)(n.li,{children:"\u503C\u53EF\u4EE5\u4E3A\u6B63\u5219"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Host: traefik.io, www.traefik.io"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"HostRegexp: traefik.io, {subdomain:[a-z]+}.traefik.io"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Method: GET, POST, PUT"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Path: /products/, /articles/{category}/{id:[0-9]+}"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"PathStrip: /products/"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u8DEF\u5F84\u5B8C\u5168\u5339\u914D, \u8F6C\u53D1\u5230\u540E\u7AEF\u7684\u65F6\u5019\u4F1A\u53BB\u6389\u8DEF\u5F84"}),"\n",(0,t.jsxs)(n.li,{children:["\u4F1A\u5C06\u539F\u8DEF\u5F84\u4FDD\u5B58\u5230 ",(0,t.jsx)(n.code,{children:"X-Forwarded-Prefix"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"PathStripRegex: /articles/{category}/{id:[0-9]+}"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"PathPrefix: /products/, /articles/{category}/{id:[0-9]+}"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"PathPrefixStrip: /products/"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"PathPrefixStripRegex: /articles/{category}/{id:[0-9]+}"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"Query: foo=bar, bar=baz"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u540E\u7AEF\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5C06\u524D\u7AEF\u7684\u8BF7\u6C42\u8D1F\u8F7D\u5230\u4E00\u7EC4\u670D\u52A1\u5668"}),"\n",(0,t.jsxs)(n.li,{children:["\u8D1F\u8F7D\u65B9\u5F0F\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"wrr \u57FA\u4E8E\u6743\u91CD\u7684\u8F6E\u8BE2"}),"\n",(0,t.jsx)(n.li,{children:"drr \u52A8\u6001\u8F6E\u8BE2"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u652F\u6301\u7194\u65AD\u673A\u5236\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u65B9\u6CD5: LatencyAtQuantileMS, NetworkErrorRatio, ResponseCodeRatio"}),"\n",(0,t.jsx)(n.li,{children:"\u64CD\u4F5C: AND, OR, EQ, NEQ, LT, LE, GT, GE"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6700\u5927\u8FDE\u63A5\u6570\u63A7\u5236\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5BF9\u94FE\u63A5\u5206\u7EC4\u53EF\u4EE5\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:"request.host"})," , ",(0,t.jsx)(n.code,{children:"client.ip"}),", ",(0,t.jsx)(n.code,{children:"request.header.ANY_HEADER"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u8FBE\u5230\u9600\u503C\u4F1A\u8FD4\u56DE ",(0,t.jsx)(n.code,{children:"429 Too Many Requests"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u7C98\u6027\u4F1A\u8BDD, \u9700\u8981\u6307\u5B9A ",(0,t.jsx)(n.code,{children:"cookieName"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u5065\u5EB7\u68C0\u67E5\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u53EF\u6307\u5B9A\u8DEF\u5F84, \u95F4\u9694, \u7AEF\u53E3, \u8981\u6C42\u662F http"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u670D\u52A1\u5B9A\u4E49\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u4E3B\u8981\u4E3A url, \u8DEF\u5F84\u53EF\u4EE5\u5728 Modifier \u4E2D\u6307\u5B9A"}),"\n",(0,t.jsx)(n.li,{children:"\u53EF\u4EE5\u6307\u5B9A weight"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'# \u5165\u53E3\u5B9A\u4E49\n[entryPoints]\n  [entryPoints.http]\n  address = ":80"\n    # \u5F3A\u5236\u8DF3\u8F6C\u5230 https\n    [entryPoints.http.redirect]\n    entryPoint = "https"\n    # url \u91CD\u5199\n    [entryPoints.http.redirect]\n    regex = "^http://localhost/(.*)"\n    replacement = "http://mydomain/$1"\n\n  [entryPoints.https]\n  address = ":443"\n  [entryPoints.https.tls]\n  clientCAFiles = ["tests/clientca1.crt", "tests/clientca2.crt"]\n    [entryPoints.https.tls]\n      [[entryPoints.https.tls.certificates]]\n      certFile = "tests/traefik.crt"\n      keyFile = "tests/traefik.key"\n\n# \u524D\u7AEF\n[frontends]\n  # \u5B9A\u4E49\u4E00\u4E2A\u524D\u7AEF\n  [frontends.frontend1]\n  # \u6307\u5B9A\u540E\u7AEF\n  backend = "backend2"\n    # \u5B9A\u4E49\u8DEF\u7531\u89C4\u5219\n    [frontends.frontend1.routes.test_1]\n    rule = "Host:test.localhost,test2.localhost"\n    # \u53EF\u4EE5\u4F7F\u7528\u81EA\u5B9A\u4E49\u5934\n    [frontends.frontend1.headers.customresponseheaders]\n    X-Custom-Response-Header = "True"\n    [frontends.frontend1.headers.customrequestheaders]\n    X-Script-Name = "test"\n  # \u5B9A\u4E49\u4E86\u4E00\u4E2A\u524D\u7AEF\n  [frontends.frontend2]\n  # \u5747\u76F4\u63A5\u8F6C\u53D1\n  backend = "backend1"\n  passHostHeader = true\n  passTLSCert = true\n  # \u6307\u5B9A\u4F18\u5148\u7EA7\n  priority = 10\n  entrypoints = ["https"] # overrides defaultEntryPoints\n    [frontends.frontend2.routes.test_1]\n    rule = "HostRegexp:localhost,{subdomain:[a-z]+}.localhost"\n  [frontends.frontend3]\n  backend = "backend2"\n    # \u89C4\u5219\u53EF\u4EE5\u5199\u5728\u4E00\u8D77\u4E5F\u53EF\u4EE5\u5206\u5F00\u5199\n    [frontends.frontend3.routes.test_1]\n    rule = "Host:test3.localhost;Path:/test"\n    [frontends.frontend3.routes.test_2]\n    rule = "Query: test=1"\n\n# \u540E\u7AEF\n[backends]\n  [backends.backend1]\n    # \u5B9A\u4E49\u7194\u65AD\u673A\u5236\n    [backends.backend1.circuitbreaker]\n    expression = "NetworkErrorRatio() > 0.5"\n    # \u8BBE\u7F6E\u6700\u5927\u8FDE\u63A5\u6570\n    [backends.backend1.maxconn]\n    amount = 10\n    extractorfunc = "request.host"\n    # \u5B9A\u4E49\u540E\u7AEF\u670D\u52A1\n    [backends.backend1.servers.server1]\n    url = "http://172.17.0.2:80"\n    weight = 10\n    [backends.backend1.servers.server2]\n    url = "http://172.17.0.3:80"\n    weight = 1\n    # \u5B9A\u4E49\u5065\u5EB7\u68C0\u67E5\n    [backends.backend1.healthcheck]\n    path = "/health"\n    interval = "10s"\n    port = 8080\n  [backends.backend2]\n    # \u8BBE\u7F6E\u8D1F\u8F7D\u65B9\u5F0F\n    [backends.backend2.LoadBalancer]\n    method = "drr"\n    [backends.backend2.loadbalancer.stickiness]\n    # \u5B9A\u4E49\u7C98\u6027\u4F1A\u8BDD\n    # \u53EF\u9009, \u9ED8\u8BA4\u4E3A sha1 \u516D\u4F4D\u5B57\u7B26\n    cookieName = "my_cookie"\n    [backends.backend2.servers.server1]\n    url = "http://172.17.0.4:80"\n    weight = 1\n    [backends.backend2.servers.server2]\n    url = "http://172.17.0.5:80"\n    weight = 2\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u914D\u7F6E\u8DEF\u5F84\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"/etc/traefik/"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"$HOME/.traefik/"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"."})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'# \u5168\u5C40\u914D\u7F6E\ndebug=false\n# "DEBUG", "INFO", "WARN", "ERROR", "FATAL", "PANIC"\nlogLevel = "ERROR"\n# \u524D\u7AEF\u672A\u6307\u5B9A entrypoint \u7684\u9ED8\u8BA4\u503C\ndefaultEntryPoints = ["http"]\n\n# \u5B89\u5168\u505C\u6B62\u7684\u8D85\u65F6\u65F6\u95F4\ngraceTimeOut = "10s"\n\n# \u95F4\u9694\u68C0\u6D4B\u65B0\u7248\u672C\ncheckNewVersion = false\n\n# Backends throttle duration.\nProvidersThrottleDuration = "2s"\n\n# Controls the maximum idle (keep-alive) connections to keep per-host.\nMaxIdleConnsPerHost = 200\n\n# If set to true invalid SSL certificates are accepted for backends.\n# This disables detection of man-in-the-middle attacks so should only be used on secure backend networks.\nInsecureSkipVerify = true\n\n# Register Certificates in the RootCA.\nRootCAs = [ "/mycert.cert" ]\n\n# \u65E5\u5FD7\u914D\u7F6E\n[traefikLog]\n# \u9ED8\u8BA4\u4E3A os.Stdout\n# \u5982\u679C\u8DEF\u5F84\u4E0D\u5B58\u5728\u4F1A\u521B\u5EFA\nfilePath = "log/traefik.log"\n# \u683C\u5F0F\u53EF\u4EE5\u4E3A json \u548C common\nformat = "common"\n\n\n# \u8BBF\u95EE\u65E5\u5FD7\n[accessLog]\n# \u9ED8\u8BA4\u4E3A os.Stdout\nfilePath = "/path/to/log/log.txt"\n# \u9ED8\u8BA4\u4E3A common log format - clf\nformat = "common"\n\n# \u6587\u4EF6\u914D\u7F6E\n[file]\n# \u6587\u4EF6\u5F15\u5165\nfilename = "rules.toml"\n# \u914D\u7F6E\u76EE\u5F55\ndirectory = "/path/to/config/"\n# \u68C0\u6D4B\u6539\u53D8\nwatch=true\n\n\n# \u6700\u5C0F\u5316\u914D\u7F6E\n[entryPoints]\n  [entryPoints.http]\n  address = ":8080"\n[web]\naddress=":8081"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"admin",children:"admin"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u5065\u5EB7\u68C0\u67E5\n# \u53EF\u4EE5\u4F7F\u7528 -c \u6307\u5B9A\u914D\u7F6E\u6587\u4EF6\ntraefik healthcheck\n# \u5C06\u5F02\u5E38\u63D0\u4EA4\u5230 github\ntraefik bug\n"})})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},17776:function(e,n,s){s.d(n,{R:()=>l,x:()=>c});var r=s(7378);let t={},i=r.createContext(t);function l(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);