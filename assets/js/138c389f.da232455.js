"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["64637"],{8496:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>t,toc:()=>h,default:()=>a,metadata:()=>s,assets:()=>d,contentTitle:()=>c});var s=JSON.parse('{"id":"service/auth/keycloak/keycloak-authz","title":"Keycloak Authz","description":"- \u6388\u6743\u670D\u52A1","source":"@site/../notes/service/auth/keycloak/keycloak-authz.md","sourceDirName":"service/auth/keycloak","slug":"/service/auth/keycloak/authz","permalink":"/notes/service/auth/keycloak/authz","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/auth/keycloak/keycloak-authz.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1688206885000,"frontMatter":{"title":"Keycloak Authz"},"sidebar":"docs","previous":{"title":"Keycloak AuthN","permalink":"/notes/service/auth/keycloak/authn"},"next":{"title":"Keycloak Awesome","permalink":"/notes/service/auth/keycloak/awesome"}}'),r=i(86106),l=i(17776);let t={title:"Keycloak Authz"},c="Keycloak Authz",d={},h=[{value:"PEP",id:"pep",level:2},{value:"UMA",id:"uma",level:2},{value:"Example",id:"example",level:2},{value:"Permission",id:"permission",level:2}];function o(n){let e={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"keycloak-authz",children:"Keycloak Authz"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/",children:"\u6388\u6743\u670D\u52A1"})}),"\n",(0,r.jsxs)(e.li,{children:["\u8BBF\u95EE\u63A7\u5236\u65B9\u5F0F / Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"ABAC - Attribute-based access control - \u57FA\u4E8E\u5C5E\u6027"}),"\n",(0,r.jsx)(e.li,{children:"RBAC- Role-based access control - \u57FA\u4E8E\u89D2\u8272"}),"\n",(0,r.jsx)(e.li,{children:"UBAC - User-based access control - \u57FA\u4E8E\u7528\u6237"}),"\n",(0,r.jsx)(e.li,{children:"CBAC - Context-based access control - \u57FA\u4E8E\u4E0A\u4E0B\u6587"}),"\n",(0,r.jsxs)(e.li,{children:["Rule-based access control - \u57FA\u4E8E\u89C4\u5219\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u4F7F\u7528 JavaScript"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"Time-based access control - \u57FA\u4E8E\u65F6\u95F4"}),"\n",(0,r.jsx)(e.li,{children:"\u901A\u8FC7\u7B56\u7565 SPI (Service Provider Interface) \u81EA\u5B9A\u4E49\u8BBF\u95EE\u63A7\u5236\u673A\u5236 (ACMs - access control mechanisms)"}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"abbr"}),(0,r.jsx)(e.th,{children:"detail"}),(0,r.jsx)(e.th,{children:"role"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"PAP"}),(0,r.jsx)(e.td,{children:"Policy Administration Point"}),(0,r.jsx)(e.td,{children:"Admin UI"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"PDP"}),(0,r.jsx)(e.td,{children:"Policy Decision Point"}),(0,r.jsx)(e.td,{children:"Authorization Services"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"PEP"}),(0,r.jsx)(e.td,{children:"Policy Enforcement Point"}),(0,r.jsx)(e.td,{children:"\u8BF7\u6C42\u62E6\u622A"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"PIP"}),(0,r.jsx)(e.td,{children:"Policy Information Point"}),(0,r.jsx)(e.td,{children:"\u7B56\u7565\u4FE1\u606F"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"RTP"}),(0,r.jsx)(e.td,{children:"Requesting party token"}),(0,r.jsx)(e.td,{})]})]})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6388\u6743\u6D41\u7A0B\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u8D44\u6E90\u7BA1\u7406\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u521B\u5EFA\u8D44\u6E90\u670D\u52A1 / Resource Server"}),"\n",(0,r.jsxs)(e.li,{children:["\u521B\u5EFA\u8D44\u6E90 / Resource\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4F8B\u5982 URL PATH, UUID, ID"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u521B\u5EFA\u548C\u5173\u8054\u8D44\u6E90\u57DF / Scope\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4E00\u822C\u5173\u8054 Action+Resource"}),"\n",(0,r.jsx)(e.li,{children:"\u53EF\u4EE5\u901A\u8FC7\u8D44\u6E90\u5C5E\u6027\u5B9A\u4E49"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u6743\u9650\u548C\u7B56\u7565\u7BA1\u7406\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u521B\u5EFA\u7B56\u7565 / Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4F8B\u5982 \u8981\u6C42\u5339\u914D \u8D44\u6E90\u548C Scope"}),"\n",(0,r.jsx)(e.li,{children:"\u652F\u6301 JavaScript \u5B9A\u4E49\u7B56\u7565"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u5B9A\u4E49\u6743\u9650 / Permission\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Resource + Scope + Policy -> grant/deny"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"\u5E94\u7528\u7B56\u7565\u5230\u6743\u9650"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Policy Enforcement\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5728\u670D\u52A1\u4E2D\u6DFB\u52A0\u62E6\u622A\uFF0C\u8BF7\u6C42 Keycloak \u8FDB\u884C\u9274\u6743"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/#_service_overview",children:"Authorization Services"})," - \u6388\u6743\u670D\u52A1 - \u63D0\u4F9B\u63A5\u53E3\u7ED9\u540E\u7AEF\u8FDB\u884C\u6743\u9650\u4EA4\u4E92\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Token Endpoint\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Token \u5305\u542B\u7B56\u7565\u4FE1\u606F"}),"\n",(0,r.jsx)(e.li,{children:"RPT - Requesting Party Token"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Resource Management Endpoint\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u8D44\u6E90\u7BA1\u7406 - \u521B\u5EFA\u3001\u5220\u9664\u3001FindByID\u3001Query"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Permission Management Endpoint\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Issue Permission Tickets"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u8D44\u6E90/Protection API\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6EE1\u8DB3 ",(0,r.jsx)(e.a,{href:"https://docs.kantarainitiative.org/uma/wg/oauth-uma-federated-authz-2.0-09.html",children:"UMA"})," \u89C4\u8303\u5B9A\u4E49\u7684\u8D44\u6E90\u6807\u8BC6\u7B26"]}),"\n",(0,r.jsx)(e.li,{children:"\u9700\u8981 uma_protection scope"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u6743\u9650/Permission\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u6743\u9650\u51B3\u7B56\u7B56\u7565\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Unanimous - \u9ED8\u8BA4 - \u6240\u6709\u90FD\u5141\u8BB8"}),"\n",(0,r.jsx)(e.li,{children:"Affirmative - \u81F3\u5C11\u4E00\u4E2A\u5141\u8BB8"}),"\n",(0,r.jsx)(e.li,{children:"Consensus - \u81F3\u5C11\u4E00\u534A\u4EE5\u4E0A\u5141\u8BB8"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-js",children:"// \u62D2\u7EDD\n$evaluation.deny();\n// \u5141\u8BB8\n$evaluation.grant();\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public interface Evaluation {\n\n    /**\n     * Returns the {@link ResourcePermission} to be evaluated.\n     *\n     * @return the permission to be evaluated\n     */\n    ResourcePermission getPermission();\n\n    /**\n     * Returns the {@link EvaluationContext}. Which provides access to the whole evaluation runtime context.\n     *\n     * @return the evaluation context\n     */\n    EvaluationContext getContext();\n\n    /**\n     * Returns a {@link Realm} that can be used by policies to query information.\n     *\n     * @return a {@link Realm} instance\n     */\n    Realm getRealm();\n\n    /**\n     * Grants the requested permission to the caller.\n     */\n    void grant();\n\n    /**\n     * Denies the requested permission.\n     */\n    void deny();\n}\n\npublic interface EvaluationContext {\n    /**\n     * Returns the {@link Identity} that represents an entity (person or non-person) to which the permissions must be granted, or not.\n     *\n     * @return the identity to which the permissions must be granted, or not\n     */\n    Identity getIdentity();\n    /**\n     * Returns all attributes within the current execution and runtime environment.\n     *\n     * @return the attributes within the current execution and runtime environment\n     */\n    Attributes getAttributes();\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Attributes"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"name"}),(0,r.jsx)(e.th,{children:"type"}),(0,r.jsx)(e.th,{children:"desc"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"kc.time.date_time"}),(0,r.jsx)(e.td,{children:"String"}),(0,r.jsx)(e.td,{children:"Current date and time - MM/dd/yyyy hh:mm:ss"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"kc.client.network.ip_address"}),(0,r.jsx)(e.td,{children:"String"}),(0,r.jsx)(e.td,{children:"IPv4 address of the client"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"kc.client.network.host"}),(0,r.jsx)(e.td,{children:"String"}),(0,r.jsx)(e.td,{children:"Client\u2019s host name"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"kc.client.id"}),(0,r.jsx)(e.td,{children:"String"}),(0,r.jsx)(e.td,{children:"The client id"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"kc.client.user_agent"}),(0,r.jsx)(e.td,{children:"String[]"}),(0,r.jsx)(e.td,{children:"The value of the 'User-Agent' HTTP header"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"kc.realm.name"}),(0,r.jsx)(e.td,{children:"String"}),(0,r.jsx)(e.td,{children:"The name of the realm"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"pep",children:"PEP"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/#_enforcer_overview",children:"Policy Enforcers"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"uma",children:"UMA"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/index.html#_service_authorization_uma_policy_api",children:"Managing Resource Permissions using the Policy API"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"http://${host}:${port}/auth/realms/${realm_name}/authz/protection/uma-policy/{resource_id}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"example",children:"Example"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/keycloak/keycloak-quickstarts/blob/latest/app-authz-uma-photoz/photoz-realm.json",children:"https://github.com/keycloak/keycloak-quickstarts/blob/latest/app-authz-uma-photoz/photoz-realm.json"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Resource"}),(0,r.jsx)(e.th,{children:"Type"}),(0,r.jsx)(e.th,{children:"URI"}),(0,r.jsx)(e.th,{children:"Scopes"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Admin Resources"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.a,{href:"http://photoz.com/admin",children:"http://photoz.com/admin"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"/admin/*"})}),(0,r.jsx)(e.td,{children:"admin:manage"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"User Profile Resource"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.a,{href:"http://photoz.com/profile",children:"http://photoz.com/profile"})}),(0,r.jsx)(e.td,{children:"/profile"}),(0,r.jsx)(e.td,{children:"profile:view"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Album Resource"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.a,{href:"http://photoz.com/album",children:"http://photoz.com/album"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"/album/*"})}),(0,r.jsxs)(e.td,{children:["album:delete",(0,r.jsx)(e.br,{}),"album:view"]})]})]})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Policies"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Only Owner and Administrators Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=aggregate AFFIRMATIVE"}),"\n",(0,r.jsx)(e.li,{children:"Administration Policy,Only Owner Policy"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Administration Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=aggregate"}),"\n",(0,r.jsx)(e.li,{children:"Any Admin Policy,Only From a Specific Client Address"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Only Owner Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"script-only-owner.js"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Any Admin Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=role logic=POSITIVE"}),"\n",(0,r.jsx)(e.li,{children:"roles=admin"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Only From a Specific Client Address\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"script-only-keycloak-domain-or-admin.js"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Any User Policy\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=role logic=POSITIVE"}),"\n",(0,r.jsx)(e.li,{children:"roles=user,photoz-restful-api/manage-albums"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Admin Resource Permission\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=resource logic=POSITIVE"}),"\n",(0,r.jsxs)(e.li,{children:["defaultResourceType=",(0,r.jsx)(e.a,{href:"http://photoz.com/admin",children:"http://photoz.com/admin"})]}),"\n",(0,r.jsx)(e.li,{children:"default=true"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Album Resource Permission\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=scope logic=POSITIVE"}),"\n",(0,r.jsx)(e.li,{children:"scopes=album:view,album:delete"}),"\n",(0,r.jsx)(e.li,{children:"resources=Album Resource"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["View User Permission\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"type=scope logic=POSITIVE"}),"\n",(0,r.jsx)(e.li,{children:"scopes=profile:view"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"permission",children:"Permission"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'{\n  "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",\n  "audience:": "resource_server_client_id",\n  "permission": ["Resource A#Scope A"],\n  "ticket": "permission_ticket"\n}\n'})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'{\n  "access_token": "${rpt}"\n}\n'})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Requesting party token"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'{\n  "authorization": {\n    "permissions": [\n      {\n        "resource_set_id": "d2fe9843-6462-4bfc-baba-b5787bb6e0e7",\n        "resource_set_name": "Hello World Resource"\n      }\n    ]\n  }\n}\n'})})]})}function a(n={}){let{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(o,{...n})}):o(n)}},17776:function(n,e,i){i.d(e,{R:()=>t,x:()=>c});var s=i(7378);let r={},l=s.createContext(r);function t(n){let e=s.useContext(l);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),s.createElement(l.Provider,{value:e},n.children)}}}]);