"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["808881"],{433160:function(e,r,s){s.r(r),s.d(r,{frontMatter:()=>c,toc:()=>l,default:()=>h,metadata:()=>n,assets:()=>d,contentTitle:()=>o});var n=JSON.parse('{"id":"devops/kubernetes/distro/k3s/k3d","title":"K3S in Docker","description":"- rancher/k3d - \u5BB9\u5668\u8FD0\u884C","source":"@site/../notes/devops/kubernetes/distro/k3s/k3d.md","sourceDirName":"devops/kubernetes/distro/k3s","slug":"/devops/kubernetes/distro/k3s/k3d","permalink":"/notes/devops/kubernetes/distro/k3s/k3d","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/distro/k3s/k3d.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1758158840000,"frontMatter":{"title":"K3S in Docker"},"sidebar":"docs","previous":{"title":"K3S","permalink":"/notes/devops/kubernetes/distro/k3s/"},"next":{"title":"Centos","permalink":"/notes/devops/kubernetes/distro/k3s/centos"}}'),t=s(486106),i=s(917776);let c={title:"K3S in Docker"},o="K3S in Docker",d={},l=[{value:"Registry",id:"registry",level:2},{value:"macOS",id:"macos",level:2},{value:"Failed Cluster Start: error during post-start cluster preparation: error overwriting contents of /etc/hosts: Exec process in node &#39;k3d-dev-server-0&#39; failed with exit code &#39;139&#39;: Logs from failed access process:",id:"failed-cluster-start-error-during-post-start-cluster-preparation-error-overwriting-contents-of-etchosts-exec-process-in-node-k3d-dev-server-0-failed-with-exit-code-139-logs-from-failed-access-process",level:2}];function a(e){let r={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"k3s-in-docker",children:"K3S in Docker"})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"https://github.com/rancher/k3d",children:"rancher/k3d"})," - \u5BB9\u5668\u8FD0\u884C\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["\u57FA\u4E8E\u4E4B\u524D\u7684 ",(0,t.jsx)(r.a,{href:"https://github.com/zeerorg/k3s-in-docker",children:"zeerorg/k3s-in-docker"})]}),"\n",(0,t.jsx)(r.li,{children:(0,t.jsx)(r.a,{href:"https://github.com/rancher/k3s/blob/master/docker-compose.yml",children:"rancher/k3s/docker-compose.yml"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'curl -Lo k3d https://echo.wener.cc/github.com/k3d-io/k3d/releases/download/v5.4.7/k3d-linux-arm64\nchmod +x k3d\nmv k3d /usr/local/bin\n\n# k3d-default.yaml\nk3d config init\n\nk3d cluster create dev\n\nexport KUBECONFIG="$(k3d kubeconfig write k3s-default)"\n'})}),"\n",(0,t.jsx)(r.h2,{id:"registry",children:"Registry"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"write to /etc/rancher/k3s/registries.yaml"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'# \u81EA\u5B9A\u4E49\nk3d cluster create mycluster --registry-config "$HOME/my-registries.yaml"\n\nk3d cluster create \\\n  --volume "${HOME}/.k3d/my-registries.yaml:/etc/rancher/k3s/registries.yaml" \\\n  --volume "${HOME}/.k3d/my-company-root.pem:/etc/ssl/certs/my-company-root.pem"\n\n# \u542F\u52A8 registry\nk3d cluster create mycluster --registry-create mycluster-registry\ndocker ps -f name=mycluster-registry\n\nk3d registry create myregistry.localhost --port 12345\nk3d cluster create newcluster --registry-use k3d-myregistry.localhost:12345\n'})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"mirrors:\n  'my.company.registry:5000':\n    endpoint:\n      - http://my.company.registry:5000\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'apiVersion: k3d.io/v1alpha3\nkind: Simple\nname: test\nservers: 1\nagents: 2\nregistries:\n  create:\n    name: myregistry\n  config: |\n    mirrors:\n      "my.company.registry":\n        endpoint:\n          - http://my.company.registry:5000\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"k3d managed"})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["/var/lib/registry\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u9ED8\u8BA4\u6CA1\u6709\u6620\u5C04\u51FA\u6765"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["/etc/docker/registry/config.yml\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u914D\u7F6E"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"# \u4F7F\u7528\u9ED8\u8BA4\u914D\u7F6E\ndocker exec dev-registry cat /etc/docker/registry/config.yml\n\n# host.k3d.internal\n# k3d-dev-server-0\n\ndocker exec k3d-dev-server-0 cat /etc/hosts\n# \u66F4\u65B0\u4E86 k3s \u955C\u50CF\u914D\u7F6E\ndocker exec k3d-dev-server-0 cat /etc/rancher/k3s/registries.yaml\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"auths: null\nconfigs: null\nmirrors:\n  dev-registry:5000:\n    endpoint:\n      - http://dev-registry:5000\n  dev-registry:42095:\n    endpoint:\n      - http://dev-registry:5000\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"# \u786E\u4FDD\u80FD\u89E3\u6790\ndocker exec k3d-dev-server-0 nslookup dev-registry\n\n# host \u901A\u8FC7 bridge \u8BBF\u95EE\ndocker inspect dev-registry -f '{{.NetworkSettings.Networks.bridge.IPAddress}}'\ncurl $(docker inspect dev-registry -f '{{.NetworkSettings.Networks.bridge.IPAddress}}'):5000 -I\n\n# \u80FD\u89E3\u6790\u6307\u5411\u540E\u53EF\u4EE5\u6D4B\u8BD5\necho \"$(docker inspect dev-registry -f '{{.NetworkSettings.Networks.bridge.IPAddress}}') dev-registry.localhost\" >> /etc/hosts\n\ndocker pull wener/base:latest\ndocker tag wener/base:latest dev-registry.localhost:5000/wener_base:latest\n# \u4E3B\u8981\u6CE8\u610F\u914D\u7F6E insecure-registries\ndocker push dev-registry.localhost:5000/wener_base:latest\n"})}),"\n",(0,t.jsx)(r.h2,{id:"macos",children:"macOS"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"brew install k3d\n"})}),"\n",(0,t.jsx)(r.h2,{id:"failed-cluster-start-error-during-post-start-cluster-preparation-error-overwriting-contents-of-etchosts-exec-process-in-node-k3d-dev-server-0-failed-with-exit-code-139-logs-from-failed-access-process",children:"Failed Cluster Start: error during post-start cluster preparation: error overwriting contents of /etc/hosts: Exec process in node 'k3d-dev-server-0' failed with exit code '139': Logs from failed access process:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"https://github.com/k3d-io/k3d/issues/1220",children:"https://github.com/k3d-io/k3d/issues/1220"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"5.4.7 BUG, 5.4.6 \u6CA1\u95EE\u9898"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"\u8986\u76D6 hosts \u65F6\u5F02\u5E38"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"sh -c cat /tmp/-etc-hosts-cUAunADhzSQlEbdflLOb > /etc/hosts\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"\u5199\u5165\u5185\u5BB9"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-hosts",children:"::1 ip6-localhost ip6-loopback localhost\n127.0.0.1 localhost\n172.18.0.1 host.k3d.internal\n172.18.0.2 k3d-dev-server-0\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n"})})]})}function h(e={}){let{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},917776:function(e,r,s){s.d(r,{R:()=>c,x:()=>o});var n=s(7378);let t={},i=n.createContext(t);function c(e){let r=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),n.createElement(i.Provider,{value:r},e.children)}}}]);