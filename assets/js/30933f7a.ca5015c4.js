"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["52146"],{37514:function(n,e,r){r.r(e),r.d(e,{frontMatter:()=>l,toc:()=>c,default:()=>h,metadata:()=>s,assets:()=>o,contentTitle:()=>a});var s=JSON.parse('{"id":"devops/infra/terraform/README","title":"Terraform","description":"- opentofu/opentofu","source":"@site/../notes/devops/infra/terraform/README.md","sourceDirName":"devops/infra/terraform","slug":"/devops/infra/terraform/","permalink":"/notes/devops/infra/terraform/","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/infra/terraform/README.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1696577752000,"frontMatter":{"title":"Terraform"},"sidebar":"docs","previous":{"title":"Pulumi","permalink":"/notes/devops/infra/pulumi"},"next":{"title":"Terraform Awesome","permalink":"/notes/devops/infra/terraform/awesome"}}'),i=r(86106),t=r(17776);let l={title:"Terraform"},a="Terraform",o={},c=[{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"terraformrc",id:"terraformrc",level:2},{value:"\u53D8\u91CF",id:"\u53D8\u91CF",level:2},{value:"\u540E\u7AEF",id:"\u540E\u7AEF",level:2},{value:"GitLab Terraform State Backend",id:"gitlab-terraform-state-backend",level:2}];function d(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"terraform",children:"Terraform"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://github.com/opentofu/opentofu",children:"opentofu/opentofu"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"OpenTofu"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.terraform.io/docs/configuration/functions.html",children:"functions"})}),"\n",(0,i.jsxs)(e.li,{children:["\u6A21\u677F\u8BED\u6CD5 ",(0,i.jsx)(e.a,{href:"https://www.terraform.io/docs/configuration/expressions.html#string-templates",children:"string-templates"})]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://www.terraform.io/docs/provisioners/index.html",children:"Provisioners"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u672C\u5730\u6216\u8FDC\u7A0B\u670D\u52A1\u5668\u6267\u884C\u7279\u5B9A\u52A8\u4F5C"}),"\n",(0,i.jsx)(e.li,{children:"\u7528\u4E8E\u51C6\u5907\u670D\u52A1\u6216\u5176\u4ED6\u57FA\u7840\u8BBE\u65BD\u5BF9\u8C61"}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u5EFA\u8BAE\u4F7F\u7528\uFF0C\u4F5C\u4E3A\u6700\u540E\u7684\u65B9\u5F0F"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u6CE8\u610F\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Provider configurations can be defined only in a root Terraform module."}),"\n",(0,i.jsxs)(e.li,{children:["\u88AB\u8C03\u7528\u6A21\u5757\u4E0D\u80FD\u5B9A\u4E49 ",(0,i.jsx)(e.code,{children:"provider"})]}),"\n",(0,i.jsxs)(e.li,{children:["0.10 \u65E7\u7684\u6A21\u5757\u4E0D\u652F\u6301 ",(0,i.jsx)(e.code,{children:"for_each"}),", ",(0,i.jsx)(e.code,{children:"count"}),", ",(0,i.jsx)(e.code,{children:"depends_on"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u79FB\u9664 ",(0,i.jsx)(e.code,{children:"provider"})," \u4E4B\u524D\u786E\u4FDD\u6240\u6709\u8D44\u6E90\u5220\u9664"]}),"\n",(0,i.jsx)(e.li,{children:"\u6A21\u5757\u4F1A\u96C6\u6210\u9ED8\u8BA4 provider - \u6CA1\u6709\u522B\u540D\u7684 provider"}),"\n",(0,i.jsxs)(e.li,{children:["\u5982\u679C\u53D1\u73B0\u7F51\u7EDC\u4E0D\u901A\uFF0C\u786E\u4FDD\u672C\u5730\u53EF\u4EE5\u6253\u5F00 ",(0,i.jsx)(e.a,{href:"https://registry.terraform.io/.well-known/terraform.json",children:"https://registry.terraform.io/.well-known/terraform.json"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u8F6C\u6362\u51FD\u6570\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"yamldecode"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u540E\u7AEF\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"local - \u672C\u5730\u5B58\u50A8 terraform.tfstate"}),"\n",(0,i.jsx)(e.li,{children:"remote - Terraform Enterprise"}),"\n",(0,i.jsx)(e.li,{children:"artifactory - \u65E0\u9501"}),"\n",(0,i.jsx)(e.li,{children:"consul"}),"\n",(0,i.jsx)(e.li,{children:"etcdv3"}),"\n",(0,i.jsx)(e.li,{children:"http - \u53EF\u9009\u9501 - REST \u63A5\u53E3"}),"\n",(0,i.jsx)(e.li,{children:"kubernetes - secret \u9650\u5236\u4E86\u6700\u5927 1MB - \u4E0D\u5EFA\u8BAE\u4F7F\u7528"}),"\n",(0,i.jsx)(e.li,{children:"\u963F\u91CC\u4E91 oss\u3001\u817E\u8BAF\u4E91 cos"}),"\n",(0,i.jsx)(e.li,{children:"pg"}),"\n",(0,i.jsx)(e.li,{children:"s3 - DynamoDB \u652F\u6301\u9501"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# \u65E5\u5FD7\nTF_LOG=1 terraform apply\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'terraform {\n  backend "local" {}\n\n  # experiments = [example]\n\n  required_providers {\n    # aws = ">= 2.7.0"\n\n    aws = {\n      version = ">= 2.7.0"\n    }\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"terraformrc",children:"terraformrc"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.terraform.io/docs/commands/cli-config.html",children:"https://www.terraform.io/docs/commands/cli-config.html"})}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'cat <<HCL > ~/.terraformrc\nplugin_cache_dir   = "$HOME/.terraform.d/plugin-cache"\ndisable_checkpoint = true\n\nprovider_installation {\n  filesystem_mirror {\n    path    = "$HOME/.terraform.d/plugins"\n    include = ["terraform.wener.me/*/*","registry.terraform.io/*/*"]\n  }\n}\nHCL\n\nmkdir -p $HOME/.terraform.d/plugin-cache $HOME/.terraform.d/plugins\n\n# \u5728 tf \u9879\u76EE\u4E0B\u8FD0\u884C\nterraform providers mirror ~/.terraform.d/plugins\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u53D8\u91CF",children:"\u53D8\u91CF"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u8F93\u5165\u53D8\u91CF\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.strong,{children:"\u4F7F\u7528\u53D8\u91CF\u5FC5\u987B\u5148\u5B9A\u4E49\u53D8\u91CF"})}),"\n",(0,i.jsxs)(e.li,{children:["\u8BFB\u53D6\u987A\u5E8F\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u73AF\u5883\u53D8\u91CF"}),"\n",(0,i.jsxs)(e.li,{children:["\u53D8\u91CF\u6587\u4EF6 ",(0,i.jsx)(e.code,{children:"terraform.tfvars"})," ",(0,i.jsx)(e.code,{children:"terraform.tfvars.json"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"HCL \u6216 JSON"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u53D8\u91CF\u6587\u4EF6 ",(0,i.jsx)(e.code,{children:"*.auto.tfvars"})," ",(0,i.jsx)(e.code,{children:"*.auto.tfvars.json"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u6570 ",(0,i.jsx)(e.code,{children:"-var"}),", ",(0,i.jsx)(e.code,{children:"-var-file"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u4F1A\u68C0\u6D4B\u73AF\u5883\u53D8\u91CF\uFF0C\u4F8B\u5982 ",(0,i.jsx)(e.code,{children:"name"})," \u5219\u4F1A\u4F7F\u7528 ",(0,i.jsx)(e.code,{children:"TF_VAR_name"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u672C\u5730\u53D8\u91CF\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u76F4\u63A5\u5199\u5728\u6587\u4EF6\u91CC\u7684\u53D8\u91CF"}),"\n",(0,i.jsx)(e.li,{children:"\u53EF\u91CD\u590D\u4F7F\u7528"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u8F93\u51FA\u53D8\u91CF\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7C7B\u4F3C\u4E8E\u4E00\u4E2A\u6A21\u5757\u7684\u8FD4\u56DE\u503C"}),"\n",(0,i.jsx)(e.li,{children:"\u5B50\u6A21\u5757\u53EF\u901A\u8FC7\u8F93\u51FA\u53D8\u91CF\u66B4\u9732\u4FE1\u606F\u7ED9\u4E0A\u7EA7"}),"\n",(0,i.jsx)(e.li,{children:"root \u6A21\u5757\u53EF\u8F93\u51FA\u5230\u547D\u4EE4\u884C"}),"\n",(0,i.jsxs)(e.li,{children:["\u5F53\u4F7F\u7528\u8FDC\u7A0B\u72B6\u6001\u65F6\uFF0Croot \u6A21\u5757\u8F93\u51FA\u53D8\u91CF\u80FD\u591F\u88AB\u5176\u4ED6\u914D\u7F6E\u8BBF\u95EE\u5230\uFF0C ",(0,i.jsx)(e.code,{children:"terraform_remote_state"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'terraform {\n  # \u5F00\u542F\u53D8\u91CF\u6821\u9A8C\n  experiments = [variable_validation]\n}\n\nvariable "gitlab_token" {\n  # \u7B80\u5355\u7C7B\u578B\n  # string number bool\n  # \u590D\u6742\u7C7B\u578B\n  # list(<TYPE>) set(<TYPE>) map(<TYPE>) object({<ATTR NAME> = <TYPE>, ... }) tuple([<TYPE>, ...])\n  type = string\n  # default = \'\'\n  description = "token for gitlab access"\n\n  validation {\n    condition     = length(var.gitlab_token) > 0 && substr(var.gitlab_token, 0, 4) == "ami-"\n    # condition     = can(regex("^ami-", var.image_id))\n    error_message = "Invalid token"\n  }\n}\nprovider "gitlab" {\n  token = var.gitlab_token\n}\n\n# \u672C\u5730\u53D8\u91CF\nlocals {\n  service_name = "forum"\n  owner        = "Community Team"\n\n  instance_ids = concat(aws_instance.blue.*.id, aws_instance.green.*.id)\n\n  # \u901A\u8FC7 local.common_tags \u65B9\u5F0F\u5F15\u7528\n  common_tags = {\n    Service = local.service_name\n    Owner   = local.owner\n  }\n}\n\n# \u8F93\u51FA\u53D8\u91CF\noutput "instance_ip_addr" {\n  value = aws_instance.server.private_ip\n}\n\noutput "db_password" {\n  value       = aws_db_instance.db.password\n  description = "The password for logging in to the database."\n  sensitive   = true\n}\n\noutput "instance_ip_addr" {\n  value       = aws_instance.server.private_ip\n  description = "The private IP address of the main server instance."\n\n  depends_on = [\n    # Security group rule must be created before this IP address could\n    # actually be used, otherwise the services will be unreachable.\n    aws_security_group_rule.local_access,\n  ]\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u540E\u7AEF",children:"\u540E\u7AEF"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Enhanced - \u53EF\u5B58\u50A8\u72B6\u6001\u548C\u6267\u884C\u64CD\u4F5C\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"local, remote"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["Standard - \u8FDC\u7A0B\u5B58\u50A8\uFF0C\u4F9D\u8D56 local \u6267\u884C\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"consul, etcd, etcdv3"}),"\n",(0,i.jsx)(e.li,{children:"artifactory, pg, swift, http"}),"\n",(0,i.jsx)(e.li,{children:"azurerm, gcs, cos, oss, manta"}),"\n",(0,i.jsxs)(e.li,{children:["s3\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u901A\u8FC7 Dynamo DB \u53EF\u652F\u6301 locking \u548C \u4E00\u81F4\u6027\u68C0\u67E5"}),"\n",(0,i.jsx)(e.li,{children:"\u5EFA\u8BAE\u5F00\u542F\u7248\u672C"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["kubernetes - \u5B58\u50A8\u4E3A secret, \u6700\u591A 1MB \u9650\u5236\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"tfstate-{workspace}-{secret_suffix}"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u7279\u6027\u652F\u6301\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"https://www.terraform.io/docs/language/state/locking.html",children:"State Locking"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u907F\u514D\u5E76\u53D1\u64CD\u4F5C"}),"\n",(0,i.jsx)(e.li,{children:"remote, sql, s3+dynamo, kubernetes"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'terraform {\n  backend "kubernetes" {\n    # tfstate-{workspace}-state\n    secret_suffix = "state"\n    # ~/.kube/config\n    load_config_file = true\n    config_context = "demo"\n    # \u9ED8\u8BA4\u4F7F\u7528 context \u5173\u8054 ns\n    namespace = "demo"\n  }\n\n  # remote\n  backend "http" {\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"gitlab-terraform-state-backend",children:"GitLab Terraform State Backend"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'STATE_NAME=staging\nPROJECT_ID=\nUSERNAME=\nPTA=\nterraform init \\\n    -backend-config="address=https://gitlab.com/api/v4/projects/$PROJECT_ID/terraform/state/$STATE_NAME" \\\n    -backend-config="lock_address=https://gitlab.com/api/v4/projects/$PROJECT_ID/terraform/state/$STATE_NAME/lock" \\\n    -backend-config="unlock_address=https://gitlab.com/api/v4/projects/$PROJECT_ID/terraform/state/$STATE_NAME/lock" \\\n    -backend-config="username=$USERNAME" \\\n    -backend-config="password=$PTA" \\\n    -backend-config="lock_method=POST" \\\n    -backend-config="unlock_method=DELETE" \\\n    -backend-config="retry_wait_min=5"\n'})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest\n\nvariables:\n  TF_ROOT: ${CI_PROJECT_DIR}/environments/example/production\n  TF_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/example-production\n\ncache:\n  key: example-production\n  paths:\n    - ${TF_ROOT}/.terraform\n\nbefore_script:\n  - cd ${TF_ROOT}\n\nstages:\n  - prepare\n  - validate\n  - build\n  - deploy\n\ninit:\n  stage: prepare\n  script:\n    - gitlab-terraform init\n\nvalidate:\n  stage: validate\n  script:\n    - gitlab-terraform validate\n\nplan:\n  stage: build\n  script:\n    - gitlab-terraform plan\n    - gitlab-terraform plan-json\n  artifacts:\n    name: plan\n    paths:\n      - ${TF_ROOT}/plan.cache\n    reports:\n      terraform: ${TF_ROOT}/plan.json\n\napply:\n  stage: deploy\n  environment:\n    name: production\n  script:\n    - gitlab-terraform apply\n  dependencies:\n    - plan\n  when: manual\n  only:\n    - master\n"})})]})}function h(n={}){let{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},17776:function(n,e,r){r.d(e,{R:()=>l,x:()=>a});var s=r(7378);let i={},t=s.createContext(i);function l(n){let e=s.useContext(t);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),s.createElement(t.Provider,{value:e},n.children)}}}]);