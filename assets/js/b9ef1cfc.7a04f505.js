"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["388741"],{712070:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>t,toc:()=>c,default:()=>a,metadata:()=>i,assets:()=>o,contentTitle:()=>d});var i=JSON.parse('{"id":"devops/kubernetes/network/k8s-network-faq","title":"K8S Network FAQ","description":"- nodePort \u4F1A\u88AB\u4EE3\u7406\uFF0C\u65E0\u6CD5\u770B\u5230\u771F\u5B9E IP\uFF0C\u53EF\u4EE5\u901A\u8FC7\u4EFB\u610F\u8282\u70B9\u8BBF\u95EE","source":"@site/../notes/devops/kubernetes/network/k8s-network-faq.md","sourceDirName":"devops/kubernetes/network","slug":"/devops/kubernetes/network/k8s-network-faq","permalink":"/notes/devops/kubernetes/network/k8s-network-faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/network/k8s-network-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1692169664000,"frontMatter":{"title":"K8S Network FAQ","tags":["FAQ"]},"sidebar":"docs","previous":{"title":"Kubernetes Networking Awesome","permalink":"/notes/devops/kubernetes/network/k8s-network-awesome"},"next":{"title":"Kubernetes Services","permalink":"/notes/devops/kubernetes/network/k8s-service"}}'),r=s(486106),l=s(917776);let t={title:"K8S Network FAQ",tags:["FAQ"]},d="K8S Network FAQ",o={},c=[{value:"NodePort \u7AEF\u53E3\u8303\u56F4",id:"nodeport-\u7AEF\u53E3\u8303\u56F4",level:2},{value:"Service \u5148\u8D70\u672C\u8282\u70B9 Endpoint",id:"service-\u5148\u8D70\u672C\u8282\u70B9-endpoint",level:2},{value:"Endpoints vs EndpointSlices",id:"endpoints-vs-endpointslices",level:2},{value:"\u9ED8\u8BA4 IngressClass",id:"\u9ED8\u8BA4-ingressclass",level:2},{value:"Ingress vs Gateway",id:"ingress-vs-gateway",level:2},{value:"LB/Load Balance vs Ingress vs ClusterIP vs API Gateway",id:"lbload-balance-vs-ingress-vs-clusterip-vs-api-gateway",level:2},{value:"\u901A\u8FC7 DNS \u540D\u5B57\u8BBF\u95EE StatusfulSet Pod",id:"\u901A\u8FC7-dns-\u540D\u5B57\u8BBF\u95EE-statusfulset-pod",level:2},{value:"redirect www",id:"redirect-www",level:2},{value:"ExternalName",id:"externalname",level:2}];function h(e){let n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"k8s-network-faq",children:"K8S Network FAQ"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"nodePort \u4F1A\u88AB\u4EE3\u7406\uFF0C\u65E0\u6CD5\u770B\u5230\u771F\u5B9E IP\uFF0C\u53EF\u4EE5\u901A\u8FC7\u4EFB\u610F\u8282\u70B9\u8BBF\u95EE"}),"\n",(0,r.jsxs)(n.li,{children:["hostPort \u4E0D\u4E00\u5B9A\u80FD\u88AB\u6240\u6709 interface \u8BBF\u95EE\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["hostNetwork: true \u53EF\u4EE5\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6B64\u65F6\u8981\u6C42 containerPort \u548C hostPort \u76F8\u540C"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"nodeport-\u7AEF\u53E3\u8303\u56F4",children:"NodePort \u7AEF\u53E3\u8303\u56F4"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"30000\u201332767"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"service-\u5148\u8D70\u672C\u8282\u70B9-endpoint",children:"Service \u5148\u8D70\u672C\u8282\u70B9 Endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: keydb\n  annotations:\n    # Topology Aware Hints\n    # Kubernetes v1.23 Beta\n    # \u4E4B\u524D\u4E3A\n    # service.kubernetes.io/topology-aware-hints\n    # \u503C\u4E3A Auto|Disabled\n    # service.kubernetes.io/topology-aware-routing: auto\n    service.kubernetes.io/topology-mode: Auto\nspec:\n  selector:\n    app: keydb\n  ports:\n    - port: 6379\n  # Kubernetes v1.21 \u5E9F\u5F03\n  topologyKeys:\n    - 'kubernetes.io/hostname'\n    - 'kubernetes.io/hostname'\n    - 'topology.kubernetes.io/zone'\n    - 'topology.kubernetes.io/region'\n    - '*'\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/",children:"Topology Aware Routing"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/2433-topology-aware-hints/README.md",children:"KEP#2433"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/topology-aware-hints/",children:"Topology Aware Hints"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Kubernetes v1.23 Beta"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"endpoints-vs-endpointslices",children:"Endpoints vs EndpointSlices"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"EndpointSlices \u66FF\u4EE3 Endpoints - v1.21"}),"\n",(0,r.jsx)(n.li,{children:"Endpoints will be mirrored to EndpointSlices for Services with no spec.selector"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u9ED8\u8BA4-ingressclass",children:"\u9ED8\u8BA4 IngressClass"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl get ingressclasses\nkubectl describe ingressclasses nginx\nkubectl annotate ingressclasses nginx ingressclass.kubernetes.io/is-default-class=true\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"ingress does not contain a valid IngressClass"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"ingress-vs-gateway",children:"Ingress vs Gateway"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ingress\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5185\u5BB9\u66F4\u591A - \u5305\u542B\u4E86 Host \u914D\u7F6E\u548C \u89C4\u5219\u914D\u7F6E"}),"\n",(0,r.jsx)(n.li,{children:"\u53EA\u5B9A\u4E49\u4E86 HTTP Host+Path \u89C4\u5219"}),"\n",(0,r.jsx)(n.li,{children:"\u901A\u5E38\u66B4\u9732 80 \u548C 443 \u4E24\u4E2A\u7AEF\u53E3"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Gateway - gateway.networking.k8s.io\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u533A\u5206\u4E86 Gateway \u548C HTTPRoute - \u6253\u6563\u89C4\u5219"}),"\n",(0,r.jsx)(n.li,{children:"Gateway \u901A\u8FC7 selector \u9009\u62E9\u8981\u5305\u542B\u7684 HTTPRoute"}),"\n",(0,r.jsxs)(n.li,{children:["Gateway \u548C Route \u662F \u5BF9\u5BF9\u591A \u5173\u7CFB\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4F8B\u5982 \u4E00\u4E2A dev \u4E00\u4E2A test \u4F46\u4F7F\u7528\u90E8\u5206\u76F8\u540C Route"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u5C06 HTTPRoute \u7684\u914D\u7F6E\u4E0B\u653E\u5230\u5F00\u53D1\u4EBA\u5458"}),"\n",(0,r.jsxs)(n.li,{children:["\u652F\u6301\u975E HTTP \u8DEF\u7531\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"TLSRoute - \u57FA\u4E8E SNI \u8DEF\u7531"}),"\n",(0,r.jsx)(n.li,{children:"TCPRoute, UDPRoute - \u57FA\u4E8E\u76EE\u6807\u7AEF\u53E3\u8DEF\u7531"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u660E\u786E\u652F\u6301\u900F\u4F20 HTTPS"}),"\n",(0,r.jsx)(n.li,{children:"\u66B4\u5728 80 \u548C 443 \u4E4B\u4E0A\u652F\u6301\u66B4\u9732\u989D\u5916\u7AEF\u53E3"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"lbload-balance-vs-ingress-vs-clusterip-vs-api-gateway",children:"LB/Load Balance vs Ingress vs ClusterIP vs API Gateway"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["LB/Load Balance - \u8D1F\u8F7D\u5747\u8861\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EA\u662F\u4E00\u79CD\u6982\u5FF5"}),"\n",(0,r.jsx)(n.li,{children:"\u8868\u793A\u805A\u5408\u4E86\u540E\u7AEF\u591A\u4E2A\u670D\u52A1/\u8282\u70B9\uFF0C\u5BF9\u5916\u8FDB\u884C\u7EDF\u4E00\u66B4\u9732"}),"\n",(0,r.jsxs)(n.li,{children:["\u57FA\u672C\u529F\u80FD\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4E0A\u6E38\u76D1\u63A7\u72B6\u6001\u76D1\u63A7 - \u5FFD\u7565\u5F02\u5E38\u8282\u70B9/\u670D\u52A1"}),"\n",(0,r.jsx)(n.li,{children:"\u8F6E\u8BE2"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Ingress - \u6D41\u91CF\u5165\u53E3\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u80FD\u611F\u77E5 7 \u5C42\u534F\u8BAE\u7684 LB - TCP/UDP/HTTP\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u57FA\u4E8E 4 \u5C42\u5B9E\u73B0 7 \u5C42"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u56E0\u4E3A\u80FD\u611F\u77E5 7 \u5C42\u534F\u8BAE\uFF0C\u6240\u4EE5\u53EF\u4EE5\u652F\u6301\u66F4\u591A\u7684\u8DEF\u7531\u529F\u80FD"}),"\n",(0,r.jsxs)(n.li,{children:["\u57FA\u672C\u529F\u80FD - \u57FA\u4E8E HTTP \u534F\u8BAE Host+Path \u7684 LB\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u57FA\u4E8E Hots/\u4E3B\u673A\u540D \u8DEF\u7531"}),"\n",(0,r.jsx)(n.li,{children:"\u57FA\u4E8E \u8DEF\u5F84 \u8DEF\u7531"}),"\n",(0,r.jsx)(n.li,{children:"TLS Offload"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5E38\u89C1\u5B9E\u73B0: nginx, haproxy, envoy, traefik"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["ClusterIP\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["4 \u5C42\u534F\u8BAE\u7684 LB - IP\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EF\u57FA\u4E8E 2 \u5C42\u5B9E\u73B0 4 \u5C42 - MAC"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5B9E\u73B0\u865A\u62DF IP - \u8BE5 IP \u53EF\u4EE5\u662F\u79C1\u6709\u7684\uFF0C\u4E5F\u53EF\u4EE5\u662F\u5E73\u53F0\u63D0\u4F9B\u7684\u516C\u7F51 IP"}),"\n",(0,r.jsx)(n.li,{children:"\u662F\u4E00\u79CD\u670D\u52A1"}),"\n",(0,r.jsx)(n.li,{children:"\u57FA\u672C\u529F\u80FD - \u57FA\u4E8E IP \u7684 LB"}),"\n",(0,r.jsx)(n.li,{children:"\u5E38\u89C1\u5B9E\u73B0: metallb"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["API Gateway - \u63A5\u53E3\u7F51\u5173\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5728\u5E94\u7528\u5C42\u534F\u8BAE\u4E4B\u4E0A\u96C6\u6210\u66F4\u591A\u529F\u80FD"}),"\n",(0,r.jsx)(n.li,{children:"API Gateway \u662F Ingress \u8D85\u96C6"}),"\n",(0,r.jsxs)(n.li,{children:["\u63D0\u4F9B\u66F4\u4E0A\u5C42\u7684\u80FD\u529B\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u611F\u77E5\u66F4\u591A\u534F\u8BAE - \u4F8B\u5982 gRPC/MQTT/MySQL/PostgreSQL/GraphQL"}),"\n",(0,r.jsxs)(n.li,{children:["\u80FD\u57FA\u4E8E\u670D\u52A1\u8FDB\u884C\u8DEF\u7531\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"gRPC \u4E0D\u540C\u670D\u52A1\u8FDB\u884C\u8DEF\u7531"}),"\n",(0,r.jsx)(n.li,{children:"MQTT \u8DEF\u7531"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u80FD\u611F\u77E5\u5BA2\u6237\u7AEF\u66F4\u591A\u4FE1\u606F - \u4F8B\u5982 \u5B9E\u73B0 Auth\u3001\u9650\u6D41 \u7B49\u529F\u80FD"}),"\n",(0,r.jsxs)(n.li,{children:["\u80FD\u5BF9\u8F93\u5165\u8F93\u51FA\u8FDB\u884C\u64CD\u4F5C\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4FEE\u6539 HTTP \u8FD4\u56DE JSON \u5185\u5BB9"}),"\n",(0,r.jsx)(n.li,{children:"\u5BF9\u8BF7\u6C42\u54CD\u5E94\u8FDB\u884C Instrument - \u4F8B\u5982 tracing"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u66F4\u63A5\u8FD1\u5F00\u53D1 - \u901A\u5E38\u652F\u6301 Hook \u4EE3\u7801\u6216\u5916\u90E8\u5E94\u7528\u8FDB\u884C\u5904\u7406"}),"\n",(0,r.jsx)(n.li,{children:"\u7F16\u6392\u63A5\u53E3"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4E0E\u670D\u52A1\u53D1\u73B0\u7ED3\u5408\u4F7F\u7528"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u901A\u5E38\u4F1A\u62BD\u8C61\u66F4\u9AD8\u5C42\u7684\u6982\u5FF5 - \u670D\u52A1\u3001\u8DEF\u7531\u3001Consumer\u3001Plugin"}),"\n",(0,r.jsx)(n.li,{children:"\u5E38\u89C1\u5B9E\u73B0: ambassador, kong, apisix"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u901A\u8FC7-dns-\u540D\u5B57\u8BBF\u95EE-statusfulset-pod",children:"\u901A\u8FC7 DNS \u540D\u5B57\u8BBF\u95EE StatusfulSet Pod"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u786E\u4FDD headless service \u5B58\u5728 - \u4F8B\u5982: redis"}),"\n",(0,r.jsx)(n.li,{children:"serviceName=redis"}),"\n",(0,r.jsx)(n.li,{children:"metadata.name=redis"}),"\n",(0,r.jsx)(n.li,{children:"clusterIP: None"}),"\n",(0,r.jsxs)(n.li,{children:["\u7136\u540E\u901A\u8FC7 ",(0,r.jsx)(n.code,{children:"redis-0.redis.NAMESPACE.svc.cluster.local"})," \u8BBF\u95EE\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6CE8\u610F\u591A\u4E86\u4E00\u5C42 stateful \u7684\u540D\u5B57"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u8981 ready \u540E\u624D\u6709\u8BB0\u5F55"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#stable-network-id",children:"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#stable-network-id"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/kubernetes/kubernetes/issues/45779",children:"https://github.com/kubernetes/kubernetes/issues/45779"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/kubernetes/kubernetes/issues/92559",children:"https://github.com/kubernetes/kubernetes/issues/92559"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Headless \u6709 30s \u7684 cache-miss \u7F13\u5B58\uFF0C\u65B0\u7684 pod \u8981 30s DNS \u624D\u80FD\u8BBF\u95EE"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"redirect-www",children:"redirect www"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'nginx.ingress.kubernetes.io/from-to-www-redirect: "true"'}),"\n",(0,r.jsxs)(n.li,{children:["haproxy.org/request-redirect: wener.me\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"rules \u91CC\u7684 host \u4F1A\u88AB\u91CD\u5B9A\u5411\u5230\u6307\u5B9A\u5730\u5740"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"host[:port]"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"request-redirect-code"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"HAProxy"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"redirect prefix http://example.com code 301 if { hdr(host) -i www.example.com }\n\nhttp-request redirect prefix http://%[hdr(host),regsub(^www\\.,,i)] code 301 if { hdr_beg(host) -i www. }\n\nhttp-request redirect prefix http://www.%[hdr(host)] code 301 unless { hdr_beg(host) -i www. }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"externalname",children:"ExternalName"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4E3B\u8981\u662F\u9700\u8981\u5904\u7406\u52A8\u6001\u89E3\u6790"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u8003\u8651\u914D\u7F6E\u9759\u6001\u670D\u52A1 IP"}),"\n",(0,r.jsxs)(n.li,{children:["HAProxy Ingress \u4E0D\u652F\u6301\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/haproxytech/kubernetes-ingress/issues/100",children:"https://github.com/haproxytech/kubernetes-ingress/issues/100"})}),"\n"]}),"\n"]}),"\n"]})]})}function a(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},917776:function(e,n,s){s.d(n,{R:()=>t,x:()=>d});var i=s(7378);let r={},l=i.createContext(r);function t(e){let n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);