"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["161147"],{392730:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>c,toc:()=>o,default:()=>p,metadata:()=>r,assets:()=>l,contentTitle:()=>d});var r=JSON.parse('{"id":"service/network/vpn/ikev2","title":"IKEv2","description":"IKEv2 \u670D\u52A1\u7AEF","source":"@site/../notes/service/network/vpn/ikev2.md","sourceDirName":"service/network/vpn","slug":"/service/network/vpn/ikev2","permalink":"/notes/service/network/vpn/ikev2","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/network/vpn/ikev2.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1737304142000,"frontMatter":{"title":"IKEv2"},"sidebar":"docs","previous":{"title":"Headscale","permalink":"/notes/service/network/vpn/headscale"},"next":{"title":"IPSec","permalink":"/notes/service/network/vpn/ipsec"}}'),i=s(486106),t=s(917776);let c={title:"IKEv2"},d="IKEv2",l={},o=[{value:"IKEv2 \u670D\u52A1\u7AEF",id:"ikev2-\u670D\u52A1\u7AEF",level:2},{value:"hwdsl2/docker-ipsec-vpn-server",id:"hwdsl2docker-ipsec-vpn-server",level:2},{value:"gaomd/ikev2-vpn-server",id:"gaomdikev2-vpn-server",level:2},{value:"\u542F\u52A8\u811A\u672C",id:"\u542F\u52A8\u811A\u672C",level:3},{value:"IKEv2 Linux \u5BA2\u6237\u7AEF",id:"ikev2-linux-\u5BA2\u6237\u7AEF",level:2},{value:"\u9ED8\u8BA4 ipsec.conf",id:"\u9ED8\u8BA4-ipsecconf",level:2}];function a(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"ikev2",children:"IKEv2"})}),"\n",(0,i.jsx)(n.h2,{id:"ikev2-\u670D\u52A1\u7AEF",children:"IKEv2 \u670D\u52A1\u7AEF"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u901A\u8FC7 strongSwan \u63D0\u4F9B IKEv2"}),"\n",(0,i.jsx)(n.li,{children:"PSK"}),"\n",(0,i.jsx)(n.li,{children:"500/udp 4500/udp"}),"\n",(0,i.jsxs)(n.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["proposals not match when using iOS 14.01 ",(0,i.jsx)(n.a,{href:"https://github.com/gaomd/docker-ikev2-vpn-server/issues/51",children:"https://github.com/gaomd/docker-ikev2-vpn-server/issues/51"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"hwdsl2docker-ipsec-vpn-server",children:"hwdsl2/docker-ipsec-vpn-server"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/hwdsl2/docker-ipsec-vpn-server",children:"hwdsl2/docker-ipsec-vpn-server"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4E0D\u652F\u6301 K8S \u73AF\u5883\u8FD0\u884C"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"\u9700\u8981 privileged"}),"\n",(0,i.jsx)(n.li,{children:"/dev/ppp for IPsec/L2TP"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"env"}),(0,i.jsx)(n.th,{children:"default"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_IPSEC_PSK"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"LC_CTYPE=C tr -dc 'A-HJ-NPR-Za-km-z2-9' </dev/urandom 2>/dev/null | head -c 20"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_USER"}),(0,i.jsx)(n.td,{children:"vpnuser"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_PASSWORD"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"LC_CTYPE=C tr -dc 'A-HJ-NPR-Za-km-z2-9' </dev/urandom 2>/dev/null | head -c 16"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_ADDL_IP_ADDRS"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_ADDL_USERS"}),(0,i.jsx)(n.td,{children:"user1,user2"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_ADDL_PASSWORDS"}),(0,i.jsx)(n.td,{children:"pass1,pass2"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_DNS_NAME"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_CLIENT_NAME"}),(0,i.jsx)(n.td,{children:"vpnclient"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_DNS_SRV1"}),(0,i.jsx)(n.td,{children:"8.8.8.8"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_DNS_SRV2"}),(0,i.jsx)(n.td,{children:"8."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_PROTECT_CONFIG"}),(0,i.jsx)(n.td,{children:"yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_ANDROID_MTU_FIX"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_SHA2_TRUNCBUG"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_SPLIT_IKEV2"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_DISABLE_IPSEC_L2TP"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_DISABLE_IPSEC_XAUTH"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_IKEV2_ONLY"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_ENABLE_MODP1024"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_ENABLE_MODP1536"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_L2TP_NET"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_L2TP_LOCAL"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_L2TP_POO"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_XAUTH_NET"}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VPN_XAUTH_POOL"}),(0,i.jsx)(n.td,{})]})]})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# https://github.com/hwdsl2/docker-ipsec-vpn-server/blob/master/vpn.env.example\n# /etc/ipsec.d/vpnclient.p12 (for Windows & Linux)\n# /etc/ipsec.d/vpnclient.sswan (for Android)\n# /etc/ipsec.d/vpnclient.mobileconfig (for iOS & macOS)\ndocker run --rm -it --privileged \\\n  --name ipsec-vpn-server \\\n  -v /data/vpn/ipsec.d:/etc/ipsec.d \\\n  -v /lib/modules:/lib/modules:ro \\\n  -p 500:500/udp \\\n  -p 4500:4500/udp \\\n  hwdsl2/ipsec-vpn-server\n\n\ndocker exec -it ipsec-vpn-server ikev2.sh --listclients\n\nalias ikev2cli="docker exec -it ipsec-vpn-server ikev2.sh"\n# --revokeclient [client name]\n# --deleteclient [client name]\n# --removeikev2 \u79FB\u9664\u6240\u6709\nikev2cli --listclients\nikev2cli -h\n\n# ikev2cli --addclient user1 pass1\n# ikev2cli --exportclient [client name]\n'})}),"\n",(0,i.jsx)(n.h2,{id:"gaomdikev2-vpn-server",children:"gaomd/ikev2-vpn-server"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["DockerHub ",(0,i.jsx)(n.a,{href:"https://hub.docker.com/r/gaomd/ikev2-vpn-server",children:"ikev2-vpn-server"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/gaomd/docker-ikev2-vpn-server",children:"aomd/docker-ikev2-vpn-server"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/gaomd/docker-ikev2-vpn-server/blob/master/bin/start-vpn",children:"bin/start-vpn"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"10.8.0.0/16"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'docker run -d --restart always --privileged \\\n  -p 500:500/udp -p 4500:4500/udp \\\n  --name ikev2-vpn-server gaomd/ikev2-vpn-server:0.3.0\n\n# fix proposals not match when using iOS 14.01\ndocker exec -it ikev2-vpn-server /bin/bash -c \'echo esp=aes256-sha256-modp2048  >> /etc/ipsec.conf\'\ndocker restart ikev2-vpn-server\n\n# \u5C06 vpn1.example.com \u4FEE\u6539\u4E3A\u673A\u5668\u7684 IP \u5730\u5740\ndocker run -i -t --rm --volumes-from ikev2-vpn-server -e "HOST=vpn1.example.com" gaomd/ikev2-vpn-server:0.3.0 generate-mobileconfig > ikev2-vpn.mobileconfig\n\n# \u751F\u6210\u7684\u79D8\u94A5\u4F4D\u4E8E /etc/ipsec.secrets\n# \u5982\u679C\u8FD8\u60F3\u4E8C\u6B21\u4F7F\u7528, \u53EF\u4EE5\u62F7\u8D1D\u51FA\u6765\ndocker cp ikev2-vpn-server:/etc/ipsec.secrets .\n# \u5982\u679C\u5DF2\u7ECF\u6709\u4E86 PKI\necho ": PSK \\"$IKEV2_PKI\\"" > ipsec.secrets\n# \u4F7F\u7528\u73B0\u6709\u7684 PKI \u542F\u52A8\ndocker run -d --restart always --privileged \\\n  -p 500:500/udp -p 4500:4500/udp -v $PWD/ipsec.secrets:/etc/ipsec.secrets \\\n  --name ikev2-vpn-server gaomd/ikev2-vpn-server:0.3.0\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u542F\u52A8\u811A\u672C",children:"\u542F\u52A8\u811A\u672C"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# https://wiki.strongswan.org/projects/strongswan/wiki/ForwardingAndSplitTunneling\n# Continue reading: https://wiki.strongswan.org/projects/strongswan/wiki/VirtualIP\nsysctl net.ipv4.ip_forward=1\nsysctl net.ipv6.conf.all.forwarding=1\nsysctl net.ipv6.conf.eth0.proxy_ndp=1\niptables -t nat -A POSTROUTING -s 10.8.0.0/16 -o eth0 -m policy --dir out --pol ipsec -j ACCEPT\niptables -t nat -A POSTROUTING -s 10.8.0.0/16 -o eth0 -j MASQUERADE\nip6tables -t nat -A POSTROUTING -s fd6a:6ce3:c8d8:7caa::/64 -o eth0 -m policy --dir out --pol ipsec -j ACCEPT\nip6tables -t nat -A POSTROUTING -s fd6a:6ce3:c8d8:7caa::/64 -o eth0 -j MASQUERADE\n\n# hotfix for openssl `unable to write \'random state\'` stderr\nSHARED_SECRET="123$(openssl rand -base64 32 2> /dev/null)"\n[ -f /etc/ipsec.secrets ] || echo ": PSK \\"${SHARED_SECRET}\\"" > /etc/ipsec.secrets\n\n# hotfix for https://github.com/gaomd/docker-ikev2-vpn-server/issues/7\nrm -f /var/run/starter.charon.pid\n\nservice ndppd start\n# http://wiki.loopop.net/doku.php?id=server:vpn:strongswanonopenvz\n/usr/sbin/ipsec start --nofork\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"/etc/ipsec.conf"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ini",children:"# /etc/ipsec.conf - strongSwan IPsec configuration file\n#\n# Based on http://www.strongswan.org/uml/testresults/ikev2/rw-psk-ipv4/\n\nconfig setup\n\nconn %default\n    left=%defaultroute\n    ikelifetime=60m\n    keylife=20m\n    rekeymargin=3m\n    keyingtries=1\n    keyexchange=ikev2\n    authby=secret\n\nconn rw\n    # http://wiki.loopop.net/doku.php?id=server:vpn:strongswanonopenvz\n    # https://wiki.strongswan.org/projects/strongswan/wiki/ForwardingAndSplitTunneling\n    leftsubnet=0.0.0.0/0,::/0\n    # end ref\n    leftfirewall=yes\n    right=%any\n    rightsourceip=10.8.0.0/16,fd6a:6ce3:c8d8:7caa::/64\n    auto=add\n"})}),"\n",(0,i.jsx)(n.h2,{id:"ikev2-linux-\u5BA2\u6237\u7AEF",children:"IKEv2 Linux \u5BA2\u6237\u7AEF"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'apk add strongswan\nservice strongswan start\nrc-update add strongswan\n\ncat << CONF >> /etc/ipsec.conf\nconn %default\n	ikelifetime=60m\n	keylife=20m\n	rekeymargin=3m\n	keyingtries=1\n	keyexchange=ikev2\n	authby=secret\n\nconn pri\n  left=%defaultroute\n  leftsourceip=%config\n  # \u670D\u52A1\u7AEF\u5730\u5740\n  right=192.168.1.1\n  rightsubnet=0.0.0.0/0\n  type=tunnel\n  auto=add\nCONF\n# sed -i \'s/load = yes/load = no/g\' /etc/strongswan.d/charon/constraints.conf\necho ":PSK \\"${IKEV2_PKI}\\"" >> /etc/ipsec.secrets\nipsec restart\nipsec up pri\n\nipsec statusall\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ipsec rereadsecrets\nipsec reload\nipsec restart\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u9ED8\u8BA4-ipsecconf",children:"\u9ED8\u8BA4 ipsec.conf"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ini",children:'# ipsec.conf - strongSwan IPsec configuration file\n\n# basic configuration\n\nconfig setup\n	# strictcrlpolicy=yes\n	# uniqueids = no\n\n# Add connections here.\n\n# Sample VPN connections\n\n#conn sample-self-signed\n#      leftsubnet=10.1.0.0/16\n#      leftcert=selfCert.der\n#      leftsendcert=never\n#      right=192.168.0.2\n#      rightsubnet=10.2.0.0/16\n#      rightcert=peerCert.der\n#      auto=start\n\n#conn sample-with-ca-cert\n#      leftsubnet=10.1.0.0/16\n#      leftcert=myCert.pem\n#      right=192.168.0.2\n#      rightsubnet=10.2.0.0/16\n#      rightid="C=CH, O=Linux strongSwan CN=peer name"\n#      auto=start\n'})})]})}function p(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},917776:function(e,n,s){s.d(n,{R:()=>c,x:()=>d});var r=s(7378);let i={},t=r.createContext(i);function c(e){let n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);