"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["245064"],{275506:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>o,toc:()=>c,default:()=>p,metadata:()=>r,assets:()=>i,contentTitle:()=>a});var r=JSON.parse('{"id":"service/network/teleport","title":"Teleport","description":"- \u662F\u4EC0\u4E48\uFF1F","source":"@site/../notes/service/network/teleport.md","sourceDirName":"service/network","slug":"/service/network/teleport","permalink":"/notes/service/network/teleport","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/service/network/teleport.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1645693721000,"frontMatter":{"title":"Teleport"},"sidebar":"docs","previous":{"title":"stun","permalink":"/notes/service/network/stun"},"next":{"title":"Tunnel","permalink":"/notes/service/network/tunnel/"}}'),s=t(486106),l=t(917776);let o={title:"Teleport"},a="Teleport",i={},c=[{value:"demo",id:"demo",level:2},{value:"access plugin",id:"access-plugin",level:2},{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"access denied to admin connecting to on cluster teleport",id:"access-denied-to-admin-connecting-to-on-cluster-teleport",level:2},{value:"the connection was closed on the remote side",id:"the-connection-was-closed-on-the-remote-side",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"teleport",children:"Teleport"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u662F\u4EC0\u4E48\uFF1F\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u652F\u6301 CA,\u52A0\u5BC6,\u8BA4\u8BC1\u6388\u6743\u7684\u53CD\u5411\u4EE3\u7406"}),"\n",(0,s.jsx)(n.li,{children:"\u652F\u6301\u534F\u8BAE SSH, Kubernetes, Web"}),"\n",(0,s.jsx)(n.li,{children:"kubectl exec"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7AEF\u53E3\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"3023, 3024, 3025, 3080"}),"\n",(0,s.jsx)(n.li,{children:"3022 - Node - SSH"}),"\n",(0,s.jsx)(n.li,{children:"3023 - Proxy -> 3022"}),"\n",(0,s.jsx)(n.li,{children:"3024 - Proxy - \u53CD\u5411 SSH \u901A\u9053"}),"\n",(0,s.jsx)(n.li,{children:"3025 - Auth - SSH Auth Service"}),"\n",(0,s.jsx)(n.li,{children:"3080 - Proxy - HTTPS auth tsh, Web UI"}),"\n",(0,s.jsx)(n.li,{children:"3026 - Kubernetes - HTTPS Proxy"}),"\n",(0,s.jsx)(n.li,{children:"3027 - Kubernetes - Kubernetes Service"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://goteleport.com/teleport/docs/enterprise/introduction/",children:"\u4F01\u4E1A\u7248"})," \u7279\u6027 / ",(0,s.jsx)(n.a,{href:"https://goteleport.com/teleport/docs/faq/#commercial-teleport-editions",children:"Commercial Teleport Editions"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"RBAC"}),"\n",(0,s.jsxs)(n.li,{children:["SSO\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"SAML"}),"\n",(0,s.jsx)(n.li,{children:"OIDC - Okta, Active Directory, Auth0"}),"\n",(0,s.jsx)(n.li,{children:"\u793E\u533A\u7248\u672C\u652F\u6301 github \u548C local \u8BA4\u8BC1"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Approval"}),"\n",(0,s.jsx)(n.li,{children:"FedRAMP/FIPS"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7EC4\u4EF6\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"tsh - ssh"}),"\n",(0,s.jsx)(n.li,{children:"tctl - auth server"}),"\n",(0,s.jsx)(n.li,{children:"teleport - sshd"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u589E\u5F3A\u4F1A\u8BDD\u8BB0\u5F55 \u57FA\u4E8E BPF \u9700\u8981 ",(0,s.jsx)(n.a,{href:"https://github.com/iovisor/bcc",children:"iovisor/bcc"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"demo",children:"demo"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"teleport.yaml"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"teleport:\n  data_dir: ./teleport\n  advertise_ip: 192.168.1.2\nauth_service:\n  enabled: true\n  cluster_name: 'teleport'\n  listen_addr: 0.0.0.0:3025\n  tokens:\n    - proxy,node,app:f7adb7ccdf04037bcd2b52ec6010fd6f0caec94ba190b765\nssh_service:\n  enabled: true\n  labels:\n    env: staging\napp_service:\n  enabled: true\n  debug_app: true\nproxy_service:\n  enabled: true\n  listen_addr: 0.0.0.0:3023\n  web_listen_addr: 0.0.0.0:3080\n  tunnel_listen_addr: 0.0.0.0:3024\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"teleport:\n  data_dir: ./teleport\n  auth_token: proxy,node,app:f7adb7ccdf04037bcd2b52ec6010fd6f0caec94ba190b765\n  auth_servers:\n  - 192.168.1.2:3025\n  advertise_ip: 192.168.1.3\nssh_service:\n  enabled: true\n  listen_addr: 0.0.0.0:3022\nproxy_service:\n  enabled: false\nauth_service:\n  enabled: false\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'teleport configure --cluster-name demo-cluster -o $PWD/tele.yaml\n\n# \u542F\u52A8\nteleport start -c tele.yaml\n# \u6DFB\u52A0\u7528\u6237\ntctl users add admin -c tele.yaml --roles=admin --logins=root,admin\n\ntsh --proxy localhost:3080 --insecure login --user admin\ntsh status\ntsh ls\n\n# \u6DFB\u52A0\u8282\u70B9\ntctl tokens add --type=node -c tele.yaml\n# \u542F\u52A8\u8282\u70B9\nsudo teleport start \\\n--roles=node \\\n--auth-server=https://teleport.example.com:443 \\\n--token=${TOKEN?} \\\n--labels=env=demo\n\n# macOS\ncurl -O https://get.gravitational.com/teleport-v6.0.1-darwin-amd64-bin.tar.gz\n# Linux\ncurl -O https://get.gravitational.com/teleport-v6.0.1-linux-amd64-bin.tar.gz\n\ndocker run --rm -it quay.io/gravitational/teleport\n\nteleport start --roles=node --auth-server=10.1.0.1 --token=xyz --nodename=d\n\nteleport start --roles=app --token=xyz --auth-server=proxy.example.com:3080 \\\n    --app-name="example-app" \\\n    --app-uri="http://localhost:8080" \\\n    --labels=group:dev\n\nteleport start --roles=app --token=xyz --auth-server=proxy.example.com:3080 \\\n  --app-name="example-app" \\\n  --app-uri="http://localhost:8080"\n\nteleport start --roles=database --token=xyz --auth-server=proxy.example.com:3080 \\\n  --db-name="example-db" \\\n  --db-protocol="postgres" \\\n  --db-uri="localhost:5432"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"access-plugin",children:"access plugin"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/gravitational/teleport-plugins/tree/master/access",children:"https://github.com/gravitational/teleport-plugins/tree/master/access"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://goteleport.com/teleport/docs/config-reference/",children:"Teleport Configuration Reference"})}),"\n",(0,s.jsx)(n.li,{children:"/etc/teleport.yaml"}),"\n",(0,s.jsxs)(n.li,{children:["\u670D\u52A1\u7C7B\u578B\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"auth - \u63D0\u4F9B\u8BA4\u8BC1\u6388\u6743"}),"\n",(0,s.jsx)(n.li,{children:"node/ssh - \u5BF9\u63A5\u8282\u70B9\u5230\u96C6\u7FA4"}),"\n",(0,s.jsx)(n.li,{children:"proxy - \u63D0\u4F9B WebUI \u548C SSH"}),"\n",(0,s.jsx)(n.li,{children:"app - \u53CD\u5411\u4EE3\u7406\u5E94\u7528"}),"\n",(0,s.jsx)(n.li,{children:"kubernetes"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# \u5168\u5C40\u914D\u7F6E \u5F71\u54CD\u6240\u6709\u670D\u52A1\nteleport:\n  # \u4F5C\u4E3A hostname \u522B\u540D\n  nodename: graviton\n  # \u6570\u636E\u76EE\u5F55 https://goteleport.com/teleport/docs/admin-guide/#filesystem-layout\n  data_dir: /var/lib/teleport\n\n  # JOIN \u5230\u96C6\u7FA4\u7684 Token - \u521D\u6B21\u4F7F\u7528\u540E\u4FBF\u4E0D\u5728\u9700\u8981\n  auth_token: xxxx-token-xxxx\n\n  # AuthServer CA PIN\n  # https://goteleport.com/teleport/docs/admin-guide/#adding-nodes-to-the-cluster\n  ca_pin: "sha256:7e12c17c20d9cb504bbcb3f0236be3f446861f1396dcbb44425fe28ec1c108f1"\n\n  # \u652F\u6301 FQDN\n  advertise_ip: 10.1.0.5\n\n  # \u96C6\u7FA4\u4E2D\u7684\u6388\u6743\u670D\u52A1\n  auth_servers:\n  - 10.1.0.5:3025\n  - 10.1.0.6:3025\n\n  # \u9650\u6D41\n  connection_limits:\n    max_connections: 1000\n    max_users: 250\n\n  # \u652F\u6301\u914D\u7F6E stdout,stderr,syslog  INFO, WARN, ERROR\n  # \u9ED8\u8BA4 ERROR\n  log:\n    output: /var/lib/teleport/teleport.log\n    severity: ERROR\n\n  # \u5B58\u50A8\u96C6\u7FA4\u72B6\u6001\u548C\u5BA1\u8BA1\u65E5\u5FD7\n  # \u652F\u6301 DynamoDB, S3, etcd \u7B49\n  # https://goteleport.com/teleport/docs/admin-guide/#high-availability\n  storage:\n    # \u9ED8\u8BA4\u5B58\u50A8\u5230\u6570\u636E\u76EE\u5F55\n    type: dir\n\n    # \u9ED8\u8BA4 /var/lib/teleport/log\n    audit_events_uri: [ \'dynamodb://events_table_name\', \'firestore://events_table_name\', \'file:///var/lib/teleport/log\', \'stdout://\' ]\n\n    # \u5B58\u50A8\u8BB0\u5F55\u7684\u4F1A\u8BDD\n    # https://goteleport.com/teleport/docs/admin-guide/#using-amazon-s3\n    audit_sessions_uri: \'s3://example.com/path/to/bucket?region=us-east-1\'\n\n    # DynamoDB\n    # ==========\n    continuous_backups: [ true|false ]\n    auto_scaling: [ true|false ]\n\n    # minimum/maximum read capacity in units\n    read_min_capacity: int\n    read_max_capacity: int\n    read_target_value: float\n    # minimum/maximum write capacity in units\n    write_min_capacity: int\n    write_max_capacity: int\n    write_target_value: float\n\n  # ssh-rsa, rsa-sha2-256, rsa-sha2-512\n  ca_signature_algo: "rsa-sha2-512"\n  ciphers:\n  - aes128-ctr\n  - aes192-ctr\n  - aes256-ctr\n  - aes128-gcm@openssh.com\n  - chacha20-poly1305@openssh.com\n  kex_algos:\n  - curve25519-sha256@libssh.org\n  - ecdh-sha2-nistp256\n  - ecdh-sha2-nistp384\n  - ecdh-sha2-nistp521\n  mac_algos:\n  - hmac-sha2-256-etm@openssh.com\n  - hmac-sha2-256\n  ciphersuites:\n  - tls-ecdhe-rsa-with-aes-128-gcm-sha256\n  - tls-ecdhe-ecdsa-with-aes-128-gcm-sha256\n  - tls-ecdhe-rsa-with-aes-256-gcm-sha384\n  - tls-ecdhe-ecdsa-with-aes-256-gcm-sha384\n  - tls-ecdhe-rsa-with-chacha20-poly1305\n  - tls-ecdhe-ecdsa-with-chacha20-poly1305\n\n# Auth \u670D\u52A1\nauth_service:\n  # \u662F\u5426\u542F\u7528\n  enabled: yes\n\n  # \u751F\u6210 CA \u5305\u542B\u7684\u540D\u5B57 - \u5C3D\u91CF\u8BBE\u7F6E\u4E3A\u6709\u610F\u4E49\u7684\u540D\u5B57\n  # \u4FEE\u6539\u4F1A\u5BFC\u81F4\u6240\u6709\u751F\u6210\u7684\u8BC1\u4E66\u5931\u6548\uFF0C\u53EF\u80FD\u9700\u8981\u6E05\u9664 /var/lib/teleport\n  cluster_name: "main"\n  # \u8BA4\u8BC1\n  authentication:\n    # OSS \'local\', \'github\'\n    # Enterprise \'oidc\', \'saml\', \'false\'\n    type: local\n    # off,otp, u2f\n    second_factor: otp\n    u2f:\n      # Teleport Web UI (proxy) - \u786E\u4FDD\u5176\u4ED6\u8282\u70B9\u53EF\u8BBF\u95EE\n      app_id: https://localhost:3080\n      # \u5217\u4E3E\u6240\u6709\n      facets:\n      - https://localhost:3080\n\n  # Auth API, Cluster API\n  listen_addr: 0.0.0.0:3025\n\n  # AuthServer DNS - \u53EF\u9009\n  # https://goteleport.com/teleport/docs/admin-guide/#public-addr\n  public_addr: auth.example.com:3025\n\n  # \u9884\u5B9A\u4E49\u7528\u4E8E\u52A0\u5165\u8282\u70B9\u7684 Token\n  # tctl nodes add --ttl \u751F\u6210\u5E26 TTL \u7684\u968F\u673A Token\n  # \u5EFA\u8BAE\u4F7F\u7528 pwgen \u751F\u6210 32+ byte \u7684 Token\n  tokens:\n  - "proxy,node:xxxxx"\n  - "auth:yyyy"\n  # node - \u9ED8\u8BA4\n  # proxy - https://goteleport.com/teleport/docs/architecture/proxy/#recording-proxy-mode\n  # off - \u5173\u95ED\n  # \u5B9E\u9A8C\u6027 *-sync - \u76F4\u63A5\u53D1\u9001\u5230 S3\n  session_recording: "node"\n\n  # session_recording=proxy \u751F\u6548\n  # https://goteleport.com/teleport/docs/architecture/proxy/#recording-proxy-mode\n  proxy_checks_host_keys: yes\n  # \u4F8B\u5982 30m, 1h, 1h30m\n  client_idle_timeout: never\n  # \u8FDE\u63A5\u4E0A\u7684 ssh \u5982\u679C cert \u8FC7\u671F\u662F\u5426\u65AD\u5F00\n  disconnect_expired_cert: no\n\n  keep_alive_interval: 5m\n  keep_alive_count_max: 3\n\n  # \u96C6\u7FA4\u7EAC\u5EA6\u4F1A\u8BDD\u63A7\u5236\u8D85\u65F6\u65F6\u95F4\n  # session_control_timeout: 2m\n\n  license_file: /var/lib/teleport/license.pem\n\n# \u8282\u70B9 SSH \u670D\u52A1\nssh_service:\n  enabled: yes\n  listen_addr: 0.0.0.0:3022\n  # \u53EF\u4EE5\u914D\u7F6E\u5141\u8BB8\u76F4\u8FDE\n  public_addr: node.example.com:3022\n  # \u8282\u70B9\u6807\u7B7E\n  # https://goteleport.com/teleport/docs/admin-guide/#labeling-nodes-and-applications\n  labels:\n    role: leader\n    type: postgres\n\n  # \u547D\u4EE4\u5B9A\u4E49\u6807\u7B7E\n  commands:\n  # arch=x86_64\n  - name: arch\n    command: [ \'/bin/uname\', \'-p\' ]\n    period: 1h0m0s\n\n  # ~/.tsh/environment\n  permit_user_env: false\n\n  # \u589E\u5F3A\u4F1A\u8BDD\u8BB0\u5F55\n  # https://gravitational.com/teleport/docs/features/enhanced-session-recording\n  enhanced_recording:\n    enabled: false\n    # \u5355\u4F4D page\n    command_buffer_size: 8\n    disk_buffer_size: 128\n    network_buffer_size: 8\n    # cgroupv2 \u6302\u8F7D\u70B9\n    cgroup_path: /cgroup2\n  # PAM \u96C6\u6210\n  # https://goteleport.com/teleport/docs/features/ssh-pam/\n  pam:\n    enabled: no\n    service_name: teleport\n\n# \u4EE3\u7406\u670D\u52A1\nproxy_service:\n  enabled: yes\n  # SSH forwarding/proxy\n  listen_addr: 0.0.0.0:3023\n  # Reverse tunnel\n  tunnel_listen_addr: 0.0.0.0:3024\n  # Web UI - password+HOTP\n  web_listen_addr: 0.0.0.0:3080\n  public_addr: proxy.example.com:3080\n  ssh_public_addr: proxy.example.com:3023\n  tunnel_public_addr: proxy.example.com:3024\n\n  https_keypairs:\n  - key_file: /var/lib/teleport/webproxy_key.pem\n    cert_file: /var/lib/teleport/webproxy_cert.pem\n  - key_file: /etc/letsencrypt/live/*.teleport.example.com/privkey.pem\n    cert_file: /etc/letsencrypt/live/*.teleport.example.com/fullchain.pem\n\n  kube_listen_addr: 0.0.0.0:3026\n  # \u4FEE\u6539 k8s \u63A5\u5165\u5730\u5740\n  kube_public_addr: kube.example.com:3026\n\n# \u5E94\u7528\u670D\u52A1\napp_service:\n  enabled: yes\n  # \u5F00\u542F debug \u5E94\u7528 - \u4F1A\u663E\u793A JWT \u5185\u5BB9\n  debug_app: true\n  apps:\n  - name: "kubernetes-dashboard"\n    # \u5E94\u7528\n    uri: "http://10.0.1.27:8000"\n    # \u5916\u90E8\u5730\u5740\n    public_addr: "example.com"\n    # \u6807\u7B7E\n    labels:\n      env: "prod"\n    # \u52A8\u6001\u6807\u7B7E\n    commands:\n    - name: "os"\n      command: [ "/usr/bin/uname" ]\n      period: "5s"\n\nkubernetes_service:\n  enabled: yes\n  public_addr: [ k8s.example.com:3026 ]\n  listen_addr: 0.0.0.0:3026\n  # \u672A\u8FD0\u884C\u5728 k8s \u5185\u901A\u8FC7 kubeconfig_file \u6307\u5B9A\u914D\u7F6E\n  kubeconfig_file: /secrets/kubeconfig\n  # \u8FD0\u884C\u5728 k8s \u5185 \u5B9A\u4E49\u96C6\u7FA4\u540D\u5B57\n  # \u4F7F\u7528 SA \u8BA4\u8BC1\n  kube_cluster_name:\n  labels:\n    env: "prod"\n    # \u52A8\u6001\u6807\u7B7E\n    - name: "os"\n        command: [ "/usr/bin/uname" ]\n        period: "5s"\n    # GKE \u96C6\u7FA4\u540D\u5B57\n    - name: cluster-name\n      command: [ \'curl\', \'http://metadata.google.internal/computeMetadata/v1/instance/attributes/cluster-name\', \'-H\', \'Metadata-Flavor: Google\' ]\n      period: 1m0s\n'})}),"\n",(0,s.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(n.h2,{id:"access-denied-to-admin-connecting-to-on-cluster-teleport",children:"access denied to admin connecting to on cluster teleport"}),"\n",(0,s.jsx)(n.h2,{id:"the-connection-was-closed-on-the-remote-side",children:"the connection was closed on the remote side"})]})}function p(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},917776:function(e,n,t){t.d(n,{R:()=>o,x:()=>a});var r=t(7378);let s={},l=r.createContext(s);function o(e){let n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);