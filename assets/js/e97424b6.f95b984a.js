"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["74583"],{11748:function(n,s,e){e.r(s),e.d(s,{frontMatter:()=>t,toc:()=>h,default:()=>x,metadata:()=>i,assets:()=>c,contentTitle:()=>d});var i=JSON.parse('{"id":"os/linux/fs/zfs/zfs-tuning","title":"ZFS \u8C03\u4F18","description":"- \u63D0\u5347 \u5E94\u7528\u6027\u80FD - \u9488\u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u8C03\u4F18 - recordsize\uFF0Clogbias\u3001sync=off","source":"@site/../notes/os/linux/fs/zfs/zfs-tuning.md","sourceDirName":"os/linux/fs/zfs","slug":"/os/linux/fs/zfs/tuning","permalink":"/notes/os/linux/fs/zfs/tuning","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/fs/zfs/zfs-tuning.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1714721203000,"frontMatter":{"title":"ZFS \u8C03\u4F18"},"sidebar":"docs","previous":{"title":"Stat","permalink":"/notes/os/linux/fs/zfs/stat"},"next":{"title":"OpenZFS Version","permalink":"/notes/os/linux/fs/zfs/version"}}'),l=e(86106),r=e(17776);let t={title:"ZFS \u8C03\u4F18"},d="ZFS Tuning",c={},h=[{value:"ZIL SLOG",id:"zil-slog",level:2},{value:"sync",id:"sync",level:3},{value:"logbias",id:"logbias",level:2},{value:"ashift",id:"ashift",level:2},{value:"L2ARC",id:"l2arc",level:2},{value:"\u78C1\u76D8\u4FE1\u606F",id:"\u78C1\u76D8\u4FE1\u606F",level:2},{value:"atime on temporary",id:"atime-on-temporary",level:2},{value:"zfs_vdev_mirror_rotating_inc",id:"zfs_vdev_mirror_rotating_inc",level:2},{value:"SSD TRIM",id:"ssd-trim",level:2},{value:"\u53C2\u8003",id:"\u53C2\u8003",level:2}];function o(n){let s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.header,{children:(0,l.jsx)(s.h1,{id:"zfs-tuning",children:"ZFS Tuning"})}),"\n",(0,l.jsx)(s.admonition,{title:"\u76EE\u7684",type:"tip",children:(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u63D0\u5347 \u5E94\u7528\u6027\u80FD - \u9488\u5BF9\u5DE5\u4F5C\u8D1F\u8F7D\u8C03\u4F18 - recordsize\uFF0Clogbias\u3001sync=off"}),"\n",(0,l.jsx)(s.li,{children:"\u63D0\u5347 \u8BFB - cache\u3001\u5185\u5B58"}),"\n",(0,l.jsx)(s.li,{children:"\u63D0\u5347 \u5199 - slog\u3001zfs_txg_timeout"}),"\n",(0,l.jsx)(s.li,{children:"\u63D0\u5347 \u7A7A\u95F4\u4F7F\u7528\u7387 - \u538B\u7F29\u3001recordsize\u3001draid"}),"\n",(0,l.jsx)(s.li,{children:"\u63D0\u5347 \u5B89\u5168 - \u70ED\u5907\u3001\u51B7\u5907\u3001sync"}),"\n"]})}),"\n",(0,l.jsx)(s.admonition,{type:"caution",children:(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"slog \u4E0D\u662F write buffer"}),"\n"]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"/proc/spl/kstat/zfs/main/iostats"}),"\n",(0,l.jsxs)(s.li,{children:["/sys/module/zfs/parameters\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"ZFS \u5185\u6838\u6A21\u5757\u53C2\u6570"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.admonition,{type:"tip",children:(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u4F7F\u7528\u673A\u68B0\u76D8\u65F6\uFF0C\u5EFA\u8BAE\u914D\u5907\u4E00\u4E2A SSD \u5206\u4E24\u4E2A\u533A\uFF0C\u4E00\u4E2A\u505A SLOG \u4E00\u4E2A\u505A L2ARC - \u5E76\u589E\u52A0 zfs_txg_timeout"}),"\n",(0,l.jsxs)(s.li,{children:["compressratio \u53D7 recordsize \u5F71\u54CD\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://github.com/openzfs/zfs/discussions/11293",children:"https://github.com/openzfs/zfs/discussions/11293"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"\u603B\u662F\u5F00\u542F compression"}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(s.table,{children:[(0,l.jsx)(s.thead,{children:(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.th,{children:"zpool prop"}),(0,l.jsx)(s.th,{children:"default"}),(0,l.jsx)(s.th,{children:"recommand"})]})}),(0,l.jsxs)(s.tbody,{children:[(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"ashift"}),(0,l.jsx)(s.td,{children:"0"}),(0,l.jsx)(s.td,{children:"12"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"atime"}),(0,l.jsx)(s.td,{children:"on"}),(0,l.jsx)(s.td,{children:"off"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"recordsize"}),(0,l.jsx)(s.td,{children:"128K"}),(0,l.jsx)(s.td,{})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"logbias"}),(0,l.jsx)(s.td,{children:"latency"}),(0,l.jsx)(s.td,{})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"autotrim"}),(0,l.jsx)(s.td,{children:"off"}),(0,l.jsx)(s.td,{children:"SDD \u63A8\u8350 on"})]})]})]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-bash",children:"zdb | grep ashift # \u67E5\u770B\u4F7F\u7528\u7684 ashift\n"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["ashift\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"2^n - block size/sector size"}),"\n",(0,l.jsx)(s.li,{children:"\u5339\u914D\u5E95\u5C42\u7269\u7406 sector size"}),"\n",(0,l.jsx)(s.li,{children:"0 \u4E3A\u81EA\u52A8\u68C0\u6D4B"}),"\n",(0,l.jsx)(s.li,{children:"\u4E00\u822C\u4E3A 12 - 4K"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.hr,{}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["source\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"default"}),"\n",(0,l.jsxs)(s.li,{children:["temporary\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u4E34\u65F6\u6302\u8F7D\u70B9\u5C5E\u6027 - \u4F1A\u6620\u5C04\u5230 mount"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"inherited from"}),"\n",(0,l.jsx)(s.li,{children:"local"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["xattrs=on\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u5B58\u50A8\u6269\u5C55\u4FE1\u606F\u5230\u9690\u85CF\u76EE\u5F55\uFF0C\u8BBF\u95EE\u6587\u4EF6\u65F6\u9700\u8981\u989D\u5916 lookup"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["xattr=sa\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u5B58\u50A8\u6269\u5C55\u4FE1\u606F\u5230 inode"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-bash",children:"zfs set compression=lz4 data\nzfs set atime=off data\nzfs set relatime=on data\nzfs set xattr=sa data\n\n# \u65AD\u7535\u53EF\u80FD\u4E22\u5931\u4E00\u5B9A\u6570\u636E\nzfs set sync=disabled POOL\n\n# primarycache=metadata - \u770B\u60C5\u51B5\nzfs set atime=off relatime=on xattr=sa compression=lz4 sync=disabled POOL\n\nzfs get all POOL | grep -E 'compression|atime|xattr|sync|primarycache|recordsize'\n"})}),"\n",(0,l.jsx)(s.h2,{id:"zil-slog",children:"ZIL SLOG"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["ZIL - ZFS Intent Log\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u77ED\u671F\u5B58\u50A8"}),"\n",(0,l.jsx)(s.li,{children:"ZIL \u9ED8\u8BA4\u5B58\u5728\u4E8E\u786C\u76D8\u4E0A\u7684\u7279\u6B8A\u533A\u57DF - \u4EA7\u751F\u53CC\u5199 - \u5148\u5199 ZIL \u5728\u5199\u56DE\u5230\u78C1\u76D8\u533A\u57DF"}),"\n",(0,l.jsxs)(s.li,{children:["\u4E0D\u4F1A\u4F7F\u7528 ZIL \u7684\u573A\u666F\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"logbias=throughput"}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"\u5927\u5757"})," - \u4F8B\u5982\uFF1A \u6570\u636E\u540C\u6B65\u65F6\u4E0D\u4F1A\u7528\u5230"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.strong,{children:"\u53EA\u7528\u4E8E\u7CFB\u7EDF crash \u6062\u590D"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["SLOG - Separate ZFS Intent Log\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"ZIL \u5B58\u50A8\u4E8E\u989D\u5916\u7684\u78C1\u76D8"}),"\n",(0,l.jsx)(s.li,{children:"\u66FF\u4EE3\u5B58\u50A8\u78C1\u76D8\u4E0A\u7684 ZIL - \u907F\u514D\u53CC\u5199"}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.strong,{children:"\u4E0D\u662F\u5199\u7F13\u5B58"})}),"\n",(0,l.jsxs)(s.li,{children:["\u7528\u4E0D\u4E86\u591A\u5C11\u7A7A\u95F4\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u4E00\u822C 16G \u6216 32G \u8DB3\u77E3"}),"\n",(0,l.jsx)(s.li,{children:"max amount of write traffic per second x 15"}),"\n",(0,l.jsxs)(s.li,{children:["TXG commit interval - transaction group commit interval - 5s-10s\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"zfs_txg_synctime"}),"\n",(0,l.jsx)(s.li,{children:"\u589E\u52A0 \u4E8B\u52A1 \u5EF6\u65F6\u6765\u589E\u52A0\u4F7F\u7528\u7684 slog"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.admonition,{type:"tip",children:[(0,l.jsx)(s.p,{children:"\u5C0F\u7684\u5199\u64CD\u4F5C\u4F1A\u5148\u805A\u5408\u91CD\u6392\u5E8F\uFF0C\u7136\u540E\u4E00\u6B21\u6027\u5199\u5165\uFF0C\u6B64\u65F6\u4F7F\u7528 SLOG \u80FD\u63D0\u5347\u6027\u80FD"}),(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u907F\u514D write IOPS amplification"}),"\n"]}),(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"\u65E0 SLOG"})}),(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"async write -> TXG RAM -> ZPool"}),"\n",(0,l.jsx)(s.li,{children:"sync write -> TXG RAM & ZIL"}),"\n",(0,l.jsx)(s.li,{children:"TXG RAM -> ZPool"}),"\n"]}),(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"\u6709 SLOG"})}),(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"sync write -> TXG RAM & SLOG"}),"\n",(0,l.jsx)(s.li,{children:"\u7CFB\u7EDF\u6062\u590D\u65F6 SLOG -> TXG RAM -> replay TXG -> ZPool"}),"\n"]})]}),"\n",(0,l.jsx)(s.h3,{id:"sync",children:"sync"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["sync=standard\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"POSIX-compatible"}),"\n",(0,l.jsx)(s.li,{children:"synchronous only if requested"}),"\n",(0,l.jsx)(s.li,{children:"\u90E8\u5206\u60C5\u51B5\u4F1A\u5199\u5165\u5230 slog"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["sync=always\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u4E3B\u8981\u4FDD\u969C\u6570\u636E\u5B89\u5168"}),"\n",(0,l.jsx)(s.li,{children:"\u6709\u4E9B\u4E0D\u652F\u6301 journal \u7684 DB \u5FC5\u987B\u8981 sync"}),"\n",(0,l.jsx)(s.li,{children:"slog \u5F88\u5FEB \u53EF\u4EE5\u8003\u8651"}),"\n",(0,l.jsxs)(s.li,{children:["\u4F1A\u5F3A\u5236\u5148\u5199\u5165\u5230 log \u8BBE\u5907 - ",(0,l.jsx)(s.strong,{children:"\u4E0D\u4F1A\u589E\u52A0\u6027\u80FD"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["sync=disabled - sync=never, sync=off\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u8BA9\u5199\u5165\u66F4\u5FEB"}),"\n",(0,l.jsx)(s.li,{children:"\u5FFD\u7565 O_SYNC"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-bash",children:'# txg \u63D0\u4EA4\u95F4\u9694 - 5\u79D2\ncat /sys/module/zfs/parameters/zfs_txg_timeout\n# \u589E\u52A0 slog \u4F7F\u7528\u91CF, 180s \u63D0\u4EA4\u4E00\u6B21\necho 180 | sudo tee /sys/module/zfs/parameters/zfs_txg_timeout\n\n# \u6301\u4E45\u5316\necho "options zfs zfs_txg_timeout=180" | sudo tee /etc/modprobe.d/zfs.conf\n'})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(s.table,{children:[(0,l.jsx)(s.thead,{children:(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.th,{children:"parameter"}),(0,l.jsx)(s.th,{children:"default"}),(0,l.jsx)(s.th,{children:"prefer"}),(0,l.jsx)(s.th,{children:"note"})]})}),(0,l.jsxs)(s.tbody,{children:[(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"zfs_txg_timeout"}),(0,l.jsx)(s.td,{children:"5"}),(0,l.jsx)(s.td,{children:"120"}),(0,l.jsx)(s.td,{children:"\u5F3A\u5236\u63D0\u4EA4 Transaction Group (TXG) \u7684\u65F6\u95F4\u95F4\u9694,\u66F4\u5927\u7684\u503C\u53EF\u4EE5\u805A\u5408\u66F4\u591A\u6570\u636E"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"---"}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"zfs_dirty_data_max"}),(0,l.jsx)(s.td,{children:"10% RAM"}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"zfs_dirty_data_max_percent"}),(0,l.jsx)(s.td,{children:"10% RAM"}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"zfs_dirty_data_sync_percent"}),(0,l.jsx)(s.td,{children:"20"}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{children:"\u8FBE\u5230 zfs_dirty_data_max \u6BD4\u4F8B\u540E\u51FA\u53D1 sync"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"zfs_dirty_data_max_max"}),(0,l.jsx)(s.td,{children:"25% RAM"}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"zfs_dirty_data_max_max_percent"}),(0,l.jsx)(s.td,{children:"25% RAM"}),(0,l.jsx)(s.td,{}),(0,l.jsx)(s.td,{})]})]})]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://jrs-s.net/2019/05/02/zfs-sync-async-zil-slog/",children:"https://jrs-s.net/2019/05/02/zfs-sync-async-zil-slog/"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://www.truenas.com/blog/zfs-zil-and-slog-demystified/",children:"https://www.truenas.com/blog/zfs-zil-and-slog-demystified/"})}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"logbias",children:"logbias"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["logbias=latency\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u65E0 SLOG\uFF0Cblock \u8F83\u5927\u80FD\u63D0\u5347\u6027\u80FD"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["logbias=throughput\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u5C0F block \u5199\u5165\u4EA7\u751F\u975E\u5E38\u591A\u788E\u7247"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-bash",children:"zfs send dataset >/dev/null\n\nzpool iostat -r 1\n"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias",children:"https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias"})}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"ashift",children:"ashift"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(s.table,{children:[(0,l.jsx)(s.thead,{children:(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.th,{style:{textAlign:"right"},children:"ashift"}),(0,l.jsx)(s.th,{style:{textAlign:"right"},children:"sector"})]})}),(0,l.jsxs)(s.tbody,{children:[(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"9"}),(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"512 B"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"10"}),(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"1 KB"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"11"}),(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"2 KB"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"12"}),(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"4 KB"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"13"}),(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"8 KB"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"14"}),(0,l.jsx)(s.td,{style:{textAlign:"right"},children:"16 KB"})]})]})]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"12=4KB - \u5E38\u7528\u7684 PageSize"}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"l2arc",children:"L2ARC"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u8BFB\u7F13\u5B58"}),"\n",(0,l.jsx)(s.li,{children:"ARC \u4E3A\u5185\u5B58"}),"\n",(0,l.jsx)(s.li,{children:"L2ARC \u4E3A cache \u8BBE\u5907"}),"\n",(0,l.jsx)(s.li,{children:"\u4E4B\u524D\u662F\u8986\u76D6\u5199"}),"\n",(0,l.jsxs)(s.li,{children:["\u76EE\u524D\u652F\u6301 TRIM - ",(0,l.jsx)(s.a,{href:"https://github.com/zfsonlinux/zfs/pull/9789",children:"https://github.com/zfsonlinux/zfs/pull/9789"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"l2arc_trim_ahead - \u9700\u8981\u65F6\u591A trim \u591A\u5C11"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-bash",children:"# \u53EF\u67E5\u770B SSD trim \u652F\u6301\u60C5\u51B5\nzpool status -t\n# \u89E6\u53D1 pool\nzpool trim pool\n"})}),"\n",(0,l.jsx)(s.h2,{id:"\u78C1\u76D8\u4FE1\u606F",children:"\u78C1\u76D8\u4FE1\u606F"}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-bash",children:"# sector size\n# phy sector size\nblockdev --getss --getpbsz /dev/sda\n\ncat /sys/block/sd{a,b}/queue/{logical_block_size,physical_block_size,optimal_io_size}\n"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.a,{href:"https://github.com/bradfa/flashbench",children:"bradfa/flashbench"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u68C0\u6D4B\u95EA\u5B58\u7684 block size"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"atime-on-temporary",children:"atime on temporary"}),"\n",(0,l.jsx)(s.p,{children:"atime \u603B\u662F\u4E3A on"}),"\n",(0,l.jsx)(s.h2,{id:"zfs_vdev_mirror_rotating_inc",children:"zfs_vdev_mirror_rotating_inc"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["mirror ssd + hdd\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\u4FDD\u7559\u8BFB\u6027\u80FD"}),"\n",(0,l.jsx)(s.li,{children:"\u5199\u6027\u80FD\u65E0\u6CD5\u4FDD\u969C"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"ssd-trim",children:"SSD TRIM"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"zpool set autotrim=on"})," + cron ",(0,l.jsx)(s.code,{children:"zpool trim"})]}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7",children:"https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://openzfs.github.io/openzfs-docs/man/8/zpool-trim.8.html",children:"https://openzfs.github.io/openzfs-docs/man/8/zpool-trim.8.html"})}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"\u53C2\u8003",children:"\u53C2\u8003"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.a,{href:"https://www.youtube.com/watch?v=1Wo3i2gkAIk",children:"How the ZFS Adaptive Replacement Cache works"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.strong,{children:"Free RAM is wasted RAM"})}),"\n",(0,l.jsx)(s.li,{children:"ARC \u7EF4\u62A4 LRU,LFU"}),"\n",(0,l.jsx)(s.li,{children:"\u7F13\u5B58 fs \u548C metadata - metadata \u9ED8\u8BA4 25% cache"}),"\n",(0,l.jsx)(s.li,{children:"Compress ARC - \u5B58\u50A8\u66F4\u591A\u7F13\u5B58"}),"\n",(0,l.jsx)(s.li,{children:"block - 512b - 16MB"}),"\n",(0,l.jsx)(s.li,{children:"\u57FA\u4E8E\u5185\u5B58\u538B\u529B\u8C03\u6574\u4F7F\u7528\u7684\u7F13\u5B58\u91CF - adaptive"}),"\n",(0,l.jsxs)(s.li,{children:["tuning\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"file server - \u5927 ARC, \u7F13\u5B58\u66F4\u591A metadata, \u53EF\u8003\u8651 L2ARC"}),"\n",(0,l.jsx)(s.li,{children:"block storage/iSCSI - \u5927 ARC, \u914D\u7F6E volblocksize"}),"\n",(0,l.jsx)(s.li,{children:"Database/A - \u5C0F ARC, \u53EA\u7F13\u5B58 metadata, large db buffer cache"}),"\n",(0,l.jsx)(s.li,{children:"Database/B - \u4E2D ARC, \u53EA\u7F13\u5B58 metadata, small db buffer cache, compression \u80FD\u8BA9 ARC \u547D\u4E2D\u66F4\u591A\u7F13\u5B58"}),"\n",(0,l.jsx)(s.li,{children:"Hypervisor - \u4E2D\u5C0F ARC, \u4E3A VM \u9884\u7559\u5185\u5B58, \u907F\u514D\u53CC\u7F13\u5B58"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html",children:"Workload Tuning"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["PosstgreSQL - ",(0,l.jsx)(s.a,{href:"https://vadosware.io/post/everything-ive-seen-on-optimizing-postgres-on-zfs-on-linux/",children:"Everything I've seen on optimizing Postgres on ZFS"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"recordsize=8K"}),"\n",(0,l.jsx)(s.li,{children:"logbias=throughput"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["MySQL InnoDB\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"recordsize=16K"}),"\n",(0,l.jsx)(s.li,{children:"primarycache=metadata"}),"\n",(0,l.jsx)(s.li,{children:"logbias=throughput"}),"\n",(0,l.jsxs)(s.li,{children:["my.cnf\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"skip-innodb_doublewrite"}),"\n",(0,l.jsx)(s.li,{children:"innodb_use_native_aio=0"}),"\n",(0,l.jsx)(s.li,{children:"innodb_use_atomic_writes=0"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://www.delphix.com/blog/delphix-engineering/zfs-raidz-stripe-width-or-how-i-learned-stop-worrying-and-love-raidz",children:"ZFS RAIDZ stripe width, or: How I Learned to Stop Worrying and Love RAIDZ"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://www.unixarena.com/2013/07/zfs-how-to-extend-zpool-and-re-layout.html",children:"ZFS \u2013 How to Extend ZPOOL and Re-layout ?"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://docs.oracle.com/cd/E23824_01/html/821-1448/ftyue.html",children:"ZFS Terminology"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://docs.google.com/spreadsheets/d/1pdu_X2tR4ztF6_HLtJ-Dc4ZcwUdt6fkCjpnXxAEFlyA",children:"ZFS overhead calc.xlsx"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://blogs.oracle.com/roch/tuning-zfs-recordsize",children:"Tuning ZFS recordsize"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Module%20Parameters.html",children:"Module Parameters"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://calomel.org/freebsd_network_tuning.html",children:"https://calomel.org/freebsd_network_tuning.html"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.a,{href:"https://docs.freebsd.org/en/books/handbook/zfs/#zfs-advanced-tuning",children:"https://docs.freebsd.org/en/books/handbook/zfs/#zfs-advanced-tuning"})}),"\n"]})]})}function x(n={}){let{wrapper:s}={...(0,r.R)(),...n.components};return s?(0,l.jsx)(s,{...n,children:(0,l.jsx)(o,{...n})}):o(n)}},17776:function(n,s,e){e.d(s,{R:()=>t,x:()=>d});var i=e(7378);let l={},r=i.createContext(l);function t(n){let s=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(s):{...s,...n}},[s,n])}function d(n){let s;return s=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),i.createElement(r.Provider,{value:s},n.children)}}}]);