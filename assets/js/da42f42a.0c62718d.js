"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["594654"],{875331:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>o,toc:()=>c,default:()=>h,metadata:()=>r,assets:()=>l,contentTitle:()=>i});var r=JSON.parse('{"id":"devops/kubernetes/ops/rke","title":"RKE - \u5B89\u88C5\u5668","description":"- \u662F\u4EC0\u4E48","source":"@site/../notes/devops/kubernetes/ops/rke.md","sourceDirName":"devops/kubernetes/ops","slug":"/devops/kubernetes/ops/rke","permalink":"/notes/devops/kubernetes/ops/rke","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/ops/rke.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1652772118000,"frontMatter":{"title":"RKE - \u5B89\u88C5\u5668"},"sidebar":"docs","previous":{"title":"RBAC","permalink":"/notes/devops/kubernetes/ops/rbac"},"next":{"title":"RKE2","permalink":"/notes/devops/kubernetes/ops/rke2"}}'),t=s(486106),a=s(917776);let o={title:"RKE - \u5B89\u88C5\u5668"},i="RKE",l={},c=[{value:"\u5B89\u88C5",id:"\u5B89\u88C5",level:2},{value:"\u8FD0\u7EF4",id:"\u8FD0\u7EF4",level:2},{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"FAQ",id:"faq",level:2},{value:"Error response from daemon: linux mounts: path /var/lib/rancher is mounted on / but it is not a shared mount",id:"error-response-from-daemon-linux-mounts-path-varlibrancher-is-mounted-on--but-it-is-not-a-shared-mount",level:3},{value:"Failed to get job complete status for job rke-network-plugin-deploy-job in namespace kube-system",id:"failed-to-get-job-complete-status-for-job-rke-network-plugin-deploy-job-in-namespace-kube-system",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"rke",children:"RKE"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u662F\u4EC0\u4E48\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"K8S \u96C6\u7FA4\u5B89\u88C5\u5668"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://rancher.com/docs/rke/latest/en/config-options/",children:"\u914D\u7F6E\u9879"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://rancher.com/docs/rke/latest/en/example-yamls/",children:"cluster-example.yaml"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u7CFB\u7EDF\u955C\u50CF ",(0,t.jsx)(n.a,{href:"https://github.com/rancher/kontainer-driver-metadata/blob/master/rke/k8s_rke_system_images.go",children:"k8s_rke_system_images.go"})]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/setup/release/notes/",children:"K8S Release Note"})}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"RKE2 \u4E0E RKE1 \u533A\u522B\u5F88\u5927"}),"\n"]})}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u975E\u5E38\u5EFA\u8BAE\u4F7F\u7528\u79C1\u6709\u4ED3\u5E93\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"air-gap \u9700\u8981 g \u7EA7\u522B\u7684\u538B\u7F29\u5305 - \u975E\u5E38\u6162"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"\u6CE8\u610F\u5F00\u542F SSH \u7684 AllowTcpForwarding"}),"\n",(0,t.jsxs)(n.li,{children:["\u6CE8\u610F\u8282\u70B9\u9700\u8981\u4E00\u4E9B\u63D0\u524D\u914D\u7F6E - \u53C2\u8003 ",(0,t.jsx)(n.a,{href:"https://github.com/wenerme/alpine-admin/blob/master/roles/alpine/tasks/k8s-prepare.yaml",children:"k8s-prepare"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u5B89\u88C5\u540E\u9700\u8981\u505A\u7684\u4E8B\u60C5\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u6DFB\u52A0 PV - \u4F8B\u5982 nfs-client-provisioner\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u4E0D\u6DFB\u52A0\u4F1A\u5BFC\u81F4\u9700\u8981\u6301\u4E45\u5B58\u50A8\u7684\u65E0\u6CD5\u62FF\u5230 PVC"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6DFB\u52A0 LoadBalancer \u63A7\u5236\u5668 - \u4F8B\u5982 metallb\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u4E0D\u6DFB\u52A0\u4F1A\u5BFC\u81F4 LoadBalancer \u62FF\u4E0D\u5230 ip - \u4F8B\u5982 istio-ingresgateway (rancher \u53EF\u914D\u7F6E\u4F7F\u7528 NodePort)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(n.h2,{id:"\u5B89\u88C5",children:"\u5B89\u88C5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u4E0B\u8F7D\u6700\u65B0\u7248\nrke_version=$(curl -s https://api.github.com/repos/rancher/rke/releases/latest | jq -r .tag_name)\nfor f in rke_{darwin-amd64,linux-amd64}; do curl -LO https://github.com/rancher/rke/releases/download/${rke_version}/$f; chmod +x $f; done;\n# \u6620\u5C04\u4E3A rke \u547D\u4EE4\nln -fs rke_$(uname -o | grep -qi darwin && echo darwin-amd64 || echo linux-amd64) rke\n# \u67E5\u770B\u5F53\u524D\u7248\u672C\n./rke -v\n# \u522B\u540D\u540E\u5C31\u4E0D\u9700\u8981 ./\nalias rke=$PWD/rke\nrke -v\n\n# \u67E5\u770B\u6240\u6709 rancher \u7248\u672C\nrke config --list-version --all\n# \u7CFB\u7EDF\u955C\u50CF\n# \u7CFB\u7EDF\u955C\u50CF\u4E0D\u5305\u542B quay \u548C gcr - \u5DF2\u7ECF\u6620\u5C04\u4E3A rancher \u4E0B\u7684\u955C\u50CF\nrke config --system-images\n\n# \u5982\u679C\u4F7F\u7528\u79C1\u6709\u4ED3\u5E93\u53EF\u4EE5\u63D0\u524D\u7F13\u5B58\u7CFB\u7EDF\u955C\u50CF - \u4F8B\u5982 registry.wener.me\nrke config --system-images | tail -n +2 | xargs -I {} -n 1 docker pull registry.wener.me/{}\n\n# \u914D\u7F6E\u597D clutser.yml\n\n# \u6267\u884C\u5B89\u88C5 - \u53EF\u91CD\u590D\u6267\u884C - \u53EF\u6DFB\u52A0\u8282\u70B9\u540E\u6267\u884C\n# \u9ED8\u8BA4\u4F7F\u7528 clutser.yml \u6587\u4EF6\nrke up --config cluster.yml\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u8FD0\u7EF4",children:"\u8FD0\u7EF4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u4E00\u6B21\u6027\u5907\u4EFD etcd\nrke etcd snapshot-save --name <SNAPSHOT.db> --config rancher-cluster.yml\n# \u4E00\u6B21\u6027\u5907\u4EFD\u5230 s3\nrke etcd snapshot-save --config rancher-cluster.yml --name snapshot-name  \\\n--s3 --access-key S3_ACCESS_KEY --secret-key S3_SECRET_KEY \\\n--bucket-name s3-bucket-name  --s3-endpoint  s3.amazonaws.com \\\n--folder folder-name\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# \u96C6\u7FA4\u540D\u5B57 - \u5EFA\u8BAE\u66F4\u6539 - \u9ED8\u8BA4 local\ncluster_name: center\n# \u5B89\u88C5\u76EE\u5F55 - \u4F1A\u8BB0\u5F55 etcd \u5FEB\u7167 /opt/rke/etcd-snapshots\nprefix_path: /opt/rke\n\n# \u5EFA\u8BAE\u4F7F\u7528 ssh-agent\nssh_agent_auth: true\n# \u53EF\u9009 - \u5982\u679C\u6709 agent \u53EF\u4EE5\u4E0D\u7528\u914D\u7F6E\n# ssh_key_path: ~/.ssh/rke_rsa\n\n# \u8282\u70B9\u4FE1\u606F\nnodes:\n  - address: 10.0.0.1 # \u5916\u90E8\u5730\u5740\n    # \u5185\u90E8\u5730\u5740 - \u53EF\u9009 - \u96C6\u7FA4\u5185\u90E8\u901A\u4FE1\u4F7F\u7528\n    internal_address: 192.168.1.1\n    # \u590D\u5199 hostname \u540E\u5728 rancher \u7BA1\u7406\u9875\u9762\u770B\u5230\u7684\u662F\u540D\u5B57\u800C\u4E0D\u662F ip\n    hostname_override: k8snode1\n    # \u4F7F\u7528\u7684 ssh \u7528\u6237 - \u6CA1\u6709\u5168\u5C40\u914D\u7F6E\u9700\u8981\u6BCF\u4E2A\u914D\u7F6E\n    user: admin\n    # \u8282\u70B9\u7684\u89D2\u8272 - \u57FA\u7840\u8BA1\u7B97\u8282\u70B9\u53EA\u9700\u8981 worker \u5373\u53EF\n    role: [controlplane, etcd, worker]\n\n# \u670D\u52A1\u4FE1\u606F\nservices:\n  etcd:\n    # etcd \u81EA\u52A8\u5907\u4EFD - \u53EF\u9009\n    backup_config:\n      # \u542F\u7528\u5FEB\u7167\n      enabled: true\n      # \u589E\u91CF\u5907\u4EFD\u95F4\u9694\n      interval_hours: 6\n      # \u4FDD\u7559\u5929\u6570\n      retention: 60\n      # \u53EF\u9009\u914D\u7F6E\n      s3backupconfig:\n        access_key: 'myaccesskey'\n        secret_key: 'myaccesssecret'\n        bucket_name: 'my-backup-bucket'\n        folder: 'folder-name'\n        endpoint: 's3.eu-west-1.amazonaws.com'\n        region: 'eu-west-1'\n\n# \u79C1\u6709\u4ED3\u5E93 - \u975E\u5E38\u5EFA\u8BAE\nprivate_registries:\n  - url: registry.wener.me\n    # \u591A\u4E2A - \u53EF\u8BBE\u7F6E\u9ED8\u8BA4\n    is_default: true\n"})}),"\n",(0,t.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,t.jsx)(n.h3,{id:"error-response-from-daemon-linux-mounts-path-varlibrancher-is-mounted-on--but-it-is-not-a-shared-mount",children:"Error response from daemon: linux mounts: path /var/lib/rancher is mounted on / but it is not a shared mount"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mount --make-rshared /\n\n# \u5F00\u673A\u542F\u52A8\u8BBE\u7F6E\nrc-update add local\ncat <<CONF > /etc/local.d/00-mount-shared-root.start\n#!/bin/sh\nmount --make-rshared /\nCONF\n"})}),"\n",(0,t.jsx)(n.h3,{id:"failed-to-get-job-complete-status-for-job-rke-network-plugin-deploy-job-in-namespace-kube-system",children:"Failed to get job complete status for job rke-network-plugin-deploy-job in namespace kube-system"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5C1D\u8BD5\u518D\u6B21\u6267\u884C\uFF0C\u4E00\u822C\u4F1A\u597D"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/rancher/rancher/issues/19713",children:"#19713"})}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},917776:function(e,n,s){s.d(n,{R:()=>o,x:()=>i});var r=s(7378);let t={},a=r.createContext(t);function o(e){let n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);