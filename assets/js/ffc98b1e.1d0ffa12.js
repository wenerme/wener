"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["686552"],{513422:function(n,e,l){l.r(e),l.d(e,{frontMatter:()=>t,toc:()=>o,default:()=>a,metadata:()=>s,assets:()=>c,contentTitle:()=>d});var s=JSON.parse('{"id":"db/relational/postgresql/postgresql-ddl","title":"DDL","description":"CREATE TABLE","source":"@site/../notes/db/relational/postgresql/postgresql-ddl.md","sourceDirName":"db/relational/postgresql","slug":"/db/relational/postgresql/ddl","permalink":"/notes/db/relational/postgresql/ddl","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-ddl.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1657890515000,"frontMatter":{"title":"DDL"},"sidebar":"docs","previous":{"title":"Date","permalink":"/notes/db/relational/postgresql/date"},"next":{"title":"PostgreSQL Troubleshooting","permalink":"/notes/db/relational/postgresql/debug"}}'),i=l(486106),r=l(917776);let t={title:"DDL"},d="PostgreSQL DDL",c={},o=[{value:"CREATE TABLE",id:"create-table",level:2},{value:"ALTER TABLE",id:"alter-table",level:2},{value:"\u7EE7\u627F\u8868",id:"\u7EE7\u627F\u8868",level:2},{value:"add constraint if not exists",id:"add-constraint-if-not-exists",level:2}];function h(n){let e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"postgresql-ddl",children:"PostgreSQL DDL"})}),"\n",(0,i.jsx)(e.h2,{id:"create-table",children:"CREATE TABLE"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u533A\u5206 column_constraint, table_constraint"}),"\n",(0,i.jsxs)(e.li,{children:["INHERITS - \u7EE7\u627F\u6E90\u8868\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u53EF\u4EE5\u662F \u672C\u5730\u8868\u6216\u8FDC\u7A0B\u8868"}),"\n",(0,i.jsx)(e.li,{children:"\u4F1A\u5EFA\u7ACB\u5173\u7CFB - \u4FEE\u6539\u7236\u8868\u5F71\u54CD\u5B50\u8868"}),"\n",(0,i.jsx)(e.li,{children:"\u53EF\u8986\u76D6\u5217\u5B9A\u4E49 - \u4F46\u7C7B\u578B\u8981\u5339\u914D"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["LIKE - \u590D\u5236\u6E90\u8868\u4FE1\u606F -\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u53EF\u590D\u5236 \u672C\u5730\u8868\u3001\u89C6\u56FE\u3001\u8FDC\u7A0B\u8868\u3001\u7EC4\u5408\u7C7B\u578B"}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"{ INCLUDING | EXCLUDING } { COMMENTS | COMPRESSION | CONSTRAINTS | DEFAULTS | GENERATED | IDENTITY | INDEXES | STATISTICS | STORAGE | ALL }"})}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u9009\u9879\u4E3A EXCLUDING\uFF0C\u4E5F\u5C31\u662F\u5305\u542B\u6240\u6709"}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"INCLUDING CONSTRAINTS"})," \u662F\u5305\u542B ",(0,i.jsx)(e.code,{children:"CHECK"}),", \u800C\u4E0D\u5305\u542B \u5916\u952E"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6CE8\u610F"})," \u4E0D\u5305\u542B FOREIGN KEY"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u5916\u952E\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"addition foreign key constraint - \u88AB\u5F15\u7528\u8868 SHARE ROW EXCLUSIVE"}),"\n",(0,i.jsxs)(e.li,{children:["MATCH\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"SIMPLE - \u9ED8\u8BA4 - \u5141\u8BB8\u4EFB\u610F\u5217 NULL - \u542B NULL \u5219\u4E0D\u9650\u5236"}),"\n",(0,i.jsx)(e.li,{children:"FULL - \u591A\u5916\u952E\u5217\u65F6\u4E0D\u5141\u8BB8\u6709\u4E00\u4E2A\u5217\u4E3A NULL \u9664\u975E\u5168 NULL"}),"\n",(0,i.jsx)(e.li,{children:"PARTIAL - \u672A\u5B9E\u73B0"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["ON DELETE|UPDATE\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"NO ACTION - \u9ED8\u8BA4 - \u53EF\u4EE5\u5EF6\u8FDF\u68C0\u67E5"}),"\n",(0,i.jsx)(e.li,{children:"RESTRICT - \u540C NO ACTION \u4F46 \u4E0D\u53EF\u4EE5\u5EF6\u8FDF\u68C0\u67E5"}),"\n",(0,i.jsx)(e.li,{children:"CASCADE"}),"\n",(0,i.jsx)(e.li,{children:"SET NULL"}),"\n",(0,i.jsx)(e.li,{children:"SET DEFAULT - \u8BBE\u7F6E\u4E3A\u9ED8\u8BA4\uFF0C\u8981\u6C42\u5F15\u7528\u8868\u4E5F\u80FD\u5339\u914D\u4E0A\u5BF9\u5E94\u884C"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"[NOT] DEFERRABLE"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u662F\u5426\u7ACB\u5373\u68C0\u67E5 - \u53EF\u4EE5\u5728\u4E8B\u52A1\u6700\u540E\u68C0\u67E5"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"INITIALLY {IMMEDIATE|DEFERRED}"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u63A7\u5236\u53EF\u5EF6\u8FDF\u68C0\u67E5\u9650\u5236\u7684 \u68C0\u67E5\u65F6\u95F4"}),"\n",(0,i.jsx)(e.li,{children:"IMMEDIATE - \u7ACB\u5373"}),"\n",(0,i.jsx)(e.li,{children:"DEFERRED - \u4E8B\u52A1\u7ED3\u675F"}),"\n",(0,i.jsxs)(e.li,{children:["\u53EF\u4FEE\u6539 ",(0,i.jsx)(e.code,{children:"SET CONSTRAINTS { ALL | name [, ...] } { DEFERRED | IMMEDIATE }"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["ON COMMIT - \u63A7\u5236\u4E34\u65F6\u8868\u63D0\u4EA4\u65F6\u7684\u884C\u4E3A\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"PRESERVE ROWS"}),"\n",(0,i.jsx)(e.li,{children:"DELETE ROWS"}),"\n",(0,i.jsx)(e.li,{children:"DROP"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/sql-createtable.html",children:"CREATE TABLE"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["PG 11 \u5F00\u59CB\u652F\u6301\u751F\u6210\u5217\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"PG 12 \u652F\u6301 STORED"}),"\n",(0,i.jsx)(e.li,{children:"VIRTUAL - WIP"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"alter-table",children:"ALTER TABLE"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"{ DISABLE | ENABLE } ROW LEVEL SECURITY"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u662F\u5426\u5F00\u542F RLS"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"[NO] FORCE ROW LEVEL SECURITY"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u662F\u5426\u9650\u5236 table owner - \u26A0\uFE0F \u8BE5\u64CD\u4F5C\u4E0D\u4F1A enable RLS"}),"\n",(0,i.jsx)(e.li,{children:"\u9ED8\u8BA4\u4E0D\u9650\u5236 table owner"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/sql-altertable.html",children:"ALTER TABLE"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u67E5\u770B RLS \u72B6\u6001\nselect\n  relname,\n  relrowsecurity,\n  relforcerowsecurity\nfrom\n  pg_class\nwhere\n  relname not like 'pg_%'\n  and relname not like 'sql_%'\n  and relkind = 'r';\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u7EE7\u627F\u8868",children:"\u7EE7\u627F\u8868"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u6743\u9650\u53EA\u6821\u9A8C\u7236\u8868"}),"\n",(0,i.jsxs)(e.li,{children:["\u4E0D\u652F\u6301\u8DE8\u8868 UNIQUE\u3001\u5916\u952E\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7D22\u5F15\u53EA\u80FD\u9488\u5BF9\u5355\u4E2A\u8868"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.li,{children:"INSERT, UPDATE \u9700\u8981\u660E\u786E\u8868"}),"\n",(0,i.jsx)(e.li,{children:"ALTER TABLE \u53EF\u4EE5\u5C06\u8868\u8BBE\u7F6E\u4E3A\u7EE7\u627F\u8868"}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u652F\u6301 ALTER TABLE RENAME"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"SELECT\n  name,\n  elevation -- ONLY \u4E0D\u5305\u542B children \u8868\nFROM\n  ONLY cities\nWHERE\n  elevation > 500;\n\n-- c.tableoid \u6765\u6E90\u8868 - \u5728 pg_class.oid \u627E\u5230\u5B9A\u4E49\nSELECT\n  c.tableoid:: regclass,\n  c.name,\n  c.elevation\nFROM\n  cities c\nWHERE\n  c.elevation > 500;\n\nSELECT\n  name,\n  elevation -- \u663E\u6027\u8981\u6C42\u5305\u542B children - \u9ED8\u8BA4\u5305\u542B - \u4E0D\u5EFA\u8BAE\u4F7F\u7528\u8BE5\u8BED\u6CD5\nFROM\n  cities *\nWHERE\n  elevation > 500;\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/ddl-inherit.html",children:"https://www.postgresql.org/docs/current/ddl-inherit.html"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/tutorial-inheritance.html",children:"https://www.postgresql.org/docs/current/tutorial-inheritance.html"})}),"\n",(0,i.jsxs)(e.li,{children:["\u53EF\u7528\u4E8E\u6570\u636E\u5206\u7247 - ",(0,i.jsx)(e.a,{href:"https://arctype.com/blog/inheritance-in-postgres/",children:"https://arctype.com/blog/inheritance-in-postgres/"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u4E0D\u8FC7\u73B0\u5728\u7684 pg \u5206\u7247\u529F\u80FD\u66F4\u6210\u719F"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"add-constraint-if-not-exists",children:"add constraint if not exists"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"\u57FA\u4E8E\u540D\u5B57\u53BB\u91CD\u590D"}),"\n"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u4E5F\u53EF\u4EE5\u901A\u8FC7\u67E5\u8BE2\u5224\u65AD\u662F\u5426\u5B58\u5728 ",(0,i.jsx)(e.code,{children:"SELECT 1 FROM pg_constraint WHERE conname = 'constraint_name'\""})]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"do $$\nbegin\nalter table tenants add\n  constraint tenants_tid_fkey foreign key (tid) references system_tenants (tid) on delete cascade;\nexception\n  when duplicate_object then raise notice 'Table constraint foo.bar already exists';\nend;\n$$;\n"})}),"\n",(0,i.jsxs)(e.ol,{start:"2",children:["\n",(0,i.jsx)(e.li,{children:"\u67E5\u8BE2\u5224\u65AD\u903B\u8F91\u662F\u5426\u5B58\u5728"}),"\n"]})]})}function a(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(h,{...n})}):h(n)}},917776:function(n,e,l){l.d(e,{R:()=>t,x:()=>d});var s=l(7378);let i={},r=s.createContext(i);function t(n){let e=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:t(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);