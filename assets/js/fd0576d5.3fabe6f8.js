"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["45455"],{55879:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>a,toc:()=>d,default:()=>u,metadata:()=>l,assets:()=>o,contentTitle:()=>r});var l=JSON.parse('{"id":"db/relational/sqlite/sqlite-faq","title":"SQLite FAQ","description":"- \u4E0D\u652F\u6301\u6DFB\u52A0\u975E\u5E38\u91CF\u9ED8\u8BA4\u503C\u7684\u5217","source":"@site/../notes/db/relational/sqlite/sqlite-faq.md","sourceDirName":"db/relational/sqlite","slug":"/db/relational/sqlite/faq","permalink":"/notes/db/relational/sqlite/faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/sqlite/sqlite-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1736508300000,"frontMatter":{"title":"SQLite FAQ","tags":["FAQ"]},"sidebar":"docs","previous":{"title":"SQLean","permalink":"/notes/db/relational/sqlite/sqlean"},"next":{"title":"TiDB","permalink":"/notes/db/relational/tidb"}}'),s=t(86106),i=t(17776);let a={title:"SQLite FAQ",tags:["FAQ"]},r="SQLite FAQ",o={},d=[{value:"attempt to write a readonly database",id:"attempt-to-write-a-readonly-database",level:2},{value:"\u5220\u9664\u4E0D\u652F\u6301 WHERE \u548C ORDER",id:"\u5220\u9664\u4E0D\u652F\u6301-where-\u548C-order",level:2},{value:"Golang database is locked (5) (SQLITE_BUSY)",id:"golang-database-is-locked-5-sqlite_busy",level:2},{value:"sqlite \u4FEE\u590D",id:"sqlite-\u4FEE\u590D",level:2},{value:"35% faster than fs",id:"35-faster-than-fs",level:2},{value:"BLOB or Hex TEXT",id:"blob-or-hex-text",level:2},{value:"cannot drop UNIQUE column",id:"cannot-drop-unique-column",level:2},{value:"count slow",id:"count-slow",level:2}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"sqlite-faq",children:"SQLite FAQ"})}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u4E0D\u652F\u6301\u6DFB\u52A0\u975E\u5E38\u91CF\u9ED8\u8BA4\u503C\u7684\u5217\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Cannot add a column with non-constant default"}),"\n",(0,s.jsxs)(n.li,{children:["\u4E0D\u53EF\u4EE5 ",(0,s.jsx)(n.code,{children:"alter table tab add column my_time timestamp default current_timestamp;"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["timestamp\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"current_timestamp \u8FD4\u56DE\u7684\u662F text"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"strftime('%s', current_timestamp)"})," \u8FD4\u56DE\u7684\u662F integer"]}),"\n",(0,s.jsx)(n.li,{children:"\u53EF\u4EE5\u4F7F\u7528 real \u5B58\u50A8\u9AD8\u7CBE\u5EA6 - \u5305\u542B ms/\u03BCs/ns"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"select hex(randomblob(16));\nselect lower(hex(randomblob(16)));\n-- \u4F2A UUIv4\nselect lower(hex(randomblob(4))) || '-' || lower(hex(randomblob(2))) || '-4' || substr(lower(hex(randomblob(2))),2) || '-' || substr('89ab',abs(random()) % 4 + 1, 1) || substr(lower(hex(randomblob(2))),2) || '-' || lower(hex(randomblob(6)));\n-- \u4F2A UUIv7\nSELECT\n  -- timestamp\n  format('%08x', ((strftime('%s') * 1000) >> 16)) || '-' ||\n  format('%04x', ((strftime('%s') * 1000) + ((strftime('%f') * 1000) % 1000)) & 0xffff) || '-' ||\n  -- version\n  format('%04x', 0x7000 + abs(random()) % 0x0fff) || '-' ||\n  -- variant\n  format('%04x', 0x8000 + abs(random()) % 0x3fff) || '-' ||\n  -- randomness\n  format('%012x', abs(random()) >> 16) AS uuid7;\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"create table if not exists message_log\n(\n  id            text        not null default (lower(hex(randomblob(16)))) primary key,\n  uid           uuid        not null default (lower(hex(randomblob(4))) || '-' || lower(hex(randomblob(2))) || '-4' || substr(lower(hex(randomblob(2))),2) || '-' || substr('89ab',abs(random()) % 4 + 1, 1) || substr(lower(hex(randomblob(2))),2) || '-' || lower(hex(randomblob(6)))),\n  created_at    timestamptz not null default current_timestamp,\n  updated_at    timestamptz not null default current_timestamp,\n  deleted_at    timestamptz,\n  tid           text        not null default 'org_00000000000000000000000000',\n  eid           text,\n\n  user_id       text,\n  session_id    text,\n  connection_id text,\n  message_seq   bigint,\n  url           text,\n  port          integer,\n  seq           bigint,\n  type          bigint,\n  name          text,\n  direction     text,\n  data          json,\n  data_hash     text,\n  remaining     int,\n  key           text unique,\n  size          integer,\n  flags         json,\n  metadata      json,\n  payload       bytea,\n\n  attributes    jsonb       not null default '{}',\n  properties    jsonb       not null default '{}',\n  extensions    jsonb       not null default '{}',\n  unique (tid, eid)\n);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"attempt-to-write-a-readonly-database",children:"attempt to write a readonly database"}),"\n",(0,s.jsx)(n.p,{children:"\u53EF\u80FD\u662F\u6743\u9650\u4E0D\u8DB3"}),"\n",(0,s.jsx)(n.h2,{id:"\u5220\u9664\u4E0D\u652F\u6301-where-\u548C-order",children:"\u5220\u9664\u4E0D\u652F\u6301 WHERE \u548C ORDER"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u9700\u8981\u4ECE\u6E90\u7801\u7F16\u8BD1 ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/compile.html#enable_update_delete_limit",children:"SQLITE_ENABLE_UPDATE_DELETE_LIMIT"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"golang-database-is-locked-5-sqlite_busy",children:"Golang database is locked (5) (SQLITE_BUSY)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"db.SetMaxOpenConns(1)\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5982\u679C\u9700\u8981\u4E0D\u540C\u8868\u5E76\u884C\u64CD\u4F5C\uFF0C\u8003\u8651\u4F7F\u7528\u591A\u4E2A sqlite \u6587\u4EF6"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/mattn/go-sqlite3/issues/274#issuecomment-191597862",children:"https://github.com/mattn/go-sqlite3/issues/274#issuecomment-191597862"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"sqlite-\u4FEE\u590D",children:"sqlite \u4FEE\u590D"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'echo ".dump" | sqlite old.db | sqlite new.db\n'})}),"\n",(0,s.jsx)(n.h2,{id:"35-faster-than-fs",children:"35% faster than fs"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["read\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"avg 10KB"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["write\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"wal"}),"\n",(0,s.jsx)(n.li,{children:"synchronous=NORMAL"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.sqlite.org/fasterthanfs.html",children:"https://www.sqlite.org/fasterthanfs.html"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"blob-or-hex-text",children:"BLOB or Hex TEXT"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["BLOB - \u5B58\u50A8\u66F4\u5C11\u5185\u5BB9\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u4F7F\u7528\u8C03\u8BD5\u4E0D\u65B9\u4FBF"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Hex TEXT - \u5B58\u50A8\u66F4\u591A\u5185\u5BB9\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u66F4\u591A IO\uFF0C\u66F4\u6162"}),"\n",(0,s.jsx)(n.li,{children:"\u4F7F\u7528\u8C03\u8BD5\u53CB\u597D"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"cannot-drop-unique-column",children:"cannot drop UNIQUE column"}),"\n",(0,s.jsx)(n.p,{children:"SQLite \u4E0D\u652F\u6301 drop unique \u5217\uFF0C\u53EA\u6709\u5C1D\u8BD5 rename \u8868\uFF0C\u5EFA\u7ACB\u65B0\u8868\u89E3\u51B3\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"count-slow",children:"count slow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u5982\u679C\u6CA1\u8FDB\u884C\u8FC7\u5220\u9664\uFF0C\u90A3 max(rowid)=count\nselect max(rowid) from tab;\n-- \u907F\u514D count(*) - expain \u4F1A\u53D1\u73B0\u6267\u884C\u903B\u8F91\u4E0D\u540C\nselect count(rowid) from tab;\n"})})]})}function u(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},17776:function(e,n,t){t.d(n,{R:()=>a,x:()=>r});var l=t(7378);let s={},i=l.createContext(s);function a(e){let n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);