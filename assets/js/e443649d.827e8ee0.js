"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["86679"],{34928:function(e,s,n){n.r(s),n.d(s,{frontMatter:()=>l,toc:()=>h,default:()=>o,metadata:()=>r,assets:()=>c,contentTitle:()=>t});var r=JSON.parse('{"id":"devops/web/nginx/nginx-faq","title":"Nginx FAQ","description":"a client request body is buffered to a temporary file","source":"@site/../notes/devops/web/nginx/nginx-faq.md","sourceDirName":"devops/web/nginx","slug":"/devops/web/nginx/faq","permalink":"/notes/devops/web/nginx/faq","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/nginx/nginx-faq.md","tags":[{"inline":true,"label":"FAQ","permalink":"/notes/tags/faq"}],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1712053653000,"frontMatter":{"title":"Nginx FAQ","tags":["FAQ"]},"sidebar":"docs","previous":{"title":"Nginx \u5E38\u7528\u914D\u7F6E","permalink":"/notes/devops/web/nginx/cookbook"},"next":{"title":"Nginx Modules","permalink":"/notes/devops/web/nginx/modules"}}'),i=n(86106),a=n(17776);let l={title:"Nginx FAQ",tags:["FAQ"]},t="Nginx FAQ",c={},h=[{value:"a client request body is buffered to a temporary file",id:"a-client-request-body-is-buffered-to-a-temporary-file",level:2},{value:"\u91CD\u5B9A\u5411\u6CA1\u6709\u7AEF\u53E3",id:"\u91CD\u5B9A\u5411\u6CA1\u6709\u7AEF\u53E3",level:2},{value:"request_uri vs uri",id:"request_uri-vs-uri",level:2},{value:"host vs http_host",id:"host-vs-http_host",level:2},{value:"ssl passthrough",id:"ssl-passthrough",level:2},{value:"closed keepalive connection (104: Connection reset by peer)",id:"closed-keepalive-connection-104-connection-reset-by-peer",level:2}];function d(e){let s={a:"a",annotation:"annotation",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",math:"math",mi:"mi",mrow:"mrow",msub:"msub",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"nginx-faq",children:"Nginx FAQ"})}),"\n",(0,i.jsx)(s.h2,{id:"a-client-request-body-is-buffered-to-a-temporary-file",children:"a client request body is buffered to a temporary file"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"client_body_buffer_size"}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"\u91CD\u5B9A\u5411\u6CA1\u6709\u7AEF\u53E3",children:"\u91CD\u5B9A\u5411\u6CA1\u6709\u7AEF\u53E3"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-conf",children:"# \u4F7F\u7528 http_host\nproxy_set_header Host $http_host;\n# \u6216\u8005\nproxy_set_header Host $host:$server_port;\n"})}),"\n",(0,i.jsxs)(s.h2,{id:"request_uri-vs-uri",children:[(0,i.jsxs)(s.span,{className:"katex",children:[(0,i.jsx)(s.span,{className:"katex-mathml",children:(0,i.jsx)(s.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(s.semantics,{children:[(0,i.jsxs)(s.mrow,{children:[(0,i.jsx)(s.mi,{children:"r"}),(0,i.jsx)(s.mi,{children:"e"}),(0,i.jsx)(s.mi,{children:"q"}),(0,i.jsx)(s.mi,{children:"u"}),(0,i.jsx)(s.mi,{children:"e"}),(0,i.jsx)(s.mi,{children:"s"}),(0,i.jsxs)(s.msub,{children:[(0,i.jsx)(s.mi,{children:"t"}),(0,i.jsx)(s.mi,{children:"u"})]}),(0,i.jsx)(s.mi,{children:"r"}),(0,i.jsx)(s.mi,{children:"i"}),(0,i.jsx)(s.mi,{children:"v"}),(0,i.jsx)(s.mi,{children:"s"})]}),(0,i.jsx)(s.annotation,{encoding:"application/x-tex",children:"request_uri vs "})]})})}),(0,i.jsx)(s.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(s.span,{className:"base",children:[(0,i.jsx)(s.span,{className:"strut",style:{height:"0.854em",verticalAlign:"-0.1944em"}}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"re"}),(0,i.jsx)(s.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"q"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"u"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"es"}),(0,i.jsxs)(s.span,{className:"mord",children:[(0,i.jsx)(s.span,{className:"mord mathnormal",children:"t"}),(0,i.jsx)(s.span,{className:"msupsub",children:(0,i.jsxs)(s.span,{className:"vlist-t vlist-t2",children:[(0,i.jsxs)(s.span,{className:"vlist-r",children:[(0,i.jsx)(s.span,{className:"vlist",style:{height:"0.1514em"},children:(0,i.jsxs)(s.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,i.jsx)(s.span,{className:"pstrut",style:{height:"2.7em"}}),(0,i.jsx)(s.span,{className:"sizing reset-size6 size3 mtight",children:(0,i.jsx)(s.span,{className:"mord mathnormal mtight",children:"u"})})]})}),(0,i.jsx)(s.span,{className:"vlist-s",children:"\u200B"})]}),(0,i.jsx)(s.span,{className:"vlist-r",children:(0,i.jsx)(s.span,{className:"vlist",style:{height:"0.15em"},children:(0,i.jsx)(s.span,{})})})]})})]}),(0,i.jsx)(s.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"},children:"r"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"i"}),(0,i.jsx)(s.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"v"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"s"})]})})]}),"uri"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"$request_uri"})," - \u4FDD\u7559\u67E5\u8BE2\u53C2\u6570\uFF0C",(0,i.jsx)(s.code,{children:"?"})," \u90E8\u5206"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"$uri"})," - \u53EA\u6709\u8DEF\u5F84"]}),"\n"]}),"\n",(0,i.jsxs)(s.h2,{id:"host-vs-http_host",children:[(0,i.jsxs)(s.span,{className:"katex",children:[(0,i.jsx)(s.span,{className:"katex-mathml",children:(0,i.jsx)(s.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(s.semantics,{children:[(0,i.jsxs)(s.mrow,{children:[(0,i.jsx)(s.mi,{children:"h"}),(0,i.jsx)(s.mi,{children:"o"}),(0,i.jsx)(s.mi,{children:"s"}),(0,i.jsx)(s.mi,{children:"t"}),(0,i.jsx)(s.mi,{children:"v"}),(0,i.jsx)(s.mi,{children:"s"})]}),(0,i.jsx)(s.annotation,{encoding:"application/x-tex",children:"host vs "})]})})}),(0,i.jsx)(s.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(s.span,{className:"base",children:[(0,i.jsx)(s.span,{className:"strut",style:{height:"0.6944em"}}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"h"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"os"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"t"}),(0,i.jsx)(s.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"v"}),(0,i.jsx)(s.span,{className:"mord mathnormal",children:"s"})]})})]}),"http_host"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["$host\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u6A21\u5757\u5B9A\u4E49\u53D8\u91CF"}),"\n",(0,i.jsxs)(s.li,{children:["\u53EF\u80FD\u662F HTTP Host \u5934\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\u6B64\u65F6\u4E0E ",(0,i.jsx)(s.code,{children:"$http_host"})," \u7C7B\u4F3C"]}),"\n",(0,i.jsx)(s.li,{children:"\u5C0F\u5199\uFF0C\u6CA1\u6709\u7AEF\u53E3"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:"\u53EF\u80FD\u662F URL \u4E2D\u7684 HOST"}),"\n",(0,i.jsx)(s.li,{children:"\u53EF\u80FD\u662F \u7B2C\u4E00\u4E2A server_name"}),"\n",(0,i.jsx)(s.li,{children:"\u5982\u679C server_name \u5305\u542B\u6B63\u5219\uFF0C\u90A3\u4E48 $host \u4E5F\u4F1A - \u5BFC\u81F4\u51FA\u73B0\u96BE\u770B\u7684\u8DEF\u5F84"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"$server_name"})," \u603B\u662F\u7B2C\u4E00\u4E2A ",(0,i.jsx)(s.code,{children:"server_name"})]}),"\n",(0,i.jsx)(s.li,{children:"\u53EF\u80FD\u4E0D\u5305\u542B port"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["$http_host\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\u901A\u8FC7 ",(0,i.jsx)(s.a,{href:"http://nginx.org/en/docs/http/ngx_http_core_module.html#variables",children:"$http_HEADER"})," \u5B9A\u4E49"]}),"\n",(0,i.jsx)(s.li,{children:"\u4E0E HTTP \u5934\u4E2D\u4FE1\u606F\u4FDD\u6301\u4E00\u81F4"}),"\n",(0,i.jsx)(s.li,{children:"\u5305\u542B port"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"ssl-passthrough",children:"ssl passthrough"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"by sni"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"nginx -V | grep stream_ssl_preread_module\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-conf",children:"stream {\n\n  map $ssl_preread_server_name $targetBackend {\n    ab.mydomain.com  upstream1.example.com:443;\n    xy.mydomain.com  upstream2.example.com:443;\n  }\n\n  server {\n    listen 443;\n\n    proxy_connect_timeout 1s;\n    proxy_timeout 3s;\n    resolver 1.1.1.1;\n\n    proxy_pass $targetBackend;\n    ssl_preread on;\n  }\n}\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://gist.github.com/kekru/c09dbab5e78bf76402966b13fa72b9d2",children:"https://gist.github.com/kekru/c09dbab5e78bf76402966b13fa72b9d2"})}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"by stream"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-conf",children:"stream {\n  server {\n    listen 443;\n    proxy_pass backend.example.com:443;\n  }\n}\n"})}),"\n",(0,i.jsx)(s.h2,{id:"closed-keepalive-connection-104-connection-reset-by-peer",children:"closed keepalive connection (104: Connection reset by peer)"})]})}function o(e={}){let{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},17776:function(e,s,n){n.d(s,{R:()=>l,x:()=>t});var r=n(7378);let i={},a=r.createContext(i);function l(e){let s=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(a.Provider,{value:s},e.children)}}}]);