"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["100764"],{878458:function(n,e,i){i.r(e),i.d(e,{frontMatter:()=>l,toc:()=>o,default:()=>x,metadata:()=>s,assets:()=>c,contentTitle:()=>d});var s=JSON.parse('{"id":"devops/service/fabio","title":"fabio","description":"- \u76EE\u524D\u8BE5\u9879\u76EE\u5F00\u53D1\u4E0D\u592A\u6D3B\u8DC3\uFF0C\u4E0D\u5EFA\u8BAE\u7528\u6765\u505A\u4E3B\u8981\u7684\u8DEF\u7531\u6216 Ingress \u89D2\u8272","source":"@site/../notes/devops/service/fabio.md","sourceDirName":"devops/service","slug":"/devops/service/fabio","permalink":"/notes/devops/service/fabio","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/service/fabio.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1630662479000,"frontMatter":{"id":"fabio","title":"fabio"},"sidebar":"docs","previous":{"title":"Consul","permalink":"/notes/devops/service/consul"},"next":{"title":"Istio","permalink":"/notes/devops/service/istio"}}'),t=i(486106),r=i(917776);let l={id:"fabio",title:"fabio"},d="fabio",c={},o=[{value:"\u8DEF\u7531\u914D\u7F6E",id:"\u8DEF\u7531\u914D\u7F6E",level:2},{value:"\u914D\u7F6E",id:"\u914D\u7F6E",level:2},{value:"Consul Policy",id:"consul-policy",level:2}];function h(n){let e={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"fabio",children:"fabio"})}),"\n",(0,t.jsx)(e.admonition,{title:"\u6CE8\u610F \u26A0\uFE0F",type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u76EE\u524D\u8BE5\u9879\u76EE\u5F00\u53D1\u4E0D\u592A\u6D3B\u8DC3\uFF0C\u4E0D\u5EFA\u8BAE\u7528\u6765\u505A\u4E3B\u8981\u7684\u8DEF\u7531\u6216 Ingress \u89D2\u8272"}),"\n",(0,t.jsx)(e.li,{children:"\u7528\u6765\u5C06 consul \u4E0A\u7684\u670D\u52A1\u5BF9\u5916\u66B4\u9732\u8FD8\u662F\u53EF\u4EE5\u7684\uFF0C\u4F46\u4E0D\u5EFA\u8BAE\u4F5C\u4E3A\u552F\u4E00\u4F9D\u8D56"}),"\n"]})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/fabiolb/fabio",children:"fabiolb/fabio"})," - Consul \u5185\u7684\u670D\u52A1 Load-Balancing"]}),"\n",(0,t.jsxs)(e.li,{children:["\u7279\u6027\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u8BBF\u95EE\u65E5\u5FD7"}),"\n",(0,t.jsx)(e.li,{children:"\u8BBF\u95EE\u63A7\u5236"}),"\n",(0,t.jsx)(e.li,{children:"\u8BC1\u4E66\u5B58\u50A8"}),"\n",(0,t.jsx)(e.li,{children:"\u538B\u7F29"}),"\n",(0,t.jsx)(e.li,{children:"HTTP \u5934\u6CE8\u5165"}),"\n",(0,t.jsx)(e.li,{children:"HTTPS \u4E0A\u6E38"}),"\n",(0,t.jsx)(e.li,{children:"PROXY \u534F\u8BAE"}),"\n",(0,t.jsx)(e.li,{children:"\u8DEF\u5F84\u5254\u9664 - Path stripping"}),"\n",(0,t.jsx)(e.li,{children:"SSE"}),"\n",(0,t.jsx)(e.li,{children:"\u539F\u59CB TCP"}),"\n",(0,t.jsx)(e.li,{children:"TCP SNI"}),"\n",(0,t.jsx)(e.li,{children:"HTTPS TCP SNI"}),"\n",(0,t.jsx)(e.li,{children:"\u6D41\u91CF\u63A7\u5236 - \u8DEF\u7531 N% \u5230\u4E0D\u540C\u4E0A\u6E38"}),"\n",(0,t.jsx)(e.li,{children:"\u652F\u6301 Vault \u5B58\u50A8 \u8BC1\u4E66"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u9ED8\u8BA4\u53EA\u4F1A\u5904\u7406\u901A\u8FC7\u76D1\u63A7\u68C0\u67E5\u7684\u670D\u52A1"}),"\n",(0,t.jsx)(e.li,{children:"\u9ED8\u8BA4\u7AEF\u53E3 9999"}),"\n",(0,t.jsx)(e.li,{children:"\u7BA1\u7406\u7AEF\u53E3 9998"}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/fabiolb/fabio/wiki/Routing",children:"\u8DEF\u7531"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["Tags\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"urlprefix-{host}/{path}"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"urlprefix-i.com/static"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.code,{children:"urlprefix-/foo/bar proto=https tlsskipverify=true strip=/foo"})}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"urlprefix-:3306 proto=tcp"})," - TCP \u8DEF\u7531"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://github.com/fabiolb/fabio/blob/master/fabio.properties",children:"fabio.properties"})}),"\n",(0,t.jsxs)(e.li,{children:["\u53C2\u8003\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/weibocom/nginx-upsync-module",children:"weibocom/nginx-upsync-module"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"consul \u751F\u6210 nginx \u914D\u7F6E"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# go\ngo get -u github.com/fabiolb/fabio\n# macOS\nbrew install fabio\n\nconsul agent -dev\n\nconsul kv put fabio/config 'route add wener-me /wener https://wener.me opts \"strip=/wener host=wener.me\"'\n\n# http://localhost:9999/wener\nfabio\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u8DEF\u7531\u914D\u7F6E",children:"\u8DEF\u7531\u914D\u7F6E"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u9ED8\u8BA4\u914D\u7F6E\u8DEF\u5F84 ",(0,t.jsx)(e.code,{children:"/fabio/config"})]}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://fabiolb.net/cfg/",children:"Config Language"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"Options"}),(0,t.jsx)(e.th,{children:"Value"}),(0,t.jsx)(e.th,{children:"Desc"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"allow"}),(0,t.jsx)(e.td,{children:"ip:10.0.0.0/8,ip:fe80::/10"}),(0,t.jsx)(e.td,{children:"\u5141\u8BB8\u8BBF\u95EE\u7684 IP"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"deny"}),(0,t.jsx)(e.td,{children:"ip:10.0.0.0/8,ip:fe80::1234"}),(0,t.jsx)(e.td,{children:"\u4E0D\u5141\u8BB8\u8BBF\u95EE\u7684 IP"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"strip"}),(0,t.jsx)(e.td,{children:"/path"}),(0,t.jsxs)(e.td,{children:["\u8DEF\u5F84\u5254\u9664 - ",(0,t.jsx)(e.code,{children:"/path/to/file"})," -> ",(0,t.jsx)(e.code,{children:"/to/file"})]})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"proto"}),(0,t.jsxs)(e.td,{children:["tcp",(0,t.jsx)(e.br,{}),"https",(0,t.jsx)(e.br,{}),"tcp+sni"]}),(0,t.jsxs)(e.td,{children:["TCP \u7684 dst \u5FC5\u987B\u662F ",(0,t.jsx)(e.code,{children:":<port>"})]})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"pxyproto"}),(0,t.jsx)(e.td,{children:"true"}),(0,t.jsx)(e.td,{children:"PROXY"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"tlsskipverify"}),(0,t.jsx)(e.td,{children:"true"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"host"}),(0,t.jsx)(e.td,{children:"wener"}),(0,t.jsx)(e.td,{children:"Host \u5934\uFF0C\u5982\u679C\u4E3A dst\uFF0C\u5219\u4F1A\u4F7F\u7528\u6CE8\u518C\u7684\u4E0A\u6E38\u4E3B\u673A\u540D"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"register"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"auth"}),(0,t.jsx)(e.td,{}),(0,t.jsx)(e.td,{})]})]})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:'# route add <svc> <src> <dst>[ weight <w>][ tags "<t1>,<t2>,..."][ opts "k1=v1 k2=v2 ..."]\n# \u8F6C\u53D1\u5230 wener.me\nroute add wener-me /wener https://wener.me opts "strip=/wener host=wener.me"\n\n# route del <svc>[ <src>[ <dst>]]\n# route del <svc> tags "<t1>,<t2>,..."\n# route del tags "<t1>,<t2>,..."\n\n# route weight <svc> <src> weight <w> tags "<t1>,<t2>,..."\n# route weight <src> weight <w> tags "<t1>,<t2>,..."\n# route weight <svc> <src> weight <w>\n# route weight service host/path weight w tags "tag1,tag2"\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u914D\u7F6E",children:"\u914D\u7F6E"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://fabiolb.net/ref/",children:"Reference"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"conf type"}),(0,t.jsx)(e.th,{children:"demo"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"fabio.properties"}),(0,t.jsx)(e.td,{children:"metrics.target=stdout"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"env"}),(0,t.jsx)(e.td,{children:"metrics_target=stdout"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"env prefix"}),(0,t.jsx)(e.td,{children:"FABIO_metrics_target=stdout"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"ENV"}),(0,t.jsx)(e.td,{children:"FABIO_METRICS_TARGET=stdout"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"arg"}),(0,t.jsx)(e.td,{children:"-metrics.target stdout"})]})]})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"# \u591A\u534F\u8BAE\u76D1\u542C\nproxy.addr = 172.16.20.11:80;proto=http;rt=60s;wt=30s,\\\n             172.16.20.11:443;proto=https;rt=60s;wt=30s;cs=all;tlsmin=10, \\\n             172.16.20.11:8443;proto=tcp+sni\n"})}),"\n",(0,t.jsx)(e.h2,{id:"consul-policy",children:"Consul Policy"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-hcl",children:'node_prefix {\n  "" {\n    policy = "read"\n  }\n}\nservice {\n  fabio {\n    policy = "write"\n  }\n  gateway {\n    policy = "write"\n  }\n}\nservice_prefix {\n  "" {\n    policy = "write"\n  }\n}\nkey_prefix {\n  "fabio" {\n    policy = "write"\n  }\n}\nagent {\n  // \u53EF\u9650\u5236\u4E3A fabio\n  "" {\n    policy = "read"\n  }\n}\n'})})]})}function x(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(h,{...n})}):h(n)}},917776:function(n,e,i){i.d(e,{R:()=>l,x:()=>d});var s=i(7378);let t={},r=s.createContext(t);function l(n){let e=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:l(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);