"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([["53343"],{75173:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>c,toc:()=>l,default:()=>u,metadata:()=>s,assets:()=>i,contentTitle:()=>o});var s=JSON.parse('{"id":"queue/nats/nats-server","title":"nats-server","description":"| port | for                          |","source":"@site/../notes/queue/nats/nats-server.md","sourceDirName":"queue/nats","slug":"/queue/nats/server","permalink":"/notes/queue/nats/server","draft":false,"unlisted":false,"editUrl":"https://github.com/wenerme/wener/edit/master/notes/../notes/queue/nats/nats-server.md","tags":[],"version":"current","lastUpdatedBy":"wener","lastUpdatedAt":1695042174000,"frontMatter":{"title":"nats-server"},"sidebar":"docs","previous":{"title":"NATS Protocol","permalink":"/notes/queue/nats/protocol"},"next":{"title":"NATS Service","permalink":"/notes/queue/nats/service"}}'),r=t(86106),a=t(17776);let c={title:"nats-server"},o="nats-server",i={},l=[{value:"jwt seutp",id:"jwt-seutp",level:2},{value:"Cluster",id:"cluster",level:2},{value:"cluster",id:"cluster-1",level:2},{value:"jetstream cluster",id:"jetstream-cluster",level:2},{value:"gateway",id:"gateway",level:2},{value:"leafnode",id:"leafnode",level:2},{value:"HELM",id:"helm",level:2},{value:"Account fetch failed: fetching jwt timed out",id:"account-fetch-failed-fetching-jwt-timed-out",level:2},{value:"system_account in config and operator JWT must be identical",id:"system_account-in-config-and-operator-jwt-must-be-identical",level:2},{value:"no nkey seed found",id:"no-nkey-seed-found",level:2},{value:"using nats based account resolver - the system account needs to be specified in configuration or the operator jwt",id:"using-nats-based-account-resolver---the-system-account-needs-to-be-specified-in-configuration-or-the-operator-jwt",level:2},{value:"JetStream not enabled for account (10039)",id:"jetstream-not-enabled-for-account-10039",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"nats-server",children:"nats-server"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"brew install nats-server\n\n# http://127.0.0.1:8222/\nnats-server -js -sd $PWD/jetstream-store -m 8222\n\nnats-server --signal reload\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"port"}),(0,r.jsx)(n.th,{children:"for"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"4222"}),(0,r.jsx)(n.td,{children:"client"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"8222"}),(0,r.jsx)(n.td,{children:"HTTP management"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"6222"}),(0,r.jsx)(n.td,{children:"routing port for clustering."})]})]})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"port: 4222\nmonitor_port: 8222\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"/etc/nats/nats-server.conf"}),"\n",(0,r.jsxs)(n.li,{children:["$var\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u5728\u914D\u7F6E\u91CC\u5B9A\u4E49"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4F7F\u7528 \u73AF\u5883\u53D8\u91CF"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# \u8FDE\u63A5\u914D\u7F6E\nhost: 0.0.0.0\nport: 4222\nlisten: "$host:$port"\n# client_advertise: "$host:$port"\n\n# HTTP monitoring port\nmonitor_port: 8222\n\ntls: {}\ngateway: {}\nleafnode: {}\nmqtt: {}\nwebsocket: {}\n\n# \u8D85\u65F6\u914D\u7F6E\nping_interval: "2m"\nping_max: 2\nwrite_deadline: "10s"\n\n# \u9650\u5236\nmax_connections: 64K\nmax_control_line: 4KB\nmax_payload: 1MB\nmax_pending: 64MB\nmax_subscriptions: 0\n\n# JetStream\njetstream: {\n  store_dir: "/tmp/nats/jetstream"\n  # \u5185\u5B58\u7684 75%\n  # max_memory_store:\n  max_file_store: 1TB\n  # chachapoly, aes\n  # cipher:\n  # 32+\n  # key:\n  max_outstanding_catchup: 32MB\n}\n\nauthorization {\n  # timeout: 3\n\n  # \u540C --auth\n  # nats sub -s nats://s3cr3t@localhost:4222 ">"\n  # \u652F\u6301 bcrypt: nats server passwd\n  token: "s3cr3t"\n\n  # \u5BC6\u7801\u652F\u6301 Bcrypted\n  user: ""\n  password: ""\n  users: [\n        {user: "", password: ""b""}\n  ]\n}\n\naccounts {\n\n}\nno_auth_user:\n\n# \u96C6\u7FA4\u914D\u7F6E\ncluster {\n  # It is recommended to set a cluster name\n  name: "my_cluster"\n\n  # Route connections to be received on any interface on port 6222\n  port: 6222\n\n  # Routes are protected, so need to use them with --routes flag\n  # e.g. --routes=nats-route://ruser:T0pS3cr3t@otherdockerhost:6222\n  authorization {\n    user: ruser\n    password: T0pS3cr3t\n    timeout: 2\n  }\n\n  # Routes are actively solicited and connected to from this server.\n  # This Docker image has none by default, but you can pass a\n  # flag to the nats-server docker image to create one to an existing server.\n  routes = []\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"jwt-seutp",children:"jwt seutp"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"alg ed25519-nkey"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker run -w /nsc --rm -it -v $PWD/nsc:/nsc natsio/nats-box:latest\n\n# -n operator \u540D\u5B57\n# /nsc/nats/nsc/stores\nnsc init -n nats\n\nnsc generate config --nats-resolver > jwt.conf\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'host: 0.0.0.0\nport: 4222\nmonitor_port: 8222\n\njetstream: {\n  store_dir: "./jetstream-store"\n}\n\nwebsocket {\n  port: 9222\n  no_tls: true\n}\n\ninclude ./nsc/jwt.conf\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u6DFB\u52A0\u5B9E\u9645\u4F7F\u7528\u7684 account \u548C user\nnsc add account wener --js-disk-storage 1g\nnsc add user apis\n\n# \u68C0\u67E5\u4FE1\u606F\nnsc list keys\nnsc describe operator\n# nsc edit operator --service-url nats://127.0.0.1:4222\n\n# \u63A8\u9001\u5230 nats\nnsc push -a incs -u nats://127.0.0.1\n\n# \u5BA2\u6237\u7AEF\u8FDE\u63A5\nnats context add nats --server 127.0.0.1:4222 --select --creds ./nkeys/creds/nats/wener/apis.creds\nnats account info\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cluster",children:"Cluster"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"version: '3.5'\nservices:\n  nats:\n    image: nats\n    ports:\n      - '8222:8222'\n    command: '--cluster_name NATS --cluster nats://0.0.0.0:6222 --http_port 8222 '\n    networks: ['nats']\n  nats-1:\n    image: nats\n    command: '--cluster_name NATS --cluster nats://0.0.0.0:6222 --routes=nats://ruser:T0pS3cr3t@nats:6222'\n    networks: ['nats']\n    depends_on: ['nats']\n  nats-2:\n    image: nats\n    command: '--cluster_name NATS --cluster nats://0.0.0.0:6222 --routes=nats://ruser:T0pS3cr3t@nats:6222'\n    networks: ['nats']\n    depends_on: ['nats']\n\nnetworks:\n  nats:\n    name: nats\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cluster-1",children:"cluster"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"--routes [rurl-1, rurl-2]     Routes to solicit and connect\n--cluster nats://host:port    Cluster URL for solicited routes\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"listen: 127.0.0.1:4222\nhttp: 8222\n\ncluster {\n  name: example\n\n  # host/port for inbound route connections from other server\n  listen: localhost:4244\n\n  # Authorization for route connections\n  # Other server can connect if they supply the credentials listed here\n  # This server will connect to discovered routes using this user\n  authorization {\n    user: route_user\n    password: pwd\n    timeout: 0.5\n  }\n\n  # This server establishes routes with these server.\n  # This server solicits new routes and Routes are actively solicited and connected to from this server.\n  # Other servers can connect to us if they supply the correct credentials\n  # in their routes definitions from above.\n  routes = [\n    nats://route_user:pwd@127.0.0.1:4245\n    nats://route_user:pwd@127.0.0.1:4246\n  ]\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u53EA\u4F1A forward client \u6D88\u606F\u7ED9\u76F8\u90BB\u8282\u70B9"}),"\n",(0,r.jsx)(n.li,{children:"gossiping"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"jetstream-cluster",children:"jetstream cluster"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"RAFT"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"gateway",children:"gateway"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"cluster <-> cluster"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.nats.io/running-a-nats-service/configuration/gateways",children:"https://docs.nats.io/running-a-nats-service/configuration/gateways"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"leafnode",children:"leafnode"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u8FDE\u63A5 super cluster"}),"\n",(0,r.jsx)(n.li,{children:"\u5EF6\u4F38 nats-server"}),"\n",(0,r.jsx)(n.li,{children:"\u4F7F\u7528\u672C\u5730 authz+authn"}),"\n",(0,r.jsx)(n.li,{children:"\u672C\u5730 low RTT"}),"\n",(0,r.jsx)(n.li,{children:"\u4E0D\u9700\u8981\u80FD\u8BBF\u95EE\u81EA\u5DF1"}),"\n",(0,r.jsx)(n.li,{children:"\u53EF\u4EE5\u540C\u65F6\u8FDE\u591A\u4E2A\u96C6\u7FA4"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Nats-Request-Info: {"acc":"LEAF_ACCOUNT","rtt":11491934}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"helm",children:"HELM"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/nats-io/k8s/tree/main/helm/charts/nats",children:"https://github.com/nats-io/k8s/tree/main/helm/charts/nats"})}),"\n"]}),"\n",(0,r.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(n.h2,{id:"account-fetch-failed-fetching-jwt-timed-out",children:"Account fetch failed: fetching jwt timed out"}),"\n",(0,r.jsx)(n.p,{children:"\u914D\u7F6E resolver.timeout"}),"\n",(0,r.jsx)(n.h2,{id:"system_account-in-config-and-operator-jwt-must-be-identical",children:"system_account in config and operator JWT must be identical"}),"\n",(0,r.jsx)(n.p,{children:"\u751F\u6210\u914D\u7F6E\u4E0D\u8981\u6307\u5B9A --sys-account,\u9ED8\u8BA4\u4E3A SYS"}),"\n",(0,r.jsx)(n.h2,{id:"no-nkey-seed-found",children:"no nkey seed found"}),"\n",(0,r.jsx)(n.h2,{id:"using-nats-based-account-resolver---the-system-account-needs-to-be-specified-in-configuration-or-the-operator-jwt",children:"using nats based account resolver - the system account needs to be specified in configuration or the operator jwt"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nsc add account -n SYS\nnsc edit operator --system-account SYS\n"})}),"\n",(0,r.jsx)(n.h2,{id:"jetstream-not-enabled-for-account-10039",children:"JetStream not enabled for account (10039)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5FC5\u987B\u8981\u914D\u7F6E js-disk-storage"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nsc edit account server --js-disk-storage 1g\nnsc describe account server\n"})})]})}function u(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},17776:function(e,n,t){t.d(n,{R:()=>c,x:()=>o});var s=t(7378);let r={},a=s.createContext(r);function c(e){let n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);